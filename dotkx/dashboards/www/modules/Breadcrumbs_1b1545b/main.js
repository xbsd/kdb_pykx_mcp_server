define(["backbone","Handlebars","QuickBase","css!./css/app.css"],function(i,e,r){"use strict";var a,s=this&&this.__extends||(a=function(e,t){return(a=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}))(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),n=(o.focus2Array=function(e){var t=[],i=/"([^"]*)"/g,e=null!=e&&e.toString?e.toString():"",a=/^\[([^\]]*)]$/.exec(e);if(null!==a){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(a[1]))for(var s=void 0;null!==(s=i.exec(a[1]));)t.push(_.map(s[1].split(","),function(e){return e.replace(/&#44;/g,",")}))}else t.push(e.split(","));return t},o.focus2SingleCommonPath=function(e){for(var a=o.focus2Array(e),s=[],t=_.min(_.map(a,"length"))||0,i=0;i<t&&"break"!==function(t){var i=a[0][t];if(!_.every(a,function(e){return e[t]===i}))return"break";s.push(i)}(i);i++);return s},o);function o(){}c.getComponentDefinition=function(e){var t={id:19,componentName:"Breadcrumbs",componentDescription:"Breadcrumbs",appKey:"Breadcrumbs",css:"breadcrumbs",listViewThumb:e.websiteUrl+"Images/breadcrumbs.png",ghostViewThumb:null,buildViewThumb:null,appArgs:{websiteUrl:e.websiteUrl,quickStart:[{path:"Basic.Path",message:"define Path"}],json:{version:"4.7.7",Basic:{Name:"",Path:"",Breakdown:[],UsePathForAlternativeText:!0,AllowReordering:!0,ShowEditButton:!1,Data:"",DataSourceMapping:{Value:"",Text:""},BreadcrumbList:[],Theme:"Dark"},Style:{advanced:""}},schema:{type:"object",title:"Properties",_transform:function(i,e,t,a){var s=i.Basic.AllowReordering,n=i.Basic.Data instanceof r.DocumentDataModel;_.set(e,"properties.Basic.properties.Data.options.hidden",!s),_.set(e,"properties.Basic.properties.BreadcrumbList.options.hidden",!s||n),_.set(e,"properties.Basic.properties.ShowEditButton.options.hidden",!s),"root"===t||"Basic.Data"===t||"Basic.BreadcrumbList"===t||"Basic.AllowReordering"===t?a(i,e):a(),"Basic.Data"===t?i.Basic.Data instanceof r.DocumentDataModel?i.Basic.Data.getMeta(function(e){var e=_.fromPairs(_.map(e.columns.collection.models,function(e){return[e.get("id"),e.toJSON()]})),t=_.keys(e),e=_.find(e,function(e){return 0===e.kdbType||11===e.kdbType});i.dropdownPossibleValues&&i.dropdownPossibleValues.sort()!==t.sort()&&(i.dropdownPossibleValues=t,i.Basic.DataSourceMapping.Value=t[0]||"",i.Basic.DataSourceMapping.Text=e&&e.id||t[0]||""),a(i)}):(i.dropdownPossibleValues=[],i.Basic.DataSourceMapping.Value="",i.Basic.DataSourceMapping.Text="",a(i)):a()},properties:{Basic:{type:"object",title:"Settings",options:{collapsed:!1},propertyOrder:200,properties:{Name:{type:"string",title:"Name",default:""},Path:{type:"viewstate",title:"Path",default:""},Breakdown:{type:"viewstate",title:"Visible Breadcrumbs",default:""},UsePathForAlternativeText:{type:"boolean",title:"Use Path For Alternative Text",default:!0,format:"checkbox"},AllowReordering:{type:"boolean",title:"Allow Reordering",default:!0,format:"checkbox"},Data:{type:"data",title:"Breadcrumb Data Source",default:""},DataSourceMapping:{type:"object",title:"Data Source Mapping",options:{collapsed:!0,hidden:!0},properties:{Value:{type:"string",enumSource:"possibleValues",watch:{possibleValues:"root.dropdownPossibleValues"},default:""},Text:{type:"string",enumSource:"possibleValues",watch:{possibleValues:"root.dropdownPossibleValues"},default:""}}},BreadcrumbList:{type:"viewstate",title:"Available Breadcrumbs",default:""},ShowEditButton:{type:"boolean",title:"Show Edit Button",default:!1,format:"checkbox"},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Dark","Light"]},DashboardTheme:{options:{hidden:!0}}}},Style:{type:"object",title:"Style",options:{collapsed:!0},propertyOrder:210,properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(var i=_.find(c.upgrades,{version:e.settingsModel.get("version")}),a=void 0===i?1:c.upgrades.indexOf(i)+1;a<c.upgrades.length;a+=1){var s=c.upgrades[a];s.fn(e.settingsModel),e.settingsModel.set("version",s.version)}return t},c.upgrades=[{version:0,fn:function(){}},{version:"4.3.0",fn:function(e){e.set("Basic.UseColumnNames",!1)}},{version:"4.7.6",fn:function(e){e.set("Basic.ShowEditButton",!1),e.set("Basic.Data",""),e.set("dropdownPossibleValues",[""]),e.set("Basic.DataSourceMapping",{Value:"",Text:""}),e.set("Basic.BreadcrumbList",[]),e.set("Basic.AllowReordering",!0);var t=e.get("Basic");_.isNil(t.UsePathForAlternativeText)&&(_.isNil(t.UseColumnNames)?e.set("Basic.UsePathForAlternativeText",!0):(e.set("Basic.UsePathForAlternativeText",!t.UseColumnNames),e.unset("Basic.UseColumnNames")))}},{version:"4.7.7",fn:function(e){e.get("Basic.Name")||e.set("Basic.Name","")}}];var l=c;function c(){}h.app=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,a,s){return'<div class="breadcrumb-container">\n    <div class="breadcrumb">\n        <div class="edit-div" title="Edit">\n            <i class="fa fa-pencil"></i>\n            &nbsp;</div>\n        <div class="home-div" style="z-index: 101">\n            <i class="fa fa-home"></i>\n            &nbsp;</div>\n        \n    </div>\n</div>'},useData:!0}),h.appStackItem=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,a,s){return"<span>"+e.escapeExpression(e.lambda(t,t))+'</span><div class="small-ico close"></div>'},useData:!0}),h.editBreadcrumbsDialog=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,a,s){return'<div class="pnlLeft">\n    <span class="spanTitle">Available:</span>\n    <i class="fa fa-question-circle breadcrumb-help bc-help-available"></i>\n    <ol class="pnlAvailable"></ol>\n</div>\n<div class="pnlRight">\n    <span class="spanTitle">Visible:</span>\n    <i class="fa fa-question-circle breadcrumb-help bc-help-visible"></i>\n    <ol class="pnlVisible"></ol>\n</div>'},useData:!0});var d=h;function h(){}p=i.View,s(b,p);var p,u=b;function b(e,t,i,a){var s=p.call(this)||this,t=(s.info=e,t?e.name.replace(/&#44;/g,","):e.column);return s.$el.html(d.appStackItem(t)),s.$el.attr("id",i+e.column),e.placeholder?s.$el.addClass("placeholder"):(s.$el.on(r.Tools.clickEvent(),function(e){e.stopPropagation(),e.preventDefault(),a.onItemSelect(s)}),s.$el.find(".close").on(r.Tools.clickEvent(),function(e){e.stopPropagation(),e.preventDefault(),a.onItemClose(s)})),s}m=r.DialogBase,s(v,m),v.prototype.dialogButtons=function(){var e=this;return[{text:"OK",click:this.onSave.bind(this),icon:"fa fa-check"},{text:"Cancel",click:function(){e.dialogClose()},icon:"fa fa-times"}]},v.prototype.preRender=function(){this.options.height=440,this.options.width=500,this.options.dialogTitle="Edit Breadcrumbs",this.options.userClass="Breadcrumbs edit-breadcrumbs-dialog"},v.prototype.renderTemplate=function(){return d.editBreadcrumbsDialog()},v.prototype.remove=function(){return r.DialogBase.prototype.remove.apply(this)},v.prototype.getListHtml=function(e,i){var a=this;return _.reduce(e,function(e,t){return e+a.getListItemHtml(t,i)},"")},v.prototype.getListItemHtml=function(e,t){var i="<span><i class='fa fa-fw bc-empty'></i></span>";return"<li data-field='"+e+"'>"+e+(i=t&&!_.includes(this.breadcrumbList,e)?"<span class='li-span-icon'><i class='fa fa-warning bc-warning' title='"+v.TTIP_BREADCRUMB_WARNING+"'></i></span>":i)+"</li>"},v.prototype.initPanels=function(){var i=this.breadcrumbList,e=this.breadcrumbOrder,t=this.getListHtml(e,!1),e=this.getListHtml(_.difference(i,e),!0),a=(this.$helpAvailableListIcon.attr("title",v.TTIP_AVAILABLE_LIST),this.$helpVisibleListIcon.attr("title",v.TTIP_VISIBLE_LIST),this.$pnlVisible.html(t),this.$pnlAvailable.html(e),this);this.$bothPanels.sortable({connectWith:this.$bothPanels,out:function(e,t){e.originalEvent.type.includes("mouseup")&&($(e.target).hasClass("pnlVisible")?t.item.find(".bc-warning").length&&$(t.item).replaceWith(a.getListItemHtml(t.item.text(),!1)):$(e.target).hasClass("pnlAvailable")&&!_.includes(i,t.item.text())&&$(t.item).replaceWith(a.getListItemHtml(t.item.text(),!0)))}})},v.prototype.onCancel=function(){this.dialogClose()},v.prototype.onSave=function(){var e=_.map(this.$pnlVisible.find(">li"),function(e){return $(e).data("field")});this.api.setProperty("Basic.Breakdown",e),this.dialogClose()},v.TTIP_AVAILABLE_LIST="Drag and drop breadcrumbs from this list to the \nVisible Breadcrumbs list to make them visible.",v.TTIP_VISIBLE_LIST="• Drag and drop items within this list to change their order.\n• Drag and drop breadcrumbs from this list to the Available\n   Breadcrumbs list to remove breadcrumbs from view.",v.TTIP_BREADCRUMB_WARNING="This breadcrumb will be permanently removed during this session.";var m,f,g=v;function v(e){var t=m.call(this,e)||this;return t.breadcrumbOrder=[],t.breadcrumbList=[],t.api=e.api,t.breadcrumbOrder=e.breadcrumbOrder,t.breadcrumbList=e.breadcrumbList,t.$pnlAvailable=t.$(".pnlAvailable"),t.$pnlVisible=t.$(".pnlVisible"),t.$helpAvailableListIcon=t.$(".bc-help-available"),t.$helpVisibleListIcon=t.$(".bc-help-visible"),t.$bothPanels=t.$pnlAvailable.add(t.$pnlVisible),t.initPanels(),t}function B(e){var t=f.call(this,e)||this;return t.itemViews=[],t.breakdownColumns=[],t.data=[],t.uniqueId=_.uniqueId("breadcrumb_"),t.breakdownCache=[],t.restorePath=!0,t.allBreadcrumbsDataSrcList=[],t.dataModel=void 0,t.api=e.api,t.disableSortable=e.disableSortable||!1,t.$el.html(d.app({})),t.$el.addClass("breadcrumb-app"),t.$breadcrumb=t.$el.find(".breadcrumb"),t.$home=t.$el.find(".home-div"),t.$edit=t.$el.find(".edit-div"),t.viewModel=new i.DeepModel({"Basic.Breakdown":[],"Basic.Path":"","Basic.AllowReordering":!t.disableSortable}),t.hasInit=!1,t}return f=i.View,s(B,f),B.prototype.onItemClose=function(e){e=this.data.indexOf(e.info),e=_.map(this.data.slice(0,e),function(e){return e.name}).join(",");this.api.setProperty("Basic.Path",e)},B.prototype.onItemSelect=function(e){e=this.data.indexOf(e.info),e=_.map(this.data.slice(0,e+1),function(e){return e.name}).join(",");this.api.setProperty("Basic.Path",e)},B.prototype.onResize=function(){},B.prototype.onSettingsChange=function(e){var i=this;_.each(e,_.bind(function(e,t){i.viewModel.set(t,e)},this)),this.hasInit||(this.hasInit=!0,this.onDataSourceChanged(),this.initializeEvents(),this.breakdownColumns=this.viewModel.get("Basic.Breakdown"),this.onPathChanged(this.viewModel,this.viewModel.get("Basic.Path")),this.onAllowReordering())},B.prototype.onData=function(e,t){var i=this,a=(this.allBreadcrumbsDataSrcList=[],e.columns.collection.pluck("id")[0]);t.reset&&0<t.reset.length&&_.each(t.reset,function(e){i.allBreadcrumbsDataSrcList.push(e[a])})},B.prototype.initializeEvents=function(){var t=this;this.listenTo(this.viewModel,"change:Basic.Breakdown",this.onBreakdownChanged.bind(this)),this.listenTo(this.viewModel,"change:Basic.Path",this.onPathChanged.bind(this)),this.listenTo(this.viewModel,"change:Basic.Data",this.onDataSourceChanged.bind(this)),this.listenTo(this.viewModel,"change:Basic.AllowReordering",this.onAllowReordering.bind(this)),this.listenTo(this.viewModel,"change:Basic.UsePathForAlternativeText change:Basic.ShowEditButton",this.onRenderBreadcrumbs.bind(this)),this.$home.on(r.Tools.clickEvent(),function(e){e.stopPropagation(),e.preventDefault(),t.api.setProperty("Basic.Path","")}),this.$edit.on("click",this.showEditBreadcrumbsDlg.bind(this))},B.prototype.onBreakdownChanged=function(e,i){this.breakdownColumns=i;var e=_.get(e,"_previousAttributes.Basic.Breakdown"),t=_.compact(_.map(e,function(e,t){if(i.indexOf(e)<0)return t-1}));if(_.isString(this.viewModel.get("Basic.Path"))&&e&&0<t.length){for(var a=this.viewModel.get("Basic.Path").split(","),s=0;s<a.length;s++)s>=t[0]&&(a[s]=null);this.api.setProperty("Basic.Path",_.compact(a).toString()),this.renderBreadcrumbs(),this.setValidPath(!1)}else this.setValidPath(!1),this.renderBreadcrumbs()},B.prototype.onOrderChanged=function(){this.setValidPath(!0)},B.prototype.onPathChanged=function(e,t){var i,a=this,t=n.focus2SingleCommonPath(t).join(",");this.path!==t&&(this.breakdownCache&&this.path&&this.restorePath?(i=[],_.every(this.breakdownColumns,function(e,t){return!(!a.breakdownCache||e!==a.breakdownCache[t]||(i.push(e),0))}),_.isEmpty(i)?this.path="":(this.path=this.path.split(",").slice(0,i.length).join(","),_.delay(function(){a.api.setProperty("Basic.Path",a.path)},250)),this.breakdownCache=null):(this.breakdownCache=null,this.path=t),this.path?(t=this.path.toString().split(","),this.data=t.map(function(e){return{name:e}})):this.data=[],this.renderBreadcrumbs()),this.restorePath=!0},B.prototype.onAllowReordering=function(){this.disableSortable=!this.viewModel.get("Basic.AllowReordering"),this.$breadcrumb.sortable("instance")&&this.$breadcrumb.sortable("option","disabled",this.disableSortable),this.renderBreadcrumbs()},B.prototype.onRenderBreadcrumbs=function(){this.renderBreadcrumbs()},B.prototype.renderBreadcrumbs=function(){var a=this,e=(!this.disableSortable&&this.viewModel.get("Basic.ShowEditButton")?this.$edit.insertBefore(this.$home):this.$edit.detach(),this.itemViews.forEach(function(e){return e.remove()}),this.itemViews=[],_.isEmpty(this.breakdownColumns)?this.data:this.breakdownColumns);_.isArray(e)&&(_.times(e.length,function(e){var t=a.data[e],i=a.breakdownColumns[e],t=t&&(t.column===i||_.isNil(t.column))?t:{name:i,placeholder:!0};t.column=i,_.isNil(t.name)||(i=new u(t,a.viewModel.get("Basic.UsePathForAlternativeText"),a.uniqueId,a),a.itemViews.push(i),i.$el.css("z-index",100-e),a.$breadcrumb.append(i.el))}),this.viewModel.get("Basic.Breakdown"))&&!this.disableSortable&&this.$breadcrumb.sortable({items:">div:not(.home-div, .edit-div)",stop:this.onOrderChanged.bind(this)})},B.prototype.setValidPath=function(e){var t,i,a=this,s=[];this.disableSortable||(this.$breadcrumb.sortable("instance")&&(s=_.map(this.$breadcrumb.sortable("toArray"),function(e,t){return $("#"+e).css("z-index",100-t),e.replace(a.uniqueId,"")})),_.isEqual(this.viewModel.get("Basic.Breakdown"),s))||(this.breakdownCache=this.viewModel.get("Basic.Breakdown"),e&&this.api.setProperty("Basic.Breakdown",s),e=n.focus2SingleCommonPath(this.viewModel.get("Basic.Path")),t=[],this.breakdownCache&&(i=_.reduce(e,function(e,t,i){i=a.breakdownCache[i];return t&&void 0!==i&&(e[i]=t),e},{}),_.takeWhile(s,function(e){e=i[e];return void 0!==e&&(t.push(e),!0)})),this.restorePath=!1,this.api.setProperty("Basic.Path",t.join(",")))},B.prototype.onDataSourceChanged=function(){var e=this.viewModel.get("Basic.Data");e!==this.dataModel&&(this.allBreadcrumbsDataSrcList=[]),this.dataModel&&(this.stopListening(this.dataModel),this.api.unsubscribe(this.dataModel)),(this.dataModel=e)?this.dataModel&&this.dataModel.attributes?(this.initializeErrorHandler(this.dataModel),this.api.subscribe(this.dataModel,this.onData.bind(this))):this.api.showErrorMessage({error:t('Invalid Data Source: "')+e.path+'" '+t("visible"),errorType:"Warning"}):this.renderBreadcrumbs()},B.prototype.initializeErrorHandler=function(e){var t=this;this.updateErrorMessage(),this.listenTo(e,"change:error",function(){t.updateErrorMessage()})},B.prototype.updateErrorMessage=function(){this.dataModel&&this.dataModel.get("error")?this.api.showErrorMessage(this.dataModel.get("error")):this.api.hideErrorMessage()},B.prototype.showEditBreadcrumbsDlg=function(){var e=this.breakdownColumns,t=this.viewModel.get("Basic.Data")?this.allBreadcrumbsDataSrcList:this.viewModel.get("Basic.BreadcrumbList");new g({api:this.api,breadcrumbOrder:e,breadcrumbList:t,target:this.$edit})},B.getComponentDefinition=l.getComponentDefinition,B});
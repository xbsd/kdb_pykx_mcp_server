define(["Handlebars","echarts","QuickBase","moment","xlsx","backbone","css!./css/app.css"],function(t,e,s,i,n,o){"use strict";var a,r=this&&this.__extends||(a=function(t,e){return(a=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}))(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),l=(d.getComponentDefinition=function(t){var e={id:57,appArgs:{json:{version:"4.7.8",Basics:{Name:"",LeftPanel:{Position:"Top",WidthType:"Percentage",Height:100,Width:20},RightPanel:{Position:"Bottom",WidthType:"Percentage",Height:100,Width:20}}},schema:{type:"object",title:"Properties",properties:{Basics:{propertyOrder:0,type:"object",title:"Basics",options:{collapsed:!1},properties:{Name:{default:"",type:"string",propertyOrder:1,title:"Name"},LeftPanel:{propertyOrder:2,type:"object",title:"Left Panel",options:{collapsed:!1},properties:d.PANEL},RightPanel:{propertyOrder:3,type:"object",title:"Right Panel",options:{collapsed:!1},properties:d.PANEL}}}}}}};if(0<_.keys(t.settingsModel.attributes).length)for(var i=_.find(d.upgrades,{version:t.settingsModel.get("version")}),s=void 0===i?1:d.upgrades.indexOf(i)+1;s<d.upgrades.length;s+=1){var n=d.upgrades[s];n.fn(t.settingsModel,t),t.settingsModel.set("version",n.version)}return e},d.PANEL={Position:{title:"Position",type:"string",enum:["Top","Bottom"],propertyOrder:1,default:"Top"},WidthType:{title:"Height/Width Type",type:"string",enum:["Percentage","Fixed"],propertyOrder:2,default:"Percentage"},Height:{title:"Height",type:"number",propertyOrder:3,default:100},Width:{title:"Width",type:"number",propertyOrder:4,default:20},ComponentId:{type:"string",options:{hidden:!0}}},d.upgrades=[{version:"0",fn:function(t,e){}},{version:"4.7.8a",fn:function(t,e){var i,s,n,o;t.get("Basics.LeftPanel")||(i=t.get("Basics.Position")||"Top",s=t.get("Basics.Height")||100,n=t.get("Basics.Width")||20,o=t.get("Basics.WidthType")||"Percentage",t.set("Basics.LeftPanel.Position",i),t.set("Basics.LeftPanel.Height",s),t.set("Basics.LeftPanel.Width",n),t.set("Basics.LeftPanel.WidthType",o),t.set("Basics.RightPanel.Position","Bottom"),t.set("Basics.RightPanel.Height",100),t.set("Basics.RightPanel.Width",20),t.set("Basics.RightPanel.WidthType","Percentage"))}}],d);function d(){}p.app=t.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,s,n){var o=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="worksheet">\n    <div class="grid-stack">\n        <div class="advanced-item placeholder"></div>\n    </div>\n    <div class="no-widgets-info">\n        <div class="loading">'+t.escapeExpression((o(i,"t")||e&&o(e,"t")||t.hooks.helperMissing).call(null!=e?e:t.nullContext||{},"start dragging widgets from the panel on your left",{name:"t",hash:{},data:n,loc:{start:{line:6,column:29},end:{line:6,column:87}}}))+'</div>\n\n        <div class="dragComponentsHelp">\n            <i class="fa fa-chevron-right"></i>\n            <i class="fa fa-chevron-right"></i>\n            <i class="fa fa-chevron-right"></i>\n        </div>\n    </div>\n</div>\n<div class="visual-indicator-left"></div>\n<div class="visual-indicator-right"></div>\n'},useData:!0});var h=p;function p(){}u.prototype.panelPos=function(t){return"Basics."+this.position+"."+t},u.prototype.onSettingsChange=function(t){var e=t[this.panelPos(u.PROP_POSITION)],e=(e&&e!==this.propertyCache[this.panelPos(u.PROP_POSITION)]&&(this.propertyCache[this.panelPos(u.PROP_POSITION)]=e,this.onLayoutChanged()),t[this.panelPos(u.PROP_WIDTH_TYPE)]),i=t[this.panelPos(u.PROP_HEIGHT)],t=t[this.panelPos(u.PROP_WIDTH)];(e||i||t)&&(e&&this.propertyCache[this.panelPos(u.PROP_WIDTH_TYPE)]!==e&&(this.propertyCache[this.panelPos(u.PROP_WIDTH_TYPE)]=e),i&&this.propertyCache[this.panelPos(u.PROP_HEIGHT)]!==i&&(this.propertyCache[this.panelPos(u.PROP_HEIGHT)]=i),t&&this.propertyCache[this.panelPos(u.PROP_WIDTH)]!==t&&(this.propertyCache[this.panelPos(u.PROP_WIDTH)]=t),this.onWidthChanged())},u.prototype.updateWidget=function(t){this.widgetEl=t,this.api.setProperty("Basics."+this.position+".ComponentId",t.getAttribute("data-widgetid")),this.onLayoutChanged(),this.onWidthChanged()},u.prototype.removeWidget=function(){this.widgetEl=null,this.api.setProperty("Basics."+this.position+".ComponentId","")},u.prototype.onLayoutChanged=function(){this.visualIndicator.classList.remove("top"),this.visualIndicator.classList.remove("bottom");var t=this.propertyCache[this.panelPos(u.PROP_POSITION)].toLowerCase(),e="bottom"===t?"top":"bottom";this.visualIndicator.classList.add(t),this.widgetEl&&(this.widgetEl.classList.remove(e),this.widgetEl.classList.add(t))},u.prototype.onWidthChanged=function(){var t=this.propertyCache[this.panelPos(u.PROP_WIDTH)],e=this.propertyCache[this.panelPos(u.PROP_HEIGHT)],i=("Percentage"===this.propertyCache[this.panelPos(u.PROP_WIDTH_TYPE)]&&(t=(i=this.el.getBoundingClientRect()).width*(t/100),e=i.height*(e/100)),this.visualIndicator.style.width=t+"px",this.visualIndicator.style.height=e+"px","LeftPanel"===this.position?"left-panel":"right-panel"),i=this.el.getElementsByClassName(i);null!=i&&i.length&&((i=i[0].getElementsByClassName("app-div")[0]).style.width=t+"px",i.style.height=e+"px")},u.PROP_POSITION="Position",u.PROP_WIDTH_TYPE="WidthType",u.PROP_HEIGHT="Height",u.PROP_WIDTH="Width",u.PROP_SHOW="Show";var g,c=u;function u(t,e,i,s){this.api=t,this.el=e,this.visualIndicator=i,this.position=s,this.propertyCache={}}function f(t){t=g.call(this,t)||this;return t.itemClass="",t.panelId="",t.propertyCache={},t.removing=!1,t}return g=s.ComponentDropView,r(f,g),f.prototype.initialize=function(t){this.api=t.api,this.panelId=_.uniqueId("overlaypanel"),this.el=t.el,this.componentModel=t.componentModel,this.dashboardAppModel=t.dashboardAppModel,this.dashboardViewModel=t.dashboardViewModel,this.quickView=t.quickView,this.websiteUrl=t.websiteUrl,this.basePanel=t.basePanel,this.webGLContextAndCanvas=t.webGLContextAndCanvas,this.events=null,this.model||(this.model=this.componentModel),this.viewModel=new o.DeepModel,this.widgets=[],this.postRender()},f.prototype.renderWidget=function(){var t=$('<div class="advanced-item"><div class="drop-show"></div></div>');return this.$gridstack&&this.$gridstack.append(t),t},f.prototype.postRender=function(){return this.el.classList.add("overlay-panel"),this.el.setAttribute("id",this.panelId),this.el.innerHTML=h.app({}),this.worksheet=this.el.querySelector(".worksheet"),this.$worksheet=this.$el.find("> .worksheet"),this.$gridstack=this.$worksheet.find("> .grid-stack"),this.gridstack=this.worksheet.querySelector(".grid-stack"),this.noWidgetsInfo=this.worksheet.querySelector(".no-widgets-info"),this.visualIndicatorLeft=this.el.querySelector(".visual-indicator-left"),this.visualIndicatorRight=this.el.querySelector(".visual-indicator-right"),this.placeholder=this.gridstack.querySelector(".placeholder"),this.leftPanel=new c(this.api,this.el,this.visualIndicatorLeft,"LeftPanel"),this.rightPanel=new c(this.api,this.el,this.visualIndicatorRight,"RightPanel"),this},f.prototype.onSettingsChange=function(t){var i=this;_.each(t,function(t,e){i.viewModel.set(e,t)}),this.leftPanel.onSettingsChange(t),this.rightPanel.onSettingsChange(t),this.initializePost(),this.webGLContextAndCanvas&&this.onResize()},f.prototype.initializePost=function(){this.hasInitPost||(this.hasInitPost=!0,this.widgetsCollection=this.model.get("widgets"),this.initializeEvents(),this.clearPanel(this.applyCurrentPanel.bind(this)),this.switchBuildMode(this.dashboardViewModel.get("buildMode")),this.onResize())},f.prototype.applyCurrentPanel=function(){var e=this;this.widgetsCollection.each(function(t){e.addWidget(t,!0,null)})},f.prototype.clearPanel=function(t){this.clearWidgets(function(){t&&t()})},f.prototype.initializeEvents=function(){var t=this;this.$worksheet&&(this.$worksheet.on("dragover",this.getSafeDragNDropHandler(this.onWorksheetDragOver)),this.$worksheet.on("dragleave",this.getSafeDragNDropHandler(this.onWorksheetDragLeave)),this.$worksheet.on("drop",this.getSafeDragNDropHandler(this.onWorksheetDrop))),this.listenTo(this.dashboardViewModel,"change:selectedWidget",this.onSelectedWidgetChanged),this.listenTo(this.dashboardViewModel,"change:buildMode",function(){return t.switchBuildMode(t.dashboardViewModel.get("buildMode"))}),this.listenTo(this.dashboardAppModel,"change:pendingSelectionWidgetId",this.onSelectingWidget),this.initializeEvents_widgetCollection()},f.prototype.onComponentDragOver=function(t){var e;if(!_.includes(t.originalEvent.dataTransfer.types,"Files"))return $(t.currentTarget).toggleClass("highlight",!0),t=this.el.getElementsByClassName("left-panel")[0],e=this.el.getElementsByClassName("right-panel")[0],t||(this.visualIndicatorLeft.style.display="block"),e||(this.visualIndicatorRight.style.display="block"),!1},f.prototype.clearWidgets=function(t){_.includes(this.model.get("widgets").map("id"),this.dashboardViewModel.get("selectedWidgetId"))&&this.deselectCurrentWidget(),0<this.widgets.length&&(_.each(this.widgets,function(t){t.view&&_.isFunction(t.view.remove)&&t.view.remove()}),this.widgets=[],this.$gridstack.children().remove()),t&&t()},f.prototype.getWidgetClass=function(t,e){var i="base",s=this.el.getElementsByClassName("left-panel")[0],n=this.el.getElementsByClassName("right-panel")[0],o=this.api.getProperty("Basics.LeftPanel.ComponentId"),a=this.api.getProperty("Basics.RightPanel.ComponentId");return this.itemClass?(i=this.itemClass,this.itemClass=""):o===e?i="left-panel":a===e?i="right-panel":0<this.widgets.length&&!s?i="left-panel":2!==this.widgets.length||n||(i="right-panel"),"ui-widget "+i},f.prototype.onResize=function(){this.leftPanel.onWidthChanged(),this.rightPanel.onWidthChanged(),this.onResizeWidgets()},f.prototype.onResizeWidgets=function(){_.each(this.widgets,function(t){t.view&&(_.isFunction(t.view.onResize)&&t.view.onResize(!0),_.isFunction(t.view.onResizeStop))&&t.view.onResizeStop(!0)})},f.prototype.remove=function(){var t=this;this.removing||(this.removing=!0,this.stopListening(),this.$worksheet&&this.$worksheet.off(),this.clearPanel(function(){t.removeCallbacks=[],t.$el.remove(),t.removing=!1})),o.View.prototype.remove.apply(this)},f.prototype.renderComponent=function(t,e,i,s){e=this.createComponentView(t,e,i,s),i=$("<div/>",{class:"grid-stack-item-content"}).append(e.$el);t.$widget.append(i)},f.prototype.setTheme=function(e){_.each(this.widgets,function(t){t.view.app&&t.view.app.setTheme&&t.view.app.setTheme(e)})},f.prototype.switchOffBuildMode=function(t){s.ComponentDropView.prototype.switchOffBuildMode.apply(this,[t]),this.$gridstack&&this.$gridstack.find("> div").addClass("build-off")},f.prototype.switchOnBuildMode=function(t){s.ComponentDropView.prototype.switchOnBuildMode.apply(this,[t]),this.$gridstack&&this.$gridstack.find("> div").removeClass("build-off")},f.prototype.onComponentDragEnter=function(t){var e;if(!_.includes(t.originalEvent.dataTransfer.types,"Files"))return e=t.currentTarget.getAttribute("data-widgetid"),this.model.get("widgets").get(e).get("component")||$(t.currentTarget).toggleClass("highlight",!0),!1},f.prototype.onComponentDragLeave=function(t){return $(t.currentTarget).toggleClass("highlight",!1),this.visualIndicatorLeft.style.display="none",!(this.visualIndicatorRight.style.display="none")},f.prototype.onComponentDrop=function(t){var e,i,s=this.el.getElementsByClassName("left-panel")[0],n=this.el.getElementsByClassName("right-panel")[0],o="";return s&&n||(i=this.el.getBoundingClientRect(),e=this.el.clientWidth/2,i=t.clientX-i.left,!s&&i<=e?o="left-panel":!n&&e<i&&(o="right-panel"),this.itemClass=o),this.onComponentDragLeave(t),void 0!==t.originalEvent.dataTransfer&&(s=t.originalEvent.dataTransfer.getData("text"),this.dashboardAppModel.get("components").get(s))&&(n=$(t.currentTarget).attr("data-widgetid"),e=this.findWidgetItem(n),i=t.currentTarget,this.dashboardViewModel.set("selectedWidget",null),i.classList.contains("left-panel")||i.classList.contains("right-panel")?this.addComponentToWidget(e.model,s,!0):i.classList.contains("base")&&(""===o?this.addComponentToWidget(e.model,s,!0):this.addNewWidget(null,s,!1)),this.onResize()),!1},f.prototype.addWidget=function(t,e,i){this.noWidgetsInfo&&(this.noWidgetsInfo.style.display="none"),this.visualIndicatorLeft&&(this.visualIndicatorLeft.style.display="none"),this.visualIndicatorRight&&(this.visualIndicatorRight.style.display="none");t=s.ComponentDropView.prototype.addWidget.apply(this,[t,e,i,this.basePanel,this.webGLContextAndCanvas]),e=this.el.getElementsByClassName("left-panel")[0],i=this.el.getElementsByClassName("right-panel")[0];return e&&this.leftPanel.updateWidget(e),i&&this.rightPanel.updateWidget(i),t},f.prototype.addWidgetEvents=function(t){var e,i=this;if(!(t instanceof $))throw"Wrong parameter.";_.each(t,function(t){(e=$(t)).on("click",$.proxy(i.onWidgetClick,i)),e.on("dragenter",i.getSafeDragNDropHandler(i.onComponentDragEnter)),e.on("dragleave",i.getSafeDragNDropHandler(i.onComponentDragLeave)),e.on("dragover",i.getSafeDragNDropHandler(i.onComponentDragOver)),e.on("drop",i.getSafeDragNDropHandler(i.onComponentDrop))})},f.prototype.onSelectingWidget=function(t,e){t&&(this.onWidgetClick(null,e),this.dashboardAppModel.set("pendingSelectionWidgetId",null,{silent:!0}))},f.prototype.onSelectedWidgetChanged=function(t,e){t=t.get("selectedWidgetId");this.$el.find(".advanced-item.selected").toggleClass("selected",!1),t&&this.$el.find(".advanced-item[data-widgetid='"+t+"']").toggleClass("selected",!0)},f.prototype.onWidgetCollectionAdd=function(t,e,i){i=i&&i.at;this.addWidget(t,!1,i)},f.prototype.onWorksheetDragLeave=function(t){return!(this.placeholder.style.display="none")},f.prototype.onWorksheetDragOver=function(t){return!(this.placeholder.style.display="block")},f.prototype.onWorksheetDrop=function(t){return this.placeholder.style.display="none",this.visualIndicatorLeft.style.display="none",this.visualIndicatorRight.style.display="none",this.deselectCurrentWidget(),this.widgets.length<3&&this.onComponentDropWrap(t),!1},f.prototype.onComponentDropWrap=function(t){var e=t.originalEvent.dataTransfer.getData("text");return t.preventDefault&&(t.preventDefault(),t.stopPropagation()),this.dashboardAppModel&&this.dashboardAppModel.get("components").has(e)&&this.addNewWidget(null,e,!1),!1},f.prototype.pasteWidget=function(t){1<this.widgets.length&&this.removeWidget(this.widgets[this.widgets.length-1].model),t.setParent(this.widgetsCollection);this.addNewWidget(t,t.get("component").get("definitionId"),!0);this.onResize()},f.prototype.removeWidget=function(t){var e=this.findWidgetItem(t.id),i=this.api.getProperty("Basics.LeftPanel.ComponentId"),s=this.api.getProperty("Basics.RightPanel.ComponentId");i===t.id&&this.leftPanel.removeWidget(),s===t.id&&this.rightPanel.removeWidget(),e&&(this.widgets=_.without(this.widgets,e),0===this.widgets.length&&(this.noWidgetsInfo.style.display="block",this.visualIndicatorLeft.style.display="block",this.visualIndicatorRight.style.display="block"),this.quickView||this.model.get("widgets").remove(e.model),e.$widget.css({border:"none",background:"none","box-shadow":"none","pointer-events":"none"}),e.view&&e.view.remove&&e.view.remove(),e.$widget.off(),e.$widget.remove())},f.prototype.updateWebGLContext=function(i,s,n){this.webGLContextAndCanvas=i&&s?{gl:i,canvas:s,elements:n}:void 0;var o=["Panel","FlexPanel","Accordion","Tabs","OverlayPanel"];this.widgets.forEach(function(t){var e=t.view.key;"ChartGL"!==e&&-1===o.indexOf(e)||null!=(e=t.view.app)&&e.updateWebGLContext(i,s,n)})},f.getComponentDefinition=l.getComponentDefinition,f.PROP_POSITION="Basics.Position",f.PROP_WIDTH_TYPE="Basics.WidthType",f.PROP_HEIGHT="Basics.Height",f.PROP_WIDTH="Basics.Width",f});
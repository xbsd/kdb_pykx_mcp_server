define(["backbone","Handlebars","QuickBase","moment","./lib/maplibre-gl.5.0.5","MapboxDraw","turf","./lib/terminator","css!./css/app.css"],function(o,p,R,s,c,E,d,F){"use strict";var i,r,e=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}))(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),a=this&&this.__awaiter||function(e,n,s,l){return new(s=s||Promise)(function(r,t){function i(e){try{a(l.next(e))}catch(e){t(e)}}function o(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(i,o)}a((l=l.apply(e,n||[])).next())})},n=this&&this.__generator||function(i,o){var a,n,s,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(r){return function(e){var t=[r,e];if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,n&&(s=2&t[0]?n.return:t[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,t[1])).done)return s;switch(n=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,n=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(s=0<(s=l.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3]))l.label=t[1];else if(6===t[0]&&l.label<s[1])l.label=s[1],s=t;else{if(!(s&&l.label<s[2])){s[2]&&l.ops.pop(),l.trys.pop();continue}l.label=s[2],l.ops.push(t)}}t=o.call(i,l)}catch(e){t=[6,e],n=0}finally{a=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},u=this&&this.__assign||function(){return(u=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},l=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var i,o=0,a=t.length;o<a;o++)!i&&o in t||((i=i||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(i||Array.prototype.slice.call(t))},G=(r=o.View,e(t,r),t.prototype.renderMapAnimatedCircles=function(){this.animatedCircleSource=this.api.getProperty("AnimatedCircles").DataSource,this.cleanUpSource(),this.removeLayers(),this.api.subscribe(this.animatedCircleSource,_.bind(this.onData,this))},t.prototype.cleanUpSource=function(){this.animatedCircleSource&&(this.stopListening(this.animatedCircleSource),this.api.unsubscribe(this.animatedCircleSource))},t.prototype.onAnimatedCirclesChange=function(e,t){this.cleanUpSource(),t&&(this.animatedCircleSource=t,this.renderAnimatedCircles())},t.prototype.onData=function(e,t,r){if(r)return this.updateError("AnimatedCircle Source",r);r=this.animatedCircleSource.dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("AnimatedCircles.possibleAnimatedCircles",[""].concat(r)),this.animatedCirclesData=t.items?t.items():this.animatedCircleSource.dataSet.collection.models.map(function(e){return e.attributes}),t.reset?this.resetData():(this.sourceToJSON(),this.drawData())},t.prototype.resetData=function(){this.sourceToJSON(),this.addSource()},t.prototype.sourceToJSON=function(){var i=this,o=this.api.getProperty("AnimatedCircles.ID"),a=this.api.getProperty("AnimatedCircles.UseLabel"),n=this.api.getProperty("AnimatedCircles.Label"),s=this.api.getProperty("AnimatedCircles.LabelSize"),l=this.api.getProperty("AnimatedCircles.Color"),p=this.api.getProperty("AnimatedCircles.Radius"),c=this.api.getProperty("AnimatedCircles.Latitude"),u=this.api.getProperty("AnimatedCircles.Longitude"),d=this.api.getProperty("AnimatedCircles.Altitude");this.data={type:"FeatureCollection",crs:{type:"name",properties:{name:"animatedCircleDataCrs"}},features:[]},_.each(this.animatedCirclesData,function(e,t){var r,t={id:_.isNil(o)?t:e[o],radius:_.isNil(p)||!e[p]?4:parseFloat(e[p]),color:_.isNil(l)||!e[l]?"#11b4da":e[l]};a&&_.extend(t,{label:_.isNil(n)?"":e[n],labelSize:_.isNil(s)||!e[s]?10:parseFloat(e[s]),color:_.isNil(l)||!e[l]?"#11b4da":e[l],strokeWidth:1,strokeColor:"#ffffff"}),null!=(r=i.data)&&r.features.push({type:"Feature",properties:t,geometry:{type:"Point",coordinates:[_.isNil(u)||!e[u]?0:e[u],_.isNil(c)||!e[c]?0:e[c],_.isNil(d)||!e[d]?0:e[d]]}})}),this.animateCircles(0)},t.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},t.prototype.resetAnimatedCircles=function(){this.data=_.cloneDeep(this.previousData),this.drawData()},t.prototype.drawData=function(){this.map&&this.map.getSource("animCircleClusterData")&&this.map.getSource("animCircleClusterData").setData(this.data)},t.prototype.removeLayers=function(){this.map.getLayer("unclustered-animatedCircle")&&this.map.removeLayer("unclustered-animatedCircle"),this.map.getLayer("unclustered-animatedCircle-lbl")&&this.map.removeLayer("unclustered-animatedCircle-lbl"),this.map.getSource("animCircleClusterData")&&this.map.removeSource("animCircleClusterData")},t.prototype.addSource=function(){var e,t,r,a=this;_.isNil(this.data)||(t=this.api.getProperty("MapDetails.Offline"),r=this.api.getProperty("TileServer.Enable"),e=this.api.getProperty("AnimatedCircles.UseLabel"),this.removeLayers(),t=t?["OpenSansBold"]:["Arial Unicode MS Bold"],r&&(t=[this.api.getProperty("TileServer.Font")]),this.map.addSource("animCircleClusterData",{type:"geojson",data:this.data}),r={"text-font":t,"text-field":["get","label"],"text-variable-anchor":["top","bottom","left","right"],"text-radial-offset":1,"text-size":["get","labelSize"],"text-justify":"auto","text-allow-overlap":!1},this.map.addLayer({id:"unclustered-animatedCircle",type:"circle",source:"animCircleClusterData",filter:["!",["has","point_count"]],paint:{"circle-color":["get","color"],"circle-radius":["get","radius"],"circle-stroke-width":["get","strokeWidth"],"circle-stroke-color":["get","strokeColor"]}}),e&&this.map.addLayer({id:"unclustered-animatedCircle-lbl",source:"animCircleClusterData",filter:["!",["has","point_count"]],type:"symbol",layout:r}),this.map.on("mouseenter","unclustered-animatedCircle",function(e){var t=e.features[0],r=_.get(t,"properties.id"),i=a.api.getProperty("AnimatedCircles.ID"),o=_.filter(a.animatedCirclesData,function(e){return e[i]===r});a.displayTooltip(e,o,t,r),0<o.length&&a.doActions("Hover",o[0])}),this.map.on("mouseleave","unclustered-point",function(e){a.app.hideTooltip()}),this.map.on("click","unclustered-animatedCircle",function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=a.api.getProperty("AnimatedCircles.ID"),e=_.filter(a.animatedCirclesData,function(e){return e[r]===t});0<e.length&&a.doActions("Click",e[0])}),this.map.on("contextmenu","unclustered-animatedCircle",function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=a.api.getProperty("AnimatedCircles.ID"),e=_.filter(a.animatedCirclesData,function(e){return e[r]===t});0<e.length&&a.doActions("Right Click",e[0])}),this.map.on("dblclick","unclustered-animatedCircle",function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=a.api.getProperty("AnimatedCircles.ID"),e=_.filter(a.animatedCirclesData,function(e){return e[r]===t});0<e.length&&a.doActions("Double Click",e[0])}))},t.prototype.animate=function(t){var e,r=this;_.each(null==(e=this.data)?void 0:e.features,function(e){e.properties.strokeWidth=t%2?1:3,e.properties.strokeColor=t%2?"#ffffff":"rgba(255,255,255,0.7)"}),this.map&&this.map.getSource("animCircleClusterData")&&this.map.getSource("animCircleClusterData").setData(this.data),setTimeout(function(){r.map&&r.animateCircles(t+1)},800)},t.prototype.doActions=function(r,i){var o=[],e=this.api.getProperty("AnimatedCircles.Actions");_.each(e,function(e,t){e.Value=e.Trigger===r?i[e.Current]:e.Target.get("value"),e._PropertyIndex=t,o.push(e)}),this.api.doActions(o,"AnimatedCircles.Actions")},t.prototype.displayTooltip=function(e,t,r,i){var o=this.api.getProperty("AnimatedCircles.Tooltip"),a=this.api.getProperty("AnimatedCircles.ShowTooltip"),r=r.geometry.coordinates.slice();this.app.showTooltip(e,o,a,r,i,t)},t);function t(e){var t=r.call(this,e)||this;return t.errors={},t.animatedCircleSource=void 0,t.animatedCirclesData=[],t.map=e.map,t.api=e.api,t.app=e.app,t.renderAnimatedCircles=_.debounce(function(){t.renderMapAnimatedCircles()},250),t.animateCircles=_.debounce(function(e){t.animate(e)},250),t}y=o.View,e(h,y),h.prototype.renderMapConcentricCircles=function(){this.concentricCircleSource=this.api.getProperty("ConcentricCircles").Datasource,this.concentricCircleSource&&(this.cleanUpSource(),this.removeLayers(),this.api.subscribe(this.concentricCircleSource,_.bind(this.onData,this)))},h.prototype.cleanUpSource=function(){this.concentricCircleSource&&(this.stopListening(this.concentricCircleSource),this.api.unsubscribe(this.concentricCircleSource))},h.prototype.onConcentricCirclesChange=function(e,t){this.cleanUpSource(),t&&(this.concentricCircleSource=t,this.renderConcentricCircles())},h.prototype.onData=function(e,t,r){if(r)return this.updateError("ConcentricCircle Source",r);r=this.concentricCircleSource.dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("ConcentricCircles.possibleConcentricCircles",[""].concat(r)),this.concentricCirclesData=t.items?t.items():this.concentricCircleSource.dataSet.collection.models.map(function(e){return e.attributes}),this.addSource()},h.prototype.resetData=function(){this.addSource()},h.prototype.getConcentricCircleArray=function(e){var t=this.api.getProperty("ConcentricCircles.Radius");return"string"==typeof t&&e&&Array.isArray(e[t])?e[t]:[5,10,15]},h.prototype.getConcentricCircleColors=function(e,t){var r=[],i=this.api.getProperty("ConcentricCircles.Colors");"string"==typeof i&&e&&Array.isArray(e[i])&&(r=e[i]);for(var o=0;o<=t;o++)_.isNil(e[o])&&r.push("#11b4da");return r},h.prototype.addSource=function(){var e,l=this,i=(this.api.getProperty("ConcentricCircles.Id"),this.api.getProperty("ConcentricCircles.Lat")),o=this.api.getProperty("ConcentricCircles.Lng"),p=this.api.getProperty("ConcentricCircles.BorderWidth");this.removeLayers(),this.data={type:"FeatureCollection",crs:{type:"name",properties:{name:"concentricCircleDataCrs"}},features:[]},null!=(e=this.concentricCirclesData)&&e.length&&this.concentricCirclesData.forEach(function(e,a){var t=l.getConcentricCircleArray(e),n=l.getConcentricCircleColors(e,t.length),r=null!=(r=null==e?void 0:e[i])?r:0,s=[null!=(e=null==e?void 0:e[o])?e:0,r];l.isValidCoordinate(s)&&t.forEach(function(e,t){var r=null!=(r=null==n?void 0:n[t])?r:"#11b4da",i=p?parseFloat(p):1,e=d.circle(s,e,{steps:64,units:"kilometers"}),o="location-radius-".concat(a,"-").concat(t),t="location-radius-outline-".concat(a,"-").concat(t);l.circleSource.push(o),l.circleLayer.push(t),l.addCircleToMap(o,t,e,r,i)})})},h.prototype.isValidCoordinate=function(e){return!isNaN(e[0])&&!isNaN(e[1])},h.prototype.addCircleToMap=function(e,t,r,i,o){this.map&&(this.map.addSource(e,{type:"geojson",data:r}),r=this.api.getProperty("ConcentricCircles.Name"),this.map.addLayer({id:r+t,type:"line",source:e,paint:{"line-color":i,"line-width":o}}))},h.prototype.getIntersectedPoints=function(){},h.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},h.prototype.removeLayerByName=function(t){var r=this,e=_.filter(this.app.map.getLayersOrder(),function(e){return 0<=e.indexOf(t)});_.each(e,function(e){r.map.getLayer(e)&&r.map.removeLayer(e)})},h.prototype.removeLayers=function(){var t=this;_.each(this.circleLayer,function(e){t.removeLayerByName(e)}),_.each(this.circleSource,function(e){t.map.getSource(e)&&t.map.removeSource(e)})};var y,U=h;function h(e){var t=y.call(this,e)||this;return t.errors={},t.concentricCircleSource=void 0,t.concentricCirclesData=[],t.circleLayer=[],t.circleSource=[],t.map=e.map,t.api=e.api,t.app=e.app,t.renderConcentricCircles=_.debounce(function(){t.renderMapConcentricCircles()},250),t}m=o.View,e(g,m),g.prototype.renderCircleLayer=function(e,t){this.renderCircleByLayer(e)},g.prototype.renderMapCircles=function(){var r=this;_.each(this.api.getProperty("Circles"),function(e,t){r.renderMapCircleLayer(t)})},g.prototype.renderMapCircleLayer=function(e){this.circleSource[e]=_.get(this.api.getProperty("Circles.".concat(e)),"DataSource"),this.cleanUpSource(e),this.removeLayers(e),this.api.subscribe(this.circleSource[e],_.bind(this.onData,this,e))},g.prototype.cleanUpSource=function(e){this.circleSource&&this.circleSource[e]&&(this.stopListening(this.circleSource[e]),this.api.unsubscribe(this.circleSource[e]))},g.prototype.onCirclesChange=function(e,t,r){this.cleanUpSource(r),t&&(this.circleSource[r]=t,this.renderMapCircleLayer(r))},g.prototype.onData=function(e,t,r,i){if(i)return this.updateError("Circle Source",i);i=this.circleSource[e].dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("Circles.".concat(e,".possibleCircles"),[""].concat(i)),this.circlesData[e]=r.items?r.items():this.circleSource[e].dataSet.collection.models.map(function(e){return e.attributes}),r.reset?this.resetData(e):(this.sourceToJSON(e),this.drawData(e)),this.app.renderAnnotationFromViewstate()},g.prototype.resetData=function(e){this.sourceToJSON(e),this.addSource(e)},g.prototype.sourceToJSON=function(r){var i=this,o=this.api.getProperty("Circles.".concat(r,".ID")),a=this.api.getProperty("Circles.".concat(r,".UseLabel")),n=this.api.getProperty("Circles.".concat(r,".Label")),s=this.api.getProperty("Circles.".concat(r,".LabelSize")),l=this.api.getProperty("Circles.".concat(r,".Color")),p=this.api.getProperty("Circles.".concat(r,".StrokeColor")),c=this.api.getProperty("Circles.".concat(r,".StrokeWidth")),u=this.api.getProperty("Circles.".concat(r,".Radius")),d=this.api.getProperty("Circles.".concat(r,".CircleOpacity")),y=this.api.getProperty("Circles.".concat(r,".Latitude")),h=this.api.getProperty("Circles.".concat(r,".Longitude")),m=this.api.getProperty("Circles.".concat(r,".Altitude"));this.data[r]={type:"FeatureCollection",crs:{type:"name",properties:{name:"circleCrs"}},features:[]},_.each(this.circlesData[r],function(e,t){t={id:_.isNil(o)?t:e[o],strokeColor:_.isNil(p)||!e[p]?"#ffffff":e[p],strokeWidth:_.isNil(c)||!e[c]?1:parseFloat(e[c]),radius:_.isNil(u)||!e[u]?4:parseFloat(e[u]),color:_.isNil(l)||!e[l]?"#11b4da":e[l],"circle-opacity":parseFloat(d)/100};a&&_.extend(t,{label:_.isNil(n)?"":e[n],labelSize:_.isNil(s)||!e[s]?10:parseFloat(e[s]),color:_.isNil(l)||!e[l]?"#11b4da":e[l]}),i.data[r].features.push({type:"Feature",properties:t,geometry:{type:"Point",coordinates:[_.isNil(h)||!e[h]?0:e[h],_.isNil(y)||!e[y]?0:e[y],_.isNil(m)||!e[m]?0:e[m]]}})}),this.api.getProperty("Annotation.Enable")&&(this.previousData[r]=_.cloneDeep(this.data[r]))},g.prototype.updateSelected=function(e){var t,r,i,o,a,n,s,l,p,c,u,d,y,h,m;this.api.getProperty("Circles.".concat(e,".TrackSelected"))&&(t=this.api.getProperty("Circles.".concat(e,".Selected.SelectedItem")),r=this.api.getProperty("Circles.".concat(e,".Selected.Column")),i=this.api.getProperty("Circles.".concat(e,".Selected.Color")),o=this.api.getProperty("Circles.".concat(e,".ID")),a=this.api.getProperty("Circles.".concat(e,".StrokeColor")),n=this.api.getProperty("Circles.".concat(e,".StrokeWidth")),s=this.api.getProperty("Circles.".concat(e,".Radius")),l=this.api.getProperty("Circles.".concat(e,".CircleOpacity")),p=this.api.getProperty("Circles.".concat(e,".Latitude")),c=this.api.getProperty("Circles.".concat(e,".Longitude")),u=this.api.getProperty("Circles.".concat(e,".Altitude")),d=this.api.getProperty("Circles.".concat(e,".ClusterMaxZoom")),y=this.api.getProperty("Circles.".concat(e,".ClusterRadius")),h={type:"FeatureCollection",crs:{type:"name",properties:{name:"circleSelectedCrs"}},features:[]},m=_.filter(this.circlesData[e],function(e){return e[r]===t}),_.each(m,function(e,t){t={id:_.isNil(o)?t:e[o],strokeColor:_.isNil(a)||!e[a]?"#ffffff":e[a],strokeWidth:_.isNil(n)||!e[n]?1:parseFloat(e[n]),radius:_.isNil(s)||!e[s]?4:parseFloat(e[s]),color:i,"circle-opacity":parseFloat(l)/100};h.features.push({type:"Feature",properties:t,geometry:{type:"Point",coordinates:[_.isNil(c)||!e[c]?0:e[c],_.isNil(p)||!e[p]?0:e[p],_.isNil(u)||!e[u]?0:e[u]]}})}),this.map.getLayer("selectedCircleLayer"+e)&&this.map.removeLayer("selectedCircleLayer"+e),this.map.getSource("selectedCircles"+e)&&this.map.removeSource("selectedCircles"+e),this.map.addSource("selectedCircles"+e,{type:"geojson",data:h,cluster:!1,clusterMaxZoom:d,clusterRadius:y}),this.map.addLayer({id:"selectedCircleLayer"+e,type:"circle",source:"selectedCircles"+e,filter:["!",["has","point_count"]],paint:{"circle-color":["get","color"],"circle-radius":["get","radius"],"circle-stroke-width":["get","strokeWidth"],"circle-stroke-color":["get","strokeColor"],"circle-opacity":["get","circle-opacity"],"circle-stroke-opacity":["get","circle-opacity"]}}))},g.prototype.addSelectedBounds=function(e,t,r){var i=this,o=this.api.getProperty("Bounds.PointClickRadius"),t=[[[t+o,e+o],[t-o,e+o],[t-o,e-o],[t+o,e-o],[t+o,e+o]]];this.removeSelectedBounds(),this.map.addSource("boundData2",{type:"geojson",data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Polygon",coordinates:t}}]}}),this.map.addLayer({id:"circleBounds2",type:"line",source:"boundData2",layout:{},paint:{"line-width":1,"line-color":"#5b94c6"}}),this.addBoundingBtn&&this.el.querySelector(".mapbox-gl-draw_trash")&&((e=document.createElement("button")).className="mapbox-gl-draw_ctrl-draw-btn mapbox-gl-draw_undo",e.title="Undo bounds",this.el.querySelector(".mapbox-gl-draw_trash").parentElement.append(e),this.el.querySelector(".mapbox-gl-draw_undo").addEventListener("click",function(){i.undoBounds()}),this.addBoundingBtn=!1,this.filterCircles(this.map.getSource("boundData2"),t))},g.prototype.removeSelectedBounds=function(){this.map.getLayer("circleBounds2")&&this.map.removeLayer("circleBounds2"),this.map.getSource("boundData2")&&this.map.removeSource("boundData2");var e=this.el.querySelector(".mapbox-gl-draw_undo");e&&(e.removeEventListener("click",this.undoBounds),e.remove())},g.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},g.prototype.resetCircles=function(){var r=this;_.each(this.data,function(e,t){r.data[t]=_.cloneDeep(r.previousData[t]),r.drawData(t),r.pointsInView(t)})},g.prototype.filterCircles=function(o,a){var r=this;this.api.getProperty("Annotation.Filter")&&_.each(this.data,function(i,e){var t;i=_.cloneDeep(r.previousData[e]),_.get(i,"features")&&(_.each(i.features,function(t,r){_.each(o.features,function(e){"LineString"!==_.get(e,"geometry.type")&&d.inside(d.point(t.geometry.coordinates),_.isNil(a)?d.polygon(e.geometry.coordinates):d.polygon(a))&&(i.features[r].filtered=!0)})}),r.data[e].features=_.filter(i.features,function(e){return e.filtered}),r.api.getProperty("Circles.".concat(e,".ID"))&&(t=_.map(_.filter(i.features,function(e){return _.get(e,"filtered")}),function(e){return e.properties.id}),r.api.setProperty("Circles.".concat(e,".Selected.SelectedZoomedItems"),t,{silent:!0})),r.drawData(e))})},g.prototype.drawData=function(e){this.map&&this.map.getSource("circClusterData"+e)&&(this.map.getSource("circClusterData"+e).setData(this.data[e]),this.pointsInView(e))},g.prototype.removeLayers=function(e){this.removeLayerByName("circle-cluster-count"+e),this.removeLayerByName("unclustered-circle"+e),this.removeLayerByName("unclustered-circle-lbl"+e),this.removeLayerByName("circleClusters"+e),this.map.getSource("circClusterData"+e)&&this.map.removeSource("circClusterData"+e)},g.prototype.removeLayerByName=function(t){var r=this,e=_.filter(this.app.map.getLayersOrder(),function(e){return 0<=e.indexOf(t)});_.each(e,function(e){r.map.getLayer(e)&&r.map.removeLayer(e)})},g.prototype.addSource=function(s){var e,t,r,i,o,a,n,l=this;_.isNil(this.data)||_.isNil(this.data[s])||(e=this.api.getProperty("Circles.".concat(s,".Cluster")),t=this.api.getProperty("Circles.".concat(s,".UseLabel")),a=this.api.getProperty("MapDetails.Offline"),n=this.api.getProperty("TileServer.Enable"),r=this.api.getProperty("Circles.".concat(s,".ClusterMaxZoom")),i=this.api.getProperty("Circles.".concat(s,".ClusterRadius")),o=this.api.getProperty("Circles.".concat(s,".Name")),a=a?["OpenSansBold"]:["Arial Unicode MS Bold"],n&&(a=[this.api.getProperty("TileServer.Font")]),this.removeLayers(s),this.map.addSource("circClusterData"+s,{type:"geojson",data:this.data[s],cluster:e,clusterMaxZoom:r,clusterRadius:i}),e&&(this.map.addLayer({id:"circleClusters"+s,type:"circle",source:"circClusterData"+s,filter:["has","point_count"],paint:{"circle-color":["step",["get","point_count"],"#51bbd6",100,"#f1f075",750,"#f28cb1"],"circle-radius":["step",["get","point_count"],20,100,30,750,40]}}),this.map.addLayer({id:"circle-cluster-count"+s,type:"symbol",source:"circClusterData"+s,filter:["has","point_count"],layout:{"text-field":["get","point_count_abbreviated"],"text-font":a,"text-size":12}})),n={"text-font":a,"text-field":["get","label"],"text-variable-anchor":["top","bottom","left","right"],"text-radial-offset":1,"text-size":["get","labelSize"],"text-justify":"auto","text-allow-overlap":!1},this.map.addLayer({id:o+"unclustered-circle"+s,type:"circle",source:"circClusterData"+s,filter:["!",["has","point_count"]],paint:{"circle-color":["get","color"],"circle-radius":["get","radius"],"circle-stroke-width":["get","strokeWidth"],"circle-stroke-color":["get","strokeColor"],"circle-opacity":["get","circle-opacity"],"circle-stroke-opacity":["get","circle-opacity"]}}),t&&this.map.addLayer({id:"unclustered-circle-lbl"+s,source:"circClusterData"+s,filter:["!",["has","point_count"]],type:"symbol",layout:n}),this.map.on("click","circleClusters"+s,function(e){var r=l.map.queryRenderedFeatures(e.point,{layers:["circleClusters"+s]}),e=r[0].properties.cluster_id;l.map.getSource("circClusterData"+s).getClusterExpansionZoom(e,function(e,t){e||l.map.easeTo({center:r[0].geometry.coordinates,zoom:t})})}),this.map.on("mouseenter",o+"unclustered-circle"+s,function(e){var t=e.features[0],r=_.get(t,"properties.id"),i=l.api.getProperty("Circles.".concat(s,".ID")),o=_.filter(l.circlesData[s],function(e){return e[i]===r});l.displayTooltip(e,o,t,r,s),0<o.length&&l.doActions("Hover",o[0],s)}),this.map.on("mouseleave",o+"unclustered-circle"+s,function(e){l.app.hideTooltip()}),this.map.on("click",o+"unclustered-circle"+s,function(e){var t,r,i,o=e.features[0],a=_.get(o,"properties.id"),n=l.api.getProperty("Circles.".concat(s,".ID")),o=_.filter(l.circlesData[s],function(e){return e[n]===a});0<o.length&&l.doActions("Click",o[0],s),l.api.getProperty("Circles.".concat(s,".ZoomOnSelect"))&&l.map.flyTo({center:e.features[0].geometry.coordinates,zoom:l.map.getZoom()+1}),l.api.getProperty("Bounds.PointClick")&&(o=l.api.getProperty("Bounds.PointClickRadius")/100,e=_.get(e,"lngLat"))&&(t=e.lat+o,r=e.lat-o,i=e.lng+o,o=e.lng-o,l.addSelectedBounds(e.lat,e.lng),l.api.setProperty("Bounds.PointClickBounds",[[r,o],[t,i]]))}),this.map.on("contextmenu",o+"unclustered-circle"+s,function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=l.api.getProperty("Circles.".concat(s,".ID")),e=_.filter(l.circlesData[s],function(e){return e[r]===t});0<e.length&&l.doActions("Right Click",e[0],s)}),this.map.on("dblclick",o+"unclustered-circle"+s,function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=l.api.getProperty("Circles.".concat(s,".ID")),e=_.filter(l.circlesData[s],function(e){return e[r]===t});0<e.length&&l.doActions("Double Click",e[0],s)}),this.pointsInView(s),this.updateSelected(s))},g.prototype.pointsInView=function(e){var t;this.api.getProperty("Circles.".concat(e,".CirclesInView"))&&(t={type:"FeatureCollection",crs:{type:"name",properties:{name:"circleCrs"}},features:[]},_.each(this.data,function(e){t.features=t.features.concat(e.features)}),this.map.fitBounds(d.bbox(t)))},g.prototype.doActions=function(r,i,e){var o=[],t=this.api.getProperty("Circles.".concat(e,".Actions"));_.each(t,function(e,t){e.Value=e.Trigger===r?i[e.Current]:e.Target.get("value"),e._PropertyIndex=t,o.push(e)}),this.api.doActions(o,"Circles.".concat(e,".Actions"))},g.prototype.displayTooltip=function(e,t,r,i,o){var a=this.api.getProperty("Circles.".concat(o,".Tooltip")),o=this.api.getProperty("Circles.".concat(o,".ShowTooltip")),r=r.geometry.coordinates.slice();this.app.showTooltip(e,a,o,r,i,t)};var m,j=g;function g(e){var t=m.call(this,e)||this;return t.errors={},t.circleSource={},t.circlesData={},t.data={},t.previousData={},t.addBoundingBtn=!0,t.map=e.map,t.api=e.api,t.el=e.el,t.app=e.app,t.renderCircles=_.debounce(function(){t.renderMapCircles()},250),t.renderCircleByLayer=_.debounce(function(e){t.renderMapCircleLayer(e)},250),t.undoBounds=function(){t.resetCircles(),t.removeSelectedBounds(),t.el.querySelector(".mapbox-gl-draw_undo").remove(),t.addBoundingBtn=!0},t}f=o.View,e(S,f),S.prototype.renderMapPoints=function(){var r=this;_.each(this.api.getProperty("Points"),function(e,t){r.renderMapPointsLayer(t)})},S.prototype.renderMapPointsLayer=function(e){var t=this,r=(this.pointsSource[e]=_.get(this.api.getProperty("Points.".concat(e)),"DataSource"),this.cleanUpSource(e),this.removeLayers(e),this.api.subscribe(this.pointsSource[e],_.bind(this.onData,this,e)),location.origin+location.pathname.replace("/edit","")+"/modules/"+this.path+"/css/assets/images/"),i=_.map(this.api.getProperty("Icons"),function(e){return{url:r+e.name+".png",id:e.name}});this.addImages(i).then(function(){t.api.subscribe(t.pointsSource[e],_.bind(t.onData,t))})},S.prototype.cleanUpSource=function(e){this.pointsSource&&this.pointsSource[e]&&(this.stopListening(this.pointsSource[e]),this.api.unsubscribe(this.pointsSource[e]))},S.prototype.onPointsChange=function(e,t,r){this.cleanUpSource(r),t&&(this.pointsSource[r]=t,this.renderMapPointsLayer(r))},S.prototype.onData=function(e,t,r,i){if(i)return this.updateError("Points Source",i);i=this.pointsSource[e].dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("Points.".concat(e,".possiblePoints"),[""].concat(i)),this.pointsData[e]=r.items?r.items():this.pointsSource[e].dataSet.collection.models.map(function(e){return e.attributes}),r.reset?this.resetData(e):(this.sourceToJSON(e),this.drawData(e)),this.app.renderAnnotationFromViewstate()},S.prototype.resetData=function(e){this.sourceToJSON(e),this.addSource(e)},S.prototype.sourceToJSON=function(r){var i=this,o=this.api.getProperty("Points.".concat(r,".ID")),a=this.api.getProperty("Points.".concat(r,".UseLabel")),n=this.api.getProperty("Points.".concat(r,".Label")),s=this.api.getProperty("Points.".concat(r,".LabelSize")),l=this.api.getProperty("Points.".concat(r,".Color")),p=""===l?"_t":"",c=this.api.getProperty("Points.".concat(r,".Icon")),u=this.api.getProperty("Points.".concat(r,".IconRotation")),d=this.api.getProperty("Points.".concat(r,".IconScale")),y=this.api.getProperty("Points.".concat(r,".IconOpacity")),h=this.api.getProperty("Points.".concat(r,".Latitude")),m=this.api.getProperty("Points.".concat(r,".Longitude")),g=this.api.getProperty("Points.".concat(r,".Altitude")),f=parseFloat(this.api.getProperty("Points.".concat(r,".IconScaleInterpolate.Stop1Percent")))/100;this.data[r]={type:"FeatureCollection",crs:{type:"name",properties:{name:"clusterCrs"}},features:[]},_.each(this.pointsData[r],function(e,t){t={id:_.isNil(o)?t:e[o],icon:_.isNil(c)||!e[c]?"default":e[c]+p,iconRotation:_.isNil(u)||!e[u]?0:parseFloat(e[u]),iconScale:_.isNil(d)||!e[d]?1:parseFloat(e[d]),iconScaleMin:_.isNil(d)||!e[d]?.25:parseFloat(e[d])*f,color:_.isNil(l)||!e[l]?"#11b4da":e[l],"icon-opacity":parseFloat(y)/100};a&&_.extend(t,{label:_.isNil(n)?"":e[n],labelSize:_.isNil(s)||!e[s]?10:e[s]}),i.data[r].features.push({type:"Feature",properties:t,geometry:{type:"Point",coordinates:[_.isNil(m)||!e[m]?0:e[m],_.isNil(h)||!e[h]?0:e[h],_.isNil(g)||!e[g]?0:e[g]]}})}),this.api.getProperty("Annotation.Enable")&&(this.previousData[r]=_.cloneDeep(this.data[r]))},S.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},S.prototype.resetPoints=function(){var r=this;_.each(this.data,function(e,t){r.data[t]=_.cloneDeep(r.previousData[t]),r.drawData(t),r.pointsInView(t)})},S.prototype.filterPoints=function(o,a){var r=this;this.api.getProperty("Annotation.Filter")&&_.each(this.data,function(i,e){var t;i=_.cloneDeep(r.previousData[e]),_.get(i,"features")&&(_.each(i.features,function(t,r){_.each(o.features,function(e){"LineString"!==_.get(e,"geometry.type")&&d.inside(d.point(t.geometry.coordinates),_.isNil(a)?d.polygon(e.geometry.coordinates):d.polygon(a))&&(i.features[r].filtered=!0)})}),r.data[e].features=_.filter(i.features,function(e){return e.filtered}),r.api.getProperty("Points.".concat(e,".ID"))&&(t=_.map(_.filter(i.features,function(e){return _.get(e,"filtered")}),function(e){return e.properties.id}),r.api.setProperty("Points.".concat(e,".Selected.SelectedZoomedItems"),t,{silent:!0})),r.drawData(e))})},S.prototype.addImages=function(r){return a(this,void 0,void 0,function(){var t,o=this;return n(this,function(e){return t=function(r,i){return a(o,void 0,void 0,function(){var t;return n(this,function(e){switch(e.label){case 0:return[4,this.map.loadImage(i)];case 1:return t=e.sent(),this.map.style.getImage(r)||(this.map.addImage(r,t.data,{sdf:!0}),this.map.addImage(r+"_t",t.data,{sdf:!1})),[2]}})})},r.map(function(e){return t(e.id,e.url)}),[2]})})},S.prototype.drawData=function(e){this.map&&this.map.getSource("clusterData"+e)&&(this.map.getSource("clusterData"+e).setData(this.data[e]),this.pointsInView(e))},S.prototype.removeLayers=function(e){this.removeLayerByName("cluster-count"+e),this.removeLayerByName("unclustered-point"+e),this.removeLayerByName("unclustered-point-lbl"+e),this.removeLayerByName("cluster-clustered-point"+e),this.map.getSource("clusterData"+e)&&this.map.removeSource("clusterData"+e),this.removeSelectedBounds()},S.prototype.removeLayerByName=function(t){var r=this,e=_.filter(this.app.map.getLayersOrder(),function(e){return 0<=e.indexOf(t)});_.each(e,function(e){r.map.getLayer(e)&&r.map.removeLayer(e)})},S.prototype.updateSelected=function(e){var t,r,i,o,a,n,s,l,p,c,u,d,y,h,m,g,f,S,C,L,b;this.api.getProperty("Points.".concat(e,".TrackSelected"))&&(t=this.api.getProperty("Points.".concat(e,".Selected.SelectedItem")),r=this.api.getProperty("Points.".concat(e,".Selected.Column")),i=this.api.getProperty("Points.".concat(e,".Selected.Color")),o=""===i?"_t":"",a=this.api.getProperty("Points.".concat(e,".ID")),n=this.api.getProperty("Points.".concat(e,".Icon")),s=this.api.getProperty("Points.".concat(e,".IconRotation")),l=this.api.getProperty("Points.".concat(e,".IconScale")),p=this.api.getProperty("Points.".concat(e,".IconOpacity")),c=this.api.getProperty("Points.".concat(e,".Latitude")),u=this.api.getProperty("Points.".concat(e,".Longitude")),d=this.api.getProperty("Points.".concat(e,"..Altitude")),y=this.api.getProperty("Points.".concat(e,".ClusterMaxZoom")),h=this.api.getProperty("Points.".concat(e,".ClusterRadius")),m=this.api.getProperty("Points.".concat(e,".IconInterpolate")),g=this.api.getProperty("Points.".concat(e,".IconScaleInterpolate.ZoomStop1")),f=this.api.getProperty("Points.".concat(e,".IconScaleInterpolate.ZoomStop2")),S=parseFloat(this.api.getProperty("Points.".concat(e,".IconScaleInterpolate.Stop1Percent")))/100,C=this.api.getProperty("Points.".concat(e,".IconScaleInterpolate.Exponential")),L={type:"FeatureCollection",crs:{type:"name",properties:{name:"clusterSelectedCrs"}},features:[]},b=_.filter(this.pointsData[e],function(e){return e[r]===t}),_.each(b,function(e,t){t={id:_.isNil(a)?t:e[a],icon:_.isNil(n)||!e[n]?"default":e[n]+o,iconRotation:_.isNil(s)||!e[s]?0:parseFloat(e[s]),iconScale:_.isNil(l)||!e[l]?1:parseFloat(e[l]),iconScaleMin:_.isNil(l)||!e[l]?.25:parseFloat(e[l])*S,"icon-opacity":parseFloat(p)/100,color:i};L.features.push({type:"Feature",properties:t,geometry:{type:"Point",coordinates:[_.isNil(u)||!e[u]?0:e[u],_.isNil(c)||!e[c]?0:e[c],_.isNil(d)||!e[d]?0:e[d]]}})}),this.map.getLayer("selectedPointsLayer"+e)&&this.map.removeLayer("selectedPointsLayer"+e),this.map.getSource("selectedPoints")+e&&this.map.removeSource("selectedPoints"+e),this.map.addSource("selectedPoints"+e,{type:"geojson",data:L,cluster:!1,clusterMaxZoom:y,clusterRadius:h}),this.map.addLayer({id:"selectedPointsLayer"+e,type:"symbol",layout:{"icon-allow-overlap":!0,"icon-image":["get","icon"],"icon-size":m?["interpolate",["exponential",C],["zoom"],g,["get","iconScaleMin"],f,["get","iconScale"]]:["get","iconScale"],"icon-rotate":["get","iconRotation"]},source:"selectedPoints"+e,filter:["!",["has","point_count"]],paint:{"icon-color":["get","color"]}}))},S.prototype.addSelectedBounds=function(e,t,r){var i=this,o=this.api.getProperty("Bounds.PointClickRadius"),t=[[[t+o,e+o],[t-o,e+o],[t-o,e-o],[t+o,e-o],[t+o,e+o]]];this.removeSelectedBounds(),this.map.addSource("boundData",{type:"geojson",data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Polygon",coordinates:t}}]}}),this.map.addLayer({id:"circleBounds",type:"line",source:"boundData",layout:{},paint:{"line-width":1,"line-color":"#5b94c6"}}),this.addBoundingBtn&&this.el.querySelector(".mapbox-gl-draw_trash")&&((e=document.createElement("button")).className="mapbox-gl-draw_ctrl-draw-btn mapbox-gl-draw_undo",e.title="Undo bounds",this.el.querySelector(".mapbox-gl-draw_trash").parentElement.append(e),this.el.querySelector(".mapbox-gl-draw_undo").addEventListener("click",function(){i.undoBounds()}),this.filterPoints(this.map.getSource("boundData"),t))},S.prototype.removeSelectedBounds=function(){this.map.getLayer("circleBounds")&&this.map.removeLayer("circleBounds"),this.map.getSource("boundData")&&this.map.removeSource("boundData");var e=this.el.querySelector(".mapbox-gl-draw_undo");e&&e.removeEventListener("click",this.undoBounds)},S.prototype.addSource=function(l){var e,t,r,i,o,a,n,s,p,c,u,d=this;_.isNil(this.data)||_.isNil(this.data[l])||(e=this.api.getProperty("Points.".concat(l,".Cluster")),t=this.api.getProperty("Points.".concat(l,".UseLabel")),c=this.api.getProperty("MapDetails.Offline"),u=this.api.getProperty("TileServer.Enable"),r=this.api.getProperty("Points.".concat(l,".ClusterMaxZoom")),i=this.api.getProperty("Points.".concat(l,".ClusterRadius")),o=this.api.getProperty("Points.".concat(l,".IconInterpolate")),a=this.api.getProperty("Points.".concat(l,".IconScaleInterpolate.ZoomStop1")),n=this.api.getProperty("Points.".concat(l,".IconScaleInterpolate.ZoomStop2")),s=this.api.getProperty("Points.".concat(l,".IconScaleInterpolate.Exponential")),p=this.api.getProperty("Points.".concat(l,".Name")),c=c?["OpenSansBold"]:["Open%20Sans%20Semibold"],u&&(c=[this.api.getProperty("TileServer.Font")]),this.removeLayers(l),this.map.addSource("clusterData"+l,{type:"geojson",data:this.data[l],cluster:e,clusterMaxZoom:r,clusterRadius:i}),e&&(this.map.addLayer({id:p+"cluster-clustered-point"+l,type:"circle",source:"clusterData"+l,filter:["has","point_count"],paint:{"circle-color":["step",["get","point_count"],"#51bbd6",100,"#f1f075",750,"#f28cb1"],"circle-radius":["step",["get","point_count"],20,100,30,750,40]}}),this.map.addLayer({id:p+"cluster-count"+l,type:"symbol",source:"clusterData"+l,filter:["has","point_count"],layout:{"text-field":["get","point_count_abbreviated"],"text-font":c,"text-size":12}})),u={"icon-allow-overlap":!0,"icon-image":["get","icon"],"icon-size":o?["interpolate",["exponential",s],["zoom"],a,["get","iconScaleMin"],n,["get","iconScale"]]:["get","iconScale"],"icon-rotate":["get","iconRotation"]},this.map.addLayer({id:p+"unclustered-point"+l,source:"clusterData"+l,filter:["!",["has","point_count"]],type:"symbol",layout:t?_.extend(u,{"text-font":c,"text-field":["get","label"],"text-variable-anchor":["top","bottom","left","right"],"text-radial-offset":1,"text-size":["get","labelSize"],"text-justify":"auto","text-allow-overlap":!1}):u,paint:{"icon-color":["get","color"],"icon-opacity":["get","icon-opacity"]}}),this.map.on("click",p+"cluster-clustered-point"+l,function(e){var r=d.map.queryRenderedFeatures(e.point,{layers:[p+"cluster-clustered-point"+l]}),e=r[0].properties.cluster_id;d.map.getSource("clusterData"+l).getClusterExpansionZoom(e,function(e,t){e||d.map.easeTo({center:r[0].geometry.coordinates,zoom:t})})}),this.map.on("mouseenter",p+"unclustered-point"+l,function(e){var t=e.features[0],r=_.get(t,"properties.id"),i=d.api.getProperty("Points.".concat(l,".ID")),o=_.filter(d.pointsData[l],function(e){return e[i]===r});d.displayTooltip(e,o,t,r,l),0<o.length&&d.doActions("Hover",o[0],l)}),this.map.on("mouseleave",p+"unclustered-point"+l,function(e){d.app.hideTooltip()}),this.map.on("click",p+"unclustered-point"+l,function(e){var t,r,i,o,a=e.features[0],n=_.get(a,"properties.id"),s=d.api.getProperty("Points.".concat(l,".ID")),a=_.filter(d.pointsData[l],function(e){return e[s]===n});0<a.length&&(d.doActions("Click",a[0],l),d.api.getProperty("Bounds.PointClick")&&(a=d.api.getProperty("Bounds.PointClickRadius")/100,t=_.get(e,"lngLat"))&&(r=t.lat+a,i=t.lat-a,o=t.lng+a,a=t.lng-a,d.addSelectedBounds(t.lat,t.lng,l),d.api.setProperty("Bounds.PointClickBounds",[[i,a],[r,o]])),d.api.getProperty("Points.".concat(l,".ZoomOnSelect")))&&d.map.flyTo({center:e.features[0].geometry.coordinates,zoom:d.map.getZoom()+1})}),this.map.on("dblclick",p+"unclustered-point"+l,function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=d.api.getProperty("Points.".concat(l,".ID")),e=_.filter(d.pointsData[l],function(e){return e[r]===t});0<e.length&&d.doActions("Double Click",e[0],l)}),this.map.on("contextmenu",p+"unclustered-point"+l,function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=d.api.getProperty("Points.".concat(l,".ID")),e=_.filter(d.pointsData[l],function(e){return e[r]===t});0<e.length&&d.doActions("Right Click",e[0],l)}),this.pointsInView(l),this.updateSelected(l))},S.prototype.pointsInView=function(e){this.api.getProperty("Points.".concat(e,".PointsInView"))&&this.map.fitBounds(d.bbox(this.data[e]))},S.prototype.doActions=function(r,i,e){var o=[],t=this.api.getProperty("Points.".concat(e,".Actions"));_.each(t,function(e,t){e.Value=e.Trigger===r?i[e.Current]:e.Target.get("value"),e._PropertyIndex=t,o.push(e)}),this.api.doActions(o,"Points.".concat(e,".Actions"))},S.prototype.displayTooltip=function(e,t,r,i,o){var a=this.api.getProperty("Points.".concat(o,".Tooltip")),o=this.api.getProperty("Points.".concat(o,".ShowTooltip")),r=r.geometry.coordinates.slice();this.app.showTooltip(e,a,o,r,i,t)};var f,Z=S;function S(e){var t=f.call(this,e)||this;return t.errors={},t.pointsSource={},t.pointsData={},t.data={},t.previousData={},t.addBoundingBtn=!0,t.map=e.map,t.api=e.api,t.path=e.path,t.el=e.el,t.app=e.app,t.renderPoints=_.debounce(function(){t.renderMapPoints()},250),t.renderPointsByLayer=_.debounce(function(e){t.renderMapPointsLayer(e)},250),t.undoBounds=function(){t.resetPoints(),t.removeSelectedBounds(),t.el.querySelector(".mapbox-gl-draw_undo").remove(),t.addBoundingBtn=!0},t}C=o.View,e(L,C),L.prototype.renderMapHeatmaps=function(){this.heatmapSource=this.api.getProperty("Heatmap").DataSource,this.cleanUpSource(),this.removeLayers(),this.api.subscribe(this.heatmapSource,_.bind(this.onData,this)),this.renderGradient()},L.prototype.renderGradient=function(){var r,e,i=this;this.api.getProperty("Heatmap.ShowGradient")?(r=[],e=this.api.getProperty("Heatmap.Colors"),_.each(e,function(e,t){r.push(i.api.getProperty("Heatmap.Colors."+t+".color"))}),e=250/(0<r.length?r.length:1),this.el.querySelector(".maplibregl-ctrl-top-left").innerHTML=A.gradientBar({colors:r,width:e})):this.el.querySelector(".maplibregl-ctrl-top-left").innerHTML=""},L.prototype.cleanUpSource=function(){this.heatmapSource&&(this.stopListening(this.heatmapSource),this.api.unsubscribe(this.heatmapSource))},L.prototype.onHeatmapsChange=function(e,t){this.cleanUpSource(),t&&(this.heatmapSource=t,this.renderHeatmaps())},L.prototype.onData=function(e,t,r){if(r)return this.updateError("Heatmap Source",r);r=this.heatmapSource.dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("Heatmap.possibleHeatmap",[""].concat(r)),this.heatmapsData=t.items?t.items():this.heatmapSource.dataSet.collection.models.map(function(e){return e.attributes}),t.reset?this.resetData():(this.sourceToJSON(),this.drawData())},L.prototype.resetData=function(){this.sourceToJSON(),this.addSource()},L.prototype.sourceToJSON=function(){var i=this,o=this.api.getProperty("Heatmap.ID"),a=this.api.getProperty("Heatmap.Weight"),n=this.api.getProperty("Heatmap.Latitude"),s=this.api.getProperty("Heatmap.Longitude");this.data={type:"FeatureCollection",crs:{type:"name",properties:{name:"heatmapCrs"}},features:[]},_.each(this.heatmapsData,function(e,t){var r=[_.isNil(s)||!e[s]?0:e[s],_.isNil(n)?0:e[n]],t={weight:_.isNil(a)||!e[a]?1:e[a],id:_.isNil(o)||!e[o]?t:e[o]};i.data&&i.data.features.push({type:"Feature",geometry:{type:"Point",coordinates:r},properties:t})})},L.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},L.prototype.drawData=function(){this.map&&this.addSource()},L.prototype.removeLayers=function(){this.removeLayerByName("heatmap-heat"),this.removeLayerByName("heatmap-point"),this.map.getSource("heatmapData")&&this.map.removeSource("heatmapData")},L.prototype.removeLayerByName=function(t){var r=this,e=_.filter(this.app.map.getLayersOrder(),function(e){return 0<=e.indexOf(t)});_.each(e,function(e){r.map.getLayer(e)&&r.map.removeLayer(e)})},L.prototype.addSource=function(){var i,o,a,e,n=this;_.isNil(this.data)||(this.removeLayers(),this.map.addSource("heatmapData",{type:"geojson",data:this.data}),i=[],o=[],a=this.api.getProperty("Heatmap.Colors"),e=this.api.getProperty("Heatmap.Name"),_.each(a,function(e,t){var r=n.api.getProperty("Heatmap.Colors."+t+".color");i.push(t),i.push(r),o.push(t/(a.length-1)),o.push(0===t?"rgba(33,102,172,0)":r)}),this.map.addLayer({id:e+"heatmap-heat",type:"heatmap",source:"heatmapData",maxzoom:9,paint:{"heatmap-weight":["interpolate",["linear"],["get","weight"],0,0,6,1],"heatmap-intensity":["interpolate",["linear"],["zoom"],0,1,9,3],"heatmap-color":["interpolate",["linear"],["heatmap-density"]].concat(o),"heatmap-radius":["interpolate",["linear"],["zoom"],0,2,9,20],"heatmap-opacity":["interpolate",["linear"],["zoom"],7,1,9,0]}}),this.api.getProperty("Heatmap.ShowBaseCircles")&&this.map.addLayer({id:"heatmap-point",type:"circle",source:"heatmapData",minzoom:4,paint:{"circle-radius":["interpolate",["linear"],["zoom"],7,["interpolate",["linear"],["get","weight"],1,1,6,4],16,["interpolate",["linear"],["get","weight"],1,5,6,50]],"circle-color":["interpolate",["linear"],["get","weight"]].concat(i),"circle-stroke-color":"white","circle-stroke-width":1,"circle-opacity":["interpolate",["linear"],["zoom"],7,0,8,1]}}),this.map.on("mouseenter",e+"heatmap-heat",function(e){var t=e.features[0],r=_.get(t,"properties.id"),i=n.api.getProperty("Heatmap.ID"),o=_.filter(n.heatmapsData,function(e){return e[i]===r});n.displayTooltip(e,o,t,r),0<o.length&&n.doActions("Hover",o[0])}),this.map.on("mouseenter","heatmap-point",function(e){var t=e.features[0],r=_.get(t,"properties.id"),i=n.api.getProperty("Heatmap.ID"),o=_.filter(n.heatmapsData,function(e){return e[i]===r});n.displayTooltip(e,o,t,r),0<o.length&&n.doActions("Hover",o[0]),n.map.getCanvas().style.cursor="pointer"}),this.map.on("mouseleave","heatmap-point",function(e){n.app.hideTooltip(),n.map.getCanvas().style.cursor=""}),this.map.on("mouseleave","unclustered-point",function(e){n.app.hideTooltip()}),this.map.on("dblclick",e+"heatmap-heat",function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=n.api.getProperty("Heatmap.ID"),e=_.filter(n.heatmapsData,function(e){return e[r]===t});0<e.length&&n.doActions("Double Click",e[0])}),this.map.on("click",e+"heatmap-heat",function(e){var e=e.features[0],t=_.get(e,"properties.id"),r=n.api.getProperty("Heatmap.ID"),e=_.filter(n.heatmapsData,function(e){return e[r]===t});0<e.length&&n.doActions("Click",e[0])}))},L.prototype.doActions=function(r,i){var o=[],e=this.api.getProperty("Heatmap.Actions");_.each(e,function(e,t){e.Value=e.Trigger===r?i[e.Current]:e.Target.get("value"),e._PropertyIndex=t,o.push(e)}),this.api.doActions(o,"Heatmap.Actions")},L.prototype.displayTooltip=function(e,t,r,i){var o=this.api.getProperty("Heatmap.Tooltip"),a=this.api.getProperty("Heatmap.ShowTooltip"),r=r.geometry.coordinates.slice();this.app.showTooltip(e,o,a,r,i,t)};var C,V=L;function L(e){var t=C.call(this,e)||this;return t.errors={},t.heatmapSource=void 0,t.heatmapsData=[],t.map=e.map,t.api=e.api,t.el=e.el,t.app=e.app,t.renderHeatmaps=_.debounce(function(){t.renderMapHeatmaps()},250),t}b=o.View,e(P,b),P.prototype.renderMapHeatmaps=function(){this.heatmapSource=this.api.getProperty("HeatmapGrid").DataSource,this.cleanUpSource(),this.removeLayers(),this.api.subscribe(this.heatmapSource,_.bind(this.onData,this))},P.prototype.onHeatmapsChange=function(e,t){this.cleanUpSource(),t&&(this.heatmapSource=t,this.renderHeatmaps())},P.prototype.onData=function(e,t,r){if(r)return this.updateError("Heatmap Source",r);r=this.heatmapSource.dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("HeatmapGrid.possibleHeatmap",[""].concat(r)),this.heatmapsData=t.items?t.items():this.heatmapSource.dataSet.collection.models.map(function(e){return e.attributes}),t.reset?this.resetData():(this.sourceToJSON(),this.drawData())},P.prototype.resetData=function(){this.sourceToJSON(),this.addSource()},P.prototype.cleanUpSource=function(){this.heatmapSource&&(this.stopListening(this.heatmapSource),this.api.unsubscribe(this.heatmapSource))},P.prototype.sourceToJSON=function(){var i=this,o=this.api.getProperty("HeatmapGrid.ID"),a=this.api.getProperty("HeatmapGrid.Latitude"),n=this.api.getProperty("HeatmapGrid.Longitude");this.data={type:"FeatureCollection",crs:{type:"name",properties:{name:"heatmapCrs"}},features:[]},_.each(this.heatmapsData,function(e,t){var r=[_.isNil(n)||!e[n]?0:e[n],_.isNil(a)?0:e[a]],t={id:_.isNil(o)||!e[o]?t:e[o]};i.data&&_.get(i.data,"features")&&i.data.features.push({type:"Feature",geometry:{type:"Point",coordinates:r},properties:t})})},P.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},P.prototype.drawData=function(){this.map&&this.addSource()},P.prototype.removeLayers=function(){this.removeLayerByName("heatmap-grid"),this.map.getSource("heatmapGridData")&&this.map.removeSource("heatmapGridData"),this.isRendered=!1},P.prototype.removeLayerByName=function(t){var r=this,e=_.filter(this.app.map.getLayersOrder(),function(e){return 0<=e.indexOf(t)});_.each(e,function(e){r.map.getLayer(e)&&r.map.removeLayer(e)})},P.prototype.setZoomLevel=function(e){var t=this.api.getProperty("HeatmapGrid.Min"),r=this.api.getProperty("HeatmapGrid.Max");(0===t||t<=e)&&(0===r||e<=r)?this.isRendered||(this.removeLayers(),this.renderHeatmap()):this.removeLayers()},P.prototype.renderHeatmap=function(){var e,t,r,i,o,a,n,s,l,p,c,u=this;this.data&&(this.isRendered=!0,e=d.bbox(this.data),t=this.api.getProperty("HeatmapGrid.GridSize"),o="hexagon"===this.api.getProperty("HeatmapGrid.Shape"),r=this.api.getProperty("HeatmapGrid.Name"),i={},o=o?d.hexGrid(e,t,i):d.squareGrid(e,t,i),a=[],n=this.api.getProperty("HeatmapGrid.ShowZero"),o.id="heatmapGridSource",o.features.forEach(function(e){var t=d.pointsWithinPolygon(u.data,d.polygon(e.geometry.coordinates));e.properties={density:t.features.length,points:_.map(t.features,function(e){return e.properties.id})},a.push(t.features.length)}),s=_.max(a)||1,l=_.min(a)||0,o.features.forEach(function(e){var t=e.properties.density;e.properties.PropPercent=t?(t-l)/(s-l):0,e.properties.PropOpacity=n||t?.8:0}),p=["interpolate",["linear"],["get","PropPercent"]],c=this.api.getProperty("HeatmapGrid.Colors"),_.each(c,function(e,t){p.push(t/c.length),p.push(e.color)}),this.map.addSource("heatmapGridData",{type:"geojson",data:o}),this.map.addLayer({id:r+"heatmap-grid",type:"fill",source:"heatmapGridData",paint:{"fill-color":p,"fill-opacity":["get","PropOpacity"]}}),this.map.on("mousemove",r+"heatmap-grid",function(e){var t=u.getActionRowData(e);0<t.length&&(u.displayTooltip(e,t),0<t.length)&&u.doActions("Hover",t[0])}),this.map.on("dblclick",r+"heatmap-grid",function(e){e=u.getActionRowData(e);0<e.length&&u.doActions("Double Click",e[0])}),this.map.on("click",r+"heatmap-grid",function(e){e=u.getActionRowData(e);0<e.length&&u.doActions("Click",e[0])}))},P.prototype.getActionRowData=function(e){var t=JSON.parse(e.features[0].properties.points),r=this.api.getProperty("HeatmapGrid.ID");return _.filter(this.heatmapsData,function(e){return 0<=t.indexOf(e[r])})},P.prototype.addSource=function(){_.isNil(this.data)||(this.removeLayers(),this.setZoomLevel(this.map.getZoom()))},P.prototype.doActions=function(r,i){var o=[],e=this.api.getProperty("HeatmapGrid.Actions");_.each(e,function(e,t){e.Value=e.Trigger===r?i[e.Current]:e.Target.get("value"),e._PropertyIndex=t,o.push(e)}),this.api.doActions(o,"HeatmapGrid.Actions")},P.prototype.displayTooltip=function(e,t){var r=this.api.getProperty("HeatmapGrid.Tooltip"),i=this.api.getProperty("HeatmapGrid.ShowTooltip");this.app.showTooltip(e,r,i,e.lngLat,"id",t)};var b,z=P;function P(e){var t=b.call(this,e)||this;return t.errors={},t.heatmapSource=void 0,t.heatmapsData=[],t.isRendered=!1,t.map=e.map,t.api=e.api,t.el=e.el,t.app=e.app,t.renderHeatmaps=_.debounce(function(){t.renderMapHeatmaps()},250),t.renderHeatmaps=t.renderHeatmaps.bind(t),t}v=o.View,e(D,v),D.prototype.renderMapLayers=function(){var e=this.api.getProperty("Layers.DataSource");e&&_.get(e,"DataSource")&&(this.layerSource=e.DataSource,this.cleanUpSource(),this.removeLayers(),this.api.subscribe(this.layerSource,_.bind(this.onData,this)))},D.prototype.getColorScale=function(){var r=[],i=this.api.getProperty("Layers.DataSource.Palette");return _.each(i,function(e,t){r.push(t/i.length),r.push(e.type)}),r},D.prototype.addLayers=function(){var i,o,e,s=this,l=(this.api.getProperty("Layers.DataSource.File")&&(i="hostedLayerDataSource",o=this.api.getProperty("Layers.DataSource.Name"),e=this.api.getProperty("Layers.DataSource.File"))&&(t=location.origin+location.pathname.replace("/edit","")+"/modules/"+this.path+"/css/assets/layers/",fetch(t+e).then(function(e){return e.json()}).then(function(e){var t,r;s.layersData&&(t=s.api.getProperty("Layers.DataSource.FileId"),r=Object.keys(_.get(e,"features.0.properties")),s.api.setProperty("Layers.DataSource.possibleLayersIds",[""].concat(r)),s.json=e,s.redrawLayers(),s.map.on("mouseenter",o+i+"id",function(e){s.setActions(e,t,"Hover",!0)}),s.map.on("click",o+i+"id",function(e){s.setActions(e,t,"Click",!0)}),s.map.on("contextmenu",o+i+"id",function(e){s.setActions(e,t,"Right Click",!1)}),s.map.on("dblclick",o+i+"id",function(e){s.setActions(e,t,"Double Click",!1)}),s.map.on("mouseleave",o+i+"id",function(){s.app.hideTooltip()}))})),this.updateLayers(this.api.getProperty("Layers.Simple"),"Simple"),this.updateLayers(this.api.getProperty("Layers.Hosted"),"Hosted"),this.updateRasterLayers(),[]),t=this.api.getProperty("Layers.Video");_.each(t,function(e,t){var r,i="videoLayerID".concat(t),o=s.getCoordinates(t),a=s.api.getProperty("Layers.Video.".concat(t,".file")),n=s.api.getProperty("Layers.Video.".concat(t,".image"));s.map.getLayer(i)&&s.map.removeLayer(i),s.map.getSource(i)&&s.map.removeSource(i),o&&a&&(r="".concat(location.origin).concat(location.pathname.replace("/edit",""),"/modules/").concat(s.path,"/css/assets/layers/"),t={mediaName:i,mediaOrder:null!=(t=s.api.getProperty("Layers.Video.".concat(t,".order")))?t:0,property:u({type:n?"image":"video",coordinates:o},n?{url:"".concat(r).concat(a)}:{urls:["".concat(r).concat(a)]}),layer:u({id:i,type:"raster",source:i},n&&{paint:{"raster-fade-duration":0}})},l.push(t))}),this.addMediaLayers(l)},D.prototype.updateRasterLayers=function(){var a=this,e=this.api.getProperty("Layers.Raster");_.each(e,function(e,t){var r="RasterLayerID".concat(t),i=a.api.getProperty("Layers.Raster.".concat(t,".TileSize")),o=a.api.getProperty("Layers.Raster.".concat(t,".TileUrl")),t=a.api.getProperty("Layers.Raster.".concat(t,".Name"))+r+t+"id";a.map.getLayer(t)&&a.map.removeLayer(t),a.map.getLayer(r)&&a.map.removeLayer(r),a.map.getSource(r)&&a.map.removeSource(r),o&&i&&r&&(a.map.addSource(r,{type:"raster",tiles:[o],tileSize:i}),a.map.addLayer({id:t,type:"raster",source:r,paint:{},slot:"middle"})),a.moveLayerToBase(t)})},D.prototype.updateLayers=function(e,l){var p=this;_.each(e,function(e,i){var t="".concat(l,"LayerID").concat(i),r=p.api.getProperty("Layers.".concat(l,".").concat(i,".properties")),o=p.api.getProperty("Layers.".concat(l,".").concat(i,".data")),a=p.api.getProperty("Layers.".concat(l,".").concat(i,".file")),n=p.api.getProperty("Layers.".concat(l,".").concat(i,".Name")),s="".concat(location.origin).concat(location.pathname.replace("/edit",""),"/modules/").concat(p.path,"/css/assets/layers/"),n=n+t+i+"id";p.map.getLayer(n)&&p.map.removeLayer(n),p.map.getLayer(t)&&p.map.removeLayer(t),p.map.getSource(t)&&p.map.removeSource(t),r&&(p.map.addSource(t,{type:"Hosted"===l?"geojson":p.api.getProperty("Layers.".concat(l,".").concat(i,".datatype")),data:"Hosted"===l?"".concat(s).concat(a):JSON.parse(o)}),(s=JSON.parse(_.unescape(r))).source=t,s.id=n,p.map.addLayer(s),p.map.on("mouseenter",n,function(e){var t,r;p.api.getProperty("Layers.".concat(l,".").concat(i,".ShowTooltip"))&&(r=e.features[0],t=_.get(r,"properties"),r=_.get(r,"properties.id"),p.displayTooltip(e,r,0,t,"".concat(l,".").concat(i)))}))})},D.prototype.addMediaLayers=function(e){var t=this,e=_.sortBy(e,"mediaOrder");_.each(e,function(e){t.map.addSource(e.mediaName,e.property),t.map.addLayer(e.layer),t.moveLayerToBase(e.mediaName)})},D.prototype.redrawLayers=function(){var e,r,t,i,o,a,n,s,l,p,c,u="hostedLayerDataSource";this.removeLayers(),this.layersData&&this.json&&(c=this.api.getProperty("Layers.DataSource.Id"),e=this.api.getProperty("Layers.DataSource.DataValue"),r=this.api.getProperty("Layers.DataSource.FileId"),t=this.api.getProperty("Layers.DataSource.UseMinMax"),i=this.api.getProperty("Layers.DataSource.MinRange"),o=this.api.getProperty("Layers.DataSource.MaxRange"),a=this.api.getProperty("Layers.DataSource.ShowZero"),n=this.api.getProperty("Layers.DataSource.Name"),s=_.mapValues(_.keyBy(this.layersData,c),e),l=t?parseFloat(i):_.minBy(Object.values(s),function(e){return parseFloat(e)}),p=t?parseFloat(o):_.maxBy(Object.values(s),function(e){return parseFloat(e)}),_.each(_.get(this.json,"features"),function(e){var t=s[e.properties[r]];a&&_.isNil(t)?e.properties.PropPercent=0:e.properties.PropPercent=t?(t-l)/(p-l):0}),this.map.addSource(u,{type:"geojson",data:this.json}),c={id:n+u+"id",source:u,type:"fill",paint:{"fill-color":_.concat(["interpolate",["linear"],["get","PropPercent"]],this.getColorScale()),"fill-opacity":.75}},a||(c.filter=["!=","PropPercent",0]),this.map.addLayer(c),this.moveLayerToBase(n+u+"id"))},D.prototype.onLayersChange=function(e,t){this.cleanUpSource(),t&&(this.layerSource=t,this.renderLayers())},D.prototype.onData=function(e,t,r){if(r)return this.updateError("Layer Source",r);r=this.layerSource.dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("Layers.DataSource.possibleLayers",[""].concat(r)),this.layersData=t.items?t.items():this.layerSource.dataSet.collection.models.map(function(e){return e.attributes}),this.addLayers()},D.prototype.setActions=function(e,t,r,i){var o=this.api.getProperty("Layers.DataSource.Id"),a=e.features[0].properties[t],t=_.filter(this.layersData,function(e){return e[o]===a});i&&this.displayTooltip(e,a,e.features[0].properties.PropPercent,t,"DataSource"),0<t.length&&this.doActions(r,t[0])},D.prototype.doActions=function(r,i){var o=[],e=this.api.getProperty("Layers.DataSource.Actions");_.each(e,function(e,t){e.Value=e.Trigger===r?i[e.Current]:e.Target.get("value"),e._PropertyIndex=t,o.push(e)}),this.api.doActions(o,"Layers.DataSource.Actions")},D.prototype.getCoordinates=function(e){e=this.api.getProperty("Layers.Video."+e+".coordinates");if(e)return JSON.parse(e)},D.prototype.cleanUpSource=function(){this.layerSource&&(this.stopListening(this.layerSource),this.api.unsubscribe(this.layerSource))},D.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},D.prototype.removeLayers=function(){var e="hostedLayerDataSource",t=this.api.getProperty("Layers.DataSource.Name");this.map.getLayer(t+e+"id")&&this.map.removeLayer(t+e+"id"),this.map.getLayer(e)&&this.map.removeLayer(e),this.map.getSource(e)&&this.map.removeSource(e)},D.prototype.displayTooltip=function(e,t,r,i,o){var a,n,s=this.api,l=(this.app,s.getProperty("Layers.".concat(o,".Tooltip"))),p=s.getProperty("Layers.".concat(o,".ShowTooltip")),c=s.getProperty("Layers.DataSource.DataValue"),s=s.getProperty("Layers.DataSource.Palette")||[];p&&(s=_.map(s,"type"),a=e.lngLat,n=this.api.getTemplateViewStates(l),c="DataSource"===o?null!=(o=null==(o=null==i?void 0:i[0])?void 0:o[c])?o:null:i,o=0<s.length?s[Math.min(s.length-1,Math.round((s.length-1)*r))]:"#000000",s=u(u({},n),{id:t,color:o,value:c,latitude:1<a.length?a[1]:0,longitude:1<a.length?a[0]:0}),this.app.showTooltip(e,l,p,a,t,i,s))},D.prototype.moveLayerToBase=function(e){var t=this.map.getStyle().layers.find(function(e){return/(unclustered-|heatmap-|location-radius|cluster|id)/i.test(e.id)});t&&_.get(t,"id")&&this.map.getLayer(e)&&this.map.moveLayer(e,_.get(t,"id"))};var v,W=D;function D(e){var t=v.call(this,e)||this;return t.errors={},t.layerSource=void 0,t.layersData=[],t.map=e.map,t.api=e.api,t.el=e.el,t.path=e.path,t.app=e.app,t.renderLayers=_.debounce(function(){t.renderMapLayers()},250),t}O=o.View,e(w,O),w.prototype.renderMapLines=function(){var r=this;_.each(this.api.getProperty("Lines"),function(e,t){r.renderMapLinesLayer(t)})},w.prototype.renderMapLinesLayer=function(e){var t=this.api.getProperty("Lines.".concat(e));this.lineSource[e]=t?t.DataSource:void 0,this.lineSource[e]?(this.cleanUpSource(e),this.removeLayers(e),this.api.subscribe(this.lineSource[e],this.onData.bind(this,e))):console.error("Line source not found for index ".concat(e))},w.prototype.cleanUpSource=function(e){this.lineSource[e]&&(this.stopListening(this.lineSource[e]),this.api.unsubscribe(this.lineSource[e]))},w.prototype.onLinesChange=function(e,t,r){this.cleanUpSource(r),t&&(this.lineSource[r]=t,this.renderLines(r))},w.prototype.onData=function(e,t,r,i){if(i)return this.updateError("Line Source",i);i=this.lineSource[e].dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("Lines.".concat(e,".possibleLines"),[""].concat(i)),this.linesData[e]=r.items?r.items():this.lineSource[e].dataSet.collection.models.map(function(e){return e.attributes}),r.reset?(this.resetData(e),this.onCurrentPointChange(e)):(this.sourceToJSON(e),this.drawData(e))},w.prototype.resetData=function(e){this.sourceToJSON(e),this.addSource(e)},w.prototype.sourceToJSON=function(t){for(var e,r=this,i=function(e){return r.api.getProperty("Lines.".concat(t,".").concat(e))},o=i("ID"),a=i("UseLabel"),n=i("Label"),s=i("LabelSize"),l=i("Color"),p=i("Width"),c=i("Latitude"),u=i("Longitude"),d=i("Gradient"),y=i("Point.Size"),h=i("Point.Color"),m=[],i=_.groupBy(this.linesData[t],o),g=0,f=Object.entries(i);g<f.length;g++){var S,C=f[g],L=C[0],C=C[1];C.length&&(S=C.map(function(e){return[(null==e?void 0:e[u])||0,(null==e?void 0:e[c])||0]}),C={id:L,color:null!=(C=null==(L=C[0])?void 0:L[l])?C:"#FF7FB6",width:parseFloat(null==L?void 0:L[p])||1,pointColor:null!=(C=null==L?void 0:L[h])?C:"#FF7FB6",pointSize:parseFloat(null==L?void 0:L[y])||5},a&&(C.label=null!=(e=null==L?void 0:L[n])?e:"",C.labelSize=parseFloat(null==L?void 0:L[s])||10),m.push({type:"Feature",geometry:{type:"LineString",coordinates:S},properties:C}))}o={type:"geojson",data:{type:"FeatureCollection",features:m}};d&&(o.lineMetrics=!0),this.data[t]=o},w.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},w.prototype.drawData=function(e){this.map&&this.addSource(e)},w.prototype.removeLayers=function(e){var t="route".concat(e),r="linesLabels".concat(e),e="lineData".concat(e);this.removeLayerByName(t),this.removeLayerByName(r),this.map.getSource(e)&&this.map.removeSource(e)},w.prototype.removeLayerByName=function(t){var r=this,e=_.filter(this.app.map.getLayersOrder(),function(e){return 0<=e.indexOf(t)});_.each(e,function(e){r.map.getLayer(e)&&r.map.removeLayer(e)})},w.prototype.getGradientRange=function(e){var t=this.api.getProperty("Lines.".concat(e,".GradientSource"));return _.map(this.linesData[e],function(e){return parseFloat(e[t])})},w.prototype.addSource=function(a){function r(e){return n.api.getProperty("Lines.".concat(a,".").concat(e))}var n=this;if(null==(e=this.data)||!e[a])return!1;var e=r("ID"),t=r("Name"),i=r("Gradient"),o=r("GradientType"),s=r("ShowTooltip"),l=r("UseLabel"),p=r("Actions"),s=s||0<p.length,p=this.api.getProperty("MapDetails.Offline"),p=this.api.getProperty("TileServer.Enable")?[this.api.getProperty("TileServer.Font")]:p?["OpenSansBold"]:["Arial Unicode MS Bold"],c=this.map.getSource("lineData".concat(a));if(c)return c.setData(this.data[a].data),this.setLineInView(a),!1;this.removeLayers(a),this.map.addSource("lineData".concat(a),this.data[a]);function u(e,t){var r=e.features[0],i=null==(i=null==r?void 0:r.properties)?void 0:i.id,o=f[i];null!=o&&o.length&&("mouseenter"===t?(n.displayTooltip(e,o,r,i,a),n.doActions("Hover",o[0],a)):"dblclick"===t?n.doActions("Double Click",o[0],a):"click"===t&&n.doActions("Click",o[0],a))}var d,y,h,m,g,c={"line-color":["get","color"],"line-width":["get","width"]},f=(i&&(d=["interpolate",["linear"],["line-progress"]],y=r("Colors"),"data driven"===o?(h=this.getGradientRange(a),m=Math.min.apply(Math,h),g=Math.max.apply(Math,h),h.length&&void 0!==m&&void 0!==g&&h.forEach(function(e,t){e=Math.round((e-m)/(g-m)*(y.length-1));d.push(t/h.length,y[e].color)})):y.forEach(function(e,t){d.push(parseFloat(r("Colors.".concat(t,".percent")))/100,r("Colors.".concat(t,".color")))}),c["line-gradient"]=d),this.map.addLayer({id:"".concat(t,"route").concat(a),type:"line",source:"lineData".concat(a),layout:{"line-join":"round","line-cap":"round"},paint:c}),l&&this.map.addLayer({id:"linesLabels".concat(a),type:"symbol",source:"lineData".concat(a),layout:{"symbol-placement":"line","text-font":p,"text-field":["get","label"],"text-size":["get","labelSize"],"text-justify":"auto","text-allow-overlap":!1}}),_.groupBy(this.linesData[a],e));return s&&(i="".concat(t,"route").concat(a),this.map.on("mouseenter",i,function(e){return u(e,"mouseenter")}),this.map.on("dblclick",i,function(e){return u(e,"dblclick")}),this.map.on("click",i,function(e){return u(e,"click")}),this.map.on("mouseleave","unclustered-point",function(){return n.app.hideTooltip()})),this.setLineInView(a),!0},w.prototype.setLineInView=function(e){var t,r,i,o,a;this.api.getProperty("Lines.".concat(e,".LinesInView"))&&(t=this.api.getProperty("Lines.".concat(e,".Latitude")),r=this.api.getProperty("Lines.".concat(e,".Longitude")),i=_.maxBy(this.linesData[e],t),a=_.maxBy(this.linesData[e],r),o=_.minBy(this.linesData[e],t),e=_.minBy(this.linesData[e],r),e=new c.LngLat(e[r],o[t]),o=new c.LngLat(a[r],i[t]),a=new c.LngLatBounds(e,o),this.map.fitBounds(a,{padding:{top:30,right:30,bottom:75,left:30}}))},w.prototype.onCurrentPointChange=function(e){var t=this.api.getProperty("Lines.".concat(e,".CurrentPoint")),r=null==(r=null==(r=null==(r=null==(r=null==(r=null==(r=this.data[e])?void 0:r.data)?void 0:r.features)?void 0:r[0])?void 0:r.geometry)?void 0:r.coordinates)?void 0:r[t];r&&(this.currentPoint?(this.currentPoint.features[0].geometry.coordinates=r,this.map.getSource("lineCircleData".concat(e)).setData(this.currentPoint)):(t=_.get(this.data,"data.features.0.properties.pointSize"),this.currentPoint={type:"FeatureCollection",crs:{type:"name",properties:{name:"lineCrs"}},features:[{type:"Feature",properties:{id:"currentPoint",strokeColor:"#ffffff",strokeWidth:1,radius:parseFloat(t||"5.0"),color:_.get(this.data,"data.features.0.properties.pointColor")},geometry:{type:"Point",coordinates:r}}]},this.map.addSource("lineCircleData".concat(e),{type:"geojson",data:this.currentPoint,clusterMaxZoom:14,clusterRadius:50}),this.map.addLayer({id:"line-circle".concat(e),type:"circle",source:"lineCircleData".concat(e),filter:["!",["has","point_count"]],paint:{"circle-color":["get","color"],"circle-radius":["get","radius"],"circle-stroke-width":["get","strokeWidth"],"circle-stroke-color":["get","strokeColor"]}})))},w.prototype.doActions=function(r,i,e){var o=[];this.api.getProperty("Lines.".concat(e,".Actions")).forEach(function(e,t){e.Value=e.Trigger===r?i[e.Current]:e.Target.get("value"),e._PropertyIndex=t,o.push(e)}),this.api.doActions(o,"Lines.".concat(e,".Actions"))},w.prototype.displayTooltip=function(e,t,r,i,o){var a=this.api.getProperty("Lines.".concat(o,".Tooltip")),o=this.api.getProperty("Lines.".concat(o,".ShowTooltip")),r=r.geometry.coordinates.slice();this.app.showTooltip(e,a,o,r,i,t)};var O,q=w;function w(e){var t=O.call(this,e)||this;return t.errors={},t.lineSource={},t.linesData={},t.data={},t.map=e.map,t.api=e.api,t.app=e.app,t.renderLines=_.debounce(function(){t.renderMapLines()},250),t.renderLinesByLayer=_.debounce(function(e){t.renderMapLinesLayer(e)},250),t}T.getComponentDefinition=function(e){var t,r,i={Trigger:{default:"Click",enum:["Click","Double Click","Right Click","Hover"],propertyOrder:2,title:"Trigger Action",type:"string"}},i={appArgs:{json:{version:"v2.15.0",Basics:{Name:"",TrackLoadTime:!1,LoadTime:""},MapDetails:{Key:"",Offline:!0,Latitude:8.3221,Longitude:46.5928,Zoom:1,Style:"",UrlStyle:"",LayerSelect:"none",RenderWorldCopies:!0,Projection:"mercator"},Points:{},Circles:{},Lines:{},ConcentricCircles:{Datasource:"",Id:"",Lat:"",Lng:"",Radius:"",Colors:"",BorderWidth:1,FilterPoints:"",Name:""},Heatmap:{possibleHeatmap:[""],DataSource:"",ID:"",Latitude:"",Longitude:"",ShowTooltip:!0,ShowBaseCircles:!0,Tooltip:"",Weight:1,ShowGradient:!1,PaletteTheme:"",Actions:[],Name:"",Colors:[{color:"#2166AC"},{color:"#67A9CF"},{color:"#D1E5F0"},{color:"#FDDBC7"},{color:"#EF8A62"},{color:"#B2182B"}]},HeatmapGrid:{possibleHeatmap:[""],DataSource:"",ID:"",Latitude:"",Longitude:"",GridSize:50,Shape:"square",ShowZero:!0,ShowTooltip:!0,Tooltip:"",Min:0,Max:0,PaletteTheme:"",Actions:[],Name:"",Colors:[{color:"#2166AC"},{color:"#67A9CF"},{color:"#D1E5F0"},{color:"#FDDBC7"},{color:"#EF8A62"},{color:"#B2182B"}]},AnimatedCircles:{possibleAnimatedCircles:[""],DataSource:"",ID:"",Latitude:"",Longitude:"",ShowTooltip:!0,Tooltip:"",Color:"#11b4da",Radius:4,UseLabel:!1,Label:"",LabelSize:"",Actions:[],Name:""},Bounds:{Current:"",PointClick:!1,PointClickRadius:30,PointClickBounds:""},Annotation:{Enable:!0,Filter:!0,Zoom:!0,Selected:""},Export:{Filename:"",Data:""},Layers:{DataSource:{possibleLayers:[],possibleLayersIds:[],File:"",FileId:"",DataSource:"",Id:"",DataValue:"",ShowTooltip:!0,UseMinMax:!1,MinRange:0,MaxRange:100,Tooltip:'<table><tr><td><i class="fa fa-square" style="color:{{color}}"></i> Id : </td><td>{{id}}</td></tr></table>',ShowZero:!0,Actions:[],PaletteTheme:"",Palette:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}]},Video:[],Hosted:[],Simple:[],Raster:[]},NightDayLayer:{Show:!1,Current:""},Icons:[{name:"arrow"},{name:"arrow2"},{name:"arrow3"},{name:"arrow4"},{name:"airplane"},{name:"airplane-fighter"},{name:"airplane-fighter2"},{name:"airplane-fighter3"},{name:"airplane-fighter4"},{name:"airplane-jumbo"},{name:"airplane-front"},{name:"airplane-jet"},{name:"airplane-land"},{name:"airplane-paper"},{name:"airplane-private"},{name:"airplane-takeoff"},{name:"airplane-top"},{name:"airport"},{name:"anchor"},{name:"arrow"},{name:"bus"},{name:"clock"},{name:"cloudy"},{name:"default"},{name:"drone"},{name:"helicopter"},{name:"passport"},{name:"ship-container"},{name:"signpost"},{name:"surveillance"},{name:"taxi"},{name:"wifi"},{name:"rain"},{name:"rainHeavy"},{name:"sea"},{name:"sun"},{name:"sunshine"}],Interactions:{scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0},ExternalAPI:{Enable:!1,URL:"",Key:"",Style:"arcgis/streets"},TileServer:{Enable:!1,Style:"",Font:"Open Sans Bold",UseApiUrl:!1,ApiUrl:""},Style:{Theme:"Light",advanced:"",colors:{lineColor:"#226688",innerLineColor:"#fff",pink:"#f3c1d3",purple:"#ceb5cf",blue:"#a3cec5",torquoise:"#aadb78",green:"#d3e46f",yellow:"#fae364",orange:"#fdc663",red:"#fdaf6b",white:"#f0f8ff",background:"#ddeeff"},extrusion:{extrude:!1,source:"composite",sourceLayer:"building",minZoom:15,fillColor:"#aaa",fillOpacity:60}}},schema:{_transform:function(e,t,r,i){"TileServer.UseApiUrl"!==r&&"root"!==r||(r="root"===r?_.get(e,"TileServer.UseApiUrl"):_.get(e,r),_.set(t,"properties.TileServer.properties.ApiUrl.options.hidden",!r),_.set(t,"properties.TileServer.properties.Style.options.hidden",r),i(e,t)),i()},properties:{possiblePalettes:{propertyOrder:2,type:"array",format:"table",default:[""],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",title:"Basics",propertyOrder:1,properties:{Name:{title:"Name",type:"string",default:""},TrackLoadTime:{title:"Track Load Time",type:"boolean",default:!1},LoadTime:{title:"Load Time (ms)",type:"string",default:""}}},MapDetails:{options:{collapsed:!1},properties:{Key:{default:"",propertyOrder:1,title:"Map Box Key",type:"string",options:{hidden:!0}},Offline:{default:!0,propertyOrder:2,type:"boolean"},Latitude:{default:8.3221,maximum:90,minimum:-90,propertyOrder:3,title:"Center Latitude",type:"number"},Longitude:{default:46.5928,maximum:180,minimum:-180,propertyOrder:4,title:"Center Longitude",type:"number"},Zoom:{default:1,maximum:17,minimum:0,propertyOrder:10,title:"Zoom",type:"number"},Style:{propertyOrder:11,title:"JSON Style Override",type:"tooltipTemplate",default:"",disableTree:!0},UrlStyle:{propertyOrder:12,title:"URL Style Override",type:"string",default:"",tooltip:"Override the default style with an external map style such as https://api.maptiler.com/maps/a59e261e-b853-47d8-a0d5-4d5984f89da3/style.json?key=insert key here"},Theme:{propertyOrder:13,title:"Theme",enum:["dark","color","simple"],default:"dark"},LayerSelect:{propertyOrder:14,title:"Layer Enablement",enum:["none","quick","all"],type:"string",default:"none"},RenderWorldCopies:{default:!0,title:"Render World Copies",propertyOrder:15,type:"boolean"},Projection:{default:"mercator",title:"Projection",propertyOrder:16,type:"string",enum:["mercator","globe"]}},propertyOrder:2,title:"Map",type:"object"},Points:{propertyOrder:2,title:"Points",type:"array",format:"array",options:{collapsed:!0},uniqueItems:!1,items:{type:"object",title:"Point Layer",id:"arrPointItem",properties:{possiblePoints:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Name:{default:"",propertyOrder:1,type:"string"},Cluster:{default:!1,propertyOrder:2,title:"Cluster",type:"boolean"},PointsInView:{default:!1,propertyOrder:3,title:"Load points in view",type:"boolean"},DataSource:{default:"",format:"data",propertyOrder:10,title:"DataSource",type:"data"},ID:{default:"",propertyOrder:11,enumSource:"poss_points",title:"ID",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},Latitude:{default:"",enumSource:"poss_points",propertyOrder:12,title:"Latitude Data",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},Longitude:{default:"",enumSource:"poss_points",propertyOrder:13,title:"Longitude Data",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},Altitude:{default:"",enumSource:"poss_points",propertyOrder:14,title:"Altitude Data",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},Color:{default:"",enumSource:"poss_points",propertyOrder:20,title:"Color",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},Icon:{default:"",enumSource:"poss_points",propertyOrder:30,title:"Icon",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},IconScale:{default:"",enumSource:"poss_points",propertyOrder:31,title:"Icon Scale",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},IconRotation:{default:"",enumSource:"poss_points",propertyOrder:32,title:"Icon Rotation",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},IconOpacity:{default:100,propertyOrder:33,title:"Icon Opacity %",type:"number",minimum:0,maximum:100},IconInterpolate:{default:!1,propertyOrder:34,title:"Icon Zoom Interpolate",type:"boolean"},UseLabel:{default:!1,propertyOrder:40,title:"Use Labels",type:"boolean"},Label:{default:"",propertyOrder:41,title:"Label",enumSource:"poss_points",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},LabelSize:{default:"",propertyOrder:42,enumSource:"poss_points",title:"Label Size",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},ShowTooltip:{default:!1,propertyOrder:49,title:"Show Tooltip",type:"boolean"},Tooltip:{propertyOrder:50,title:"Tooltip",type:"tooltipTemplate",default:"{{id}}",templateItems:{values:{items:_.keyBy(["id","latitude","longitude","altitude"]),type:"object"}}},ZoomOnSelect:{default:!1,propertyOrder:55,title:"Zoom on Select",type:"boolean"},TrackSelected:{default:!1,propertyOrder:56,title:"Track Selected",type:"boolean"},ClusterMaxZoom:{default:14,title:"Cluster Max Zoom",minimum:1,maximum:15,type:"number",propertyOrder:57},ClusterRadius:{default:50,title:"Cluster Radius",minimum:1,maximum:250,type:"number",propertyOrder:58},Selected:{properties:{Color:{default:"#ff0000",title:"Color",options:{gradient:!1},type:"gradient",propertyOrder:101},Column:{default:"",propertyOrder:102,enumSource:"poss_points",title:"Column",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}},SelectedItem:{default:"",propertyOrder:103,type:"string",title:"Selected Item"},SelectedZoomedItems:{default:"",propertyOrder:104,type:"string",title:"Annotated Items"}},propertyOrder:60,title:"Selected",type:"object",options:{collapsed:!0}},Actions:{fields:{map:_.extend({Current:{enumSource:"poss_points",propertyOrder:21,title:"Source Column",type:"string",watch:{poss_points:"arrPointItem.possiblePoints"}}},i),nav:i,query:i,url:i},options:{collapsed:!0},propertyOrder:80,type:"actions"},IconScaleInterpolate:{properties:{ZoomStop1:{default:1,title:"Zoom Stop 1",type:"number",propertyOrder:101},ZoomStop2:{default:6,title:"Zoom Stop 2",type:"number",propertyOrder:102},Stop1Percent:{default:25,title:"Zoom Stop 1 %",type:"number",minimum:0,maximum:100,propertyOrder:103},Exponential:{default:2,title:"Exponential",type:"number",propertyOrder:104}},propertyOrder:90,title:"Icon Scale interpolate",type:"object",options:{collapsed:!0}}}}},Circles:{propertyOrder:3,title:"Circles",type:"array",format:"array",options:{collapsed:!0},uniqueItems:!1,items:{type:"object",title:"Circle Layer",id:"arrCircleItem",properties:{possibleCircles:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Name:{default:"",propertyOrder:1,type:"string"},Cluster:{default:!1,propertyOrder:2,title:"Cluster",type:"boolean"},CirclesInView:{default:!1,propertyOrder:2,title:"Circles In View",type:"boolean"},DataSource:{default:"",format:"data",propertyOrder:10,title:"DataSource",type:"data"},ID:{default:"",propertyOrder:11,enumSource:"poss_circles",title:"ID",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},Latitude:{default:"",enumSource:"poss_circles",propertyOrder:12,title:"Latitude Data",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},Longitude:{default:"",enumSource:"poss_circles",propertyOrder:13,title:"Longitude Data",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},Altitude:{default:"",enumSource:"poss_circles",propertyOrder:14,title:"Altitude Data",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},Color:{default:"",enumSource:"poss_circles",propertyOrder:20,title:"Color",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},Radius:{default:"",enumSource:"poss_circles",propertyOrder:21,title:"Radius",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},StrokeColor:{default:"",enumSource:"poss_circles",propertyOrder:22,title:"Stroke Color",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},StrokeWidth:{default:"",enumSource:"poss_circles",propertyOrder:23,title:"Stroke Width",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},CircleOpacity:{default:100,propertyOrder:24,title:"Circle Opacity %",type:"number",minimum:0,maximum:100},UseLabel:{default:!1,propertyOrder:40,title:"Use Labels",type:"boolean"},Label:{default:"",propertyOrder:41,title:"Label",enumSource:"poss_circles",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},LabelSize:{default:"",propertyOrder:42,enumSource:"poss_circles",title:"Label Size",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},ShowTooltip:{default:!1,propertyOrder:49,title:"Show Tooltip",type:"boolean"},Tooltip:{propertyOrder:50,title:"Tooltip",type:"tooltipTemplate",default:"{{id}}",templateItems:{values:{items:_.keyBy(["id","latitude","longitude","altitude"]),type:"object"}}},ZoomOnSelect:{default:!1,propertyOrder:55,title:"Zoom on Select",type:"boolean"},TrackSelected:{default:!1,propertyOrder:56,title:"Track Selected",type:"boolean"},ClusterMaxZoom:{default:14,title:"Cluster Max Zoom",minimum:1,maximum:15,type:"number",propertyOrder:57},ClusterRadius:{default:50,title:"Cluster Radius",minimum:1,maximum:250,type:"number",propertyOrder:58},Selected:{properties:{Color:{default:"#ff0000",title:"Color",options:{gradient:!1},type:"gradient",propertyOrder:101},Column:{default:"",propertyOrder:102,enumSource:"poss_circles",title:"Column",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}},SelectedItem:{default:"",propertyOrder:103,type:"string",title:"Selected Item"},SelectedZoomedItems:{default:"",propertyOrder:104,type:"string",title:"Annotated Items"}},propertyOrder:60,title:"Selected",type:"object",options:{collapsed:!0}},Actions:{fields:{map:_.extend({Current:{enumSource:"poss_circles",propertyOrder:21,title:"Source Column",type:"string",watch:{possCircles:"arrCircleItem.possibleCircles"}}},i),nav:i,query:i,url:i},options:{collapsed:!0},propertyOrder:80,type:"actions"}}}},Lines:{propertyOrder:4,title:"Lines",type:"array",format:"array",options:{collapsed:!0},uniqueItems:!1,items:{type:"object",title:"Line Layer",id:"arrLineItem",properties:{possibleLines:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Name:{default:"",propertyOrder:1,type:"string"},LinesInView:{default:!1,propertyOrder:3,title:"Load lines in view",type:"boolean"},DataSource:{default:"",format:"data",propertyOrder:10,title:"DataSource",type:"data"},ID:{default:"",propertyOrder:11,enumSource:"poss_lines",title:"ID",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},Latitude:{default:"",enumSource:"poss_lines",propertyOrder:12,title:"Latitude Data",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},Longitude:{default:"",enumSource:"poss_lines",propertyOrder:13,title:"Longitude Data",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},Color:{default:"",enumSource:"poss_lines",propertyOrder:20,title:"Color",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},Width:{default:"",enumSource:"poss_lines",propertyOrder:21,title:"Width",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},UseLabel:{default:!1,propertyOrder:40,title:"Use Labels",type:"boolean"},Label:{default:"",propertyOrder:41,title:"Label",enumSource:"poss_lines",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},LabelSize:{default:"",propertyOrder:42,enumSource:"poss_lines",title:"Label Size",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},CurrentPoint:{default:"",propertyOrder:45,title:"Current Point Index",type:"string"},ShowTooltip:{default:!1,propertyOrder:49,title:"Show Tooltip",type:"boolean"},Tooltip:{propertyOrder:50,title:"Tooltip",type:"tooltipTemplate",default:"{{id}}",templateItems:{values:{items:_.keyBy(["id","latitude","longitude","altitude"]),type:"object"}}},Gradient:{default:!1,propertyOrder:60,title:"Use Gradient",type:"boolean"},GradientType:{default:"linear",propertyOrder:61,title:"Gradient Type",type:"string",enum:["linear","data driven"]},GradientSource:{default:!1,propertyOrder:62,enumSource:"poss_lines",title:"Gradient Column Data",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},Colors:{default:[{index:0,color:"#2166AC"},{index:20,color:"#67A9CF"},{index:40,color:"#D1E5F0"},{index:60,color:"#FDDBC7"},{index:80,color:"#EF8A62"},{index:100,color:"#B2182B"}],format:"table",items:{properties:{color:{default:"#2166AC",title:"Color",options:{gradient:!1},type:"gradient",propertyOrder:2},percent:{default:0,title:"Percent",minimum:0,maximum:100,type:"number",propertyOrder:1}},title:"Color",type:"object"},options:{collapsed:!0},propertyOrder:65,title:"Colors",type:"array",uniqueItems:!1},Point:{properties:{Color:{default:"",enumSource:"poss_lines",propertyOrder:1,title:"Color",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}},Size:{default:"",enumSource:"poss_lines",propertyOrder:2,title:"Size",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}}},title:"Point",options:{collapsed:!0},propertyOrder:66,type:"object"},Actions:{fields:{map:_.extend({Current:{enumSource:"poss_lines",propertyOrder:21,title:"Source Column",type:"string",watch:{poss_lines:"arrLineItem.possibleLines"}}},i),nav:i,query:i,url:i},options:{collapsed:!0},propertyOrder:70,type:"actions"}},options:{collapsed:!0}}},ConcentricCircles:{properties:{possibleConcentricCircles:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Name:{default:"",propertyOrder:1,type:"string"},Datasource:{default:"",format:"data",propertyOrder:10,title:"DataSource",type:"data"},Id:{default:"",enumSource:"poss_concentricCircles",propertyOrder:11,title:"ID",type:"string",watch:{poss_concentricCircles:"root.ConcentricCircles.possibleConcentricCircles"}},Lat:{default:"",enumSource:"poss_concentricCircles",propertyOrder:12,title:"Latitude Data",type:"string",watch:{poss_concentricCircles:"root.ConcentricCircles.possibleConcentricCircles"}},Lng:{default:"",enumSource:"poss_concentricCircles",propertyOrder:13,title:"Longitude Data",type:"string",watch:{poss_concentricCircles:"root.ConcentricCircles.possibleConcentricCircles"}},Radius:{default:"",enumSource:"poss_concentricCircles",propertyOrder:14,title:"Radius (KM)",type:"string",watch:{poss_concentricCircles:"root.ConcentricCircles.possibleConcentricCircles"}},Colors:{default:"",enumSource:"poss_concentricCircles",propertyOrder:15,title:"Colors",type:"string",watch:{poss_concentricCircles:"root.ConcentricCircles.possibleConcentricCircles"}},BorderWidth:{default:1,propertyOrder:20,title:"Border Width",type:"number"},FilterPoints:{default:"",propertyOrder:30,title:"Filter Points",type:"string",options:{hidden:!0}}},options:{collapsed:!0},propertyOrder:4,title:"Concentric Circles",type:"object"},Heatmap:{properties:{possibleHeatmap:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Name:{default:"",propertyOrder:1,type:"string"},DataSource:{default:"",format:"data",propertyOrder:10,title:"DataSource",type:"data"},ID:{default:"",propertyOrder:11,enumSource:"poss_heatmap",title:"ID",type:"string",watch:{poss_heatmap:"root.Heatmap.possibleHeatmap"}},Latitude:{default:"",enumSource:"poss_heatmap",propertyOrder:12,title:"Latitude Data",type:"string",watch:{poss_heatmap:"root.Heatmap.possibleHeatmap"}},Longitude:{default:"",enumSource:"poss_heatmap",propertyOrder:13,title:"Longitude Data",type:"string",watch:{poss_heatmap:"root.Heatmap.possibleHeatmap"}},Weight:{default:"",enumSource:"poss_heatmap",propertyOrder:21,title:"Weight",type:"string",watch:{poss_heatmap:"root.Heatmap.possibleHeatmap"}},ShowTooltip:{default:!1,propertyOrder:49,title:"Show Tooltip",type:"boolean"},ShowBaseCircles:{default:!0,propertyOrder:50,title:"Show Base Circle",type:"boolean"},Tooltip:{propertyOrder:51,title:"Tooltip",type:"tooltipTemplate",default:"{{id}}",templateItems:{values:{items:_.keyBy(["id","latitude","longitude","altitude"]),type:"object"}}},PaletteTheme:{default:"",title:"Palette Theme",type:"string",enumSource:"possible_palettes",watch:{possible_palettes:"root.possiblePalettes"},propertyOrder:51},ShowGradient:{default:!1,propertyOrder:52,title:"Show Gradient",type:"boolean"},Colors:{default:[{color:"#2166AC"},{color:"#67A9CF"},{color:"#D1E5F0"},{color:"#FDDBC7"},{color:"#EF8A62"},{color:"#B2182B"}],format:"table",items:{properties:{color:{default:"#2166AC",title:"Color",options:{gradient:!1},type:"gradient"}},title:"Color",type:"object"},options:{collapsed:!0},propertyOrder:55,title:"Colors",type:"array",uniqueItems:!1},Actions:{fields:{map:_.extend({Current:{enumSource:"poss_heatmap",propertyOrder:21,title:"Source Column",type:"string",watch:{poss_heatmap:"root.Heatmap.possibleHeatmap"}}},i),nav:i,query:i,url:i},options:{collapsed:!0},propertyOrder:60,type:"actions"}},options:{collapsed:!0},propertyOrder:4,title:"Heatmap",type:"object"},HeatmapGrid:{properties:{possibleHeatmap:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Name:{default:"",propertyOrder:1,type:"string"},DataSource:{default:"",format:"data",propertyOrder:10,title:"DataSource",type:"data"},ID:{default:"",propertyOrder:11,enumSource:"poss_heatmap",title:"ID",type:"string",watch:{poss_heatmap:"root.HeatmapGrid.possibleHeatmap"}},Latitude:{default:"",enumSource:"poss_heatmap",propertyOrder:12,title:"Latitude Data",type:"string",watch:{poss_heatmap:"root.HeatmapGrid.possibleHeatmap"}},Longitude:{default:"",enumSource:"poss_heatmap",propertyOrder:13,title:"Longitude Data",type:"string",watch:{poss_heatmap:"root.HeatmapGrid.possibleHeatmap"}},GridSize:{default:50,propertyOrder:20,title:"Grid Size",type:"number"},Shape:{default:"square",propertyOrder:21,title:"Cell Shape",type:"string",enum:["square","hexagon"]},Min:{default:0,propertyOrder:22,title:"Min Zoom",type:"number"},Max:{default:0,propertyOrder:23,title:"Max Zoom",type:"number"},ShowZero:{default:!0,title:"Show Zero Values",propertyOrder:24,type:"boolean"},ShowTooltip:{default:!1,propertyOrder:49,title:"Show Tooltip",type:"boolean"},Tooltip:{propertyOrder:50,title:"Tooltip",type:"tooltipTemplate",default:"{{id}}",templateItems:{values:{items:_.keyBy(["id","latitude","longitude","altitude"]),type:"object"}}},PaletteTheme:{default:"",title:"Palette Theme",type:"string",enumSource:"possible_palettes",watch:{possible_palettes:"root.possiblePalettes"},propertyOrder:51},Colors:{default:[{color:"#2166AC"},{color:"#67A9CF"},{color:"#D1E5F0"},{color:"#FDDBC7"},{color:"#EF8A62"},{color:"#B2182B"}],format:"table",items:{properties:{color:{default:"#2166AC",title:"Color",options:{gradient:!1},type:"gradient"}},title:"Color",type:"object"},options:{collapsed:!0},propertyOrder:55,title:"Colors",type:"array",uniqueItems:!1},Actions:{fields:{map:_.extend({Current:{enumSource:"poss_heatmap",propertyOrder:21,title:"Source Column",type:"string",watch:{poss_heatmap:"root.HeatmapGrid.possibleHeatmap"}}},i),nav:i,query:i,url:i},options:{collapsed:!0},propertyOrder:60,type:"actions"}},options:{collapsed:!0},propertyOrder:4,title:"Heatmap Grid",type:"object"},AnimatedCircles:{properties:{possibleAnimatedCircles:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Name:{default:"",propertyOrder:1,type:"string"},DataSource:{default:"",format:"data",propertyOrder:10,title:"DataSource",type:"data"},ID:{default:"",propertyOrder:11,enumSource:"poss_circles",title:"ID",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}},Latitude:{default:"",enumSource:"poss_circles",propertyOrder:12,title:"Latitude Data",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}},Longitude:{default:"",enumSource:"poss_circles",propertyOrder:13,title:"Longitude Data",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}},Altitude:{default:"",enumSource:"poss_circles",propertyOrder:14,title:"Altitude Data",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}},Color:{default:"",enumSource:"poss_circles",propertyOrder:20,title:"Color",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}},Radius:{default:"",enumSource:"poss_circles",propertyOrder:21,title:"Radius",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}},UseLabel:{default:!1,propertyOrder:40,title:"Use Labels",type:"boolean"},Label:{default:"",propertyOrder:41,title:"Label",enumSource:"poss_circles",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}},LabelSize:{default:"",propertyOrder:42,enumSource:"poss_circles",title:"Label Size",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}},ShowTooltip:{default:!1,propertyOrder:49,title:"Show Tooltip",type:"boolean"},Tooltip:{propertyOrder:50,title:"Tooltip",type:"tooltipTemplate",default:"{{id}}",templateItems:{values:{items:_.keyBy(["id","latitude","longitude","altitude"]),type:"object"}}},Actions:{fields:{map:_.extend({Current:{enumSource:"poss_circles",propertyOrder:21,title:"Source Column",type:"string",watch:{possCircles:"root.AnimatedCircles.possibleAnimatedCircles"}}},i),nav:i,query:i,url:i},options:{collapsed:!0},propertyOrder:60,type:"actions"}},options:{collapsed:!0},propertyOrder:7,title:"Animated Circles",type:"object"},Layers:{title:"Layers",type:"object",properties:{DataSource:{title:"Data Layers",type:"object",propertyOrder:1,properties:{possibleLayers:{default:[],format:"table",items:{type:"string"},propertyOrder:1,options:{collapsed:!0,hidden:!0},type:"array"},possibleLayersIds:{default:[],format:"table",items:{type:"string"},propertyOrder:2,options:{collapsed:!0,hidden:!0},type:"array"},Name:{default:"",type:"string",propertyOrder:1},DataSource:{default:"",format:"data",title:"DataSource",type:"data",propertyOrder:3},File:{default:"",type:"string",propertyOrder:4},FileId:{title:"File Id",default:"",type:"string",enumSource:"poss_layersids",watch:{poss_layersids:"root.Layers.DataSource.possibleLayersIds"},propertyOrder:5},Id:{default:"",type:"string",enumSource:"poss_layers",watch:{poss_layers:"root.Layers.DataSource.possibleLayers"},propertyOrder:6},DataValue:{default:"",type:"string",enumSource:"poss_layers",watch:{poss_layers:"root.Layers.DataSource.possibleLayers"},propertyOrder:7},ShowZero:{default:!0,title:"Show Zero & Null Values",type:"boolean",propertyOrder:8},ShowTooltip:{default:!1,propertyOrder:9,title:"Show Tooltip",type:"boolean"},Tooltip:{type:"tooltipTemplate",default:'<table><tr><td><i class="fa fa-square" style="color:{{color}}"></i> Id : </td><td>{{id}}</td></tr></table>',templateItems:{values:{items:_.keyBy(["id","latitude","longitude","value","id"]),type:"object"}},propertyOrder:10},UseMinMax:{default:!1,type:"boolean",propertyOrder:11},MinRange:{default:0,type:"number",title:"Min Range",propertyOrder:12},MaxRange:{default:100,type:"number",propertyOrder:13},Actions:{propertyOrder:20,fields:{map:_.extend({Current:{enumSource:"poss_layers",propertyOrder:21,title:"Source Column",type:"string",watch:{poss_points:"root.Layers.DataSource.possibleLayers"}}},i),nav:i,query:i,url:i},options:{collapsed:!0},type:"actions"},PaletteTheme:{default:"",title:"Palette Theme",type:"string",enumSource:"possible_palettes",watch:{possible_palettes:"root.possiblePalettes"},propertyOrder:15},Palette:{type:"array",propertyOrder:16,format:"table",title:"Color Palette",options:{collapsed:!0},uniqueItems:!1,items:{type:"object",title:"Palette Color",properties:{type:{type:"gradient",options:{gradient:!1},title:"color",default:"#ffa500"}}},default:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}]}}},Video:{default:[],format:"table",items:{properties:{file:{default:"",title:"File",type:"string"},coordinates:{default:"",title:"Coordinates",type:"string"},order:{default:1,title:"Order",type:"number"},image:{default:!1,title:"Image",type:"boolean"}},title:"Media layer",type:"object"},options:{collapsed:!0},propertyOrder:3,title:"Media Layers",type:"array",uniqueItems:!1},Hosted:{default:[],format:"table",items:{properties:{file:{default:"",title:"File",type:"string"},Name:{default:"",type:"string"},properties:{default:"",title:"Properties",type:"tooltipTemplate",disableTree:!0},Tooltip:{default:'\n                                                    <div>\n                                                        <i class="fa fa-circle" style="color:{{this.color}}"></i> {{this.id}}\n                                                    </div>\n                                                    {{#each this.value}}\n                                                        <div>{{@key}} : {{this}}</div>\n                                                    {{/each}}\n                                                    ',title:"Tooltip",type:"tooltipTemplate",disableTree:!0},ShowTooltip:{default:!1,title:"Show Tooltip",type:"boolean"}},title:"Hosted Layer",type:"object"},options:{collapsed:!0},propertyOrder:3,title:"Hosted Layers",type:"array",uniqueItems:!1},Simple:{default:[],format:"table",items:{properties:{datatype:{default:"geojson",title:"Type",type:"string",enum:["geojson","vector"]},Name:{default:"",type:"string"},data:{default:"",title:"Data",type:"tooltipTemplate",disableTree:!0},properties:{default:"",title:"Properties",type:"tooltipTemplate",disableTree:!0},Tooltip:{default:'\n                                                    <div>\n                                                        <i class="fa fa-circle" style="color:{{this.color}}"></i> {{this.id}}\n                                                    </div>\n                                                    {{#each this.value}}\n                                                        <div>{{@key}} : {{this}}</div>\n                                                    {{/each}}\n                                                    ',title:"Tooltip",type:"tooltipTemplate",disableTree:!0},ShowTooltip:{default:!1,title:"Show Tooltip",type:"boolean"}},title:"Simple Layer",type:"object"},options:{collapsed:!0},propertyOrder:3,title:"Simple Layers",type:"array",uniqueItems:!1},Raster:{default:[],format:"table",items:{properties:{Name:{default:"",title:"Name",type:"string"},TileUrl:{default:"",title:"Tile URL",type:"string"},TileSize:{default:256,type:"integer",title:"Tile Size",minimum:1,maximum:500}},title:"Raster Layer",type:"object"},options:{collapsed:!0},propertyOrder:4,title:"Raster Layers",type:"array",uniqueItems:!1}}},NightDayLayer:{properties:{Show:{default:!1,propertyOrder:1,title:"Show Layer",type:"boolean"},Current:{default:"",type:"string"}},options:{collapsed:!0},propertyOrder:9,title:"Night Day Layer",type:"object"},Icons:{default:[{name:"default"},{name:"airplane"},{name:"globe"}],format:"table",items:{properties:{name:{default:"",title:"Name",type:"string"}},title:"Icon",type:"object"},options:{collapsed:!0},propertyOrder:8,title:"Icons",type:"array",uniqueItems:!1},Bounds:{propertyOrder:5,title:"Bounds",type:"object",options:{collapsed:!0},properties:{Current:{default:"",propertyOrder:1,title:"Current Bounds",type:"string"},PointClick:{default:!0,propertyOrder:2,title:"Track Point click Bounds",type:"boolean"},PointClickRadius:{default:"",propertyOrder:3,title:"Selected Point Bound Size",type:"number",minimum:1,maximum:1e3},PointClickBounds:{default:"",propertyOrder:4,title:"Current Point Bounds",type:"string"}}},Annotation:{propertyOrder:5,title:"Annotation",type:"object",options:{collapsed:!0},properties:{Enable:{default:!0,propertyOrder:1,title:"Enable",type:"boolean"},Filter:{default:!0,propertyOrder:2,title:"Filter on Draw",type:"boolean"},Zoom:{default:!0,propertyOrder:3,title:"Zoom on Draw",type:"boolean"},Selected:{default:"",propertyOrder:4,title:"Selected Annotation",type:"string"}}},Interactions:{title:"Interactions",type:"object",options:{collapsed:!0},properties:{scrollZoom:{default:!0,propertyOrder:1,title:"Scroll Zoom",type:"boolean"},boxZoom:{default:!0,propertyOrder:2,title:"Box Zoom",type:"boolean"},dragRotate:{default:!0,propertyOrder:3,title:"Drag Rotate",type:"boolean"},dragPan:{default:!0,propertyOrder:4,title:"Drag Pan",type:"boolean"},keyboard:{default:!0,propertyOrder:5,title:"Keyboard",type:"boolean"},doubleClickZoom:{default:!0,propertyOrder:6,title:"Double Click Zoom",type:"boolean"},touchZoomRotate:{default:!0,propertyOrder:7,title:"Touch Zoom Rotate",type:"boolean"}}},Style:{options:{collapsed:!0},properties:{DashboardTheme:{options:{hidden:!0}},Theme:{default:"Light",enum:["Light","Dark"],options:{hidden:!0},title:"Theme",type:"string"},advanced:{default:"",propertyOrder:160,title:"Advanced CSS",type:"css"},colors:{options:{collapsed:!0},propertyOrder:991,title:"Colors",type:"object",properties:{lineColor:{default:"#226688",title:"Line Color",options:{gradient:!1},type:"gradient"},innerLineColor:{default:"#fff",title:"Inner Line Color",options:{gradient:!1},type:"gradient"},pink:{default:"#f3c1d3",title:"Color 1",options:{gradient:!1},type:"gradient"},purple:{default:"#ceb5cf",title:"Color 2",options:{gradient:!1},type:"gradient"},blue:{default:"#a3cec5",title:"Color 3",options:{gradient:!1},type:"gradient"},torquoise:{default:"#aadb78",title:"Color 4",options:{gradient:!1},type:"gradient"},green:{default:"#d3e46f",title:"Color 5",options:{gradient:!1},type:"gradient"},yellow:{default:"#fae364",title:"Color 6",options:{gradient:!1},type:"gradient"},orange:{default:"#fdc663",title:"Color 7",options:{gradient:!1},type:"gradient"},red:{default:"#fdaf6b",title:"Color 8",options:{gradient:!1},type:"gradient"},white:{default:"#f0f8ff",title:"Color 9",options:{gradient:!1},type:"gradient"},background:{default:"#ddeeff",title:"Background",options:{gradient:!1},type:"gradient"}}},extrusion:{options:{collapsed:!0},propertyOrder:992,title:"3D Models",type:"object",properties:{extrude:{default:!1,title:"Show 3D Models",propertyOrder:1,type:"boolean"},source:{default:"composite",propertyOrder:2,title:"Source",type:"string"},sourceLayer:{default:"building",propertyOrder:3,title:"Source Layer",type:"string"},minZoom:{default:15,propertyOrder:4,title:"Min zoom",minimum:10,maximum:20,type:"number"},fillColor:{default:"#aaa",propertyOrder:5,title:"Fill Color",options:{gradient:!1},type:"gradient"},fillOpacity:{default:60,propertyOrder:6,title:"Fill Opacity %",minimum:1,maximum:100,type:"number"}}}},propertyOrder:991,title:"Style",type:"object"},TileServer:{options:{collapsed:!0},properties:{Enable:{default:!1,propertyOrder:1,type:"boolean"},UseApiUrl:{default:!1,propertyOrder:2,type:"boolean",title:"Set Style using a URL"},ApiUrl:{default:"",propertyOrder:3,type:"string",title:"Style URL",options:{hidden:!0}},Style:{propertyOrder:4,title:"Style Editor",type:"tooltipTemplate",default:"",disableTree:!0},Font:{default:"Open Sans Bold",propertyOrder:5,type:"string",title:"Widget Fonts"}},propertyOrder:991,title:"Tile Server",type:"object"},Export:{options:{collapsed:!0},properties:{Filename:{default:"",propertyOrder:1,title:"Filename",type:"string"},Data:{default:"",propertyOrder:2,title:"Exported Image Data",tooltip:"Stores the exported map image encoded as a Base64 PNG string",type:"string"}},propertyOrder:800,title:"Export",type:"object"},ExternalAPI:{options:{collapsed:!0},properties:{Enable:{default:!1,propertyOrder:2,type:"boolean"},URL:{default:"",propertyOrder:2,title:"URL",type:"string"},Key:{default:"",propertyOrder:3,type:"string"},Style:{default:"arcgis/streets",enum:["arcgis/streets","arcgis/navigation","arcgis/topographic","arcgis/light-gray","arcgis/dark-gray","arcgis/topographic/base","arcgis/streets-night","arcgis/streets-relief","arcgis/streets-relief/base","arcgis/community","arcgis/outdoor","arcgis/topographic/base","arcgis/imagery","arcgis/imagery/labels","arcgis/oceans","arcgis/oceans/base","arcgis/oceans/labels","arcgis/hillshade/light","arcgis/hillshade/dark","arcgis/terrain","arcgis/terrain/base","arcgis/terrain/detail","arcgis/light-gray/base","arcgis/light-gray/labels","arcgis/dark-gray/base","arcgis/dark-gray/labels","arcgis/human-geography","arcgis/human-geography-dark","arcgis/charted-territory","arcgis/charted-territory/base","arcgis/colored-pencil","arcgis/nova","arcgis/modern-antique","arcgis/modern-antique/base","arcgis/midcentury","arcgis/newspaper","osm/standard","osm/standard-relief","osm/standard-relief/base","osm/navigation","osm/navigation-dark","osm/streets","osm/streets-relief","osm/streets-relief/base","osm/hybrid","osm/hybrid/detail","osm/light-gray","osm/dark-gray","osm/blueprint"],title:"Style",type:"string"}},propertyOrder:992,title:"External API",type:"object"}},title:"Properties",type:"object"},websiteUrl:e.websiteUrl},appKey:"OfflineMap",buildViewThumb:null,componentDescription:"Offline Map Widget (BETA)",componentName:"OfflineMap",css:"offlineMap",ghostViewThumb:null,id:10123};if(0<_.keys(e.settingsModel.attributes).length)for(r=T.upgrades.indexOf(_.find(T.upgrades,{version:e.settingsModel.get("version")}))+1;r<T.upgrades.length;r+=1)(t=T.upgrades[r]).fn(e.settingsModel,e),e.settingsModel.set("version",t.version);return i};var K=T;function T(){}K.upgrades=[{fn:function(){for(var e=0;e<arguments.length;e++)e,0},version:0},{version:"4.7.7.1",fn:function(e){e.get("Heatmap");var t=e.get("Lines"),t=(_.isNil(e.get("Heatmap"))&&e.set("Heatmap",{possibleHeatmap:[""],DataSource:"",ID:"",Latitude:"",Longitude:"",Tooltip:"",Weight:1,Actions:[],Colors:[{color:"#2166AC"},{color:"#67A9CF"},{color:"#D1E5F0"},{color:"#FDDBC7"},{color:"#EF8A62"},{color:"#B2182B"}]}),t.Gradient=!_.isNil(t.Gradient)&&t.Gradient,t.Colors=_.isNil(t.Color)?[{percent:0,color:"#2166AC"},{percent:20,color:"#67A9CF"},{percent:40,color:"#D1E5F0"},{percent:60,color:"#FDDBC7"},{percent:80,color:"#EF8A62"},{percent:100,color:"#B2182B"}]:t.Color,t.CurrentPoint=_.isNil(t.CurrentPoint)?"":t.CurrentPoint,e.set("Lines",t),e.get("AnimatedCircles"));_.isNil(t)&&e.set("AnimatedCircles",{possibleAnimatedCircles:[""],DataSource:"",ID:"",Latitude:"",Longitude:"",Tooltip:"",Color:"#11b4da",Radius:4,UseLabel:!1,Label:"",LabelSize:"",Actions:[]})}},{version:"4.7.7",fn:function(e){e.get("Basics.Name")||e.set("Basics.Name","")}},{version:"4.7.7.1",fn:function(e){var t=e.get("Points"),t=(t.TrackSelected=!_.isNil(t.TrackSelected)&&t.TrackSelected,t.ZoomOnSelect=!_.isNil(t.ZoomOnSelect)&&t.ZoomOnSelect,t.Selected=_.isNil(t.Selected)?{Color:"#ff0000",Column:"",SelectedItem:""}:t.Selected,e.get("Circles")),t=(t.TrackSelected=!_.isNil(t.TrackSelected)&&t.TrackSelected,t.ZoomOnSelect=!_.isNil(t.ZoomOnSelect)&&t.ZoomOnSelect,t.Selected=_.isNil(t.Selected)?{Color:"#ff0000",Column:"",SelectedItem:""}:t.Selected,e.get("Lines")),t=(t.LinesInView=!_.isNil(t.LinesInView)&&t.LinesInView,e.get("Heatmap")),t=(t.ShowGradient=!_.isNil(t.ShowGradient)&&t.ShowGradient,e.get("MapDetails")),t=(t.Offline=!!_.isNil(t.Offline)||t.Offline,e.get("NightDayLayer"));e.set("NightDayLayer",_.isNil(t)?{Current:"",Show:!1}:t)}},{version:"4.7.7.2",fn:function(e){var r=e.get("Icons");_.each(["drone-0","emitter-0","fighter-0","fighter2-0","plane-0","ship-0","airplane-0","jet-0","taxi-0"],function(t){0===_.filter(r,function(e){return e.name===t}).length&&r.push({name:t})})}},{version:"4.7.7.3",fn:function(r){r.get("Layers.Hosted")||r.set("Layers.Hosted",[]),r.get("Layers.Simple")||r.set("Layers.Simple",[]),r.get("Layers.Video")||r.set("Layers.Video",[]),_.each(r.get("Layers"),function(e,t){r.get("Layers."+t)&&r.set("Layers.Simple."+t,e)})}},{version:"4.7.7.4",fn:function(e){e.get("Points.Selected.SelectedZoomedItems")||e.set("Points.Selected.SelectedZoomedItems",""),e.get("Circles.Selected.SelectedZoomedItems")||e.set("Circles.Selected.SelectedZoomedItems","")}},{version:"4.7.8",fn:function(e){e.get("Layers.DataSource")||e.set("Layers.DataSource",{possibleLayers:[],DataSource:"",Id:"",DataValue:"",File:"",FileId:"",Tooltip:'<table><tr><td><i class="fa fa-square" style="color:{{color}}"></i> Id : </td><td>{{id}}</td></tr></table>',PaletteTheme:"",Palette:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}]})}},{version:"4.7.8.1",fn:function(e){e.get("ExternalAPI")||e.set("ExternalAPI",{Enable:!1,URL:"",Key:"",Style:"arcgis/streets"})}},{version:"4.7.8.2",fn:function(e){e.get("Style.extrusion")||e.set("Style.extrusion",{extrude:!1,source:"composite",sourceLayer:"building",minZoom:15,fillColor:"#aaa",fillOpacity:60})}},{version:"4.7.8.3",fn:function(e){e.get("Circles")&&!_.isArray(e.get("Circles"))&&e.set("Circles.0",e.get("Circles")),e.get("Points")&&!_.isArray(e.get("Points"))&&e.set("Points.0",e.get("Points")),e.get("Lines")&&!_.isArray(e.get("Lines"))&&e.set("Lines.0",e.get("Lines"));e.get("HeatmapGrid");_.isNil(e.get("HeatmapGrid"))&&e.set("HeatmapGrid",{possibleHeatmap:[""],DataSource:"",ID:"",Latitude:"",Longitude:"",Tooltip:"",Shape:"square",GridSize:50,ShowZero:!0,Min:0,Max:0,Actions:[],Colors:[{color:"#2166AC"},{color:"#67A9CF"},{color:"#D1E5F0"},{color:"#FDDBC7"},{color:"#EF8A62"},{color:"#B2182B"}]})}},{version:"v2.2.1",fn:function(r){r.get("Annotation.Selected")||r.set("Annotation.Selected",""),_.each(r.get("Lines"),function(e,t){r.get("Lines."+t+".Gradient")||r.set("Lines."+t+".Gradient",!1),r.get("Lines."+t+".GradientType")||r.set("Lines."+t+".GradientType","linear"),r.get("Lines."+t+".GradientSource")||r.set("Lines."+t+".GradientSource","")})}},{version:"v2.2.3",fn:function(i){_.each(["Points","Circle","Lines"],function(r){var e=i.get(r);_.each(e,function(e,t){i.get("".concat(r,".").concat(t,".ShowTooltip"))||i.set("".concat(r,".").concat(t,".ShowTooltip"),!0)})}),_.each(["HeatmapGrid","Heatmap","AnimatedCircles","Layers.DataSource"],function(e){i.get("".concat(e,".ShowTooltip"))||i.set("".concat(e,".ShowTooltip"),!0)})}},{version:"v2.2.6",fn:function(e){e.get("HeatmapGrid.PaletteTheme")||e.set("HeatmapGrid.PaletteTheme",""),e.get("Heatmap.PaletteTheme")||e.set("Heatmap.PaletteTheme",""),e.get("Layers.DataSource.PaletteTheme")||e.set("Layers.DataSource.PaletteTheme",""),e.get("TileServer")||e.set("TileServer",{Enable:!1,Style:"",Font:"Open Sans Bold"}),_.isNil(e.get("TileServer.UseApiUrl"))&&e.set("TileServer.UseApiUrl",!1),_.isNil(e.get("TileServer.ApiUrl"))&&e.set("TileServer.ApiUrl","")}},{version:"v2.3.0",fn:function(e){_.isNil(e.get("MapDetails.UrlStyle"))&&e.set("MapDetails.UrlStyle","")}},{version:"v2.3.1",fn:function(e){_.isNil(e.get("HeatmapGrid.Shape"))&&e.set("HeatmapGrid.Shape","square")}},{version:"v2.4.0",fn:function(i){_.isNil(i.get("Layers.DataSource.UseMinMax"))&&i.set("Layers.DataSource.UseMinMax",!1),_.isNil(i.get("Layers.DataSource.MinRange"))&&i.set("Layers.DataSource.MinRange",0),_.isNil(i.get("Layers.DataSource.MaxRange"))&&i.set("Layers.DataSource.MaxRange",100),_.isNil(i.get("HeatmapGrid.Shape"))&&i.set("HeatmapGrid.Shape","square"),i.get("HeatmapGrid.PaletteTheme")||i.set("HeatmapGrid.PaletteTheme","");_.each(["Points","Circles"],function(r){var e=i.get(r);_.each(e,function(e,t){i.get("".concat(r,".").concat(t,".ClusterMaxZoom"))||i.set("".concat(r,".").concat(t,".ClusterMaxZoom"),14),i.get("".concat(r,".").concat(t,".ClusterRadius"))||i.set("".concat(r,".").concat(t,".ClusterRadius"),50)})}),_.isNil(i.get("ConcentricCircles"))&&i.set("ConcentricCircles",{Datasource:"",Id:"",Lat:"",Lng:"",Radius:"",Colors:"",BorderWidth:1,FilterPoints:""})}},{version:"v2.5.0",fn:function(e){_.isNil(e.get("MapDetails.LayerSelect"))&&e.set("MapDetails.LayerSelect","none")}},{version:"v2.5.1",fn:function(i){["Simple","Hosted"].forEach(function(r){var e=i.get("Layers.".concat(r));e&&e.forEach(function(e,t){t=t;t="Layers.".concat(r,".").concat(t,".Tooltip");_.isNil(i.get(t))&&i.set(t,'\n                <div>\n                    <i class="fa fa-circle" style="color:{{this.color}}"></i> {{this.id}}\n                </div>\n                {{#each this.value}}\n                    <div>{{@key}} : {{this}}</div>\n                {{/each}}\n                ')})}),_.each(i.get("Circles"),function(e,t){_.isNil(i.get("Circles.".concat(t,".CircleOpacity")))&&i.set("Circles.".concat(t,".CircleOpacity"),100)}),_.each(i.get("Points"),function(e,t){_.isNil(i.get("Points.".concat(t,".IconOpacity")))&&i.set("Points.".concat(t,".IconOpacity"),100)})}},{version:"v2.5.3",fn:function(r){var e=r.get("Points"),e=(_.each(e,function(e,t){r.get("Points.".concat(t,".IconInterpolate"))||r.set("Points.".concat(t,".IconInterpolate"),!1),r.get("Points.".concat(t,".IconScaleInterpolate"))||r.set("Points.".concat(t,".IconScaleInterpolate"),{ZoomStop1:1,ZoomStop2:6,Stop1Percent:25,Exponential:2})}),r.get("Icons"));_.each(e,function(e){"airplane-jumobo"===e.name&&(e.name="airplane-jumbo")})}},{version:"v2.6.0",fn:function(i){_.each(["Points","Circles","Lines"],function(r){var e=i.get(r);_.each(e,function(e,t){i.get("".concat(r,".").concat(t,".Name"))||i.set("".concat(r,".").concat(t,".Name"),"")})});_.each(["ConcentricCircles","Heatmap","HeatmapGrid","AnimatedCircles","Layers.DataSource"],function(e){i.get("".concat(e,".Name"))||i.set("".concat(e,".Name"),"")}),["Simple","Hosted"].forEach(function(e){e=i.get("Layers.".concat(e));e&&e.forEach(function(e,t){i.set("Layers.".concat(e,".").concat(t,".Name"),"")})})}},{version:"v2.7.0",fn:function(e){_.isNil(e.get("Basics.TrackLoadTime"))&&e.set("Basics.TrackLoadTime",!1),_.isNil(e.get("Basics.LoadTime"))&&e.set("Basics.LoadTime",""),_.isNil(e.get("MapDetails.RenderWorldCopies"))&&e.set("MapDetails.RenderWorldCopies",!1),_.isNil(e.get("Heatmap.ShowBaseCircles"))&&e.set("Heatmap.ShowBaseCircles",!0)}},{version:"v2.9.0",fn:function(e){_.isNil(e.get("MapDetails.Projection"))&&e.set("MapDetails.Projection","mercator")}},{version:"v2.13.0",fn:function(e){_.isNil(e.get("Layers.Raster"))&&e.set("Layers.Raster",[])}},{version:"v2.15.0",fn:function(e){_.isNil(e.get("Export"))&&e.set("Export",{Filename:"",Data:""})}}];I.app=p.template({compiler:[8,">= 4.3.0"],main:function(e,t,r,i,o){var a=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="offlineMap" id="'+e.escapeExpression("function"==typeof(r=null!=(r=a(r,"id")||(null!=t?a(t,"id"):t))?r:e.hooks.helperMissing)?r.call(null!=t?t:e.nullContext||{},{name:"id",hash:{},data:o,loc:{start:{line:1,column:28},end:{line:1,column:34}}}):r)+'">\n</div>\n'},useData:!0}),I.gradientBar=p.template({1:function(e,t,r,i,o,a,n){var s=e.lambda,l=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'        <div style="background-color:'+l(s(t,t))+";width:"+l(s(null!=n[1]?e(n[1],"width"):n[1],t))+'px"></div>\n'},compiler:[8,">= 4.3.0"],main:function(e,t,r,i,o,a,n){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="gradientBar">\n'+(null!=(r=s(r,"each").call(null!=t?t:e.nullContext||{},null!=t?s(t,"colors"):t,{name:"each",hash:{},fn:e.program(1,o,0,a,n),inverse:e.noop,data:o,loc:{start:{line:2,column:4},end:{line:4,column:13}}}))?r:"")+"</div>"},useData:!0,useDepths:!0}),I.pngExport=p.template({compiler:[8,">= 4.3.0"],main:function(e,t,r,i,o){return'<button class="mapbox-gl-print-btn mapbox-gl-draw_print" title="export to png">\n    <i class="fa fa-camera mapbox-gl-draw_print" aria-hidden="true"></i>\n</button>\n'},useData:!0});var A=I;function I(){}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e){if(null===e)throw new TypeError("Cannot convert undefined or null to object");var r=Object(e);return _.each(arguments,function(e){if(null!==e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t])}),r},writable:!0,configurable:!0});x.cache=function(l,p,c,u){var e;_.isArray(c.load)&&(e=c.load.reduce(function(e,t,r){var i,o,a,n,s;return l.cache&&((o=l.cache[t])&&o.get("_viewType")&&(o=(i=o).get("value"),a=(n=(p+t).split(".")).pop(),n=n.join("."),s={},a)&&(s[a]=i,u.setProperty(n,s,{bypass:!0})),e[t]=o||c.defaults&&c.defaults[r]),e},{}),l.set(e)),_.isArray(c.store)&&(e=c.store.reduce(function(e,t){var r=(p+t).split("."),i=r.pop();return i&&(e[t]=u.getProperty(r.join("."))[i]),e},{}),_.extend(l.cache,e),e=c.store.reduce(function(e,t){return e[t]=void 0,e},{}),l.set(e))},x.compareKDBTimes=function(e,t){return e.i>t.i?1:e.i<t.i?-1:e.n>t.n?1:e.n<t.n?-1:0},x.convertPropertyIfMoment=function(e){e=Tools.convertISODatetimeToKDBLikeObject(e);return Tools.isKDBTemporal(e)?Tools.convertKDBTemporalToMoment(e):e},x.expandNestedViewStates=function(e,t){var r,i=/([a-zA-Z]+)\.[0-9]+\./,o=Object.keys(e),a=[];return(a=_.every(o,function(){var e=t.getPropertyMeta(o[0]);return e&&"viewstate"===e.type})?_.uniq(_.filter(_.map(o,function(e){e=i.exec(e);return e?e[1]:null}))):a).length?(r={},_.each(a,function(e){return r[e]=t.getProperty(e)}),r):e},x.focus2Array=function(e){var t=[],r=/"([^"]*)"/g,e=e.toString?e.toString():"",i=/^\[([^\]]*)]$/.exec(e);if(null!==i){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(i[1]))for(var o=void 0;null!==(o=r.exec(i[1]));)t.push(_.map(o[1].split(","),function(e){return e.replace(/&#44;/g,",")}))}else t.push(e.split(","));return _.filter(t,function(e){return 0<(""+e).length})},x.hex2RGB=function(e){e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e?[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]:[255,255,255]},x.RGB2hex=function(e){return"#"+((1<<24)+(e[0]<<16)+(e[1]<<8)+e[2]).toString(16).slice(1)},x.clamp=function(e,t,r){return r<e?r:e<t?t:e},x.interpolateColor=function(e,t,r,i){for(var r=(r-t)/(e.length-1),i=this.clamp((i-t)/r,0,e.length-1),i=_.isNaN(i)?0:i,t=e[Math.floor(i)].type,r=e[Math.ceil(i)].type,o=this.hex2RGB(t),a=this.hex2RGB(r),n=i-Math.floor(i),s=o.slice(),l=0;l<3;l++)s[l]=Math.round(s[l]+n*(a[l]-o[l]));return this.RGB2hex(s)},x.getConditionResult=function(e,t,r){var i,o,a={isMatch:function(e,t){var r,i=!1,o=e.split(/ +and +| +/);for(_.includes(o,"or")&&(o=_.without(o,"or"),i=!0),r=0;r<o.length;r++)0!==o[r].indexOf("-")&&o[r].indexOf("*")<0&&(o[r]="*"+o[r]+"*");return _[i?"some":"every"](o,function(e){return a.isSimpleMatch(e,t)})},isSimpleMatch:function(e,t){var r=!1,e=(0===e.indexOf("-")&&(e=e.replace("-",""),r=!0),new RegExp("^"+e.replace(/\*/g,".*")+"$").test(t));return r?!e:e}},n=!1,s=isNaN(parseFloat(e))||_.isObject(e)?(""+e).toLowerCase():parseFloat(e),l=isNaN(parseFloat(t))||_.isObject(t)?(""+t).toLowerCase():parseFloat(t);switch(e&&e.class&&0<=["1212","1213","1214","1215"].indexOf(e.class)?(s=Tools.convertKDBTemporalToMoment(e).unix(),"in"===r?(i=[],_.each(t.toString().split(","),function(e){i.push(Tools.convertDateStringValueToMoment(e).unix()),l=i.toString()})):l=Tools.convertDateStringValueToMoment(t).unix()):e&&e.class&&0<=["1216","1217","1218","1219"].indexOf(e.class)&&(s=Tools.convertKDBTemporalToMoment(e).valueOfNano(),"in"===r?(o=[],_.each(t.toString().split(","),function(e){o.push(Tools.convertDateStringValueToMoment(e).valueOfNano()),l=o.toString()})):l=Tools.convertDateStringValueToMoment(t).valueOfNano()),r){case"contains":n=0<=s.toString().indexOf(l.toString());break;case"starts with":n=0===s.toString().indexOf(l.toString());break;case"ends with":n=-1!==s.toString().indexOf(l.toString(),s.toString().length-l.toString().length);break;case"==":n=s===l;break;case"<":n=s<l;break;case">":n=l<s;break;case"<=":n=s<=l;break;case">=":n=l<=s;break;case"!=":n=s!==l;break;case"in":n=0<=l.toString().split(",").indexOf(s.toString());break;case"search":n=a.isMatch(l,s);break;case"regexp":n=new RegExp(t.toString()).test(e?e.toString():"")}return n},x.isDuration=function(e){return _.get(e,"_kdbType")&&0<=["1216","1217","1218","1219"].indexOf(e._kdbType)},x.getFormatter=function(i,o,a,n){return"Number"===i||"Formatted Number"===i||"Smart Number"===i||"Datetime"===i||"Currency"===i||"SmartCurrency"===i?function(e){var t,r=e;if(null==(e="Smart Number"!==i&&"Formatted Number"!==i||_.isNumber(e)?e:_.isNumber(parseFloat(e))?parseFloat(e):e))return"";if("Smart Number"===i)r=_.isNumber(e)?Tools.smartFormatNumber(e,o):_.escape(e);else{if("Datetime"===i)return t=e,(s.isMoment(e)||s.isDuration(e)?x.isDuration(e)?Tools.convertValueToMoment(e.valueOf()):e:Tools.isKDBTemporal(e)?Tools.convertKDBTemporalToMoment(e):("number"==typeof e&&(t=new Date(e)),Tools.convertDateStringValueToMoment(t.toString()))).format(n);r="Formatted Number"===i&&e.toFixed?_.isNaN(e)?"":Tools.formatNumber(e,o):e.toFixed?e.toFixed(o):_.escape(r)}if(a&&0<=r.toString().indexOf(".")){for(;"0"===r[r.length-1];)r=r.slice(0,-1);"."===r[r.length-1]&&(r=r.slice(0,-1))}return r}:"Boolean"===i?function(e){return _.escape(e)}:function(e){return s.isMoment(e)||s.isDuration(e)?e.format(n,void 0):_.escape(e)}},x.pump=function(r){var e,i,o;return null==r||!_.isObject(r)||(e=Object.getPrototypeOf(r),_.isObject(r)&&e!==Object.prototype&&e!==Array.prototype)?r:e===Array.prototype&&_.isArray(r)?r.map(x.pump):(i=/^(\d+)((?:\.\w+)+)$/,Object.keys(r).every(function(e){return i.test(e)})?Object.keys(r).map(function(e){var t=i.exec(e);return _.isNil(t)?{index:0,tail:void 0,value:void 0}:{index:Number(t[1]),tail:t[2].substring(1),value:r[e]}}).reduce(function(e,t){var r={},i=void 0===t.index?0:t.index;return r[i]={},r[i][t.tail]=t.value,_.merge(e,x.pump(r))},[]):(o={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/},Object.keys(r).some(function(e){return o.nonGreedy.test(e)})?Object.keys(r).map(function(e){var t=o.greedy.exec(e);return{head:_.isNil(t)?null:t[1],tail:_.isNil(t)||""===t[2]?null:t[2].substring(1),value:r[e]}}).reduce(function(e,t){var r={},i=null!==t.tail,o=_.isNil(t.head)?0:t.head,a=_.isNil(t.tail)?0:t.tail;return i?(r[o]={},r[o][a]=t.value):r[o]=t.value,_.merge(e,x.pump(r))},{}):_.mapValues(r,x.pump)))},x.replaceViewStatesWithValue=function(e,t,r){return x.replaceViewStates(e,t,function(e,t,r,i){return i.value!==r&&console.warn("viewModel value has changed"),i.value},r)},x.replaceViewStatesWithModel=function(e,t,i){return x.replaceViewStates(e,t,function(e,t,r){return r instanceof o.Model&&r.get("_viewType")?r:((e=i.getProperty(e)[t]).get("value")!==r&&e.set("value",r),e)},i)},x.alpha=function(e,t){var r=this.hex2RGB(e);return r?"rgba(".concat(r[0],",").concat(r[1],",").concat(r[2],",").concat(t/100,")"):new Color(e).alpha(t/100).rgbaString()},x.colorFactory=function(e,t,r){void 0===t&&(t="#0061FF"),void 0===r&&(r=80);var i={};return i[e+"Color"]={title:e.replace("Point","").replace("Hover","Hover ").replace("Border","Border ").replace("Background","Background ")+"Color",type:"gradient",default:t,options:{gradient:!1}},i[e+"Opacity"]={title:e.replace("Point","").replace("Hover","Hover ").replace("Border","Border ").replace("Background","Background ")+"Opacity",default:r,minimum:0,maximum:100,type:"number",step:1,format:"range"},i},x.backgroundFactory=function(e){return x.colorFactory(e+"Background")},x.borderFactory=function(e){var t={};return t[e+"BorderWidth"]={title:e.replace("Point","").replace("Hover","Hover ")+" Border Width",type:"number",format:"range",default:2.01,minimum:.01,maximum:10.01},_.merge(x.colorFactory(e+"Border"),t)},x.radiusFactory=function(e){var t={};return t[e+"Radius"]={title:e.replace("Point","").replace("Hover","Hover ").replace("Hit","Hit ")+"Radius",type:"number",format:"range",default:0,minimum:0,maximum:10},t},x.typeFactory=function(e){return{_Type:{type:"string",default:e,options:{hidden:!0}}}},x.replaceViewStates=function(r,e,l,p){var c;return c=function(e,t){return function r(e,t,i){i=i?i+".":"";var o,a,n=p.getPropertyMeta(i+(t+="")),s=e&&e.has&&e.has("_dataSource")&&e.has("_dataType"),s=(_.isArray(e)||_.isObject(e))&&!s;return n&&"data"===n.type?e:n&&"viewstate"===n.type?(o=(a=(i+t).split(".")).pop(),a=a.join("."),l(a,void 0===o?"":o,e,n)):s?(i+=t,c=function(e,t){return r(e,t,i)},(_.isArray(e)?_.map:_.mapValues)(e,c)):e}(e,t,r||"")},(_.isArray(e)?_.map:_.mapValues)(e,c)};var M=x;function x(){}k.COUNTRY_CODES1=["in","ADM0_A3","AFG","ALD","BEN","BLR","BWA","COK","COL","DNK","DOM","ERI","FIN","FRA","FRO","GIB","GNB","GNQ","GRC","GTM","JPN","KIR","LKA","MHL","MMR","MWI","NCL","OMN","RWA","SMR","SVK","SYR","TCD","TON","URY","WLF"],k.COUNTRY_CODES2=["in","ADM0_A3","AZE","BGD","CHL","CMR","CSI","DEU","DJI","GUY","HUN","IOA","JAM","LBN","LBY","LSO","MDG","MKD","MNG","MRT","NIU","NZL","PCN","PYF","SAU","SHN","STP","TTO","UGA","UZB","ZMB"],k.COUNTRY_CODES3=["in","ADM0_A3","AGO","ASM","ATF","BDI","BFA","BGR","BLZ","BRA","CHN","CRI","ESP","HKG","HRV","IDN","IRN","ISR","KNA","LBR","LCA","MAC","MUS","NOR","PLW","POL","PRI","SDN","TUN","UMI","USA","USG","VIR","VUT"],k.COUNTRY_CODES4=["in","ADM0_A3","ARE","ARG","BHS","CIV","CLP","DMA","ETH","GAB","GRD","GRL","HMD","IND","IOT","IRL","IRQ","ITA","KOS","LUX","MEX","NAM","NER","PHL","PRT","RUS","SEN","SUR","TZA","VAT"],k.COUNTRY_CODES5=["in","ADM0_A3","AUT","BEL","BHR","BMU","BRB","CYN","DZA","EST","FLK","GMB","GUM","HND","JEY","KGZ","LIE","MAF","MDA","NGA","NRU","SLB","SOL","SRB","SWZ","THA","TUR","VEN","VGB"],k.COUNTRY_CODES6=["in","ADM0_A3","AIA","BIH","BLM","BRN","CAF","CHE","COM","CPV","CUB","ECU","ESB","FSM","GAZ","GBR","GEO","KEN","LTU","MAR","MCO","MDV","NFK","NPL","PNG","PRY","QAT","SLE","SPM","SYC","TCA","TKM","TLS","VNM","WEB","WSB","YEM","ZWE"],k.COUNTRY_CODES7=["in","ADM0_A3","ABW","ALB","AND","ATC","BOL","COD","CUW","CYM","CYP","EGY","FJI","GGY","IMN","KAB","KAZ","KWT","LAO","MLI","MNP","MSR","MYS","NIC","NLD","PAK","PAN","PRK","ROU","SGS","SVN","SWE","TGO","TWN","VCT","ZAF"],k.COUNTRY_CODES8=["in","ADM0_A3","ARM","ATG","AUS","BTN","CAN","COG","CZE","GHA","GIN","HTI","ISL","JOR","KHM","KOR","LVA","MLT","MNE","MOZ","PER","SAH","SGP","SLV","SOM","TJK","TUV","UKR","WSM"],k.COUNTRY_CODES9=["in","ADM0_A3","ATA"],k.COUNTRY_STATES1=["in","ADM0_A3","USA","CAN","AUS"];var N,B=k;function k(){}function H(e){var t=N.call(this,e)||this;t.ignoreOnSettingsChange=!1,t.listenersActive=!1,t.mapboxID="",t.lastZoom=0,t.drawControlAdded=!1,t.selectedCoordinate=[],t.length=0,t.path="OfflineMap",t.styleLoad=!1,t.currentAnnotatedState={},t.globalPalette=[],t.showLayers=!1,t.layersVisibility={},t.api=e.api,t.mapboxID=t.mapboxID="offlineMap-".concat(t.cid),t.el.innerHTML=A.app({id:t.mapboxID}),t.viewModel=new o.DeepModel({}),t.path=t.extractOfflineMapPath(e.dashboardAppModel),t.dashboardViewModel=e.dashboardViewModel,t.setTheme(t.dashboardViewModel.get(H.APP_THEME)),t.api.getProperty("MapDetails.Offline");return t.determineMapStyle(),t.loadPalettes(e),t}return N=o.View,e(H,N),H.prototype.initializeMapStyle=function(e){this.initializeMap(e),this.registerMapEvents()},H.prototype.checkArrayOfArrays=function(e){return e.every(function(e){return Array.isArray(e)})},H.prototype.showTooltip=function(e,t,r,i,o,a,n){var s=this;if(t&&r){for(r=this.api.getTemplateViewStates(t);180<Math.abs(e.lngLat.lng-i[0]);)i[0]+=e.lngLat.lng>i[0]?360:-360;this.popup&&this.popup.remove();n=n||u(u({},r),{id:o,latitude:1<i.length?i[1]:0,longitude:1<i.length?i[0]:0,altitude:2<i.length?i[2]:0});0<a.length&&(n=u(u({},n),a[0]));var r=p.compile(t)(n),l=i;i&&0<i.length&&this.checkArrayOfArrays(i)&&(l=_.last(i),_.each(i,function(e){s.map.getBounds().contains(e)&&(l=e)})),this.popup=new c.Popup({closeOnClick:!0,autoPan:!1,maxWidth:"none",keepInView:!0}).setLngLat(l).setHTML(r).addTo(this.map)}},H.prototype.hideTooltip=function(){this.popup&&this.popup.remove()},H.prototype.extractOfflineMapPath=function(e){e=_.filter(e.get("paths"),function(e){return"OfflineMap"===e.key});return _.get(e,"0.value","OfflineMaps")},H.prototype.removeMapBoxDrawSources=function(){var t=this;_.each(["mapbox-gl-draw-cold"],function(e){t.map.getSource(e)&&t.map.removeSource(e)})},H.prototype.determineMapStyle=function(){return a(this,void 0,void 0,function(){var t,r,i,o,a;return n(this,function(e){switch(e.label){case 0:if(i=this.api.getProperty("ExternalAPI.Enable"),o=this.api.getProperty("TileServer.Enable"),i&&(i=this.api.getProperty("ExternalAPI.Key"),r=this.api.getProperty("ExternalAPI.Style"),t=this.api.getProperty("ExternalAPI.URL"),this.initializeMapStyle("".concat(t).concat(r,"?token=").concat(i))),!o)return[3,8];if(t=this.api.getProperty("TileServer.UseApiUrl"),r=this.api.getProperty("TileServer.ApiUrl"),i=this.api.getProperty("TileServer.Style"),!t)return[3,6];e.label=1;case 1:return e.trys.push([1,4,,5]),[4,fetch(r)];case 2:if((o=e.sent()).ok)return[4,o.json()];throw new Error("Failed to fetch from Tile Server: ".concat(o.statusText));case 3:return a=e.sent(),this.initializeMapStyle(a),[3,5];case 4:return a=e.sent(),console.error("Error fetching TileServer API:",a),this.initializeMapStyle(this.getStyle()),[3,5];case 5:return[3,7];case 6:i&&this.initializeMapStyle(JSON.parse(_.unescape(i))),e.label=7;case 7:return[3,9];case 8:this.initializeMapStyle(this.getStyle()),e.label=9;case 9:return[2]}})})},H.prototype.initializeMap=function(e){var r=this;this.map=new c.Map({container:this.mapboxID,fadeDuration:0,center:[this.api.getProperty("MapDetails.Longitude"),this.api.getProperty("MapDetails.Latitude")],zoom:this.api.getProperty("MapDetails.Zoom"),style:e,canvasContextAttributes:{preserveDrawingBuffer:!1}}),this.setRenderWorldCopies(),this.map.addControl(new c.NavigationControl),this.map.on("style.load",function(){var t=(new Date).getTime();r.map.once("idle",function(){var e;r.api.getProperty("Basics.TrackLoadTime")&&(e=(new Date).getTime(),r.api.setProperty("Basics.LoadTime",e-t)),r.map.setProjection({type:r.api.getProperty("MapDetails.Projection")})})})},H.prototype.registerMapEvents=function(){var t=this;this.map.on("load",function(){t.initializeLayers(),t.interactions(),t.renderNightDayLayer(),t.setMapBounds(),t.initializeListeners()}),this.map.on("style.load",function(){t.styleLoad=!0,t.set3DModel(),t.timeout=setTimeout(function(){t.renderAnnotationFromViewstate()},2e3)}),this.map.on("zoomend",function(){return t.setMapBounds()}),this.lastZoom=this.map.getZoom(),this.map.on("zoom",function(){var e=t.map.getZoom();e!==t.lastZoom&&t.zoomChanges(e),t.lastZoom=e}),this.setAnnotationSelection=_.debounce(function(e){t.updateAnnotatedSelection(e)},300),this.annotationMenu()},H.prototype.loadPalettes=function(e){this.globalPalette=e.dashboardAppModel.get("globalPalettes");e=_.uniqBy(this.globalPalette,"rule");this.api.setProperty("possiblePalettes",_.map(e,"rule"))},H.prototype.initializeLayers=function(){this.clusterLayer=new Z({map:this.map,api:this.api,path:this.path,el:this.el,app:this}),this.clusterLayer.renderPoints(),this.circleLayer=new j({map:this.map,api:this.api,el:this.el,app:this}),this.circleLayer.renderCircles(),this.animatedCircleLayer=new G({map:this.map,api:this.api,app:this}),this.animatedCircleLayer.renderAnimatedCircles(),this.concentricCircleLayer=new U({map:this.map,api:this.api,app:this}),this.concentricCircleLayer.renderConcentricCircles(),this.lineLayer=new q({map:this.map,api:this.api,app:this}),this.lineLayer.renderLines(),this.heatmapLayer=new V({map:this.map,api:this.api,el:this.el,app:this}),this.heatmapLayer.renderHeatmaps(),this.heatmapGridLayer=new z({map:this.map,api:this.api,el:this.el,app:this}),this.heatmapGridLayer.renderHeatmaps(),this.layers=new W({map:this.map,api:this.api,el:this.el,path:this.path,app:this}),this.layers.renderLayers(),this.layers.addLayers()},H.prototype.zoomChanges=function(e){this.heatmapGridLayer&&this.heatmapGridLayer.setZoomLevel(e)},H.prototype.set3DModel=function(){var e,t,r,i,o,a,n=this.api.getProperty("Style.extrusion.extrude");this.styleLoad&&n?(e=this.api.getProperty("Style.extrusion.source"),t=this.api.getProperty("Style.extrusion.sourceLayer"),r=this.api.getProperty("Style.extrusion.minZoom"),i=this.api.getProperty("Style.extrusion.fillColor"),o=this.api.getProperty("Style.extrusion.fillOpacity"),a=this.map.getStyle().layers.find(function(e){return"symbol"===e.type&&e.layout["text-field"]}).id,this.map.getLayer("add-3d")&&this.map.removeLayer("add-3d"),this.map.addLayer({id:"add-3d",source:e,"source-layer":t,filter:["==","extrude","true"],type:"fill-extrusion",minzoom:parseFloat(r),paint:{"fill-extrusion-color":i,"fill-extrusion-height":["interpolate",["linear"],["zoom"],15,0,15.05,["get","height"]],"fill-extrusion-base":["interpolate",["linear"],["zoom"],15,0,15.05,["get","min_height"]],"fill-extrusion-opacity":parseFloat(o)/100}},a)):n||this.map.getLayer("add-3d")&&this.map.removeLayer("add-3d")},H.prototype.setExternalAPIStyle=function(){var e=this.api.getProperty("ExternalAPI.Key"),t=this.api.getProperty("ExternalAPI.Style");this.map.setStyle("https://basemapstyles-api.arcgis.com/arcgis/rest/services/styles/v2/styles/"+t+"?token="+e)},H.prototype.setMapBounds=function(){var e=this.map.getBounds(),t=e.getSouthWest(),e=e.getNorthEast(),r=this.map.getCenter();this.api.setProperty("MapDetails.Latitude",_.get(r,"lat")),this.api.setProperty("MapDetails.Longitude",_.get(r,"lng")),this.api.setProperty("MapDetails.Zoom",this.map.getZoom()),this.api.setProperty("Bounds.Current",[t.lat,t.lng,e.lat,e.lng])},H.prototype.renderNightDayLayer=function(){var e=this.api.getProperty("NightDayLayer.Show"),t=this.api.getProperty("NightDayLayer.Current");this.map&&e&&(e=new F({time:t.substr(0,19),resolution:2}),this.map.getLayer("daynight")&&this.map.removeLayer("daynight"),this.map.getSource("daynightData")&&this.map.removeSource("daynightData"),this.map.addSource("daynightData",{type:"geojson",data:e}),this.map.addLayer({id:"daynight",type:"fill",source:"daynightData",layout:{},paint:{"fill-color":"#000","fill-opacity":.1}}))},H.prototype.interactions=function(){var t=this;this.map&&_.each(["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],function(e){t.api.getProperty("Interactions."+e)?t.map[e].enable():t.map[e].disable()})},H.prototype.exportMapToPNG=function(){var o=this,a=this.api.getProperty("Export.Filename");requestAnimationFrame(function(){requestAnimationFrame(function(){o.map.once("idle",function(){var e=o.map.getCanvas(),t=(a||"map")+".png";if(0===e.width||0===e.height)console.error("Canvas has invalid dimensions.");else try{var r=e.toDataURL("image/png"),i=document.createElement("a");o.api.setProperty("Export.Data",r),i.href=r,i.download=t,i.click(),URL.revokeObjectURL(i.href),console.log("Map exported as PNG:",t)}catch(e){console.error("Failed to export map:",e)}})})})},H.prototype.annotationMenu=function(){var e,t=this;function r(e){this.hostedLayers=["SimpleLayer","ostedLayer"],this.definedLayers=l(l([],this.hostedLayers,!0),["unclustered-","route","location-radius-outline-0-0","heatmap-grid","heatmap-heat","unclustered-animatedCircle","Raster"],!1),(this.app=e).$el.find(".maplibregl-ctrl-groupLayers").remove()}this.map&&(this.draw||(this.draw=new E({displayControlsDefault:!1,controls:{line_string:!0,polygon:!0,trash:!0},defaultMode:"simple_select"}),this.map.on("draw.create",_.bind(this.updateArea,this)),this.map.on("draw.delete",_.bind(this.updateArea,this)),this.map.on("draw.update",_.bind(this.updateArea,this)),this.map.on("draw.selectionchange",_.bind(this.updateTooltip,this))),this.draw&&(this.map&&this.previousDraw&&this.map.removeControl(this.previousDraw),this.api.getProperty("Annotation.Enable")?(this.map.addControl(this.draw),this.drawControlAdded=!0,this.$el.find(".mapboxgl-ctrl-group").addClass("maplibregl-ctrl maplibregl-ctrl-group"),this.el.classList.add("maplibregl-ctrl"),this.previousDraw=this.draw):this.drawControlAdded&&(this.map.removeControl(this.draw),this.drawControlAdded=!1),this.$el.find(".mapboxgl-ctrl-group").append(A.pngExport()),this.$el.find(".mapbox-gl-draw_print")[0].addEventListener("click",function(e){t.exportMapToPNG(),_.defer(function(){t.map.triggerRepaint()},500)})),r.prototype.filterLayers=function(e,t){return e.filter(t)},r.prototype.toggleVisibility=function(e,t){var r=this;e.forEach(function(e){r.app.map.setLayoutProperty(e,"visibility",t?"visible":"none")})},r.prototype.isHostedLayer=function(t){return this.hostedLayers.some(function(e){return t.includes(e)})},r.prototype.isDefinedLayer=function(t){return!!t&&this.definedLayers.some(function(e){return t.includes(e)&&!t.includes("lbl")&&!t.includes("cluster-")})},r.prototype.labelText=function(i){return Object.entries({"unclustered-point":"Point Layer ","unclustered-circle":"Circle Layer ",Raster:"Layer","unclustered-animatedCircle":"Animated Circle Layer ",route:"Line Layer ","heatmap-grid":"Heatmap GRID ","heatmap-heat":"Heatmap Layer ",SimpleLayerID:"Simple Layer ",HostedLayerID:"Hosted Layer ",hostedLayerDataSource:"Data Layer ","location-radius-outline-0-0":"Concentric Circle Layer ",id:""," 00":""," 0":""}).forEach(function(e){var t=e[0],e=e[1],r=i.indexOf(t);i=0<r?i.substring(0,r):i.replace(t,e)}),i},r.prototype.linkedLayer=function(e){return e},r.prototype.onAdd=function(){var t=this,r=this.app.api.getProperty("MapDetails.LayerSelect"),i=document.createElement("div");return"none"!==r?(i.className="mapboxgl-ctrl-group mapboxgl-ctrl maplibregl-ctrl maplibregl-ctrl-group maplibregl-ctrl-groupLayers",i.innerHTML='<button class="mapbox-gl-draw_ctrl-draw-btn mapbox-gl-draw_layers">\n                            <svg class="menuButton" focusable="false" viewBox="-5 -5 24 24" aria-hidden="true">\n                                <path d="M 0.289062 3.46875 L 5.75 5.945312 C 5.910156 6.019531 6.089844 6.019531 6.25 5.945312 L 11.707031 3.46875 C 12.097656 3.292969 12.097656 2.707031 11.707031 2.53125 L 6.25 0.0546875 C 6.089844 -0.0195312 5.910156 -0.0195312 5.75 0.0546875 L 0.289062 2.53125 C -0.0976562 2.707031 -0.0976562 3.292969 0.289062 3.46875 Z M 11.710938 5.539062 L 10.347656 4.921875 L 6.558594 6.636719 C 6.382812 6.71875 6.195312 6.757812 6 6.757812 C 5.804688 6.757812 5.617188 6.71875 5.441406 6.636719 L 1.652344 4.921875 L 0.289062 5.539062 C -0.0976562 5.714844 -0.0976562 6.300781 0.289062 6.476562 L 5.75 8.949219 C 5.910156 9.023438 6.089844 9.023438 6.25 8.949219 L 11.710938 6.476562 C 12.097656 6.300781 12.097656 5.714844 11.710938 5.539062 Z M 11.710938 8.535156 L 10.351562 7.917969 L 6.558594 9.636719 C 6.382812 9.71875 6.195312 9.757812 6 9.757812 C 5.804688 9.757812 5.617188 9.71875 5.441406 9.636719 L 1.648438 7.917969 L 0.289062 8.535156 C -0.0976562 8.710938 -0.0976562 9.296875 0.289062 9.472656 L 5.75 11.945312 C 5.910156 12.019531 6.089844 12.019531 6.25 11.945312 L 11.710938 9.472656 C 12.097656 9.296875 12.097656 8.710938 11.710938 8.535156 Z M 11.710938 8.535156"></path>\n                            </svg>\n                        </button>\n                        '.concat("all"===r?'<div class="mapControlMenu" style="color:black"></div>':""),i.addEventListener("contextmenu",function(e){return e.preventDefault()}),i.addEventListener("click",function(e){return t.handleLayerClick(e,i,r)})):_.each(this.app.map.getLayersOrder(),function(e){t.app.map.setLayoutProperty(e,"visibility","visible")}),i},r.prototype.layersDisplay=function(e,t){var r,i=this,o=[e],a="unclustered-point",n="unclustered-circle",s=this.app.map.getLayersOrder();0<=e.indexOf(a)&&(r=e.substring(e.indexOf(a)+a.length,e.length),a=e.substring(0,e.indexOf(a)),o.push(a+"cluster-clustered-point"+r),o.push(a+"cluster-count"+r)),0<=e.indexOf(n)&&(r=e.substring(e.indexOf(n)+n.length,e.length),o.push("circleClusters"+r),o.push("circle-cluster-count"+r),o.push("unclustered-circle-lbl"+r)),"heatmap-heat"===e&&o.push("heatmap-point"),e.indexOf("route")&&(r=e.substring("route".length),o.push("linesLabels"+r)),0<=e.indexOf("location-radius-outline-0-0")&&(o=_.filter(s,function(e){return 0<=e.indexOf("location-radius-outline")})),_.each(o,function(e){0<=_.indexOf(s,e)&&i.app.map.setLayoutProperty(e,"visibility",t?"visible":"none")})},r.prototype.handleLayerClick=function(r,e,t){var i=this,o=this.filterLayers(this.app.map.getLayersOrder(),this.isHostedLayer.bind(this)),a=this.filterLayers(this.app.map.getLayersOrder(),this.isDefinedLayer.bind(this)),n="",t=(_.get(r,"target.classList")&&(0===r.target.classList.length||r.target.classList.contains("menuButton"))&&("quick"===t&&(this.toggleVisibility(o,!this.app.showLayers),this.app.showLayers?e.classList.add("hideLayer"):e.classList.remove("hideLayer")),this.app.showLayers=!this.app.showLayers),this.app.showLayers&&a.forEach(function(e){var t=r.target instanceof HTMLElement&&r.target.classList.value.includes(e),t=(i.app.layersVisibility[e]=i.app.layersVisibility[e]||{isCheck:!0},t&&(i.app.layersVisibility[e].isCheck=!i.app.layersVisibility[e].isCheck),i.app.layersVisibility[e].isCheck);n+='\n                            <div class="'.concat(e,'">\n                                <i class="').concat(e," layer-enablement layer-icon-enablement fa ").concat(t?"fa-check-square-o":"fa-square-o"," ").concat(e,'"></i>\n                                <span class="').concat(e,' layer-enablement layer-text-enablement">').concat(i.labelText(e)," </span>\n                            </div>\n                        "),i.layersDisplay(e,t)}),e.querySelector(".mapControlMenu"));t&&(t.innerHTML=n)},e=new r(this),this.map.addControl(e,"top-right"))},H.prototype.tryParseJSONObject=function(e){try{var t=JSON.parse(e);if(t&&"object"==typeof t)return t}catch(e){}return!1},H.prototype.updateArea=function(e){var t,r,i,o=null==(o=e.features)?void 0:o[0];"Polygon"===(null==(t=null==o?void 0:o.geometry)?void 0:t.type)&&(t="draw.delete"===e.type,e=this.api.getProperty("Annotation.Filter"),r=_.get(this.currentAnnotatedState,"features"),t?r&&((i=null==o?void 0:o.id)&&(this.currentAnnotatedState.features=this.currentAnnotatedState.features.filter(function(e){return e.id!==i}),this.api.setProperty("Annotation.Selected",JSON.stringify(this.currentAnnotatedState))),0===this.currentAnnotatedState.features.length)?this.removeOldAnnotatedViewstateLayer():this.filterAnnotatedData(this.draw.getAll()):e?this.filterAnnotatedData(this.draw.getAll()):this.updateAnnotatedSelection(this.draw.getAll()))},H.prototype.filterAnnotatedData=function(e){0<e.features.length&&(this.clusterLayer&&this.clusterLayer.filterPoints(e),this.circleLayer)&&this.circleLayer.filterCircles(e),this.currentAnnotatedState=e,this.setAnnotationSelection(e),this.api.getProperty("Annotation.Zoom")&&this.map.fitBounds(d.bbox(e))},H.prototype.updateAnnotatedSelection=function(e){this.api.setProperty("Annotation.Selected",JSON.stringify(e))},H.prototype.updateTooltip=function(e){var t;"LineString"===_.get(e.features[0],"geometry.type")&&(e=e.target.getCenter(),t=this.draw.getSelected(),_.get(t,"features")&&0<t.features.length&&(this.selectedCoordinate=_.get(t.features[0],"geometry.coordinates"),this.length=d.length(t)),e.lng)&&e.lat&&(t=0<this.selectedCoordinate.length?this.selectedCoordinate[0]:[e.lng,e.lat],this.popup=new c.Popup({keepInView:!0,autoPan:!1,maxWidth:"none"}).setLngLat(t).setHTML(this.length.toFixed(2)+"km").addTo(this.map))},H.prototype.removeMapData=function(){this.clusterLayer&&this.clusterLayer.remove(),this.circleLayer&&this.circleLayer.remove(),this.lineLayer&&this.lineLayer.remove(),this.heatmapLayer&&this.heatmapLayer.remove(),this.heatmapGridLayer&&this.heatmapGridLayer.remove(),this.animatedCircleLayer&&this.animatedCircleLayer.remove(),this.concentricCircleLayer&&this.concentricCircleLayer.remove(),this.map&&(this.map=null),this.setAnnotationSelection&&this.setAnnotationSelection.cancel()},H.prototype.remove=function(){return this.removeMapData(),this.timeout&&clearTimeout(this.timeout),o.View.prototype.remove.apply(this)},H.prototype.onResize=function(){this.map&&this.map.resize()},H.prototype.getColor=function(e,t,r,i){e=this.api.getProperty("Style.colors."+e);return e===t||e===r?"Light"===i?t:r:e},H.prototype.setTheme=function(e){"Light"===e?this.el.classList.add("Light"):this.el.classList.remove("Light"),this.theme=e,this.api.setProperty("Style.colors.pink",this.getColor("pink","#f3c1d3","#a6a6a6",e)),this.api.setProperty("Style.colors.purple",this.getColor("purple","#ceb5cf","#a6a6a6",e)),this.api.setProperty("Style.colors.blue",this.getColor("blue","#a3cec5","#a6a6a6",e)),this.api.setProperty("Style.colors.torquoise",this.getColor("torquoise","#aadb78","#a6a6a6",e)),this.api.setProperty("Style.colors.green",this.getColor("green","#d3e46f","#a6a6a6",e)),this.api.setProperty("Style.colors.yellow",this.getColor("yellow","#fae364","#a6a6a6",e)),this.api.setProperty("Style.colors.orange",this.getColor("orange","#fdc663","#a6a6a6",e)),this.api.setProperty("Style.colors.red",this.getColor("red","#fdaf6b","#a6a6a6",e)),this.api.setProperty("Style.colors.white",this.getColor("white","#f0f8ff","#a6a6a6",e)),this.api.setProperty("Style.colors.background",this.getColor("background","#ddeeff","#171717",e)),this.getStyle(),this.clusterLayer&&this.clusterLayer.renderPoints(),this.heatmapLayer&&this.heatmapLayer.renderHeatmaps(),this.heatmapGridLayer&&this.heatmapGridLayer.renderHeatmaps(),this.circleLayer&&this.circleLayer.renderCircles(),this.animatedCircleLayer&&this.animatedCircleLayer.renderAnimatedCircles(),this.concentricCircleLayer&&this.concentricCircleLayer.renderConcentricCircles()},H.prototype.onViewModelChanged=function(e){var r=this,i=[/(Circles.)(\d+)(.Cluster)/,/(Circles.)(\d+)(.Name)/,/(Circles.)(\d+)(.CirclesInView)/,/(Circles.)(\d+)(.DataSource)/,/(Circles.)(\d+)(.ID)/,/(Circles.)(\d+)(.Latitude)/,/(Circles.)(\d+)(.Longitude)/,/(Circles.)(\d+)(.Altitude)/,/(Circles.)(\d+)(.Color)/,/(Circles.)(\d+)(.Radius)/,/(Circles.)(\d+)(.StrokeColor)/,/(Circles.)(\d+)(.StrokeWidth)/,/(Circles.)(\d+)(.CircleOpacity)/,/(Circles.)(\d+)(.UseLabel)/,/(Circles.)(\d+)(.Label)/,/(Circles.)(\d+)(.LabelSize)/,/(Circles.)(\d+)(.Tooltip)/,/(Circles.)(\d+)(.ZoomOnSelect)/,/(Circles.)(\d+)(.TrackSelected)/,/(Circles.)(\d+)(.Selected.Color)/,/(Circles.)(\d+)(.Selected.Column)/],o=[/(Points.)(\d+)(.Cluster)/,/(Points.)(\d+)(.Name)/,/(Points.)(\d+)(.PointsInView)/,/(Points.)(\d+)(.DataSource)/,/(Points.)(\d+)(.ID)/,/(Points.)(\d+)(.Latitude)/,/(Points.)(\d+)(.Longitude)/,/(Points.)(\d+)(.Altitude)/,/(Points.)(\d+)(.Color)/,/(Points.)(\d+)(.Radius)/,/(Points.)(\d+)(.StrokeColor)/,/(Points.)(\d+)(.StrokeWidth)/,/(Points.)(\d+)(.IconOpacity)/,/(Points.)(\d+)(.UseLabel)/,/(Points.)(\d+)(.Label)/,/(Points.)(\d+)(.LabelSize)/,/(Points.)(\d+)(.Tooltip)/,/(Points.)(\d+)(.ZoomOnSelect)/,/(Points.)(\d+)(.TrackSelected)/,/(Points.)(\d+)(.Selected.Color)/,/(Points.)(\d+)(.Selected.Column)/,/(Points.)(\d+)(.IconInterpolate)/,/(Points.)(\d+)(.IconScaleInterpolate.ZoomStop1)/,/(Points.)(\d+)(.IconScaleInterpolate.ZoomStop2)/,/(Points.)(\d+)(.IconScaleInterpolate.Stop1Percent)/,/(Points.)(\d+)(.IconScaleInterpolate.Exponential)/],a=[/(Circles.)(\d+)(.Selected.SelectedItem)/,/(Circles.)(\d+)(.Selected.SelectedZoomedItems)/],n=[/(Points.)(\d+)(.Selected.SelectedItem)/,/(Points.)(\d+)(.Selected.SelectedZoomedItems)/],s=[/(Lines.)(\d+)(.DataSource)/,/(Lines.)(\d+)(.Name)/,/(Lines.)(\d+)(.ID)/,/(Lines.)(\d+)(.Latitude)/,/(Lines.)(\d+)(.Longitude)/,/(Lines.)(\d+)(.Tooltip)/,/(Lines.)(\d+)(.ShowTooltip)/,/(Lines.)(\d+)(.Actions)/,/(Lines.)(\d+)(.Color)/,/(Lines.)(\d+)(.Width)/,/(Lines.)(\d+)(.UseLabel)/,/(Lines.)(\d+)(.Label)/,/(Lines.)(\d+)(.LabelSize)/,/(Lines.)(\d+)(.LinesInView)/,/(Lines.)(\d+)(.Gradient)/,/(Lines.)(\d+)(.Colors)/,/(Lines.)(\d+)(.Point.Size)/,/(Lines.)(\d+)(.Point.Color)/],l=[/(Lines.)(\d+)(.CurrentPoint)/];_.each(e,function(e,t){_.each(i,function(e){e=t.match(e);e&&_.get(e,2)&&r.circleLayer.renderCircleByLayer(e[2])}),_.each(a,function(e){e=t.match(e);e&&_.get(e,2)&&r.circleLayer.updateSelected(e[2])}),_.each(o,function(e){e=t.match(e);e&&_.get(e,2)&&r.clusterLayer.renderPointsByLayer(e[2])}),_.each(n,function(e){e=t.match(e);e&&_.get(e,2)&&r.clusterLayer.updateSelected(e[2])}),_.each(s,function(e){e=t.match(e);e&&_.get(e,2)&&r.lineLayer.renderLinesByLayer(e[2])}),_.each(l,function(e){e=t.match(e);e&&_.get(e,2)&&r.lineLayer.onCurrentPointChange(_.get(e,2))})})},H.prototype.onSettingsChange=function(e){e=M.expandNestedViewStates(e,this.api),e=M.replaceViewStatesWithValue("",e,this.api),e=M.pump(e);this.onSettingsChangeProcessed.call(this,e)},H.prototype.onSettingsChangeProcessed=function(r){var o=this,a=["Circles","Points","Lines","Layers"];_.each(r,function(e,i){var t;0<=a.indexOf(i)?o.newLayerDetails(i,e)||_.each(e,function(e,r){_.each(e,function(e,t){o.viewModel.set(i+"."+r+"."+t,e)})}):"Hosted"===i?(t=o.api.getProperty("Layers.Hosted"),_.each(t,function(e,t){_.each(["Layers.Hosted."+t+".file","Layers.Hosted."+t+".property"],function(e){o.viewModel.set(e,e)})})):"Raster"===i?(t=o.api.getProperty("Layers.Raster"),_.each(t,function(e,t){_.each(["Layers.Raster."+t+".Name","Layers.Raster."+t+".TileUrl","Layers.Raster."+t+".TileSize"],function(e){o.viewModel.set(e,o.api.getProperty(e))})})):o.viewModel.set(r)}),this.ignoreOnSettingsChange&&(this.ignoreOnSettingsChange=!1),this.listenersActive||this.initializeListeners()},H.prototype.newLayerDetails=function(r,e){var i=this,o=!1;return _.each(e,function(e,t){e&&""!==e.DataSource&&""===i.viewModel.get(r+"."+t+".DataSource")&&("Circles"===r&&i.circleLayer?(i.circleLayer.renderMapCircleLayer(t),o=!0):"Points"===r&&i.clusterLayer?(i.clusterLayer.renderMapPointsLayer(t),o=!0):"Lines"===r&&i.lineLayer&&(i.lineLayer.renderMapLinesLayer(t),o=!0))}),o},H.prototype.flattenObj=function(r,i){var o=this,a={},n=["SelectedZoomedItems","SelectedItem","DataSource"];return Object.keys(r).forEach(function(e){var t=i?"".concat(i,".").concat(e):e;"object"!=typeof r[e]||0<=n.indexOf(e)?a[t]=r[e]:a=u(u({},a),o.flattenObj(r[e],t))}),a},H.prototype.updatePalette=function(e,t,r){var i,o,a=this.api.getProperty("".concat(e,".PaletteTheme"));null!=a&&a.trim()&&(i=""+(null!=(o=null==(o=this.dashboardViewModel)?void 0:o.get("DashboardTheme"))?o:""),o=_.filter(this.globalPalette,function(e){var t=_.get(e,"theme","").toLowerCase(),t=".dark"!==t&&".light"!==t||t===".".concat(i.toLowerCase());return e.rule===a&&t}),o=_.map(o,function(e){e=R.Tools.rgbStr2hex(e.color);return"color"===r?{color:e}:{type:e}}),this.api.setProperty("".concat(e,".").concat(t),o))},H.prototype.initializeListeners=function(){var e,r=this;this.layers&&(this.listenTo(this.viewModel,["change:Layers.Video","change:Layers.Simple","change:Layers.Hosted","change:Layers.Raster","change:Layers.DataSource.File","change:Layers.DataSource.FileId","change:Layers.DataSource.Id","change:Layers.DataSource.Name","change:Layers.DataSource.DataValue","change:Layers.DataSource.ShowZero","change:Layers.DataSource.UseMinMax","change:Layers.DataSource.MaxRange","change:Layers.DataSource.MinRange","change:Layers.DataSource.Palette"].join(" "),_.bind(this.layers.addLayers,this.layers)),this.listenTo(this.viewModel,"change:Layers.DataSource.DataSource",_.bind(this.layers.renderLayers,this.layers)),this.listenTo(this.viewModel,"change:Layers.DataSource.PaletteTheme",_.bind(this.updatePalette,this,"Layers.DataSource","Palette","type"))),this.clusterLayer&&(this.listenTo(this.viewModel,"change:Points",function(e){r.onViewModelChanged(r.flattenObj(e.changed,void 0))}),this.clusterLayer.addSource(),this.listenersActive=!0),this.circleLayer&&_.each(this.api.getProperty("Circles"),function(e,t){r.listenTo(r.viewModel,"change:Circles",function(e){r.onViewModelChanged(r.flattenObj(e.changed,void 0))}),r.circleLayer.addSource(t),r.listenersActive=!0}),this.animatedCircleLayer&&(this.listenTo(this.viewModel,"change:AnimatedCircles.DataSource",_.bind(this.animatedCircleLayer.onAnimatedCirclesChange,this.animatedCircleLayer)),this.listenTo(this.viewModel,["change:AnimatedCircles.Cluster","change:AnimatedCircles.Latitude","change:AnimatedCircles.Longitude","change:AnimatedCircles.Radius","change:AnimatedCircles.Color","change:AnimatedCircles.UseLabel","change:AnimatedCircles.Label","change:AnimatedCircles.LabelSize"].join(" "),_.bind(this.animatedCircleLayer.renderAnimatedCircles,this.animatedCircleLayer)),this.animatedCircleLayer.addSource(),this.listenersActive=!0),this.concentricCircleLayer&&(this.listenTo(this.viewModel,"change:ConcentricCircles.DataSource",_.bind(this.concentricCircleLayer.onConcentricCirclesChange,this.concentricCircleLayer)),this.listenTo(this.viewModel,["change:ConcentricCircles.Id","change:ConcentricCircles.Name","change:ConcentricCircles.Latitude","change:ConcentricCircles.Longitude","change:ConcentricCircles.Radius","change:ConcentricCircles.Colors","change:ConcentricCircles.BorderWidth","change:ConcentricCircles.FilterPoints"].join(" "),_.bind(this.concentricCircleLayer.renderConcentricCircles,this.concentricCircleLayer)),this.concentricCircleLayer.addSource(),this.listenersActive=!0),this.lineLayer&&(this.listenTo(this.viewModel,"change:Lines",function(e){r.onViewModelChanged(r.flattenObj(e.changed,void 0))}),this.lineLayer.addSource(),this.listenersActive=!0),this.map&&(this.listenTo(this.viewModel,["change:Style.colors.lineColor","change:Style.colors.innerLineColor","change:Style.colors.pink","change:Style.colors.purple","change:Style.colors.blue","change:Style.colors.torquoise","change:Style.colors.green","change:Style.colors.yellow","change:Style.colors.orange","change:Style.colors.red","change:Style.colors.white","change:Style.colors.background"].join(" "),_.bind(this.updateStyle,this)),this.listenTo(this.viewModel,["change:Style.extrusion.extrude","change:Style.extrusion.source","change:Style.extrusion.sourceLayer","change:Style.extrusion.minZoom","change:Style.extrusion.fillColor","change:Style.extrusion.fillOpacity"].join(" "),_.bind(this.set3DModel,this)),this.listenTo(this.viewModel,["change:Interactions.scrollZoom","change:Interactions.boxZoom","change:Interactions.dragRotate","change:Interactions.dragPan","change:Interactions.keyboard","change:Interactions.doubleClickZoom","change:Interactions.touchZoomRotate"].join(" "),_.bind(this.interactions,this)),this.listenTo(this.viewModel,"change:ExternalAPI.Style",_.bind(this.setExternalAPIStyle,this)),this.listenTo(this.viewModel,"change:MapDetails.UrlStyle",_.bind(this.changeStyle,this)),this.listenTo(this.viewModel,"change:MapDetails.LayerSelect",_.bind(this.annotationMenu,this)),this.listenTo(this.viewModel,"change:TileServer.ApiUrl, change:Basics.LoadTime, change:Basics.TrackLoadTime, change:MapDetails.Projection",_.bind(this.determineMapStyle,this)),this.listenTo(this.viewModel,"change:MapDetails.RenderWorldCopies",function(){r.setRenderWorldCopies(),r.map.redraw()}),this.heatmapLayer&&(e=["change:Heatmap.ID","change:Heatmap.Name","change:Heatmap.Latitude","change:Heatmap.Longitude","change:Heatmap.Tooltip","change:Heatmap.Weight","change:Heatmap.Actions","change:Heatmap.Colors","change:Heatmap.ShowGradient","change:Heatmap.ShowBaseCircles"],this.listenTo(this.viewModel,"change:Heatmap.DataSource",_.bind(this.heatmapLayer.onHeatmapsChange,this.heatmapLayer)),this.listenTo(this.viewModel,e.join(" "),_.bind(this.heatmapLayer.renderHeatmaps,this.heatmapLayer)),this.listenTo(this.viewModel,"change:Heatmap.PaletteTheme",_.bind(this.updatePalette,this,"Heatmap","Colors","color")),this.heatmapLayer.addSource()),this.heatmapGridLayer&&(e=["change:HeatmapGrid.ID","change:HeatmapGrid.Name","change:HeatmapGrid.Latitude","change:HeatmapGrid.Longitude","change:HeatmapGrid.Tooltip","change:HeatmapGrid.GridSize","change:HeatmapGrid.Actions","change:HeatmapGrid.Colors","change:HeatmapGrid.ShowGradient","change:HeatmapGrid.ShowZero","change:HeatmapGrid.Min","change:HeatmapGrid.Max","change:HeatmapGrid.Shape"],this.listenTo(this.viewModel,"change:HeatmapGrid.DataSource",_.bind(this.heatmapGridLayer.onHeatmapsChange,this.heatmapGridLayer)),this.listenTo(this.viewModel,e.join(" "),_.bind(this.heatmapGridLayer.renderHeatmaps,this.heatmapGridLayer)),this.listenTo(this.viewModel,"change:HeatmapGrid.PaletteTheme",_.bind(this.updatePalette,this,"HeatmapGrid","Colors","color")),this.heatmapGridLayer.addSource()),this.map&&this.listenTo(this.viewModel,"change:NightDayLayer.Show, change:NightDayLayer.Current",_.bind(this.renderNightDayLayer,this)),this.listenTo(this.viewModel,"change:Annotation.Selected",function(){r.api.getProperty("Annotation.Selected")!==JSON.stringify(r.currentAnnotatedState)&&r.renderAnnotationFromViewstate()}))},H.prototype.removeOldAnnotatedViewstateLayer=function(){this.clusterLayer&&this.clusterLayer.resetPoints(),this.circleLayer&&this.circleLayer.resetCircles()},H.prototype.renderAnnotationFromViewstate=function(){var e=this.tryParseJSONObject(this.api.getProperty("Annotation.Selected"));this.removeOldAnnotatedViewstateLayer(),this.draw.deleteAll(),e?(this.filterAnnotatedData(e),this.draw.add(e)):this.currentAnnotatedState=null},H.prototype.updateStyle=function(){this.map&&this.map.setStyle(this.getStyle())},H.prototype.setRenderWorldCopies=function(){this.map.setRenderWorldCopies(this.api.getProperty("MapDetails.RenderWorldCopies"))},H.prototype.changeStyle=function(){this.updateStyle(),this.initializeLayers(),this.interactions(),this.renderNightDayLayer(),this.setMapBounds(),this.initializeListeners()},H.prototype.getStyle=function(){var e,t,r=this.api.getProperty("MapDetails.Style"),i=this.api.getProperty("MapDetails.UrlStyle"),o=this.api.getProperty("MapDetails.Offline"),i=i||"https://demotiles.maplibre.org/style.json";return o?(e="".concat(location.origin).concat(location.pathname.replace("/edit",""),"/modules/").concat(this.path,"/css/assets/"),t={lineColor:this.api.getProperty("Style.colors.lineColor"),innerLineColor:this.api.getProperty("Style.colors.innerLineColor"),pink:this.api.getProperty("Style.colors.pink"),purple:this.api.getProperty("Style.colors.purple"),blue:this.api.getProperty("Style.colors.blue"),turquoise:this.api.getProperty("Style.colors.torquoise"),green:this.api.getProperty("Style.colors.green"),yellow:this.api.getProperty("Style.colors.yellow"),orange:this.api.getProperty("Style.colors.orange"),red:this.api.getProperty("Style.colors.red"),white:this.api.getProperty("Style.colors.white"),background:this.api.getProperty("Style.colors.background")},r||{version:8,sources:{countries:{type:"vector",tiles:["".concat(e,"countries/{z}/{x}/{y}.pbf")],maxzoom:6}},glyphs:"".concat(e,"font/{fontstack}/{range}.pbf"),layers:l(l([this.createBackgroundLayer(t.background),this.createGlowLayer("country-glow-outer","countries",t.lineColor,5,.1),this.createGlowLayer("country-glow-inner","countries",t.lineColor,{stops:[[0,1.2],[1,1.6],[2,2],[3,2.4]]},.8)],this.createAreaLayers(t),!0),[this.createLineLayer("geo-lines","countries","geo-lines",t.lineColor,[6,2]),this.createLineLayer("land-border-country","countries","land-border-country",t.innerLineColor,void 0,1.5),this.createStateLayer(t.lineColor),this.createSymbolLayer("country-abbrev","countries","country-name","{ABBREV}",o,t.lineColor),this.createSymbolLayer("country-name","countries","country-name","{NAME}",o,t.lineColor),this.createSymbolLayer("geo-lines-lables","countries","geo-lines","{DISPLAY}",o,t.lineColor,!0)],!1)}):r||i},H.prototype.createBackgroundLayer=function(e){return{id:"background",type:"background",paint:{"background-color":e}}},H.prototype.createGlowLayer=function(e,t,r,i,o){return{id:e,type:"line",source:t,"source-layer":"country",layout:{"line-join":"round"},paint:{"line-color":r,"line-width":i,"line-opacity":{stops:[[0,0],[1,o]]}}}},H.prototype.createAreaLayers=function(e){return[{id:"area-white",filter:B.COUNTRY_CODES9,color:e.white},{id:"area-red",filter:B.COUNTRY_CODES1,color:e.red},{id:"area-orange",filter:B.COUNTRY_CODES2,color:e.orange},{id:"area-yellow",filter:B.COUNTRY_CODES3,color:e.yellow},{id:"area-green",filter:B.COUNTRY_CODES4,color:e.green},{id:"area-turquoise",filter:B.COUNTRY_CODES5,color:e.turquoise},{id:"area-blue",filter:B.COUNTRY_CODES6,color:e.blue},{id:"area-purple",filter:B.COUNTRY_CODES7,color:e.purple},{id:"area-pink",filter:B.COUNTRY_CODES8,color:e.pink}].map(function(e){return{id:e.id,type:"fill",source:"countries",filter:e.filter,"source-layer":"country",paint:{"fill-color":e.color}}})},H.prototype.createLineLayer=function(e,t,r,i,o,a){return{id:e,type:"line",source:t,"source-layer":r,paint:u({"line-color":i,"line-width":a||{base:1.5,stops:[[0,0],[1,.8],[2,1]]}},o&&{"line-dasharray":o})}},H.prototype.createStateLayer=function(e){return{id:"state",type:"line",source:"countries","source-layer":"state",minzoom:3,filter:B.COUNTRY_STATES1,paint:{"line-color":e,"line-opacity":.25,"line-dasharray":[6,2,2,2],"line-width":1.2}}},H.prototype.createSymbolLayer=function(e,t,r,i,o,a,n){return{id:e,type:"symbol",source:t,"source-layer":r,minzoom:1.8,maxzoom:3,layout:u({"text-field":i,"text-font":o?["OpenSansBold"]:["Open Sans Semibold"],"text-transform":"uppercase","text-max-width":20,"text-size":{stops:[[3,10],[4,11],[5,12],[6,16]]}},(n=void 0===n?!1:n)&&{"symbol-placement":"line","symbol-spacing":600}),paint:{"text-halo-color":"#fff","text-halo-width":1.5}}},H.getComponentDefinition=K.getComponentDefinition,H.APP_THEME="DashboardTheme",H});
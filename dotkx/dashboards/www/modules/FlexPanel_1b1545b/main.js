define(["backbone","Handlebars","QuickBase","css!./css/main.css"],function(i,e,o){"use strict";var n,t=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}))(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),s=(a.getComponentDefinition=function(e){if(0<_.keys(e.settingsModel.attributes).length)for(var t=_.find(a.upgrades,{version:e.settingsModel.get("version")}),i=void 0===t?1:a.upgrades.indexOf(t)+1;i<a.upgrades.length;i+=1){var o=a.upgrades[i];o.fn(e.settingsModel),e.settingsModel.set("version",o.version)}return{id:1011,componentName:"Flex Panel",componentDescription:"group two components together with a panel",appKey:"FlexPanel",disable_array_reorder:!0,appArgs:{json:{version:"4.7.7",Basics:{Name:"",layout:"horizontaltop",maxSize:0,minSize:250},Style:{advanced:""}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",options:{disable_array_reorder:!0},properties:{Name:{type:"string",title:"Name",default:""},layout:{type:"string",title:"Orientation",enum:["horizontaltop","verticalleft","verticalright","horizontalbottom"],options:{enum_titles:["Horizontal Top","Vertical Left","Vertical Right","Horizontal Bottom"]},default:"horizontaltop"},minSize:{type:"number",title:"Min Size"},maxSize:{type:"number",title:"Max Size"}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}}},a.upgrades=[{version:0,fn:function(e){}},{version:"4.7.7",fn:function(e){e.get("Basics.Name")||e.set("Basics.Name","")}}],a);function a(){}d.app=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="worksheet">\n    <div class="grid-stack">\n        <div class=\'advanced-item two placeholder\'></div>\n    </div>\n    <div class="no-widgets-info">\n        <div class="loading">'+e.escapeExpression((s(i,"t")||t&&s(t,"t")||e.hooks.helperMissing).call(null!=t?t:e.nullContext||{},"start dragging widgets from the panel on your left",{name:"t",hash:{},data:n,loc:{start:{line:6,column:29},end:{line:6,column:87}}}))+'</div>\n\n        <div class="dragComponentsHelp">\n            <i class="fa fa-chevron-right"></i>\n            <i class="fa fa-chevron-right"></i>\n            <i class="fa fa-chevron-right"></i>\n        </div>\n    </div>\n</div>\n<div class="visual-indicator"></div>'},useData:!0});var r,l=d;function d(){}function h(e){e=r.call(this,e)||this;return e.api=null,e.isGridstack=!1,e.selected=null,e.hasInitPost=!1,e.removing=!1,e}return r=o.ComponentDropView,t(h,r),h.prototype.initialize=function(e){this.panelId=_.uniqueId("flexpanel"),this.api=e.api,this.componentModel=e.componentModel,this.dashboardAppModel=e.dashboardAppModel,this.dashboardViewModel=e.dashboardViewModel,this.quickView=e.quickView,this.websiteUrl=e.websiteUrl,this.basePanel=e.basePanel,this.webGLContextAndCanvas=e.webGLContextAndCanvas,this.webGLContextAndCanvas&&this.webGLContextAndCanvas.elements&&(this.webGLContextAndCanvas.elements=this.webGLContextAndCanvas.elements.concat(this.el)),this.events=null,this.model||(this.model=this.componentModel),this.viewModel=new i.DeepModel,this.widgets=[],this.postRender()},h.prototype.initializeEvents=function(){var t=this;this.$worksheet&&(this.$worksheet.on("dragover",this.getSafeDragNDropHandler(this.onWorksheetDragOver)),this.$worksheet.on("dragleave",this.getSafeDragNDropHandler(this.onWorksheetDragLeave)),this.$worksheet.on("drop",this.getSafeDragNDropHandler(this.onWorksheetDrop))),this.listenTo(this.viewModel,"change:Basics.layout",this.onLayoutChanged),this.listenTo(this.viewModel,"change:Basics.maxSize",this.onSizeLimitChanged),this.listenTo(this.viewModel,"change:Basics.minSize",this.onSizeLimitChanged),this.listenTo(this.dashboardViewModel,"change:selectedWidget",this.onSelectedWidgetChanged),this.listenTo(this.dashboardViewModel,"change:buildMode",function(){return t.switchBuildMode(t.dashboardViewModel.get("buildMode"))}),this.listenTo(this.dashboardAppModel,"change:pendingSelectionWidgetId",this.onSelectingWidget),this.initializeEvents_widgetCollection(),this.el.getElementsByClassName("worksheet")[0].addEventListener("scroll",function(e){return t.onScroll(e)})},h.prototype.initializePost=function(){this.hasInitPost||(this.hasInitPost=!0,this.horizontalStyles=document.createElement("style"),this.horizontalStyles.type="text/css",document.head.appendChild(this.horizontalStyles),this.verticalStyles=document.createElement("style"),this.verticalStyles.type="text/css",document.head.appendChild(this.verticalStyles),this.widgetsCollection=this.model.get("widgets"),this.initializeEvents(),this.clearPanel(this.applyCurrentPanel.bind(this)),this.switchBuildMode(this.dashboardViewModel.get("buildMode")),this.onLayoutChanged(),this.onSizeLimitChanged())},h.prototype.addWidget=function(e,t,i){return this.noWidgetsInfo&&(this.noWidgetsInfo.style.display="none"),this.visualIndicator&&(this.visualIndicator.style.display="none"),o.ComponentDropView.prototype.addWidget.apply(this,[e,t,i,this.basePanel,this.webGLContextAndCanvas])},h.prototype.addWidgetEvents=function(e){var t,i=this;if(!(e instanceof $))throw"Wrong parameter.";_.each(e,function(e){(t=$(e)).on("click",$.proxy(i.onWidgetClick,i)),t.on("dragenter",i.getSafeDragNDropHandler(i.onComponentDragEnter)),t.on("dragleave",i.getSafeDragNDropHandler(i.onComponentDragLeave)),t.on("dragover",i.getSafeDragNDropHandler(i.onComponentDragOver)),t.on("drop",i.getSafeDragNDropHandler(i.onComponentDrop))})},h.prototype.applyCurrentPanel=function(){var t=this;this.isGridstack=!1,this.widgetsCollection.each(function(e){t.addWidget(e,!0,null)})},h.prototype.clearPanel=function(e){this.clearWidgets(function(){e&&e()})},h.prototype.clearWidgets=function(e){_.includes(this.model.get("widgets").map("id"),this.dashboardViewModel.get("selectedWidgetId"))&&this.deselectCurrentWidget(),0<this.widgets.length&&(_.each(this.widgets,function(e){e.view&&_.isFunction(e.view.remove)&&e.view.remove()}),this.widgets=[],this.$gridstack.children().remove()),e&&e()},h.prototype.getWidgetClass=function(e){var t="one";return 1===this.widgets.length&&(t="two",0===e)&&(this.widgets[0].$widget.removeClass(t="one"),this.widgets[0].$widget.addClass("two")),"ui-widget "+t},h.prototype.onComponentDragOver=function(e){if(!_.includes(e.originalEvent.dataTransfer.types,"Files"))return $(e.currentTarget).toggleClass("highlight",!0),!1},h.prototype.onComponentDragEnter=function(e){var t;if(!_.includes(e.originalEvent.dataTransfer.types,"Files"))return t=e.currentTarget.getAttribute("data-widgetid"),this.model.get("widgets").get(t).get("component")||$(e.currentTarget).toggleClass("highlight",!0),!1},h.prototype.onComponentDragLeave=function(e){return $(e.currentTarget).toggleClass("highlight",!1),!1},h.prototype.onComponentDrop=function(e){var t;return this.onComponentDragLeave(e),void 0!==e.originalEvent.dataTransfer&&(t=e.originalEvent.dataTransfer.getData("text"),this.dashboardAppModel.get("components").get(t))&&(e=$(e.currentTarget).attr("data-widgetid"),e=this.findWidgetItem(e),this.dashboardViewModel.set("selectedWidget",null),e?this.addComponentToWidget(e.model,t,!0):this.addNewWidget(null,t,!1)),!1},h.prototype.onComponentDropWrap=function(e){var t=e.originalEvent.dataTransfer.getData("text");return e.preventDefault&&(e.preventDefault(),e.stopPropagation()),this.dashboardAppModel&&this.dashboardAppModel.get("components").has(t)&&this.addNewWidget(null,t,!1),!1},h.prototype.onLayoutChanged=function(){this.visualIndicator.classList.remove("horizontaltop"),this.visualIndicator.classList.remove("verticalleft"),this.visualIndicator.classList.remove("verticalright"),this.visualIndicator.classList.remove("horizontalbottom"),this.el.classList.remove("horizontaltop"),this.el.classList.remove("verticalleft"),this.el.classList.remove("verticalright"),this.el.classList.remove("horizontalbottom"),this.visualIndicator.classList.add(this.viewModel.get("Basics.layout")),this.el.classList.add(this.viewModel.get("Basics.layout"))},h.prototype.onResize=function(){this.onResizeWidgets()},h.prototype.onResizeWidgets=function(){_.each(this.widgets,function(e){e.view&&(_.isFunction(e.view.onResize)&&e.view.onResize(!0),_.isFunction(e.view.onResizeStop))&&e.view.onResizeStop(!0)})},h.prototype.onScroll=function(e){this.webGLContextAndCanvas&&this.onResize(),this.onWidgetsScroll()},h.prototype.onWidgetsScroll=function(){_.each(this.widgets,function(e){e.view&&_.isFunction(e.view.onScroll)&&e.view.onScroll()})},h.prototype.onSelectingWidget=function(e,t){e&&(this.onWidgetClick(null,t),this.dashboardAppModel.set("pendingSelectionWidgetId",null,{silent:!0}))},h.prototype.onSelectedWidgetChanged=function(e,t){e=e.get("selectedWidgetId");this.$el.find(".advanced-item.selected").toggleClass("selected",!1),e&&this.$el.find(".advanced-item[data-widgetid='"+e+"']").toggleClass("selected",!0)},h.prototype.onSettingsChange=function(e){var i=this;_.each(e,function(e,t){i.viewModel.set(t,e)}),this.initializePost(),this.webGLContextAndCanvas&&this.onResize()},h.prototype.onSizeLimitChanged=function(){var e="#"+this.panelId+".flex-panel",t=">.worksheet>.grid-stack>.advanced-item.one>.grid-stack-item-content>.component-build-view>.border-div>.app-div",i=this.viewModel.get("Basics.minSize"),o=this.viewModel.get("Basics.maxSize"),n=e+".horizontaltop"+t+","+e+".horizontalbottom"+t+"{",e=e+".verticalleft"+t+","+e+".verticalright"+t+"{";i&&(n+="min-height: "+i+"px;",e+="min-width: "+i+"px;"),o&&(n+="max-height: "+o+"px;",e+="max-width: "+o+"px;"),e+="height: 100%;}",this.horizontalStyles.innerHTML=n+="width: 100%;}",this.verticalStyles.innerHTML=e,this.onResize()},h.prototype.onWidgetCollectionAdd=function(e,t,i){i=i&&i.at;this.addWidget(e,!1,i)},h.prototype.onWorksheetDragLeave=function(e){return!(this.placeholder.style.display="none")},h.prototype.onWorksheetDragOver=function(e){return!(this.placeholder.style.display="block")},h.prototype.onWorksheetDrop=function(e){return this.placeholder.style.display="none",this.deselectCurrentWidget(),this.widgets.length<2&&this.onComponentDropWrap(e),!1},h.prototype.pasteWidget=function(e){2===this.widgets.length&&this.removeWidget(this.widgets[1]),e.setParent(this.widgetsCollection);this.addNewWidget(e,e.get("component").get("definitionId"),!0)},h.prototype.remove=function(){var e,t=this;this.removing||(this.removing=!0,this.horizontalStyles&&(this.horizontalStyles.remove(),this.horizontalStyles=null),this.verticalStyles&&(this.verticalStyles.remove(),this.verticalStyles=null),null!=(e=this.webGLContextAndCanvas)&&e.elements&&-1<(e=this.webGLContextAndCanvas.elements.indexOf(this.el))&&this.webGLContextAndCanvas.elements.splice(e,1),this.stopListening(),this.$worksheet&&this.$worksheet.off(),this.clearPanel(function(){t.removeCallbacks=[],t.$el.remove(),t.removing=!1})),i.View.prototype.remove.apply(this)},h.prototype.removeWidget=function(e){e=this.findWidgetItem(e.id);e&&(this.widgets=_.without(this.widgets,e),this.widgets.length<=0?(this.noWidgetsInfo.style.display="block",this.visualIndicator.style.display="block"):1===this.widgets.length&&this.widgets[0].$widget.hasClass("two")&&(this.widgets[0].$widget.toggleClass("two",!1),this.widgets[0].$widget.toggleClass("one",!0)),this.quickView||this.model.get("widgets").remove(e.model),e.$widget.css({border:"none",background:"none","box-shadow":"none","pointer-events":"none"}),e.view&&e.view.remove&&e.view.remove(),e.$widget.off(),e.$widget.remove())},h.prototype.postRender=function(){return this.el.classList.add("flex-panel"),this.el.setAttribute("id",this.panelId),this.el.innerHTML=l.app({}),this.$worksheet=this.$el.find("> .worksheet"),this.worksheet=this.el.querySelector(".worksheet"),this.gridstack=this.worksheet.querySelector(".grid-stack"),this.$gridstack=this.$worksheet.find("> .grid-stack"),this.noWidgetsInfo=this.worksheet.querySelector(".no-widgets-info"),this.visualIndicator=this.el.querySelector(".visual-indicator"),this.placeholder=this.gridstack.querySelector(".placeholder"),this},h.prototype.renderComponent=function(e,t,i,o){t=this.createComponentView(e,t,i,o),i=$("<div/>",{class:"grid-stack-item-content"}).append(t.$el);e.$widget.append(i)},h.prototype.renderWidget=function(){var e=$('<div class="advanced-item"><div class="drop-show"></div></div>');return this.$gridstack&&this.$gridstack.append(e),e},h.prototype.setTheme=function(t){_.each(this.widgets,function(e){e.view.app&&e.view.app.setTheme&&e.view.app.setTheme(t)})},h.prototype.switchOffBuildMode=function(e){o.ComponentDropView.prototype.switchOffBuildMode.apply(this,[e]),this.$gridstack&&this.$gridstack.find("> div").addClass("build-off")},h.prototype.switchOnBuildMode=function(e){o.ComponentDropView.prototype.switchOnBuildMode.apply(this,[e]),this.$gridstack&&this.$gridstack.find("> div").removeClass("build-off")},h.prototype.updateWebGLContext=function(i,o,e){var n=e.concat(this.el),s=(this.webGLContextAndCanvas=i&&o?{gl:i,canvas:o,elements:n}:void 0,["Panel","FlexPanel","Accordion","Tabs","OverlayPanel"]);this.widgets.forEach(function(e){var t=e.view.key;"ChartGL"!==t&&-1===s.indexOf(t)||null!=(t=e.view.app)&&t.updateWebGLContext(i,o,n)})},h.getComponentDefinition=s.getComponentDefinition,h});
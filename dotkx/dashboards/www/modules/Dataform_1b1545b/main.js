define(["backbone","Handlebars","Forms","QuickBase","css!./css/app.css"],function(h,e,u,g){var s={SAMPLE_DATA:"",dataItemTransform:function(a,e,t,s){var o,l;"Number"===a._Type?s(a):"Data"===t&&"Datepicker"!==a._Type&&"Slider"!==a._Type?(t=a.Data,o=a.DataSourceMapping.Value instanceof h.Model,l=a.DataSourceMapping.Text instanceof h.Model,t?t.getMeta(function(e){var e=_.fromPairs(_.map(e.columns.collection.models,function(e){return[e.get("id"),e.toJSON()]})),t=_.keys(e),e=_.find(e,function(e){return 0===e.kdbType||11===e.kdbType}),i=a.DataSourceMapping.DropdownPossibleValues;i&&!_.isEqual(i.sort(),t.sort())&&(a.DataSourceMapping.DropdownPossibleValues=t,a.DropdownPossibleValues=t,o||(a.DataSourceMapping.Value=t[0]||""),l||(a.DataSourceMapping.Text=e&&e.id||t[0]||"")),s(a)}):(a.DataSourceMapping.DropdownPossibleValues=[],a.DropdownPossibleValues=[],o||(a.DataSourceMapping.Value=""),l||(a.DataSourceMapping.Text=""),s(a))):s()},getComponentDefinition:function(e){var t,i,a={id:27,componentName:"Dataform",componentDescription:"See results from your data queries.",appKey:"Dataform",css:"Dataform",listViewThumb:e.websiteUrl+"Images/dataform.png",ghostViewThumb:null,buildViewThumb:null,appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"c2.4.0",isDataform:!0,Basics:{Name:"",Data:"",SubmitButtonText:"Submit",ValidationAnalytic:"",ExpandDictParameters:!0,ForceExecute:!1,ShowReset:!1,ShowSubmit:!0,FloatSubmit:!0,FloatReset:!1,ViewStates:[],Actions:[]},Style:{minWidth:"",advanced:"",display:"Row",inline:"Top",labelWidth:"",labelPadding:"",labelAlign:"Left",padding:"",verticalSpacing:"",submitOffset:"",resetOffset:"",formMargin:""}},schema:{type:"object",title:"Properties",properties:{isDataform:{type:"boolean",default:!0,options:{hidden:!0}},Basics:{type:"object",title:"Basics",options:{collapsed:!1},properties:{Name:{title:"Name",tooltip:g.ComponentPropertyTooltip.getTooltip("Name"),type:"string",default:"",propertyOrder:1},Data:{type:"data",title:"Data Source",default:"",propertyOrder:1},ValidationAnalytic:{type:"data",title:"Validation Analytic",default:"",propertyOrder:2},SubmitButtonText:{type:"string",title:"Submit Button Text",default:"Submit",propertyOrder:3},ExpandDictParameters:{type:"boolean",title:"Expand Dict Parameters",format:"checkbox",default:!0,propertyOrder:4},ForceExecute:{type:"boolean",title:"Force Execute on Submit",format:"checkbox",default:!1,propertyOrder:5},ShowReset:{type:"boolean",title:"Show Reset",format:"checkbox",default:!1,propertyOrder:6},FloatReset:{type:"boolean",title:"Float Reset",format:"checkbox",default:!1,propertyOrder:7},ShowSubmit:{type:"boolean",title:"Show Submit",format:"checkbox",default:!0,propertyOrder:8},FloatSubmit:{type:"boolean",title:"Float Submit",format:"checkbox",default:!0,propertyOrder:9},ViewStates:{title:"ViewState Parameters",type:"array",format:"object",options:{disable_array_add:!0,disable_array_delete:!0,no_additional_properties:!0,disable_collapse:!0},items:{id:"arr_item",title:"ViewState",headerTemplate:"{{#if self.DisplayName.path}}{{ self.DisplayName.path }}{{else if self.DisplayName}}{{ self.DisplayName }}{{else}}ViewState {{i1}}{{/if}}",type:"object",options:{hidden:!1,collapsed:!0,keep_oneof_values:!1},properties:{PathEnc:{type:"string",options:{hidden:!0}},DisplayName:{type:"string",title:"Display Name",propertyOrder:1},HideParameter:{type:"boolean",title:"Hide Parameter",default:!1,format:"checkbox",propertyOrder:2},Tooltip:{type:"string",default:"",propertyOrder:3},AllowNulls:{type:"boolean",default:!0,title:"Allow Nulls",propertyOrder:4},FieldType:{id:"FieldType",title:"Parameter Type",type:"object",options:{disable_collapse:!0,keep_oneof_values:!1},propertyOrder:5,_transform:s.dataItemTransform,oneOf:[{id:"Text",title:"Default",type:"object",options:{hidden:!0,collapsed:!0,linked_oneof_property:{property:"_Type",value:"Default"}},properties:{_Type:{type:"string",default:"Default",options:{hidden:!0}},Data:{type:"string",hidden:!0},DataSourceMapping:{type:"object",hidden:!0},Items:{type:"array",hidden:!0},DropdownPossibleValues:{type:"array",hidden:!0}}},{id:"Dropdown",title:"Dropdown",type:"object",options:{hidden:!1,collapsed:!1,linked_oneof_property:{property:"_Type",value:"Dropdown"}},properties:{_Type:{type:"string",default:"Dropdown",options:{hidden:!0}},DropdownPossibleValues:{type:"array",items:{type:"string"},default:[],options:{hidden:!0}},Data:{type:"data",title:"Data Source",default:"",propertyOrder:1},AcceptEmptyValues:{type:"boolean",title:"Accept Empty Values",tooltip:g.ComponentPropertyTooltip.getTooltip("AcceptEmptyValues")+g.ComponentPropertyTooltip.getTooltip("AcceptEmptyValuesNote"),default:!1,format:"checkbox",propertyOrder:3},ForceSelect:{type:"boolean",title:"Force Selected Value",default:!1,format:"checkbox",propertyOrder:4},MultiSelect:{type:"boolean",title:"Multi-select",default:!1,format:"checkbox",propertyOrder:5},ShowSearch:{type:"boolean",title:"Show Search",tooltip:g.ComponentPropertyTooltip.getTooltip("ShowSearch"),default:!1,format:"checkbox",propertyOrder:6},AdvancedSearch:{type:"boolean",title:"Advanced Search",tooltip:g.ComponentPropertyTooltip.getTooltip("AdvancedSearch"),default:!1,format:"checkbox",propertyOrder:7},FieldSummaryThreshold:{title:"Field Summary Threshold",tooltip:g.ComponentPropertyTooltip.getTooltip("FieldSummaryThreshold"),type:"number",default:5,propertyOrder:8},TooltipSummaryThreshold:{title:"Tooltip Summary Threshold",type:"number",default:5,propertyOrder:9},SelectAllValue:{title:"'Select All' Value",type:"string",propertyOrder:10},SelectAllDefault:{title:"'Select All' Reset to Default",type:"boolean",default:!1,propertyOrder:11},SortListBySelected:{type:"boolean",title:"Sort List by Selected",default:!1,format:"checkbox",propertyOrder:12},UseCustom:{type:"boolean",title:"Use Custom",default:!1,format:"checkbox",propertyOrder:13},DataSourceMapping:{type:"object",title:"Data Source Mapping",properties:{Value:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.FieldType.DropdownPossibleValues"}},Text:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.FieldType.DropdownPossibleValues"}},DropdownPossibleValues:{type:"array",items:{type:"string"},default:[],options:{hidden:!0}}}},Custom:{type:"object",title:"Custom",options:{collapsed:!1},properties:{Icon:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.FieldType.DropdownPossibleValues"}},IconColor:{type:"string",enumSource:"possible_values",title:"Icon Color",default:"",watch:{possible_values:"arr_item.FieldType.DropdownPossibleValues"}}}},Items:{type:"array",format:"table",title:"Items",uniqueItems:!0,options:{collapsed:!1},items:{type:"object",properties:{Value:{type:"string"},Text:{type:"string"}}}}}},{id:"Password",title:"Password",type:"object",options:{hidden:!0,collapsed:!0,linked_oneof_property:{property:"_Type",value:"Password"}},properties:{_Type:{type:"string",default:"Password",options:{hidden:!0}}}},{id:"Number",title:"Number",type:"object",options:{hidden:!0,collapsed:!0,linked_oneof_property:{property:"_Type",value:"Number"}},properties:{_Type:{type:"string",default:"Number",options:{hidden:!0}},Increment:{type:"number",title:"Increment",default:1,propertyOrder:1},UseDecimalPlaces:{type:"boolean",title:"Set Decimal Places",default:!1,format:"checkbox",propertyOrder:2},DecimalPlaces:{type:"number",title:"Decimal Places",default:2,propertyOrder:3,min:0,max:10}}},{id:"Datepicker",title:"Datepicker",type:"object",options:{hidden:!1,collapsed:!1,linked_oneof_property:{property:"_Type",value:"Datepicker"}},properties:{_Type:{type:"string",default:"Datepicker",options:{hidden:!0}},Data:{type:"data",title:"Data Source",default:"",propertyOrder:1},ReadOnly:{type:"boolean",title:"ReadOnly",default:!1,format:"checkbox",propertyOrder:2}}},{id:"Slider",title:"Slider",type:"object",options:{hidden:!1,collapsed:!1,linked_oneof_property:{property:"_Type",value:"Slider"}},properties:{_Type:{type:"string",default:"Slider",options:{hidden:!0}},Data:{type:"data",title:"Data Source",default:"",propertyOrder:1},Range:{type:"boolean",title:"Range",default:!1,format:"checkbox",propertyOrder:2},Tooltip:{type:"boolean",title:"Tooltip",default:!1,format:"checkbox",propertyOrder:4},ShowTicks:{type:"boolean",title:"Show Ticks",default:!1,format:"checkbox",propertyOrder:3},Formatter:{type:"tooltipTemplate",title:"Tooltip Formatter",default:"",propertyOrder:5,options:{showMenuLayout:!0}}}}]}}}},Actions:{type:"actions"}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:"",propertyOrder:1},display:{type:"string",title:"Display",enum:["Row","Column"],default:"Row",propertyOrder:2},minWidth:{type:"string",title:"Field Width",default:"",propertyOrder:3},padding:{type:"string",title:"Field Padding",default:"",propertyOrder:4},formMargin:{type:"string",title:"Form Margin",default:"",propertyOrder:5},labelAlign:{type:"string",title:"Label Alignment",enum:["Left","Right"],default:"Left",propertyOrder:6},labelPadding:{type:"string",title:"Label Padding",default:"",propertyOrder:7},inline:{type:"string",title:"Label Positions",enum:["Top","Left"],default:"Top",propertyOrder:8},labelWidth:{type:"string",title:"Label Widths",default:"",propertyOrder:9},resetOffset:{type:"string",title:"Reset Margin",default:"",propertyOrder:11},submitOffset:{type:"string",title:"Submit Margin",default:"",propertyOrder:13},verticalSpacing:{type:"string",title:"Vertical Spacing",default:"",propertyOrder:14}}}}}}};if(e.settingsModel&&0<_.keys(e.settingsModel.attributes).length)for(i=s.upgrades.indexOf(_.find(s.upgrades,{version:e.settingsModel.get("version")}))+1;i<s.upgrades.length;i+=1)(t=s.upgrades[i]).fn(e.settingsModel),e.settingsModel.set("version",t.version);return e.dataModel.getByPath(s.SAMPLE_DATA)&&(a.appArgs.json.Basics.Data=s.SAMPLE_DATA),a},upgrades:[{version:"4.0.0",fn:function(e){_.isUndefined(e.get("Basics.SubmitButtonText"))&&e.set("Basics.SubmitButtonText","Submit")}},{version:"4.4.0",fn:function(e){_.isUndefined(e.get("Basics.SubmitButtonText"))&&e.set("Basics.SubmitButtonText","Submit")}},{version:"4.0.0s1",fn:function(e){_.each(e.get("Basics.ViewStates"),function(e){e.Tooltip=""})}},{version:"4.0.2d1",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType&&e.FieldType.isDropdown&&!e.FieldType.isDefaultInput&&void 0!==e.FieldType.MultiSelect&&i.set("Basics.ViewStates."+t+".FieldType.ShowRowCount",e.FieldType.MultiSelect)})}},{version:"4.0.3",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType&&e.FieldType.isDropdown&&!e.FieldType.isDefaultInput&&void 0!==e.FieldType.MultiSelect&&i.unset("Basics.ViewStates."+t+".FieldType.ShowRowCount")})}},{version:"4.1.0",fn:function(e){e.set("Basics.FloatSubmit",!0)}},{version:"4.1.1",fn:function(i){var e=i.get("Basics.ViewStates"),t=i.get("Style");(t=void 0===i.get("Style")?{}:t).minWidth=void 0===t.minWidth?"":t.minWidth,t.labelWidth=void 0===t.labelWidth?"":t.labelWidth,t.labelAlign=void 0===t.labelAlign?"Left":t.labelAlign,t.padding=void 0===t.padding?"":t.padding,t.formMargin=void 0===t.formMargin?"":t.formMargin,t.layout=void 0===t.layout?"default":t.layout,t.verticalSpacing=void 0===t.verticalSpacing?"":t.verticalSpacing,t.submitOffset=void 0===t.submitOffset?"16px 0px 0px 10px":t.submitOffset,t.resetOffset=void 0===t.resetOffset?"16px 0px 0px 10px":t.resetOffset,"inline"===t.layout?t.inlineBlock=!1:t.inlineBlock=!0,i.unset("Style.layout"),t.margin&&i.unset("Style.margin"),i.set("Basics.ValidationAnalytic",""),_.each(e,function(e,t){e.DisplayName||i.set("Basics.ViewStates."+t+".DisplayName","")}),i.set("Basics.FloatReset",!0)}},{version:"4.1.1D2",fn:function(i){var e=i.get("Basics.ViewStates");i.unset("Style.resetAlign"),i.unset("Style.submitAlign"),_.each(e,function(e,t){e.FieldType.DisplayName||i.unset("Basics.ViewStates."+t+".FieldType.DisplayName"),e.FieldType.FieldThresholdSummary||i.set("Basics.ViewStates."+t+".FieldType.FieldThresholdSummary"),e.FieldType.SelectAllValue||i.set("Basics.ViewStates."+t+".FieldType.SelectAllValue"),e.FieldType.ForceSelect||i.set("Basics.ViewStates."+t+".FieldType.ForceSelect",!1)}),i.unset("Style.margin")}},{version:"4.2.0p2",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType.DisplayName||i.unset("Basics.ViewStates."+t+".FieldType.DisplayName",""),e.FieldType.FieldThresholdSummary||i.set("Basics.ViewStates."+t+".FieldType.FieldThresholdSummary",5),e.FieldType.SelectAllValue||i.set("Basics.ViewStates."+t+".FieldType.SelectAllValue","")}),i.unset("Style.margin")}},{version:"4.2.1",fn:function(i){i.unset("Style.inlineBlock"),_.isUndefined(i.get("Style.display"))&&i.set("Style.display","Row");var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType.AcceptEmptyValues||i.set("Basics.ViewStates."+t+".FieldType.AcceptEmptyValues",!1),e.FieldType.ShowSearch||i.set("Basics.ViewStates."+t+".FieldType.ShowSearch",!1),e.FieldType.TooltipSummaryThreshold||i.set("Basics.ViewStates."+t+".FieldType.TooltipSummaryThreshold",5),e.FieldType.FieldSummaryThreshold||(e.FieldType.FieldThresholdSummary?i.set("Basics.ViewStates."+t+".FieldType.FieldSummaryThreshold",e.FieldType.FieldThresholdSummary):i.set("Basics.ViewStates."+t+".FieldType.FieldSummaryThreshold",5)),e.FieldType.FieldSummaryThreshold&&i.unset("Basics.ViewStates."+t+".FieldType.FieldThresholdSummary")})}},{version:"4.3.0",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType.isDropdown?i.set("Basics.ViewStates."+t+".FieldType._Type","Dropdown"):i.set("Basics.ViewStates."+t+".FieldType._Type","Default"),i.unset("Basics.ViewStates."+t+".FieldType.isDefaultInput"),i.unset("Basics.ViewStates."+t+".FieldType.isDropdown")})}},{version:"4.3.1",fn:function(e){var t=e.get("Basics.SetViewStateOnSubmit.Value"),i=e.get("Basics.SetViewStateOnSubmit.ViewState");t&&i?e.set("Basics.Actions",[{_Type:"map",Current:t,Target:i}]):e.get("Basics.Actions")||e.set("Basics.Actions",[]),e.unset("Basics.SetViewStateOnSubmit")}},{version:"4.5.1",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){i.unset("Basics.ViewStates."+t+".FieldType.UseDataSource")})}},{version:"4.6.1P2",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){i.set("Basics.ViewStates."+t+".FieldType.AdvancedSearch",!1)})}},{version:"4.7.6",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){i.set("Basics.ViewStates."+t+".FieldType.SortListBySelected",!1)})}},{version:"4.7.7",fn:function(e){e.get("Basics.Name")||e.set("Basics.Name","")}},{version:"v2.4.0",fn:function(e){_.each(e.get("Basics.ViewStates"),function(e){e.AllowNulls=!0})}}]},c=(l.escapeRegexCharacters=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\+\?\.\\\^\$\|]/g,"\\$&")},l.matchCustom=function(e,t){var i;return""===$.trim(e.term)||void 0!==t.text&&(e=e.term||"",i=t.text||"",l.isMatch(e.toLowerCase(),i.toLowerCase()))?t:null},l.isMatch=function(e,t){var i,a=!1,s=e.split(/ +and +| +/);for(_.includes(s,"or")&&(s=_.without(s,"or"),a=!0),i=0;i<s.length;i++)0!==s[i].indexOf("-")&&s[i].indexOf("*")<0&&(s[i]="*"+s[i]+"*");var o=a||_.every(s,function(e){return 0===e.indexOf("-")});return _[a?"some":"every"](s,function(e){return l.isSimpleMatch(e,t,o)})},l.isSimpleMatch=function(e,t,i){var a=!1;if(i||0!==e.indexOf("-")||(e=e.replace("-",""),a=!0),""===t){if("null"===e||"*null*"===e)return!a}else if("-null"===e)return!0;i=new RegExp("^"+l.escapeRegexCharacters(e).replace(/\*/g,".*")+"$").test(t);return a?!i:i},l);function l(){}function a(e){Object.assign(this,(dataModel=e.dataModel,debouncedApplyViewStateClone=e.debouncedApplyViewStateClone,form=e.form,onSubmit=e.onSubmit,settingsModel=e.settingsModel,viewModel=e.viewModel,viewModelClone=e.viewModelClone,e)),this.style=this.settingsModel.get("Style"),this.initializeEvents(),this.$form=this.form.$el,this.$reset=this.form.$el.find("button.reset"),this.$submit=this.form.$el.find("button[type=submit]"),this.$ulList=this.form.$el.find("fieldset > ul")}function o(e){Object.assign(this,(form=e.form,reapplyButtons=e.reapplyButtons,settingsModel=e.settingsModel,viewModel=e.viewModel,widgetId=e.widgetId,e)),this.customCss,this.$customCss,this.initializeEvents()}var m=function(e){return(e=(e=(e=(e=(e=-1<e.indexOf("/")?e.split("/").pop():e).replace("_"," ")).trim()).replace(/([A-Z])/g," $1")).replace(/^./,function(e){return e.toUpperCase()})).trim()},f=function(e){return decodeURIComponent(e)},n=function(e){return atob(e.replace(/_/g,"+").replace(/-/g,"/"))},y=function(e){return encodeURIComponent(e)},v=function(e){return btoa(e).replace(/\+/g,"_").replace(/\//g,"-").replace(/=/g,"")},b=function(e){return _.isObject(e)&&_.isFunction(e.get)&&e.get("_viewType")},r=function(){return"-ms-scroll-limit"in document.documentElement.style&&"-ms-ime-align"in document.documentElement.style},d=h.Model.extend({initialize:function(){this.schema={},this.listenersByPath={}}});_.extend(a.prototype,h.Events,{applyFloat:function(e){var t,i;e?(t="submit"===e?this.$submit:this.$reset,i=document.createElement("li"),$(i).css("width","inherit"),$(i).addClass("bbf-field"),$(i).addClass(e+"-field"),$(i).append(t),this.$ulList.append(i)):(this.applyFloat("submit"),this.applyFloat("reset"))},buttonOrdering:function(){var e=this.form.$el.find("button:last-child"),t=this.form.$el.find("ul > li:last-child"),i=this.form.$el.find("ul > li.reset-field"),a=this.form.$el.find("ul > li.submit-field");1===i.length&&1===a.length?i.is(t)||(a.detach(),i.detach(),this.$ulList.append(a),this.$ulList.append(i)):1!==this.$reset.length||1!==this.$submit.length||this.$reset.is(e)||(this.$submit.detach(),this.$reset.detach(),this.$form.append(this.$submit),this.$form.append(this.$reset))},initializeEvents:function(){this.listenTo(this.viewModel,"change:Basics.FloatReset",this.onFloatReset),this.listenTo(this.viewModel,"change:Basics.FloatSubmit",this.onFloatSubmit),this.listenTo(this.viewModel,"change:Basics.ShowReset",this.onShowResetChanged),this.listenTo(this.viewModel,"change:Basics.ShowSubmit",this.onShowSubmitChanged),this.listenTo(this.viewModel,"change:Basics.SubmitButtonText",this.onSubmitButtonTextChange)},onFloatReset:function(){var e="Row"===this.style.display?this.viewModel.get("Basics.FloatReset"):!this.viewModel.get("Basics.FloatReset"),t=this.viewModel.get("Basics.ShowReset");e&&t?this.applyFloat("reset"):t&&!e&&this.removeFloat("reset"),this.buttonOrdering()},onFloatSubmit:function(){var e="Row"===this.style.display?this.viewModel.get("Basics.FloatSubmit"):!this.viewModel.get("Basics.FloatSubmit"),t=this.viewModel.get("Basics.ShowSubmit");e&&t?this.applyFloat("submit"):t&&!e&&this.removeFloat("submit"),this.buttonOrdering()},onShowResetChanged:function(){this.viewModel.get("Basics.ShowReset")?(this.$form.addClass("has-reset"),this.onFloatReset()):(this.$form.removeClass("has-reset"),this.removeFloat("reset"))},onShowSubmitChanged:function(){this.viewModel.get("Basics.ShowSubmit")?(this.$form.addClass("has-submit"),this.onFloatSubmit()):(this.$form.removeClass("has-submit"),this.removeFloat("submit")),this.form.off(),this.viewModel.get("Basics.ShowSubmit")?this.form.on("change",function(e){this.form.commit()},this):this.form.on("changeList change",function(e){this.form.commit(),this.debouncedNoSubmit()},this)},onSubmitButtonTextChange:function(){this.$submit.text(this.viewModel.get("Basics.SubmitButtonText"))},remove:function(){return this.stopListening(),null},removeFloat:function(e){var e="submit"===e?this.$submit:this.$reset,t=e.parent();t.is(this.$form)||(this.$form.append(e),t.remove())},renderReset:function(){this.$reset.data("uiButton")||this.$reset.button({text:"Reset",icon:"fa fa-undo"}).click(function(e){var t;this.dataModel&&(t=this.dataModel.getParameters(),t=_.flatten(_.map(t,function(e){return _.isObject(e.dictParameters)?e.dictParameters:e})),_.each(t,function(e,t){var i=v(e.path),a=this.viewModelClone.getByPath(e.path);i&&a&&e.path.indexOf("_setting")<0&&(e=a.get("_default"),a.get("_rolling")&&(e=g.Helpers.convertRollingToDate(e,a.get("_type"))),a.set("value",e),this.form.fields[i]&&this.form.fields[i].editor.getValue()!==e&&("list"===a.get("_type")?this.form.fields[i].editor.setValue(e,!0):this.form.fields[i].editor.setValue(e)),this.viewModel.get("showSubmit")||this.debouncedApplyViewStateClone())}))}.bind(this)),this.onShowResetChanged()},renderSubmit:function(){this.$submit.data("uiButton")||this.$submit.button({text:this.viewModel.get("Basics.SubmitButtonText"),icon:"fa fa-check"}).click(this.onSubmit),this.onShowSubmitChanged()}});return _.extend(o.prototype,h.Events,{applyCustomCss:function(e,t){e?e===this.customCss&&!t||(this.$customCss&&this.$customCss.length?this.$customCss.html(e):this.$customCss=$("<style />",{"data-widgetid":this.widgetId,html:e,type:"text/css"}).appendTo(document.head),this.customCss=e):this.$customCss&&(this.$customCss.remove(),this.$customCss=null,this.customCss=null)},constructRule:function(e,t){if(e){var i,a,s=e.tagName.toLowerCase(),o='[data-widgetid="'+this.widgetId+'"] div.Dataform.app-div > form.bbf-form ',l=("button"!=s&&(o+="> div > fieldset > ul "),e&&0<e.classList.length?(i=s+"."+e.classList.toString().replace(/\ /g,"."),o+=this.trimId(i,s)):e&&(o+=e.tagName.toLowerCase()),o+="{","");for(a in t)t.hasOwnProperty(a)&&!this.isBlank(t[a])&&(l+=a+":"+t[a]+";");return l?o+l+"}":""}return""},initializeEvents:function(){this.listenTo(this.settingsModel,"change:Style",this.setStyle)},isBlank:function(e){return!e||/^\s*$/.test(e)},remove:function(){return this.stopListening(),this.applyCustomCss(),null},setDictStyle:function(){var e=$(this.el).find('i.fa.dict-button[data-action="add"]');_.each(e,function(e){$(e).closest(".bbf-field").css("margin-bottom","0px")})},setStyle:function(){var e=this.settingsModel.changed,t="",i=this.form.$el.find("div.bbf-editor"),a=(this.form.$el.find("div.bbf-editor > div"),this.form.$el.find("ul[data-fields]")),s=this.form.$el.find(".bbf-field"),o=this.form.$el,l=this.form.$el.find("li.bbf-field > label"),n=this.form.$el.find("button.reset"),r=this.settingsModel.get("Style"),d=this.form.$el.find("button[type=submit]"),p=this.viewModel.get("Basics.FloatSubmit")&&this.viewModel.get("Basics.FloatReset")&&this.viewModel.get("Basics.ShowSubmit")&&this.viewModel.get("Basics.ShowReset");o.toggleClass("bothFloat",p),"Left"===r.inline?(i.toggleClass("fillspace",!1),o.toggleClass("inline-labels",!0),t+=this.constructRule(i[0],{"margin-left":r.labelWidth})):(i.toggleClass("fillspace",!0),o.toggleClass("inline-labels",!1)),_.each(i,function(e){var t=e.childNodes[0].type;"checkbox"===t&&$(e).toggleClass(t,!0)}),"Row"===r.display?(a.toggleClass("flex-row",!0),a.toggleClass("flex-column",!1)):(a.toggleClass("flex-row",!1),a.toggleClass("flex-column",!0)),t=(t=(t=(t+=this.constructRule(s[0],{margin:r.formMargin,width:r.minWidth,padding:r.padding,"margin-bottom":r.verticalSpacing}))+this.constructRule(l[0],{width:"Left"===r.inline?r.labelWidth:"100%","text-align":r.labelAlign&&r.labelAlign.toLowerCase(),padding:r.labelPadding}))+this.constructRule(d[0],{margin:r.submitOffset}))+this.constructRule(n[0],{margin:r.resetOffset}),r.labelWidth||r.minWidth||"Left"!==r.inline||(t=(t+=this.constructRule(i[0],{"margin-left":"50px"}))+this.constructRule(l[0],{width:"50px"})),this.applyCustomCss(t,!0),this.setDictStyle(),"Style"in e&&null!=e.Style.display&&this.reapplyButtons()},trimId:function(e,t){var i=e.replace(/\.field[^\s]+/g,"");return"button"===t&&-1===e.indexOf(".reset")&&(i+='[type="submit"]'),i}}),h.View.extend({ERRORCLASS_INTERNAL_INVALID:"internal-invalid-error",ERRORMSG_INTERNAL_INVALID:"Invalid date/time",ERRORMSG_INTERNAL_INVALID_NUMBER:"Invalid number",ERRORCLASS_INTERNAL_UNAVAILABLE:"internal-unavailable-error",ERRORMSG_INTERNAL_UNAVAILABLE:"Date out of scope",hasInit:!1,timeout:2e3,errorTooltip:{},internalErrorTooltip:{},autogenerateDatasource:!1,availableDates:{},mulitSelectItems:{},isOpen:[],initialize:function(e){this.options=e,this.$el.addClass("Dataform"),this.widgetId=e.widgetId,this.settingsModel=e.settingsModel,e.dashboardAppModel.get("embedded")&&!e.settingsModel.get("Basics.Data")&&(this.autogenerateDatasource=!0),this.appViewModel=e.viewModel,this.autogenerateDatasource||(this.appDataModel=e.dataModel),this.model=new d,this.viewModel=new h.DeepModel,this.DeltaClientLib=e.DeltaClientLib,this.api=e.api,this.hideErrorMessage=this.api.hideErrorMessage,this.showErrorMessage=this.api.showErrorMessage,this.INTERNAL_ERROR_TABLE={invalid_date:{msg:this.ERRORMSG_INTERNAL_INVALID,cssClass:this.ERRORCLASS_INTERNAL_INVALID},invalid_number:{msg:this.ERRORMSG_INTERNAL_INVALID_NUMBER,cssClass:this.ERRORCLASS_INTERNAL_INVALID},unavailable:{msg:this.ERRORMSG_INTERNAL_UNAVAILABLE,cssClass:this.ERRORCLASS_INTERNAL_UNAVAILABLE}},this.dataCallbacks={},this.propertyListeners={},this.dataformItems=new h.Collection,this.updatedFlag=!1,this.changeQueue={},this.viewModelClone=this.cloneViewState(this.appViewModel),this.autogenerateDatasource||(this.dataModelClone=this.cloneDataSources(this.appDataModel)),this.applyRelatedDataSourcesMappers(),this.validationCollection=new h.Collection([],{model:h.Model.extend({idAttribute:this.primaryKey})}),this.debouncedApplyViewStateClone=_.debounce(this.applyViewStateClone,100).bind(this),this.debouncedOnDataCollectionChanged=_.debounce(this.onDataCollectionChanged,100),this.debouncedNoSubmit=_.debounce(this.noSubmitBtnSubmission,500).bind(this),this.debouncedRenderForm=_.debounce(this.renderForm,100),this.onThemeChanged(),this.updatedFlag=!0;var i=this;this.beforeShowDayFn=function(e){var t=_.split(this.id,"_");return 1<t.length&&i.availableDates[t[2]]&&null!==i.availableDates[t[2]][0]?[_.includes(i.availableDates[t[2]],i.convertDateToString(e)),""]:[!0,""]}},initializeEvents:function(){var a=this;this.listenTo(this.options.dashboardViewModel,"change:DashboardTheme",this.onThemeChanged),this.listenTo(this.viewModel,"change:Basics.Data",this.applyDataProperty),this.listenTo(this.viewModel,"change:Basics.ExpandDictParameters",this.onExpandDictParametersChanged),this.listenTo(this.viewModel,"change:Basics.ValidationAnalytic",this.removeTooltips),this.listenTo(this.validationCollection,"change add remove reset",this.debouncedOnDataCollectionChanged),this.intersectionObserver=new IntersectionObserver(function(e){for(var t=0,i=e;t<i.length;t++)i[t].isIntersecting||a.onResizeStop()}),this.intersectionObserver.observe(this.$el[0])},initializeVSParamListeners:function(e,t){this.stopListening(e),this.listenTo(e,"changeSettings",function(){this.updatedFlag=!0,this.loadParams()}),this.listenTo(e,"change:FieldType.Data",function(e){this.updatedFlag=!0,this.applyViewStateDataProperty(t)}),this.listenTo(e,"change:FieldType._Type",function(){this.onViewStateModelTypeChange()}),this.listenTo(e,"change:FieldType change:Tooltip",function(){"Datepicker"===e.get("FieldType._Type")?this.generateSchema(t):("Dropdown"===e.get("FieldType._Type")&&this.generateSchema(t),this.debouncedRenderForm())}),this.listenTo(e,"change:DisplayName",function(){this.applyDisplayName()}),this.listenTo(e,"change:HideParameter",function(e){this.onHideParameter(e,t)})},applyDataProperty:function(){var t=this,e=this.viewModel.get("Basics.Data");t.dataModel&&t.stopListening(t.dataModel),e?(t.dataModel=t.getClonedModel(e),t.dataModelOriginal=e,t.dataModel&&t.dataModel.attributes?(t.loadParams(),t.dataModel&&t.listenTo(t.dataModel,"change",function(e){0<_.filter(_.keys(e.changed),function(e){return 0===e.indexOf("_")}).length&&_.defer(function(){t.loadParams()})}),t.initializeErrorHandler(t.dataModel)):t.showErrorMessage({error:'Invalid Data Source: "'+e.path+'" selected',errorType:"Warning"},t.dataModel)):(t.dataModel=null,t.model.clear(),t.debouncedRenderForm())},applyDisplayName:function(){var e=this.getParams();_.each(e,_.bind(function(e){_.isString(e)?t=e:_.isObject(e)&&(t=e.raw?"raw_"+e.key:e.path);var t,e=this.getViewStateItem(t);e&&(e=e.DisplayName,e=_.isObject(e)?e.get("value"):e,t=this.$el.find("[title='"+t+"']"),$(t).html(e))},this))},applyRelatedDataSourcesMappers:function(){var t=this,e=_.map(_.filter(t.settingsModel.get("Basics").ViewStates,function(e){return e&&e.FieldType&&e.FieldType.Data}),function(e){return e.FieldType.Data.path}),i=[],a=_.map(_.map(t.settingsModel.get("Basics").ViewStates,"PathEnc"),function(e){return f(e)});_.each(_.map(t.settingsModel.get("Basics").ViewStates,"HideParameter"),function(e){e&&i.push(e.path)}),_.each(t.api.getDataSourceMap(a,e,i),function(e){e=t.getClonedModel(e);e&&e.apply()})},applyViewStateClone:function(){var i=this;_.each(this.viewModelClone.getViewStateList(),function(e){var t=i.appViewModel.getByPath(e.path);t&&("dict"===e.model.get("_type")?t.set("value",i.cloneDict(e.model.get("value"),i.appViewModel)):t.set("value",e.model.get("value")))}),this.forceExecutePending&&this.dataModelOriginal&&this.dataModelOriginal.forceExecute(),this.executeActions(),this.forceExecutePending=!1},applyViewStateDataProperty:function(t){var l=this,n=this.dataformItems.get(v(t)),e=n.get("viewModel"),i=_.find(this.settingsModel.get("Basics").ViewStates,function(e){return e.PathEnc===y(t)});n&&i&&!n.ignoreModelChanges&&((e=this.getClonedModel(e.get("FieldType.Data")))&&(this.stopListening(e),this.dataUnsubscribe(e,n.get("onData")),n.set("subscribed",!1)),i.FieldType.Data)&&(this.listenTo(e,"refresh",function(){l.applyViewStateDataProperty(t)}),n.set("onData",function(e,t){var i=e.columns,a=!1,s=n.get("columnsCollection"),o=n.get("collection"),e=(e.primaryKey!==n.get("primaryKey")&&(n.set("primaryKey",e.primaryKey),o.reset(),n.set("collection",new h.Collection([],{model:h.Model.extend({idAttribute:n.primaryKey})})),a=!0),i.reset?s.reset(i.reset):(s.remove(_.map(i.remove,function(e){return e.id})),s.add(i.add),s.add(i.change,{merge:!0})),a=a||_.some(["add","remove","reset","change"],function(e){return l.metaChange="reset",r()?e in i:void 0!==i[e]}),t.reset?o.reset(t.reset):_.isArray(i.reset)&&_.isEmpty(i.reset)?o.reset():(o.remove(_.map(t.remove,function(e){return e[n.get("primaryKey")]})),o.add(t.add),o.add(t.change,{merge:!0})),f(n.get("pathEnc")));a&&l.onViewStateColumnsCollectionChanged(e),_.some(["add","change","remove","reset"],_.partial(_.has,t))&&l.onViewStateDataCollectionChanged(e)}),e)&&(this.dataSubscribe(e,n.get("onData")),n.set("subscribed",!0))},cloneDataSources:function(e){e=JSON.stringify(e);return new g.DocumentDataModel(JSON.parse(e),null,"",this.viewModelClone,!0)},cloneDict:function(e,i){return value={},_.each(e,function(e,t){e instanceof h.Model?value[t]=i.getByPath(e.path):value[t]=e}),value},cloneViewState:function(o){var l=this,e=JSON.stringify(o),n=new g.DocumentViewModel(JSON.parse(e));return _.each(n.getViewStateList(),function(e){var t=n.getByPath(e.path),e=o.getByPath(e.path);t&&e&&("dict"===e.get("_type")?t.set("value",l.cloneDict(e.get("value"),n)):t.set("value",e.get("value")))}),l.stopListening(o),l.listenTo(o,"change",function(e){var t;e&&(e.path?(t=n.getByPath(e.path))&&("dict"===e.get("_type")?t.set({_default:l.cloneDict(e.get("_default"),n),_type:e.get("_type"),value:l.cloneDict(e.get("value"),n)}):t.set(e.attributes)):e.changed&&_.each(e.changed,_.bind(function(e,t){var i,a=n.get(t),s=o.get(t);s&&!s.path&&(s.path=t),s&&!a?(i=this.getClonedModel(s,"viewstate"))&&(i.path=t,n.set(t,i)):!s&&a?(l.stopListening(a),n.unset(t)):s&&a&&("dict"===s.get("_type")?a.set({_default:l.cloneDict(s.get("_default"),n),_type:s.get("_type"),value:l.cloneDict(s.get("value"),n)}):a.set(s.attributes))},this)))}),n},convertDateToString:function(e){return _.isDate(e)?g.Tools.convertValueToMoment(e,"1214",!0).toDashString():e},dataSubscribe:function(e,t){var i=this;e&&t&&(_.has(i.dataCallbacks,e.path)?i.dataCallbacks[e.path].add(t):(i.dataCallbacks[e.path]=$.Callbacks("memory unique"),i.dataCallbacks[e.path].add(t),i.api.subscribe(e,$.proxy(i.dataCallbacks[e.path].fire,i))))},dataUnsubscribe:function(e,t){var i=this;e&&t&&_.has(i.dataCallbacks,e.path)&&_.has(i.dataCallbacks,e.path)&&(i.dataCallbacks[e.path].remove(t),i.dataCallbacks[e.path].has()||(i.api.unsubscribe(e),i.dataCallbacks[e.path]=null,delete i.dataCallbacks[e.path]))},doApply:function(e){var a=this,t=this.viewModel.get("Basics.ForceExecute"),i=this.settingsModel.get("Basics.SetViewStateOnSubmit.ViewState"),i=this.getClonedModel(i),s=!1;_.each(this.form.fields,function(e,t){var i=_.get(e,"model.schema."+t+".type");i&&"Number"===i&&_.isNaN(Number(e.model.get(t)))&&(s=!0,e.editor.$el.closest(".bbf-editor").addClass("error"),a.setInternalTooltip(t,e.editor.$el,a.INTERNAL_ERROR_TABLE.invalid_number))}),s||(this.setError(e),_.isEmpty(e)&&(this.form.commit(),!0===a.viewModel.get("Basics.ShowSubmit")&&(e=this.viewModel.get("Basics.SetViewStateOnSubmit.Value"),i&&e&&i.set("value",e),t)&&(this.forceExecutePending=!0),this.debouncedApplyViewStateClone()))},executeActions:function(){var e=this.viewModel.get("Basics.Actions");this.api.doActions(e,"Basics.Actions")},generateDatasource:function(){var e,i=this,a=[],t=(_.each(this.viewModel.get("Basics.ViewStates"),function(e,t){t=i.api.getPropertyMeta("Basics.ViewStates."+t+"."+"Parameter");t&&"viewstate"===t.type&&a.push(t.path)}),null);a.length?(e=new g.DocumentDataModel({},null,"dummyRoot",this.appViewModel,!0),t=new g.DocumentDataModel({_dataType:"query",_queryParams:a.map(function(e){return{value:"<%"+e+"%>"}})},e,_.uniqueId("dummyinternal_"),this.appViewModel,!1),this.appDataModel=e,this.dataModelClone=this.cloneDataSources(this.appDataModel)):(this.appDataModel=null,this.dataModelClone=null),this.viewModel.set("Basics.Data",t)},generateSchema:function(e){var t,i,a=this,s=!1,o=v(e),l=this.dataformItems.get(o),n=this.getViewStateItem(e),r=n.FieldType.AcceptEmptyValues;if(n.FieldType.Data){var d=n.FieldType.DataSourceMapping,p=n.FieldType.Custom,s=n.FieldType.UseCustom;if(n.FieldType.Data&&!l.get("subscribed")&&this.applyViewStateDataProperty(e),d&&d.Value&&d.Text&&(t=l.get("collection").map(function(e){var t={val:b(d.Value)?g.Tools.castToDashString(e.get(d.Value.get("value")),l.viewStateType):g.Tools.castToDashString(e.get(d.Value),l.viewStateType),label:b(d.Text)?e.get(d.Text.get("value")):e.get(d.Text)};return s&&(p&&p.Icon&&(t.Icon=b(p.Icon)?g.Tools.castToDashString(e.get(p.Icon.get("value")),l.viewStateType):g.Tools.castToDashString(e.get(p.Icon),l.viewStateType)),p)&&p.IconColor&&(t.IconColor=b(p.IconColor)?g.Tools.castToDashString(e.get(p.IconColor.get("value")),l.viewStateType):g.Tools.castToDashString(e.get(p.IconColor),l.viewStateType)),t}),t=r?t:_.filter(t,function(e){return null!==e.val&&void 0!==e.val&&""!==e.val})),"Slider"===n.FieldType._Type&&_.get(l.get("collection"),"models")&&(i=_.map(l.get("collection").models,function(e){return e.get(Object.keys(e.attributes)[0])})),"Datepicker"===n.FieldType._Type)return void(_.get(l.get("collection"),"models")&&(this.availableDates[l.id]=_.map(l.get("collection").models,function(e){var t=Object.keys(e.attributes)[0],e=e.get(t)||"";if(g.Tools.isKDBTemporal(e))return g.Tools.convertKDBTemporalToMoment(e).toDashString()}),0<this.form.fields[l.id].editor.$el.find(".hasDatepicker").length)&&(e=this.form.fields[l.id].model.get(l.id),this.form.fields[l.id].editor.setAvailableDates(this.availableDates[l.id]),this.form.fields[l.id].editor.updateDateInputField(e),this.form.fields[l.id].editor.setValue(e)))}else t=_.map(n.FieldType.Items,function(e){var t={label:b(e.Text)?e.Text.get("value"):e.Text,val:b(e.Value)?e.Value.get("value"):e.Value};return s&&(t.Icon&&(t.Icon=b(e.Icon)?e.Icon.get("value"):e.Icon),t.IconColor)&&(t.IconColor=b(e.IconColor)?e.IconColor.get("value"):e.IconColor),t}),t=r?t:_.filter(t,function(e){return null!==e.val&&void 0!==e.val&&""!==e.val});this.model.schema[o]={acceptEmptyValues:n.FieldType.AcceptEmptyValues,enforceValue:n.FieldType.ForceSelect,inputItemLimit:n.FieldType.FieldSummaryThreshold,matcher:n.FieldType.AdvancedSearch?c.matchCustom:null,modelKey:o,multiSelect:n.FieldType.MultiSelect,options:t||[],selectAllValue:n.FieldType.SelectAllValue,sortListBySelected:n.FieldType.SortListBySelected,showSearch:n.FieldType.ShowSearch,tooltip:function(e){return n.Tooltip||e||""},tooltipItemLimit:n.FieldType.TooltipSummaryThreshold,type:n.FieldType.MultiSelect?"MultiSelect":"Select",validators:[],viewstateType:l.viewStateType,width:"100%"},i&&_.get(this,"form.fields")&&_.get(l,"id")&&this.form.fields[l.id]&&this.model&&_.defer(function(){a.form.fields[l.id].editor.setKeys(i,a.model.get(o))},250)},getClonedModel:function(e,t){var i,a,s,o,l,n,r,d=this,p=null,c=null,h="";if(!e||!e.path)return null;switch(t=t||(e.get("_viewType")?"viewstate":e.get("_dataType")?"datasource":null)){case"datasource":p=d.dataModelClone,c=d.appDataModel,h="#clone";break;case"viewstate":p=d.viewModelClone,c=d.appViewModel}if(!p)return null;if(!(i=p.getByPath(e.path))){switch(r=JSON.stringify(e),t){case"datasource":s=new g.DocumentDataModel(JSON.parse(r),null,"",d.viewModelClone);break;case"viewstate":s=new g.DocumentViewModel(JSON.parse(r))}(n=/\/([\w -]+)$/.exec(e.path))&&n[1]?(a=n[1],n=e.path.substr(0,e.path.length-n[0].length),(o=c.getByPath(n))&&(o.path=n,l=d.getClonedModel(o,t))):(a=e.path,l=p),l&&l.set(a,s),i=s}return i.isClone=!0,i.path=e.path+h,"datasource"===t?(e.root&&e===e.root?i.root=i:i.root=e.root,i.dataSet||i.apply(),d.stopListening(e),d.listenTo(e,"change",function(){i.set(e.attributes),i.updateParameters()})):"viewstate"===t&&(d.stopListening(e),d.listenTo(e,"change",function(){"dict"===e.get("_type")?i.set({_default:d.cloneDict(e.get("_default"),d.viewModelClone),_type:e.get("_type"),value:d.cloneDict(e.get("value"),d.viewModelClone)}):e.has("_type")&&i.set(e.attributes)})),i},getParams:function(){var e,i;return!(!this.dataModel||!this.dataModel.getParameters||_.isUndefined(this.viewModel.get("Basics.ExpandDictParameters")))&&(e=this.dataModel.getParameters(),i=[],this.viewModel.get("Basics.ExpandDictParameters")?_.each(e,function(t){t.dictParameters?_.each(t.dictParameters,function(e){e.raw?i.push({type:e.type,value:e.value,dict:t.path,key:e.key,raw:!0}):e.key?i.push({path:e.path,key:e.key}):i.push(e.path)}):i.push(t.path)}):_.each(e,function(e){i.push(e.path)}),_.uniq(i))},getViewStateItem:function(t){return _.find(this.api.getProperty("Basics.ViewStates"),function(e){if(e&&e.PathEnc===y(t))return!0})},initializeErrorHandler:function(e){var t=this;t.updateErrorMessage(),t.listenTo(e,"change:error",function(){t.updateErrorMessage()})},loadParams:function(){var p={},e=this.getParams(),c=[];_.each(e,_.bind(function(o,e){var i,a,s,l,t,n,r,d;_.isString(o)?title=a=o:_.isObject(o)&&(title=(a=o.raw?"raw_"+o.key:o.path,o.key)),a&&((d=this.appDataModel.getViewState().getByPath(a))&&(d.path=a,l=this.getClonedModel(d)),pathEnc=y(a),s=v(a),c.push(a),i=this.dataformItems.get(s),d=l?l.get("_type"):o.type,i||(i=this.dataformItems.add({collection:new h.Collection([],{model:h.Model.extend({idAttribute:"_rowIndex"})}),columnsCollection:new h.Collection([],{model:h.Model.extend({idAttribute:"id"})}),id:s,order:"",pathEnc:pathEnc,dictPathKey:o.key||"",primaryKey:"_rowIndex",viewModel:new h.DeepModel(_.find(this.settingsModel.get("Basics").ViewStates,function(e){return v(f(e.PathEnc))===s}))}),this.initializeVSParamListeners(i.get("viewModel"),a),this.updatedFlag=!0),i.viewStateType=d,this.model.has(s)||(l?(value=l.get("value"),"dict"===d&&(value=_.mapValues(value,function(e){e=_.isString(e)&&e.match(/^<%.+%>$/)?e.substr(2,a.length-4):_.isObject(e)?e.path:e;return e})),value=g.Tools.castToDashString(value,l.get("_type")),this.model.set(s,value),this.listenTo(l,"change:_type",this.onViewStateModelTypeChange),this.model.listenersByPath[s]=_.bind(function(e,t){this.forceRender=!0,e&&e.get("_type")&&(t=g.Tools.castToDashString(t,e.get("_type"))),this.set(s,t)},this.model),this.model.listenTo(l,"change:value",this.model.listenersByPath[s]),this.listenTo(this.model,"change:"+s,_.bind(function(e,t,i){this.changeQueue[a]=t,i.unset||(this.model.stopListening(l,"change:value",this.model.listenersByPath[s]),l.set("value",t),this.model.listenTo(l,"change:value",this.model.listenersByPath[s]))},this))):(this.model.set(s,o.value),this.listenTo(this.model,"change:"+s,function(e,t,i){var a,s=this.getClonedModel(this.dataModel.getViewState().getByPath(o.dict));s&&(a=_.clone(s.get("value")),i.unset?delete a[o.key]:(o.value=t,a[o.key]={type:o.type,value:o.value}),s.set("value",a))}))),(t=_.find(this.settingsModel.get("Basics").ViewStates,function(e,t){if(e)return i.set("order",t),e.PathEnc===pathEnc}))?t.FieldType||(t.FieldType={}):(t={FieldType:{},HideParameter:!1,PathEnc:pathEnc,DisplayName:m(title),Tooltip:""},p["Basics.ViewStates."+e+".DisplayName"]=t.DisplayName,p["Basics.ViewStates."+e+".FieldType"]=t.FieldType,p["Basics.ViewStates."+e+".HideParameter"]=t.HideParameter,p["Basics.ViewStates."+e+".PathEnc"]=t.PathEnc,p["Basics.ViewStates."+e+".Tooltip"]=t.Tooltip),"Slider"===t.FieldType._Type?(this.generateSchema(a),this.model.schema[s]=$.extend(!0,{},{range:t.FieldType.Range,ticks:t.FieldType.ShowTicks,tooltip:t.FieldType.Tooltip,tooltipFormatter:t.FieldType.Formatter,type:t.FieldType._Type})):"Dropdown"===t.FieldType._Type?this.generateSchema(a):"Password"===t.FieldType._Type?this.model.schema[s]=$.extend(!0,{},{type:t.FieldType._Type}):"Number"===t.FieldType._Type?(e=_.get(t,"FieldType.Increment"),r=_.get(t,"FieldType.UseDecimalPlaces"),n=_.get(t,"FieldType.DecimalPlaces"),e="object"==typeof e?e.get("value"):e,r="object"==typeof r?r.get("value"):r,n="object"==typeof n?n.get("value"):n,this.model.schema[s]=$.extend(!0,{},{type:t.FieldType._Type,increment:e||1,useDecimalPlaces:r||!1,decimalPlaces:n||2})):((e=u.RTTI.getByName(d))&&e.editor&&this.model.schema[s]&&e.editor.type!==this.model.schema[s].type&&(this.updatedFlag=!0),_.isEmpty(t.FieldType.Data)&&!_.isEmpty(this.availableDates[s])&&(this.availableDates[s]=null,this.removeTooltips(this.internalErrorTooltip),this.internalErrorTooltip={}),e.editor.options=$.extend(e.editor.options,{beforeShowDay:this.beforeShowDayFn}),e.editor.options=$.extend(e.editor.options,{readOnly:_.get(t,"FieldType.ReadOnly")}),e.editor.options=$.extend(e.editor.options,{availableDates:_.isEmpty(this.availableDates[s])?null:this.availableDates[s],minDate:_.isEmpty(this.availableDates[s])?null:_.min(this.availableDates[s]),maxDate:_.isEmpty(this.availableDates[s])?null:_.max(this.availableDates[s])}),this.model.schema[s]=$.extend(!0,{},e.editor)),t.Tooltip)&&(r="object"==typeof t.Tooltip?t.Tooltip.get("value"):t.Tooltip,this.model.schema[s].fieldAttrs={title:r.replace(/(?:\\r\\n|\\r|\\n)/g,"\r\n")})},this)),_.defer(_.bind(function(){_.each(p,_.bind(function(e,t){this.api.setProperty(t,e)},this))},this)),_.each(_.keys(this.model.attributes),_.bind(function(e){var t=n(e),i=this.dataformItems.get(e),a=y(t);-1===c.indexOf(t)&&((t=this.dataModel.getViewState().getByPath(t))&&(this.stopListening(t,"change:_type"),this.model.stopListening(t,"change:value",this.model.listenersByPath[e]),t.stopListening(this.model)),this.model.unset(e),this.autogenerateDatasource||this.settingsModel.set("Basics.ViewStates",_.reject(this.settingsModel.get("Basics.ViewStates"),function(e){return e&&e.PathEnc===a})),i&&(this.stopListening(i.get("collection")),this.stopListening(i.get("viewModel")),this.dataformItems.remove(i)),delete this.model.listenersByPath[e],delete this.model.schema[e],this.updatedFlag=!0)},this)),this.updatedFlag&&(this.renderForm(),this.StylesModule.setStyle(),this.updatedFlag=!1)},viewStateDataModelChanged:function(e,t,i){var a=this.dataformItems.get(v(f(e)));a&&(a=a.get("collection"),i.reset?a.reset(i.reset):(a.remove(_.map(i.remove,function(e){return e[self.primaryKey]})),a.add(i.add),a.set(i.change,{remove:!1})),this.updatedFlag=!0,i.add||i.change||i.reset||i.remove)&&this.generateSchema(f(e))},noSubmitBtnSubmission:function(){var e=this,t=e.settingsModel.get("Basics.ValidationAnalytic");return t?(e.updateValidationModel(t),e.api.subscribe(e.validationModel,_.bind(e.onValidationData,e))):e.doApply(),!1},onDataCollectionChanged:function(){var t={};this.validationCollection.each(function(e){e.get("Value")&&(t[e.get("Property")]=e.get("Value"))}),this.doApply(t)},onExpandDictParametersChanged:function(){this.updatedFlag=!0,this.loadParams()},onScroll:function(){this.onResizeStop()},onResizeStop:function(){var e,a=this,s=!1;if(!_.isEmpty(this.internalErrorTooltip)){var o=this;for(key in this.internalErrorTooltip)!function(){var e,t=o.internalErrorTooltip[key].text(),i=Object.keys(o.INTERNAL_ERROR_TABLE).find(function(e){return a.INTERNAL_ERROR_TABLE[e].msg===t});o.form.fields[key]&&(s=!0,u.ErrorTooltip.clear(o.internalErrorTooltip[key]),e=(o.form.fields[key].editor.$el.is("input")?o.form.fields[key].editor.$el:o.form.fields[key].editor.$el.find("input"))[0],o.isTopMostElement(e))&&o.setInternalTooltip(key,o.form.fields[key].editor.$el,o.INTERNAL_ERROR_TABLE[i])}()}s||_.isEmpty(this.errors)||this.setError(this.errors),0<$("#ui-datepicker-div").length&&document.activeElement.classList.contains("hasDatepicker")&&(e=(e=document.activeElement).id.substring(e.id.lastIndexOf("_")+1),this.form.fields[e])&&$("#ui-datepicker-div").hide()},onFieldBlur:function(e,t){t=this.errorTooltip[t.schema.tooltipTitle];t&&t.hide()},setInternalTooltip:function(e,t,i){this.internalErrorTooltip[e]=u.ErrorTooltip.show(i.msg,t),$(this.internalErrorTooltip[e]).addClass(i.cssClass)},onFieldClose:function(e,t){var i=this.internalErrorTooltip[t.key],a=this.errorTooltip[t.schema.tooltipTitle];e.model.schema[t.key].type;i&&$(i).hasClass(this.ERRORCLASS_INTERNAL_INVALID)&&0<t.$el.find(".hasDatepicker").length?t.previousDate&&(a||t.$el.parent().removeClass("error"),u.ErrorTooltip.clear(i),delete this.internalErrorTooltip[t.key],t.updateDateInputField(t.previousDate),t.setValue(t.previousDate)):i&&i.hasClass(this.ERRORCLASS_INTERNAL_UNAVAILABLE)&&!i.closest("body").length?(e=t.$el,this.setInternalTooltip(t.key,e,this.INTERNAL_ERROR_TABLE.unavailable)):a&&a.show()},hideNullError:function(e){var t=null==(t=null==(t=this.dataformItems.get(e.key))?void 0:t.get("viewModel"))?void 0:t.get("AllowNulls"),e=e.model.get(e.key);return _.isNil(e)&&t},onFieldInvalidError:function(e,t){var i=t.$el,a=this.errorTooltip[t.schema.tooltipTitle],s=this.hideNullError(t),a=(a&&a.hide(),this.internalErrorTooltip[t.key]);s?null!=a&&a.hide():a?a.hasClass(this.ERRORCLASS_INTERNAL_UNAVAILABLE)||!a.closest("body").length?(u.ErrorTooltip.clear(a),this.setInternalTooltip(t.key,i,this.INTERNAL_ERROR_TABLE.invalid_date)):a.show():(t.$el.parent().hasClass("error")||t.$el.parent().addClass("error"),this.setInternalTooltip(t.key,i,this.INTERNAL_ERROR_TABLE.invalid_date))},onFieldUnavailableError:function(e,t){var i=t.$el,a=this.errorTooltip[t.schema.tooltipTitle],a=(a&&a.hide(),this.internalErrorTooltip[t.key]);a?a.hasClass(this.ERRORCLASS_INTERNAL_INVALID)||!a.closest("body").length?(u.ErrorTooltip.clear(a),this.setInternalTooltip(t.key,i,this.INTERNAL_ERROR_TABLE.unavailable)):a.show():(t.$el.parent().hasClass("error")||t.$el.parent().addClass("error"),this.setInternalTooltip(t.key,i,this.INTERNAL_ERROR_TABLE.unavailable))},onFieldValid:function(e,t){var i=this.internalErrorTooltip[t.key],a=this.errorTooltip[t.schema.tooltipTitle];i&&(u.ErrorTooltip.clear(i),delete this.internalErrorTooltip[t.key],a?a.show():t.$el.parent().removeClass("error"))},onFieldChange:function(e,t){var i=this.internalErrorTooltip[t.key],a=this.errorTooltip[t.schema.tooltipTitle];i&&(u.ErrorTooltip.clear(i),delete this.internalErrorTooltip[t.key]),a?a.show():t.$el.parent().removeClass("error")},onFieldFocus:function(e,i){var a=this,t=this.errorTooltip[i.schema.tooltipTitle];_.each(this.errorTooltip,function(e,t){t!==i.schema.tooltipTitle||a.internalErrorTooltip[t]?e.hide():e.show()}),t||i.$el.parent().removeClass("error")},onHideParameter:function(e,t){this.updatedFlag=!1,this.loadParams(),_.each(this.dataformItems.models,function(e){var t=document.getElementsByClassName("field-"+e.id);t&&0<t.length&&(t[0].style.display=e.get("viewModel").get("HideParameter")?"none":"")})},onSettingsChange:function(e){var a=this;_.each(e,function(e,t){"Basics.ViewStates"===t?a.autogenerateDatasource?(a.viewModel.set("Basics.ViewStates",[]),0<e.length&&_.each(e,function(e,t){t="Basics.ViewStates."+t;a.viewModel.set(t+".Parameter",e.Parameter),a.subscribeToDropdown(t,e.PathEnc),a.subscribeToDatepicker(t,e.PathEnc),a.subscribeToSlider(t,e.PathEnc)}),a.hasInit&&a.generateDatasource()):_.each(e,function(e,t){var i="Basics.ViewStates."+t;a.viewModel.get("Basics.ViewStates")?_.each(e,function(e,t){a.viewModel.set(i+"."+t,e)}):(a.subscribeToDropdown(i,e.PathEnc),a.subscribeToDatepicker(i,e.PathEnc),a.subscribeToSlider(i,e.PathEnc))}):a.viewModel.set(t,e)}),e["Basics.ViewStates"]&&_.each(this.viewModel.get("Basics.ViewStates"),function(e){var t;e&&(t=v(f(e.PathEnc)),t=a.dataformItems.get(t))&&t.get("viewModel").set(e)}),this.hasInit||(this.hasInit=!0,this.autogenerateDatasource&&this.generateDatasource(),this.applyDataProperty(),this.initializeEvents()),this.updateBindings()},onThemeChanged:function(){var e="Dark";this.options.dashboardViewModel.get("DashboardTheme")&&(e=this.options.dashboardViewModel.get("DashboardTheme")),this.$el.removeClass("Dark").removeClass("Light").addClass(e)},onSubmit:function(e){var t=this.settingsModel.get("Basics.ValidationAnalytic");if(e&&e.preventDefault(),!_.isEmpty(this.internalErrorTooltip))for(key in this.internalErrorTooltip)if(this.form.fields[key])return!1;return t?(this.updateValidationModel(t),this.api.subscribe(this.validationModel,_.bind(this.onValidationData,this))):this.doApply(),!1},onValidationData:function(e,t){var i=this,a=e.columns;e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey,this.validationCollection.reset()),t.reset?(e.columns.reset&&(this.columns=e.columns.reset),this.validationCollection.reset(t.reset)):_.isArray(a.reset)&&_.isEmpty(a.reset)?this.validationCollection.reset():(this.validationCollection.remove(_.map(t.remove,function(e){return e[i.primaryKey]})),this.validationCollection.add(t.add),this.validationCollection.set(t.change,{remove:!1})),this.api.unsubscribe(this.validationModel)},onViewStateColumnsCollectionChanged:function(e){var t=this.dataformItems.get(v(e)),i=[""].concat(t.get("columnsCollection").map(function(e){return e.get("id")}));t.set("ignoreModelChanges",!0),void 0<=this.getParams().length&&_.defer(_.bind(function(){this.settingsModel.set("Basics.ViewStates.undefined.FieldType.DropdownPossibleValues",i),_.defer(function(){t.set("ignoreModelChanges",!1)})},this))},onViewStateDataCollectionChanged:function(t){var e,i,a,s,o,l,n,r,d=this.dataformItems.get(v(t)),p=d.get("collection"),c=!1,h=(d.get("pathEnc"),d.get("viewModel")),u=this.dataModel.getViewState().getByPath(t),m=_.find(this.settingsModel.get("Basics").ViewStates,function(e){return e.PathEnc===y(t)}),f=m.FieldType.AcceptEmptyValues;d&&p&&m&&(n=m.FieldType.DataSourceMapping,r=m.FieldType.Custom,c=m.FieldType.UseCustom,this.availableDates[d.id]=p.map(function(e){var t=Object.keys(e.attributes)[0],e=e.get(t)||"";if(g.Tools.isKDBTemporal(e))return g.Tools.convertKDBTemporalToMoment(e).toDashString()}),_.get(this.form,"fields."+d.id+".editor")&&0<this.form.fields[d.id].editor.$el.find(".hasDatepicker").length&&(this.form.fields[d.id].editor.schema.options.availableDates=this.availableDates[d.id]),n)&&n.Value&&n.Text&&(m=_.map(p.filter(function(e){return!!f||null!==e.get(n.Value)&&void 0!==e.get(n.Value)}),function(e){var t=e.get(n.Value),t={val:g.Tools.castToDashString(t,d.viewStateType),label:e.get(n.Text)};return c&&(r&&r.Icon&&(t.Icon=e.get(r.Icon)),r)&&r.IconColor&&(t.IconColor=e.get(r.IconColor)),t}),this.form)&&this.form.fields[d.id]&&(i=this.form.fields[d.id],i=_.get(i,"schema.multiSelect"),this.isOpen[d.id]&&i?this.mulitSelectItems[t]=m:(this.mulitSelectItems[t]=null,this.form.fields[d.id].title=t,this.form.fields[d.id].editor.setOptions(m),this.model.schema[d.id].options=m),e="",m&&m[0],u&&(m=g.Tools.castToDashString(u.get("value"),u.get("_type")),s=g.Tools.castToDashString(u.get("_default"),u.get("_type")),p=p.map(function(e){e=g.Tools.castToDashString(e.get(n.Value,u.get("_type")));if(e)return e.toString?e.toString():""+e}),o=h.get("FieldType.SelectAllValue"),l=h.get("FieldType.SelectAllDefault"),h.get("FieldType.ForceSelect")?null!=m&&(h.get("FieldType.MultiSelect")?(a=_.intersection(p,m),m===o||_.isEqual(m,[o])?(e=m,this.form.fields[d.id].editor.setValue(o)):e=this.isSelectAll(l,o,s)?(this.updateSelectAllValues(p,d.id),s):a,0!==e.length||_.isNil(_.first(p))||(e=_.first(p),this.form.fields[d.id].editor.setValue([e]))):_.includes(p,m.toString?m.toString():""+m)&&(e=m)):this.isSelectAll(l,o,s)?this.updateSelectAllValues(p,d.id):e=m),i||this.form.fields[d.id].editor.setValue(e),h.get("FieldType.ForceSelect"))&&(this.form.fields[d.id].commit(),this.viewModel.get("Basics.ShowSubmit")||this.debouncedApplyViewStateClone())},isSelectAll:function(e,t,i){return!(!e||t!==i&&!_.isEqual(i,[t]))},updateSelectAllValues:function(e,t){this.form.fields[t].editor.setValue(e),this.form.fields[t].commit()},onViewStateModelTypeChange:function(e,t){var i=this;_.defer(function(){i.loadParams()})},reapplyButtons:function(){this.ButtonsModule.onShowResetChanged(),this.ButtonsModule.onShowSubmitChanged()},remove:function(){var a=this;return this.api&&_.each(this.api.getProperty("Basics.ViewStates"),function(e){_.each(e,function(e,t){var t="Basics.ViewStates."+t,i=a.settingsModel.get(t+".FieldType.Data"),t=a.settingsModel.get(t+".FieldType._Type");"Dropdown"===t&&i&&a.api.unsubscribe(i),"Datepicker"===t&&i&&a.api.unsubscribe(i),"Slider"===t&&i&&a.api.unsubscribe(i)})}),this.removeTooltips(),this.removeTooltips(this.internalErrorTooltip),this.availableDates={},this.form&&(this.bbForm&&this.bbForm.removeEventListener("scroll",this.onScroll.bind(this)),this.intersectionObserver.unobserve(this.$el[0]),this.form.remove()),this.StylesModule&&this.StylesModule.remove(),h.View.prototype.remove.call(this)},removeTooltips:function(t){t=t||this.errorTooltip;var e=this.$el.find("label");_.each(e,_.bind(function(e){(input=$(e).parent().find("div.bbf-editor")).removeClass("error"),_.each(t,function(e){u.ErrorTooltip.clear(e)}),t={}},this))},renderForm:function(){var e,s=this,i=[],i=(s.form&&(this.ButtonsModule=this.ButtonsModule.remove(),this.StylesModule=this.StylesModule.remove(),this.bbForm&&this.bbForm.removeEventListener("scroll",this.onScroll.bind(this)),s.form.remove(),s.form=null),s.dataModelClone&&_.isFunction(s.dataModelClone.getViewState)&&(i=s.dataModelClone.getViewState().getViewStateList()),e=_.sortBy(this.dataformItems.models,function(e){return e.get("order")}),e=_.map(e,function(e){return e.get("id")}),this.form=new u({base64:!0,model:this.model,fields:e,resetButton:t("Reset"),submitButton:this.viewModel.get("Basics.ShowSubmit")?t(this.viewModel.get("Basics.SubmitButtonText")):t("Submit"),viewStates:i}).render(),_.assign({},this,{onSubmit:this.onSubmit.bind(this)})),i=(this.ButtonsModule=new a(i),this.ButtonsModule.renderReset(),this.ButtonsModule.renderSubmit(),_.assign({},this,{reapplyButtons:this.reapplyButtons.bind(this)})),i=(this.StylesModule=new o(i),this.StylesModule.setStyle(),s.form.$el.find('[data-action="add"]').click(function(e){e.preventDefault(),_.defer(function(){s.StylesModule.setDictStyle()})}),s.form.$el.find("input").keypress(function(e){13!==e.which||s.viewModel.get("Basics.ShowSubmit")||(s.form.commit(),s.onSubmit())}),s.form.$el.find("select"));i&&0<i.length&&_.each(i,function(e){var t,i,a=$(e).attr("name");a&&(t=s.form.fields[a].schema.sortListBySelected,i=s.form.fields[a].schema.multiSelect),$(e).on("select2:open",function(){s.isOpen[a]=!0}),$(e).on("select2:closing",function(){s.isOpen[a]=!1,t&&s.form.fields[a].editor.setOptions(s.form.fields[a].editor.currentOptions)}),$(e).on("select2:close",function(){var e;i&&s.mulitSelectItems&&(e=s.mulitSelectItems[s.form.fields[a].title])&&(s.form.fields[a].editor.setOptions(e),s.model.schema[a].options=e)})}),_.each(this.dataformItems.models,function(e){var t=e.get("id"),t=this.form.el.getElementsByClassName("field-"+t)[0];t&&(t.style.display=e.get("viewModel").get("HideParameter")?"none":"")}),s.$el.append(s.form.el),s.debouncedUpdate=_.debounce(function(){s.form.validate({appendToBody:!0})},300),s.listenTo(s.form,"change",s.debouncedUpdate),_.each(e,function(e){s.listenTo(s.form,e+":blur",s.onFieldBlur),s.listenTo(s.form,e+":focus",s.onFieldFocus),s.listenTo(s.form,e+":invalid",s.onFieldInvalidError),s.listenTo(s.form,e+":valid",s.onFieldValid),s.listenTo(s.form,e+":unavailable",s.onFieldUnavailableError),s.listenTo(s.form,e+":change",s.onFieldChange),s.listenTo(s.form,e+":close",s.onFieldClose)}),s.applyDisplayName(),this.bbForm=s.$el.find(".bbf-form")[0],this.bbForm&&this.bbForm.addEventListener("scroll",this.onScroll.bind(this))},setError:function(e){var a=this,s=(this.errors=e,_.isEmpty(e)?this.removeTooltips():this.updateTooltips(event,e),{appendToBody:!0});_.each(e,_.bind(function(e,t){var i=a.dataformItems.findWhere({dictPathKey:t})&&f(a.dataformItems.findWhere({dictPathKey:t}).get("pathEnc"));t=this.validationParmKeyMapping[t]||t;i=this.$el.find("[title='"+(i||t)+"']").parent().find("div.bbf-editor");(0<i.length&&!$(i).hasClass("error")||!this.errorTooltip[t].closest("body").length&&this.isTopMostElement(i.find("input")[0]))&&(this.errorTooltip[t]=u.ErrorTooltip.show(e,this.$el.find(i),s),i.addClass("error"))},this))},setTheme:function(){this.onThemeChanged()},isTopMostElement:function(e,t){t=e.getBoundingClientRect(),t=document.elementFromPoint(t.x+t.width/2,t.y+t.height/2);return t===e||t&&t.classList&&t.classList.contains("field-error")},subscribeToDropdown:function(e,t){var i=this.settingsModel.get(e+".FieldType.Data");"Dropdown"===this.settingsModel.get(e+".FieldType._Type")&&i&&(this.api.unsubscribe(i),this.api.subscribe(i,_.bind(this.viewStateDataModelChanged,this,t)))},subscribeToDatepicker:function(e,t){var i=this.settingsModel.get(e+".FieldType.Data");"Datepicker"===this.settingsModel.get(e+".FieldType._Type")&&i&&(this.api.unsubscribe(i),this.api.subscribe(i,_.bind(this.viewStateDataModelChanged,this,t)))},subscribeToSlider:function(e,t){var i=this.settingsModel.get(e+".FieldType.Data");"Slider"===this.settingsModel.get(e+".FieldType._Type")&&i&&(this.api.unsubscribe(i),this.api.subscribe(i,_.bind(this.viewStateDataModelChanged,this,t)))},updateBindings:function(){var s=this,e=this.getParams();s.dataModel&&(_.each(e,_.bind(function(e){var i,t,a;_.isString(e)?a=e:_.isObject(e)&&(a=e.raw?"raw_"+e.key:e.path),e=s.dataformItems.get(v(a)),i=e?e.get("viewModel"):null,(t=(e=this.getViewStateItem(a))?e.FieldType:t)&&i&&(a=e.HideParameter,_.isBoolean(a)?i.set("HideParameter",a):_.isObject(a)&&_.isFunction(a.get)&&a.get("_viewType")&&(i.get("HideParameter")&&this.stopListening(i.get("HideParameter")),a=this.getClonedModel(a))&&(i.set("HideParameter",a.get("value")),this.listenTo(a,"change:value",_.bind(function(e,t){i.set("HideParameter",t)},this))),i.set("FieldType.Data",t.Data),i.set("Actions",e.Actions))},this)),s.settingsModel.changed)&&s.settingsModel.changed.Basics&&!_.isEmpty(_.filter(s.settingsModel.changed.Basics.ViewStates,function(e){return e&&!_.isEmpty(e.FieldType)}))&&(s.updatedFlag=!0,s.loadParams())},updateErrorMessage:function(){this.dataModel.get("error")?(this.showErrorMessage(this.dataModel.get("error")),_.delay($.proxy(this.hideErrorMessage,this),3e3)):this.hideErrorMessage()},updateTooltips:function(e,i){if(e)for(key in this.errors)u.ErrorTooltip.clear(this.errorTooltip[key]);else{e=this.$el.find("label");_.each(e,_.bind(function(e){var t=this,e=(title=$(e).attr("title"),input=$(e).parent().find("div.bbf-editor"),this.validationParmKeyMapping?Object.keys(this.validationParmKeyMapping).find(function(e){return t.validationParmKeyMapping[e]===title}):void 0),e=e||title;_.has(i,e)?this.errorTooltip[title]&&(u.ErrorTooltip.clear(this.errorTooltip[title]),this.$el.is("visible"))&&this.errorTooltip[title].show():(input.removeClass("error"),u.ErrorTooltip.clear(this.errorTooltip[title]),delete this.errorTooltip[title])},this))}},updateValidationModel:function(e){var a,s,o=this,t=o.dataformItems.models[0]&&!!o.dataformItems.models[0].get("dictPathKey");if(this.validationModel=this.getClonedModel(e),a="virtual"===this.validationModel.get("_dataType"),s={name:"data",type:a?"text":"dict",value:{}},t)switch(_.each(o.dataformItems.models,function(e){var t=f(e.get("pathEnc")),i=o.viewModelClone.getByPath(t),e=e.get("dictPathKey");i&&(a?s.value[t]=i.get("value"):s.value[e]={type:i.get("_type"),IsKdbParam:!0,isViewState:!0,name:i.path,value:i.get("value")})}),this.validationModel.get("_dataType")){case"analytic":this.validationModel.attributes._analyticParams=[s];break;case"query":this.validationModel.attributes._queryParams=[s];break;case"virtual":this.validationModel.attributes._virtualParams=[s]}this.createValidationModelParamTable()},createValidationModelParamTable:function(){var e;switch(this.validationParmKeyMapping=new Object,this.validationModel.get("_dataType")){case"analytic":e="_analyticParams";break;case"query":e="_queryParams";break;case"virtual":e="_virtualParams"}var t=this.validationModel.get(e);if(t&&0<t.length){t=t[0];if(t&&"dict"===t.type)if(_.isString(t.value)&&t.value.match(/^<%.+%>$/)){var i=t.value.substring(2,t.value.length-2),a=_.filter(this.appViewModel.viewStates,function(e){return e.path===i})[0];if(a){var s=a.model.get("value");for(o in s)this.validationParmKeyMapping[o]=s[o].path}}else if(_.isObject(t.value))for(var o in s=t.value)this.validationParmKeyMapping[o]=s[o].name}}},{getComponentDefinition:s.getComponentDefinition})});
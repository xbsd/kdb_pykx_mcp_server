define(["Handlebars","QuickBase","vis","moment","xlsx","backbone","css!./css/app.css"],function(h,p,y,l,e,t){"use strict";var i,r=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}))(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),u=(a.prototype.getData=function(){return this.api.getProperty("Layers."+this.index).Data},a.prototype.getId=function(){return this.uid},a.prototype.initialize=function(){},a.prototype.updateData=function(o){var s=this,n=new y.DataSet,p=this.api.getProperty("Layers."+this.index+".XAxis"),l=this.api.getProperty("Layers."+this.index+".YAxis"),u=this.api.getProperty("Layers."+this.index+".ZAxis"),d=this.api.getProperty("Layers."+this.index+".Volume"),e=this.api.getProperty("X.AxisType"),t=this.api.getProperty("Y.AxisType"),r=this.api.getProperty("Z.AxisType"),i=this.api.getProperty("Style.ColorPalette.ColorScheme"),c=_.reverse(_.map(i,function(e){return e.type}));o?(this.axisLabels={},this.axisCache={},this.chartData=void 0,"Category"===e&&this.possibeLabels(o,p,"x"),"Category"===t&&this.possibeLabels(o,l,"y"),"Category"===r&&this.possibeLabels(o,u,"z"),-1<_.indexOf(["dot-color","dot-size","dot-line","bar-color","bar-size","bar-line"],this.api.getProperty("Layers."+this.index)._Type)?(this.columns=[this.api.getProperty("X.Label"),this.api.getProperty("Y.Label"),this.api.getProperty("Z.Label"),"value"],_.each(o.getData().models,function(e){var t=void 0===(t=e.get(o.getPropertyFromColumn(p)))?0:t,r=void 0===(r=e.get(o.getPropertyFromColumn(l)))?0:r,i=void 0===(i=e.get(o.getPropertyFromColumn(u)))?0:i,a=void 0===(a=e.get(o.getPropertyFromColumn(d)))?0:a;n.add({x:s.axisLabels.x?s.axisLabels.x[t]:parseFloat(t),y:s.axisLabels.y?s.axisLabels.y[r]:parseFloat(r),z:s.axisLabels.z?s.axisLabels.z[i]:parseFloat(i),style:void 0===parseFloat(a)?0:parseFloat(a),data:e.attributes,colorScheme:c})})):(this.columns=[this.api.getProperty("X.Label"),this.api.getProperty("Y.Label"),this.api.getProperty("Z.Label")],_.each(o.getData().models,function(e){var t=e.get(o.getPropertyFromColumn(p)),r=void 0===(r=e.get(o.getPropertyFromColumn(l)))?0:r,i=void 0===(i=e.get(o.getPropertyFromColumn(u)))?0:i;n.add({x:s.parseAxis(void 0===t?0:t,"x"),y:s.parseAxis(r,"y"),z:s.parseAxis(i,"z"),style:s.parseAxis(i,"z"),data:e.attributes})})),this.chartData=n):this.initialize()},a.prototype.possibeLabels=function(e,t,r){var t=e.getPropertyFromColumn(t),e=_.sortedUniq(e.getData().pluck(t)),i={},a={},o=0;_.each(e,function(e){void 0===i[e]&&(i[e]=o,o++)}),_.each(i,function(e,t){a[e]=t}),this.axisLabels[r]=i,this.axisCache[r]=a},a.prototype.parseAxis=function(e,t){return"Time"===this.api.getProperty(t.toUpperCase()+".AxisType")?e.i||0:(t=this.axisLabels[t]?this.axisLabels[t][e]:parseFloat(e),isNaN(t)?0:t)},a);function a(e,t,r){this.index=e,this.uid=t,this.api=r,this.colorCache={},this.columns=[],this.labels=[],this.labelData=[],this.chartType="dot",this.previousChartData={},this.axisLabels={},this.axisCache={}}s.sourceKey=function(e){return e.getPath()},s.mergeChanges=function(t,r,e,i,a,o){return e&&(t=_.fromPairs(_.map(e,function(e){return[r(e),e]}))),i&&_.each(i,function(e){return _.extend(t[r(e)],e)}),a&&_.each(a,function(e){t[r(e)]=e}),o&&_.each(o,function(e){delete t[r(e)]}),t},s.prototype.setFocus=function(e){this.focus=e,this.updateChildren(),this.childDataSource&&this.childDataSource.setFocus(e)},s.prototype.isFocused=function(){return this.focus.length===this.depth&&(0===this.depth||this.source.id===this.focus[this.depth])},s.prototype.getColumnNames=function(){if(this.breakdownColumns&&this.breakdownColumns.length)return[s.BREAKDOWN_ID,this.breakdownColumns[0]].concat(_.difference(_.keys(this.meta),this.breakdownColumns));try{return _.map(this.meta,function(e){return[e.id,e.index]}).sort(function(e,t){return e[1]-t[1]}).map(function(e){return e[0]})}catch(e){return _.keys(this.meta)}},s.prototype.getColumnType=function(e){return this.childDataSource?this.childDataSource.getColumnType(e):e===s.BREAKDOWN_ID?this.meta[this.primaryKey].kdbType:this.meta[e]?this.meta[e].kdbType:11},s.prototype.getData=function(){return this.childDataSource?this.childDataSource.getData():this.source.dataSet&&this.source.dataSet.collection},s.prototype.getDepth=function(){return this.childDataSource?this.childDataSource.getDepth():this.depth},s.prototype.getKey=function(){return this.source.cid},s.prototype.getPrimaryKey=function(){return this.childDataSource?this.childDataSource.getPrimaryKey():this.primaryKey},s.prototype.getPropertyFromColumn=function(e){return e===s.BREAKDOWN_ID?this.getPrimaryKey():e},s.prototype.getPath=function(){return this.source.path},s.prototype.getSource=function(){return this.source},s.prototype.hasData=function(){return this.childDataSource?this.childDataSource.hasData():this.hasDataFlag},s.prototype.onData=function(e,t,r){e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey),this.meta=s.mergeChanges(this.meta,function(e){return e.id},e.columns.reset,e.columns.change,e.columns.add,e.columns.remove),0!==this.depth||_.isEqual(e.breakdownColumns,this.breakdownColumns)||(this.breakdownColumns=e.breakdownColumns,this.removeChild()),t.reset&&0<t.reset.length&&this.removeChild(),r?this.updateError(this,r):this.listener&&this.listener.updateError(this,void 0),this.hasDataFlag=!0,this.updateChildren()&&this.listener.updateDataSource(this)},s.prototype.subscribe=function(){this.api.subscribe(this.source,this.onData.bind(this))},s.prototype.updateDataSource=function(){this.listener.updateDataSource(this)},s.prototype.updateError=function(e,t){this.listener.updateError(this,t)},s.prototype.unsubscribe=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource),this.api.unsubscribe(this.source)},s.prototype.removeChild=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource)},s.prototype.updateChildren=function(){var e;return!(this.breakdownColumns&&this.breakdownColumns.length&&this.depth<this.breakdownColumns.length-1&&(this.focus.length>this.depth?(this.childDataSource&&this.focus[this.depth]!==this.childDataSource.getSource().id&&this.removeChild(),!this.childDataSource&&(0!==this.depth&&(this.focus[this.depth-1],this.source.id.toString()),e=this.source.dataSet&&this.source.dataSet.collection.get(this.focus[this.depth]))&&(this.childDataSource=new s(e,this,this.api,this.focus,this.depth+1,this.breakdownColumns),this.childDataSource.subscribe())):(this.removeChild(),this.focus.length!==this.depth||!this.hasDataFlag||0!==this.depth&&this.focus[this.depth-1]!=this.source.id||this.listener.updateDataSource(this)),1))},s.BREAKDOWN_ID="{breakdownId}";var o=s;function s(e,t,r,i,a,o){this.hasDataFlag=!1,this.focus=[],this.meta={},this.source=e,this.listener=t,this.api=r,this.depth=a||0,this.breakdownColumns=o,this.setFocus(i)}var n=p.Tools,d=("function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(null===e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),a=1;a<arguments.length;a++){var o=t[a];if(null!==o)for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(i[s]=o[s])}return i},writable:!0,configurable:!0}),c.expandNestedViewStates=function(e,t){var r,i=/([a-zA-Z]+)\.[0-9]+\./,a=Object.keys(e),o=[];return(o=_.every(a,function(){var e=t.getPropertyMeta(a[0]);return e&&"viewstate"===e.type})?_.uniq(_.filter(_.map(a,function(e){e=i.exec(e);return e?e[1]:null}))):o).length?(r={},_.each(o,function(e){return r[e]=t.getProperty(e)}),r):e},c.focus2Array=function(e){var t=[],r=/"([^"]*)"/g,e=e.toString?e.toString():"",i=/^\[([^\]]*)]$/.exec(e);if(null!==i){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(i[1]))for(var a=void 0;null!==(a=r.exec(i[1]));)t.push(_.map(a[1].split(","),function(e){return e.replace(/&#44;/g,",")}))}else t.push(e.split(","));return _.filter(t,function(e){return 0<(""+e).length})},c.hex2RGB=function(e){e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e?[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]:[0]},c.clamp=function(e,t,r){return r<e?r:e<t?t:e},c.getFormatter=function(i,a,o,s){return"Number"===i||"Formatted Number"===i||"Smart Number"===i||"Datetime"===i||"Currency"===i||"SmartCurrency"===i?function(e){var t,r=e;if(null==(e="Smart Number"!==i&&"Formatted Number"!==i||_.isNumber(e)?e:_.isNumber(parseFloat(e))?parseFloat(e):e))return"";if("Smart Number"===i)r=_.isNumber(e)?n.smartFormatNumber(e,a):_.escape(e);else{if("Datetime"===i)return t=e,(l.isMoment(e)||l.isDuration(e)?c.isDuration(e)?n.convertValueToMoment(e.valueOf()):e:n.isKDBTemporal(e)?n.convertKDBTemporalToMoment(e):("number"==typeof e&&(t=new Date(e)),n.convertDateStringValueToMoment(t.toString()))).format(s);r="Formatted Number"===i&&e.toFixed?_.isNaN(e)?"":n.formatNumber(e,a):e.toFixed?e.toFixed(a):_.escape(r)}if(o&&0<=r.toString().indexOf(".")){for(;"0"===r[r.length-1];)r=r.slice(0,-1);"."===r[r.length-1]&&(r=r.slice(0,-1))}return r}:"Boolean"===i?function(e){return _.escape(e)}:function(e){return l.isMoment(e)||l.isDuration(e)?e.format(i,void 0):_.escape(e)}},c.isDuration=function(e){return _.get(e,"_kdbType")&&0<=["1216","1217","1218","1219"].indexOf(e._kdbType)},c.pump=function(r){var e,i,a;return null==r||!_.isObject(r)||(e=Object.getPrototypeOf(r),_.isObject(r)&&e!==Object.prototype&&e!==Array.prototype)?r:e===Array.prototype&&_.isArray(r)?r.map(c.pump):(i=/^(\d+)((?:\.\w+)+)$/,Object.keys(r).every(function(e){return i.test(e)})?Object.keys(r).map(function(e){var t=i.exec(e);return _.isNil(t)?{index:0,tail:void 0,value:void 0}:{index:Number(t[1]),tail:t[2].substring(1),value:r[e]}}).reduce(function(e,t){var r={},i=void 0===t.index?0:t.index,i=(r[i]={},r[i][t.tail]=t.value,JSON.parse(JSON.stringify(e))),t=JSON.parse(JSON.stringify(c.pump(r)));return Object.assign(i,t)},[]):(a={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/},Object.keys(r).some(function(e){return a.nonGreedy.test(e)})?Object.keys(r).map(function(e){var t=a.greedy.exec(e);return{head:_.isNil(t)?null:t[1],tail:_.isNil(t)||""===t[2]?null:t[2].substring(1),value:r[e]}}).reduce(function(e,t){var r={},i=null!==t.tail,a=_.isNil(t.head)?0:t.head,o=_.isNil(t.tail)?0:t.tail,i=(i?(r[a]={},r[a][o]=t.value):r[a]=t.value,JSON.parse(JSON.stringify(e))),o=JSON.parse(JSON.stringify(c.pump(r)));return Object.assign(i,o)},{}):_.mapValues(r,c.pump)))},c.replaceViewStatesWithValue=function(e,t,r){return c.replaceViewStates(e,t,function(e,t,r,i){return _.get(i,"value")!==r&&console.warn("viewModel value has changed"),_.get(i,"value")},r)},c.safeHandle=function(r){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{r.apply(this,e)}catch(e){console.error("oupsies..",e)}}},c.alpha=function(e,t){var r=this.hex2RGB(e);return r?"rgba(".concat(r[0],",").concat(r[1],",").concat(r[2],",").concat(t/100,")"):new Color(e).alpha(t/100).rgbaString()},c.replaceViewStates=function(r,e,p,l){var u;return u=function(e,t){return function r(e,t,i){i=i?i+".":"";var a,o,s=l.getPropertyMeta(i+(t+="")),n=e&&e.has&&e.has("_dataSource")&&e.has("_dataType"),n=(_.isArray(e)||_.isObject(e))&&!n;return s&&"data"===s.type?e:s&&"viewstate"===s.type?(a=(o=(i+t).split(".")).pop(),o=o.join("."),p(o,void 0===a?"":a,e,s)):n?(i+=t,u=function(e,t){return r(e,t,i)},(_.isArray(e)?_.map:_.mapValues)(e,u)):e}(e,t,r||"")},(_.isArray(e)?_.map:_.mapValues)(e,u)},c);function c(){}var m=["surface","dot","bar","bar-color","bar-size","grid","dot-color","dot-line","dot-size","line"],f=(g.getComponentDefinition=function(e){var t,r,i={id:1,componentName:"3D Chart",componentDescription:"",version:"4.7.7",appArgs:{quickStart:[{path:"Layers.0.Data",message:"populate Data Source"}],json:{version:"4.5.0",possibleAxis:[],possibleColumns:[],possibleLabels:[],possibleRules:[],possiblePalettes:[],Basics:{Name:"",Focus:"",Theme:"Dark",Selected:"",SelectedAttr:""},Layers:[{possibleLayerAxis:[],_Id:"L0",_Type:"dot",Data:"",XAxis:"",YAxis:"",ZAxis:"",Volume:"",Name:"Layer 1"}],X:{AxisType:"Linear",Label:"",Format:"",DateFormat:"YYYY-MM-DD",Prefix:"",Suffix:"",UseMin:!1,AxisMin:0,UseMax:!1,AxisMax:10},Y:{AxisType:"Linear",Label:"",Format:"",DateFormat:"YYYY-MM-DD",Prefix:"",Suffix:"",UseMin:!1,AxisMin:0,UseMax:!1,AxisMax:10},Z:{AxisType:"Linear",Label:"",Format:"",DateFormat:"YYYY-MM-DD",Prefix:"",Suffix:"",UseMin:!1,AxisMin:0,UseMax:!1,AxisMax:10},Volume:{UseMin:!1,AxisMin:0,UseMax:!1,AxisMax:10},Position:{Horizontal:1.39,Vertical:.079,Distance:50},Style:{palettes:[],fill:"transparent",stroke:"#ffffff",advanced:"",VerticalRatio:70,KeepAspectRatio:!1,advancedTooltip:"<table>{{#each points}}<tr><td>{{xLabel}}</td><td>{{x}}</td></tr><tr><td>{{yLabel}}</td><td>{{y}}</td></tr><tr><td>{{zLabel}}</td><td>{{z}}</td></tr>{{/each}}</table>",ColorPalette:{ColorScheme:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}]}},Alignment:{paddingLeft:"0",paddingRight:"0",paddingTop:"0",paddingBottom:"0"},format:{widgetTitle:"",titleFontSize:"16",titleHorizontal:"Center",titlePaddingLeft:0,titlePaddingRight:0,titlePaddingTop:0,titlePaddingBottom:0}},schema:{type:"object",title:"Properties",properties:{possiblePalettes:{propertyOrder:2,type:"array",format:"table",default:[""],options:{collapsed:!0,hidden:!0}},possibleAxis:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},possibleRules:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},possibleColumns:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},possibleLabels:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",title:"Basics",propertyOrder:1,properties:{Name:{title:"Name",type:"string",default:"",propertyOrder:1},Focus:{type:"viewstate",title:"Focus",default:"",propertyOrder:2},Theme:{type:"string",title:"Theme",propertyOrder:3,enum:["Light","Dark"],options:{hidden:!0}},Selected:{type:"viewstate",title:"Selected Value",default:""},SelectedAttr:{type:"string",title:"Selected Value Attribute",enumSource:"possible_axis",watch:{possible_axis:"root.possibleAxis"}}}},Layers:{propertyOrder:1,type:"array",items:{type:"object",id:"arrItem",title:"Layer",options:{collapsed:!0},headerTemplate:"{{#if self.Name}}{{valueProp self.Name }}{{else}}Layer {{ i1 }}{{/if}}",oneOf:m.map(function(e){return{title:e,options:{linked_oneof_property:{property:"_Type",value:e}},properties:_.extend({},g.LAYER_COMMON)}})}},X:{type:"object",title:"X",propertyOrder:3,options:{collapsed:!0},properties:{AxisType:{type:"string",propertyOrder:2,enum:["Linear","Category","Time"],default:"Linear"},Label:{type:"string",propertyOrder:3},Format:{type:"string",propertyOrder:4,enum:["General","Number","Smart Number","Formatted Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:11,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},DateFormat:{type:"string",propertyOrder:12,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:13,default:""},Suffix:{type:"string",propertyOrder:14,default:""},UseMin:{type:"boolean",title:"Set Min Axis Value",format:"checkbox",propertyOrder:4},AxisMin:{type:"number",format:"number",default:0,propertyOrder:6},UseMax:{type:"boolean",title:"Set Max Axis Value",format:"checkbox",propertyOrder:7},AxisMax:{type:"number",format:"number",default:10,propertyOrder:8}}},Y:{type:"object",title:"Y",propertyOrder:4,options:{collapsed:!0},properties:{AxisType:{type:"string",propertyOrder:2,enum:["Linear","Category","Time"],default:"Linear"},Label:{type:"string",propertyOrder:3},Format:{type:"string",propertyOrder:4,enum:["General","Number","Smart Number","Formatted Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:11,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},DateFormat:{type:"string",propertyOrder:12,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:13,default:""},Suffix:{type:"string",propertyOrder:14,default:""},UseMin:{type:"boolean",title:"Set Min Axis Value",format:"checkbox",propertyOrder:4},AxisMin:{type:"number",format:"number",default:0,propertyOrder:6},UseMax:{type:"boolean",title:"Set Max Axis Value",format:"checkbox",propertyOrder:7},AxisMax:{type:"number",format:"number",default:10,propertyOrder:8}}},Z:{type:"object",propertyOrder:5,title:"Z",options:{collapsed:!0},properties:{AxisType:{type:"string",propertyOrder:2,enum:["Linear","Category"],default:"Linear"},Label:{type:"string",propertyOrder:3},Format:{type:"string",propertyOrder:4,enum:["General","Number","Smart Number","Formatted Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:11,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},DateFormat:{type:"string",propertyOrder:12,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:13,default:""},Suffix:{type:"string",propertyOrder:14,default:""},UseMin:{type:"boolean",title:"Set Min Axis Value",format:"checkbox",propertyOrder:4},AxisMin:{type:"number",format:"number",default:0,propertyOrder:6},UseMax:{type:"boolean",title:"Set Max Axis Value",format:"checkbox",propertyOrder:7},AxisMax:{type:"number",format:"number",default:10,propertyOrder:8}}},Volume:{type:"object",title:"Volume",propertyOrder:6,options:{collapsed:!0},properties:{UseMin:{type:"boolean",title:"Set Min Axis Value",format:"checkbox",propertyOrder:2},AxisMin:{type:"number",format:"number",default:0,propertyOrder:3},UseMax:{type:"boolean",title:"Set Max Axis Value",format:"checkbox",propertyOrder:4},AxisMax:{type:"number",format:"number",default:10,propertyOrder:5}}},Position:{type:"object",propertyOrder:7,title:"Position",options:{collapsed:!0},properties:{Horizontal:{type:"number",default:10,minimum:0,maximum:100,step:1,format:"range"},Vertical:{type:"number",default:500,minimum:0,maximum:1e3,step:1,format:"range"},Distance:{type:"number",default:10,minimum:0,maximum:100,step:1,format:"range"}}},Style:{type:"object",propertyOrder:8,title:"Style",options:{collapsed:!0},properties:{stroke:{type:"gradient",options:{gradient:!1,noColor:!0},title:"Stroke",default:"#ffffff"},fill:{type:"gradient",options:{gradient:!1,noColor:!0},title:"Fill",default:"transparent"},advanced:{type:"css",title:"Advanced CSS",default:""},advancedTooltip:{data:["series","values"],default:"",templateItems:{points:{items:{cols:null,style:"style",x:"x",xLabel:"xLabel",y:"y",yLabel:"yLabel",z:"z",zLabel:"zLabel"},type:"array"}},type:"tooltipTemplate",title:"Custom tooltip"},VerticalRatio:{title:"Vertical Ratio",type:"number",default:70,format:"range",minimum:0,maximum:100},KeepAspectRatio:{type:"boolean",format:"checkbox",title:"Keep Aspect Ratio",default:!1},palettes:{default:"",title:"Palette Theme",type:"string",propertyOrder:4,enumSource:"possible_palettes",watch:{possible_palettes:"root.possiblePalettes"}},ColorPalette:{type:"object",propertyOrder:5,title:"Contour Palette",options:{collapsed:!0},properties:{ColorScheme:{propertyOrder:5,title:"Color Scheme",type:"array",format:"table",options:{collapsed:!1},uniqueItems:!1,items:{type:"object",title:"Color",properties:{type:{type:"gradient",default:"#5B9BD5",title:"Color",options:{gradient:!1}}}}}}}}},Alignment:{type:"object",propertyOrder:9,title:"Margins",options:{collapsed:!0},properties:{paddingLeft:{type:"number",title:"Padding Left",default:0,format:"number"},paddingRight:{type:"number",title:"Padding Right",default:0,format:"number"},paddingTop:{type:"number",title:"Padding Top",default:0,format:"number"},paddingBottom:{type:"number",title:"Padding Bottom",default:0,format:"number"}}},format:{type:"object",propertyOrder:10,title:"Format",options:{collapsed:!0},properties:{widgetTitle:{type:"string",propertyOrder:13,title:"Title"},titleFontSize:{type:"number",propertyOrder:15,title:"Title Font Size",format:"number"},titleHorizontal:{type:"string",propertyOrder:16,title:"Title Horizontal Align",enum:["Left","Center","Right"]},titlePaddingLeft:{type:"number",propertyOrder:17,title:"Title Padding Left",default:0,format:"number"},titlePaddingRight:{type:"number",propertyOrder:18,title:"Title Padding Right",default:0,format:"number"},titlePaddingTop:{type:"number",propertyOrder:19,title:"Title Padding Top",default:0,format:"number"},titlePaddingBottom:{type:"number",propertyOrder:20,title:"Title Padding Bottom",default:0,format:"number"}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(r=g.upgrades.indexOf(_.find(g.upgrades,{version:e.settingsModel.get("version")}))+1;r<g.upgrades.length;r+=1)(t=g.upgrades[r]).fn(e.settingsModel,e),e.settingsModel.set("version",t.version);return i},g.LAYER_COMMON={possibleLayerAxis:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},_Id:{type:"string",options:{hidden:!0}},_Type:{type:"string",options:{hidden:!0},default:"dot"},Data:{type:"data",propertyOrder:1,format:"string",title:"Data Source",default:""},Name:{title:"Name",type:"string",default:"",propertyOrder:2},XAxis:{type:"string",title:"X-Axis",propertyOrder:3,enumSource:"possible_columns",watch:{possibleCols:"arrItem.possibleLayerAxis"}},YAxis:{type:"string",title:"Y-Axis",propertyOrder:4,enumSource:"possible_columns",watch:{possibleCols:"arrItem.possibleLayerAxis"}},ZAxis:{type:"string",title:"Z-Axis",propertyOrder:5,enumSource:"possible_columns",watch:{possibleCols:"arrItem.possibleLayerAxis"}},Volume:{type:"string",title:"Volume",enumSource:"possible_columns",propertyOrder:6,watch:{possibleCols:"arrItem.possibleLayerAxis"}}},g);function g(){}f.upgrades=[{version:0,fn:function(){}},{version:"4.1.0s1",fn:function(){}},{version:"4.1.0s2",fn:function(){}},{version:"4.3.0.2",fn:function(e){var t=e.get("Style"),r=e.get("X"),i=e.get("Y"),a=e.get("Z");t.stroke=void 0===t.stroke?"#ffffff":t.stroke,t.fill=void 0===t.fill?"transparent":t.fill,e.set("Style",t),r.Format=-1===_.indexOf(["General","Number","Smart Number","Formatted Number","Datetime"],r.Format)?"General":r.Format,r.Precision=void 0===r.Precision?0:r.Precision,r.DateFormat=void 0===r.DateFormat?"":r.DateFormat,r.Prefix=void 0===r.Prefix?"":r.Prefix,r.Suffix=void 0===r.Suffix?"":r.Suffix,r.AxisType=void 0===r.AxisType?"Linear":r.AxisType,i.Format=-1===_.indexOf(["General","Number","Smart Number","Formatted Number","Datetime"],i.Format)?"General":i.Format,i.Precision=void 0===i.Precision?0:i.Precision,i.DateFormat=void 0===i.DateFormat?"":i.DateFormat,i.Prefix=void 0===i.Prefix?"":i.Prefix,i.Suffix=void 0===i.Suffix?"":i.Suffix,i.AxisType=void 0===i.AxisType?"Linear":i.AxisType,a.Format=-1===_.indexOf(["General","Number","Smart Number","Formatted Number","Datetime"],a.Format)?"General":a.Format,a.Precision=void 0===a.Precision?0:a.Precision,a.DateFormat=void 0===a.DateFormat?"":a.DateFormat,a.Prefix=void 0===a.Prefix?"":a.Prefix,a.Suffix=void 0===a.Suffix?"":a.Suffix,a.AxisType=void 0===a.AxisType?"Linear":a.AxisType,e.set("X",r),e.set("Y",i),e.set("Z",a)}},{version:"4.5.0",fn:function(e){var t=e.get("Style"),r=e.get("X"),i=e.get("Y"),a=e.get("Z"),o=e.get("Volume");r.DateFormat=void 0===r.DateFormat||""===r.DateFormat?"YYYY-MM-DD":r.DateFormat,i.DateFormat=void 0===i.DateFormat||""===r.DateFormat?"YYYY-MM-DD":r.DateFormat,a.DateFormat=void 0===a.DateFormat||""===r.DateFormat?"YYYY-MM-DD":r.DateFormat,o.UseMax=void 0!==o.UseMax&&o.UseMax,o.UseMin=void 0!==o.UseMin&&o.UseMin,o.AxisMax=void 0===o.AxisMax?10:o.AxisMax,o.AxisMin=void 0===o.AxisMin?0:o.AxisMin,t.VerticalRatio=void 0===t.VerticalRatio?70:t.VerticalRatio,t.KeepAspectRatio=void 0!==t.KeepAspectRatio&&t.KeepAspectRatio,t.ColorPalette=void 0===t.ColorPalette?{ColorScheme:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}]}:t.ColorPalette,e.set("Style",t),e.set("X",r),e.set("Y",i),e.set("Z",a),e.set("Volume",o)}},{version:"4.7.7",fn:function(e){e.get("Basics.Name")||e.set("Basics.Name","")}},{version:"4.7.7a",fn:function(e){e.get("Layers")||(e.set("Layers.0.Data",e.get("Basics.Data")),e.set("Layers.0.Name","Layer 1"),e.set("Layers.0._Type",e.get("Basics.Type")),e.set("Layers.0._Id","L0"),e.unset("Basics.Data"),e.unset("Basics.Type"),e.set("Layers.0.XAxis",e.get("X.Data")),e.set("Layers.0.YAxis",e.get("Y.Data")),e.set("Layers.0.ZAxis",e.get("Z.Data")),e.set("Layers.0.Volume",e.get("Volume.Data")),e.unset("X.Data"),e.unset("Y.Data"),e.unset("Z.Data"),e.unset("Volume.Data"))}}];D.app=h.template({compiler:[8,">= 4.3.0"],main:function(e,t,r,i,a){var o,s=null!=t?t:e.nullContext||{},n=e.hooks.helperMissing,p="function",l=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="Chart3D">\n\n    <div class="title">\n    </div>\n\n    <div class="frame">\n        <div id="Chart3D_'+l(typeof(o=null!=(o=e(r,"id")||(null!=t?e(t,"id"):t))?o:n)==p?o.call(s,{name:"id",hash:{},data:a,loc:{start:{line:7,column:25},end:{line:7,column:31}}}):o)+'" class="graph '+l(typeof(o=null!=(o=e(r,"id")||(null!=t?e(t,"id"):t))?o:n)==p?o.call(s,{name:"id",hash:{},data:a,loc:{start:{line:7,column:46},end:{line:7,column:52}}}):o)+'" style="height:100%" >\n          <div style="height:100%;width:100%"></div>\n\n        </div>\n    </div>\n\n</div>'},useData:!0});var b,x=D;function D(){}function P(e){var t=b.call(this,e)||this,r=(t.focus=[],t.isReadyForThemeChange=!1,t.layers=[],t.dataSources={},t.ignoreSettingsChange=!1,t.globalPalette=[],t.api=e.api,_.extend(t,_.pick(e,["api","dashboardViewModel"])),t.onSettingsChange.bind(t));return t.onSettingsChange=function(e){var t=this.onSettingsChange!==(this.onSettingsChange=r);this.onSettingsChange(e),t&&(this.isReadyForThemeChange=!0,this.setThemeAccordingToDashboardSettings())}.bind(t),t.el.innerHTML=x.app({id:t.cid}),t.globalPalette=e.dashboardAppModel.get("globalPalettes"),t.api.setProperty("possiblePalettes",_.map(_.uniqBy(t.globalPalette,"rule"),"rule")),t}return b=t.View,r(P,b),P.prototype.onSettingsChange=function(e){this.ignoreSettingsChange||(e=d.expandNestedViewStates(e,this.api),e=d.replaceViewStatesWithValue("",e,this.api),e=d.pump(e),this.onSettingsChangeProcessed.call(this,e))},P.prototype.updateDataSource=function(r,e){var t=this,i=(this.setIgnoreSettings(!0),r.getColumnNames());this.api.setProperty("possibleAxis",i,{silent:!0}),this.api.setProperty("possibleColumns",i,{silent:!0}),this.dataSources[r.getKey()]&&(e?(this.setPossibleAxes(e,i),e.updateData(r)):this.layers.filter(function(e,t){e=e.getData();return e&&e.cid===r.getKey()}).forEach(function(e){t.setPossibleAxes(e,i),e.updateData(r)})),this.setIgnoreSettings(!1),d.safeHandle(this.initializeChart.bind(this)).call(this)},P.prototype.updateError=function(e,t){function r(e){return"Error"===e?3:"Loading"===e?2:"NoResults"===e?1:0}var i=this,e=e.getKey(),a={},e=(t&&(a[e]=t),_.reduce(a,function(e,t){t=t.type;return r(t)>r(e)?t:e},""));e&&("NoResults"!==e||Object.keys(this.dataSources).length===Object.keys(a).length)?(t=_.map(a,function(e,t){e=e.error,t=i.dataSources[t];return e?"["+t.getPath()+"]: "+e:null}).filter(function(e){return e}),this.api.showQueryStatus({error:t.join("\n"),type:e})):this.api.hideQueryStatus()},P.prototype.onSettingsChangeProcessed=function(e){_.isObject(e.Basics)&&this.onSettingsBasicsChanged.call(this,e.Basics),_.isObject(e.Layers)&&this.onSettingsLayersChanged.call(this,e),_.isObject(e.Position)&&this.setCameraPosition(),(_.isObject(e.X)||_.isObject(e.Y)||_.isObject(e.Z)||_.isObject(e.Volume)||_.isObject(e.Style))&&this.onSettingsOnData(e,"X"),_.isObject(e.Style)&&this.onStyleChanged(e.Style),_.isObject(e.format)&&this.onSettingsOnFormat(e)},P.prototype.onStyleChanged=function(r){var i,a,e,t,o,s,n;r.palettes&&(i=""+(null==(e=this.dashboardViewModel)?void 0:e.get("DashboardTheme")),a=".palette_theme",e=this.api.getProperty("Style.palettes"),t=_.filter(this.globalPalette,function(e){var t=".dark"!==_.get(e,"theme")&&".light"!==_.get(e,"theme")||e.theme.toLowerCase()==="."+i.toLowerCase();return e.rule===a&&t}),o=(_.isEmpty(e)||" "===e||e===a)&&0<t.length,s=!1,n=[],o&&_.each(t,function(e){n.push({type:p.Tools.rgbStr2hex(e.color)}),s=!0}),_.each(this.globalPalette,function(e){var t=!_.get(e,"theme")||e.theme.toLowerCase()==="."+i.toLowerCase();e.rule===r.palettes&&t&&!o&&(n.push({type:p.Tools.rgbStr2hex(e.color)}),s=!0)}),s)&&this.api.setProperty("Style.ColorPalette.ColorScheme",n)},P.getNewLayerId=function(e){for(var t=0;e["L"+t];)t++;return"L"+t},P.prototype.onSettingsLayersChanged=function(e){var o=this,s=e.Layers,n=_.reduce(s,function(e,t){return e[t[P.PROP_LAYER_ID]]=!0,e},{});_.each(this.layers,function(e){void 0===e||n[e.getId()]||o.layers.splice(o.layers.indexOf(e),1)}),_.each(this.layers,function(t){var e=_.findIndex(s,function(e){return e._Id===t.getId()});t.index!==e&&(t.index=e)}),s.forEach(function(e,t){var r,i=e[P.PROP_LAYER_ID],e=(_.isEmpty(i)&&(i=e[P.PROP_LAYER_ID]=P.getNewLayerId(n),n[i]=!0,o.api.setProperty(P.PROP_LAYERS+"."+t+"."+P.PROP_LAYER_ID,i,{silent:!0})),e.Name),e=(_.isEmpty(e)&&o.api.setProperty(P.PROP_LAYERS+"."+t+".Name","Layer "+(t+1),{silent:!0}),_.find(o.layers,function(e){return e.getId()===i})),a=_.findIndex(s,function(e){return e._Id===i});e||(e=new u(a,i,o.api),o.layers.push(e),r=o.api.getProperty(P.PROP_LAYERS+"."+(t-1)),a=o.api.getProperty(P.PROP_LAYERS+"."+t).Data,r&&(r.Data&&!a&&o.api.setProperty(P.PROP_LAYERS+"."+t+".Data",r.Data,{silent:!0}),["possibleLayerAxis","XAxis","YAxis","ZAxis","Volume"].forEach(function(e){o.api.setProperty(P.PROP_LAYERS+"."+t+"."+e,r[e],{silent:!0})})))}),this.updateLayersData(s.filter(function(e){return e.Data}))},P.prototype.updateLayersData=function(e){var i=this;e.forEach(function(e){var t=e.Data,r=i.dataSources[t.cid];r?r.hasData()&&i.updateDataSource(r,i.layers[e.index]):(r=new o(t,i,i.api,i.focus),(i.dataSources[t.cid]=r).subscribe())})},P.prototype.onSettingsOnFormat=function(e){this.initializeChart()},P.prototype.onSettingsOnData=function(e,t){this.updateLayersData(this.api.getProperty(P.PROP_LAYERS)),this.initializeChart()},P.prototype.onSettingsBasicsChanged=function(e){var t=this;void 0!==e.Focus&&(this.focus=_.first(d.focus2Array(e.Focus))||[],_.each(this.dataSources,function(e){e.setFocus(t.focus)}))},P.prototype.labelFormat=function(e,t){var r=this.api.getProperty(e+".Format"),i=this.api.getProperty(e+".Precision"),a=this.api.getProperty(e+".DateFormat"),o=this.api.getProperty(e+".AxisType"),s=this.api.getProperty(e+".DateFormat"),n=this.api.getProperty(e+".Prefix"),p=this.api.getProperty(e+".Suffix");return"Category"===o&&this.layers[0]&&_.get(this.layers[0],"axisCache")&&(t=(e=this.layers[0].axisCache[e.toLowerCase()])?e[t]:t),"Time"===o&&_.isNumber(t)?l(t).format(s):n+d.getFormatter(""===r?"General":r,""===i?0:i,!1,a)(t)+p},P.prototype.initializeChart=function(){var e,s=this,i=this.api.getProperty("Style.VerticalRatio"),a=this.el.querySelector("."+this.cid),o=this.api.getProperty("Style.fill"),n=this.api.getProperty("Style.KeepAspectRatio"),p=this.api.getProperty("Style.ColorPalette.ColorScheme"),l=0<p.length?p[0].type:"#F8696B",u=this.api.getProperty("Style.stroke"),d=[],c=[];this.layers.forEach(function(e,t){var t=s.api.getProperty("Layers."+t+"._Type"),r="dot-color"===t?_.reverse(_.map(p,function(e){return e.type})):l,e=_.get(e,"chartData");e&&e.length&&(d.push(e),r={axisColor:u,backgroundColor:{fill:o,stroke:"rgba(0,0,0,0)"},dataColor:{fill:r.toString(),stroke:"line"===t?l:u},height:a.offsetHeight+"px",keepAspectRatio:n,onclick:function(e){s.onClick(e)},showGrid:!0,showPerspective:!0,showShadow:!1,style:t,tooltip:function(e){var t="",r=s.api.getProperty("Style.advancedTooltip"),i=h.compile(r);try{var a=s.api.getTemplateViewStates(r),o=s.getTooltipData(e.data),t=i(_.assignIn(o,a))}catch(e){t=""}return t},tooltipStyle:{content:{background:"rgba(0, 0, 0, 0.8)",borderRadius:"6px",color:"white"}},valueMax:s.axisMax("Volume"),valueMin:s.axisMin("Volume"),verticalRatio:i/100,width:a.offsetWidth+"px",xLabel:s.api.getProperty("X.Label"),xMax:s.axisMax("X"),xMin:s.axisMin("X"),xValueLabel:function(e){return s.labelFormat("X",e)},yLabel:s.api.getProperty("Y.Label"),yMax:s.axisMax("Y"),yMin:s.axisMin("Y"),yValueLabel:function(e){return s.labelFormat("Y",e)},zLabel:s.api.getProperty("Z.Label"),zMax:_.isNil(s.axisMax(""))?s.getRoundedMax(e._data,"z"):s.axisMax("Volume"),zMin:s.axisMin("Z"),zValueLabel:function(e){return s.labelFormat("Z",e)}},c.push(r))}),c.length&&((e=new y.Graph3d(a,d,c)).off("cameraPositionChange",null),e.on("cameraPositionChange",this.onCameraPositionChange.bind(this)),this.chart=e,this.setCameraPosition())},P.prototype.getRoundedMax=function(e,t){e=_.get(_.maxBy(_.values(e),t),t)+1;return 4<Math.log10(e)?5*Math.ceil(e/5):e},P.prototype.getTooltipData=function(e){var t=this.api.getProperty("X.Label"),r=this.api.getProperty("Y.Label"),i=this.api.getProperty("Z.Label");return{points:[{cols:e.data,style:e.style,x:e.x,xLabel:t,y:e.y,yLabel:r,z:e.z,zLabel:i}]}},P.prototype.onClick=function(e){var t=this.api.getProperty("Basics.SelectedAttr"),e=e.data[t];this.api.setProperty("Basics.Selected",e,!0);var t=this.layers[0].getData(),t=this.dataSources[t.cid].getDepth(),r=_.clone(this.focus);r[t]=e&&e.toString?e.toString():""+e,this.api.setProperty("Basics.Focus",r.join(","),!0)},P.prototype.onCameraPositionChange=function(e){this.api.setProperty("Position.Horizontal",e.horizontal),this.api.setProperty("Position.Vertical",e.vertical),this.api.setProperty("Position.Distance",e.distance)},P.prototype.axisMin=function(e){var t=this.api.getProperty(e+".UseMin"),e=this.api.getProperty(e+".AxisMin");return t?parseFloat(e):void 0},P.prototype.axisMax=function(e){var t=this.api.getProperty(e+".UseMax"),e=this.api.getProperty(e+".AxisMax");return t?parseFloat(e):void 0},P.prototype.setCameraPosition=function(){var e,t,r;this.layers&&0<this.layers.length&&(e=this.api.getProperty("Position.Horizontal"),t=this.api.getProperty("Position.Vertical"),r=this.api.getProperty("Position.Distance"),this.chart)&&this.chart.setCameraPosition({distance:_.isNaN(r)?2.5:r,horizontal:_.isNaN(e)?.0873:e,vertical:_.isNaN(t)?.001241:t})},P.prototype.setIgnoreSettings=function(e){this.ignoreSettingsChange=e},P.prototype.setPossibleAxes=function(i,a){var o=this;this.api.setProperty("Layers."+i.index+".possibleLayerAxis",a);["XAxis","YAxis","ZAxis","Volume"].forEach(function(e,t){var r=o.api.getProperty("Layers."+i.index+"."+e);-1===a.indexOf(r)&&o.api.setProperty("Layers."+i.index+"."+e,a[t]||a[0])})},P.prototype.onResizeStop=function(){d.safeHandle(this.initializeChart.bind(this)).call(this)},P.prototype.setTheme=function(e){var t="";"Light"===e?t="#000000":"Dark"===e&&(t="#FFFFFF"),e=e.toLowerCase(),this.api.setProperty("Style.stroke",t),this.el.classList.remove("light"),this.el.classList.remove("dark"),this.el.classList.add(e)},P.prototype.setThemeAccordingToDashboardSettings=function(){this.isReadyForThemeChange&&this.setTheme(this.dashboardViewModel.get("DashboardTheme"))},P.getComponentDefinition=f.getComponentDefinition,P.PROP_LAYER_ID="_Id",P.PROP_LAYERS="Layers",P});
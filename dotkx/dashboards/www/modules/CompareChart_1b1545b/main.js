define(["Handlebars","QuickBase","d3","moment","nv","xlsx","backbone","css!./css/app.css"],function(a,p,m,s,W,j,e){"use strict";var o,r,i=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}))(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),n=this&&this.__assign||function(){return(n=Object.assign||function(t){for(var e,r=1,o=arguments.length;r<o;r++)for(var a in e=arguments[r])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},l=(r=e.DeepModel,i(c,r),c.prototype.initialize=function(t){},c.prototype.updateData=function(i){var t,e,r,o,a,n,s,l;i?(this.chartData={},n=this.get("Labels.Label"),t=this.get("NodeLabels.Format")?this.get("NodeLabels.Format"):"General",e=this.get("NodeLabels.Precision")?this.get("NodeLabels.Precision"):0,r=!!this.get("NodeLabels.HideTrailingZeroes")&&this.get("NodeLabels.HideTrailingZeroes"),o=this.get("NodeLabels.DateFormat")?this.get("NodeLabels.DateFormat"):"YYYY-MM-DD",void 0!==n&&(n=n.startsWith("/")&&n.endsWith("/")?n.substring(1,n.length-1):"^"+n.replace(/\*/g,"(.*)")+"$",a=new RegExp(n),n=i.getColumnNames().filter(function(t){return t.match(a)}),s=[],l=S.getFormatter(t,e,r,o),_.each(n,_.bind(function(r){_.each(this.get("Data"),_.bind(function(t){var e,o,a,t=t.Column;void 0!==t&&(t=t.startsWith("/")&&t.endsWith("/")?t.substring(1,t.length-1):"^"+t.replace(/\*/g,"(.*)")+"$",e=new RegExp(t),t=i.getColumnNames().filter(function(t){return t.match(e)}),this.labelData=i.getData().map(function(t){return t.get(i.getPropertyFromColumn(r))}),o=this.labelData,a=_.fromPairs(_.map(this.get("Data"),function(t){return[t.Column,t.Display]})),_.each(t,function(r){i.getData().map(function(t,e){return[o[e],t.get(r),r,0]}),s=_.union(s,i.getData().map(function(t,e){return[l(o[e]),a[r]||r,t.get(r),0]}))}),this.chartData={data:s},this.updateVisuals())},this))},this))),this.updateVisuals()):this.initialize()},c.prototype.updateVisuals=function(){this.format=this.computeDataSetProps()},c.prototype.calcRange=function(t,e,r){return e+t/100*(Math.abs(r)-Math.abs(e))},c.prototype.getWidth=function(){var t=this.get("NodeLabels.Show")?"display":"none",e=this.get("NodePercentages.Show")?"display":"none",r=this.get("NodeValues.Show")?"display":"none",o=this.get("NodeLabels.Width")?this.get("NodeLabels.Width"):60,a=this.get("NodePercentages.Width")?this.get("NodePercentages.Width"):60,i=this.get("NodeValues.Width")?this.get("NodeValues.Width"):60;return 2*(("none"==t?0:o)+("none"==e?0:a)+("none"==r?0:i))},c.prototype.computeDataSetProps=function(){var e=[],t=(this.get("Style.chartBarColors")&&_.each(_.map(this.get("Style.chartBarColors"),"type"),function(t){e.push(t)}),this.get("Style.labelColor")?this.get("Style.labelColor"):"#eae6df"),r=(this.get("NodeLabels.Position")&&parseInt(this.get("NodeLabels.Position"),10),this.get("NodeLabels.Show")?"display":"none"),o=(this.get("NodePercentages.Position")&&parseInt(this.get("NodePercentages.Position"),10),this.get("NodePercentages.Show")?"display":"none"),a=(this.get("NodeValues.Position")&&parseInt(this.get("NodeValues.Position"),10),this.get("NodeValues.Show")?"display":"none"),i=this.get("NodeValues.Format")?this.get("NodeValues.Format"):"Number",n=this.get("NodeValues.Format")?this.get("NodeValues.Format"):"Number",s={b:this.get("Padding.Bottom")?this.get("Padding.Bottom"):20,t:this.get("Padding.Top")?this.get("Padding.Top"):5,l:this.get("Padding.Left")?this.get("Padding.Left"):0,r:this.get("Padding.Right")?this.get("Padding.Right"):40},l=this.get("NodeLabels.Width")?this.get("NodeLabels.Width"):60,p=this.get("NodePercentages.Width")?this.get("NodePercentages.Width"):60,c=this.get("NodeValues.Width")?this.get("NodeValues.Width"):60,l="none"==r?0:l,p="none"==o?0:p,c="none"==a?0:c,u="none"==o?0:p,d="none"==a?u:c+u;return{colors:e,labelColor:t,decimal:n,labelShow:r,valueShow:a,percentShow:o,c1:[d,20+l+p+c+d],c2:[u,20+l+p+c+u],c3:[0,20+l+p+c],partWidth:l+p+c,minWidth:20,yAxisFormat:"Smart Number"===i?A.smartFormatNumber:void 0,margin:s}},c);function c(){var t=null!==r&&r.apply(this,arguments)||this;return t.colorCache={},t.columns=[],t.labels=[],t.chartData={},t.labelData=[],t.chartType="compareChart",t.previousChartData={},t}u=e.Collection,i(h,u),h.prototype.modelId=function(t){return t};var u,d=h;function h(){var t=null!==u&&u.apply(this,arguments)||this;return t.model=l,t}f.mergeChanges=function(e,r,t,o,a,i){return t&&(e=_.fromPairs(_.map(t,function(t){return[r(t),t]}))),o&&_.each(o,function(t){return _.extend(e[r(t)],t)}),a&&_.each(a,function(t){e[r(t)]=t}),i&&_.each(i,function(t){delete e[r(t)]}),e},f.prototype.setFocus=function(t){this.focus=t,this.updateChildren(),this.childDataSource&&this.childDataSource.setFocus(t)},f.prototype.isFocused=function(){return this.focus.length===this.depth&&(0===this.depth||this.source.id===this.focus[this.depth])},f.prototype.getColumnNames=function(){if(this.breakdownColumns&&this.breakdownColumns.length)return[f.BREAKDOWN_ID,this.breakdownColumns[0]].concat(_.difference(_.keys(this.meta),this.breakdownColumns));try{return _.map(this.meta,function(t){return[t.id,t.index]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}catch(t){return _.keys(this.meta)}},f.prototype.getColumnType=function(t){return this.childDataSource?this.childDataSource.getColumnType(t):t===f.BREAKDOWN_ID?this.meta[this.primaryKey].kdbType:this.meta[t]?this.meta[t].kdbType:11},f.prototype.getData=function(){return this.childDataSource?this.childDataSource.getData():this.source.dataSet&&this.source.dataSet.collection},f.prototype.getDepth=function(){return this.childDataSource?this.childDataSource.getDepth():this.depth},f.prototype.getKey=function(){return this.source.cid},f.prototype.getPrimaryKey=function(){return this.childDataSource?this.childDataSource.getPrimaryKey():this.primaryKey},f.prototype.getPropertyFromColumn=function(t){return t===f.BREAKDOWN_ID?this.getPrimaryKey():t},f.prototype.getPath=function(){return this.source.path},f.prototype.getSource=function(){return this.source},f.prototype.hasData=function(){return this.childDataSource?this.childDataSource.hasData():this.hasDataFlag},f.prototype.onData=function(t,e,r){t.primaryKey!==this.primaryKey&&(this.primaryKey=t.primaryKey),this.meta=f.mergeChanges(this.meta,function(t){return t.id},t.columns.reset,t.columns.change,t.columns.add,t.columns.remove),0!==this.depth||_.isEqual(t.breakdownColumns,this.breakdownColumns)||(this.breakdownColumns=t.breakdownColumns,this.removeChild()),e.reset&&0<e.reset.length&&this.removeChild(),r?this.updateError(this,r):this.listener&&this.listener.updateError(this,void 0),this.hasDataFlag=!0,this.updateChildren()&&this.listener.updateDataSource(this)},f.prototype.subscribe=function(){this.api.subscribe(this.source,this.onData.bind(this))},f.prototype.updateDataSource=function(t){this.listener.updateDataSource(this)},f.prototype.updateError=function(t,e){this.listener.updateError(this,e)},f.prototype.unsubscribe=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource),this.api.unsubscribe(this.source)},f.sourceKey=function(t){return t.getPath()},f.prototype.removeChild=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource)},f.prototype.updateChildren=function(){var t;return!(this.breakdownColumns&&this.breakdownColumns.length&&this.depth<this.breakdownColumns.length-1&&(this.focus.length>this.depth?(this.childDataSource&&this.focus[this.depth]!==this.childDataSource.getSource().id&&this.removeChild(),!this.childDataSource&&(0!==this.depth&&(this.focus[this.depth-1],this.source.id),t=this.source.dataSet&&this.source.dataSet.collection.get(this.focus[this.depth]))&&(this.childDataSource=new f(t,this,this.api,this.focus,this.depth+1,this.breakdownColumns),this.childDataSource.subscribe())):(this.removeChild(),this.focus.length!==this.depth||!this.hasDataFlag||0!==this.depth&&this.focus[this.depth-1]!=this.source.id||this.listener.updateDataSource(this)),1))},f.BREAKDOWN_ID="{breakdownId}";var y=f;function f(t,e,r,o,a,i){this.breakdownColumns=[],this.hasDataFlag=!1,this.focus=[],this.meta={},this.source=t,this.listener=e,this.api=r,this.depth=a||0,this.breakdownColumns=i,this.setFocus(o)}g=e.DeepModel,i(v,g),v.prototype.initialize=function(t){},v.prototype.computeLayoutProp=function(t){var e=void 0===this.get("Padding.Top")?0:this.get("Padding.Top"),r=void 0===this.get("Padding.Left")?0:this.get("Padding.Left"),o=void 0===this.get("Padding.Bottom")?0:this.get("Padding.Bottom"),a=void 0===this.get("Padding.Right")?0:this.get("Padding.Right");return{padding:{top:e+t.top,left:r+t.left,right:a+t.right,bottom:o+t.bottom}}};var g,b=v;function v(){return null!==g&&g.apply(this,arguments)||this}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){if(null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),r=1;r<arguments.length;r++){var o=arguments[r];if(null!==o)for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e},writable:!0,configurable:!0});x.expandNestedViewStates=function(t,r){var e,o=Object.keys(t),a=[];return(a=_.every(o,function(t){var e=r.getPropertyMeta(o[0]);return e&&"viewstate"===e.type})?_.uniq(_.filter(_.map(o,function(t){t=/^((?:\w+\.)*)(\d+)/.exec(t);return t?t[1].slice(0,-1):null}),function(t){return null!==t})):a).length?(e={},_.each(a,function(t){return e[t]=r.getProperty(t)}),e):t},x.focus2Array=function(t){var e=[],r=/"([^"]*)"/g,t=t.toString?t.toString():"",o=/^\[([^\]]*)]$/.exec(t);if(null!==o){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(o[1]))for(var a=void 0;null!==(a=r.exec(o[1]));)e.push(_.map(a[1].split(","),function(t){return t.replace(/&#44;/g,",")}))}else e.push(t.split(","));return _.filter(e,function(t){return 0<(""+t).length})},x.getFormatter=function(o,a,i,n){return"Number"===o||"Formatted Number"===o||"Smart Number"===o||"Datetime"===o||"Currency"===o||"SmartCurrency"===o?function(t){var e,r=t;if(null==t)return"";if("Smart Number"===o)r=_.isNumber(t)?A.smartFormatNumber(t,a):_.escape(t);else{if("Datetime"===o)return(s.isMoment(e=t)||s.isDuration(t)?t:A.isKDBTemporal(t)?A.convertKDBTemporalToMoment(t):("number"==typeof t&&(e=new Date(t)),A.convertDateStringValueToMoment(e.toString()))).format(n);r="Formatted Number"===o&&t.toFixed?A.formatNumber(t,a):t.toFixed?t.toFixed(a):_.escape(r)}if(i&&0<=r.toString().indexOf(".")){for(;"0"===r[r.length-1];)r=r.slice(0,-1);"."===r[r.length-1]&&(r=r.slice(0,-1))}return r}:"General"===o?function(t){return s.isMoment(t)||s.isDuration(t)?t.format():_.escape(t)}:"Boolean"===o?function(t){return _.escape(t)}:void 0},x.pump=function(r){var t,o,a;if(null!=r)return!_.isObject(r)||(t=Object.getPrototypeOf(r),_.isObject(r)&&t!==Object.prototype&&t!==Array.prototype)?r:t===Array.prototype?r.map(x.pump):(o=/^(\d+)((?:\.\w+)+)$/,Object.keys(r).every(function(t){return o.test(t)})?Object.keys(r).map(function(t){var e=o.exec(t);return{index:Number(e[1]),tail:e[2].substring(1),value:r[t]}}).reduce(function(t,e){var r={};return r[e.index]={},r[e.index][e.tail]=e.value,$.extend(!0,t,x.pump(r))},[]):(a={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/},Object.keys(r).some(function(t){return a.nonGreedy.test(t)})?Object.keys(r).map(function(t){var e=a.greedy.exec(t);return{head:e[1],tail:""!==e[2]?e[2].substring(1):null,value:r[t]}}).reduce(function(t,e){var r={};return null!==e.tail?(r[e.head]={},r[e.head][e.tail]=e.value):r[e.head]=e.value,$.extend(!0,t,x.pump(r))},{}):_.mapValues(r,x.pump)))},x.replaceViewStatesWithValue=function(t,e,r){return x.replaceViewStates(t,e,function(t,e,r,o){return o.value!==r&&console.warn("viewModel value has changed"),o.value},r)},x.safeHandle=function(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{r.apply(this,t)}catch(t){console.error("oupsies..",t)}}},x.alpha=function(t,e){var r=p.Tools.hex2RGB(t);return r?"rgba(".concat(r[0],",").concat(r[1],",").concat(r[2],",").concat(e/100,")"):new Color(t).alpha(e/100).rgbaString()},x.colorFactory=function(t,e,r){void 0===e&&(e="#4f6aa6"),void 0===r&&(r=80);var o={};return o[t+"Color"]={title:t.replace("Point","").replace("Hover","Hover ").replace("Border","Border ").replace("Background","Background ")+"Color",type:"gradient",default:e,options:{gradient:!1}},o[t+"Opacity"]={title:t.replace("Point","").replace("Hover","Hover ").replace("Border","Border ").replace("Background","Background ")+"Opacity",default:r,minimum:0,maximum:100,type:"number",step:1,format:"range"},o},x.replaceViewStates=function(r,t,s,l){var p=function(t,e){return function r(t,e,o){o=o?o+".":"";e+="";var a=l.getPropertyMeta(o+e);{var i,n;return a&&"data"===a.type?t:a&&"viewstate"===a.type?(n=(o+e).split("."),i=n.pop(),n=n.join("."),s(n,i,t,a)):!_.isArray(t)&&!_.isObject(t)||t.has&&t.has("_dataSource")&&t.has("_dataType")?t:(o+=e,p=function(t,e){return r(t,e,o)},(c=_.isArray(t)?_.map:_.mapValues)(t,p))}}(t,e,r||"")},c=_.isArray(t)?_.map:_.mapValues;return c(t,p)};var S=x;function x(){}var w={Trigger:{type:"string",enum:["Click","Hover"],default:"Click",title:"Trigger Action",propertyOrder:2,options:{hidden:!0}}},D=(C.getComponentDefinition=function(t){var e,r,o={id:1,componentName:"CompareChart",componentDescription:"",version:"v2.3.0.1",appArgs:{quickStart:[{path:"Basics.Data"}],json:{version:"4.7.7",Basics:{Name:"",Data:"",Theme:"Dark",Focus:"",Actions:[]},Labels:{Label:""},Data:[{Column:"",Display:"",Color:""}],Padding:{Top:5,Bottom:20,Left:0,Right:40},Style:{palettes:[],chartBarColors:[{type:"#0061FF"},{type:"#F23A66"},{type:"#009BAB"},{type:"#7647CC"},{type:"#FFC300"},{type:"#9FA3A6"},{type:"#003A99"},{type:"#A90B31"},{type:"#005D67"},{type:"#452481"}],advanced:"",advancedTooltip:"<div>Value : {{value}}</div>",labelColor:"#404040"},FileExport:{ShowScreenshot:!1,ShowExportCsvButton:!1,ShowExportExcelButton:!1,ScreenshotButton:"Export Png",FileName:[]},NodePercentages:{Show:!1,Position:0,Width:40},NodeValues:{Show:!0,Position:0,Format:"Number",Precision:0,Width:40},NodeLabels:{Show:!0,Position:0,Format:"General",Precision:0,DateFormat:"YYYY-MM-DD",HideTrailingZeroes:!1,Width:90},possibleColumns:[""],possibleLabels:[""],possiblePalettes:[""]},schema:{type:"object",title:"Properties",properties:{possiblePalettes:{propertyOrder:2,type:"array",format:"table",default:[""],options:{collapsed:!0,hidden:!0}},possibleLabels:{type:"array",propertyOrder:1,format:"table",items:{type:"string"},default:["sym"],options:{collapsed:!0,hidden:!0}},possibleColumns:{propertyOrder:2,type:"array",format:"table",items:{type:"string"},default:["sym"],options:{collapsed:!0,hidden:!0}},possibleRules:{type:"array",propertyOrder:1,format:"table",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},possibleCalcs:{type:"array",propertyOrder:1,format:"table",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",propertyOrder:3,title:"Basics",options:{collapsed:!1},properties:{Name:{title:"Name",type:"string",default:""},Data:{type:"data",format:"string",title:"Data Source",default:""},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},Focus:{type:"viewstate",title:"Focus",default:""},ChartType:{options:{hidden:!0}},Actions:{type:"actions",options:{collapsed:!0},fields:{map:_.extend({Current:{title:"Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.possibleColumns"},propertyOrder:10},ViewstateProperty:{title:"Viewstate",type:"viewstate"}},w),nav:w,query:w,url:w}}}},Labels:{type:"object",propertyOrder:4,title:"LHS Data",options:{collapsed:!0},properties:{Label:{propertyOrder:1,default:"",title:"Series Key",type:"customDropdown",data:"possible_labels",watch:{possible_labels:"root.possibleLabels"}}}},Data:{type:"array",propertyOrder:5,format:"object",title:"RHS Data",uniqueItems:!1,options:{collapsed:!0},items:{type:"object",title:"Data",properties:{Column:{default:"",title:"Series Data",type:"customDropdown",data:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},Display:{type:"string",default:"",title:"Display"},Color:{type:"gradient",options:{gradient:!1,hidden:!0},title:"Color",default:"#0061FF"}}}},Padding:{type:"object",title:"Padding",propertyOrder:8,options:{collapsed:!0},properties:{Left:{type:"number",default:2},Right:{type:"number",default:2},Top:{type:"number",default:2},Bottom:{type:"number",default:2}}},Style:{type:"object",propertyOrder:8,title:"Style",options:{collapsed:!0},properties:{palettes:{default:"",title:"Palette Theme",propertyOrder:1,type:"string",enumSource:"possible_palettes",watch:{possible_palettes:"root.possiblePalettes"}},chartBarColors:{type:"array",format:"table",title:"Color Palette",propertyOrder:2,options:{collapsed:!1},uniqueItems:!1,items:{type:"object",title:"Bar Colour",properties:{type:{type:"gradient",options:{gradient:!1},title:"color",default:"#0061FF"}}},default:[{type:"#0061FF"},{type:"#F23A66"},{type:"#009BAB"},{type:"#7647CC"},{type:"#FFC300"},{type:"#9FA3A6"},{type:"#003A99"},{type:"#A90B31"},{type:"#005D67"},{type:"#452481"}]},advanced:{type:"css",title:"Advanced CSS",propertyOrder:3,default:""},advancedTooltip:{type:"tooltipTemplate",title:"Custom tooltip",propertyOrder:4,data:["xaxis","yaxis","key","color"],default:"<div>Value : {{value}}</div>"},labelColor:{type:"gradient",options:{gradient:!1},propertyOrder:5,title:"Text Colour",default:"#404040"}}},FileExport:{type:"object",propertyOrder:320,title:"File Export",options:{collapsed:!0},properties:{ShowExportCsvButton:{type:"boolean",title:"Show Export Csv Button",default:!1,format:"checkbox"},ShowExportExcelButton:{type:"boolean",title:"Show Export Excel Button",default:!1,format:"checkbox"},ShowScreenshot:{type:"boolean",title:"Show Screenshot Button",default:!1,format:"checkbox"},ScreenshotButton:{default:"Export Png",enum:["Export Png","Copy to Clipboard","Export Png & Copy to Clipboard"],title:"Screenshot Button",type:"string"},FileName:{type:"array",format:"table",title:"FileName",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Filename Part",options:{collapsed:!0},properties:{FileNamePart:{title:"FileName Part",type:"string"}}}}}},NodeLabels:{type:"object",propertyOrder:5,title:"Labels",options:{collapsed:!0},properties:{Show:{type:"boolean",title:"Show",default:!1,propertyOrder:1,format:"checkbox"},Position:{type:"number",title:"Position",default:0,propertyOrder:2,format:"number"},Format:{type:"string",propertyOrder:3,enum:["General","Number","Smart Number","Formatted Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:4,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},HideTrailingZeroes:{type:"boolean",propertyOrder:5,title:"Hide Trailing Zeroes",format:"checkbox",default:!1},DateFormat:{type:"string",propertyOrder:6,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Width:{type:"number",propertyOrder:7,title:"Width",format:"number",default:90}}},NodeValues:{type:"object",propertyOrder:6,title:"Values",options:{collapsed:!0},properties:{Show:{type:"boolean",title:"Show",default:!1,propertyOrder:1,format:"checkbox"},Position:{type:"number",title:"Position",default:0,propertyOrder:2,format:"number"},Format:{type:"string",propertyOrder:3,enum:["Number","Smart Number"],default:"General"},Precision:{type:"number",propertyOrder:4,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},Width:{type:"number",propertyOrder:5,title:"Width",format:"number",default:40}}},NodePercentages:{type:"object",propertyOrder:7,title:"Percentages",options:{collapsed:!0},properties:{Show:{type:"boolean",title:"Show",default:!1,propertyOrder:1,format:"checkbox"},Position:{type:"number",title:"Position",default:0,propertyOrder:2,format:"number"},Width:{type:"number",title:"Width",propertyOrder:3,default:40}}}}}}};if(0<_.keys(t.settingsModel.attributes).length)for(r=C.upgrades.indexOf(_.find(C.upgrades,{version:t.settingsModel.get("version")}))+1;r<C.upgrades.length;r+=1)(e=C.upgrades[r]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return o},C);function C(){}D.upgrades=[{version:0,fn:function(){for(var t=0;t<arguments.length;t++)t,0}},{version:"4.1.0s1",fn:function(t){}},{version:"4.1.0s2",fn:function(t){}},{version:"4.3.0",fn:function(t){void 0===t.get("NodeLabels")&&t.set("NodeLabels",{Show:!0,Position:0,Format:"General",Precision:0,DateFormat:"YYYY-MM-HH",HideTrailingZeroes:!1}),void 0===t.get("NodeValues")&&t.set("NodeValues",{Show:!0,Position:0,Format:"Number",Precision:0,Width:40}),void 0===t.get("NodePercentages")&&t.set("NodePercentages",{Show:!1,Position:0,Width:40});t.unset("notificationEvent");t=t.get("format");delete t.showBreadCrumbs,delete t.showControls,delete t.reduceXTicks,delete t.groupSpacing,delete t.rotateLabels,delete t.maxChartElements,delete t.yAxisFormat,delete t.labelShow,delete t.labelPosition,delete t.labelFormat,delete t.valueShow,delete t.valuePosition,delete t.valueFormat,delete t.percentPosition,delete t.percentFormat,delete t.percentShow}},{version:"4.3.0.1",fn:function(t){var e=t.get("Style");e.labelColor=void 0===e.labelColor?"#404040":e.labelColor,t.set("Style",e)}},{version:"4.3.0.2",fn:function(t){var e=t.get("Basics");e.Actions=void 0===e.Actions?[]:e.Actions,t.set("Basics",e)}},{version:"4.5.1",fn:function(t){var e=t.get("NodeLabels"),r=t.get("NodePercentages"),o=t.get("NodeValues");e.Width=void 0===e.Width?90:e.Width,r.Width=void 0===r.Width?40:r.Width,o.Width=void 0===o.Width?40:o.Width,t.set("NodeLabels",e),t.set("NodePercentages",r),t.set("NodeValues",o)}},{version:"4.7.7",fn:function(t){t.get("Basics.Name")||t.set("Basics.Name","")}},{version:"v2.3.0.1",fn:function(t){void 0===t.get("FileExport.ScreenshotButton")&&t.set("FileExport.ScreenshotButton","Export Png")}}];N.prototype.on=function(t){this.handlers.push(t)},N.prototype.off=function(e){this.handlers=this.handlers.filter(function(t){return t!==e})},N.prototype.trigger=function(e){this.handlers.slice(0).forEach(function(t){return t(e)})},N.prototype.expose=function(){return this};var P=N;function N(){this.handlers=[]}Object.defineProperty(T.prototype,"ShowTooltip",{get:function(){return this.onTooltipShow.expose()},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"HideTooltip",{get:function(){return this.onTooltipHide.expose()},enumerable:!1,configurable:!0}),T.prototype.partData=function(t,e){var r={};return r.keys=[m.set(t.map(function(t){return t[0]})).values(),m.set(t.map(function(t){return t[1]})).values()],r.data=[r.keys[0].map(function(t){return r.keys[1].map(function(t){return 0})}),r.keys[1].map(function(t){return r.keys[0].map(function(t){return 0})})],t.forEach(function(t){r.data[0][r.keys[0].indexOf(t[0])][r.keys[1].indexOf(t[1])]=t[e],r.data[1][r.keys[1].indexOf(t[1])][r.keys[0].indexOf(t[0])]=t[e]}),r},T.prototype.visualize=function(e){var a={};function i(o,a,i,n,s){var l=m.sum(o),e=0,p=0,c=i-a-2*n*o.length,u=[],r=(o.forEach(function(t){var e=0==l?0:t/l,r=e*(i-a-2*n*o.length),t=(r==s?c-=s:p+=r,{middle:0,y:0,h:0,key1:0,key2:0,value:t,percent:e,height:r});u.push(t)}),c/Math.max(p,1)),e=0;return u.forEach(function(t){t.percent=r*t.percent,t.height=t.height==s?s:t.height*r,t.middle=e+n+t.height,t.y=a+t.middle-t.percent*(i-a-2*n*o.length),t.h=t.percent*(i-a-2*n*o.length),t.percent=0==l?0:t.value/l,e+=2*n+t.height}),u}return a.mainBars=[i(e.data[0].map(function(t){return m.sum(t)}),0,this.height,this.buffMargin,this.minHeight),i(e.data[1].map(function(t){return m.sum(t)}),0,this.height,this.buffMargin,this.minHeight)],a.subBars=[[],[]],a.mainBars.forEach(function(t,o){t.forEach(function(t,r){i(e.data[o][r],t.y,t.y+t.h,0,0).forEach(function(t,e){t.key1=0==o?r:e,t.key2=0==o?e:r,a.subBars[o].push(t)})})}),a.subBars.forEach(function(t){t.sort(function(t,e){return t.key1<e.key1?-1:t.key1>e.key1?1:t.key2<e.key2?-1:t.key2>e.key2?1:0})}),a.edges=a.subBars[0].map(function(t,e){return{key1:t.key1,key2:t.key2,y1:t.y,y2:a.subBars[1][e].y,h1:t.h,h2:a.subBars[1][e].h}}),a.keys=e.keys,a},T.prototype.arcTween=function(t){var e=this,r=m.interpolate(this._current,t);return this._current=r(0),function(t){return e.edgePolygon(r(t))}},T.prototype.drawPart=function(r,t,o){var a=this,e=(m.select("#"+t).append("g").attr("class","part"+o).attr("transform","translate("+o*(this.bb+this.minHeight)+",0)"),m.select("#"+t).select(".part"+o).append("g").attr("class","subbars"),m.select("#"+t).select(".part"+o).append("g").attr("class","mainbars"),m.select("#"+t).select(".part"+o).select(".mainbars").selectAll(".mainbar").data(r.mainBars[o]).enter().append("g").attr("class","mainbar"));e.append("rect").attr("class","mainrect").attr("x",100).attr("y",function(t){return t.middle-t.height}).attr("width",this.minHeight).attr("height",function(t){return t.height}).style("shape-rendering","auto").style("fill-opacity",0).style("stroke-width","0.5").style("stroke","black").style("stroke-opacity",0),e.append("text").attr("class","barlabel").attr("x",this.c1[o]).attr("y",function(t){return t.middle+5}).text(function(t,e){return 9<r.mainBars[o][e].height?r.keys[o][e]:""}).attr("text-anchor","start").attr("display",this.displayLabel),e.append("text").attr("class","barvalue").attr("x",this.c2[o]).attr("y",function(t){return t.middle+5}).text(function(t,e){return 9<r.mainBars[o][e].height?[a.smartNumberFormatter?a.smartNumberFormatter(t.value):t.value.toFixed(a.decimalPlaces)]:""}).attr("text-anchor","start").attr("display",this.displayValue),e.append("text").attr("class","barpercent").attr("x",this.c3[o]).attr("y",function(t){return t.middle+5}).text(function(t,e){t=a.smartNumberFormatter?a.smartNumberFormatter(100*t.percent):(100*t.percent).toFixed(a.decimalPlaces);return 9<r.mainBars[o][e].height?["( "+t+"%) "]:""}).attr("text-anchor","start").style("fill","grey").attr("display",this.displayPercent),m.select("#"+t).select(".part"+o).select(".subbars").selectAll(".subbar").data(r.subBars[o]).enter().append("rect").attr("class","subbar").attr("x",this.partWidth).attr("y",function(t){return t.y}).attr("width",this.minHeight).attr("height",function(t){return t.h}).style("fill",function(t){return a.colors[t.key1]})},T.prototype.drawEdges=function(t,e){var r=this;m.select("#"+e).append("g").attr("class","edges").attr("transform","translate("+(this.minHeight+this.partWidth)+",0)"),m.select("#"+e).select(".edges").selectAll(".edge").data(t.edges).enter().append("polygon").attr("class","edge").attr("points",this.edgePolygon).style("fill",function(t){return r.colors[t.key1]}).style("opacity",.5).each(function(t){r._current=t})},T.prototype.drawHeader=function(r,o){var a=this;m.select("#"+o).append("g").attr("class","header").append("text").text(r[2]).style("font-size","20").attr("x",108).attr("y",-20).style("text-anchor","middle").style("font-weight","bold"),[0,1].forEach(function(t){var e=m.select("#"+o).select(".part"+t).append("g").attr("class","header");e.append("text").text(r[t]).attr("x",a.c1[t]-5).attr("y",-5).style("fill","grey").style("display","none"),e.append("text").text("Count").attr("x",a.c2[t]-10).attr("y",-5).style("fill","grey").style("display","none"),e.append("line").attr("x1",a.c1[t]-10).attr("y1",-2).attr("x2",a.c3[t]+10).attr("y2",-2).style("stroke","black").style("stroke-width","1").style("shape-rendering","crispEdges").style("display","none")})},T.prototype.edgePolygon=function(t){return[0,t.y1,this.bb,t.y2,this.bb,t.y2+t.h2,0,t.y1+t.h1].join(" ")},T.prototype.transitionPart=function(r,t,o){var a=this,e=m.select("#"+t).select(".part"+o).select(".mainbars").selectAll(".mainbar").data(r.mainBars[o]);e.select(".mainrect").transition().duration(500).attr("y",function(t){return t.middle-t.height/2}).attr("height",function(t){return t.height}),e.select(".barlabel").transition().duration(500).attr("y",function(t){return t.middle-t.height/2}),e.select(".barvalue").transition().duration(500).attr("y",function(t){return t.middle-t.height/2}).text(function(t,e){return 9<r.mainBars[o][e].height?[a.smartNumberFormatter?a.smartNumberFormatter(t.value):t.value.toFixed(a.decimalPlaces)]:""}),e.select(".barpercent").transition().duration(500).attr("y",function(t){return t.middle-t.height/2}).text(function(t,e){t=a.smartNumberFormatter?a.smartNumberFormatter(100*t.percent):(100*t.percent).toFixed(a.decimalPlaces);return 9<r.mainBars[o][e].height?["( "+t+"%) "]:""}),m.select("#"+t).select(".part"+o).select(".subbars").selectAll(".subbar").data(r.subBars[o]).transition().duration(500).attr("y",function(t){return t.y}).attr("height",function(t){return t.h})},T.prototype.transitionEdges=function(t,e){var r=this;m.select("#"+e).append("g").attr("class","edges").attr("transform","translate("+this.minHeight+",0)"),m.select("#"+e).select(".edges").selectAll(".edge").data(t.edges).transition().duration(500).attrTween("points",function(t){var e=m.interpolate(r._current,t);return r._current=e(0),function(t){return r.edgePolygon(e(t))}}).style("opacity",function(t){return 0==t.h1||0==t.h2?0:.5})},T.prototype.transition=function(t,e){this.transitionPart(t,e,0),this.transitionPart(t,e,1),this.transitionEdges(t,e)},T.prototype.draw=function(n,e){var s=this;n.forEach(function(i,a){e.append("g").attr("id",i.id).attr("transform","translate("+1e3*a+",0)");var t=s.visualize(i.data);s.drawPart(t,i.id,0),s.drawPart(t,i.id,1),s.drawEdges(t,i.id),s.drawHeader(i.header,i.id),[0,1].forEach(function(o){m.select("#"+i.id).select(".part"+o).select(".mainbars").selectAll(".mainbar").on("mouseover",function(t,e){var r=m.select("#"+i.id).select(".part"+o).select(".subbars").selectAll(".subbar")[a][e];return s.onTooltipShow.trigger({data:t,dataIndex:e,seriesIndex:a,svg:r}),s.selectSegment(n,o,e)}).on("mouseout",function(t,e){return s.onTooltipHide.trigger(),s.deSelectSegment(n,o,e)})}),[0,1].forEach(function(a){m.select("#"+i.id).select(".part"+a).select(".subbars").selectAll(".subbar").on("mouseover",function(t,e,r){var o=m.select("#"+i.id).select(".part"+a).select(".subbars").selectAll(".subbar")[r][e];return s.onTooltipShow.trigger({data:t,dataIndex:e,seriesIndex:r,svg:o}),s.selectSegment(n,a,t["key"+(a+1)])}).on("mouseout",function(t){return s.onTooltipHide.trigger(),s.deSelectSegment(n,a,t["key"+(a+1)])})})}),this.selectSegment(n,0,0)},T.prototype.selectSegment=function(t,r,o){var a=this;t.forEach(function(t){var e={keys:[],data:{}},e=(e.keys=t.data.keys.map(function(t){return t}),e.data[r]=_.map(t.data.data[r],function(t){return t}),e.data[1-r]=_.map(t.data.data[1-r],function(t){return t.map(function(t,e){return o==e?t:0})}),a.transition(a.visualize(e),t.id),m.select("#"+t.id).select(".part"+r).select(".mainbars").selectAll(".mainbar").filter(function(t,e){return e==o}));e.select(".mainrect").style("stroke-opacity",1),e.select(".barlabel").style("font-weight","bold"),e.select(".barvalue").style("font-weight","bold"),e.select(".barpercent").style("font-weight","bold")})};var H=T;function T(t,e,r,o,a,i,n,s,l,p,c,u,d){var h=this;this.buffMargin=1,this.onTooltipShow=new P,this.onTooltipHide=new P,this.deSelectSegment=function(t,e,r){t.forEach(function(t){h.transition(h.visualize(t.data),t.id);t=m.select("#"+t.id).select(".part"+e).select(".mainbars").selectAll(".mainbar").filter(function(t,e){return e==r});t.select(".mainrect").style("stroke-opacity",0),t.select(".barlabel").style("font-weight","normal"),t.select(".barvalue").style("font-weight","normal"),t.select(".barpercent").style("font-weight","normal")})},this.minHeight=l,this.height=e,this.colors=t,this.decimalPlaces=o,this.bb=r,this.c1=a,this.c2=i,this.c3=n,this.partWidth=s,this.displayLabel=p,this.displayValue=c,this.displayPercent=u,this.smartNumberFormatter=d}m.tip=function(){var t,i=function(){return"n"},n=function(){return[0,0]},s=function(){return" "},l=((t=m.select(document.createElement("div"))).style({position:"absolute",opacity:0,pointerEvents:"none",boxSizing:"border-box"}),t.node()),e=null,p=null,c=null;function u(t){e="svg"===(t=(t=t).node()).tagName.toLowerCase()?t:t.ownerSVGElement,p=e.createSVGPoint(),e.parentNode.appendChild(l)}u.show=function(){var t=Array.prototype.slice.call(arguments),e=(t[t.length-1]instanceof SVGElement&&(c=t.pop()),s.apply(this,t)),r=(n.apply(this,t),i.apply(this,t)),o=m.select(l),a=0;for(o.html(e).style({opacity:1,"pointer-events":"all"});a--;)o.classed(h[a],!1);return d.get(r).apply(this),e=t[4]<100?t[4]+50:t[4]-50,o.classed(r,!0).style({top:e+"px",left:t[3]+20+"px"}),parseInt($(o[0]).css("left"),10)+$(o[0]).width()>$(o[0]).parent().width()&&$(o[0]).css("left",$(o[0]).parent().width()-$(o[0]).width()-40+"px"),parseInt($(o[0]).css("top"),10)+$(o[0]).height()>$(o[0]).parent().height()&&$(o[0]).css("top",$(o[0]).parent().height()-$(o[0]).height()+"px"),u},u.hide=function(){return m.select(l).style({opacity:0,"pointer-events":"none"}),u},u.attr=function(t,e){return arguments.length<2&&"string"==typeof t?m.select(l).attr(t):(t=Array.prototype.slice.call(arguments),m.selection.prototype.attr.apply(m.select(l),t),u)},u.style=function(t,e){return arguments.length<2&&"string"==typeof t?m.select(l).style(t):(t=Array.prototype.slice.call(arguments),m.selection.prototype.style.apply(m.select(l),t),u)},u.direction=function(t){return arguments.length?(i=null===t?t:m.functor(t),u):i},u.offset=function(t){return arguments.length?(n=null===t?t:m.functor(t),u):n},u.html=function(t){return arguments.length?(s=null==t?t:m.functor(t),u):s};var d=m.map({n:function(){var t=r();return{top:t.n.y-l.offsetHeight,left:t.n.x-l.offsetWidth/2}},s:function(){var t=r();return{top:t.s.y,left:t.s.x-l.offsetWidth/2}},e:function(){var t=r();return{top:t.e.y-l.offsetHeight/2,left:t.e.x}},w:function(){var t=r();return{top:t.w.y-l.offsetHeight/2,left:t.w.x-l.offsetWidth}},nw:function(){var t=r();return{top:t.nw.y-l.offsetHeight,left:t.nw.x-l.offsetWidth}},ne:function(){var t=r();return{top:t.ne.y-l.offsetHeight,left:t.ne.x}},sw:function(){var t=r();return{top:t.sw.y,left:t.sw.x-l.offsetWidth}},se:function(){var t=r();return{top:t.se.y,left:t.e.x}}}),h=d.keys();function r(){var t=c||m.event.target,e={},r=t.getScreenCTM(),t=t.getBBox(),o=t.width,a=t.height,i=t.x,t=t.y,n=document.documentElement.scrollTop||document.body.scrollTop,s=document.documentElement.scrollLeft||document.body.scrollLeft;return p.x=i+s,p.y=t+n,e.nw=p.matrixTransform(r),p.x+=o,e.ne=p.matrixTransform(r),p.y+=a,e.se=p.matrixTransform(r),p.x-=o,e.sw=p.matrixTransform(r),p.y-=a/2,e.w=p.matrixTransform(r),p.x+=o,e.e=p.matrixTransform(r),p.x-=o/2,p.y-=a/2,e.n=p.matrixTransform(r),p.y+=a,e.s=p.matrixTransform(r),e}return u};k.app=a.template({compiler:[8,">= 4.3.0"],main:function(t,e,r,o,a){var i,n=null!=e?e:t.nullContext||{},s=t.hooks.helperMissing,l="function",p=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="CompareChart">\n\n    <div class="title">\n    </div>\n\n    <div class="frame">\n        <div id="biPartite_'+p(typeof(i=null!=(i=t(r,"id")||(null!=e?t(e,"id"):e))?i:s)==l?i.call(n,{name:"id",hash:{},data:a,loc:{start:{line:7,column:27},end:{line:7,column:33}}}):i)+'" class="graph biPartite_'+p(typeof(i=null!=(i=t(r,"id")||(null!=e?t(e,"id"):e))?i:s)==l?i.call(n,{name:"id",hash:{},data:a,loc:{start:{line:7,column:58},end:{line:7,column:64}}}):i)+'" >\n         \n            \n        </div>\n    </div>\n\n</div>'},useData:!0}),k.chart=a.template({compiler:[8,">= 4.3.0"],main:function(t,e,r,o,a){return'<div class="crumbs">\n</div>\n<div class="graph">\n    <svg></svg>\n</div>\n'},useData:!0}),k.fileExporter=a.template({compiler:[8,">= 4.3.0"],main:function(t,e,r,o,a){return'<div class="tools-panel">\n</div>'},useData:!0});var F=k;function k(){}E.getConfig=function(t){var o=this,a={},e={".csv":"Csv",".xlsx":"Excel"}[t.fileFormat],i=t.columnsConfig,n=i.dataSource;return a.fileName=p.ExportTools.getExportFileName(t.fileName,"",e),a.metaData=[],a.fileFormat=t.fileFormat,a.workSheetTitle=t.workSheetTitle,n&&(e=i.labelColId,n.breakdownColumns.length&&"{breakdownId}"===e&&(e=n.breakdownColumns[n.getDepth()]),a.dataSet=n.getData().toJSON(),a.metaData=[this.getExportMetaData({colId:e,colName:e,dataType:i.labelProps.Format,dataFormat:i.labelProps.DateFormat,precision:i.labelProps.Precision,hideTrailingZeroes:i.labelProps.HideTrailingZeroes,kdbType:n.getColumnType(e)})],_.each(i.layers,function(t){var e=t.Column,r=t.Display,t=p.ExportTools.regExValidateColumnIDs(e,n.getColumnNames());0<t.length?t.forEach(function(t){a.metaData.push(o.getExportMetaData({colId:t,colName:r,dataType:i.layersProps.Format,dataFormat:"",precision:i.layersProps.Precision,hideTrailingZeroes:!1,kdbType:n.getColumnType(t)}))}):console.log("Column with id: '"+e+"' not found")})),a},E.getExportMetaData=function(t){var e={},r=this.getValidPrecission(Number(t.precision)),r=this.resolveColumnTypeAndFormat(t.dataType,t.dataFormat,r,t.kdbType);return e.colId=t.colId,e.colName=t.colName,e.dataType=r.dataType,e.dataKdbType=r.dataKdbType,e.dataFormat=r.dataFormat,e.hideTrailingZeroes=t.hideTrailingZeroes,e.prefix="",e.suffix="",e},E.resolveColumnTypeAndFormat=function(t,e,r,o){var a=11<o&&o<20,i=3<o&&o<10,n=r?"."+Array(r+1).join("0"):"";switch((3===o||o<1||19<o)&&(o=11,e="TO_STRING",t="String"),t){case"Number":i&&(e="#0"+n);break;case"Formatted Number":t="Number",e="#,##0"+n;break;case"Smart Number":t="Number",e="SmartNumber"+n;break;case"Datetime":t=p.ExportTools.getTemporalTypeFromFormat(e),e=p.ExportTools.CHARTS_DATE_FORMAT_MAP[e],e=a?e||"":(t="String","");break;default:t="String",e=""}return{dataType:t=1===o?"Boolean":t,dataFormat:e,dataKdbType:o}},E.getValidPrecission=function(t){var e=void 0!==t?t:0;return e<0?(e=0,console.info("Invalid precission, should be between in range of 0 and 10, got: ",t)):10<e&&(e=10,console.info("Invalid precission, should be between in range of 0 and 10, got: ",t)),e};var Y=E;function E(){}O=p.ExportTools.FileExporterView,i(L,O),L.prototype.initialize=function(){this.fileExport=function(t){try{var e=p.ExportTools,r=Y.getConfig(_.extend(this.getExportConfig(),{fileFormat:t}));e.openFileExportDialog(r)}catch(t){p.Log.Warn("Invalid file export config check properties")}}},L.prototype.apiExport=function(){};var O,B=L;function L(){return null!==O&&O.apply(this,arguments)||this}B.prototype.SETTINGS=["api","appViewModel","getExportConfig","getSvgNode","isPivot"];var M,A=p.Tools;function V(t){var r=M.call(this,t)||this,o=(r.focus=[],r.layers=new d,r.dataSources={},r.errors={},r.globalPalette=[],_.extend(r,_.pick(t,["api","dashboardViewModel"])),r.api.setProperty,r.onSettingsChange);return r.onSettingsChange=function(t){var e=this.onSettingsChange!==(this.onSettingsChange=o);this.onSettingsChange(t),e&&(this.isReadyForThemeChange=!0,this.setThemeAccordingToDashboardSettings())}.bind(r),r.$el.html(F.app({id:r.cid})),r.listenTo(r.layers,"add",_.bind(function(t){t.get("NodeLabels")&&t.get("NodeValues")||(t.set("NodeLabels",this.api.getProperty("NodeLabels")),t.set("NodeValues",this.api.getProperty("NodeValues"))),this.setThemeAccordingToDashboardSettings()},r)),r.listenTo(r.layers,"reset",_.bind(function(t){this.setThemeAccordingToDashboardSettings()},r)),r.listenTo(r.layers,"remove",function(t){t.stopListening()}),r.listenTo(r.layers,"update",_.bind(function(t,e){this.updatePossibleLayers();e.changes.added.length,e.changes.removed.length;S.safeHandle(this.initializeChart).call(this)},r)),r.layoutModel=new b,r.listenTo(r.layoutModel,"change",S.safeHandle(r.initializeChart)),r.fileExportModel=new e.DeepModel,r.fileExporterView=new B({model:r.fileExportModel,el:F.fileExporter({}),api:r.api,appViewModel:r.fileExportModel,getSvgNode:function(){return r.$el.find(".frame svg")[0]},getExportConfig:function(){var t=r.layers.at(0),e={};try{e={columnsConfig:{dataSource:r.dataSources[t.get("Basics.Data").cid],layers:t.get("Data"),labelColId:t.get("Labels.Label"),labelProps:t.get("NodeLabels"),layersProps:t.get("NodeValues")},fileName:r.fileExportModel.get("FileExport.FileName"),altFileName:t.get("format.widgetTitle"),workSheetTitle:"CompareChart"}}catch(t){p.Log.Warn("Can not export file -  Datasource or other properties are not set")}return e}}),r.$el.prepend(r.fileExporterView.$el),r.listenTo(r.fileExporterView,"redraw-chart",S.safeHandle(r.initializeChart)),r.globalPalette=t.dashboardAppModel.get("globalPalettes"),r.api.setProperty("possiblePalettes",_.map(_.uniqBy(r.globalPalette,"rule"),"rule")),r}return M=e.View,i(V,M),V.prototype.onSettingsChange=function(t){t=S.expandNestedViewStates(t,this.api),t=S.replaceViewStatesWithValue("",t,this.api),t=S.pump(t);this.onSettingsChangeProcessed.call(this,t)},V.prototype.updateError=function(t,e){function r(t){return"Error"===t?3:"Loading"===t?2:"NoResults"===t?1:0}var o=this,t=t.getKey(),e=(e?this.errors[t]=e:delete this.errors[t],_.reduce(this.errors,function(t,e){e=e.type;return r(e)>r(t)?e:t},""));e&&("NoResults"!==e||Object.keys(this.dataSources).length===Object.keys(this.errors).length)?(t=_.map(this.errors,function(t,e){t=t.error,e=o.dataSources[e];return t?"["+e.getPath()+"]: "+t:null}).filter(function(t){return t}),this.api.showQueryStatus({error:t.join("\n"),type:e})):this.api.hideQueryStatus()},V.prototype.updateDataSource=function(e){var r=this;if(this.dataSources[e.getKey()]){var o=this.layers.filter(function(t){t=t.get("Basics.Data");return t&&t.cid===e.getKey()}),a=p.HeuristicHelpers.getNumericColumns(e),i=p.HeuristicHelpers.getStringColumns(e),n=this.errors[e.getKey()];if(!(0!==i.length&&0!==a.length||n&&"Loading"!==_.get(n,"type")))return void this.api.showQueryStatus({error:t("Data Source provided is not valid for Bipartite Chart"),type:"Warning"});o.forEach(function(t){t.updateData(e),t.set("possibleColumns",e.getColumnNames()),t.set("possibleRules",e.getColumnNames()),t.set("possibleLabels",e.getColumnNames()),r.api.setProperty("possibleColumns",t.get("possibleColumns")),r.api.setProperty("possibleRules",t.get("possibleRules")),r.api.setProperty("possibleLabels",t.get("possibleLabels")),""===r.api.getProperty("Labels.Label")&&r.api.setProperty("Labels.Label",i[0]),""===r.api.getProperty("Data.0.Column")&&r.api.setProperty("Data.0.Column",a[0])})}S.safeHandle(this.initializeChart).call(this)},V.prototype.onSettingsChangeProcessed=function(t){_.isObject(t.Basics)&&this.onSettingsBasicsChanged.call(this,t.Basics),_.isObject(t.Basics)&&t.Basics.Data&&this.onSettingsLayersChanged.call(this,t),_.isObject(t.Labels)&&this.onSettingsOnLabels(t),_.isObject(t.Data)&&this.onSettingsOnData(t),_.isObject(t.NodeLabels)&&this.updateBaseLayer(t),_.isObject(t.NodePercentages)&&this.updateBaseLayer(t),_.isObject(t.NodeValues)&&this.updateBaseLayer(t),_.isObject(t.Style)&&this.onSettingsOnStyle(t,"Style"),_.isObject(t.Padding)&&this.onSettingsPaddingChanged.call(this,t),_.isObject(t.FileExport)&&this.onSettingsFileExportChanged.call(this,t.FileExport)},V.prototype.onSettingsFileExportChanged=function(t){var r=this;this.fileExportModel&&_.each(t,function(t,e){r.fileExportModel.set("FileExport."+e,t)})},V.prototype.onSettingsPaddingChanged=function(t){this.layoutModel.set("Padding",t.Padding)},V.prototype.onSettingsLayersChanged=function(t){this.layers.set(t);var t=t.Basics.Data,e=this.dataSources[t.cid];e?e.hasData()&&this.updateDataSource(e):(e=new y(t,this,this.api,this.focus),(this.dataSources[t.cid]=e).subscribe()),t.cid},V.prototype.onSettingsOnLabels=function(t){var r=this.layers.models[0];_.each(t.Labels,function(t,e){r&&"Label"===e&&r.set("Labels.Label",t)})},V.prototype.onSettingsOnStyle=function(r,t){var o,a,e,i,n,s,l;_.get(r,"Style.palettes")&&(o=""+(null==(l=this.dashboardViewModel)?void 0:l.get("DashboardTheme")),a=".palette_theme",l=this.api.getProperty("Style.palettes"),e=_.filter(this.globalPalette,function(t){var e=".dark"!==_.get(t,"theme")&&".light"!==_.get(t,"theme")||t.theme.toLowerCase()==="."+o.toLowerCase();return t.rule===a&&e}),i=(_.isEmpty(l)||" "===l||l===a)&&0<e.length,n=!1,s=[],i&&_.each(e,function(t){s.push({type:p.Tools.rgbStr2hex(t.color)}),n=!0}),_.each(this.globalPalette,function(t){var e=!_.get(t,"theme")||t.theme.toLowerCase()==="."+o.toLowerCase();t.rule===_.get(r,"Style.palettes")&&e&&!i&&(s.push({type:p.Tools.rgbStr2hex(t.color)}),n=!0)}),n)&&this.api.setProperty("Style.chartBarColors",s),this.layers&&0<this.layers.models.length&&(void 0===(l=this.layers.models[0]).get(t)?l.set(t,this.api.getProperty(t)):this.updateBaseLayer(r))},V.prototype.updateBaseLayer=function(t){var e;this.layers&&0<this.layers.models.length&&((e=this.layers.models[0]).set(t),_.each(this.dataSources,function(t){e.chartData={},e.updateData(t)}),e.updateVisuals(),this.initializeChart())},V.prototype.onSettingsOnData=function(t){var e;0<this.layers.models.length&&((e=this.layers.models[0]).set("Data",t.Data),_.each(this.dataSources,_.bind(function(t){e.chartData={},void 0===e.get("Style")&&e.set("Style",this.api.getProperty("Style")),e.updateData(t)},this)),this.initializeChart())},V.prototype.onSettingsBasicsChanged=function(t){var e=this;void 0!==t.Focus&&(this.focus=_.first(S.focus2Array(t.Focus))||[],_.each(this.dataSources,function(t){t.setFocus(e.focus)}))},V.prototype.initializeChart=function(){var r,t,e,o,a,i,n,s=this;this.chart&&(this.chart.destroy(),delete this.chart),this.layers.models[0]&&this.layers.models[0].chartData&&(r=this.layers.models[0].chartData,t=this.layers.models[0].format,r)&&r.data&&t&&(e=this.$el.width()-this.layers.models[0].getWidth()-2*t.minWidth,n=this.$el.height(),(o=this.$el.find("#biPartite_"+this.cid)).empty(),i=r.data.length/t.colors.length,i=isNaN(i)||i<1?1:Math.ceil(r.data.length/t.colors.length),a=window.d3.select("#biPartite_"+this.cid).append("svg").append("g").attr("transform","translate("+t.margin.l+","+t.margin.t+")"),n=[{data:(i=new H(_.flatten(_.times(i,_.constant(t.colors))),n,e,t.decimal,t.c1,t.c2,t.c3,t.partWidth,t.minWidth,t.labelShow,t.valueShow,t.percentShow,t.yAxisFormat)).partData(r.data,2),id:"view_biPartite_"+this.cid,header:["","",""]}],i.draw(n,a),this.tooltip(a),i.ShowTooltip.on(function(t){var e=_.get(t,"svg")?t.svg.getBoundingClientRect():{x:0,y:0};s.tip.show(t.data,t.dataIndex,t.seriesIndex,e.x,e.y)}),i.HideTooltip.on(function(){s.tip.hide()}),$(o).find(".part0 .mainbar").click(function(e){var t=_.indexOf(r.data,_.find(r.data,function(t){return t[0]===$(e.target).text()}));-1!=t&&s.onClick(t)}),this.setThemeLabelColor(t.labelColor))},V.prototype.onResizeStop=function(){S.safeHandle(this.initializeChart).call(this)},V.prototype.tooltip=function(t){var e,r,o=this.api.getProperty("Style");this.tip=window.d3.tip().attr("class","d3-tip").html(function(t){e=a.compile(o.advancedTooltip);try{r=e(t)}catch(t){r=""}return r}),t.call(this.tip)},V.prototype.onClick=function(t){var e,r,o=this.layers.models[0],a=o.get("Basics.Data"),a=this.dataSources[a.cid],t=a.getData().at(t);void 0!==t&&(e=a.getDepth(),r=_.clone(this.focus),a=a.getPropertyFromColumn(o.get("Labels.Label")),o=t.get(a),r[e]=o&&o.toString?o.toString():""+o,this.api.setProperty("Basics.Focus",r.join(","),!0),this.doActions(t))},V.prototype.doActions=function(e){var t=this.api.getProperty("Basics.Actions").map(function(t){return n(n({},t),{Value:e.get(t.Current)})});this.api.doActions(t,"Basics.Actions")},V.prototype.onLayerDataEvents=function(t){var e=t.get("Basics.Data"),e=e?this.dataSources[e.cid]:void 0;t.updateData(e),t.set("_Hidden._PossibleColumns",e?e.getColumnNames():[])},V.prototype.onLayerVisualEvents=function(t){t.updateVisuals()},V.prototype.setTheme=function(t){var e;if("Light"===t)e="#000000";else{if("Dark"!==t)return void console.warn("Dashboard Theme should be set / unkown theme: "+t);e="#FFFFFF"}t=t.toLowerCase();this.layers.models[0],this.api;this.$el.removeClass("dark light"),this.$el.addClass(t),this.setThemeLabelColor(e)},V.prototype.setThemeLabelColor=function(t){this.$el.find("text").css("fill",t)},V.prototype.setThemeAccordingToDashboardSettings=function(){this.isReadyForThemeChange&&this.setTheme(this.dashboardViewModel.get("DashboardTheme"))},V.prototype.updatePossibleLayers=function(){this.layers.filter(function(t){return"Line"===t.get("_Hidden._Type")}).forEach(function(o){var t=o.collection.reduceRight(function(t,e,r){return[o===e?"nofill":"Layer "+(r+1)].concat(t)},["origin"]);o.set("_Hidden._PossibleLayers",t)}.bind(this))},V.getComponentDefinition=D.getComponentDefinition,V.DEBUG=!1,V});
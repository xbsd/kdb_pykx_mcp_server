define(["Handlebars","QuickBase","moment","backbone","css!./css/app.css"],function(t,e,a,n){var i,r=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])}))(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function a(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}),f=this&&this.__assign||function(){return(f=Object.assign||function(t){for(var e,a=1,n=arguments.length;a<n;a++)for(var i in e=arguments[a])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},y=this&&this.__awaiter||function(t,o,s,l){return new(s=s||Promise)(function(a,e){function n(t){try{r(l.next(t))}catch(t){e(t)}}function i(t){try{r(l.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?a(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(n,i)}r((l=l.apply(t,o||[])).next())})},m=this&&this.__generator||function(n,i){var r,o,s,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(a){return function(t){var e=[a,t];if(r)throw new TypeError("Generator is already executing.");for(;l;)try{if(r=1,o&&(s=2&e[0]?o.return:e[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,e[1])).done)return s;switch(o=0,(e=s?[2&e[0],s.value]:e)[0]){case 0:case 1:s=e;break;case 4:return l.label++,{value:e[1],done:!1};case 5:l.label++,o=e[1],e=[0];continue;case 7:e=l.ops.pop(),l.trys.pop();continue;default:if(!(s=0<(s=l.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){l=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3]))l.label=e[1];else if(6===e[0]&&l.label<s[1])l.label=s[1],s=e;else{if(!(s&&l.label<s[2])){s[2]&&l.ops.pop(),l.trys.pop();continue}l.label=s[2],l.ops.push(e)}}e=i.call(n,l)}catch(t){e=[6,t],o=0}finally{r=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},o=(s.getComponentDefinition=function(t){var e,a;if(0<_.keys(t.settingsModel.attributes).length)for(a=s.upgrades.indexOf(_.find(s.upgrades,{version:t.settingsModel.get("version")}))+1;a<s.upgrades.length;a+=1)(e=s.upgrades[a]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return{appArgs:{json:{Basics:{Name:""},Luna:{Title:"",Subtitle:"",Time:0,ILatitude:"-27",ILongitude:"133",IZoom:"3",Latitude:"-27",Longitude:"133",Zoom:"3",MapProvider:"Mapbox",MapProviderStyleURL:"mapbox://styles/bicubic/ciwwzdmym00i52pnx6kytgkkv",MapProviderKey:"pk.eyJ1IjoiYmljdWJpYyIsImEiOiJjaW1yaXJra3gwMTE3djlrazNjaGlubDA4In0.NwmyTomCSijLB5FbQHE_rw",Layers:[]}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",properties:{Name:{title:"Name",type:"string",default:""}}},Luna:{type:"object",title:"Luna",properties:{Title:{type:"string",title:"Title",default:"",format:"string"},Subtitle:{type:"string",title:"Subtitle",default:"",format:"string"},Time:{type:"number",title:"Time",default:0},ILatitude:{type:"string",title:"ILatitude",default:"",format:"string"},ILongitude:{type:"string",title:"ILongitude",default:"",format:"string"},IZoom:{type:"string",title:"IZoom",default:"",format:"string"},Latitude:{type:"string",title:"Latitude",default:"",format:"string"},Longitude:{type:"string",title:"Longitude",default:"",format:"string"},Zoom:{type:"string",title:"Zoom",default:"",format:"string"},Layers:{type:"array",format:"object",title:"Layers",options:{collapsed:!0,reset:!0},items:{type:"object",title:"Layer",properties:{Enabled:{default:!1,type:"boolean",propertyOrder:1,format:"checkbox"},Name:{default:"",type:"string",propertyOrder:2},Type:{type:"string",title:"Type",enum:["Points"],propertyOrder:3},Data:{title:"Data Source",type:"data"},LiveData:{title:"Data Source (Live)",type:"data"},AnnotationsData:{title:"Annotations",type:"data"},SelectedObjectId:{title:"SelectedObjectId",type:"string"},Sprites:{title:"Sprites",type:"array",format:"object",options:{collapsed:!0,reset:!0},items:{type:"object",title:"Sprite",properties:{Descriptor:{title:"Descriptor",type:"string"}}}},LayerId:{default:"",type:"string",propertyOrder:4},Arg1:{default:"",type:"string",propertyOrder:5},Arg2:{default:"",type:"string",propertyOrder:6},Arg3:{default:"",type:"string",propertyOrder:7}}}},UserInput:{type:"string",title:"User Input"}}}}}}}},s);function s(){}o.upgrades=[{fn:function(t){}},{fn:function(t){t.get("Basics.Name")||t.set("Basics.Name","")},version:"4.7.7"}];l.app=t.template({compiler:[8,">= 4.3.0"],main:function(t,e,a,n,i){var r,o=null!=e?e:t.nullContext||{},s=t.hooks.helperMissing,l="function",u=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="luna">\n    <div class="luna">\n        <iframe class="'+u(typeof(r=null!=(r=t(a,"frameID")||(null!=e?t(e,"frameID"):e))?r:s)==l?r.call(o,{name:"frameID",hash:{},data:i,loc:{start:{line:3,column:23},end:{line:3,column:34}}}):r)+'" id="luna-iframe" src="'+u(typeof(r=null!=(r=t(a,"url")||(null!=e?t(e,"url"):e))?r:s)==l?r.call(o,{name:"url",hash:{},data:i,loc:{start:{line:3,column:58},end:{line:3,column:65}}}):r)+"#loc="+u(typeof(r=null!=(r=t(a,"lat")||(null!=e?t(e,"lat"):e))?r:s)==l?r.call(o,{name:"lat",hash:{},data:i,loc:{start:{line:3,column:70},end:{line:3,column:77}}}):r)+","+u(typeof(r=null!=(r=t(a,"lng")||(null!=e?t(e,"lng"):e))?r:s)==l?r.call(o,{name:"lng",hash:{},data:i,loc:{start:{line:3,column:78},end:{line:3,column:85}}}):r)+","+u(typeof(r=null!=(r=t(a,"zoom")||(null!=e?t(e,"zoom"):e))?r:s)==l?r.call(o,{name:"zoom",hash:{},data:i,loc:{start:{line:3,column:86},end:{line:3,column:94}}}):r)+'">\n\n            \n        </iframe>\n    </div>\n</div>'},useData:!0});var g=l;function l(){}var u;e.Tools;function c(t){var e=u.call(this,t)||this;return e.status={},e.api=t.api,e.el=t.el,e.iframeId="luna-iframe"+e.cid,e.settings=void 0,e.status={},e}return u=n.View,r(c,u),c.prototype.onSettingsChange=function(t){var p=this,a=void 0===this.settings,n=(this.settings=f(f({},this.settings),t),this.api.hideErrorMessage(),this.settings["Luna.Title"]),i=this.settings["Luna.Subtitle"],t=this.settings["Luna.Layers"];if(a){for(var e=this.api.getProperty("Luna.ILatitude"),r=this.api.getProperty("Luna.ILongitude"),o=this.api.getProperty("Luna.IZoom"),s=document.querySelectorAll("script[src]"),s=_.findLast(s,function(t){return 0<=_.get(t,"src").indexOf("Luna")}),l=_.get(s,"src").split("/"),u="",c=3;c<l.length-1;c++)u=u+"/"+l[c];this.el.innerHTML=g.app({frameID:this.iframeId,lat:e,lng:r,url:u+"/luna/index.html",zoom:o})}this.iframe=this.el.getElementsByClassName(this.iframeId)[0].contentWindow,this.iframe.layers=t;var d;a&&(d=this.api.getProperty("Luna.MapProvider"),y(p,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return _.isNil(this.iframe.window.lunaLaunchControl)?[4,new Promise(function(t){return requestAnimationFrame(t)})]:[3,2];case 1:return t.sent(),[3,0];case 2:return[2,this.iframe]}})}).then(function(t){t.lunaLaunchControl(d)}));y(p,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return _.isNil(this.iframe.window.luna)?[4,new Promise(function(t){return requestAnimationFrame(t)})]:[3,2];case 1:return t.sent(),[3,0];case 2:return[2,this.iframe]}})}).then(function(c){var t=c.document.querySelector("div.what"),e=(c.layers.forEach(function(e,t){var a,n,i,r,o,s,l=e.LayerId,u=p.api.getProperty("Luna.Layers."+t+".Enabled");e.Enabled=!!u&&e.Enabled,p.api.getProperty("Luna.Layers."+t+".SelectedObjectId");_.isNil(p.status[l])&&(e.Enabled&&l&&e.Type&&e.Name&&(p.status[l]={status:"INIT"},u=c.luna.loadLayer(e.Name,e.Type,"./assets/layers/"+l,e.Arg1,e.Arg2,e.Arg3,e.Sprites),p.status[l]={layer:u,status:"LOADING"},c.luna.updateLayerName(p.status[l].layer,e.Name),(a=p.status[l].dataSource)!=(n=e.Data)&&(a&&p.api.unsubscribe(a),p.api.subscribe(n,p.onData.bind(p,e)),p.status[l].dataSource=n),(i=p.status[l].liveDataSource)!=(r=e.LiveData)&&(i&&p.api.unsubscribe(i),p.api.subscribe(r,p.onLiveData.bind(p,e)),p.status[l].liveDataSource=r),o=p.status[l].annotationsDataSource,s=e.AnnotationsData,console.log("anno check"),o!=s)&&(o&&p.api.unsubscribe(o),p.api.subscribe(s,p.onAnnotationsData.bind(p,e)),p.status[l].annotationsDataSource=s),c.luna.updateLayerName(p.status[l].layer,e.Name),_.get(c.luna,"layers."+t+".objects"))&&_.each(c.luna.layers[t].objects,function(t){t.visible=e.Enabled}),e.Enabled&&((a=p.status[l].dataSource)!=(n=e.Data)&&(a&&p.api.unsubscribe(a),p.api.subscribe(n,p.onData.bind(p,e)),p.status[l].dataSource=n),(i=p.status[l].liveDataSource)!=(r=e.LiveData)&&(i&&p.api.unsubscribe(i),p.api.subscribe(r,p.onLiveData.bind(p,e)),p.status[l].liveDataSource=r),(o=p.status[l].annotationsDataSource)!=(s=e.AnnotationsData)&&(p.api.subscribe(s,p.onTooltipsData.bind(p,e)),p.status[l].annotationsDataSource=s),p.status[l].tooltipsDataSource!=(s=e.AnnotationsData)&&(p.api.subscribe(s,p.onAnnotationsData.bind(p,e)),p.status[l].tooltipsDataSource=s),p.status[l].selectedObjectId!=(u=p.api.getProperty("Luna.Layers."+t+".SelectedObjectId")))&&(c.luna.updateSelectedObjectId(e,u),p.status[l].selectedObjectId=u),$(p.iframe.frameElement).contents().find(".layer-bar-title:nth-child("+(t+1)+")").html(e.Name)}),window.api=p.api,a&&c.luna.registerUpdateCallback(function(t){for(var e=0,a=Object.entries(t);e<a.length;e++){var n=a[e],i=n[0],r=n[1];switch(i){case"timeslider.value":p.api.setProperty("Luna.Time",r);break;case"lat":p.api.setProperty("Luna.Latitude",r);break;case"lng":p.api.setProperty("Luna.Longitude",r);break;case"zoom":p.api.setProperty("Luna.Zoom",r);break;case"pick":p.api.setProperty("Luna.Layers.0.SelectedObjectId",t.pick.id);break;case"error":p.api.showErrorMessage(r);break;default:console.log("updateCallback presented with unknown update key="+i)}}}),t.querySelector(":scope > div.big")),t=t.querySelector(":scope > div.small");n&&(e.innerHTML=n),i&&(t.innerHTML=i)})},c.prototype.onData=function(t,e,a,n){var i=this.el.getElementsByClassName(this.iframeId)[0].contentWindow;i&&i.luna?i.luna.updateData(t,a,!0):console.log("onData called but no luna component registered")},c.prototype.onAnnotationsData=function(t,e,a,n){var i=this.el.getElementsByClassName(this.iframeId)[0].contentWindow;i&&i.luna?i.luna.updateAnnotationsData(t,a):console.log("onAnnotationsData called but no luna component registered")},c.prototype.onTooltipsData=function(t,e,a,n){var i=this.el.getElementsByClassName(this.iframeId)[0].contentWindow;i&&i.luna?i.luna.updateTooltipsData(t,a):console.log("onTooltipsData called but no luna component registered")},c.prototype.onLiveData=function(t,e,a,n){var i=this.el.getElementsByClassName(this.iframeId)[0].contentWindow;i&&i.luna?i.luna.updateData(t,a,!1):console.log("onLiveData called but no luna component registered")},c.prototype.setTheme=function(t){},c.getComponentDefinition=o.getComponentDefinition,c});
define(["QuickBase","backbone","Forms","Handlebars","moment","chartjs","d3","css!./css/app.css"],function(a,e,n,t,s,r,l){var o,i=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}))(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),d=this&&this.__assign||function(){return(d=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t}).apply(this,arguments)},h=this&&this.__spreadArray||function(t,e,i){if(i||2===arguments.length)for(var o,s=0,a=e.length;s<a;s++)!o&&s in e||((o=o||Array.prototype.slice.call(e,0,s))[s]=e[s]);return t.concat(o||Array.prototype.slice.call(e))},p=(u.onItemDataTransform=function(o,s,t,a){var r,n,l;"data"===t?(t=(r=o).data,r.DataSourceMapping||(r.DataSourceMapping={Value:"",Text:""}),r.DropdownPossibleValues||(r.DropdownPossibleValues=[]),n=r.DataSourceMapping.Value instanceof e.Model,l=r.DataSourceMapping.Text instanceof e.Model,t?t.getMeta(function(t){var t=_.fromPairs(_.map(t.columns.collection.models,function(t){return[t.get("id"),t.toJSON()]})),e=_.keys(t),t=_.find(t,function(t){return 0===t.kdbType||11===t.kdbType}),i=r.DropdownPossibleValues;i&&!_.isEqual(i.sort(),e.sort())&&(r.DropdownPossibleValues=e,n||(r.DataSourceMapping.Value=e[0]||""),l||(r.DataSourceMapping.Text=t&&t.id||e[0]||"")),console.log("DFilter transform: ",o,s),a(o,s)}):(r.DropdownPossibleValues=[],n||(r.DataSourceMapping.Value=""),l||(r.DataSourceMapping.Text=""),a(o,s))):a(o,s)},u.getComponentDefinition=function(t){var e,i,o={Trigger:{default:"Rule Change",enum:["Rule Change"],propertyOrder:2,title:"Trigger Action",type:"string"}},o={id:101,componentName:"Data Filter",componentDescription:"Filter data sources.",appKey:"DataFilter",listViewThumb:"fa fa-fw fa-filter",ghostViewThumb:null,buildViewThumb:null,appArgs:{quickStart:[{path:"Basics.data",message:"populate Data Source"}],json:{version:"v2.2.1",Basics:{Name:"",data:"",queryModel:"",kdbString:"",UseViewStates:!1},Bindings:[],Items:[],Actions:[],format:{SortListBySelected:!1},Style:{HistogramBuckets:50,HistogramColor:"#0071cd"}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",options:{collapsed:!1},properties:{Name:{propertyOrder:1001,title:"Name",type:"string",default:""},data:{propertyOrder:1001,type:"data",title:"Data Source"},queryModel:{propertyOrder:1002,type:"string",title:"Query Model"},kdbString:{propertyOrder:1003,title:"KDB String",type:"string"},UseViewStates:{type:"boolean",default:!1,options:{hidden:!0}}}},Bindings:{type:"array",format:"table",title:"Bindings",uniqueItems:!0,options:{collapsed:!0},items:{type:"object",properties:{Key:{type:"string"},ViewState:{type:"viewstate"}}}},Items:{title:"Fields",type:"array",format:"object",options:{collapsed:!0,disable_array_add:!0,disable_array_delete:!0,no_additional_properties:!0},items:{id:"arr_item",title:"ViewState",type:"object",headerTemplate:"{{#if self.propertyName}}{{ self.propertyName }}{{else}}Field{{/if}}",_transform:u.onItemDataTransform,options:{hidden:!1,collapsed:!0,keep_oneof_values:!1},properties:{DropdownPossibleValues:{type:"array",items:{type:"string"},default:[],options:{hidden:!0}},propertyName:{type:"string",title:"Property Name",options:{hidden:!0}},data:{type:"data",title:"Data Source"},FieldSummaryThreshold:{title:"Field Summary Threshold",type:"number"},DataSourceMapping:{type:"object",title:"Data Source Mapping",properties:{Value:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.DropdownPossibleValues"}},Text:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.DropdownPossibleValues"}}}},items:{type:"array",format:"table",title:"Items",uniqueItems:!0,options:{collapsed:!1},items:{type:"object",properties:{Value:{type:"string"},Text:{type:"string"}}}}}}},Actions:{title:"Actions",type:"actions",fields:{map:_.extend({Current:{propertyOrder:10,title:"Source Column",type:"string",enum:["Operand","Operator","Value"],default:"Value"}},o),nav:o,query:o,url:o},options:{collapsed:!0}},format:{type:"object",title:"Format",options:{collapsed:!0},properties:{SortListBySelected:{title:"Sort List by Selected",type:"boolean",default:!1}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{HistogramColor:{title:"Histogram Color",type:"gradient",default:"#0071cd",options:{gradient:!1}},HistogramBuckets:{title:"Histogram no of Buckets",type:"number",minimum:0,maximum:250,default:50}}}}}}};if(t.settingsModel&&0<_.keys(t.settingsModel.attributes).length)for(i=u.upgrades.indexOf(_.find(u.upgrades,{version:t.settingsModel.get("version")}))+1;i<u.upgrades.length;i+=1)(e=u.upgrades[i]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return o},u.defaults=function(){return u.getComponentDefinition({settingsModel:new e.Model}).appArgs.json},u.default_FieldSummaryThreshold=5,u);function u(){}p.upgrades=[{version:"4.4.0S2",fn:function(t){t.set("Style",{advanced:"",cssClasses:""})}},{version:"4.4.1",fn:function(t){t.get("Bindings")||t.set("Bindings",[])}},{version:"4.5.0",fn:function(t){t.get("Basics.UseViewStates")||t.set("Basics.UseViewStates",!1)}},{version:"4.5.1",fn:function(i){_.each(i.get("Items"),function(t,e){i.unset("Items."+e+".useDataSource")})}},{version:"4.7.6",fn:function(t){t.get("format.SortListBySelected")||t.set("format.SortListBySelected",!1)}},{version:"4.7.7",fn:function(t){t.get("Basics.Name")||t.set("Basics.Name","")}},{version:"4.7.7.1",fn:_.noop},{version:"4.7.8",fn:function(t){t.get("Style.HistogramBuckets")||t.set("Style.HistogramBuckets",50),t.get("Style.HistogramColor")||t.set("Style.HistogramColor","#0071cd")}},{version:"4.8.1",fn:function(t){_.each(t.get("Items"),function(t){_.isUndefined(t.FieldSummaryThreshold)&&(t.FieldSummaryThreshold=p.default_FieldSummaryThreshold)})}},{version:"v2.2.1",fn:function(t){_.isNil(t.get("Actions"))&&t.set("Actions",[])}}];m.QueryItem=t.template({1:function(t,e,i,o,s){var a,r=null!=e?e:t.nullContext||{},n=t.hooks.helperMissing,l="function",d=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="group-toolbar">\n\n    <div class="radio-group">\n        <input type="radio" id="'+d(typeof(a=null!=(a=t(i,"andId")||(null!=e?t(e,"andId"):e))?a:n)==l?a.call(r,{name:"andId",hash:{},data:s,loc:{start:{line:5,column:32},end:{line:5,column:41}}}):a)+'" name="'+d(typeof(a=null!=(a=t(i,"radioName")||(null!=e?t(e,"radioName"):e))?a:n)==l?a.call(r,{name:"radioName",hash:{},data:s,loc:{start:{line:5,column:49},end:{line:5,column:62}}}):a)+'">\n        <label for="'+d(typeof(a=null!=(a=t(i,"andId")||(null!=e?t(e,"andId"):e))?a:n)==l?a.call(r,{name:"andId",hash:{},data:s,loc:{start:{line:6,column:20},end:{line:6,column:29}}}):a)+'">AND</label>\n        <input type="radio" id="'+d(typeof(a=null!=(a=t(i,"orId")||(null!=e?t(e,"orId"):e))?a:n)==l?a.call(r,{name:"orId",hash:{},data:s,loc:{start:{line:7,column:32},end:{line:7,column:40}}}):a)+'" name="'+d(typeof(a=null!=(a=t(i,"radioName")||(null!=e?t(e,"radioName"):e))?a:n)==l?a.call(r,{name:"radioName",hash:{},data:s,loc:{start:{line:7,column:48},end:{line:7,column:61}}}):a)+'">\n        <label for="'+d(typeof(a=null!=(a=t(i,"orId")||(null!=e?t(e,"orId"):e))?a:n)==l?a.call(r,{name:"orId",hash:{},data:s,loc:{start:{line:8,column:20},end:{line:8,column:28}}}):a)+'">OR</label>\n    </div>\n\n    <svg width="10" height="15" xmlns="http://www.w3.org/2000/svg">\n\n        <g>\n            <title>background</title>\n            <rect fill="none" id="canvas_background" height="17" width="12" y="-1" x="-1" />\n        </g>\n        <g>\n            <title>Layer 1</title>\n            <g id="svg_19">\n                <g id="svg_2">\n                    <g id="svg_3">\n                        <path id="svg_4" d="m2.610779,4.717635c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\n                        />\n                    </g>\n                    <g id="svg_5">\n                        <path id="svg_6" d="m7.465516,4.717635c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\n                        />\n                    </g>\n                </g>\n                <g id="svg_10">\n                    <path id="svg_11" d="m2.610779,9.341194c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629s0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629s-0.809123,1.791629 -1.791629,1.791629z"\n                    />\n                </g>\n                <g id="svg_12">\n                    <path id="svg_13" d="m7.465516,9.341194c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629s0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629s-0.809123,1.791629 -1.791629,1.791629z"\n                    />\n                </g>\n                <g id="svg_14">\n                    <g id="svg_15">\n                        <path id="svg_16" d="m2.610779,13.964753c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\n                        />\n                    </g>\n                    <g id="svg_17">\n                        <path id="svg_18" d="m7.465516,13.964753c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\n                        />\n                    </g>\n                </g>\n            </g>\n        </g>\n    </svg>\n\n    <div class="align-right">\n        \n        <span class="add-rule-button-group">\n            <select class="add-rule-menu">\n                <option value="normal">Rule</option>\n                <option value="histogram">Histogram</option>\n            </select>\n            <button class="add-rule">Rule</button>\n        </span>\n\n        <button class="add-group">Group</button>\n        <button class="delete-group">Delete</button>\n    </div>\n</div>\n'},3:function(t,e,i,o,s){return" group "},5:function(t,e,i,o,s){return" rule "},compiler:[8,">= 4.3.0"],main:function(t,e,i,o,s){var a,r=null!=e?e:t.nullContext||{},n=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return(null!=(a=n(i,"if").call(r,null!=e?n(e,"isGroup"):e,{name:"if",hash:{},fn:t.program(1,s,0),inverse:t.noop,data:s,loc:{start:{line:1,column:0},end:{line:66,column:7}}}))?a:"")+'\n<div class="items-div '+(null!=(a=n(i,"if").call(r,null!=e?n(e,"isGroup"):e,{name:"if",hash:{},fn:t.program(3,s,0),inverse:t.program(5,s,0),data:s,loc:{start:{line:68,column:22},end:{line:68,column:65}}}))?a:"")+'">\n    <div class="branch"></div>\n    <div class="drag-div">\n        <svg width="10" height="15" xmlns="http://www.w3.org/2000/svg">\n\n            <g>\n                <title>background</title>\n                <rect fill="none" id="canvas_background" height="17" width="12" y="-1" x="-1" />\n            </g>\n            <g>\n                <title>Layer 1</title>\n                <g id="svg_19">\n                    <g id="svg_2">\n                        <g id="svg_3">\n                            <path id="svg_4" d="m2.610779,4.717635c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\n                            />\n                        </g>\n                        <g id="svg_5">\n                            <path id="svg_6" d="m7.465516,4.717635c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\n                            />\n                        </g>\n                    </g>\n                    <g id="svg_10">\n                        <path id="svg_11" d="m2.610779,9.341194c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629s0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629s-0.809123,1.791629 -1.791629,1.791629z"\n                        />\n                    </g>\n                    <g id="svg_12">\n                        <path id="svg_13" d="m7.465516,9.341194c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629s0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629s-0.809123,1.791629 -1.791629,1.791629z"\n                        />\n                    </g>\n                    <g id="svg_14">\n                        <g id="svg_15">\n                            <path id="svg_16" d="m2.610779,13.964753c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\n                            />\n                        </g>\n                        <g id="svg_17">\n                            <path id="svg_18" d="m7.465516,13.964753c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\n                            />\n                        </g>\n                    </g>\n                </g>\n            </g>\n        </svg>\n    </div>\n\n    <div class="droppie"></div>\n</div>'},useData:!0}),m.app=t.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,o,s){return'<div class="query-builder"></div>'},useData:!0}),m.bindingSelect=t.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,o,s){var a=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="binding-wrap">\n    <i class="fa fa-fw watermark fa-eye binding-apply"></i>\n\n    <div class="binding-container" style="display:none">\n        <i class="fa fa-fw watermark fa-eye viewstate-icon"></i>\n        <input class="viewstate-display" type="text" tabindex="-1" value="'+t.escapeExpression("function"==typeof(i=null!=(i=a(i,"viewstateDisplay")||(null!=e?a(e,"viewstateDisplay"):e))?i:t.hooks.helperMissing)?i.call(null!=e?e:t.nullContext||{},{name:"viewstateDisplay",hash:{},data:s,loc:{start:{line:6,column:74},end:{line:6,column:94}}}):i)+'" readonly />\n        <i class="fa fa-fw watermark fa-eraser binding-clear-dialog"></i>\n        <div class="binding-dropdown">\n            <select class="binding-select"></select>\n        </div>\n    </div>\n</div>'},useData:!0});var g=m;function m(){}c=e.View,i(v,c),v.prototype.addChild=function(t){var e=new v({api:this.api,model:t,appModel:this.options.appModel});this.$items.append(e.$el),this.items[t.cid]=e},v.prototype.allowBindings=function(){this.$bindings||this.updateValueEditor()},v.prototype.createRuleForm=function(){this.$form=$(document.createElement("div")),this.$form.addClass("the-form"),this.form={},this.form.active=new n.editors.Checkbox({model:this.model,schema:this.model.schema.active,key:"active"}).render(),this.form.active.on("change",$.proxy(this.onFormActiveChanged,this)),this.form.propertyName=new n.editors.Select({model:this.model,schema:this.model.schema.propertyName,key:"propertyName"}).render(),this.form.propertyName.on("change",$.proxy(this.onFormPropertyNameChanged,this)),this.$form.append(this.wrapInDiv(this.form.active.$el,"editor active")),this.$form.append(this.wrapInDiv(this.form.propertyName.$el,"editor property-name type-"+this.model.get("type"))),"histogram"!==this.model.get("type")&&(this.form.operator=new n.editors.Select({model:this.model,schema:this.model.schema.operator,key:"operator"}).render(),this.form.operator.on("change",$.proxy(this.onFormOperatorChanged,this)),this.$form.append(this.wrapInDiv(this.form.operator.$el,"editor operator"))),this.proxiedDragStart=$.proxy(this.dragStart,this),this.proxiedDragEnd=$.proxy(this.dragEnd,this),this.$form[0].addEventListener("dragstart",this.proxiedDragStart),this.$form[0].addEventListener("dragend",this.proxiedDragEnd),"histogram"!==this.model.get("type")&&this.$form.hover(this.displayOptions.bind(this,!0),this.displayOptions.bind(this,!1)),this.updateValueEditor(),this.$items.prepend(this.$form)},v.prototype.displayOptions=function(t){var e;this.$form.find(".value > div").toggleClass("three-options",t&&!this.useBindings),this.$form.find(".value > div").toggleClass("two-options",t&&this.useBindings),this.$form.find(".value-wrap > div").toggleClass("show-options",t),null!=(e=this.$bindingContainer)&&e.toggleClass("show-options",t),null!=(e=this.$bindingClear)&&e.toggle(t)},v.prototype.dragStart=function(t){this.onDragStart(t)},v.prototype.dragEnd=function(t){this.$el.removeClass("draggie"),this.options.appModel.trigger("drag-finished")},v.prototype.getValueIndex=function(i){var o=0,t=new Number(i).valueOf();return isNaN(t)?_.isString(i)&&(i=s(i).valueOf()):i=t,t===this.maxValue?(this.pickMaxValue=!0,o=this.chartData.length-1):_.find(this.chartData,function(t,e){return!(i>=t.x&&(o=e,1))}),o},v.prototype.histogramDragMouseDown=function(t){t.stopPropagation(),t.preventDefault();var e=$(t.target);this.histogramIsDragging=!0,this.$histogramDragHandle=e.hasClass("grabber")?e.parent():e,this.leftHandleWidth=this.$histogramHandleL.width(),this.$histogramHandleL.css("pointer-events","none"),this.$histogramHandleR.css("pointer-events","none"),this.$histogramDragMiddle.css("pointer-events","none"),this.dragDelta=t.offsetX,this.histogramDragMiddleWidth=this.$histogramDragMiddle.width(),this.middleRightLimit=this.chart.width-(this.histogramDragMiddleWidth+1),this.isDraggingLeft=this.$histogramDragHandle[0]===this.$histogramHandleL[0],this.leftLimit=this.isDraggingLeft?0:parseInt(this.$histogramHandleL.css("left"))+this.leftHandleWidth,this.rightLimit=this.isDraggingLeft?parseInt(this.$histogramHandleR.css("left"))-this.leftHandleWidth:this.chart.width-2},v.prototype.histogramDragMouseMove=function(t){var e,i;this.histogramIsDragging&&(this.$histogramDragHandle[0]===this.$histogramDragMiddle[0]?((e=t.offsetX-this.dragDelta)<=0?(e=0,this.pickMaxValue=!1):e>=this.middleRightLimit?(e=this.middleRightLimit,this.pickMaxValue=!0):this.pickMaxValue=!1,i=e+this.histogramDragMiddleWidth,this.$histogramDragMiddle.css({left:e,right:this.chart.width-i}),this.$histogramHandleL.css("left",e),this.$histogramHandleR.css("left",i),this.$histogramGreyoutL.css("right",this.chart.width-(e+4)),this.$histogramGreyoutR.css("left",i)):(t.offsetX<=this.leftLimit?(e=this.leftLimit,this.pickMaxValue=this.pickMaxValue&&this.isDraggingLeft):t.offsetX>=this.rightLimit?(e=this.rightLimit,this.pickMaxValue=!this.isDraggingLeft):(e=t.offsetX,this.pickMaxValue=this.pickMaxValue&&this.isDraggingLeft),this.$histogramDragHandle.css("left",e),this.isDraggingLeft?(this.$histogramGreyoutL.css("right",this.chart.width-(e+4)),this.$histogramDragMiddle.css("left",e)):(this.$histogramGreyoutR.css("left",e),this.$histogramDragMiddle.css("right",this.chart.width-e))),this.updateSelectedIndex(e,this.$histogramDragHandle,i))},v.prototype.histogramDragMouseUp=function(){this.histogramIsDragging=!1,this.pointerId&&(this.$chartCanvas[0].releasePointerCapture(this.pointerId),this.pointerId=null),this.$histogramHandleL.css("pointer-events","auto"),this.$histogramHandleR.css("pointer-events","auto"),this.$histogramDragMiddle.css("pointer-events","auto"),this.$histogramDragHandle=null},v.prototype.hitTest=function(t,e){var i=this.$el,o={};if(i){var s=i.offset();if(o.top=s.top,o.left=s.left,o.right=s.left+i.outerWidth(),o.bottom=s.top+i.outerHeight(),o.left<=t)if(t<=o.right)if(o.top<=e)if(e<=o.bottom)return{test:!0,top:e<o.top+i.outerHeight()/2}}return{test:!1}},v.prototype.initGroup=function(){var e=this;this.$el.addClass("group"),this.$el.attr("data-id",this.id),this.options.isRoot&&this.$el.addClass("rootGroup"),this.proxiedDragOver=$.proxy(this.onDragOver,this),this.$items[0].addEventListener("dragover",this.proxiedDragOver),this.proxiedDrop=$.proxy(this.onDrop,this),this.$items[0].addEventListener("drop",this.proxiedDrop),this.proxiedDragLeave=$.proxy(this.onDragLeave,this),this.$items[0].addEventListener("dragleave",this.proxiedDragLeave),this.initGroupRadio(),this.initGroupToolbar(),this.listenTo(this.model.get("children"),"add",this.onItemAdded),this.listenTo(this.model.get("children"),"remove",this.onItemRemoved),this.model.get("children").each(function(t){e.addChild(t)}),this.listenTo(this.options.appModel,"drag-started",this.onDragStarted),this.listenTo(this.options.appModel,"drag-finished",this.onDragFinished),this.proxiedDragStart=$.proxy(this.dragStart,this),this.proxiedDragEnd=$.proxy(this.dragEnd,this),this.$el[0].addEventListener("dragstart",this.proxiedDragStart),this.$el[0].addEventListener("dragend",this.proxiedDragEnd)},v.prototype.initGroupRadio=function(){this.$and=this.$el.find("#"+this.renderModel.andId),this.$andLbl=this.$el.find("label[for="+this.renderModel.andId+"]"),this.$or=this.$el.find("#"+this.renderModel.orId),this.$orLbl=this.$el.find("label[for="+this.renderModel.orId+"]"),"AND"===this.model.get("operator")?this.$and.prop("checked",!0):"OR"===this.model.get("operator")&&this.$or.attr("checked","checked"),this.$andLbl.toggleClass("ui-state-active","AND"===this.model.get("operator")),this.$orLbl.toggleClass("ui-state-active","OR"===this.model.get("operator")),this.$radioGroup.button({classes:{"ui-button":"group-and-or"}}),this.$andLbl.button({classes:{"ui-button":"ui-state-default ui-button-text-only ui-corner-left radio-and-or"}}),this.$el.find("label[for="+this.renderModel.orId+"]").button({classes:{"ui-button":"ui-state-default ui-button-text-only ui-corner-left radio-and-or"}}),this.$radioGroup.on("change",$.proxy(this.onRadioChanged,this))},v.prototype.initGroupToolbar=function(){var i=this,t=this;this.$toolbar=this.$el.find(".group-toolbar"),this.$addRuleBtn=this.$el.find(".add-rule"),this.$addRuleBtn.button({icon:"fa fa-plus"}).click($.proxy(this.onAddRule,this)),this.$addRuleMenu=this.$el.find(".add-rule-menu"),this.$addRuleMenu.select2({theme:"dashboards",width:"71px",minimumResultsForSearch:1/0}),this.$addRuleMenu.val(null).trigger("change"),this.$addRuleMenu.on("select2:select",function(t){var e=i.$addRuleMenu.val();e&&(i.onAddRuleMenu(e),i.$addRuleMenu.val(null).trigger("change"))}),this.$addGroupBtn=this.$el.find(".add-group"),this.$addGroupBtn.button({icon:"fa fa-plus"}).click(function(){i.model.get("children").add(new F({appModel:t.options.appModel}))}),this.$deleteGroupRuleBtn=this.$el.find(".delete-group"),this.$deleteGroupRuleBtn.button({icon:"fa fa-times"}).click(function(){return i.model.destroy()}),this.$toolbar[0].addEventListener("drop",this.proxiedDrop),this.$toolbar[0].addEventListener("dragover",this.proxiedDragOver),this.$toolbar[0].addEventListener("dragleave",this.proxiedDragLeave)},v.prototype.initRule=function(){var t=this,e=(this.$el.addClass("rule"),this.createRuleForm(),$(document.createElement("button")));e.addClass("delete-row btn-no-borders"),e.text("Delete"),this.$form.append(e),e.button({icon:"fa fa-trash",text:!1,showLabel:!1}).click(function(){return t.model.destroy()}),"histogram"!==this.model.get("type")&&(this.$compareFields=$(document.createElement("button")),this.$compareFields.addClass("compare-fields btn-no-borders"),this.$compareFields.text("Compare fields"),this.$compareFields.toggle(!this.useBindings),this.$form.append(this.$compareFields),this.setCompareBtnProps(this.model.get("compareFields")),this.$compareFields.button().click(function(){return t.onCompareFieldsClick(!t.model.get("compareFields"))})),this.listenTo(this.options.appModel.get("data.items"),"add remove",this.onFieldsCountChanged),this.listenTo(this.options.appModel.get("data.items"),"change",this.onFieldsItemChanged),this.listenTo(this.model,"change:propertyName",this.onModelPropertyNameChanged),this.listenTo(this.model,"change:operator",this.onModelOperatorChanged),this.listenTo(this.model,"change:value",this.onModelValueChanged),"histogram"===this.model.get("type")&&this.listenTo(this.model,"change:value2",this.onModelValueChanged)},v.prototype.onAddRule=function(t){this.model.get("children").add(new R({appModel:this.options.appModel}))},v.prototype.onAddRuleMenu=function(t){this.model.get("children").add(new R({appModel:this.options.appModel,type:t}))},v.prototype.onDragLeave=function(t){_.forEach(this.items,function(t){t.$el.removeClass("drag-over")}),this.$el.find("> .items-div.group > .droppie").hide()},v.prototype.onDragOver=function(o){var s=this;return this.draggie.queryItem.id===this.id||($(o.currentTarget).hasClass("group-toolbar")?this.$el.find("> .items-div.group > .droppie").show():_.forEach(this.items,function(t){var e,i;t.$form&&(e=t.hitTest(o.pageX,o.pageY),t.$el.removeClass("drag-over-top"),t.$el.removeClass("drag-over-bottom"),e.test)&&(i=void 0,i=e.top?(t.$el.addClass("drag-over-top"),"top"):(t.$el.addClass("drag-over-bottom"),"bottom"),s.draggie)&&(s.draggie.lastHitTest={item:t,side:i})}),!o.preventDefault)||(o.preventDefault(),!1)},v.prototype.onDragStart=function(t){this.options.appModel.trigger("drag-started",this),this.$el.addClass("draggie"),t.stopPropagation()},v.prototype.onDragStarted=function(t){this.draggie={queryItem:t}},v.prototype.onDragFinished=function(){this.draggie=null,$(".drag-over-top").removeClass("drag-over-top"),$(".drag-over-bottom").removeClass("drag-over-bottom"),this.$el.find("[draggable]").prop("draggable",!1)},v.prototype.onDrop=function(t){var e,i,o;return this.draggie.queryItem.id===this.id||(i=!(e=o=-1),!$(t.currentTarget).hasClass("group-toolbar")&&this.draggie.lastHitTest&&this.draggie.lastHitTest.item?(this.draggie.queryItem.model.collection===this.draggie.lastHitTest.item.model.collection&&(i=this.draggie.queryItem.renderModel.isGroup&&!0,o=this.draggie.queryItem.model.collection.indexOf(this.draggie.queryItem.model)),e=this.model.get("children").indexOf(this.draggie.lastHitTest.item.model),"bottom"===this.draggie.lastHitTest.side?(e<o||!i)&&(e+=1):"top"===this.draggie.lastHitTest.side&&i&&e-1===o&&--e):e=this.model.get("children").length,t=this.draggie.queryItem.model.toJSON(),this.draggie.queryItem.model.destroy(),i=_.extend({appModel:this.options.appModel},t),o=new(this.draggie.queryItem.renderModel.isGroup?F:R)(i),this.model.get("children").add(o,{at:e}),this.renderModel.isGroup&&_.each(this.items,function(t){t.removeEventHandlers()}),this.removeEventHandlers(),this.render(),this.options.appModel.trigger("drag-finished"),!1)},v.prototype.onEmptyChanged=function(){!this.model.get("children")||0<_.keys(this.items).length?this.$items.removeClass("empty"):this.$items.addClass("empty")},v.prototype.onFieldsCountChanged=function(){this.model.setSchema(),this.updateValueEditor()},v.prototype.onFieldsItemChanged=function(t,e,i){var o,s;this.form.propertyName&&(o=void 0,this.model.setSchema(),s=this.form.propertyName.$el.parent(),this.form.propertyName.off(),this.form.propertyName.remove(),o=s.parent().find(".active"),s.remove(),this.form.propertyName=new n.editors.Select({model:this.model,schema:this.model.schema.propertyName,key:"propertyName"}).render(),this.form.propertyName.on("change",$.proxy(this.onFormPropertyNameChanged,this)),o.after(this.wrapInDiv(this.form.propertyName.$el,"editor property-name type-"+this.model.get("type")))),this.updateValueEditor()},v.prototype.onItemAdded=function(t,e,i){this.addChild(t),this.onEmptyChanged()},v.prototype.onItemRemoved=function(t,e,i){var o=this.items[t.cid];delete this.items[t.cid],o&&o.remove(!0),this.onEmptyChanged()},v.prototype.onFormActiveChanged=function(t,e){this.model.set({active:t.getValue()})},v.prototype.onFormPropertyNameChanged=function(t,e){var i,o,t=t.getValue(),t=this.options.appModel.get("data.meta.columns").get(t);t?(o={propertyName:t.get("id"),propertyType:t.get("kdbType")},t.get("kdbType")!==this.model.get("propertyType")&&(t=t.get("kdbType"),i=this.model.get("propertyType"),i=this.model.get("compareFields")&&4<=t&&t<=9&&4<=i&&i<=9,o=_.extend(o,{operator:"histogram"===this.model.get("type")?null:"equal",value:1!==t&&(i?this.model.get("value"):null),value2:null}),this.leftIndex=void 0,this.rightIndex=void 0),this.model.set(o)):this.model.set({propertyName:null,propertyType:null,operator:"histogram"===this.model.get("type")?null:"equal",value:null,value2:null})},v.prototype.onFormOperatorChanged=function(t,e){this.model.set({operator:t.getValue()}),null!=(t=this.$compareFields)&&t.toggle(!_.includes(["is_blank","is_not_blank"],this.model.get("operator"))&&!this.useBindings)},v.prototype.onFormValueChanged=function(){!this.useBindings&&(this.form.value.validate()||"histogram"===this.model.get("type")&&this.model.validate(this.form.value.getValue(),this.model.get("value2")))?this.form.value.setValue(this.model.get("value")):"histogram"===this.model.get("type")?(this.form.value.momentFormat?this.model.set("value",s(this.form.value.getValue()).valueOf()):this.model.set({value:this.form.value.getValue()}),this.leftIndex=this.getValueIndex(this.model.get("value")),this.updateHandlesPosition()):this.model.set({value:this.useBindings?"<%"+(this.$bindingSelect.val()||this.$viewstateDisplay.val())+"%>":this.form.value.getValue()})},v.prototype.onFormValue2Changed=function(){this.form.value2.validate()||"histogram"===this.model.get("type")&&this.model.validate(this.model.get("value"),this.form.value2.getValue())?this.form.value2.setValue(this.model.get("value2")):(this.form.value2.momentFormat?this.model.set("value2",s(this.form.value2.getValue()).valueOf()):this.model.set({value2:this.form.value2.getValue()}),this.rightIndex=this.getValueIndex(this.model.get("value2")),this.updateHandlesPosition())},v.prototype.onModelOperatorChanged=function(t,e,i){this.model.setSchema(),this.updateValueEditor(),this.doActions(t,e,"Operator")},v.prototype.onModelPropertyNameChanged=function(t,e,i){var o=this.model;o.setSchema(),this.form.operator&&this.form.operator.setOptions(o.schema.operator.options),"histogram"===this.model.get("type")&&(this.leftIndex=void 0,this.rightIndex=void 0,this.model.set({value:null,value2:null})),"histogram"!==this.model.get("type")&&this.model.get("compareFields")?this.onCompareFieldsClick(!0):this.updateValueEditor(),this.doActions(t,e,"Operand")},v.prototype.onModelValueChanged=function(t,e,i){this.model.trigger("change"),this.doActions(t,e,"Value")},v.prototype.doActions=function(o,s,a){var r,t=this.api.getProperty("Actions");null!=t&&t.length&&(r=[],t.forEach(function(t,e){var i;t.Current===a&&(i=s,"Operand"===t.Current&&(i=o.get("propertyName")),"Operator"===t.Current&&(i=o.get("operator")),r.push(d(d({},t),{Value:i,_PropertyIndex:e})))}),0<r.length)&&this.api.doActions(r,"Actions")},v.prototype.onResizeStart=function(){this.chart&&(this.$histogramHandleL.hide(),this.$histogramHandleR.hide())},v.prototype.onResize=function(){this.chart&&(this.chart.resize(),this.updateHandlesPosition())},v.prototype.onResizeStop=function(){this.chart&&(this.chart.resize(),this.$histogramHandleL.show(),this.$histogramHandleR.show(),this.updateHandlesPosition())},v.prototype.onRadioChanged=function(){!0===this.$and.is(":checked")?this.model.set("operator","AND"):!0===this.$or.is(":checked")&&this.model.set("operator","OR"),this.$andLbl.toggleClass("ui-state-active","AND"===this.model.get("operator")),this.$orLbl.toggleClass("ui-state-active","OR"===this.model.get("operator"))},v.prototype.onSelectViewState=function(t){this.$viewstateDisplay.val(t),this.toggleBindings(!1);t=this.model.get("value");t&&t.match(v.VSRx)||(this.previousValue=t),this.onFormValueChanged()},v.prototype.render=function(){return this.renderModel={radioName:_.uniqueId("_andor"),andId:_.uniqueId("_and"),orId:_.uniqueId("_or"),isGroup:!!this.model.get("children")},this.$el.html(g.QueryItem(this.renderModel)),this.$items=this.$el.find(".items-div"),this.$radioGroup=this.$el.find(".radio-group"),this.$el.addClass("query-item"),this.model.get("children")?(this.initGroup(),this.$el.mousedown(function(t){t=$(t.target);t.hasClass("group-toolbar")&&!t.parent().hasClass("rootGroup")&&t.prop("draggable",!0)})):(this.initRule(),this.$el.mousedown(function(t){t=$(t.target);t.hasClass("the-form")&&t.prop("draggable",!0)})),this},v.prototype.remove=function(){return this.renderModel.isGroup&&_.each(this.items,function(t){t.remove()}),this.removeEventHandlers(),this.$el.remove(),this},v.prototype.removeEventHandlers=function(){var t;this.stopListening(),this.$form?(this.$form[0].removeEventListener("dragstart",this.proxiedDragStart),this.$form[0].removeEventListener("dragend",this.proxiedDragEnd)):this.model.get("children")&&(this.$radioGroup.off(),this.$addRuleBtn.button("destroy"),this.$addGroupBtn.button("destroy"),this.$deleteGroupRuleBtn.button("destroy"),this.$items[0].removeEventListener("dragover",this.proxiedDragOver),this.$items[0].removeEventListener("drop",this.proxiedDrop),this.$items[0].removeEventListener("dragleave",this.proxiedDragLeave),this.$toolbar[0].removeEventListener("drop",this.proxiedDrop),this.$toolbar[0].removeEventListener("dragleave",this.proxiedDragLeave),this.$el[0].removeEventListener("dragstart",this.proxiedDragStart),this.$el[0].removeEventListener("dragend",this.proxiedDragEnd)),this.$items.off(),this.$el.off(),null!=(t=this.$compareFields)&&t.off()},v.prototype.setCompareBtnProps=function(t){this.$compareFields.button({icon:(t?"fa fa-pencil":"fa fa-columns")+" btn-no-borders",text:!1,showLabel:!1}),this.$compareFields.prop("title",t?"Untoggle compare fields":"Compare fields")},v.prototype.updateChart=function(){var e=this,t=this.model.get("propertyType"),i=_.includes([12,13,14,15,16,17,18,19],t),o=_.includes([8,9],t),t=(this.$chartCanvas=$(document.createElement("canvas")),this.form.propertyName.$el.parent().after(this.wrapInDiv(this.wrapInDiv(this.$chartCanvas,"inner-wrap"),"editor histogram")),this.options.appModel.get("dataCollection").map(function(t){return i?a.Tools.convertKDBTemporalToMoment(t.get(e.model.get("propertyName"))).valueOf():t.get(e.model.get("propertyName"))})),s=(this.maxValue=_.max(t),this.api.getProperty("Style.HistogramBuckets")),s=(this.chartData=_.map(l.layout.histogram().bins(s).range([_.min(t),this.maxValue])(t),function(t,e){return{x:i?Math.round(t.x):o?t.x.toFixed(6):t.x,y:t.y}}),{type:"linear",display:!1,minBarLength:2,ticks:{max:_.maxBy(this.chartData,"y").y}}),t=this.api.getProperty("Style.HistogramColor"),t=(this.chart=new r(this.$chartCanvas[0].getContext("2d"),{type:"bar",data:{datasets:[{data:_.map(this.chartData,function(t,e){return{x:e+"",y:t.y}}),backgroundColor:t}]},options:{responsive:!1,maintainAspectRatio:!1,legend:{display:!1},scales:{yAxes:[s],xAxes:[{type:"linear",display:!1}]},tooltips:{enabled:!1}},plugins:[{afterDatasetsDraw:function(o,t){var e=o.getDatasetMeta(0),s=o.config.data.datasets[0].data;e.data.forEach(function(t,e){var i;0===s[e].y&&(e=t._view,t=o.chart.ctx,i=e.x-e.width/2,t.clearRect(i-1,e.y,e.width+2,2))})}}]}),this.$histogramGreyoutL=$(document.createElement("div")),this.$histogramGreyoutR=$(document.createElement("div")),this.$histogramGreyoutL.addClass("greyout left"),this.$histogramGreyoutR.addClass("greyout right"),this.$chartCanvas.parent().append(this.$histogramGreyoutL),this.$chartCanvas.parent().append(this.$histogramGreyoutR),this.$histogramDragMiddle=$(document.createElement("div")),this.$histogramDragMiddle.addClass("drag-middle"),this.$chartCanvas.parent().append(this.$histogramDragMiddle),this.$histogramDragMiddle.mousedown($.proxy(this.histogramDragMouseDown,this)),this.$histogramHandleL=$(document.createElement("div")),$(document.createElement("div")));t.addClass("grabber"),this.$histogramHandleL.append(t),this.$histogramHandleR=$(document.createElement("div")),(t=$(document.createElement("div"))).addClass("grabber"),this.$histogramHandleR.append(t),this.$histogramHandleL.addClass("left-handle"),this.$histogramHandleR.addClass("right-handle"),this.$chartCanvas.parent().append(this.$histogramHandleL),this.$chartCanvas.parent().append(this.$histogramHandleR),this.$histogramHandleL.mousedown($.proxy(this.histogramDragMouseDown,this)),this.$histogramHandleR.mousedown($.proxy(this.histogramDragMouseDown,this)),this.$chartCanvas.mousemove($.proxy(this.histogramDragMouseMove,this)),this.$chartCanvas[0].onpointermove=function(t){e.histogramIsDragging&&!e.pointerId&&(e.$chartCanvas[0].setPointerCapture(t.pointerId),e.pointerId=t.pointerId)},this.$chartCanvas.mouseup($.proxy(this.histogramDragMouseUp,this)),_.isUndefined(this.leftIndex)&&(this.model.get("value")?this.leftIndex=this.getValueIndex(this.model.get("value")):this.leftIndex=0),_.isUndefined(this.rightIndex)&&(this.model.get("value2")?this.rightIndex=this.getValueIndex(this.model.get("value2")):this.rightIndex=this.chartData.length-1),this.updateSelectedValue(),this.updateHandlesPosition(),this.onResize()},v.prototype.updateHandlesPosition=function(){var t,e,i,o,s;this.chart&&(t=this.chart.width,s=this.chartData.length,i=o=void 0,o=this.leftIndex*(e=t/s)+1,this.$histogramHandleL.css("left",o),this.$histogramGreyoutL.css("right",this.chart.width-(4+o)),s=this.rightIndex===s-1?t:this.rightIndex*e,s-=this.$histogramHandleR.width(),this.$histogramHandleR.css("left",i=1+s),this.$histogramGreyoutR.css("left",i),this.$histogramDragMiddle.css({left:o,right:t-(4+i)}))},v.prototype.updateSelectedIndex=function(t,e,i){void 0===i&&(i=null);var o=this.chart.width,s=this.chartData.length,a=o/s,t=t<=0?0:o<=t?s=-1:Math.round(t/a);e[0]===this.$histogramHandleL[0]?this.leftIndex=t:e[0]===this.$histogramHandleR[0]?this.rightIndex=t:e[0]===this.$histogramDragMiddle[0]&&(this.leftIndex=t,t=i<=0?0:o<=i?s=-1:Math.round(i/a),this.rightIndex=t),this.rightIndex>s-1&&(this.rightIndex=s-1),this.leftIndex<0&&(this.leftIndex=0),this.rightIndex>s-1&&(this.rightIndex=s-1),this.rightIndex<0&&(this.rightIndex=0),this.leftIndex>s-1&&(this.leftIndex=s-1),this.leftIndex<0&&(this.leftIndex=0),this.updateSelectedValue()},v.prototype.updateSelectedValue=function(){var t=this.chartData,e=new Number(t[this.rightIndex].x).valueOf();this.pickMaxValue&&(e=this.maxValue),this.model.set({value:t[this.leftIndex].x,value2:e})},v.prototype.updateValueEditor=function(){"histogram"===this.model.get("type")?this.updateValueEditorHistogram():this.updateValueEditorNormal()},v.prototype.updateValueEditorHistogram=function(){var t=this.model,e=(this.form.info&&(this.form.info.parent().parent().remove(),delete this.form.info),this.chart&&(this.$chartCanvas.off(),this.$histogramHandleL.off(),this.$histogramHandleR.off(),this.chart.destroy(),this.chart=null,this.$chartCanvas.parent().parent().remove(),delete this.form.chart),this.form.value2&&(e=this.form.value2.$el.parent().parent().parent(),this.form.value.off(),this.form.value.remove(),this.form.value2.off(),this.form.value2.remove(),e.parent().find(".value").remove(),e.remove()),this.model.get("propertyName")?this.debouncedUpdateChart():((e=$(document.createElement("span"))).addClass("field-info"),e.text("please select field"),this.form.info=e,this.form.propertyName.$el.parent().after(this.wrapInDiv(this.wrapInDiv(e,"inner-wrap"),"editor histogram-info"))),this.form.value=new n.editors[t.schema.value.type]({model:t,schema:t.schema.value,key:"value",id:"picker_"+_.uniqueId()}).render(),this.form.value2=new n.editors[t.schema.value.type]({model:t,schema:t.schema.value,key:"value2",id:"picker_"+_.uniqueId()}).render(),"Number"===t.schema.value.type?(this.form.value.$el.on("input",_.debounce($.proxy(this.onFormValueChanged,this),500)),this.form.value2.$el.on("input",_.debounce($.proxy(this.onFormValue2Changed,this),500))):(this.form.value.$el.on("change",_.debounce($.proxy(this.onFormValueChanged,this),500)),this.form.value2.$el.on("change",_.debounce($.proxy(this.onFormValue2Changed,this),500))),$(document.createElement("div")));e.append(this.form.value.$el),e.append(this.form.value2.$el),this.form.propertyName.$el.parent().after(this.wrapInDiv(this.wrapInDiv(e,"inner-wrap"),"editor value2 type-histogram"+(this.model.get("propertyName")?"":" disabled"))),this.form.propertyName.$el.parent().after(this.wrapInDiv(this.wrapInDiv($("<div class='empty-div type-histogram'></div>"),"inner-wrap"),"editor value type-histogram place-hiolder"))},v.prototype.updateValueEditorNormal=function(){var o,t,e,s=this,i=this.model,a="",r=(this.form.value&&(r=this.form.value.$el.parent().parent(),this.form.value.off(),this.form.value.remove(),this.toggleCompareFields(!0),(0<r.find(".value-wrap").length?r.parent():r).remove(),this.originalDropDownValues=null),"is_blank"!==this.model.get("operator")&&"is_not_blank"!==this.model.get("operator")?(_.isString(i.get("value"))&&i.get("value").match(v.VSRx)&&(a=i.get("value"),i.set("value","")),"Number"===i.schema.value.type?this.form.value=new n.editors.Text({model:i,schema:{type:"Text",validators:["number"]},key:"value",id:"picker_"+_.uniqueId()}).render():((r=_.find(this.options.appModel.get("Items"),{propertyName:i.get("propertyName")}))&&(i.schema.value.inputItemLimit=r.FieldSummaryThreshold),o=i.get("compareFields")?this.options.appModel.get("data.meta.columns"):null,i.schema.value.sortListBySelected=!i.get("compareFields")&&this.options.appModel.get("format.SortListBySelected"),i.get("compareFields")||"Select"!==i.schema.value.type&&"MultiSelect"!==i.schema.value.type||(this.originalDropDownValues?i.schema.value.options=h([],this.originalDropDownValues,!0):this.originalDropDownValues=h([],i.schema.value.options,!0),"MultiSelect"===i.schema.value.type&&(i.schema.value.multiSelect=!0)),this.form.value=new n.editors[i.get("compareFields")?"Select":i.schema.value.type]({model:i,schema:i.get("compareFields")?_.mapValues(i.schema.propertyName,function(t,e){return"options"!==e?t:_.filter(t,function(t){var e=s.model.get("propertyType"),i=o.get(t.val).get("kdbType");return 4<=e&&e<=9&&4<=i&&i<=9||s.model.get("propertyType")===o.get(t.val).get("kdbType")})}):i.schema.value,key:"value",id:"picker_"+_.uniqueId()}).render(),i.schema.value.sortListBySelected&&this.originalDropDownValues&&(i.schema.value.options=h([],this.originalDropDownValues,!0))),this.form.value.$el.attr("data-name",i.get("propertyName")),"Text"===i.schema.value.type||"Number"===i.schema.value.type?(this.form.value.$el.attr("type","search"),this.form.value.$el.on("input",_.debounce($.proxy(this.onFormValueChanged,this),500)),this.form.value.on("changeList",this.onFormValueChanged)):(t=this.form.value,e=this.originalDropDownValues,"Select"!==i.schema.value.type&&"MultiSelect"!==i.schema.value.type||(this.form.value.$el.on("select2:closing",function(){t.sortListBySelected&&(t.setOptions(t.schema.options),t.schema.options=h([],e,!0))}),this.form.value.$el.on("change",function(){t.sortListBySelected&&(!t.multiSelect||t.multiSelect&&!t.$el.select2("isOpen"))&&(t.setOptions(t.schema.options),t.schema.options=h([],e,!0))})),this.form.value.on("change changeList",$.proxy(this.onFormValueChanged,this)),this.onFormValueChanged())):(this.model.set("value",null),this.form.value={$el:$("<div class='empty-div'></div>"),off:function(){},remove:function(){this.$el.remove()}}),this.$bindings=null,!this.form.value.$el.hasClass("empty-div")&&(0<this.options.appModel.get("settingsModel").get("Bindings").length||this.options.appModel.get("settingsModel").get("Basics.UseViewStates"))&&(this.$bindings=$(g.bindingSelect({})),this.$bindingApply=this.$bindings.find(".binding-apply"),this.$bindingClear=this.$bindings.find(".binding-clear-dialog"),this.$bindingContainer=this.$bindings.find(".binding-container"),this.$bindingSelect=this.$bindings.find(".binding-select"),this.$viewstateDisplay=this.$bindings.find(".viewstate-display"),this.$viewstateIcon=this.$bindings.find(".viewstate-icon"),this.$bindingApply.click(this.showBindingsDropdown.bind(this)),this.$bindingClear.click(this.onBindingsClear.bind(this)),this.options.appModel.get("settingsModel").get("Basics.UseViewStates")?(this.$bindings.find(".binding-dropdown").hide(),this.$viewstateDisplay.click(this.showBindingsDropdown.bind(this))):(this.$viewstateIcon.hide(),this.$viewstateDisplay.hide(),this.$bindingSelect.on("select2:select",$.proxy(this.onFormValueChanged,this)))),this.$bindings&&this.form.value.$el.addClass("bindings-available"),this.$bindings?(this.form.value.$el.is("div, select")?this.wrapInDiv(this.form.value.$el,"value-wrap"):this.form.value.$el).add(this.$bindings):this.form.value.$el);this.form.operator.$el.parent().after(this.wrapInDiv(this.wrapInDiv(r,"inner-wrap"),"editor value")),this.$bindingApply&&this.model.get("compareFields")?this.$bindingApply.hide():(a||this.useBindings)&&this.showBindingsDropdown(null,this.removeVSChars(a))},v.prototype.getBindings=function(){var e=this.form.value.model.get("propertyType");return null!==e?_.map(_.filter(this.options.appModel.get("settingsModel").get("Bindings"),function(t){return t.ViewState&&(t.ViewState.get("_type")===n.RTTI.getByQTypeNum(e).name||"string"===t.ViewState.get("_type")&&0===e)}),function(t){return t.Key}):[]},v.prototype.toggleBindings=function(t){var e=this.options.appModel.get("settingsModel").get("Basics.UseViewStates");(this.options.appModel.get("settingsModel").get("Bindings").length||e)&&((this.form.value.$el.parent().hasClass("value-wrap")?this.form.value.$el.parent():this.form.value.$el).toggle(t),this.form.value.$el.toggle(t),this.$bindingApply.toggle(t),this.$bindingContainer.toggle(!t),this.toggleCompareFields(t),this.useBindings=!t,e)&&this.$bindingContainer.toggleClass("useViewState",!t)},v.prototype.onBindingsClear=function(){this.model.set("value",this.previousValue),this.toggleBindings(!0),this.displayOptions(!0)},v.prototype.showBindingsDropdown=function(t,e){var i;this.options.appModel.get("settingsModel").get("Basics.UseViewStates")?_.isNil(e)?this.options.appModel.get("api").renderViewStateDialog({path:this.removeVSChars((this.form.model||this.form.value.model).get("value")),selectCallback:this.onSelectViewState.bind(this)}):this.onSelectViewState(e):(this.toggleBindings(!1),this.previousValue=this.model.get("value"),i=this.getBindings(),this.$bindingSelect.select2({data:i,multiple:!1,theme:"dashboards",width:"100%",language:{noResults:function(){return"No matching bindings"}}}),this.$bindingSelect.val(e||""),this.$bindingSelect.trigger("change"),this.$bindingSelect.trigger("select2:select")),this.displayOptions(!0)},v.prototype.onCompareFieldsClick=function(t){var e=this.model,i=(e.set("compareFields",t),e.setSchema(),t||e.set("value",null),this.form.operator);i&&(i.setOptions(e.schema.operator.options),i.setValue(_.includes(e.schema.operator.options.map(function(t){return t.val}),i.getValue())?i.getValue():"equal"),e.set("operator",i.getValue())),this.toggleBindings(!0),this.updateValueEditor(),this.setCompareBtnProps(t),this.toggleCompareFields(!0)},v.prototype.toggleCompareFields=function(t){var e;null!=(e=this.$compareFields)&&e.toggle(t)},v.prototype.removeVSChars=function(t){return _.isString(t)?t.replace(v.VSRx,function(t){return t.substring(2,t.length-2)}):t},v.prototype.wrapInDiv=function(t,e){var i=$(document.createElement("div"));return e&&i.addClass(e),i.append(t),i},v.VSRx=/^<%[^<>%]*%>$/i;var c,f=v;function v(t){var e=c.call(this,t)||this;return e.id=_.uniqueId("qi_"),e.items={},e.chart=null,e.proxiedDragStart=null,e.proxiedDragEnd=null,e.proxiedDragOver=null,e.proxiedDrop=null,e.proxiedDragLeave=null,e.pickMaxValue=!1,e.useBindings=!1,e.options=t,e.debouncedUpdateChart=_.debounce($.proxy(e.updateChart,e),500),e.api=t.api,e.render(),e.onEmptyChanged(),e}var y;y=e.Model,i(b,y),b.prototype.defaults=function(){return{id:null,index:null,kdbType:null,type:null}};function b(t){t=y.call(this,t)||this;t.idAttribute="id";return t}D=e.Collection,i(M,D);var D,w=M;function M(t){t=D.call(this,t)||this;return t.comparator="id",t}C=e.Model,i(S,C),Object.defineProperty(S.prototype,"idAttribute",{get:function(){return"propertyName"},enumerable:!1,configurable:!0}),S.prototype.defaults=function(){return{propertyName:null,data:"",items:[]}},S.prototype.initializeEvents=function(){this.listenTo(this,"change:data",this.onDataChanged)},S.prototype.onDataChanged=function(){this.currentDataSource&&(this.currentDataSource.unsubscribe(this.subscriptionId),this.currentDataSource=void 0),this.unset("result");var t=_.findIndex(S.options.api.getProperty("Items"),{propertyName:this.get("propertyName")});-1!=t&&(S.options.api.setProperty("Items."+t+".DropdownPossibleValues",[],{silent:!0}),S.options.api.setProperty("Items."+t+".DataSourceMapping.Value","",{silent:!0}),S.options.api.setProperty("Items."+t+".DataSourceMapping.Text","",{silent:!0})),this.get("data")&&(this.currentDataSource=this.get("data"),this.currentDataSource.subscribe(this.subscriptionId,this))},S.prototype.onData=function(t,e,i){var o=this;t&&t.columns&&t.columns.reset&&(o.set("result",{meta:t,data:e,options:i}),-1!=(e=_.findIndex(S.options.api.getProperty("Items"),{propertyName:o.get("propertyName")})))&&(S.options.api.setProperty("Items."+e+".DropdownPossibleValues",_.flatMap(t.columns.reset,"id")),S.options.api.setProperty("Items."+e+".DataSourceMapping.Value",o.get("DataSourceMapping.Value")||o.get("propertyName")),S.options.api.setProperty("Items."+e+".DataSourceMapping.Text",o.get("DataSourceMapping.Text")||o.get("propertyName")))},S.prototype.onRemoved=function(){this.currentDataSource&&(this.currentDataSource.unsubscribe(this.subscriptionId),this.currentDataSource=void 0)};var C,x=S;function S(t){t=C.call(this,t)||this;return t.subscriptionId=_.uniqueId("DataFilterItem"),t.initializeEvents(),t.onDataChanged(),t}I=e.Collection,i(L,I);var I,V=L;function L(t){t=I.call(this,t)||this;return t.model=x,t}B=e.DeepModel,i(N,B),N.prototype.defaults=function(){return{"data.meta.columns":new w,"data.items":new V}},N.prototype.onDataItemRemoved=function(t,e,i){t.onRemoved()},N.prototype.reset=function(){this.get("data.meta.columns").reset(),this.get("data.items").reset()};var B,k=N;function N(t){var e=B.call(this,t)||this;return e.subscriptions=[],e.options=t,e.listenTo(e.get("data.items"),"remove",e.onDataItemRemoved),e}var T,R=a.DataFilter.RuleModel,F=a.DataFilter.GroupModel;function E(t){var e=T.call(this,t)||this;return e.newDS=!1,e.userChanging=!0,e.options=t,e.api=t.api,E.DeltaClientLib=e.options.DeltaClientLib,x.options=e.options,e.onDataCallback=$.proxy(e.onData,e),e.viewModel=new k(e.options),e.options.viewModel=e.viewModel,e.initializeEvents(),e}return T=a.DataFilter.App,i(E,T),E.prototype.clearData=function(){this.viewModel.reset(),this.rootGroup&&(this.stopListening(this.rootGroup.model),this.rootGroup.remove(),this.rootGroup=null),this.api.setProperty("Basics.queryModel",""),this.onMetaChanged()},E.prototype.initializeEvents=function(){this.listenTo(this.viewModel,"change:error",this.updateErrorMessage),this.listenTo(this.viewModel,"change:Basics.data",this.onDataSourceChanged),this.listenTo(this.viewModel,"change:Items",this.onMetaItemsChanged),this.listenTo(this.viewModel,"change:Basics.queryModel change:format.SortListBySelected",this.onQueryModelChanged),this.onQueryModelChanged()},E.prototype.onDataSourceChanged=function(){var t=this.viewModel.get("Basics.data");this.currentDs!=t&&(this.api.hideQueryStatus(),this.currentDs&&(this.api.unsubscribe(this.currentDs),this.currentDs=null),t)&&(this.currentDs=t,this.api.showQueryStatus({type:"Loading"}),this.newDS=!0,this.api.subscribe(this.currentDs,this.onData.bind(this)))},E.prototype.onData=function(t,e,i){i?this.viewModel.set("error",i):(i=this.viewModel.get("data.meta.columns"),this.api.hideErrorMessage(),this.api.hideQueryStatus(),t.columns.reset?i.reset(t.columns.reset):(i.remove(_.map(t.columns.remove,function(t){return t.id})),i.add(t.columns.add),i.add(t.columns.change,{merge:!0})),this.onMetaChanged(),this.newDS&&(this.newDS=!1,this.onQueryModelInit()),this.viewModel.set("dataCollection",e.collection))},E.prototype.onMetaChanged=function(){var i=[],o=this;this.viewModel.get("data.meta.columns").each(function(t){var e=o.viewModel.get("data.items").get(t.id);i.push(e?_.pick(e.attributes,"propertyName","data","items","DataSourceMapping","FieldSummaryThreshold"):{propertyName:t.id,data:"",items:[],FieldSummaryThreshold:p.default_FieldSummaryThreshold})}),this.api.setProperty("Items",i)},E.prototype.onMetaItemsChanged=function(){var e=this,i=this.viewModel.get("Items"),o=this,t=this.viewModel.get("data.items").filter(function(t){t={propertyName:t.get("propertyName")};return!_.some(i,t)});_.each(t,function(t){return e.viewModel.get("data.items").remove(t)}),_.each(i,function(t){o.viewModel.get("data.items").add(t,{merge:!0})})},E.prototype.rCall=function(e,t){var i=this;t&&(t[e]&&t[e](),_.each(t.items,function(t){i.rCall(e,t)}))},E.prototype.onResizeStart=function(){this.rCall("onResizeStart",this.rootGroup)},E.prototype.onResize=function(){this.rCall("onResize",this.rootGroup)},E.prototype.onResizeStop=function(){this.rCall("onResizeStop",this.rootGroup)},E.prototype.onSettingsChange=function(t){var i=this;_.each(t,function(t,e){i.viewModel.set(e,t),"Bindings"===e&&i.rootGroup?i.processAllItems(i.rootGroup.items,function(e){0===t.length||e.useBindings&&!_.find(t,function(t){return e.model.get("value")==="<%"+t.Key+"%>"})?e.preventBindings():e.allowBindings()}):(_.includes(e,"Bindings")||_.includes(e,"Histogram"))&&i.rootGroup&&(i.userChanging=!_.includes(e,"Histogram"),i.onQueryModelChanged(),i.userChanging=!1)})},E.prototype.onQueryModelInit=function(){var e=this,t=null,i=this.viewModel.get("Basics.queryModel");try{i?t=JSON.parse(i):this.viewModel.set("kdbString",""),this.renderTemplate(t)}catch(t){this.viewModel.set("error","Query model in view state contains errors. Bad JSON."),this.listenToOnce(this.viewModel,"change:queryModel",function(){e.viewModel.set("error",null)}),setTimeout(function(){e.viewModel.set({queryModel:"",kdbString:""}),e.renderTemplate(null)},3e3)}},E.prototype.onQueryModelChanged=function(){var t=this;this.rootGroup&&(this.kxStringUpdate&&clearTimeout(this.kxStringUpdate),this.kxStringUpdate=setTimeout(function(){t.api.setProperty("Basics.kdbString",a.ipc.Util.toHexString(a.ipc.Util.toMessage(t.rootGroup.model.toIPC())))},700),this.userChanging||(this.stopListening(this.rootGroup.model),this.rootGroup.remove(),this.onQueryModelInit()))},E.prototype.processAllItems=function(t,e){var i=this;_.each(t,function(t){t.renderModel.isGroup?i.processAllItems(t.items,e):e(t)})},E.prototype.remove=function(){this.currentDs&&this.api.unsubscribe(this.currentDs);var t=this.viewModel.get("data.items");return t&&_.each(t.models,function(t){return t.onRemoved()}),e.View.prototype.remove.call(this)},E.prototype.renderTemplate=function(t){var e,i=this;return this.$el.html(g.app({})),_.extend(t||{},{appModel:this.viewModel}),e=new F(t),this.rootGroup=new f({api:this.api,model:e,appModel:this.viewModel,el:this.$(".query-builder"),isRoot:!0}),this.listenTo(e,"change",function(){i.userChanging=!0,i.api.setProperty("Basics.queryModel",JSON.stringify(e.toJSON())),i.userChanging=!1}),this.userChanging&&this.onQueryModelChanged(),this.userChanging=!1,this},E.prototype.updateErrorMessage=function(t){this.viewModel.get("error")?this.api.showErrorMessage({error:t.get("error"),type:"Error"}):this.api.hideErrorMessage()},E.getComponentDefinition=p.getComponentDefinition,E.PROP_BINDINGS="Bindings",E});
define(["backbone","Handlebars","moment","QuickBase","xlsx","css!./css/app.css"],function(y,i,f,d,N){var o,I=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var o,n=0,a=t.length;n<a;n++)!o&&n in t||((o=o||Array.prototype.slice.call(t,0,n))[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))},m=this&&this.__assign||function(){return(m=Object.assign||function(e){for(var t,i=1,o=arguments.length;i<o;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},e=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}))(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),w=(r.focus2Array=function(e){var t=[],i=/"([^"]*)"/g,e=e.toString?e.toString():"",o=/^\[([^\]]*)]$/.exec(e);if(null!=o){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(o[1]))for(var n=void 0;null!==(n=i.exec(o[1]));)t.push(_.map(n[1].split(","),function(e){return e}))}else t.push(e.split(","));return _.filter(t,function(e){return 0<(""+e).length})},r.focus2SingleCommonPath=function(e){for(var o=r.focus2Array(e),n=[],t=_.min(_.map(o,"length"))||0,i=0;i<t&&"break"!==function(t){var i=o[0][t];if(!_.every(o,function(e){return e[t]===i}))return"break";n.push(i)}(i);i++);return n},r.focus2Object=function(e){return _.reduce(r.focus2Array(e),function(e,t,i){for(var o=t.length,n=e,a=0;a<o;a++){var r=t[a];n[r]||(n[r]={}),n=n[r]}return e},{})},r.getDepth=function(e){function o(e,i){return void 0===i&&(i=[]),_.isEmpty(e)?[i]:_.flatMap(e,function(e,t){return o(e,I(I([],i,!0),[t],!1))})}return _.reduce(o(e),function(e,t){return e=t.length>e?t.length:e},0)},r.hasCalc=function(){var e=document.createElement("div");return e.style.cssText="width:"+["","-webkit-","-moz-","-o-","-ms-"].join("calc(10px);width:"),!!e.style.length},r.sumArrayValues=function(e){return e.reduce(function(e,t){return e+t},0)},r.getConditionResult=function(e,t,i){var o,n,a=!1;switch(r.OPERATORS_FOR_CONVERTION[i]&&(o=(""+e).toLowerCase(),n=(""+t).toLowerCase()),i){case"contains":a=0<=o.indexOf(n);break;case"starts with":a=0===o.indexOf(n);break;case"ends with":a=-1!==o.indexOf(n,o.length-n.length);break;case"==":a=e==t;break;case"<":a=e<t;break;case">":a=t<e;break;case"<=":a=e<=t;break;case">=":a=t<=e;break;case"!=":a=e!=t;break;default:console.log("GRID: highlight rule with unknown operator: ",i)}return a},r.OPERATORS_FOR_CONVERTION=_.reduce(["contains","starts with","ends with","search"],function(e,t){return e[t]=!0,e},{}),r);function r(){}n.app=i.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){return'<div class="Datatable">\n    \n    <div class="title">\n    </div>\n\n    <div class="frame">\n    </div>\n\n</div>\n'},useData:!0}),n.columnConfiguration=i.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){return'<p>\n    Display selected columns\n</p>\n\n<ul class="lstColumns">\n    \n</ul>'},useData:!0}),n.datatable=i.template({1:function(e,t,i,o,n){var a=null!=t?t:e.nullContext||{},r=e.hooks.helperMissing,l=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="table-tools">\n\t<a class="toggle-drilldown"><input type="checkbox" title= "When checked, drilldown behavior uses a single column when expanding values">'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Single Column Drilldown",{name:"t",hash:{},data:n,loc:{start:{line:3,column:137},end:{line:3,column:168}}}))+'</a>\n\t<a class="toggle-filters"><i class="fa fa-fw fa-filter"></i><span>'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Show Filters",{name:"t",hash:{},data:n,loc:{start:{line:4,column:67},end:{line:4,column:87}}}))+'</span></a>\n    <a class="reset-filters" style="display:none"><i class="fa fa-fw fa-times"></i><span>'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Reset Filters",{name:"t",hash:{},data:n,loc:{start:{line:5,column:89},end:{line:5,column:110}}}))+'</span></a>\n    <span class="lnksExport link-disabled">\n        <i class="fa fa-fw fa-download" title="'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Download",{name:"t",hash:{},data:n,loc:{start:{line:7,column:47},end:{line:7,column:63}}}))+'"></i>\n        <a class="lnkExcelExport" title="'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Download the current dataset in Excel format",{name:"t",hash:{},data:n,loc:{start:{line:8,column:41},end:{line:8,column:93}}}))+'">'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Excel",{name:"t",hash:{},data:n,loc:{start:{line:8,column:95},end:{line:8,column:108}}}))+'</a>\n        <a class="lnkCsvExport" title="'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Download the current dataset in CSV format",{name:"t",hash:{},data:n,loc:{start:{line:9,column:39},end:{line:9,column:89}}}))+'">'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"CSV",{name:"t",hash:{},data:n,loc:{start:{line:9,column:91},end:{line:9,column:102}}}))+'</a>\n        <a class="lnkFullExport" title="'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Download the full dataset from the server",{name:"t",hash:{},data:n,loc:{start:{line:10,column:40},end:{line:10,column:89}}}))+'">'+l((e(i,"t")||t&&e(t,"t")||r).call(a,"Full",{name:"t",hash:{},data:n,loc:{start:{line:10,column:91},end:{line:10,column:103}}}))+'</a>\n    </span>\n</div>\n<div class="table-header">\n    <div class="table-row"></div>\n</div>\n'},compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){return(null!=(i=(e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]})(i,"if").call(null!=t?t:e.nullContext||{},t,{name:"if",hash:{},fn:e.program(1,n,0),inverse:e.noop,data:n,loc:{start:{line:1,column:0},end:{line:16,column:7}}}))?i:"")+'<div class="table-body">\n    <div class="scrollfix">\n        <div class="table-content"></div>\n    </div>\n</div>\n<div class="table-footer">\n\t<div class="table-row"></div>\n</div>'},useData:!0});var L=n;function n(){}l.generateColorSchema=function(e){for(var t=[],i=l.hexToRgb(e),o=i.r,n=i.g,a=i.b,r=0;r<10;r++)t[r]="rgb("+(o-10*r)+","+(n-10*r)+","+(a-10*r)+")";return t.reverse(),l.COLOR_SCHEMAS[e]=t},l.getColor=function(e,t){return e=e.replace("#",""),(l.COLOR_SCHEMAS[e]||l.generateColorSchema(e))[t]},l.hexToRgb=function(e){return{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16)}},l.COLOR_SCHEMAS={};var W=l;function l(){}a.prototype.applyHighlightRules=function(e){var n,a,r,l,s,d,h,c,u,p=this;if(this.hlRules=e,this.highlightBgColor="",!this.highlightRulesActive&&e.length){for(this.highlightRulesActive=!0,this.innerEl=document.createElement("div");this.el.firstChild;)this.innerEl.appendChild(this.el.removeChild(this.el.firstChild));this.el.className+=" highlightRulesActive",this.innerEl.className="highlightDiv",this.el.appendChild(this.innerEl)}var t=this.breakdown,g=_.isEmpty(t.focus)?0:_.first(w.focus2Array(t.focus)).length,f=t?t.breakdownColumns:[];this.iconsDiv&&this.iconsDiv.parentElement&&this.innerEl.removeChild(this.iconsDiv),this.iconsDiv=void 0,_.includes(_.keys(this.model.attributes),this.dataDef.field)&&(_.forEachRight(e,function(e){var t,i=!1,o=_.includes(["Fill Left-to-Right","Fill Right-to-Left"],e.ConditionOperator);"*"!==e.Target&&e.Target!==p.dataDef.field||("{breakdownId}"===(t=e.ConditionSource)&&(t=f[g]),t=p.model.get(t),7===p.dataDef.kdbType&&_.isString(t)&&!isNaN(parseInt(t,10))?t=parseInt(t,10):_.isString(t)&&!isNaN(Number(t))&&(t=Number(t)),n=e.BackgroundColor,a=p.negativeColor||e.Color,r=e.BorderColor,l=e.Icon,s=e.IconColor||"transparent",o?_.isNumber(t)&&(d=e.ConditionOperator,h=e.BackgroundColor,c=e.BorderColor,u=Math.max(0,Math.min(100,t))):"previous value"===e.ConditionValue?(console.log(m({},p.model)),p.model.hasChanged()&&!_.isUndefined(p.model.changed[e.ConditionSource])&&w.getConditionResult(t,p.model.previous(e.ConditionSource),e.ConditionOperator)&&(i=!0)):w.getConditionResult(t,e.ConditionValue,e.ConditionOperator)&&(i=!0)),i&&(!n||p.selected&&p.rowSelectionMode||(p.setBgColor(n),p.highlightBgColor=e.BackgroundColor),a&&(p.el.style.color=p.innerEl.style.color=a),r&&(p.el.style.border="1px solid "+r),l)&&(o=0===l.indexOf("mi-")?"mi":"fa",p.iconsDiv||(p.iconsDiv=document.createElement("div"),"left"==p.el.style.textAlign?p.iconsDiv.className="cellIconsRight":p.iconsDiv.className="cellIconsLeft",p.innerEl.prepend(p.iconsDiv)),(t=document.createElement("span")).style.color=s,t.className=o+" "+l+" cellIcons",p.iconsDiv.prepend(t))}),d)&&(h||c)&&(this.ladderDiv||(this.ladderDiv=document.createElement("div")),this.ladderDiv.className=d.replace(" ","_"),this.ladderDiv.style.width=u+"%",h&&(this.ladderDiv.style.backgroundColor=h),c&&(this.ladderDiv.style.border="1px solid "+c),this.innerEl.prepend(this.ladderDiv))},a.prototype.applyRangeBackground=function(e,t,i,o,n){this.rangeArgs=[e,t,i,o,n],e!==this.dataDef.columnConfig.Field||this.selected&&this.rowSelectionMode||this.highlightBgColor||(e=this.model.get(this.dataDef.columnConfig.Field),n=Math.round(9*(o===i?1:n?(e-o)/(i-o):(e-i)/(o-i))),e=W.getColor(t,n),t&&(this.rangeBgColor=e,this.setBgColor(e)))},a.prototype.generateFormatterFunction=function(u){var p,o,n,a,g=this,f=u.Field,r=!1,e=this.dataDef.kdbType;return e&&7===e&&(r=!0),e=_.trim(u.Template)?(p=i.compile(u.Template),function(i,o,n){var t,a=this;try{var r,e,l,s,d,h=_.omit(o.attributes,["subscribe","unsubscribe"]),c=_.isUndefined(i)?o.get(f):o.get(i);d=_.includes(["General","Percentage","Boolean"],n.Format)?h:(r=g.generateFormatterFunction(_.extend({},n,{Template:"",HighlightNegative:!1})),e=_.extend({thisValue:c},h),l=u.Template.match(/\{\{(.*?)\}\}/g).join(" "),(s=_.union(Object.keys(e).filter(function(e){return l.match(new RegExp(e))}),["thisValue"])).unshift(e),d=_.pick.apply(_,s),_.mapValues(d,function(e,t){return r("thisValue"===t?i:t,o,n)})),d=_.extend({},h,{thisField:i,thisValue:d[i],thisRawValue:c},d),t=p(_.extend(d,H.componentApi.getTemplateViewStates(u.Template))),this.innerEl&&(this.unsubscribeTemplateViewStates(),this.subscriptionKey=H.componentApi.subscribeTemplateViewStates(u.Template,function(e){t=p(_.extend(d,e)),a.innerEl.innerHTML=t}))}catch(e){t=""}if(!this.innerEl)return t;this.innerEl.innerHTML=t}):"Number"===u.Format||"Formatted Number"===u.Format||"Smart Number"===u.Format?function(e,t,i){t=_.isUndefined(e)?t.get(f):t.get(e),e=t;return null==t?"":(e="Smart Number"===i.Format?E.smartFormatNumber(t,i.Precision,!0):"Formatted Number"===i.Format?E.formatNumber(t,i.Precision):E.toFixedNumber(t,i.Precision),e=g.hideTralingZeroes(e,i.HideTrailingZeroes),this.innerEl?void(this.innerEl.textContent=e):e)}:"Date"===u.Format||"Time"===u.Format||"DateTime"===u.Format?function(e,t,i){var o="DateTime"===i.Format,n="Time"===i.Format,t=_.isUndefined(e)?t.get(f):t.get(e),e=E.convertKDBTemporalToMoment(t),t=_.isNull(t)||_.isFunction(e.isValid)&&!e.isValid()?_.escape(t):n?e.formatNano(i.TimeFormat,{trim:!1,trimNano:!1}):o?e.formatNano(i.DateFormat+" "+i.TimeFormat,{trim:!1,trimNano:!1}):e.formatNano(i.DateFormat);if(!this.innerEl)return t;this.innerEl.textContent=t}:"Percentage"===u.Format?function(e,t,i){var o,n,t=_.isUndefined(e)?t.get(f):t.get(e);if(r&&_.isString(t)&&(t=parseInt(t,10)),n=_.isNumber(t)?(t*=100,e="",o=Math.max(0,t),o=Math.min(100,o),(n=i.PercentageColorOverride)&&(e="background-color:"+n+";color:"+n+";"),t=t.toFixed(u.Precision),t=g.hideTralingZeroes(t,i.HideTrailingZeroes),this.innerEl?'<div class="percentageFormatter"><p style="'+e+"width:"+o+'%">.</p><span>'+t+"%</span></div>":t):_.escape(t),!this.innerEl)return n;this.innerEl.innerHTML=n}:function(e,t,i){t=_.isUndefined(e)?t.get(f):t.get(e);return t&&"1216"===t.class?t.toString():this.innerEl?void(this.innerEl.textContent=t):_.escape(t)},"none"!==u.Currency&&0<=u.Format.toLowerCase().indexOf("number")&&(o=g.CURRENCY_SYMBOL_MAP[u.Currency],n=e,e=function(e,t,i){e=n.apply(this,[e,t,i]);if(this.innerEl)this.innerEl.innerHTML=o+this.innerEl.textContent;else{if(!this.el)return o+e;this.el.innerHTML=o+e}}),u.HighlightNegative&&(a=e,e=function(e,t,i){e=a.apply(this,[e,t,i]),t=t.get(f);if(!this.innerEl)return e;_.isNumber(t)&&t<0?this.el.style.color=this.negativeColor=i.HighlightNegativeColor:this.el.style.color=this.negativeColor=""}),e},a.prototype.hideTralingZeroes=function(e,t){var i=e.toString();if(t&&0<=i.indexOf(".")){for(e="",(t=i[i.length-1]).match(/[kmbtpe]/i)&&(e=t,i=i.slice(0,-1));"0"===i[i.length-1];)i=i.slice(0,-1);"."===i[i.length-1]&&(i=i.slice(0,-1)),i+=e}return i},a.prototype.highlightMaxOrMin=function(){function e(e,t){!(i.highlightBgColor||i.selected&&i.rowSelectionMode)&&i.model.get(e)&&-1<i.model.get(e).split(",").indexOf(i.dataDef.columnConfig.Field)&&(i.minMaxBgColor=t||i.bgColor,i.setBgColor(i.minMaxBgColor))}var i=this;e("isMin",this.dataDef.columnConfig.HighlightMinValueColor),e("isMax",this.dataDef.columnConfig.HighlightMaxValueColor)},a.prototype.onModelChange=function(e){var t,i,o,n,a=this,r=this.model.get(this.dataDef.field),l="transparent",s="none";r!==this.contentCache&&(this.dataDef.columnConfig&&(a.dataDef.formatterFn=a.generateFormatterFunction(a.dataDef.columnConfig),this.highlightChangeDuration=this.dataDef.columnConfig.HighlightChangeDuration||1500,i=parseFloat(r),o=parseFloat(this.contentCache),_.isNumber(i))&&_.isNumber(o)&&(this.dataDef.columnConfig.HighlightChanges&&(l=$(this.el).css("background-color"),n=o<i?"#7FFF8E":"#FF7F7F",$(this.el).stop(!0,!0).css("background-color",n).animate({backgroundColor:l},a.highlightChangeDuration)),s=o<i?"up":i<o?"down":"none"),this.contentCache=r,a.dataDef.formatterFn?a.dataDef.formatterFn.apply(this,[this.dataDef.field,this.model,this.dataDef.columnConfig]):this.innerEl.textContent=r,!a.dataDef.columnConfig.isBreakdown)&&this.showAggregateFunctionTooltip&&(n=a.dataDef.columnConfig.aggFnText)&&this.innerEl.setAttribute("title",n),this.applyHighlightRules(this.hlRules),a.dataDef.columnConfig.ShowArrowsOnChange&&("up"===s?t=$('<i class="fa fa-caret-up"></i>'):"down"===s&&(t=$('<i class="fa fa-caret-down"></i>')),t&&$(a.innerEl).append(t),_.delay(function(){$(a.innerEl).find(">i").remove()},400))},a.prototype.onModelPropertyChange=function(e,t){t!==this.contentCache&&(this.contentCache=t,this.innerEl.textContent=t)},a.prototype.layout=function(e,t,i){e!==this.cachedHidden&&(this.cachedHidden=e,this.el.style.visibility=e?"hidden":"visible"),e||(t!==this.cachedLeft&&(this.cachedLeft=t,this.el.style.left=t+"px"),i!==this.cachedWidth&&(this.cachedWidth=i,this.el.style.width=i+"px"),this.dataDef.columnConfig.TextAlign!==this.cachedTextAlign&&(this.cachedTextAlign=this.dataDef.columnConfig.TextAlign,this.el.style.textAlign=this.cachedTextAlign,"left"==this.cachedTextAlign&&this.iconsDiv?this.iconsDiv.className="cellIconsRight":"left"!=this.cachedTextAlign&&this.iconsDiv&&(this.iconsDiv.className="cellIconsLeft")))},a.prototype.refreshHighlights=function(e){e===this.dataDef.columnConfig.Field&&(this.resetTextAndBorder(),this.resetBgColor())},a.prototype.remove=function(){this.unsubscribeTemplateViewStates(),this.el.remove()},a.prototype.resetBgColor=function(e){e?this.bgColor=e:e=this.bgColor,this.setBgColor(e),this.hlRules.length&&(this.applyHighlightRules(this.hlRules),this.highlightBgColor||(this.minMaxBgColor?this.highlightMaxOrMin():this.rangeBgColor&&this.applyRangeBackground.apply(this,this.rangeArgs)))},a.prototype.resetTextAndBorder=function(){this.el.style.color=this.negativeColor||"",this.el.style.border="",this.innerEl&&(this.innerEl.style.color=this.negativeColor||"")},a.prototype.setBgColor=function(e){this.el.style.backgroundColor=e},a.prototype.unsubscribeTemplateViewStates=function(){this.subscriptionKey&&(H.componentApi.unsubscribeTemplateViewStates(this.subscriptionKey),this.subscriptionKey="")},a.DEFAULT_COLOR="transparent";var z=a;function a(e,t,i,o,n,a,r){this.bgColor="",this.rangeBgColor="",this.minMaxBgColor="",this.highlightBgColor="",this.negativeColor="",this.highlightRulesActive=!1,this.breakdown={},this.hlRules=[],this.rangeArgs=[],this.subscriptionKey="",this.CURRENCY_SYMBOL_MAP={GBP:"&pound;",EUR:"&euro;",USD:"$"},this.model=e,this.dataDef=t,this.cachedTextAlign="center",this.el=document.createElement("div"),this.innerEl=this.el,this.breakdown=n,this.selected=a,this.rowSelectionMode=r,this.applyHighlightRules(i),this.showAggregateFunctionTooltip=o}s=y.View,e(h,s),h.prototype.initializeEvents=function(){this.el.addEventListener("mousedown",this.rowClickHandler),this.el.addEventListener("dblclick",this.onDoubleClick),this.el.addEventListener("mouseenter",this.onMouseEnter),this.el.addEventListener("contextmenu",this.onRightClick),this.listenTo(this.model,"isMin",this.highlightMaxOrMin),this.listenTo(this.model,"isMax",this.highlightMaxOrMin),this.listenTo(this.model,"HighlightRange",this.applyRangeBackground),this.listenTo(this.model,"RefreshHighlights",this.refreshHighlights),this.listenTo(this.viewModel,"change:HighlightRules",this.onHighlightRulesChange),this.listenTo(this.viewModel,"change:Selection.RowSelectionMode",this.onRowSelectionModeChange),this.onModelChange(this.model),this.listenTo(this.model,"change",this.onModelChange)},h.prototype.applyRangeBackground=function(t,i,o,n,a){_.each(this.cellViews,function(e){e.applyRangeBackground(t,i,o,n,a)})},h.prototype.calcFiltered=function(e){e=e||this.viewModel.get("filter");return _.isEmpty(e)?this.isFiltered=!1:this.isFiltered=h.isModelFiltered(this.model,e,this.dataDef),this.isFiltered},h.prototype.clearSelected=function(){this.cellViews.forEach(function(e){return e.selected=!1})},h.prototype.expandAll=function(e,t){},h.prototype.isAllExpanded=function(e){return!1},h.prototype.getColumnInfo=function(e){return this.parent.getColumnInfo(e)},h.prototype.getRowKey=function(){return this.model.get(this.viewModel.get("Selection.RowSelectionColumn"))},h.prototype.getApp=function(){for(var e=this.parent;e.parent;)e=e.parent;return e},h.prototype.height=function(){return this.isFiltered?0:this.viewModel.get("Style.RowHeight")},h.prototype.highlightMaxOrMin=function(){_.each(this.cellViews,function(e){e.highlightMaxOrMin()})},h.isModelFiltered=function(n,e,a){return void 0!==_.find(e,function(e,t){var i,o=_.find(a,function(e){return e.field===t});return!!o&&(_.isFunction(o.formatterFn)?0===(i=""+o.formatterFn(t,n,o)||"").indexOf('<div class="percentageFormatter">')&&(i=$(i).find("span").text()):i=_.isFunction(o.data)&&""+o.data(n)||"",-1===i.toLowerCase().indexOf(e.toLowerCase()))})},h.prototype.layout=function(e){var i=this,e=e||this.dataDef;_.each(e,function(e,t){i.cellViews[t].layout(e.hidden,e.leftComputed,e.widthComputed)})},h.prototype.onRightClick=function(e){e.stopPropagation(),e.preventDefault(),this.getApp().trigger("rowRightClicked",this)},h.prototype.onDoubleClick=function(e){e.stopPropagation(),this.getApp().trigger("rowDoubleClicked",this)},h.prototype.onHighlightRulesChange=function(){var t=this;_.each(this.cellViews,function(e){e.hlRules=t.viewModel.get("HighlightRules"),e.refreshHighlights(e.dataDef.field)})},h.prototype.onModelChange=function(t){_.each(this.cellViews,function(e){e.onModelChange(t)})},h.prototype.onMouseEnter=function(e){e.stopPropagation(),this.cellViews&&this.cellViews[0]&&this.cellViews[0].el&&this.cellViews[0].el.className.indexOf("expanded")<0&&this.getApp().trigger("rowMouseEntered",this)},h.prototype.onRowSelectionModeChange=function(){var t=this;this.parent.trigger("rowUnselected"),_.each(this.cellViews,function(e){e.rowSelectionMode=t.viewModel.get("Selection.RowSelectionMode")})},h.prototype.refreshHighlights=function(t){_.each(this.cellViews,function(e){e.refreshHighlights(t)})},h.prototype.remove=function(){return this.el.removeEventListener("mousedown",this.rowClickHandler),this.el.removeEventListener("dblclick",this.onDoubleClick),this.el.removeEventListener("contextmenu",this.onDoubleClick),y.View.prototype.remove.call(this)},h.prototype.renderInternal=function(){var i=this,o=[],n="none"===this.parent.viewModel.get("Selection.RowSelectionMode"),a=!1;return n&&!this.parent.disableHighlighting&&v.key(this.model)===this.parent.selected&&(a=!0),_.each(i.dataDef,function(e){var t=new z(i.model,e,i.viewModel.get("HighlightRules"),i.viewModel.get("Basics.AggregateFunctionTooltip"),{breakdownColumns:i.viewModel.get("breakdownColumns"),focus:i.viewModel.get("Basics.Focus")},a,n);t.onModelChange(i.model),e.class&&$(t.el).addClass(e.class),t.layout(e.hidden,e.leftComputed,e.widthComputed),i.cellViews.push(t),o.push(t.el)}),i.$el.append(o),this},h.prototype.resetBgColor=function(t){this.cachedBackgroundColor!==t&&(this.cachedBackgroundColor=t,_.each(this.cellViews,function(e){e.resetBgColor(t)}))},h.prototype.selectCells=function(){this.cellViews.forEach(function(e){return e.selected=!0})},h.prototype.setTop=function(e){e!==this.cachedTop&&(this.cachedTop=e,this.$el.css("top",e+"px"))};var s,U=h;function h(e){var t=s.call(this,_.extend({className:"table-row"},e))||this,o=(t.isFiltered=!1,t.isVisible=!0,t.selectedCellContentCache="",t);return t.api=e.api,t.dataDef=e.dataDef,t.viewModel=e.viewModel,t.parent=e.parent,t.cellViews=[],t.onDoubleClick=t.onDoubleClick.bind(t),t.onRightClick=t.onRightClick.bind(t),t.onMouseEnter=t.onMouseEnter.bind(t),o.rowClickHandler=function(t){var e,i=_.find(o.cellViews,function(e){return e&&e.el===t.target});i&&"pointer"!==i.el.style.cursor&&(e=o.parent,o.selectedCellContentCache=i.contentCache,e&&v.key(o.model)===e.selected?t.ctrlKey?o.trigger("rowUnselected",o):o.trigger("rowSelected",o):_.get(o.parent,"selected")&&t.ctrlKey?o.trigger("rowUnselected",o):o.trigger("rowSelected",o)),t.stopPropagation()},t.renderInternal(),t.initializeEvents(),t}c=y.View,e(u,c),u.prototype.applyExpand=function(){var e,t=this.viewModel.get("Basics.Animate");this.isApplied=!0,this.$expandIcon.toggleClass("expanding",!1),this.isExpanded?this.expandedDatatable||(this.stopListening(this.viewModel,"change:filter"),this.expandedDatatable=new S({model:this.collection,api:this.api,dataDef:this.childDataDef,offsetIndex:this.offsetIndex,depth:this.depth+1,noHeader:!0,noSummary:!this.api.getProperty("Basics.ShowExpandedSummary"),rowData:this.rowData,parent:this,viewModel:this.viewModel,sortDef:this.sortDef,quickView:this.quickView}),this.listenTo(this.collection,"add remove reset",this.onExpandedOrdersChanged),this.listenTo(this.expandedDatatable,"rowSelected",function(e){this.trigger("rowSelected",e)}.bind(this)),this.listenTo(this.expandedDatatable,"rowUnselected",function(e){this.trigger("rowUnselected",e)}.bind(this)),this.$el.append(this.expandedDatatable.el),this.$expandIcon.toggleClass("expanded",!0),this.api.getProperty("Basics.ShowExpandedSummary")&&this.api.getProperty("Style.ExpandedSummaryStyle")&&this.$el.toggleClass("expandedSummaryDefaultStyle",!0),this.updateHeight(),t?_.delay(this.onExpandComplete.bind(this),301):this.onExpandComplete()):this.expandedDatatable&&(this.$expandIcon.toggleClass("expanded",!1),this.$el.toggleClass("expandedSummaryDefaultStyle",!1),this.onExpandComplete(),e=function(){this.stopListening(this.collection),this.expandedDatatable.remove(),this.expandedDatatable=null,this.updateHeight(),this.parent.processMinMaxHighlighting()}.bind(this),t?_.delay(e,201):e())},u.prototype.clearSelected=function(){this.datatableRow&&this.datatableRow.cellViews.forEach(function(e){return e.selected=!1}),this.expandedDatatable&&this.expandedDatatable.clearSelected()},u.prototype.getColumnInfo=function(e){return this.parent.getColumnInfo(e)},u.prototype.updateColumnInfo=function(e){return this.parent.updateColumnInfo(e)},u.prototype.onData=function(e,t){var i=!1;e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey,this.collection.reset(),this.collection=new(E.createPivotCollectionFunc(this.primaryKey))),t.reset&&0<t.reset.length?(this.collection.reset(t.reset),i=!0):(t.add&&0<t.add.length&&(this.collection.add(t.add),i=!0),t.change&&0<t.change.length&&(this.collection.add(t.change,{merge:!0}),i=!0),t.remove&&0<t.remove.length&&(this.collection.remove(_.map(t.remove,function(e){return e.id})),i=!0)),i&&(clearTimeout(this.timeout),this.updateColumnInfo(e.columns),this.applyExpand()),this.viewModel.get("Basics.Drilldown")&&this.renderTopFooter()},u.prototype.onExpandClick=function(){var e=this.isExpanded&&this.isApplied;this.isExpanded&&!this.isApplied&&this.expand(!1),this.parent.onExpanded(this.getPath(),!e)},u.prototype.onExpanded=function(e,t){this.parent.onExpanded(e,t)},u.prototype.expand=function(e){var t=this;e&&!this.isExpanded?(this.isExpanded=!0,this.isApplied=!1,this.$expandIcon.toggleClass("expanding",!0),this.timeout=setTimeout(function(){t.expand(!1)},15e3),this.api.subscribe(this.model,this.onData.bind(this))):!e&&this.isExpanded&&(this.isExpanded=!1,this.api.unsubscribe(this.model),this.applyExpand(),clearTimeout(this.timeout))},u.prototype.expandAll=function(e,t){this.expandedDatatable&&this.expandedDatatable.expandAll(e,t)},u.prototype.isAllExpanded=function(e){return this.expandedDatatable&&(e<0||this.expandedDatatable.isAllExpanded(e))},u.prototype.getPath=function(){return this.parent.getPath().concat(this.key())},u.prototype.height=function(){var e,t;return this.isExpanded&&this.expandedDatatable?(e=this.api.getProperty("Basics.ShowExpandedSummary"),t=this.api.getProperty("Basics.Drilldown"),e=e&&!t?this.datatableRow.height():0,t=this.expandedDatatable.height(),Math.max(t,this.datatableRow.height())+e):this.datatableRow.height()},u.prototype.key=function(){return u.key(this.model)},u.key=function(e){e=e.id;return _.isString(e)?S.encodeKey(e):e&&e.i?e.toString():""+e},u.prototype.layout=function(e){e=e||this.dataDef;this.datatableRow.layout(e),this.expandedDatatable&&this.expandedDatatable.layoutRows(e.slice(1))},u.prototype.onExpandComplete=function(){this.onRowExpanded(0,this.isExpanded)},u.prototype.onExpandedOrdersChanged=function(){this.updateHeight()},u.prototype.onRowExpanded=function(e,t){this.parent&&this.parent.onRowExpanded(e+1,t)},u.prototype.remove=function(){return this.datatableRow.remove(),this.clickHandler&&_.each(E.clickEvent().split(" "),_.bind(function(e){this.$expandIcon[0].removeEventListener(e,this.clickHandler)},this)),this.expandedDatatable&&this.expandedDatatable.remove(),this.api.unsubscribe(this.model),y.View.prototype.remove.call(this)},u.prototype.renderTopFooter=function(){this.parent.renderFooter()},u.prototype.rowCount=function(){return this.parent.rowCount()},u.prototype.scrollTop=function(){return-(this.cachedTop||0)+this.parent.scrollTop()},u.prototype.setTop=function(e){e!==this.cachedTop&&(this.cachedTop=e,this.$el.css("top",e+"px"))},u.prototype.renderInternal=function(e){return this.expandedDatatable&&this.expandedDatatable.renderInternal(e),this},u.prototype.selectCells=function(){this.datatableRow&&this.datatableRow.cellViews.forEach(function(e){return e.selected=!0}),this.expandedDatatable&&this.expandedDatatable.selectCells()},u.prototype.updateHeight=function(){this.parent.updateHeight()};var c,v=u;function u(e){var t,i,o,n=c.call(this,_.extend({className:"table-row"},e))||this;return n.subscriptionKey=_.uniqueId("datatable_"),n.columnState={},n.isApplied=!1,n.isExpanded=!1,n.isVisible=!0,n.api=e.api,n.offsetIndex=e.offsetIndex,n.parent=e.parent,n.dataDef=e.dataDef,n.depth=e.depth,n.sortDef=e.sortDef,n.viewModel=e.viewModel,n.expandedDatatable=null,n.collection=new y.Collection,n.datatableRow=new U({el:n.el,model:n.model,api:e.api,dataDef:n.dataDef,viewModel:n.viewModel,rowData:e.rowData,parent:n.parent}),e.rowData&&(n.rowData=_.clone(e.rowData.rowData),t=n.$el.children().first(),i=$('<a class="expndbl" />'),"Breakdown Cell"===(o=n.viewModel.get("Basics.DrilldownInputArea"))?t.addClass("expndbl"):t.append(i),n.$expandIcon="Breakdown Cell"===o?t:i,n.$expandIcon[0].style.cursor="pointer",n.childDataDef=n.dataDef.slice(1),n.clickHandler=_.debounce(n.onExpandClick.bind(n),200,{leading:!0}),_.each(E.clickEvent().split(" "),_.bind(function(e){this.$expandIcon[0].addEventListener(e,this.clickHandler)},n))),n.listenTo(n.datatableRow,"rowSelected",function(e){this.trigger("rowSelected",e)}.bind(n)),n.listenTo(n.datatableRow,"rowUnselected",function(e){this.trigger("rowUnselected",e)}.bind(n)),e.expand&&_.defer(function(){this.onExpandClick()}.bind(n)),n}p.prototype.on=function(e,t,i){},p.prototype.off=function(e,t,i){},p.prototype.trigger=function(e){for(var t=1;t<arguments.length;t++)t-1,0},p.prototype.bind=function(e,t,i){},p.prototype.unbind=function(e,t,i){},p.prototype.once=function(e,t,i){},p.prototype.listenTo=function(e,t,i){},p.prototype.listenToOnce=function(e,t,i){},p.prototype.stopListening=function(e,t,i){};var j=p;function p(){_.extend(this,y.Events)}X=y.View,e(g,X),g.prototype.initialize=function(e){var n,a=this;a.options=e.options,a.MODEL=a.options.MODEL,this.$el.html(a.options.body),a.options.buttons=a.options.buttons||{Ok:null},n=a.options.buttons,_.each(n,function(e,i){var o=i.toLowerCase();n[i]={text:t(i),click:function(){_.isFunction(e)&&e(),a.onClose()},icons:_.has(a.ICONS_MAP,o)?{primary:a.ICONS_MAP[o]}:{}}}),this.$dialog=this.$el.dialog(_.extend({classes:{"ui-dialog":"data-table dlgBasicPopup"},title:"Basic Popup",resizable:!1,modal:!0,autoOpen:!0,width:300,height:150,close:function(){a.$dialog.dialog("destroy"),a.remove()}},this.options))},g.prototype.onClose=function(){this.$el.dialog("close")},g.prototype.onOkButtonClick=function(){this.onClose()},g.prototype.onResize=function(){};var X,q=g;function g(e){return X.call(this,e)||this}C.downloadCsv=function(e,t,i){var o="",n=[],a=[],r=_.filter(_.sortBy(t.dataDef,function(e){return e.columnIndex}),function(e){return!e.hidden}),l=(t.sortedModels.forEach(function(e){return C.parseRow(e,t,r,n,a)}),[_.map(r,"header")].concat(a)),s=(_.each(l,function(e,t){e=e.join(",");o+=t<l.length?e+"\n":e}),E.fileSave(e,o));Z.onReportActions(i,"success",i.meta,"csv",e,t.api.humanFileSize(s))},C.parseCell=function(e,t,i){var o=e.columnConfig,n=t.get(e.field)||"",a=!1;return i||(i=!_.isNil(t.get(e.field)),_.isFunction(e.formatterFn)&&i&&(n=e.formatterFn(e.field,t,e.columnConfig),o)&&(a=/<[a-z]+>[\s\S]*<\/[a-z]+>/gi.test(n),"General"!==(o.Format||"General")||a||(n=_.unescape(n))),o&&"Percentage"===o.Format&&(n=""!==n?n+"%":""),(/(&|&#|\\u)[A-Za-z0-9]{2,5};/g.test(n)||a)&&(C.converterDiv.innerHTML=n,n=C.converterDiv.innerText),_.isString(n)&&(n=n.replace(/"/g,'""')),/^[-\+=@]/.test(n)&&o.Format&&-1===o.Format.indexOf("Number")&&(n="'"+n)),'"'+n+'"'||""},C.parseRow=function(t,e,i,o,n){var a,r=e.api.getProperty("FileExport.RawFormat"),e=e.modelViewDict[t.id];(a=e?e.expandedDatatable:a)?_.each(a.sortedModels,function(e){return C.parseRow(e,a,i,o,n)}):n.push(o.concat(_.map(i,function(e){return C.parseCell(e,t,r)})))},C.convertTo2digit=function(e){return e=1===(e=""+e).length?"0"+e:e},C.getDefaultFileName=function(){var e=new Date,t=e.getMonth()+1,i=e.getDate();return"CSV "+e.getFullYear()+C.convertTo2digit(t)+C.convertTo2digit(i)},C.sanitizeForFileName=function(e){return e=e.replace(/:/g,"-").replace(/[^\w \.\-]/g,"")},C.showDialog=function(e,i,o){var n,e=_.map(e.get("FileExport.FileName"),function(e){return(e=null!==(e=e.FileNamePart)&&!_.isObject(e)?e:"").toString()}).join("")||e.get("format.widgetTitle")||C.getDefaultFileName();e=C.sanitizeForFileName(e),e+=C.FILE_EXT,n=new q({options:{width:240,title:t("Export csv file"),body:"<div class='dlgCsvExport'>"+t("Please enter the filename")+"<br><input type='text' class='ui-corner-all' value='"+e+"'/></div>",buttons:{Ok:function(){var e=""+(e=n.$el.find("input").val())||C.getDefaultFileName();e=C.sanitizeForFileName(e),new RegExp("\\"+C.FILE_EXT+"$").test(e)||(e+=C.FILE_EXT),C.downloadCsv(e,i,o)},Cancel:0}}})},C.FILE_EXT=".csv",C.converterDiv=document.createElement("div");var K=C;function C(){}function G(){this.SheetNames=[],this.Sheets={}}b.createExcelOfCurrentData=function(e,t,i){var o={},n=[],a=[],r={".xlsx":"xlsx",".xls":"xlml"}[b.FILE_EXT],l=_.filter(_.sortBy(t.dataDef,function(e){return e.columnIndex}),function(e){return!e.hidden}),s=(a.push(_.map(_.map(l,"header"),function(e,t){return{type:"General",value:e,index:t}})),t.sortedModels.forEach(function(e){return b.parseRow(e,t,l,n,a,o)}),h=a,"Datatable"),d=new G,h=b.convertDataToExcel(h,o),s=(d.SheetNames.push(s),d.Sheets[s]=h,XLSX.write(d,{bookType:r,bookSST:!0,type:"binary"})),h=b.s2ab(s),d=E.fileSave(e,h);Z.onReportActions(i,"success",i.meta,".xlsx",e,t.api.humanFileSize(d))},b.parseCell=function(e,t,i,o,n){var a,r,l,s,d={},h=e.columnConfig,c=i.get(e.field),u=!1,p=!1;if(n)d.type="General",d.value=_.unescape(c);else{if(n=null!=c,_.isFunction(e.formatterFn)&&n&&(c=e.formatterFn(e.field,i,e.columnConfig)),""!==(c=n?c.toString():"")&&h){switch(a=h.Format||"General",r=h.Precision,l=h.DateFormat,s=h.TimeFormat,/<[a-z]+>[\s\S]*<\/[a-z]+>/gi.test(c)?(b.converterDiv.innerHTML=c,c=b.converterDiv.innerText):"General"===a&&(c=_.unescape(c)),c.replace&&16<c.replace(/[,.]/g,"").length&&(p=!0),a){case"Percentage":d.oldValue=c+"%",p?u=!0:(g=Number(c),isNaN(g)||-1!==c.indexOf(".")?!isNaN(g)&&0<c.indexOf(".")&&c.length-c.indexOf(".")<4?(d.type="Percentage_10",d.value=Number((g/100).toFixed(4))):(d.type="General",d.value=c+"%"):(d.type="Percentage_9",d.value=Number((g/100).toFixed(2))));break;case"Smart Number":u=!0;break;case"Number":case"Formatted Number":p?u=!0:/(&|&#|\\u)[A-Za-z0-9]{2,5};/g.test(c)?(b.converterDiv.innerHTML=c,d.value=b.converterDiv.innerText,d.type="General"):(c.replace&&-1!==c.indexOf(",")?(-1!==c.indexOf(".")?(d.type="Number_custom",d.format="#,##0."+Array(r+1).join("0")):d.type="Formatted_Number_3",c=c.replace(/,/g,"")):-1!==c.indexOf(".")&&(d.type="Number_custom",d.format="#0."+Array(r+1).join("0")),isNaN(Number(c))?u=!0:(d.oldValue=c,d.value=Number(c)));break;case"Date":case"DateTime":var g=void 0;"Date"===a?g=l:"DateTime"===a&&(g=l+" "+s),!(u=-1!==c.indexOf(".")&&2<c.substr(c.indexOf(".")+1).length?!0:u)&&f.utc(c,g).isValid()&&"Invalid date"!==f.utc(c,g).format()?(d.oldValue=c,d.format=g,d.value=f.utc(c,g).format()):u=!0;break;default:_.includes(["true","false"],c)?(d.oldValue=c,d.value="true"===c,d.type="Boolean"):u=!0}d.type=d.type||a}else d.type=null,d.value="";u&&(o[t]=!0,_.includes(["Percentage_9","Percentage_10"],a)?d.value=c+"%":d.value=""+c,d.type="General")}return d.index=t,d},b.parseRow=function(i,e,t,o,n,a){var r,l=e.modelViewDict[i.id],s=e.api.getProperty("FileExport.RawFormat");(r=l?l.expandedDatatable:r)?_.each(r.sortedModels,function(e){return b.parseRow(e,r,t,o,n,a)}):n.push(o.concat(_.map(t,function(e,t){return b.parseCell(e,t+o.length,i,a,s)})))},b.convertTo2digit=function(e){return e=1===(e=""+e).length?"0"+e:e},b.getDefaultFileName=function(){var e=new Date,t=e.getMonth()+1,i=e.getDate();return"Excel "+e.getFullYear()+b.convertTo2digit(t)+b.convertTo2digit(i)},b.sanitizeForFileName=function(e){return e=e.replace(/:/g,"-").replace(/[^\w \.\-]/g,"")},b.showDialog=function(e,i,o){var n,e=_.map(e.get("FileExport.FileName"),function(e){return(e=null!==(e=e.FileNamePart)&&!_.isObject(e)?e:"").toString()}).join("")||e.get("format.widgetTitle")||b.getDefaultFileName(),a=(e=b.sanitizeForFileName(e),e+=b.FILE_EXT,new q({options:{width:240,title:t("Export Excel file"),body:"<div class='dlgExcelExport'>"+t("Please enter the filename")+"<br><input type='text' class='ui-corner-all' value='"+e+"'/></div>",buttons:{Ok:function(){n=""+(n=a.$el.find("input").val())||b.getDefaultFileName(),n=b.sanitizeForFileName(n),new RegExp("\\"+b.FILE_EXT+"$").test(n)||(n+=b.FILE_EXT),b.createExcelOfCurrentData(n,i,o)},Cancel:0}}}))},b.datenum=function(e,t){return t&&(e+=1462),Date.parse(e)-Date.UTC(1899,11,30)/864e5},b.convertDataToExcel=function(e,t){for(var i={},o={s:{c:1e7,r:1e7},e:{c:0,r:0}},n=0;n!=e.length;++n)for(var a=0;a!=e[n].length;++a){o.s.r>n&&(o.s.r=n),o.s.c>a&&(o.s.c=a),o.e.r<n&&(o.e.r=n),o.e.c<a&&(o.e.c=a);var r=e[n][a],l={};if(null!==r.type){t[r.index]&&(r.type="General",r.value=r.oldValue||r.value);var s=XLSX.utils.encode_cell({c:a,r:n});switch("number"==typeof l.v?l.t="n":"boolean"==typeof l.v?l.t="b":l.v instanceof Date?(l.t="n",l.z=XLSX.SSF._table[14],l.v=b.datenum(l.v)):l.t="s",r.type){case"Number":case"Formatted Number":l.t="n",l.z=XLSX.SSF._table[1];break;case"Formatted_Number_2":l.t="n",l.z=XLSX.SSF._table[2];break;case"Formatted_Number_3":l.t="n",l.z=XLSX.SSF._table[3];break;case"Formatted_Number_4":l.t="n",l.z=XLSX.SSF._table[4];break;case"Number_custom":r.format?(l.t="n",l.z=r.format):l.t="s";break;case"Smart number":l.t="s";break;case"Boolean":l.t="b";break;case"Date":l.t="d",l.z=r.format||"YYYY-MM-DD";break;case"DateTime":l.t="d",l.z=r.format||"YYYY-MM-DD HH:mm:ss";break;case"Percentage_9":l.t="n",l.z=XLSX.SSF._table[9];break;case"Percentage_10":l.t="n",l.z=XLSX.SSF._table[10];break;default:l.t="s"}l.v=r.value,i[s]=l}}return o.s.c<1e7&&(i["!ref"]=XLSX.utils.encode_range(o)),i},b.s2ab=function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),o=0;o!=e.length;++o)i[o]=255&e.charCodeAt(o);return t},b.FILE_EXT=".xlsx",b.converterDiv=document.createElement("div");var Y=b;function b(){}Q.generateFullExportConfig=function(e){var a={},r=_.filter(_.sortBy(e.dataDef,function(e){return e.columnIndex}),function(e){return!e.hidden}),l=["Date","Time","DateTime"];return r.length&&(a.columnLabel="",a.dateFormat="",_.each(r,function(e,t){var t=t<r.length-1?" && ":"",i=e.kdbType,o=e.columnConfig.Format,n=e.field+"#"+e.header+t;a.columnLabel+=n,12<=i&&i<=19&&_.includes(l,o)&&(n={Date:e.columnConfig.DateFormat,Time:e.columnConfig.TimeFormat,DateTime:e.columnConfig.DateFormat+"_"+e.columnConfig.TimeFormat},i=e.field+"#"+n[o]+t,a.dateFormat+=i)}),new RegExp("&& $").test(a.dateFormat))&&(a.dateFormat=a.dateFormat.slice(0,-4)),a},Q.onReportActions=function(o,n,a,r,l,s){_.each(_.get(o,"actions"),function(e){var t=_.get(e,"EventType"),i="success"===n,t="all"===t||"onSuccess"===t&&i||"onFail"===t&&!i;_.get(e,"Result.attributes")&&t&&e.Result.set("value",{component:"Datatable",dashboard:{dashboardId:_.get(o,"dashboardId"),dashboardName:_.get(o,"dashboardName")},fileRowLength:_.get(o,"fileLength")?_.get(o,"fileLength"):"na",fileMetaData:a,fileName:l,fileType:r,isSuccess:i,size:s,status:n,timestamp:Date.now(),type:"download",username:d.DeltaClientLib.username})})};var Z=Q;function Q(){}e(x,J=j),x.prototype.initalizeEvents=function(){var i=this,e=this,t=this.dashboardViewModel.get("selectedDocumentId"),o=this.api.getDashboardName(t),n={actions:this.api.getProperty("FileExport.Actions"),dashboardName:o,dashboardId:t,meta:_.get(e.viewModel.get("Basics.Data"),"dataSet.columnDict"),fileLength:_.get(e.viewModel.get("Basics.Data"),"dataSet.collection.length")};this.api.hasPermission(d.CustomAPIPermission.canExportData)&&(this.$lnkCsvExport.click(function(){return K.showDialog(e.viewModel,e.table,n)}),this.$lnkExcelExport.click(function(){return Y.showDialog(e.viewModel,e.table,n)}),this.$lnkFullExport.click(_.bind(this.apiExport,this))),this.listenTo(this.viewModel,"change:FileExport.ShowExportCsvButton change:FileExport.ShowExportExcelButton change:FileExport.ShowFullExportButton",_.bind(this.displayChoiceLinkButtons,this)),this.listenTo(this.viewModel,"change:Basics.Data",function(e,t){d.ExportTools.onQueryChange(t,i.$lnkFullExport)})},x.prototype.onData=function(){var e=this.getExportParamOptions();this.viewModel.get("FileExport.FullExportOverride")||(e.focus=this.viewModel.get("Basics.Focus")),this.exportData(this.fullExportModel,e)},x.prototype.apiExport=function(){var e,i;this.$lnkFullExport.hasClass("events-disabled")||(this.$spinner=$("<span />").addClass("export-spinner fa fa-spinner fa-pulse").attr("title",t("Download in progress")).appendTo(this.$lnkFullExport),e=this.getExportParamOptions(),i=this.viewModel.get("Basics.Data"),this.$lnkFullExport.addClass("export-in-progress"),this.viewModel.get("FileExport.FullExportOverride")?(i=this.viewModel.get("FileExport.FullExportOverride"),this.fullExportModel&&(this.stopListening(this.fullExportModel),this.api.unsubscribe(this.fullExportModel),this.fullExportModel=null),this.fullExportModel=i,this.api.subscribe(i,$.proxy(this.onData.bind(this),this))):(i.get("_queryString")&&i.get("_aggregateCols")&&i.get("_breakdownCols")&&"server"===i.get("_pivotType")?(i=this.getFullExportQuery(e.exportParams),this.api.subscribe(i,this),this.api.unsubscribe(i)):e.focus=this.viewModel.get("Basics.Focus"),this.exportData(i,e)))},x.prototype.exportData=function(e,t){var i=this,o=this.dashboardViewModel.get("selectedDocumentId"),n=this.api.getDashboardName(o);this.api.exportData(e,function(){i.$spinner.remove(),i.$lnkFullExport.removeClass("export-in-progress")},t,{actions:this.api.getProperty("FileExport.Actions"),component:"Datatable",dashboardId:o,dashboardName:n})},x.prototype.getExportParamOptions=function(){var e,t=Z.generateFullExportConfig(this.table);return this.viewModel.get("FileExport.FullExportOverride")&&(e=_.reject(this.viewModel.get("FileExport.FullExportOverride").get("_columns"),function(e){e.indexOf("_")}),t={columnLabel:_.map(e,function(e,t){return e+"#"+e}).join(" && "),dateFormat:""}),{exportName:d.ExportTools.getExportFileName(this.getFileName(),this.getAltFileName(),"DatatableExport"),exportParams:t}},x.prototype.getFullExportQuery=function(e){var t=this.viewModel.get("Basics.Data"),i=t.get("_breakdownCols"),o=t.get("_queryString"),n=t.get("_aggregateCols"),a=t.get("_aggregateFns"),r=t.get("_aggregateLabels"),a=this.getSelectPhrase(n,a,r),o="?["+o+";();"+this.getGroupbyPhrase(i)+";"+a+"]";return e.columnLabel=this.getPivotExportColumnParams(i,n,r),new d.DocumentDataModel({_forceReset:!0,_subscriptionKey:"",_dataType:"query",_queryString:o,_dataSource:t.get("_dataSource"),_connection:t.get("_connection")},null,null,void 0,void 0)},x.prototype.getPivotExportColumnParams=function(e,t,i){e=e instanceof y.Model?e.get("value"):e,e=_.map(e,function(e){return e+"#"+e}),t=_.map(t,function(e,t){return(i[t]&&!_.isEmpty(i[t])?i[t]:e)+"#"+e});return _.join(_.concat(e,t)," && ")},x.prototype.stringifyDict=function(e,t,i){return(e?"(enlist":"")+t+(e?")":"")+"!"+(e?"enlist":"(")+i+(e?"":")")},x.prototype.getGroupbyPhrase=function(e){var t=1===e.length,e=e instanceof y.Model?e.get("value"):e,e=_.join(_.map(e,function(e){return"`"+e}),"");return this.stringifyDict(t,e,e)},x.prototype.getSelectPhrase=function(i,e,o){var t=1===i.length,n=_.join(_.map(i,function(e,t){return o[t]&&!_.isEmpty(o[t])?'`$"'+o[t]+'"':'`$"'+e+'"'}),";"),e=_.join(_.map(e,function(e,t){return"("+e+";`"+i[t]+")"}),";");return this.stringifyDict(t,"("+n+")","("+e+")")},x.prototype.displayChoiceLinkButtons=function(){var e=this.viewModel.get("FileExport");e&&(e.ShowExportCsvButton||e.ShowExportExcelButton||e.ShowFullExportButton?(this.$lnksExport.removeClass("link-disabled"),this.$lnkCsvExport.toggleClass("link-disabled",!e.ShowExportCsvButton),this.$lnkExcelExport.toggleClass("link-disabled",!e.ShowExportExcelButton),this.$lnkFullExport.toggleClass("link-disabled",!e.ShowFullExportButton)):this.$lnksExport.addClass("link-disabled"))},x.prototype.positionPanelWithDatagrid=function(){this.positionPanelWithDatagrid()},x.prototype.getFileName=function(){return this.viewModel.get("FileExport.FileName")},x.prototype.getAltFileName=function(){return this.viewModel.get("format.widgetTitle")||""},x.prototype.remove=function(){this.$lnkCsvExport.off(),this.$lnkExcelExport.off(),this.$lnkFullExport.off(),this.stopListening()};var J,ee=x;function x(e){var t=J.call(this)||this;return t.table=e.table,t.api=e.api,t.viewModel=e.viewModel,t.dashboardViewModel=e.dashboardViewModel,t.$lnkCsvExport=t.table.$("a.lnkCsvExport"),t.$lnkExcelExport=t.table.$("a.lnkExcelExport"),t.$lnkFullExport=t.table.$("a.lnkFullExport"),t.$lnksExport=t.table.$(".lnksExport"),t.displayChoiceLinkButtons(),t.initalizeEvents(),d.ExportTools.onQueryChange(t.viewModel.get("Basics.Data"),t.$lnkFullExport),t}D.isMatch=function(e,t){var i,o=!1,n=e.split(/ +and +| +/);for(_.includes(n,"or")&&(n=_.without(n,"or"),o=!0),i=0;i<n.length;i++)0!==n[i].indexOf("-")&&n[i].indexOf("*")<0&&(n[i]="*"+n[i]+"*");return _[o?"some":"every"](n,function(e){return D.isSimpleMatch(e,t)})},D.isSimpleMatch=function(t,i){var o,e=!1;0===t.indexOf("-")&&(t=t.replace("-",""),e=!0);try{o=new RegExp("^"+t.replace(/\*/g,".*")+"$").test(i)}catch(e){o=i.includes(t)}return e?!o:o};var te=D;function D(){}ie=y.View,e(M,ie),M.prototype.initalizeEvents=function(){var t=this;this.listenTo(this.model,"reset",this.onModelReset),this.listenTo(this.model,"add",this.onModelAdd),this.listenTo(this.model,"remove",this.onModelRemove),this.listenTo(this.viewModel,"change:Basics",this.onSortOrderChange),this.listenTo(this.viewModel,"change:Basics.Focus",this.onFocusChange),this.listenTo(this.viewModel,"change:Basics.ColumnWidthMode",this.onColumnWidthModeChange.bind(this)),this.listenTo(this.viewModel,"change:Style.ShowFilterIconInFooter",this.renderFooter.bind(this)),this.noHeader?this.listenTo(this.viewModel,"change:filter",function(){t.needsSort=!0}):(this.listenTo(this.viewModel,"change:filter",this.debouncedSort.bind(this)),this.showFilters&&(this.$resetFilters.on(E.clickEvent(),function(){return t.clearFilters()}),this.$toggleFilters.on(E.clickEvent(),function(){t.toggleFilters(!t.showingFilters)})),this.$toggleDrilldown.on(E.clickEvent(),function(){var e=t.viewModel.get("Basics.Drilldown");t.api.setProperty("Basics.Drilldown",!e)}),this.listenTo(this.viewModel,"change:Basics.Drilldown",this.onPropDrilldown),this.listenTo(this.viewModel,"change:Basics.MultipleDrilldown",this.onPropMultipleDrilldown),this.listenTo(this.viewModel,"change:Basics.ExpandAll",this.onPropExpandAll),this.listenTo(this.viewModel,"change:Basics.ShowTools",this.onPropShowTools))},M.prototype.applyFilters=function(){var i={};this.noHeader||(_.each(this.headerEls,function(e){var e=$(e).find("input"),t=e.val();""!==t&&("hidden"===e.css("visibility")?(e.val(""),e.parent().removeClass("filter-active")):i[e.attr("name")]=t)}),this.viewModel.unset("filter",{silent:!0}),this.viewModel.set("filter",i),this.useFilterSettings&&this.saveFilterSettings(i),this.$resetFilters.toggle(!_.isEmpty(i)),this.debouncedUpdateExpandIcons())},M.prototype.saveFilterSettings=function(e){this.api.saveSetting("existingFilters",e,null,this.documentID),this.existingFilters=e},M.prototype.clearFilter=function(e){var t;!this.hasOwnProperty("noHeader")||this.noHeader?this.parent.parent.clearFilter(e):(t=_.omit(this.existingFilters,e),this.$theadtr.find('input.filter[name="'+e+'"]').val("").closest(".thi").removeClass("filter-active"),this.saveFilterSettings(t),this.applyFilters(),this.debouncedRenderFooter())},M.prototype.clearFilters=function(){this.noHeader||(this.$theadtr.find(".thi").removeClass("filter-active"),this.$theadtr.find("input.filter").val(""),this.saveFilterSettings(null),this.applyFilters(),this.debouncedRenderFooter())},M.prototype.clearSelected=function(){var e;this.selected&&(e=this.modelViewDict[this.selected])&&e.clearSelected(),this.selected=null},M.decodeKey=function(e){return _.isString(e)?e.replace(/\&#44;/g,",").replace(/\&#91;/g,"[").replace(/\&#93;/g,"]"):e},M.prototype.domSort=function(){var t=this;_.each(this.sortedModels,function(e){e=v.key(e),e=t.modelViewDict[e];e&&e.$el.appendTo(t.$tcontent)})},M.encodeKey=function(e){return _.isString(e)?e.replace(/,/g,"&#44;").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;"):e},M.prototype.generateView=function(i,e){var o=this,e={model:i,parent:this,api:this.api,depth:this.depth,dataDef:this.dataDef,rowData:this.rowData,sortDef:this.sortDef,viewModel:this.viewModel,offsetIndex:e||0,quickView:this.quickView},e=new(e.rowData?v:U)(e);return this.listenTo(e,"rowSelected",function(e){o.disableHighlighting=null;var t=v.key(i);t!==o.selected&&(o.clearSelected(),o.selected=t,o.selectCells()),o.trigger("rowSelected",e)}),this.listenTo(e,"rowUnselected",function(e){o.disableHighlighting=o.selected,o.clearSelected(),o.trigger("rowUnselected",e)}),this.modelViewDict[v.key(i)]=e,this.setRowHeight(e),e},M.prototype.getColumnInfo=function(e){return this.parent.getColumnInfo(e)},M.prototype.updateColumnInfo=function(e){return this.parent.updateColumnInfo(e)},M.prototype.getFocusKeys=function(){var e=w.focus2Array(this.viewModel.get("Basics.Focus")),i=this.parent.getPath(),o=[];return e.forEach(function(e){for(var t=0;t<i.length&&t<e.length&&i[t]===e[t];t++);t===i.length&&t<e.length&&o.push(e[t])}),o},M.prototype.getFooterModels=function(a,r,l,s){var d=this,h=a.viewModel.get("filter");return _.isEmpty(a.getSortedModels())?[]:(a.sortedModels.forEach(function(e){var t=v.key(e),i=a.modelViewDict[t];if(d.viewModel.get("Basics.Drilldown"))s=s||w.getDepth(r),a.depth===s?l.push(e):i&&i.expandedDatatable&&d.getFooterModels(i.expandedDatatable,r[t],l,s);else if(i&&i.expandedDatatable&&r[t])d.getFooterModels(i.expandedDatatable,r[t],l);else if(a.viewModel.get("Basics.MultipleDrilldown"))if(_.isEmpty(h))l.push(e);else{var o,n=!0;for(o in h)if(!(n=te.isMatch((""+h[o]).toLowerCase(),(""+e.get(o)).toLowerCase())))break;n&&l.push(e)}else l.push(e)}),l)},M.prototype.getPath=function(){return this.parent.getPath()},M.prototype.getSortedModels=function(){var t,i,o,n,l={},s=_.fromPairs(_.map(this.getFocusKeys(),function(e){return[e,!0]})),e=this.viewModel.get("filter"),a=this.sortDef.index-this.depth,d=this,r=1!=this.viewModel.get("Basics.Drilldown")||_.isEmpty(s)?d.model.models:_.filter(this.model.models,function(e){return s[v.key(e)]});return _.isEmpty(e)||(_.each(e,function(n,e){var a=_.find(d.dataDef,{field:e}),r=0==d.dataDef.indexOf(a);l[e]=void 0===a?function(){return!0}:function(e){var t,i=v.key(e),o=s[i],e=a.formatterFn(a.field,e,a.columnConfig);return(t=o&&!r&&void 0!==e?d.modelViewDict[i]:t)&&t.expandedDatatable?0<t.expandedDatatable.getSortedModels().length:void 0===e||te.isMatch((""+n).toLowerCase(),(""+e).toLowerCase())}}),r=_.filter(r,function(t){return _.every(l,function(e){return e(t)})})),0<=a&&(t=d.dataDef[a].field,a=(e=this.parent.getColumnInfo(t))&&e.get("kdbType"),i=function(e){return e.get(t)},o=E.getComparator(a,i),n=r.reduce(function(e,t,i){return e[t.id]=i,e},{}),"asc"===d.sortDef.direction?r.sort(function(e,t){return o(i(e),t)||n[e.id]-n[t.id]}):"desc"===d.sortDef.direction&&r.sort(function(e,t){return-1*o(i(e),t)||n[e.id]-n[t.id]})),r},M.prototype.getTableBodyHeight=function(){var e=this.viewModel.get("Style.HeaderRowHeight");return(this.showFilters&&this.viewModel.get("Basics.ShowTools")?36:0)+(this.showingFilters?2:1)*e+"px"},M.prototype.getTheadRowHeight=function(){var e=this.viewModel.get("Style.HeaderRowHeight");return(this.showingFilters?2:1)*e+"px"},M.prototype.height=function(){return this.renderHeight||this.model.length*this.viewModel.get("Style.RowHeight")},M.prototype.onColumnWidthModeChange=function(){this.layoutSection(this.headerEls),this.layoutRows(this.dataDef),this.layoutSection(this.footerEls)},M.prototype.layoutSection=function(i){var o,e=this,n=0,a=0,t=this.viewModel.get("Basics.ColumnWidthMode");if("Fixed"===t)_.each(e.dataDef,function(e,t){o=e.columnConfig.MinWidth>e.columnConfig.FixedWidth?e.columnConfig.MinWidth:e.columnConfig.FixedWidth,o=e.hidden?0:o||1,i[t]&&i[t].css({visibility:e.hidden?"hidden":"visible",left:n+"px",width:o+"px","text-align":e.columnConfig.TextAlign||"center"}),e.widthComputed=o,e.leftComputed=n,n+=o});else{for(var r=t.includes("Mixed Mode")&&this.quickView,l=0,s=(r&&_.each(e.dataDef,function(e,t){e.columnConfig._RetainWidth&&e.columnConfig.FixedWidth&&(e.widthComputed=e.hidden?0:e.columnConfig.FixedWidth<e.columnConfig.MinWidth?e.columnConfig.MinWidth:e.columnConfig.FixedWidth,l+=e.widthComputed)}),E.sum(_.map(e.dataDef,function(e){return(r?e.hidden||e.columnConfig._RetainWidth:e.hidden)?0:_.get(e,"width")}))),t=E.sum(_.map(e.dataDef,function(e){return(r?e.hidden||e.columnConfig._RetainWidth:e.hidden)?0:e.columnConfig.MinWidth})),a=Math.max(t,this.$scrollfix[0].clientWidth-l),d={},h=0;h<this.dataDef.length;h++){var c=this.dataDef[h];(r?!c.hidden&&!c.columnConfig._RetainWidth:!c.hidden)&&(o=s?a*_.get(c,"width")/s:0,c.columnConfig.MinWidth>o)&&!d[h]&&(o=c.columnConfig.MinWidth,a=Math.max(0,a-o),s=Math.max(0,s-_.get(c,"width")),d[h]=!0,h=-1)}_.each(e.dataDef,function(e,t){r&&e.columnConfig._RetainWidth||(o=d[t]?e.columnConfig.MinWidth:e.hidden?0:a*_.get(e,"width")/s,e.widthComputed=o),i[t]&&i[t].css({visibility:e.hidden?"hidden":"visible",left:n+"px",width:e.widthComputed+"px","text-align":e.columnConfig.TextAlign||"center"}),e.leftComputed=n,n+=e.widthComputed})}},M.prototype.layoutRows=function(e){var t=e||this.dataDef;_.each(_.values(this.modelViewDict),function(e){e.layout(t)})},M.prototype.onBreakdownConfigChanged=function(e){this.viewModel.set("breakdownColumns",e)},M.prototype.onFocusChange=function(e,t,i){var o=this,n=this.getFocusKeys(),a=_.difference(this.expandedIds,n);(!_.isEqual(n,this.expandedIds)||i&&i.forceChange)&&(this.expandedIds=n,a.forEach(function(e){return o.setExpandRowByKey(e,!1)}),n.forEach(function(e){return o.setExpandRowByKey(e,!0)}),this.renderTable())},M.prototype.onHasScrollChange=function(){this.layoutSection(this.headerEls),this.layoutRows(this.dataDef),this.layoutSection(this.footerEls)},M.prototype.onHeaderClick=function(e){var t;this.mouseDownTimeout&&(clearTimeout(this.mouseDownTimeout),this.mouseDownTimeout=null),this.mouseDownComplete?this.mouseDownComplete=!1:e.target.classList.contains("resizable-col-handle")||e.timeStamp===this.resizeEndTimeStamp?this.resizeEndTimeStamp=void 0:(t=$(e.target).closest(".th").index(),this.dataDef[t].columnConfig.Sortable&&(this.sortDef.index!==t&&(this.$el.find(".table-header .table-row > div").eq(this.sortDef.index).find(".sort").html(M.SORT_NONE),this.sortDef.index=t,this.sortDef.direction=null),"asc"===this.sortDef.direction?(this.sortDef.direction="desc",this.$el.find(".table-header .table-row > div").eq(t).find(".sort").html(M.SORT_DESC)):"desc"===this.sortDef.direction?(this.sortDef.direction=null,this.$el.find(".table-header .table-row > div").eq(t).find(".sort").html(M.SORT_NONE)):(this.sortDef.direction="asc",this.$el.find(".table-header .table-row > div").eq(t).find(".sort").html(M.SORT_ASC)),e.preventDefault(),this.trigger("sortingChanged",{direction:this.sortDef.direction,columnIndex:t,columnHeader:this.dataDef[t].header}),this.renderTable(!1),this.saveSorting(t,this.sortDef.direction)))},M.prototype.setSorting=function(t,e){var i;this.depth||-1!==(i=_.findIndex(this.dataDef,function(e){return e.field===t}))&&this.dataDef[i].columnConfig.Sortable&&(this.sortDef.index!==i&&(this.$el.find(".table-header .table-row > div").eq(this.sortDef.index).find(".sort").html(M.SORT_NONE),this.sortDef.index=i,this.sortDef.direction=null),"descending"===e?(this.sortDef.direction="desc",this.$el.find(".table-header .table-row > div").eq(i).find(".sort").html(M.SORT_DESC)):""===e?(this.sortDef.direction=null,this.$el.find(".table-header .table-row > div").eq(i).find(".sort").html(M.SORT_NONE)):(this.sortDef.direction="asc",this.$el.find(".table-header .table-row > div").eq(i).find(".sort").html(M.SORT_ASC)),this.trigger("sortingChanged",{direction:this.sortDef.direction,columnIndex:i,columnHeader:this.dataDef[i].header}),this.renderTable(!1))},M.prototype.saveSorting=function(e,t){this.viewModel.set("Basics.SortColumn",this.dataDef[e].field,{silent:!0}),this.api.setProperty("Basics.SortColumn",this.dataDef[e].field),this.api.setProperty("Basics.SortOrder",t?"asc"===t?"ascending":"descending":"")},M.prototype.onModelAdd=function(e){var t,i=this;this.modelViewDict[v.key(e)]||(t=this.generateView(e),this.$tcontent.append(t.el),this.debouncedSort(),this.debouncedHighlight(),this.listenTo(e,"change",function(){i.debouncedHighlight()}))},M.prototype.onModelRemove=function(e){this.removeView(e)&&(this.debouncedSort(),this.debouncedHighlight())},M.prototype.onModelReset=function(e,t){e.models;t&&_.each(t.previousModels,_.bind(function(e){this.removeView(e)},this)),this.sortedModels=this.getSortedModels(),_.each(this.sortedModels,_.bind(function(e){this.listenTo(e,"change",this.debouncedHighlight)},this)),this.renderInternal(!0),this.debouncedHighlight(),this.onFocusChange(this.viewModel,this.viewModel.get("Basics.Focus"),{forceChange:!0})},M.prototype.onSortOrderChange=function(e,t){var i=_.get(e,"changed.Basics");_.isNil(i)||(e.changed.Basics.hasOwnProperty("SortOrder")||e.changed.Basics.hasOwnProperty("SortColumn"))&&this.setSorting(t.SortColumn,t.SortOrder)},M.prototype.onPropDrilldown=function(e,t){this.$toggleDrilldown&&this.$toggleDrilldown.find("input").prop("checked",t),this.viewModel.get("Basics.Drilldown")&&(this.api.setProperty("Basics.MultipleDrilldown",!1),this.api.setProperty("Basics.ExpandAll",!1),1<w.focus2Array(this.api.getProperty("Basics.Focus")).length)&&this.api.setProperty("Basics.Focus",""),this.debouncedRenderFooter()},M.prototype.onPropExpandAll=function(e,t){this.api.setProperty("Basics.MultipleDrilldown",t),this.renderHeader()},M.prototype.onPropMultipleDrilldown=function(e,t){var i=this.viewModel.get("Basics.MultipleDrilldown");i?(this.viewModel.set("Basics.Drilldown",!1),this.api.setProperty("Basics.Drilldown",!1)):this.api.setProperty("Basics.ExpandAll",!1),this.$toggleDrilldown.toggle(!i)},M.prototype.onPropShowTools=function(e,t){this.toggleFilters(!1)},M.prototype.onRowExpanded=function(e,t){this.parent.onRowExpanded(e,t),this.model.trigger("RefreshHighlights",!0),this.noHeader&&this.noSummary||this.debouncedUpdateExpandIcons(),!t&&this.sortedModels.length<=0&&this.applyFilters(),this.debouncedRenderFooter()},M.prototype.updateExpandIcons=function(){for(var e=this.$thead.find("div.thi a.expndbl"),t=0;t<this.dataDef.length&&this.dataDef[t].expandable;t++){var i=this.isAllExpanded(t);t<e.length&&e.eq(t).toggleClass("expanded",i)}},M.prototype.processHighlightingOnChildren=function(){this.processMinMaxHighlighting();for(var e=0;e<this.expandedIds.length;e++){var t=this.modelViewDict[this.expandedIds[e]];t instanceof v&&t.expandedDatatable instanceof M&&t.expandedDatatable.processHighlightingOnChildren()}},M.prototype.processMinMaxHighlighting=function(){function r(e){return e&&e instanceof y.Model}var e,l,s=this,t=this.model.models;s.lastSearchValue,e=_.filter(s.dataDef,function(e){return e.columnConfig.HighlightMinValue||e.columnConfig.HighlightMaxValue||e.columnConfig.RangeHighlight}),l=t||s.model.models,_.each(l,function(t){t.setX("isMin",""),t.trigger("isMin"),t.setX("isMax",""),t.trigger("isMax"),_.each(s.dataDef,function(e){e=e.columnConfig.Field;t.trigger("RefreshHighlights",e)})}),e.length&&0<l.length&&_.each(e,function(t){var e,i,o,n=t.columnConfig.Field,a=null;(t.columnConfig.HighlightMinValue||t.columnConfig.RangeHighlight)&&(a=_.minBy(l,function(e){e=e.get(n);return null==e?Number.MAX_VALUE:7===s.getColumnInfo(n).get("kdbType")&&_.isString(e)?parseInt(e,10):void 0!==e.i?e.i:e})),(t.columnConfig.HighlightMaxValue||t.columnConfig.RangeHighlight)&&(e=_.maxBy(l,function(e){e=e.get(n);return null==e?Number.MIN_VALUE:7===s.getColumnInfo(n).get("kdbType")&&_.isString(e)?parseInt(e,10):void 0!==e.i?e.i:e})),t.columnConfig.RangeHighlight&&(i=a&&a instanceof y.Model?a.get(t.columnConfig.Field):void 0,o=e&&e instanceof y.Model?e.get(t.columnConfig.Field):void 0,_.each(l,function(e){e.trigger("HighlightRange",n,t.columnConfig.RangeHighlightColor,i,o,t.columnConfig.InvertRangeColor)})),t.columnConfig.HighlightMinValue&&r(a)&&(a.get("isMin")?-1===a.get("isMin").split(",").indexOf(n)&&a.setX("isMin",a.get("isMin")+","+n):a.setX("isMin",n),a.trigger("isMin")),t.columnConfig.HighlightMaxValue&&r(e)&&(e.get("isMax")?-1===e.get("isMax").split(",").indexOf(n)&&e.setX("isMax",e.get("isMax")+","+n):e.setX("isMax",n),e.trigger("isMax"))})},M.prototype.remove=function(){return _.each(this.model.models,_.bind(function(e){this.removeView(e)},this)),this.renderTable(!0),this.debouncedSort(),this.debouncedHighlight(),this.layoutModule&&this.layoutModule.remove(),y.View.prototype.remove.call(this)},M.prototype.removeView=function(e){var t=v.key(e),i=this.modelViewDict[t];return!!i&&(i.remove(),delete this.modelViewDict[t],this.stopListening(e),!0)},M.prototype.renderFooter=function(){var g,f,m=!1;function C(e){return _.isNumber(e)&&!_.isNaN(e)}this.debouncedRenderFooter.cancel(),0===this.depth?(this.footerEls=[],this.$tfooter.empty(),g=!1,_.each(this.dataDef,function(t,e){var i,o=$(document.createElement("div")).addClass("ui-state-default"),n=w.focus2Object(this.viewModel.get("Basics.Focus"));if(t.footer&&"None"!==t.footer){m=!0,g||(f=this.getFooterModels(this,n,[]),g=!0);var a,r=f.map(function(e){return e.get(t.field)}),l=f.map(function(e){return e.get(t.columnConfig.FooterWeights)}),s=r.filter(function(e){return null!=e}).map(function(e){return"string"!=typeof e||isNaN(e)?e:Number(e)}).filter(function(e){return"number"==typeof e&&!isNaN(e)});switch(t.footer){case"Average":i=_.mean(s);break;case"Count":i=f.length;break;case"Sum":i=_.sum(s);break;case"WeightedAverage":for(var d=0,h=0,c=0;c<r.length;c++){var u=r[c],p=Number(l[c]);C(p)&&C(u)&&(d+=p*u,h+=p)}0!==h&&(i=d/h)}t.formatterFn&&"Count"!==t.footer&&((n=new y.Model).set(t.field,i),i=t.formatterFn.bind({el:o[0],innerEl:o[0],unsubscribeTemplateViewStates:z.prototype.unsubscribeTemplateViewStates})(t.field,n,t.columnConfig)),!_.isEmpty(this.viewModel.get("filter"))&&this.viewModel.get("Style.ShowFilterIconInFooter")&&(n=void 0,(n="Percentage"===t.columnConfig.Format?o[0].querySelector("span"):document.createElement("span")).className="filter",(a=document.createElement("i")).className="fa fa-fw fa-filter",n.appendChild(a),"Percentage"!==t.columnConfig.Format)&&o.append(n),o.text(i).attr("title",t.footer)}this.footerEls.push(o),this.$tfooter.append(o)}.bind(this)),m?(this.layoutSection(this.footerEls),this.$el.addClass("has-footer")):this.$el.removeClass("has-footer")):this.parent.renderTopFooter()},M.prototype.renderInternal=function(e,t){var i,o,n,a,r=this,l=0,s=_.clone(this.modelViewDict),d=0,h=[],c=this.viewModel.get("Style.RowHeight"),u=_.fromPairs(_.map(this.expandedIds,function(e){return[e,!0]})),p=this.rowCount(),g=Math.ceil(p*M.OVERDRAW),f=t||this.scrollTop(),m=this.parent.offsetIndex||0;for(e=e&&!this.needsSort,this.api.getProperty("Basics.ShowExpandedSummary")&&(f-=c*this.depth),e||(this.sortedModels=this.getSortedModels()),w=0;w<this.sortedModels.length;w++){if(a=this.sortedModels[w],0<this.expandedIds.length&&u[n=v.key(a)]&&(i=this.modelViewDict[n])?(i.offsetIndex=m+w,i.renderInternal(e),(l+=i.height())<f-g*p&&(i.el.style.display="none")):l=d+c,f-g*p<=l){o=w;break}d=l}for(var C=Math.min(this.sortedModels.length,o+p+1+2*g),y=!0,w=o;w<C;w++)a=this.sortedModels[w],n=v.key(a),(i=this.modelViewDict[n])?(delete s[n],i.setTop(d),this.setRowColor(i,m+w),0<this.expandedIds.length&&u[n]?(i.offsetIndex=m+w,i.renderInternal(e),this.setRowColor(i,m+w)):this.setRowHeight(i)):(this.modelViewDict[n]=i=this.generateView(a,m+w),0<this.expandedIds.length&&y&&u[n]&&(y=!1),this.setRowColor(i,m+w),i.setTop(d),this.sortedModels[w].setX({cachedHeight:d}),h.push(i.el)),i.$el.css("display",""),d+=i.height(),i.needsSort=!1;var t=_.uniq(this.expandedIds);for(y&&0<this.expandedIds.length&&_.each(t,function(t){var e=_.find(r.sortedModels,function(e){return v.key(e)===t});e&&!r.modelViewDict[t]&&(r.modelViewDict[t]=i=r.generateView(e,m+w),r.setExpandRowByKey(v.key(e),!0),r.setRowColor(i,m+w),i.setTop(e.get("cachedHeight")),h.push(i.el))}),t.forEach(function(e){s[e]?(s[e].el.style.display="none",delete s[e]):r.modelViewDict[e]&&(r.modelViewDict[e].el.style.display="block")},this),_.each(s,_.bind(function(e,t){e.remove(),delete this.modelViewDict[t],this.stopListening(e.model)},this));w<this.sortedModels.length;w++)d+=(i=this.modelViewDict[v.key(this.sortedModels[w])])?i.height():c,i&&i.setTop(d);h.length&&this.$tcontent.append(h),this.renderHeight=d,0!=this.depth?d!==this.cachedHeight&&(this.cachedHeight=d,this.el.style.height=d+"px"):((t=d>this.bodyHeight)!==this.cachedHasScrollbar&&(this.cachedHasScrollbar=t,this.$thead&&this.$thead.toggleClass("has-scrollbar",t),this.$tfooterRoot&&this.$tfooterRoot.toggleClass("has-scrollbar",t),this.debouncedHasScrollChange()),d!==this.cachedHeight&&(this.cachedHeight=d,this.$tcontent[0].style.height=d+"px")),this.setBodyFontStyles(),this.debouncedHighlight(),e||this.debouncedDomSort(),this.trigger("rendered")},M.prototype.renderHeader=function(){var c=this,u=c.viewModel.get("Style.HeaderTextTransformation"),p=c.viewModel.get("Style.HeaderFontWeight"),g=c.viewModel.get("Style.HeaderRowHeight")||0,e=c.viewModel.get("ordering").split(","),f=e[0],m=e[1];c.$theadtr.height(c.getTheadRowHeight()),c.$tbody.css("top",c.getTableBodyHeight()),c.headerEls=[],c.$theadtr.empty(),_.each(c.dataDef,function(e,t){var i=$(document.createElement("div")),o=$(document.createElement("div")),n=$(document.createElement("div")),a=$(document.createElement("span")),r=$(document.createElement("i")),l=$(document.createElement("input")),s=e.columnConfig.Tooltip,d=e.header&&"object"==typeof e.header?null==(d=(h=e.header).get)?void 0:d.call(h,"value"):e.header,h=(!e.unsortable&&e.columnConfig.Sortable&&(h=M.SORT_NONE,d===f&&(c.sortDef.index=t,c.sortDef.direction=m),c.sortDef.index===t&&("asc"===c.sortDef.direction?h=M.SORT_ASC:"desc"===c.sortDef.direction&&(h=M.SORT_DESC)),d="".concat(d,'<span class="sort">').concat(h,"</span>")),a.on(E.clickEvent(),function(e){c.onHeaderClick(e)}),a.addClass("ui-state-default column-name"),a.on("mouseenter",function(){a.addClass("ui-state-hover")}),a.on("mouseleave",function(){a.removeClass("ui-state-hover")}),a.css({"text-transform":u,"font-weight":p,height:g+"px","line-height":g+"px"}),a.html(d),c.createResizer()),d=(a.addClass(e.isAggregate?"aggregate-col":"breakdown-col"),a.on("mousedown",c.onReorderColsStart.bind(c)),e.columnConfig.Sortable?M.HDR_TOOLTIP_HINT_CLICK_SORT+M.HDR_TOOLTIP_HINT_DRAG_MOVE:M.HDR_TOOLTIP_HINT_DRAG_MOVE);a.attr("title",s||e.header+d),i.addClass("th"),e.class&&i.addClass(e.class),l.attr("name",e.field),l.addClass("filter"),l.height(g-2+"px"),c.useFilterSettings&&c.existingFilters&&c.existingFilters[e.field]&&"string"==typeof(s=c.existingFilters[e.field])&&0<s.length&&(l.val(s),o.addClass("filter-active")),l.on("keyup",function(e){"Escape"===e.key&&$(this).val(""),0<(""+$(this).val()).length?o.addClass("filter-active"):o.removeClass("filter-active"),c.applyFilters(),c.debouncedRenderFooter()}),r.on(E.clickEvent(),function(){l.val(""),o.removeClass("filter-active"),c.applyFilters(),c.debouncedRenderFooter()}),r.addClass("clear-filter fa fa-times"),o.addClass("thi"),o.append(n),n.addClass("linkContainer"),n.append(a),n.append(h),c.viewModel.get("Basics.ExpandAll")&&e.expandable&&(a.css("padding-left","18px"),d=$('<a class="expndbl" />'),n.append(d),d.on(E.clickEvent(),function(){c.expandAll(t,!$(this).hasClass("expanded"))})),o.append(l),o.append(r),o.append(""),i.append(o),c.headerEls.push(i),c.$theadtr.append(i)}),this.layoutSection(this.headerEls),this.debouncedUpdateExpandIcons()},M.prototype.createResizer=function(){var e=$(document.createElement("div")).addClass("resizable-col-handle");return e.on("mousedown",this.onResizeColsStart.bind(this)),e},M.prototype.showResizeMarker=function(){this.$resizeColMarker||(this.$resizeColMarker=$(document.createElement("div")).addClass("resize-col-marker"));var e=this.$thead[0].getBoundingClientRect();this.$resizeColMarker.css("height",this.$el.height()-(e.top-this.$el[0].getBoundingClientRect().top)),this.$resizeColMarker.css("top",e.y),this.$tbody.append(this.$resizeColMarker)},M.prototype.showDisabledOverlay=function(e){this.disabledOverlay||(this.disabledOverlay=document.createElement("div"),this.disabledOverlay.className="disabled-overlay");var t=this.$thead[0].getBoundingClientRect(),t=(this.disabledOverlay.style.height=this.el.clientHeight-(t.top-this.el.getBoundingClientRect().top)+"px",this.getWidthForColumnType(e)),t=(this.disabledOverlay.style.width=t+"px",e===M.COLUMN_TYPE_AGGREGATE?this.getWidthForColumnType(M.COLUMN_TYPE_BREAKDOWN):0);this.disabledOverlay.style.left=t+"px",this.$thead[0].appendChild(this.disabledOverlay),this.disabledOverlay.style.top=0-this.disabledOverlay.previousElementSibling.clientHeight+"px"},M.prototype.getWidthForColumnType=function(e){var t=0;if(e===M.COLUMN_TYPE_BREAKDOWN)for(var i=0;i<this.dataDef.length&&!this.dataDef[i].isAggregate;i++)t+=this.dataDef[i].widthComputed;else if(e===M.COLUMN_TYPE_AGGREGATE)for(i=this.dataDef.length-1;0<=i&&this.dataDef[i].isAggregate;i--)t+=this.dataDef[i].widthComputed;return t},M.prototype.showReorderColTooltip=function(){this.reorderColTooltip||(this.reorderColTooltip=document.createElement("div"),this.reorderColTooltip.className="reorder-col-tooltip");var e=this.$thead[0].getBoundingClientRect();this.reorderColTooltip.style.top=e.y+e.height+"px",this.el.appendChild(this.reorderColTooltip)},M.prototype.showReorderColMarker=function(){this.reorderColMarker||(this.reorderColMarker=document.createElement("div"),this.reorderColMarker.className="reorder-col-marker",(t=document.createElement("div")).className="col-icon fa fa-long-arrow-down",(e=document.createElement("div")).className="col-line",this.reorderColMarker.appendChild(t),this.reorderColMarker.appendChild(e));var e,t=this.$thead[0].getBoundingClientRect();this.reorderColMarker.querySelector(".col-line").style.height=this.el.clientHeight-(t.top-this.el.getBoundingClientRect().top)+"px",this.$tbody[0].appendChild(this.reorderColMarker),this.reorderColMarker.style.top=t.y-(this.reorderColMarker.querySelector(".col-icon").clientHeight+4)+"px"},M.prototype.removeReorderColMarker=function(){this.reorderColMarker&&this.reorderColMarker.remove()},M.prototype.onMouseMove=function(e){this.colResizeDrag?this.onResizingCol(e):this.colReorderDrag&&this.onReorderingCols(e)},M.prototype.onMouseUp=function(e){this.colResizeDrag?this.onResizeColsEnd(e):this.colReorderDrag&&this.onReorderColsEnd(e)},M.prototype.scrollTableHoriz=function(e){e&&this.$scrollfix.scrollLeft(e)},M.prototype.onReorderColsStart=function(t){var i=this;this.mouseDownTimeout=setTimeout(function(){i.mouseDownComplete=!0,t.preventDefault(),i.colReorderDrag=!0,i.elemRect=i.el.getBoundingClientRect();var e=t.target.closest(".column-name").classList.contains("aggregate-col"),e=(i.showDisabledOverlay(e?M.COLUMN_TYPE_BREAKDOWN:M.COLUMN_TYPE_AGGREGATE),i.dndColumnType=e?M.COLUMN_TYPE_AGGREGATE:M.COLUMN_TYPE_BREAKDOWN,$(t.target).closest(".th"));i.showReorderColTooltip(),i.reorderColTooltip.innerHTML=$(t.target).closest("span").text(),i.reorderColTooltip.style.left=t.pageX+"px",i.reorderColTooltip.style.top=t.pageY+"px",i.sourceCol=e[0],i.initialColOrderIndex=i.currColOrderIndex=e.index(),i.sourceCol.querySelectorAll(".column-name")[0].classList.add("reorder-col-selected","reorder-col-placeholder"),document.body.style.cursor="move",document.addEventListener("mousemove",i.mouseMoveHandler),document.addEventListener("mouseup",i.mouseUpHandler)},300)},M.prototype.onReorderingCols=function(e){var t,i,o=this.$scrollfix[0].clientWidth!==$(".scrollfix")[0].scrollWidth;this.reorderColTooltip.style.left=e.pageX+"px",this.reorderColTooltip.style.top=e.pageY+"px",this.pageX=e.pageX,this.pageY=e.pageY,this.updateUIOnColReorderDrag(),o&&(o=.15*this.el.clientWidth,i=this.elemRect.x+o,t=this.elemRect.right-o,e.pageX>=this.elemRect.left&&e.pageX<=i||e.pageX>t&&e.pageX<this.elemRect.right?(i=1==(t=e.pageX>=this.elemRect.left&&e.pageX<=i?1:-1)?this.elemRect.left:this.elemRect.right,this.scrollDelta=(Math.abs(i-e.pageX)-o)*t,this.scrollEventId||(this.scrollEventId=setInterval(this.scrollTableOnColDrag.bind(this),100))):this.cancelScrollTableEvent())},M.prototype.cancelScrollTableEvent=function(){this.scrollEventId&&(clearInterval(this.scrollEventId),this.scrollEventId=null)},M.prototype.updateUIOnColReorderDrag=function(){if(this.pageX>=this.elemRect.x&&this.pageX<=this.elemRect.right&&this.pageY>=this.elemRect.y&&this.pageY<=this.elemRect.bottom){for(var e=-1,t=this.$theadtr.find(".th"),i=0;i<t.length;i++){var o=t[i].getBoundingClientRect();if(o.left<this.pageX&&o.right>this.pageX){e=i;break}}var n,a,r=this.dndColumnType===M.COLUMN_TYPE_AGGREGATE?"aggregate-col":"breakdown-col";-1<e&&this.$theadtr.find(".column-name")[e].classList.contains(r)?(r=this.$theadtr.find(".th")[e].getBoundingClientRect(),n=this.elemRect.width-this.$scrollfix[0].clientWidth,a=void(this.currColOrderIndex=e),this.pageX<r.width/2+r.x?r.left<this.elemRect.left?a=this.elemRect.left:r.left>this.elemRect.right-n?a=this.elemRect.right-n:(a=r.left,this.initialColOrderIndex<this.currColOrderIndex&&this.currColOrderIndex--):r.right>this.elemRect.right-n?a=this.elemRect.right-n:r.right<=this.elemRect.left?a=this.elemRect.left:(a=r.right,this.initialColOrderIndex>this.currColOrderIndex&&this.currColOrderIndex++),this.showReorderColMarker(),this.reorderColMarker.style.left=a-1+"px",document.body.style.cursor="move"):(document.body.style.cursor="not-allowed",this.removeReorderColMarker())}else document.body.style.cursor="not-allowed",this.removeReorderColMarker()},M.prototype.scrollTableOnColDrag=function(){var e;this.colReorderDrag&&_.isNumber(this.scrollDelta)&&0!==this.scrollDelta&&(e=this.$scrollfix.scrollLeft(),this.$scrollfix.scrollLeft(e+this.scrollDelta),window.requestAnimationFrame(this.updateUIOnColReorderDrag.bind(this)))},M.prototype.onReorderColsEnd=function(e){var t,o,i,n,a,r;this.colReorderDrag&&(this.colReorderDrag=!1,this.cancelScrollTableEvent(),this.parent.scrollHorizValue=this.$scrollfix.scrollLeft(),this.disabledOverlay.remove(),this.removeReorderColMarker(),this.reorderColTooltip.remove(),document.removeEventListener("mousemove",this.mouseMoveHandler),document.removeEventListener("mouseup",this.mouseUpHandler),this.sourceCol.querySelectorAll(".column-name")[0].classList.remove("reorder-col-selected","reorder-col-placeholder"),i="not-allowed"===document.body.style.cursor,document.body.style.cursor="default",i||this.initialColOrderIndex===this.currColOrderIndex?this.parent.scrollHorizValue=void 0:this.dndColumnType===M.COLUMN_TYPE_AGGREGATE?(i=_.filter(this.dataDef,function(e){return!e.isAggregate}).length,(t=this.api.getProperty("ColumnsConfiguration")).splice(this.currColOrderIndex-i,0,t.splice(this.initialColOrderIndex-i,1)[0]),this.saveReorderedAggregateColumns(t),this.api.setProperty("ColumnsConfiguration",[],{silent:!0}),this.viewModel.set("ColumnsConfiguration",t),this.api.setProperty("ColumnsConfiguration",t)):(t=(i=this.viewModel.get("Basics.Data").get("_breakdownCols"))instanceof d.DocumentViewModel,o=t?i.get("value"):i,(i=_.clone(o)).splice(this.currColOrderIndex,0,i.splice(this.initialColOrderIndex,1)[0]),r=w.focus2SingleCommonPath(this.viewModel.get("Basics.Focus")),n=[],a=_.reduce(r,function(e,t,i){i=o[i];return t&&void 0!==i&&(e[i]=t),e},{}),_.takeWhile(i,function(e){e=a[e];return void 0!==e&&(n.push(e),!0)}),r=n.join(","),t?(this.api.getProperty("Basics").Data.get("_breakdownCols").set("value",i),this.api.setProperty("Basics.Focus",r)):(this.saveReorderedBreakdownColumns(i),this.api.setProperty("Basics.Focus",r),this.api.getProperty("Basics").Data.set("_breakdownCols",i),this.api.getProperty("Basics").Data.apply(),this.api.getProperty("Basics").Data.start())),this.pageX=this.pageY=this.dndColumnType=this.initialColOrderIndex=this.currColOrderIndex=this.scrollDelta=void 0)},M.prototype.saveReorderedBreakdownColumns=function(e){this.quickView&&this.viewModel.get("Basics.EnableCustomLayoutConfiguration")&&this.api.saveSetting("UsersOrderedBreakdownColumnsConfig",JSON.stringify({breakdownCols:e}))},M.prototype.saveReorderedAggregateColumns=function(e){this.quickView&&this.viewModel.get("Basics.EnableCustomLayoutConfiguration")&&(e=this.omitColumnFields(e,M.FIELDS_TO_SAVE_FOR_REORDER),this.api.saveSetting("UsersOrderedColumnsConfiguration",e))},M.prototype.onResizeColsStart=function(e){e.preventDefault(),this.colResizeDrag=!0,this.curColumnIndex=$(e.target).closest(".th").index(),this.pageX=e.pageX,this.showResizeMarker(),this.$resizeColMarker.css("left",e.pageX+"px"),document.body.style.cursor="col-resize",document.addEventListener("mousemove",this.mouseMoveHandler),document.addEventListener("mouseup",this.mouseUpHandler)},M.prototype.onResizingCol=function(t){var i=this,o=t.pageX-this.pageX,e=0<=this.dataDef[this.curColumnIndex].columnConfig.MinWidth?this.dataDef[this.curColumnIndex].columnConfig.MinWidth:0,e=Math.max(e,M.COL_MIN_WIDTH);this.dataDef[this.curColumnIndex].widthComputed+o<e||window.requestAnimationFrame(function(){i.headerEls[i.curColumnIndex][0].style.width=i.dataDef[i.curColumnIndex].widthComputed+o+"px";for(var e=i.curColumnIndex+1;e<i.headerEls.length;e++)i.dataDef[e].hidden||(i.headerEls[e][0].style.left=i.dataDef[e].leftComputed+o+"px");i.$el.find(".resize-col-marker").css("left",t.pageX+"px")})},M.prototype.onResizeColsEnd=function(e){if(this.colResizeDrag){this.colResizeDrag=!1,this.$resizeColMarker.remove(),document.body.style.cursor="default",this.resizeEndTimeStamp=e.timeStamp,document.removeEventListener("mousemove",this.mouseMoveHandler),document.removeEventListener("mouseup",this.mouseUpHandler),this.dataDef[this.curColumnIndex].widthComputed=parseFloat(this.headerEls[this.curColumnIndex][0].style.width);for(var t=this.curColumnIndex;t<this.dataDef.length;t++)this.dataDef[t].hidden||(this.dataDef[t].leftComputed=parseFloat(this.headerEls[t][0].style.left),this.dataDef[t].widthComputed=parseFloat(this.headerEls[t][0].style.width),this.footerEls&&this.footerEls[t].css({left:this.dataDef[t].leftComputed+"px",width:this.dataDef[t].widthComputed+"px"}));this.layoutRows(this.dataDef),this.saveResizedColumnData(this.curColumnIndex),this.pageX=this.curColumnIndex=void 0}},M.prototype.saveResizedColumnData=function(e){var t,i=this.viewModel.get("Basics.ColumnWidthMode");"Fixed"===i?this.setColumnProperty(e,"FixedWidth",this.dataDef[e].widthComputed):(t=this.calcRelWidthOfResizedColumn(e),this.setColumnProperty(e,"WidthWeight",t),"Relative"!==i&&(this.dataDef[e].columnConfig.FixedWidth=this.dataDef[e].widthComputed)),this.saveCurrentColumnLayout(e)},M.prototype.setColumnProperty=function(e,t,i){for(var o=-1,n=0;n<this.dataDef.length;n++)this.dataDef[n].isAggregate&&n<=e&&o++;var a=this.dataDef[this.curColumnIndex].isAggregate?"ColumnsConfiguration":"BreakdownColumnsConfiguration",r=this.dataDef[this.curColumnIndex].isAggregate?o:this.curColumnIndex;this.viewModel.set("".concat(a,".").concat(r,".").concat(t),i,{silent:!0}),this.api.setProperty("".concat(a,".").concat(r,".").concat(t),i)},M.prototype.calcRelWidthOfResizedColumn=function(e){for(var t=0,i=0,o=0;o<this.dataDef.length;o++)this.dataDef[o].hidden||(t+=this.dataDef[o].widthComputed,o!==e&&(i+=this.dataDef[o].width));var n=this.dataDef[e].widthComputed/t,n=n*i/(1-n);return this.dataDef[e].width=n},M.prototype.saveCurrentColumnLayout=function(e){var t;this.quickView&&this.dataDef.length&&(this.dataDef[e].columnConfig._RetainWidth=!0),this.quickView&&this.viewModel.get("Basics.EnableCustomLayoutConfiguration")&&this.dataDef.length&&(e=this.viewModel.get("Basics.ColumnWidthMode"),this.api.saveSetting("ColumnWidthMode",e),e=_.filter(this.dataDef,function(e){return e.columnConfig._RetainWidth}),t=[],_.each(e,function(e){t.push(e.columnConfig)}),t=this.omitColumnFields(t,M.FIELDS_TO_SAVE_FOR_RESIZE),this.api.saveSetting("UsersColumnsConfiguration",t))},M.prototype.omitColumnFields=function(e,t){return _.map(e,function(e){return _.pick(e,t)})},M.prototype.renderTable=function(e,t){this.renderArgs?(this.renderArgs.noResort=this.renderArgs.noResort&&e,this.renderArgs.scroll=null!=t?t:this.renderArgs.scroll):this.renderArgs={noResort:e,scroll:t}},M.prototype.renderValidate=function(){this.renderArgs&&(this.renderInternal(this.renderArgs.noResort,this.renderArgs.scroll),this.renderArgs=null),window.requestAnimationFrame(this.renderValidate.bind(this))},M.prototype.resize=function(){var e=this,t=this.$scrollfix.scrollTop();this.bodyHeight=this.$tbody.height(),this.layoutSection(this.headerEls),this.layoutRows(this.dataDef),this.layoutSection(this.footerEls),_.defer(function(){e.$scrollfix.scrollTop(t)}),this.isNotVisibleOnData&&(this.renderTable(),this.isNotVisibleOnData=!this.$el.is(":visible"))},M.prototype.rowCount=function(){return 0==this.depth?Math.ceil(this.$tbody.height()/this.viewModel.get("Style.RowHeight")):this.parent.rowCount()},M.prototype.scrollTop=function(){return 0==this.depth?this.scroll:this.parent.scrollTop()},M.prototype.selectCells=function(){var e;this.selected&&(e=this.modelViewDict[this.selected])&&e.selectCells()},M.prototype.setScroll=function(e){var t;0===this.depth?this.$tcontent.parent().scrollTop(e).trigger("scroll"):(t=this.parent.parent).setScroll(t.scroll+e)},M.prototype.expandAll=function(t,i){var o=this;this.isExpandingAll=!0,this.sortedModels.forEach(function(e){var e=v.key(e);0===t?o.onExpanded(o.getPath().concat([e]),i):1<=t&&null!=(e=o.modelViewDict[e])&&e.expandAll(t-1,i)},this),this.isExpandingAll=!1},M.prototype.isAllExpanded=function(t){var i=this,e=this.sortedModels.map(function(e){return i.modelViewDict[v.key(e)]});return 0<t&&(e=_.filter(e,function(e){return e&&!!e.expandedDatatable})),_.every(e,function(e){return e&&e.isAllExpanded&&e.isAllExpanded(t-1)})},M.prototype.onExpanded=function(e,t){this.parent.onExpanded(e,t)},M.prototype.setExpandRowByKey=function(e,t){var i,o=this.model.get(M.decodeKey(e));o&&(e=this.modelViewDict[v.key(o)],!t&&e instanceof v&&this.clearFilter(e.primaryKey),i=_.findIndex(this.sortedModels,function(e){return e.id===o.id}),!e&&-1<i&&(this.isExpandingAll?this.renderInternal(!1):(i=i*this.viewModel.get("Style.RowHeight"),this.renderInternal(!0,i),this.setScroll(i)),e=this.modelViewDict[v.key(o)]),e instanceof v)&&e.expand(t)},M.prototype.setRowHeight=function(e,t){t=t||Number(this.viewModel.get("Style.RowHeight")||0);e.el.style.height=t+"px",e.el.style.lineHeight=t+"px"},M.prototype.setBodyFontStyles=function(){var e=this.viewModel.get("Style.FontFamily"),t=this.viewModel.get("Style.FontSize"),t=/^(\d*\.)?(\d+)$/.test(t)?t+"px":t;this.$tbody.css({"font-size":t,"font-family":e})},M.prototype.setRowColor=function(e,t){t=v.key(e.model)===this.selected&&!e.parent.disableHighlighting?this.viewModel.get("Style.SelectedRowBackgroundColor"):t%2==0?this.viewModel.get("Style.EvenRowBackgroundColorOverride"):this.viewModel.get("Style.OddRowBackgroundColorOverride");(e.datatableRow||e).resetBgColor(t)},M.prototype.toggleFilters=function(e){var i=this.viewModel.get("Style.HeaderRowHeight");e?(this.$el.addClass("show-filters"),this.showingFilters=!0,this.$toggleFilters.find("span").text(t("Hide Filters")),this.$el.find(".filter").height(i-2+"px"),this.$el.find(".filter").prop("disabled",!1)):(this.$el.removeClass("show-filters"),this.showingFilters=!1,this.$toggleFilters.find("span").text(t("Show Filters")),this.clearFilters()),this.$theadtr.height(this.getTheadRowHeight()),this.$tbody.css("top",this.getTableBodyHeight())},M.prototype.updateHeight=function(){this.parent.updateHeight()},M.COLUMN_TYPE_AGGREGATE="aggregate",M.COLUMN_TYPE_BREAKDOWN="breakdown",M.HDR_TOOLTIP_HINT_CLICK_SORT="\n   ",M.HDR_TOOLTIP_HINT_DRAG_MOVE="\n     ",M.FIELDS_TO_SAVE_FOR_RESIZE=["Field","DisplayName","MinWidth","WidthWeight","FixedWidth","isBreakdown","_RetainWidth"],M.FIELDS_TO_SAVE_FOR_REORDER=["Field","DisplayName"],M.COL_MIN_WIDTH=2,M.SORT_ASC='<i class="fa fa-sort-asc"></i>',M.SORT_DESC='<i class="fa fa-sort-desc"></i>',M.SORT_NONE='<i class="fa fa-sort"></i>',M.HEADER_HEIGHT=25,M.OVERDRAW=0,M.downloadSupported="download"in document.createElement("a");var ie,S=M;function M(e){var t=ie.call(this,e)||this,i=(t.showingFilters=!1,t.expandedIds=[],t.scroll=0,t.filters={},t.hasScrollbar=!1,t.footerEls=[],t.headerEls=[],t.modelViewDict={},t.noSummary=!0,t.colResizeDrag=!1,t.colReorderDrag=!1,t.mouseDownComplete=!1,t.scrollEventId=null,t);return t.quickView=e.quickView,t.parent=e.parent,t.noHeader=e.noHeader,t.noSummary=e.noSummary,t.depth=e.depth,t.viewModel=e.viewModel,t.dashboardViewModel=e.dashboardViewModel,t.rowData=e.rowData,t.showFilters=e.showFilters,t.api=e.api,t.dataDef=e.dataDef,t.sortDef=e.sortDef||{index:-1,direction:null},t._debouncedSort=_.debounce(t.renderTable,100),t.debouncedSort=function(){i._debouncedSort()},t._debouncedHighlight=_.debounce(t.processMinMaxHighlighting,300),t.debouncedHighlight=function(){i._debouncedHighlight()},t.debouncedDomSort=_.debounce(t.domSort,300),t.debouncedUpdateExpandIcons=_.debounce(t.updateExpandIcons,320),t.debouncedHasScrollChange=_.debounce(t.onHasScrollChange,500),t.debouncedRenderFooter=_.debounce(t.renderFooter,320),t.mouseMoveHandler=t.onMouseMove.bind(t),t.mouseUpHandler=t.onMouseUp.bind(t),t.$el.addClass("data-table"),t.$el.html(L.datatable(!t.noHeader||!t.noSummary)),0===t.depth&&(t.layoutModule=new ee({api:t.api,table:t,viewModel:t.viewModel,dashboardViewModel:t.dashboardViewModel})),t.$tbody=t.$el.find(".table-body"),t.$tcontent=t.$el.find(".table-content"),t.$tfooterRoot=t.$el.find(".table-footer"),t.$tfooter=t.$el.find(".table-footer .table-row"),t.$scrollfix=t.$(".scrollfix"),t.$scrollfix.scroll(function(e){i.$thead[0].scrollLeft=e.currentTarget.scrollLeft,i.$tfooterRoot[0].scrollLeft=e.currentTarget.scrollLeft}),t.noSummary||(t.$thead=t.$el.find(".table-header"),t.$theadtr=t.$el.find(".table-header .table-row"),t.$tbody.css("top",t.getTableBodyHeight())),t.noHeader||(t.$thead=t.$el.find(".table-header"),t.$theadtr=t.$el.find(".table-header .table-row"),t.$resetFilters=t.$el.find(".reset-filters"),t.$toggleFilters=t.$el.find(".toggle-filters"),t.$toggleDrilldown=t.$el.find(".toggle-drilldown"),!t.showFilters||t.viewModel&&t.viewModel.has("showTools")&&!t.viewModel.get("showTools")||t.$el.addClass("has-tools"),t.$toggleFilters.css("display",t.showFilters?"inline-block":"none"),t.viewModel.get("drilldown")&&t.$toggleDrilldown.find("input").prop("checked",!0),t.onPropMultipleDrilldown(),t.existingFilters=document.body.classList.contains("pdf")?t.api.loadSetting("existingFilters"):null,t.renderHeader()),t.onModelReset(t.model),t.onPropDrilldown(t.viewModel,t.viewModel.get("Basics.Drilldown")),t.initalizeEvents(),t.renderFooter(),t.setSorting(t.viewModel.get("Basics.SortColumn"),t.viewModel.get("Basics.SortOrder")),t.documentID=e.parent.documentID,window.requestAnimationFrame(t.renderValidate.bind(t)),t}var oe={Name:{title:"Name",type:"string",default:""},Enabled:{type:"boolean",format:"checkbox",default:!0,options:{hidden:!0}},Target:{type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.highlightTargetPossibleValues"},default:"*"},ConditionSource:{title:"Condition Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.highlightColumnsPossibleValues"},default:""},ConditionOperator:{title:"Condition Operator",type:"string",enum:["","contains","starts with","ends with","==","<",">","<=",">=","!=","Fill Left-to-Right","Fill Right-to-Left"],default:""},ConditionValue:{title:"Condition Value",type:"string",default:""},Color:{type:"gradient",options:{noColor:!0},default:""},BackgroundColor:{title:"Background Color",type:"gradient",options:{noColor:!0,gradient:!0},default:""},BorderColor:{title:"Border Color",type:"gradient",options:{noColor:!0},default:""},Icon:{type:"icon",title:"Icon",default:""},IconColor:{title:"Icon Color",type:"gradient",options:{noColor:!0},default:""}},E=(_.each(["Name","Enabled","Target","ConditionSource","ConditionOperator","ConditionValue","Color","BackgroundColor","BorderColor","Icon","IconColor"],function(e,t){oe[e].propertyOrder=1010+t}),d.Tools),F={Trigger:{type:"string",enum:["Click","Double Click","Right Click","Hover"],default:"Click",title:"Trigger Action",propertyOrder:2}},T={Field:{title:"Data Field Name",type:"customDropdown",default:"",data:"possible_columns",watch:{possible_columns:"root.datatablePossibleColumns"}},DisplayName:{title:"Display Name",type:"string",default:"",watch:{Field:"Field"}},Tooltip:{title:"Header Tooltip",type:"string",default:""},WidthWeight:{title:"Relative Width",minimum:0,type:"number",default:1},MinWidth:{title:"Minimum Width (px)",type:"number",default:1},FixedWidth:{title:"Fixed Width (px)",type:"number",default:150},TextAlign:{title:"Text Align",type:"string",enum:["left","center","right"],default:"center"},Sortable:{type:"boolean",format:"checkbox",default:!0},Format:{type:"string",enum:["General","Number","Formatted Number","Smart Number","Date","Time","DateTime","Percentage"],default:"General"},Precision:{type:"number",title:"Precision",format:"number",minimum:0,maximum:10,default:2},HideTrailingZeroes:{type:"boolean",title:"Hide Trailing Zeroes",format:"checkbox",default:!1},Currency:{title:"Currency Symbol",type:"string",enum:["none","USD","GBP","EUR"],default:"none"},DateFormat:{title:"Date Format",type:"string",enum:E.Formats.Date,default:"YYYY-MM-DD"},TimeFormat:{title:"Time Format",type:"string",enum:E.Formats.Time,default:"HH:mm:ss"},HighlightNegative:{type:"boolean",title:"Highlight Negative",format:"checkbox",default:!0},HighlightNegativeColor:{type:"gradient",options:{formatClassName:"attachedToPreviousProperty",noColor:!0,gradient:!1},title:"Negative Color",default:""},HighlightChanges:{type:"boolean",title:"Highlight Changes",format:"checkbox",default:!1},HighlightChangeDuration:{title:"Highlight Change Duration",minimum:50,maximum:1e3,type:"number",step:10,format:"range",default:200},ShowArrowsOnChange:{type:"boolean",title:"Show arrows on Change",format:"checkbox",default:!1},HighlightMinValue:{type:"boolean",title:"Highlight Min Value",format:"checkbox",default:!1},HighlightMinValueColor:{type:"gradient",options:{noColor:!0,gradient:!1,formatClassName:"attachedToPreviousProperty"},title:"Min Value Color",default:""},HighlightMaxValue:{type:"boolean",title:"Highlight Max Value",format:"checkbox",default:!1},HighlightMaxValueColor:{type:"gradient",options:{noColor:!0,gradient:!1,formatClassName:"attachedToPreviousProperty"},title:"Max Value Color",default:""},PercentageColorOverride:{type:"gradient",options:{noColor:!0,gradient:!1},default:"",title:"Percentage Color"},RangeHighlight:{type:"boolean",title:"Range Highlight",format:"checkbox",default:!1},InvertRangeColor:{type:"boolean",title:"Invert Range Color",format:"checkbox",default:!1},RangeHighlightColor:{type:"gradient",options:{noColor:!0,gradient:!1,formatClassName:"attachedToPreviousProperty"},title:"Range Color",default:""},isBreakdown:{type:"boolean",title:"Is Breakdown",format:"checkbox",default:!1,options:{hidden:!0}},Hidden:{type:"boolean",format:"checkbox",default:!1},Footer:{type:"string",enum:["None","Average","Count","Sum","WeightedAverage"],default:"None",options:{enum_titles:["None","Average","Count","Sum","Weighted Average"]}},FooterWeights:{title:"Footer Weights",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.datatablePossibleColumns"},default:""},Template:{type:"handlebar",data:[],default:"",columnsFieldName:["datatablePossibleColumns","datatablePossibleBreakdownColumns"],templateItems:{values:{type:"object",items:_.keyBy(["thisField","thisValue","thisRawValue"])}}}},R={Field:{title:"Mapped Field Name",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.datatablePossibleBreakdownColumns"},default:"",options:{hidden:!0}},DisplayName:{title:"Display Name",type:"string",default:""},Tooltip:{title:"Header Tooltip",type:"string",default:""},TextAlign:{title:"Text Align",type:"string",enum:["left","center","right"],default:"center"},Sortable:{type:"boolean",format:"checkbox",default:!0},Format:{type:"string",enum:["General","Number","Formatted Number","Smart Number","Date","Time","DateTime","Percentage"],default:"General"},Precision:{type:"number",title:"Precision",default:2},HideTrailingZeroes:{type:"boolean",title:"Hide Trailing Zeroes",format:"checkbox",default:!1},Currency:{title:"Currency Symbol",type:"string",enum:["none","USD","GBP","EUR"],default:"none"},DateFormat:{title:"Date Format",type:"string",enum:E.Formats.Date,default:"YYYY-MM-DD"},TimeFormat:{title:"Time Format",type:"string",enum:E.Formats.Time,default:"HH:mm:ss"},WidthWeight:{title:"Relative Width",minimum:0,type:"number",default:1},MinWidth:{title:"Minimum Width (px)",type:"number",default:1},FixedWidth:{title:"Fixed Width (px)",type:"number",default:150},PercentageColorOverride:{type:"gradient",options:{noColor:!0,gradient:!1},default:"",title:"Percentage Color"},isBreakdown:{type:"boolean",title:"Is Breakdown",format:"checkbox",default:!1,options:{hidden:!0}},NoDisplay:{type:"boolean",title:"Hidden",format:"checkbox",default:!1,options:{hidden:!0}},Template:{type:"handlebar",data:[],default:"",columnsFieldName:["datatablePossibleColumns","datatablePossibleBreakdownColumns"],templateItems:{values:{type:"object",items:_.keyBy(["thisField","thisValue","thisRawValue"])}}}},k=(_.each(["Field","DisplayName","Tooltip","MinWidth","WidthWeight","FixedWidth","TextAlign","Sortable","Format","Precision","HideTrailingZeroes","Currency","DateFormat","TimeFormat","HighlightNegative","HighlightNegativeColor","HighlightChanges","HighlightChangeDuration","ShowArrowsOnChange","HighlightMinValue","HighlightMinValueColor","HighlightMaxValue","HighlightMaxValueColor","RangeHighlight","InvertRangeColor","RangeHighlightColor","PercentageColorOverride","Hidden","Footer","FooterWeights","Template"],function(e,t){T[e].propertyOrder=1010+t}),_.each(["Field","DisplayName","Tooltip","MinWidth","WidthWeight","FixedWidth","TextAlign","Sortable","Format","Precision","HideTrailingZeroes","Currency","DateFormat","TimeFormat","PercentageColorOverride","NoDisplay","Template"],function(e,t){R[e].propertyOrder=1010+t}),B.getComponentDefinition=function(e){var t,i,o={id:3,componentName:"pivot table",componentDescription:"See results from your data queries.",appKey:"Datatable",listViewThumb:e.websiteUrl+"Images/pivot-table.png",ghostViewThumb:null,buildViewThumb:null,appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"v2.12.0",Basics:{Name:"",Focus:"",Drilldown:!0,Data:"",ShowTools:!0,Animate:!0,MultipleDrilldown:!1,DrilldownInputArea:"Breakdown Cell",ExpandAll:!1,ShowExpandedSummary:!1,AggregateFunctionTooltip:!0,SortColumn:"",SortOrder:"",ScrollValue:"",ShowCache:!1,UseCache:!0,EnableCustomLayoutConfiguration:!1,ColumnWidthMode:"Relative"},Selection:{RowSelectionMode:"none",RowSelectionColumn:"",SelectedValue:""},Actions:[],HighlightRules:[],FileExport:{ShowExportCsvButton:!0,ShowExportExcelButton:!0,ShowFullExportButton:!1,FullExportOverride:"",RawFormat:!1,FileName:[],Actions:[]},BreakdownColumnsConfiguration:[],_BreakdownColumnsConfiguration:[],datatablePossibleBreakdownColumns:[],ColumnsConfiguration:[],_ColumnsConfiguration:[],datatablePossibleColumns:[],Style:{Theme:"Dark",EvenRowBackgroundColorOverride:"#282828",OddRowBackgroundColorOverride:"#303030",SelectedRowBackgroundColor:"",ExpandedSummaryStyle:!1,ShowFilterIconInFooter:!0,RowHeight:30,HeaderRowHeight:30,HeaderTextTransformation:"none",HeaderFontWeight:"",FontFamily:"",FontSize:"",advanced:""}},schema:{type:"object",title:"Properties",properties:{notificationEvent:{type:"readOnlyArray",items:{type:"string"},default:null,options:{collapsed:!0,hidden:!0}},datatablePossibleColumns:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},highlightTargetPossibleValues:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},highlightColumnsPossibleValues:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},selectedColumnPossibleValues:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},datatablePossibleBreakdownColumns:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",title:"Basics",options:{collapsed:!1},propertyOrder:10,properties:{Name:{title:"Name",type:"string",default:""},Data:{type:"data",title:"Data Source",default:""},Focus:{type:"viewstate",title:"Focus",default:""},Drilldown:{type:"boolean",title:"Single Column Drilldown",default:!1,format:"checkbox"},MultipleDrilldown:{type:"boolean",title:"Allow Multiple Paths",tooltip:"Allow multiple breakdown values from the same column to be selected",default:!1,format:"checkbox"},DrilldownInputArea:{type:"string",title:"Drilldown Input Area",tooltip:"Drilldown Input Area:\n\nWhen set to 'Breakdown Cell', the input control used to perform\na drilldown is the entire cell.\n\nWhen set to '+/-', the '+' or '-' symbol serves as the input control\nto perform a drilldown and all other areas within the cell can be\nused to perform a selection.",default:"Breakdown Cell",enum:["Breakdown Cell","+/-"]},ShowTools:{type:"boolean",title:"Show Tools",default:!0,format:"checkbox"},Animate:{type:"boolean",title:"Animate",default:!0,format:"checkbox"},ExpandAll:{type:"boolean",title:"Show Expand All Button",tooltip:"Breakdown columns will present a button in the\nheader to expand or collapse all its values",default:!1,format:"checkbox"},ShowExpandedSummary:{type:"boolean",title:"Show Expanded Summary",default:!1,format:"checkbox"},AggregateFunctionTooltip:{type:"boolean",title:"Aggregate Function Tooltip",tooltip:"When checked, a tooltip identifying the aggregate function will\nappear when the mouse pointer hovers over the aggregate detail.",default:!1,format:"checkbox"},UseCache:{type:"boolean",title:"Use Cached Columns",default:!0,format:"checkbox"},ShowCache:{type:"boolean",title:"Show Cached Columns",default:!1,format:"checkbox"},SortColumn:{type:"string",title:"Sort Column",enumSource:"possible_selected_columns",watch:{possible_selected_columns:"root.selectedColumnPossibleValues"},default:""},SortOrder:{type:"string",title:"Sort Order",enum:["","descending","ascending"],default:""},ScrollValue:{type:"number",title:"Scroll Value",default:0},EnableCustomLayoutConfiguration:{type:"boolean",title:"Keep User Customizations",default:!1,format:"checkbox"},ColumnWidthMode:{type:"string",title:"Column Width Mode",enum:["Relative","Fixed","Fixed for User resized columns, otherwise Relative (Mixed Mode)"],default:"Relative"}}},BreakdownColumnsConfiguration:{type:"array",format:"object",title:"Breakdown Columns",options:{collapsed:!0,reset:!1,resetTooltip:"",disable_array_delete:!0,disable_array_reorder:!0,disable_array_add:!0,bulkEditor:!0},propertyOrder:20,items:{type:"object",title:"breakdown",headerTemplate:"Column {{ i1 }} {{#if self.DisplayName}}{{ self.DisplayName }}{{else}}{{ self.Field }}{{/if}}",options:{collapsed:!0},properties:R}},_BreakdownColumnsConfiguration:{type:"array",format:"object",title:"Cached Breakdown Columns",options:{collapsed:!0,reset:!1,resetTooltip:"",disable_array_delete:!0,disable_array_reorder:!0,bulkEditor:!0,hidden:!0},propertyOrder:20,items:{type:"object",title:"breakdown",headerTemplate:"Column {{ i1 }} {{#if self.DisplayName}}{{ self.DisplayName }}{{else}}{{ self.Field }}{{/if}}",options:{collapsed:!0},properties:R}},ColumnsConfiguration:{type:"array",format:"object",title:"Aggregate Columns",options:{collapsed:!0,reset:!0,resetTooltip:"reset column configuration",disable_array_delete:!1,disable_array_reorder:!1,disable_array_add:!1,bulkEditor:!0},propertyOrder:30,items:{type:"object",title:"column",headerTemplate:"Column {{ i1 }} {{#if self.DisplayName}}{{ self.DisplayName }}{{else}}{{ self.Field }}{{/if}}",options:{collapsed:!0},properties:T}},_ColumnsConfiguration:{type:"array",format:"object",title:"Cached Aggregate Columns",options:{collapsed:!0,reset:!0,resetTooltip:"reset column configuration",disable_array_delete:!1,disable_array_reorder:!1,disable_array_add:!1,bulkEditor:!0,hidden:!0},propertyOrder:30,items:{type:"object",title:"column",headerTemplate:"Column {{ i1 }} {{#if self.DisplayName}}{{ self.DisplayName }}{{else}}{{ self.Field }}{{/if}}",options:{collapsed:!0},properties:T}},Selection:{type:"object",title:"Selection & Routing",options:{collapsed:!0},propertyOrder:40,properties:{RowSelectionMode:{type:"string",title:"Row Selection",default:"none",enum:["none","row","cell"]},RowSelectionColumn:{title:"Selected Column",type:"string",enumSource:"possible_selected_columns",watch:{possible_selected_columns:"root.selectedColumnPossibleValues"},default:""},SelectedValue:{type:"viewstate",title:"Selected Value",default:""}}},Actions:{type:"actions",options:{collapsed:!0},propertyOrder:45,fields:{map:_.extend({Current:{propertyOrder:10,title:"Source Column",type:"string",enumSource:"possible_selected_columns",watch:{possible_selected_columns:"root.highlightColumnsPossibleValues"}}},F),nav:F,query:F,url:F,rollingOrDefault:F}},HighlightRules:{type:"array",format:"object",title:"Highlight Rules",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Rule",headerTemplate:"Rule {{ i1 }} {{self.Name}}",options:{collapsed:!0},properties:oe}},FileExport:{type:"object",title:"File Export",options:{collapsed:!0},properties:{ShowExportCsvButton:{type:"boolean",title:"Show Export Csv Button",default:!0,format:"checkbox"},ShowExportExcelButton:{type:"boolean",title:"Show Export Excel Button",default:!1,format:"checkbox"},ShowFullExportButton:{type:"boolean",title:"Show Full Export Button",default:!1,format:"checkbox"},FullExportOverride:{type:"data",title:"Full Export Override",default:""},RawFormat:{type:"boolean",title:"Export with Raw Format",default:!1,format:"checkbox"},FileName:{type:"array",format:"table",title:"FileName",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Filename Part",options:{collapsed:!0},properties:{FileNamePart:{title:"FileName Part",type:"string"}}}},Actions:{type:"array",format:"table",title:"Actions",options:{collapsed:!0},items:{type:"object",title:"Action",options:{collapsed:!0},properties:{EventType:{title:"Event Type",type:"string",default:"all",enum:["all","onSuccess","onFail"]},Result:{title:"Last Result",type:"string",default:""}}}}}},Style:{type:"object",title:"Style",options:{collapsed:!0},propertyOrder:50,properties:{Theme:{type:"string",title:"Theme",default:"Dark",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},EvenRowBackgroundColorOverride:{type:"gradient",options:{noColor:!1,gradient:!1},default:"#282828",title:"Even Row Background"},OddRowBackgroundColorOverride:{type:"gradient",options:{noColor:!1,gradient:!1},default:"#303030",title:"Odd Row Background"},SelectedRowBackgroundColor:{type:"gradient",options:{noColor:!0,gradient:!1},default:"#505050",title:"Selected Row Background"},ExpandedSummaryStyle:{type:"boolean",title:"Expanded Summary Style",default:!1,format:"checkbox"},ShowFilterIconInFooter:{type:"boolean",title:"Show Filter Icon in Footer",default:!0,format:"checkbox"},RowHeight:{type:"number",format:"number",title:"Row Height",default:30},HeaderRowHeight:{type:"number",format:"number",title:"Header Row Height",default:30},HeaderTextTransformation:{title:"Header Text Transformation",type:"string",enum:["uppercase","lowercase","capitalize","none"]},HeaderFontWeight:{title:"Header Font Weight",type:"string",enum:["","normal","bold"],default:""},FontFamily:{title:"Font Family",type:"string",enum:["","Arial, Helvetica, sans-serif",'"Courier New", Courier, monospace',"Tahoma, Geneva, sans-serif",'"Times New Roman", Times, serif',"Verdana, Geneva, sans-serif"],default:""},FontSize:{title:"Font Size",type:"string",default:""},advanced:{type:"css",title:"Advanced CSS",default:""}}}},_transform:function(e,t,i,o){function n(e,t){e=_.get(e,"Basics.ShowCache");_.isNil(e)||(_.set(t,"properties._ColumnsConfiguration.options.hidden",!e),_.set(t,"properties._BreakdownColumnsConfiguration.options.hidden",!e))}function a(e,t){var e=_.get(e,"Basics.ColumnWidthMode"),i="Fixed"===e;_.each(["BreakdownColumnsConfiguration","_BreakdownColumnsConfiguration","ColumnsConfiguration","_ColumnsConfiguration"],function(e){_.set(t,"properties.".concat(e,".items.properties.").concat("FixedWidth",".hidden"),!i),_.set(t,"properties.".concat(e,".items.properties.").concat("WidthWeight",".hidden"),i)})}function r(e,t){var e=_.get(e,"Selection.RowSelectionMode"),i=e instanceof d.DocumentViewModel,o="none"===e&&!i;_.set(t,"properties.Selection.properties.RowSelectionColumn.hidden","row"!==e&&!i),_.set(t,"properties.Selection.properties.SelectedValue.hidden",o)}"root"===i?(n(e,t),a(e,t),r(e,t),o(e,t)):"Basics.ShowCache"===i?(n(e,t),o(e,t)):"Basics.ColumnWidthMode"===i?(a(e,t),o(e,t)):"Selection.RowSelectionMode"===i?(r(e,t),o(e,t)):o()}}}};if(e.settingsModel&&0<_.keys(e.settingsModel.attributes).length)for(i=B.upgrades.indexOf(_.find(B.upgrades,{version:e.settingsModel.get("version")}))+1;i<B.upgrades.length;i+=1)(t=B.upgrades[i]).fn(e.settingsModel),e.settingsModel.set("version",t.version);return o},B.defaults=function(){return B.getComponentDefinition({settingsModel:new y.Model}).appArgs.json},B);function B(){}k.upgrades=[{version:"4.0.0_d10",fn:function(e){e.set("Selection.RowSelectionMode",e.get("Basics.RowSelectionMode")),e.set("Selection.RowSelectionColumn",e.get("Basics.RowSelectionColumn")),e.set("Selection.SelectedValue",e.get("Basics.Selected")),e.unset("Basics.RowSelectionMode"),e.unset("Basics.RowSelectionColumn"),e.unset("Basics.Selected"),e.set("Style",_.extend({},k.defaults().Style,e.get("Style"))),e.set("Basics",_.extend({},k.defaults().Basics,e.get("Basics"))),e.set("Selection.SelectedObjectRouting",[]),e.set("FileExport",$.extend(!0,{},k.defaults().FileExport)),e.set("FileExport.ShowExportCsvButton",e.get("Basics.ShowTools"))}},{version:"4.0.0_p1",fn:function(e){e.set("FileExport.ShowFullExportButton",!1)}},{version:"4.0.0_p2",fn:function(e){var t=[];_.each(e.get("ColumnsConfiguration"),function(e){e.Hidden=!1,t.push(e)}),e.set({ColumnsConfiguration:t})}},{version:"4.0.0_p2a",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){"#606060"===e.PercentageColorOverride&&(e.PercentageColorOverride="")})}},{version:"4.0.2",fn:function(e){e.set("Basics.MultipleDrilldown",!1)}},{version:"4.0.2s1",fn:function(e){e.set("Basics.ExpandAll",!1)}},{version:"4.0.2d1",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){"#ff0000"===e.HighlightNegativeColor&&(e.HighlightNegativeColor=""),"#ff0000"===e.HighlightMinValueColor&&(e.HighlightMinValueColor=""),"#ff0000"===e.HighlightMaxValueColor&&(e.HighlightMaxValueColor=""),"#6898aa"===e.RangeHighlightColor&&(e.RangeHighlightColor="")})}},{version:"4.0.2t9",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){e.MinWidth=""})}},{version:"4.0.2t10",fn:function(e){_.each(e.get("BreakdownColumnsConfiguration"),function(e){e.MinWidth=""})}},{version:"4.2.0",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){e.Footer="None"})}},{version:"4.2.0d3",fn:function(e){e.set("Basics.SortOrder",""),e.set("Basics.SortColumn","")}},{version:"4.2.0d4",fn:function(e){e.set("Style.FontFamily",""),e.set("Style.FontSize","")}},{version:"4.3.0",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){e.FooterWeights=""})}},{version:"4.3.0s2",fn:function(e){e.set("Basics.ScrollValue",0)}},{version:"4.3.0s5",fn:function(e){var t;e.get("Actions")||(t=e.get("Selection.SelectedObjectRouting"))&&(t=_.map(t,function(e){return{_Type:"map",Trigger:"Click",Current:e.ColumnProperty,Target:e.ViewstateProperty}}),e.set("Actions",t),e.unset("Selection.SelectedObjectRouting"))}},{version:"4.3.1s1",fn:function(e){e.get("HighlightRules")||e.set("HighlightRules",[])}},{version:"4.4.1",fn:function(e){e.get("FileExport.ShowFullExportButton")||e.set("FileExport.ShowFullExportButton",!1)}},{version:"4.5.0",fn:function(e){_.each(e.get("BreakdownColumnsConfiguration"),function(e){_.has(e,"Template")||(e.Template="")}),_.each(e.get("ColumnsConfiguration"),function(e){_.has(e,"Template")||(e.Template="")})}},{version:"4.5.0a",fn:function(o){var n=d.Tools.getDefaultThemeColors("Light"),a=["Style.EvenRowBackgroundColorOverride","Style.OddRowBackgroundColorOverride","Style.SelectedRowBackgroundColor"];_.forEach(["#f0f0f0","#e0e0e0","#c8c8c8"],function(e,t){var i=a[t];o.get(i)===e&&o.set(i,n[t])})}},{version:"4.7.0",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){e.InvertRangeColor||(e.InvertRangeColor=!1)})}},{version:"4.7.1",fn:function(e){e=e.get("FileExport");_.isNil(e.FullExportOverride)&&(e.FullExportOverride="")}},{version:"4.7.3",fn:function(e){var t=e.get("Selection"),t=(t.RowSelectionMode=t.RowSelectionMode?"row":"none",e.get("BreakdownColumnsConfiguration")),i=e.get("ColumnsConfiguration");e.set("_BreakdownColumnsConfiguration",_.isNil(t)?[]:t),e.set("_ColumnsConfiguration",_.isNil(i)?[]:i),e.set("Basics.ShowExpandedSummary",!1)}},{version:"4.7.3.3",fn:function(e){var t=e.get("Style"),e=e.get("Basics");t.ExpandedSummaryStyle=!_.isNil(t.ExpandedSummaryStyle)&&t.ExpandedSummaryStyle,e.ShowCache=!_.isNil(e.ShowCache)&&e.ShowCache}},{version:"4.7.4",fn:function(e){e=e.get("Basics");e.UseCache=!!_.isNil(e.UseCache)||e.UseCache}},{version:"4.7.4.4",fn:function(e){e=e.get("FileExport");e.RawFormat=!_.isNil(e.RawFormat)&&e.RawFormat}},{version:"4.7.5",fn:function(e){e=e.get("FileExport");e.Actions=_.isNil(e.Actions)?[]:e.Actions}},{version:"4.7.7",fn:function(e){e.get("Basics.Name")||e.set("Basics.Name","")}},{version:"v2.7.0",fn:function(e){e.get("Basics.EnableCustomLayoutConfiguration")||e.set("Basics.EnableCustomLayoutConfiguration",!1),e.get("Basics.ColumnWidthMode")||e.set("Basics.ColumnWidthMode","Relative"),_.each(e.get("ColumnsConfiguration"),function(e){e.FixedWidth=150}),_.each(e.get("BreakdownColumnsConfiguration"),function(e){e.FixedWidth=150})}},{version:"v2.11.0",fn:function(e){e.get("Style.ShowFilterIconInFooter")||e.set("Style.ShowFilterIconInFooter",!0)}},{version:"v2.12.0",fn:function(e){e.get("Basics.DrilldownInputArea")||e.set("Basics.DrilldownInputArea","Breakdown Cell"),e.get("Basics.AggregateFunctionTooltip")||e.set("Basics.AggregateFunctionTooltip",!1)}}];ne.getRegex=function(e){var t,i=/\/[gimsuy]*$/,e=e.Field,o=!1;if(0===e.indexOf("/")){var o=!0,n=e.substring(1).replace(i,""),i=e.match(i),i=i?i[0].substring(1):"";try{t=new RegExp(n,i)}catch(e){d.Log.Error("PivotTable: invalid regex.",e),t=new RegExp("^$")}}else t=new RegExp("^"+e.replace(/\*/g,"(.*)")+"$","i");return{isExact:o,regex:t}},ne.isDynamic=function(e){e=e.Field||"";return 0===e.indexOf("/")||0<=e.indexOf("*")};var O=ne;function ne(){}e(V,ae=j),V.prototype.initialize=function(){},V.prototype.convertValueIfNecessary=function(e){return E.isKDBTemporal(e)?E.convertKDBTemporalToMoment(e).toDashString():e},V.prototype.isSelected=function(e){var t;return!!e&&(t=this.app.viewModel.get("Selection.RowSelectionColumn"),e=this.convertValueIfNecessary(e[t]),!_.isUndefined(e))&&e==this.app.viewModel.get("Selection.SelectedValue")},V.prototype.onRowSelected=function(e,t,i){var o,n=this,a=n.app.viewModel.get("Selection.RowSelectionColumn"),r=n.app.viewModel.get("Selection.RowSelectionMode");e&&"none"!==r?(n.selectedRowObject=e,n.trigger_selectedRowChanged(),n.doActions(e),n.ignoreSelectingRows||(n.ignoreSelectingRows=!0,o=n.app.api.getPropertyMeta?n.app.api.getPropertyMeta("Selection.SelectedValue"):n.app.api.getProperty("Selection.SelectedValue"),i=i?"cell"===r?t:n.convertValueIfNecessary(e[a]):_.get(o,"defaultValue")?_.get(o,"defaultValue"):t,o&&"list"===o.viewstateType?n.app.api.setProperty("Selection.SelectedValue",[i]):n.app.api.setProperty("Selection.SelectedValue",i),n.ignoreSelectingRows=!1)):(n.selectedRowObject=null,n.trigger_selectedRowChanged())},V.prototype.doActions=function(a,r){var l=this,s=(void 0===r&&(r="Click"),[]);this.app.viewModel.get("Actions").forEach(function(e,t){var i,o,n=e.Current;"{breakdownId}"===n&&(n=l.app.primaryKey,i=(o=l.app.viewModel.get("Basics")).Data,o=o.Focus,o=_.isEmpty(o)?0:_.first(w.focus2Array(o)).length,i.dataSet)&&i.dataSet.breakdownColumns&&(n=i.dataSet.breakdownColumns[o]),e.Trigger===r&&s.push(m(m({},e),{_PropertyIndex:t,Value:a?a[n]:null}))}),s.length&&this.app.api.doActions(s,"Actions")},V.prototype.remove=function(){this.stopListening()},V.prototype.trigger_selectedRowChanged=function(){this.app.trigger("selectedRowChanged",this.selectedRowObject)};var ae,re=V;function V(e){var t=ae.call(this)||this;return t.app=e,t.initialize(),t}e(P,le=j),P.prototype.initializeEvents=function(){this.listenTo(this.app.viewModel,"change:Style.Theme",this.onThemeChanged),this.listenTo(this.app.viewModel," change:Style.RowHeight change:Style.SelectedRowBackgroundColor change:Style.EvenRowBackgroundColorOverride change:Style.OddRowBackgroundColorOverride change:Style.FontFamily change:Style.FontSize",this.onPropStyleRenderChange),this.listenTo(this.app.viewModel," change:Style.HeaderRowHeight change:Style.HeaderTextTransformation change:Style.HeaderFontWeight",this.onPropHeaderStyleRenderChange)},P.prototype.onPropHeaderStyleRenderChange=function(){this.app.datatableView&&this.app.datatableView.renderHeader()},P.prototype.onPropStyleRenderChange=function(){this.app.datatableView&&!this.suspendPropStyleRenderChange&&this.app.datatableView.renderTable(!0)},P.prototype.onThemeChanged=function(){var e,t,o=this,n=!1,a=this.app.viewModel.get("theme"),i=(this.currentTheme&&this.app.$el.removeClass(this.currentTheme),this.currentTheme=a,this.app.$el.addClass(this.currentTheme),[i=this.app.api&&this.app.api.getProperty("Style.EvenRowBackgroundColorOverride")?this.app.api.getProperty("Style.EvenRowBackgroundColorOverride"):i,e=this.app.api&&this.app.api.getProperty("Style.OddRowBackgroundColorOverride")?this.app.api.getProperty("Style.OddRowBackgroundColorOverride"):e,t=this.app.api&&this.app.api.getProperty("Style.SelectedRowBackgroundColor")?this.app.api.getProperty("Style.SelectedRowBackgroundColor"):t]),r=["Style.EvenRowBackgroundColorOverride","Style.OddRowBackgroundColorOverride","Style.SelectedRowBackgroundColor"],l=d.Tools.getDefaultThemeColors("Light"),s=d.Tools.getDefaultThemeColors("Dark");_.forEach(i,function(e,t){var i;"Light"!==a||e&&e!==s[t]?"Dark"!==a||e&&e!==l[t]||(i=s[t]):i=l[t],i&&(n=!0,o.suspendPropStyleRenderChange=!0,o.app.api.setProperty(r[t],i),o.suspendPropStyleRenderChange=!1)}),n&&this.onPropStyleRenderChange()},P.prototype.remove=function(){this.stopListening()},P.prototype.setTheme=function(){var e=this.app.viewModel.get("Style.Theme")||"Dark";this.app.options.dashboardViewModel.get("DashboardTheme")&&(e=this.app.options.dashboardViewModel.get("DashboardTheme")),this.app.viewModel.set("theme",e),this.onThemeChanged()},P.DEFAULT_DARK_EVEN_COLOR="#282828",P.DEFAULT_DARK_ODD_COLOR="#303030",P.DEFAULT_DARK_SELECTED_COLOR="#505050",P.DEFAULT_LIGHT_EVEN_COLOR="#ffffff",P.DEFAULT_LIGHT_ODD_COLOR="#f4f4f4",P.DEFAULT_LIGHT_SELECTED_COLOR="#cecece";var le,se=P;function P(e){var t=le.call(this)||this;return t.app=e,t.setTheme(),t}de=y.View,e(A,de),A.prototype.initializeEvents=function(){this.themeModule.initializeEvents(),this.listenTo(this.viewModel,"change:Basics.Data",this.onPropDataSourceChanged),this.listenTo(this.viewModel,"change:Basics.Drilldown",this.onPropDrillDownChanged),this.listenTo(this.viewModel,"change:Basics.ShowTools",this.onPropShowToolsChanged),this.listenTo(this.viewModel,"change:Basics.Animate",this.onPropAnimateChange),this.listenTo(this.viewModel,"change:Basics.ShowExpandedSummary change:Style.ExpandedSummaryStyle change:Basics.DrilldownInputArea change:Basics.AggregateFunctionTooltip",function(){this.datatableView&&!_.isEmpty(this.viewModel.get("filter"))&&this.datatableView.toggleFilters(!1),this.resetLayout(),this.model&&this.columnInfo&&this.initColumnConfig()}.bind(this)),this.listenTo(this.viewModel,"change:notificationEvent",function(){this.resetLayout(),this.model&&this.columnInfo&&this.initColumnConfig()}.bind(this)),this.listenTo(this.viewModel,"change:BreakdownColumnsConfiguration change:ColumnsConfiguration",this.generateDataViewsFromReceivedData.bind(this)),this.listenTo(this.viewModel,"change:Basics.ScrollValue",this.onScrollValueChanged),this.listenTo(this,"rowDoubleClicked",function(e){this.selectionModule.doActions(e.model.toJSON(),"Double Click")}),this.listenTo(this,"rowRightClicked",function(e){this.selectionModule.doActions(e.model.toJSON(),"Right Click")}),this.listenTo(this,"rowMouseEntered",function(e){this.selectionModule.doActions(e.model.toJSON(),"Hover")})},A.prototype.addDatatableView=function(){var i=this,e=(this.calculateRowDataDepth(),document.createElement("div"));this.$el.append(e),this.datatableView=new S({el:e,model:this.collection,viewModel:this.viewModel,dataDef:this.dataDef,offsetIndex:0,parent:this,api:this.api,selectAPI:this,depth:0,rowData:this.rowData,sortDef:{index:-1,direction:null},showFilters:!0,dashboardViewModel:this.dashboardViewModel,quickView:this.options.quickView}),this.datatableView.$tcontent.parent()[0].addEventListener("scroll",function(e){i.scrollPending||(i.scrollPending=!0,window.requestAnimationFrame(function(){i.onScrollChange()}))}),this.onPropAnimateChange(),_.defer(function(){i.onResize()}),this.listenTo(this.datatableView,"sortingChanged",function(e){i.trigger("sortingChanged",e)}),this.listenTo(this.datatableView,"rowSelected",function(e){i.onRowSelected(e.model.toJSON(),e.selectedCellContentCache,!0),i.datatableView.renderTable(!1)}),this.listenTo(this.datatableView,"rowUnselected",function(e){_.get(e,"model")&&i.onRowSelected(e.model.toJSON(),null,!1),i.selectionModule.doActions(null),i.datatableView.renderTable(!1)}),this.onRowExpanded(),this.debouncedScrollInit=_.debounce(function(){var e,t;i.datatableView.noHeader||(i.datatableView.useFilterSettings=!0,i.datatableView.renderHeader(),_.isEmpty(i.datatableView.existingFilters))||(e=i.datatableView.dataDef.filter(function(e){return!e.hidden}).map(function(e){return e.field}),t=_.keys(i.datatableView.existingFilters),0<_.intersection(e,t).length?(i.datatableView.toggleFilters(!0),i.datatableView.applyFilters()):i.datatableView.saveFilterSettings(null)),i.onScrollValueChanged(),i.scrollHorizValue&&i.datatableView&&(i.datatableView.scrollTableHoriz(i.scrollHorizValue),i.scrollHorizValue=void 0),i.stopListening(i.datatableView,"rendered",i.debouncedScrollInit)},500),this.listenTo(this.datatableView,"rendered",this.debouncedScrollInit)},A.prototype.calculateRowDataDepth=function(){for(var e=this.rowData,t=0;e;)e=e.rowData,t+=1;return t},A.prototype.initColumnConfig=function(){var t,i,o,e,n,a=this,r=_.map(this.columnInfo.models,"id"),l=this.api.getProperty("datatablePossibleColumns"),s=this.viewModel.get("BreakdownColumnsConfiguration"),d=this.getColumnsConfiguration(),h=_.map(s,"Field"),c=this.getBreakdownColumns()||[],r=_.difference(r,c),u=this.viewModel.get("Basics.UseCache"),p=c.length&&!_.isEqual(h,c),h=(p&&this.initialBreakdownApplied&&(this.initialBreakdownApplied=!0,this.normaliseFocusAgainstBreakdown(c,h)),r.length&&(r.length!==l.length||!_.isEqual(r.sort(),l.sort())));(p||h)&&(this.api.setProperty("datatablePossibleColumns",r),this.api.setProperty("selectedColumnPossibleValues",_.union(c,r)),this.api.setProperty("highlightTargetPossibleValues",_.union(c,r,["*"])),this.api.setProperty("datatablePossibleBreakdownColumns",c),this.api.setProperty("highlightColumnsPossibleValues",_.union(["{breakdownId}"],c,r))),this.api.getProperty("highlightTargetPossibleValues")&&0!=this.api.getProperty("highlightTargetPossibleValues").length||this.api.setProperty("highlightTargetPossibleValues",_.union(c,r,["*"])),this.api.getProperty("highlightColumnsPossibleValues")&&0!=this.api.getProperty("highlightColumnsPossibleValues").length||this.api.setProperty("highlightColumnsPossibleValues",_.union(["{breakdownId}"],c,r)),h&&(h=_.difference(r,l),t=_.difference(l,r),e=[],h.length&&(i={},o=[],_.each(d,function(e){O.isDynamic(e)?o.push(O.getRegex(e).regex):i[e.Field]=!0}),_.each(h,function(t){!i[t]&&!_.some(o,function(e){return e.test(t)})&&e.push(a.generateColumnConfig(t,!1))})),e=_.uniqBy(e,function(e){return e.Field}),(n=this.api.getProperty("ColumnsConfiguration"))&&0<n.length&&(e=_.each(e,function(e){e.WidthWeight=n[n.length-1].WidthWeight,e.MinWidth=n[n.length-1].MinWidth,e.FixedWidth=n[n.length-1].FixedWidth})),u&&(e=_.map(e,function(t){var e=a.api.getProperty("_ColumnsConfiguration");return _.find(e,function(e){return e.Field===t.Field})||t})),l=this.api.getProperty("ColumnsConfiguration"),r=_.filter(l,function(e){return!t.includes(e.Field)}).concat(e),this.viewModel.set("ColumnsConfiguration",r,{silent:!0}),this.api.setProperty("ColumnsConfiguration",r),this.updateColumnConfig(r,"ColumnsConfiguration")),p&&(e=_.map(c,_.bind(function(e){return _.find(s,{Field:e})||this.generateColumnConfig(e,!0)},this)),this.viewModel.set("BreakdownColumnsConfiguration",e,{silent:!0}),this.api.setProperty("BreakdownColumnsConfiguration",e),this.updateColumnConfig(e,"BreakdownColumnsConfiguration")),this.generateDataViewsFromReceivedData()},A.prototype.getColumnsConfiguration=function(){var n=this.viewModel.get("ColumnsConfiguration");if(this.quickView&&this.viewModel.get("Basics.EnableCustomLayoutConfiguration")){var e,t=this.api.loadSetting("ColumnWidthMode"),i=this.api.loadSetting("UsersColumnsConfiguration"),o=(i&&i.length&&t===this.viewModel.get("Basics.ColumnWidthMode")&&(e=this.viewModel.get("BreakdownColumnsConfiguration"),_.each(i,function(t){var i=t.isBreakdown?e:n,o=_.findIndex(i,function(e){return e.Field===t.Field&&e.DisplayName===t.DisplayName});0<=o&&_.each(["WidthWeight","FixedWidth","_RetainWidth"],function(e){i[o][e]=t[e]})})),this.api.loadSetting("UsersOrderedColumnsConfiguration"));if(o&&o.length&&n.length===o.length){for(var a=!1,r=0;r<o.length;r++)if("break"===function(t){var e=_.findIndex(n,function(e){return o[t].Field===e.Field&&o[t].DisplayName===e.DisplayName});if(e<0)return a=!0,"break";0<=e&&e!==t&&n.splice(t,0,n.splice(e,1)[0])}(r))break;a?n=this.viewModel.get("ColumnsConfiguration"):(this.api.setProperty("ColumnsConfiguration",[],{silent:!0}),this.viewModel.set("ColumnsConfiguration",n,{silent:!0}),this.api.setProperty("ColumnsConfiguration",n))}}return n},A.prototype.updateColumnConfig=function(t,e){var i=this.api.getProperty(e),o=_.map(i,"Field");_.each(t,function(e){o.indexOf(e.Field)<0&&i.push(e)}),i=_.filter(i,function(e){return 0<=_.map(t,"Field").indexOf(e.Field)}),this.api.setProperty(e,i)},A.prototype.applyDataProperty=function(){var e,i=this.viewModel.get("Basics.Data");this.model&&(this.stopListening(this.model),this.api.unsubscribe(this.model),this.model=null,this.resetLayout()),this.model=i,this.model&&this.model.attributes?((e=function(e,t){t?this.api.showQueryStatus(t):this.api.hideQueryStatus()}.bind(this))(this.model,this.model.get("queryStatus")),this.listenTo(this.model,"change:queryStatus",e),this.api.subscribe(this.model,$.proxy(this.onData,this))):this.api.showQueryStatus({message:t('Invalid Data Source: "')+i.path+'" '+t("selected"),type:"Warning"},this.model)},A.getAggregationFnText=function(e){var t;if(void 0!==e)switch(e){case"avg":t="Average";break;case"min":t="Minimum";break;case"max":t="Maximum";break;case"count":case"sum":case"first":case"last":t=_.capitalize(e);break;default:t="Analytic"}return t},A.prototype.configToSpec=function(t,e,i){var o,n=i?R:T;(t=t||this.generateObjectFromSchema(n)).isBreakdown=i;return _.each(["WidthWeight","FixedWidth","MinWidth"],function(e){t[e]=_.isNumber(t[e])&&0<=t[e]?t[e]:n[e].default}),t.isBreakdown||(o=(i=this.viewModel.get("Basics.Data")).get("_aggregateCols"),i=i.get("_aggregateFns"),o&&"function"==typeof o.indexOf&&i&&(o=(o=o.indexOf(e))<i.length?i[o]:i[0],t.aggFnText=A.getAggregationFnText(o))),{header:t.DisplayName||t.Field||e,field:t.Field||e,columnConfig:t,width:t.WidthWeight||0,hidden:!1,footer:t.Footer}},A.prototype.generateColumnConfig=function(t,e){var i=this.viewModel.get("Basics.UseCache"),o=e?this.generateObjectFromSchema(R):this.generateObjectFromSchema(T),e=this.columnInfo.get(t),e=e?e.get("kdbType"):null,n="General",a="center",r=_.last(this.viewModel.get("BreakdownColumnsConfiguration"));if(i){i=_.find(this.viewModel.get("_BreakdownColumnsConfiguration"),function(e){return e.Field===t});if(i)return i}switch(r&&(o.MinWidth=r.MinWidth,o.width=r.WidthWeight,o.fixedWidth=r.FixedWidth),e){case 4:case 5:case 6:n="Number",o.Precision=0;break;case 7:n="Formatted Number",o.Precision=0;break;case 8:case 9:n="Formatted Number",o.Precision=4;break;case 12:n="DateTime",o.TimeFormat="HH:mm:ss.SSS";break;case 13:n="Date",o.DateFormat="YYYY-MM";break;case 14:n="Date";break;case 15:n="DateTime";break;case 16:n="Time",o.TimeFormat="HH:mm:ss.SSS";break;case 17:n="Time",o.TimeFormat="HH:mm";break;case 18:n="Time";break;case 19:n="Time",o.TimeFormat="HH:mm:ss.SSS";break;case 11:case 1001:a="left"}return(4<=e&&e<=9||12<=e&&e<=19)&&(a="right"),o.Field=t,o.DisplayName=t,o.Format=n,o.TextAlign=a,o},A.prototype.generateObjectFromSchema=function(t){return $.extend(!0,{},_.chain(_.keys(t)).map(function(e){return[e,t[e].default]}).fromPairs().value())},A.prototype.getAggregateColumns=function(){var e=_.map(this.columnInfo.models,function(e){return e.id});return this.isPivot()?_.difference(e,this.getBreakdownColumns()):e.slice(1)},A.prototype.getBreakdownColumns=function(){var e;return this.isPivot()?this.viewModel.get("breakdownColumns"):(e=_.first(this.columnInfo.models))?[e.id]:null},A.prototype.getAggregateConfig=function(){var n=this,a=this.getAggregateColumns(),e=_.filter(this.viewModel.get("ColumnsConfiguration"),{Hidden:!1}),r=[];return e.forEach(function(e){for(var t=O.isDynamic(e),i=O.getRegex(e).regex,o=0;o<a.length;o++)a[o]!==_.get(e,"Field")&&!a[o].match(i)||(r.push(n.configToSpec(t?_.extend({},e,{DisplayName:a[o],Field:a[o]}):e,a[o],!1)),a.splice(o,1),o--)}),r},A.prototype.getBreakdownConfig=function(){var i=this,o=this.viewModel.get("BreakdownColumnsConfiguration");return _.map(this.getBreakdownColumns(),function(e){var t=_.find(o,{Field:e});return i.configToSpec(t,e,!0)})},A.prototype.getColumnInfo=function(e){return this.columnInfo.get(e)},A.prototype.getPath=function(){return[]},A.prototype.isPivot=function(){return this.model&&("pivot"===this.model.get("_dataType")||this.model.get("_pivotType"))&&this.viewModel.get("breakdownColumns")&&1<this.viewModel.get("breakdownColumns").length},A.prototype.normaliseFocusAgainstBreakdown=function(e,i){var o,t=this.viewModel.get("Basics.Focus"),n=0;e&&e.length&&_.find(e,function(e,t){if(!(t<i.length&&e===i[t]))return!0;n++}),(e=t&&_.isString(t)&&"["==t[0]&&"]"==t[t.length-1]?(o=t.match(/"(.*?)"/g),_.each(o,function(e,t){e=(e=e.replace(/"/g,""))&&_.isString(e)?e.split(","):[];n=Math.min(e.length,n),o[t]='"'+e.slice(0,n).join(",")+'"'}),"["+o.join(",")+"]"):(e=t&&_.isString(t)?t.split(","):[],n=Math.min(e.length,n),e.slice(0,n).join(",")))!==t&&(this.viewModel.set("Basics.Focus",e,{silent:!0}),this.api.setProperty("Basics.Focus",e),console.log(e))},A.prototype.onData=function(e,t,i){var o=this,n=!1,a=e.columns;i?this.api.showQueryStatus(i):(this.api.hideQueryStatus(),e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey,this.collection.reset(),this.collection=new(E.createPivotCollectionFunc(this.primaryKey)),n=!0),a.reset?this.columnInfo.reset(a.reset):(this.columnInfo.remove(_.map(a.remove,function(e){return e.id})),this.columnInfo.add(a.add),this.columnInfo.add(a.change,{merge:!0})),n=n||_.some(["add","remove","reset","change"],function(e){return void 0!==a[e]}),this.columnInfo.sort(),!n&&""+this.viewModel.get("breakdownColumns")==""+e.breakdownColumns||(this.viewModel.set("breakdownColumns",e.breakdownColumns),this.initColumnConfig()),t.reset?this.collection.reset(t.reset):(this.collection.remove(_.map(t.remove,function(e){return e[o.primaryKey]})),this.collection.add(t.add),this.collection.add(t.change,{merge:!0})),this.datatableView&&(this.datatableView.applyFilters(),this.datatableView.renderFooter(),this.datatableView.isNotVisibleOnData=!this.$el.is(":visible")))},A.prototype.onPropAnimateChange=function(){this.datatableView&&this.datatableView.$el.toggleClass("animate",0!=this.viewModel.get("Basics.Animate"))},A.prototype.onPropDataSourceChanged=function(){var e=this;e.viewModel.get("Basics.Data");e.viewModel.set({columns:"",columnsConfig:""},{silent:!0}),e.api.setProperty("ColumnsConfiguration",[]),e.api.setProperty("datatablePossibleColumns",[]),e.applyDataProperty()},A.prototype.onPropDrillDownChanged=function(){this.datatableView&&(this.datatableView.renderTable(!1),this.onRowExpanded(),this.datatableView.debouncedHighlight())},A.prototype.onPropShowToolsChanged=function(){var e=this.viewModel.get("Basics.ShowTools");this.datatableView&&(e?this.datatableView.$el.addClass("has-tools"):(this.datatableView.$el.removeClass("has-tools"),this.datatableView.clearFilters(),this.datatableView.toggleFilters(!1),this.datatableView.renderTable()))},A.prototype.onRowExpanded=function(){var o,n=this,a=0;if(w.focus2Array(this.viewModel.get("Basics.Focus")).forEach(function(e){var t,i=n.datatableView;for(o=0;o<e.length;o++)i&&(a=Math.max(a,o),t=i.modelViewDict[""+e[o]])&&(i=t.expandedDatatable);i&&(a=Math.max(a,o))},this),this.viewModel.get("Basics.Drilldown"))for(o=0;o<this.getBreakdownColumns().length;o++)this.dataDef[o].hidden=o<a||a<o;else for(o=0;o<this.getBreakdownColumns().length;o++)this.dataDef[o].hidden=a<o;this.datatableView&&(this.datatableView.layoutSection(this.datatableView.headerEls),this.datatableView.layoutRows(this.dataDef),this.datatableView.layoutSection(this.datatableView.footerEls),this.datatableView.renderTable(!1))},A.prototype.onRowSelected=function(e,t,i){this.selectionModule.onRowSelected(e,t,i)},A.prototype.onResize=function(){var e;this.datatableView&&(e=this.viewModel.get("Basics.Animate"),this.viewModel.set("Basics.Animate",!1),this.datatableView.resize(),this.viewModel.set("Basics.Animate",e),this.datatableView.renderInternal())},A.prototype.onScrollChange=function(){var e;this.datatableView?(this.scrollPending=!1,e=this.datatableView.$tcontent.parent()[0].scrollTop,this.datatableView.scroll!==e&&(this.datatableView.scroll=e,this.datatableView.renderTable(!0),this.viewModel.set("Basics.ScrollValue",e))):window.requestAnimationFrame(this.onScrollChange.bind(this))},A.prototype.onScrollValueChanged=function(){var e,t;this.viewModel&&this.datatableView&&(e=this.viewModel.get("Basics.ScrollValue"),t=this.datatableView.$tcontent.parent()[0].scrollTop,this.datatableView.$tcontent.parent()[0].scrollHeight>this.datatableView.$tcontent.parent()[0].clientHeight)&&(this.datatableView.renderTable(!0,e),t!==e&&(this.datatableView.$tcontent.parent()[0].scrollTop=e),this.api.setProperty("Basics.ScrollValue",e))},A.prototype.onSettingsChange=function(e){var t,i,o=_.has(e,"Basics.Data"),n=(_.each(_.omit(e,"Basics.Data"),_.bind(function(e,t){"BreakdownColumnsConfiguration"!==t&&"ColumnsConfiguration"!==t||this.datatableView&&!_.isEmpty(this.viewModel.get("filter"))&&this.datatableView.toggleFilters(!1),this.viewModel.set(t,"BreakdownColumnsConfiguration"===t||"ColumnsConfiguration"===t?_.cloneDeep(e):e)},this)),o&&this.viewModel.set("Basics.Data",_.get(e,"Basics.Data")),this.hasInit||(this.hasInit=!0,this.quickView&&this.viewModel.get("Basics.EnableCustomLayoutConfiguration")&&(o=this.api.loadSetting("UsersOrderedBreakdownColumnsConfig"))&&(o=JSON.parse(o),(t=this.api.getProperty("Basics").Data.get("_breakdownCols"))instanceof d.DocumentViewModel||o.breakdownCols.length!==t.length||!_.every(o.breakdownCols,function(e){return _.includes(t,e)})||this.api.getProperty("Basics").Data.set("_breakdownCols",o.breakdownCols)),this.applyDataProperty(),this.initializeEvents()),RegExp(/HighlightRules\.[0-9]*\./));for(i in e)if(e.hasOwnProperty(i)&&n.test(i)){this.datatableView.processHighlightingOnChildren();break}this.updateCache(e,"BreakdownColumnsConfiguration"),this.updateCache(e,"ColumnsConfiguration")},A.prototype.generateDataViewsFromReceivedData=function(){this.correctWidths()||this.renderDataViews()},A.prototype.correctWidths=function(){var n=this;var l={},s={};return _.each(["BreakdownColumnsConfiguration","ColumnsConfiguration"],function(a){var e,t=!1,i=(l={},n.viewModel.get(a)),o=_.filter(i,"BreakdownColumnsConfiguration"===a?{NoDisplay:!1}:{Hidden:!1}),r="BreakdownColumnsConfiguration"===a?R:T;_.each(["WidthWeight","FixedWidth","MinWidth"],function(n){var e=_.filter(_.map(o,n));0<_.filter(e,function(e){return e<0}).length&&(t=!0,_.each(o,function(e,t){var i,o;e[n]&&e[n]<0&&(e=e,t=t,o=r[i=n].default,l["".concat(a,".").concat(t,".").concat(i)]=e[i]=o)}))}),t&&((e={})[a]=null,n.viewModel.set(e,{silent:!0}),_.each(l,function(e,t){n.api.setProperty(t,e,{silent:!0})}),s[a]=i,n.onSettingsChange(s))}),!_.isEmpty(s)},A.prototype.remove=function(){return this.datatableView&&this.datatableView.saveFilterSettings({}),this.debouncedScrollInit&&this.debouncedScrollInit.cancel(),this.removeDataView(),this.selectionModule.remove(),this.themeModule.remove(),this.model&&(this.api.unsubscribe(this.model),this.model=null),y.View.prototype.remove.apply(this)},A.prototype.updateCache=function(e,t){var i;_.some(Object.keys(e),function(e){return 0===e.indexOf(t)})&&(e=this.api.getProperty(t),i=this.api.getProperty("_"+t)||[],_.each(e,function(t){_.map(i,"Field").indexOf(t.Field)<0&&i.push(t),i=_.map(i,function(e){return e.Field===t.Field?t:e})}),this.api.setProperty("_"+t,i))},A.prototype.removeDataView=function(){this.datatableView&&(this.datatableView.remove(),delete this.datatableView)},A.prototype.renderDataViews=function(){var e,t,o=this,i=this.getBreakdownConfig();if(this.removeDataView(),this.model){var n=_.without(i.concat(this.getAggregateConfig()),void 0);if(_.each(n,function(e,t){var i=o.columnInfo.get(e.field);o.dataDef[t]=void 0!==o.dataDef[t]?_.extend(o.dataDef[t],e):e,o.dataDef[t].kdbType=i&&_.isFunction(i.get)?i.get("kdbType"):null}),this.dataDef=this.dataDef.slice(0,n.length),!_.isEmpty(this.dataDef)){for(t=0;t<i.length-1;t+=1)this.dataDef[t]&&(this.dataDef[t].expandable=!0);for(t=i.length;t<this.dataDef.length;t++)this.dataDef[t]&&(this.dataDef[t].isAggregate=!0);if(this.isPivot())for(e=this.rowData={depth:0,viewModel:this.viewModel},t=1;t<i.length-1;t+=1)e.rowData={depth:t,viewModel:this.viewModel},e=e.rowData;else this.rowData=void 0;this.addDatatableView(),this.onPropShowToolsChanged(),this.onPropAnimateChange()}}},A.prototype.renderTopFooter=function(){},A.prototype.resetLayout=function(){this.removeDataView(),this.api.setProperty("ColumnsConfiguration",[]),this.api.setProperty("BreakdownColumnsConfiguration",[]),this.api.setProperty("datatablePossibleColumns",[]),this.api.setProperty("selectedColumnPossibleValues",[]),this.api.setProperty("datatablePossibleBreakdownColumns",[]),this.viewModel.set({ColumnsConfiguration:[],BreakdownColumnsConfiguration:[],datatablePossibleColumns:[],selectedColumnPossibleValues:[],datatablePossibleBreakdownColumns:[]},{silent:!0})},A.prototype.rowCount=function(){return 0},A.prototype.onExpanded=function(i,o){var n,e=w.focus2Array(this.viewModel.get("Basics.Focus")),e=this.viewModel.get("Basics.MultipleDrilldown")?(e=_.filter(e,function(e){for(var t=0;t<i.length&&t<e.length&&e[t]===i[t];)t++;return t===i.length&&t<=e.length?(n=!0,o):!(t==e.length&&t<i.length)}),o&&!n&&e.push(i),o||e.push(i.slice(0,-1)),1<(e=_.filter(e,function(e){return 0<e.length})).length?"["+_.map(e,function(e){return'"'+_.map(e,function(e){return S.encodeKey(e)}).join(",")+'"'}).join(",")+"]":1===e.length?_.map(e[0],function(e){return S.encodeKey(e)}).join(","):""):(i=o?i:i.slice(0,-1),_.map(i,function(e){return S.encodeKey(e)}).join(","));this.api.setProperty("Basics.Focus",e)},A.prototype.scrollTop=function(){return 0},A.prototype.setTheme=function(){this.themeModule.setTheme()},A.prototype.updateColumnInfo=function(e){e.reset&&(this.columnInfo.reset(e.reset),this.updateDataDef())},A.prototype.updateDataDef=function(){var i=this;_.each(this.dataDef,function(e){var t=i.columnInfo.get(e.field);e.kdbType=t&&_.isFunction(t.get)?t.get("kdbType"):null})},A.prototype.updateHeight=function(){this.datatableView&&this.datatableView.debouncedSort()},A.getComponentDefinition=k.getComponentDefinition;var de,H=A;function A(e){var t=de.call(this,e)||this;return t.collection=new y.Collection,t.columnInfo=new y.Collection,t.dataDef=[],t.subscriptionKey=_.uniqueId("datatable_"),t.viewModel=new y.DeepModel({ordering:"null,null"}),A.componentApi=e.api,t.columnInfo.comparator="index",t.options=e,t.api=e.api,t.appViewModel=e.viewModel,t.appDataModel=e.dataModel,t.dashboardViewModel=e.dashboardViewModel,t.quickView=e.quickView,t.selectionModule=new re(t),t.themeModule=new se(t),t.hasInit=!1,t.initialBreakdownApplied=!1,w.hasCalc()||require(["calc_polyfill"],function(){}),t.documentID=t.options.dashboardViewModel.get("selectedDocumentId"),t}return H});
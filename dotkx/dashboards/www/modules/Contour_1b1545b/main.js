define(["d3","Plotly","Handlebars","QuickBase","moment","xlsx","backbone","css!./css/app.css"],function(p,f,e,n,o,r,i){"use strict";var a,l=this&&this.__extends||(a=function(t,e){return(a=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}))(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}),s=(P.getComponentDefinition=function(t){var e,o;if(0<_.keys(t.settingsModel.attributes).length)for(o=P.upgrades.indexOf(_.find(P.upgrades,{version:t.settingsModel.get("version")}))+1;o<P.upgrades.length;o+=1)(e=P.upgrades[o]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return{appArgs:{componentDescription:"",componentName:"Contour",id:1,quickStart:[{path:"Basics.Data"}],json:{Basics:{Name:"",Data:"",ShowScale:!0,Theme:"Dark",Type:"contour"},ColorPalette:{palettes:[],ColorScheme:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}],ContourVal:!1,TickInterval:1},Image:{Source:""},Layout:{Background:"",Bottom:20,Left:80,Pad:0,Right:20,Top:20},Style:{Smoothing:75},Tooltip:{ShowTooltip:!0,TooltipTemplate:'<p><i style="color:{{color}}" class="fa fa-circle"></i> Contour Data</p><table>    <tr><td>{{xaxis.title.text}}</td><td>{{x}}</td></tr>    <tr><td>{{yaxis.title.text}}</td><td>{{y}}</td></tr>    <tr><td>{{data.colorbar.title.text}}</td><td>{{toFixed z 2}}</td></tr></table>'},X:{Column:"",Max:100,Min:0,Title:{Label:"",LabelSize:12},Type:"linear",UseRange:!1},Y:{Column:"",Max:100,Min:0,Title:{Label:"",LabelSize:12},Type:"linear",UseRange:!1},Z:{Column:"",Max:100,Min:0,Title:{Label:"",LabelSize:12},Type:"linear",UseRange:!1},possibleColumns:[""],possibleLabels:[""],possiblePalettes:[""],version:"4.7.7.1"},schema:{properties:{Basics:{options:{collapsed:!1},properties:{DashboardTheme:{options:{hidden:!0}},Name:{title:"Name",type:"string",default:"",propertyOrder:1},Data:{default:"",format:"string",propertyOrder:1,title:"Data Source",type:"data"},FixedColumn:{propertyOrder:4,title:"Column Def",type:"string"},ShowScale:{default:!0,format:"checkbox",propertyOrder:3,title:"Show Scale Bar",type:"boolean"},Theme:{enum:["Light","Dark"],options:{hidden:!0},propertyOrder:2,title:"Theme",type:"string"},Type:{default:"contour",enum:["contour","heatmap"],propertyOrder:5,type:"string"}},propertyOrder:3,title:"Basics",type:"object"},ColorPalette:{options:{collapsed:!0},properties:{palettes:{propertyOrder:1,default:"",title:"Palette Theme",type:"string",enumSource:"possible_palettes",watch:{possible_palettes:"root.possiblePalettes"}},ColorScheme:{format:"table",items:{properties:{type:{default:"#5B9BD5",options:{gradient:!1},title:"Color",type:"gradient"}},title:"Color",type:"object"},options:{collapsed:!1},propertyOrder:5,title:"Color Palette",type:"array",uniqueItems:!1},ContourVal:{default:!1,format:"checkbox",title:"Show Annotation",type:"boolean"},TickInterval:{default:1,title:"Tick Interval",type:"number"}},propertyOrder:8,title:"Contour",type:"object"},Image:{options:{collapsed:!0},properties:{Source:{default:"",title:"Source",type:"string"}},propertyOrder:11,title:"Image",type:"object"},Layout:{options:{collapsed:!0},properties:{Background:{default:"",options:{noColor:!0},propertyOrder:1,type:"gradient"},Bottom:{default:80,propertyOrder:3,type:"number"},Left:{default:50,propertyOrder:4,type:"number"},Pad:{default:0,propertyOrder:6,type:"number"},Right:{default:80,propertyOrder:5,type:"number"},Top:{default:20,propertyOrder:2,type:"number"}},propertyOrder:7,title:"Layout",type:"object"},Style:{options:{collapsed:!0},properties:{Smoothing:{default:75,max:100,min:0,propertyOrder:15,title:"Line Smoothing",type:"number"},advanced:{default:"",propertyOrder:14,title:"Advanced CSS",type:"css"}},propertyOrder:11,title:"Style",type:"object"},Tooltip:{options:{collapsed:!0},properties:{ShowTooltip:{format:"checkbox",title:"Show Tooltip",type:"boolean"},TooltipTemplate:{title:"Custom Template",type:"tooltipTemplate"}},propertyOrder:9,title:"Tooltip",type:"object"},X:{options:{collapsed:!0},properties:{Column:{enumSource:"possible_columns",propertyOrder:1,type:"string",watch:{possible_columns:"root.possibleColumns"}},Max:{default:10,propertyOrder:5,type:"number"},Min:{default:0,propertyOrder:4,type:"number"},Title:{options:{collapsed:!0},properties:{Label:{default:"",propertyOrder:1,type:"string"},LabelSize:{default:"12",propertyOrder:2,type:"number"}},propertyOrder:6,title:"Title",type:"object"},Type:{default:"linear",enum:["linear","category","date"],propertyOrder:2,type:"string"},UseRange:{default:!1,format:"checkbox",propertyOrder:3,title:"Use Range",type:"boolean"}},propertyOrder:4,title:"X Axis",type:"object"},Y:{options:{collapsed:!0},properties:{Column:{enumSource:"possible_columns",propertyOrder:1,type:"string",watch:{possible_columns:"root.possibleColumns"}},Max:{default:10,propertyOrder:5,type:"number"},Min:{default:0,propertyOrder:4,type:"number"},Title:{options:{collapsed:!0},properties:{Label:{default:"",propertyOrder:1,type:"string"},LabelSize:{default:"12",propertyOrder:2,type:"number"}},propertyOrder:6,title:"Title",type:"object"},Type:{default:"linear",enum:["linear","category","date"],propertyOrder:2,type:"srting"},UseRange:{default:!1,format:"checkbox",propertyOrder:3,title:"Use Range",type:"boolean"}},propertyOrder:5,title:"Y Axis",type:"object"},Z:{options:{collapsed:!0},properties:{Column:{enumSource:"possible_columns",propertyOrder:1,type:"string",watch:{possible_columns:"root.possibleColumns"}},Max:{default:10,propertyOrder:5,type:"number"},Min:{default:0,propertyOrder:4,type:"number"},Title:{options:{collapsed:!0},properties:{Label:{default:"",propertyOrder:1,type:"string"},LabelSize:{default:"12",propertyOrder:2,type:"number"}},propertyOrder:6,title:"Title",type:"object"},Type:{default:"linear",enum:["linear"],propertyOrder:2,type:"string",options:{hidden:!0}},UseRange:{default:!1,format:"checkbox",propertyOrder:3,title:"Use Range",type:"boolean"}},propertyOrder:6,title:"Z Axis",type:"object"},notificationEvent:{default:["sym"],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},possiblePalettes:{propertyOrder:2,type:"array",format:"table",default:[""],options:{collapsed:!0,hidden:!0}},possibleColumns:{default:["sym"],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},propertyOrder:2,type:"array"},possibleLabels:{default:["sym"],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},propertyOrder:1,type:"array"},possibleRules:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},propertyOrder:1,type:"array"}},title:"Properties",type:"object"},version:"4.5.0"}}},P);function P(){}s.upgrades=[{fn:function(){for(var t=0;t<arguments.length;t++)t,0},version:0},{fn:function(t){var e=t.get("Image");t.set("Image",void 0===e?{Source:""}:e)},version:"4.5.0"},{fn:function(t){t.get("Basics.Name")||t.set("Basics.Name","")},version:"4.7.7"},{fn:function(t){t=t.get("ColorPalette");t.palettes=_.isNil(t.palettes)?"":t.palettes},version:"4.7.7.1"}];c.app=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,o,r,i){var a=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="contour-container">\n    <div class="contour" id='+t.escapeExpression("function"==typeof(o=null!=(o=a(o,"id")||(null!=e?a(e,"id"):e))?o:t.hooks.helperMissing)?o.call(null!=e?e:t.nullContext||{},{name:"id",hash:{},data:i,loc:{start:{line:2,column:28},end:{line:2,column:34}}}):o)+" >\n    </div>\n\n</div>"},useData:!0});var u,y=c;function c(){}function C(t){var e=u.call(this,t)||this;return e.ContourID="",e.columnNames=[],e.subscriptionKey="",e.columnTypes="",e.keyColName="",e.valueColName="",e.globalPalette=[],_.extend(e,_.pick(t,["api","dashboardViewModel"])),e.ContourID="Contour-"+e.cid,e.$el.html(y.app({id:e.ContourID})),e.$el.addClass("Contour-app"),e.$chart=e.$el.find(".contour"),e.globalPalette=t.dashboardAppModel.get("globalPalettes"),e.api.setProperty("possiblePalettes",_.map(_.uniqBy(e.globalPalette,"rule"),"rule")),e}return u=i.View,l(C,u),C.prototype.onSettingsChange=function(e){var o=this,t=[C.PROP_X,C.PROP_Y,C.PROP_Z,C.PROP_PALETTE,C.PROP_TYPE,C.PROP_Y_LAYOUT,C.PROP_X_RANGE,C.PROP_X_MIN,C.PROP_X_MAX,C.PROP_Y_RANGE,C.PROP_Y_MIN,C.PROP_Y_MAX,C.PROP_TOOLTIP,C.PROP_TOOLTIP_SHOW,C.PROP_Z_RANGE,C.PROP_Z_MIN,C.PROP_Z_MAX,C.PROP_X_TITLE,C.PROP_Y_TITLE,C.PROP_Z_TITLE,C.PROP_X_TITLE_SIZE,C.PROP_Y_TITLE_SIZE,C.PROP_Z_TITLE_SIZE,C.PROP_SCALE_SHOW,C.PROP_STYLE_SMOOTH,C.PROP_STYLE_TICKINT,C.PROP_LAYOUT_T,C.PROP_LAYOUT_B,C.PROP_LAYOUT_L,C.PROP_LAYOUT_R,C.PROP_LAYOUT_PAD,C.PROP_LAYOUT_BACKGR,C.PROP_STYLE_SHOWCONTOURLBL,C.PROP_X_LAYOUT];_.get(e,C.PROP_PALETTE_THEME)&&this.onSettingColorPaletteChange(e),this.callIfDef(e,C.PROP_DATA,this.onDataSourceChange.bind(this)),_.each(t,function(t){o.callIfDef(e,t,o.initializeChart.bind(o))}),this.callIfDef(e,C.PROP_IMG_SRC,this.appendImage.bind(this))},C.prototype.onResize=function(){this.initializeChart()},C.prototype.remove=function(){return this.subscriptionKey&&(this.api.unsubscribeTemplateViewStates(this.subscriptionKey),this.subscriptionKey=""),i.View.prototype.remove.apply(this)},C.prototype.onSettingColorPaletteChange=function(o){var r,i,t,e,a,p,l;_.get(o,C.PROP_PALETTE_THEME)&&(r=""+(null==(t=this.dashboardViewModel)?void 0:t.get("DashboardTheme")),i=".palette_theme",t=this.api.getProperty("ColorPalette.palettes"),e=_.filter(this.globalPalette,function(t){var e=".dark"!==_.get(t,"theme")&&".light"!==_.get(t,"theme")||t.theme.toLowerCase()==="."+r.toLowerCase();return t.rule===i&&e}),a=(_.isEmpty(t)||" "===t||t===i)&&0<e.length,p=!1,l=[],a&&_.each(e,function(t){l.push({type:n.Tools.rgbStr2hex(t.color)}),p=!0}),_.each(this.globalPalette,function(t){var e=!_.get(t,"theme")||t.theme.toLowerCase()==="."+r.toLowerCase();t.rule===_.get(o,C.PROP_PALETTE_THEME)&&e&&!a&&(l.push({type:n.Tools.rgbStr2hex(t.color)}),p=!0)}),p)&&this.api.setProperty("ColorPalette.ColorScheme",l)},C.prototype.getColorBar=function(){var t=this.api.getProperty(C.PROP_Z_TITLE),e=this.api.getProperty(C.PROP_Z_TITLE_SIZE);return{dtick:this.api.getProperty(C.PROP_STYLE_TICKINT),tickfont:{color:"white",family:"Courier New, monospace",size:e},tickmode:"linear",title:{size:e,text:t}}},C.prototype.getMargin=function(){var t=this.api.getProperty(C.PROP_LAYOUT_T),e=this.api.getProperty(C.PROP_LAYOUT_B),o=this.api.getProperty(C.PROP_LAYOUT_L),r=this.api.getProperty(C.PROP_LAYOUT_R);return{b:e,l:o,pad:this.api.getProperty(C.PROP_LAYOUT_PAD),r:r,t:t}},C.prototype.getAxis=function(t,e,o,r){return{side:t,title:e,titlefont:{size:o},type:r}},C.prototype.getLayout=function(t,e,o){var r=this.api.getProperty(C.PROP_LAYOUT_BACKGR),i=this.api.getProperty(C.PROP_X_TITLE),a=this.api.getProperty(C.PROP_Y_TITLE),p=this.api.getProperty(C.PROP_X_TITLE_SIZE),l=this.api.getProperty(C.PROP_Y_TITLE_SIZE),n=this.api.getProperty(C.PROP_X_RANGE),s=this.api.getProperty(C.PROP_X_MIN),P=this.api.getProperty(C.PROP_X_MAX),u=this.api.getProperty(C.PROP_Y_RANGE),y=this.api.getProperty(C.PROP_Y_MIN),c=this.api.getProperty(C.PROP_Y_MAX),d=this.getMargin(),O=this.api.getProperty(C.PROP_X_LAYOUT),h=this.api.getProperty(C.PROP_Y_LAYOUT),g=this.api.getProperty(C.PROP_STYLE_SHOWCONTOURLBL),m=this.api.getProperty(C.PROP_TYPE)||"contour",T=this.$el.height(),f={autosize:!1,height:void 0===T?d.b:T-d.b,hovermode:"closest",margin:d,paper_bgcolor:r||"transparent",width:this.$el.width(),xaxis:this.getAxis("bottom",i,p,O),yaxis:this.getAxis("left",a,l,h)};if(g&&"heatmap"===m){f.annotations=[];for(var R=0;R<e.length;R++)for(var b=0;b<t.length;b++){var L={font:{family:"Arial",size:12,color:"white"},showarrow:!1,text:o[R][b],x:t[b],xref:"x",y:e[R],yref:"y"};f.annotations.push(L)}}return n&&_.set(f,"xaxis.range",[s,P]),u&&_.set(f,"yaxis.range",[y,c]),f},C.prototype.getTooltip=function(){var u=this,y=this.api.getProperty(C.PROP_TOOLTIP),t=this.api.getProperty(C.PROP_TOOLTIP_SHOW),c=this.$chart.width(),d=this.$chart.height();t&&((t=document.getElementById(this.ContourID)).on("plotly_hover",function(t){var e,o,r=t.points,i=t.event.pointerX,t=t.event.pointerY,a=void 0!==c&&i<c/2?0:-80,p=void 0!==d&&t<d/2?5:-80,l=u.api.getProperty(C.PROP_Z_RANGE),n=u.api.getProperty(C.PROP_Z_MIN),s=u.api.getProperty(C.PROP_Z_MAX),P=u.api.getProperty(C.PROP_TYPE)||"contour";0<r.length&&(e=r[0],o=2,o="heatmap"===P?(l||(s=_.max(_.flatten(r[0].fullData.z)),n=_.min(_.flatten(r[0].fullData.z))),(e.z-n)/(s-n)):(P=e.data.contours,(e.z-P.start)/(P.end-P.start)),l=_.filter(e.data.colorscale,function(t){return t[0]<=o}),r=_.get(e,"data.colorscale"),s=0<l.length?_.last(l):_.first(r),e.color=s[1],u.tooltip=u.api.setTooltip({data:e,text:y,anchorEl:u.el,position:{left:i+a,top:t+p}}))}),t.on("plotly_unhover",function(){u.tooltip&&(u.api.removeTooltip(),delete u.tooltip)}))},C.prototype.callIfDef=function(t,e,o){void 0!==t[e]&&o.call(this,t[e],e)},C.prototype.destroyChart=function(){this.$chart.html("")},C.prototype.formatTick=function(t,e){return"linear"===this.api.getProperty(e+".Type")?parseFloat(t):t.toString()},C.prototype.initializeChart=function(){var i=this;if(_.get(this,"data.collection")){var a=_.get(this,"data.collection").toJSON(),t=this.api.getProperty(C.PROP_TYPE)||"contour",p=this.api.getProperty(C.PROP_X),l=this.api.getProperty(C.PROP_Y),n=this.api.getProperty(C.PROP_Z),e=_.map(this.api.getProperty(C.PROP_PALETTE),"type"),o=this.api.getProperty(C.PROP_SCALE_SHOW),r=this.api.getProperty(C.PROP_Z_RANGE),s=this.api.getProperty(C.PROP_Z_MIN),P=this.api.getProperty(C.PROP_Z_MAX),u=this.api.getProperty(C.PROP_STYLE_SMOOTH),y=this.api.getProperty(C.PROP_STYLE_SHOWCONTOURLBL),c={smoothing:void 0===u?.75:u/100};if(this.destroyChart(),p&&l&&n&&0<a.length){for(var d=_.sortBy(_.uniq(_.map(a,function(t){return i.formatTick(t[p],"X")}))),O=_.sortBy(_.uniq(_.map(a,function(t){return i.formatTick(t[l],"Y")}))),h=[],g=(_.each(O,function(o){var r=[];_.each(d,function(e){var t=_.filter(a,function(t){return i.formatTick(t[p],"X")===e&&i.formatTick(t[l],"Y")===o}),t=0<t.length?t[0][n]:null;r.push(t)}),h.push(r)}),[]),m=0;m<e.length;m++){var T=e[m];g.push([m*(1/(e.length-1)),T])}y={autocontour:!0,colorbar:this.getColorBar(),colorscale:g,connectgaps:!0,contours:{showlabels:y},hoverinfo:"none",line:c,showscale:o,type:t,x:d,y:O,z:h,zauto:!r,zmax:P,zmin:s,zsmooth:100===u&&"best"},c=this.getLayout(d,O,h);f.newPlot(this.ContourID,[y],c,{displayModeBar:!1,responsive:!0}),this.getTooltip(),this.appendImage()}}},C.prototype.appendImage=function(){var t,e,o,r,i=this.api.getProperty(C.PROP_IMG_SRC),a=p.select("#Contour-"+this.cid+" .bglayer");this.$el.find(".contourBackground-Image").remove(),i&&a&&a.node()&&(t=(a=a.node().getBBox()).height,e=a.width,o=a.x,a=a.y,(r=document.createElementNS("http://www.w3.org/2000/svg","image")).setAttributeNS(null,"height",t),r.setAttributeNS(null,"class","contourBackground-Image"),r.setAttributeNS(null,"width",e),r.setAttributeNS(null,"preserveAspectRatio","none"),r.setAttributeNS("http://www.w3.org/1999/xlink","href",i),r.setAttributeNS(null,"x",o),r.setAttributeNS(null,"y",a),r.setAttributeNS(null,"visibility","visible"),this.$el.find(".contour .main-svg").append(r))},C.prototype.onDataSourceChange=function(r){var i=this;this.unsubscribe(),this.datasource=r,this.data=null,this.datasource&&this.api.subscribe(this.datasource,function(e,o){i.columnNames=e.columns.collection.pluck("id"),i.columnTypes=e.columns.collection.pluck("kdbType"),i.keyColName=-1<i.columnNames.indexOf("key")?"key":i.columnNames[0],i.valueColName=-1<i.columnNames.indexOf("value")?"value":i.columnNames[1],i.data=o,i.api.setProperty("possibleColumns",i.columnNames);e=n.HeuristicHelpers.getNumericColumns(r);e.length<1?i.api.showErrorMessage({error:t("Data Source provided is not valid for Contour Chart"),type:"Warning"}):(""!==i.api.getProperty(C.PROP_X)&&-1!==i.columnNames.indexOf(i.api.getProperty(C.PROP_X))||i.api.setProperty(C.PROP_X,e[0]),""!==i.api.getProperty(C.PROP_Y)&&-1!==i.columnNames.indexOf(i.api.getProperty(C.PROP_Y))||i.api.setProperty(C.PROP_Y,e[1]),""!==i.api.getProperty(C.PROP_Z)&&-1!==i.columnNames.indexOf(i.api.getProperty(C.PROP_Z))||i.api.setProperty(C.PROP_Z,e[2]),i.initializeChart())})},C.prototype.setTheme=function(t){t=t.toLowerCase();this.$el.removeClass("dark light"),this.$el.addClass(t),this.initializeChart()},C.prototype.unsubscribe=function(){this.api.unsubscribe(this.datasource)},C.getComponentDefinition=s.getComponentDefinition,C.PROP_DATA="Basics.Data",C.PROP_TYPE="Basics.Type",C.PROP_X="X.Column",C.PROP_Y="Y.Column",C.PROP_Z="Z.Column",C.PROP_PALETTE="ColorPalette.ColorScheme",C.PROP_SCALE_SHOW="Basics.ShowScale",C.PROP_X_RANGE="X.UseRange",C.PROP_X_MIN="X.Min",C.PROP_X_MAX="X.Max",C.PROP_X_LAYOUT="X.Type",C.PROP_Y_RANGE="Y.UseRange",C.PROP_Y_MIN="Y.Min",C.PROP_Y_MAX="Y.Max",C.PROP_Y_LAYOUT="Y.Type",C.PROP_Z_RANGE="Z.UseRange",C.PROP_Z_MIN="Z.Min",C.PROP_Z_MAX="Z.Max",C.PROP_TOOLTIP="Tooltip.TooltipTemplate",C.PROP_TOOLTIP_SHOW="Tooltip.ShowTooltip",C.PROP_X_TITLE="X.Title.Label",C.PROP_X_TITLE_SIZE="X.Title.LabelSize",C.PROP_Y_TITLE="Y.Title.Label",C.PROP_Y_TITLE_SIZE="Y.Title.LabelSize",C.PROP_Z_TITLE="Z.Title.Label",C.PROP_Z_TITLE_SIZE="Z.Title.LabelSize",C.PROP_LAYOUT_T="Layout.Top",C.PROP_LAYOUT_B="Layout.Bottom",C.PROP_LAYOUT_L="Layout.Left",C.PROP_LAYOUT_R="Layout.Right",C.PROP_LAYOUT_PAD="Layout.Pad",C.PROP_LAYOUT_BACKGR="Layout.Background",C.PROP_STYLE_SMOOTH="Style.Smoothing",C.PROP_STYLE_SHOWCONTOURLBL="ColorPalette.ContourVal",C.PROP_STYLE_TICKINT="ColorPalette.TickInterval",C.PROP_PALETTE_THEME="ColorPalette.palettes",C.PROP_IMG_SRC="Image.Source",C});
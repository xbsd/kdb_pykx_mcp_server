define(["backbone","jqueryui","Handlebars","QuickBase","css!./css/app.css"],function(i,t,n,e){"use strict";var o,s=this&&this.__assign||function(){return(s=Object.assign||function(t){for(var e,r=1,o=arguments.length;r<o;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},r=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}))(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),a=(p.app=n.template({compiler:[8,">= 4.3.0"],main:function(t,e,r,o,i){var n=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div id="'+t.escapeExpression("function"==typeof(r=null!=(r=n(r,"key")||(null!=e?n(e,"key"):e))?r:t.hooks.helperMissing)?r.call(null!=e?e:t.nullContext||{},{name:"key",hash:{},data:i,loc:{start:{line:1,column:9},end:{line:1,column:16}}}):r)+'" style="height:100%;width: 100%;">\n    <div id="info" class="ol-info"></div>\n</div>\n'},useData:!0}),p);function p(){}c.enumWatch=function(t){return{enumSource:"poss_points",watch:{poss_points:"arrPointItem.possiblePoints"},title:t,type:"string"}},c.gradientProp=function(t,e,r){return{default:r=void 0===r?"#ffffff":r,title:t,options:{gradient:!1},type:"gradient",propertyOrder:e}},c.numberProp=function(t,e,r,o,i){return{default:i,title:t,type:"number",minimum:r,maximum:o,propertyOrder:e}},c.getComponentDefinition=function(t){var e={Trigger:{default:"Click",enum:["Click","Hover"],propertyOrder:2,title:"Trigger Action",type:"string"}},e={possiblePoints:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},DataType:{options:{hidden:!0},title:"Data Type",type:"string"},Name:{default:"",propertyOrder:1,type:"string"},Coordinates:{default:"lat/lng",propertyOrder:4,type:"string",enum:["lat/lng","x/y"]},DataSource:{default:"",format:"data",type:"data",title:"DataSource",propertyOrder:10},ID:s(s({},c.enumWatch("ID")),{default:"",propertyOrder:11}),Latitude:s(s({},c.enumWatch("Latitude/x Data")),{default:"",propertyOrder:12}),Longitude:s(s({},c.enumWatch("Longitude/y Data")),{default:"",propertyOrder:13}),ShowTooltip:{default:!1,propertyOrder:49,type:"boolean",title:"Show Tooltip"},Tooltip:{default:"{{id}}",type:"tooltipTemplate",title:"Tooltip",propertyOrder:50,templateItems:{values:{type:"object",items:_.keyBy(["id","latitude","longitude","altitude"])}}},Labels:{type:"object",title:"Labels",propertyOrder:50,options:{collapsed:!0},properties:{UseLabel:{default:!1,type:"boolean",propertyOrder:1,title:"Use Labels"},Label:s(s({},c.enumWatch("Label")),{default:"",propertyOrder:2}),Size:c.numberProp("Label Size",3,1,50,8),OffsetX:c.numberProp("Offset X",4,-500,500,0),OffsetY:c.numberProp("Offset Y",5,-500,500,0),TextBaseLine:{default:"center",type:"string",propertyOrder:6,title:"Position",enum:["center","right","left","start","end"]},Color:c.gradientProp("Text Color",7,"#ffffff"),Declutter:{default:!1,propertyOrder:8,type:"boolean",title:"Declutter",tooltip:"Avoid overlapping text labels",options:{hidden:!0}}}},Selected:{type:"object",title:"Selected",propertyOrder:80,options:{collapsed:!0},properties:{Color:c.gradientProp("Color",101,"#ff0000"),Column:s(s({},c.enumWatch("Column")),{default:"",propertyOrder:102}),SelectedItem:{default:"",propertyOrder:103,type:"string",title:"Selected Item"}}},Actions:{type:"actions",propertyOrder:85,options:{collapsed:!0},fields:{map:_.extend({Current:s(s({},c.enumWatch("Source Column")),{propertyOrder:21})},e),nav:e,query:e,url:e}}},r=_.extend({Cluster:{default:!1,propertyOrder:3,type:"boolean",title:"Cluster"},Icon:{type:"object",title:"Icon",propertyOrder:65,options:{collapsed:!0},properties:{Src:s(s({},c.enumWatch("Image Src")),{default:"",propertyOrder:1}),Color:s(s({},c.enumWatch("Fill Color")),{default:"",propertyOrder:2}),Opacity:c.numberProp("Opacity",3,0,1,1),Position:{default:"base",propertyOrder:4,type:"string",title:"Position",enum:["base","center"]}}}},e),e=[{title:"Circle",options:{linked_oneof_property:{property:"DataType",value:"Circle"}},properties:_.extend({Cluster:{default:!1,propertyOrder:3,type:"boolean",title:"Cluster"},Circle:{type:"object",title:"Circle",propertyOrder:60,options:{collapsed:!0},properties:{Radius:c.enumWatch("Radius"),FillColor:c.enumWatch("Fill Color"),StrokeColor:c.enumWatch("Stroke Color"),StrokeWidth:c.enumWatch("Stroke Width")}}},e)},{title:"Line",options:{linked_oneof_property:{property:"DataType",value:"Line"}},properties:_.extend({Line:{type:"object",title:"Line",propertyOrder:70,options:{collapsed:!0},properties:{Width:c.numberProp("Width",1,0,50,2),Color:c.gradientProp("Color",2,"#ff0000"),Simplify:{default:!1,type:"boolean",title:"Simplify",propertyOrder:3,tooltip:"Simplify the line using Douglas-Peucker algorithm"},Tolerance:c.numberProp("Tolerance",4,0,1e4,100)}}},e)},{title:"Icon",options:{linked_oneof_property:{property:"DataType",value:"Icon"}},properties:r}],r={id:47,componentName:"Quad Map",componentDescription:"This element displays Bar Charts.",appKey:"QuadMap",data:"".concat(t.websiteUrl,"/schema/QuadMap.json"),listViewThumb:"".concat(t.websiteUrl,"Images/QuadMap.png"),appArgs:{json:{version:"v2.15.0",Basics:{Name:"",MapGeneration:"WMTS",Projection:"WGS 84",CenterLat:0,CenterLng:0,Zoom:2,FitToData:!1},WTMS:{URL:"",WrapX:!1,OriginX:-180,OriginY:90},Points:{},Style:{advanced:""},format:{}},schema:{type:"object",title:"Properties",propertyOrder:1,properties:{Basics:{type:"object",title:"Basics",propertyOrder:2,options:{collapsed:!1},properties:{Name:{type:"string",title:"Name",default:"",propertyOrder:1},MapGeneration:{type:"string",title:"Map Generation",enum:["WMTS"],default:"WMTS",propertyOrder:2},Projection:{title:"Projection",type:"string",enum:["WGS 84","Mercator"],default:"WGS 84",propertyOrder:3},CenterLat:c.numberProp("Center Lat",4,-90,90,0),CenterLng:c.numberProp("Center Lng",5,-180,180,0),Zoom:c.numberProp("Zoom",6,0,28,2),FitToData:{type:"boolean",title:"Zoom & Fit to Data",default:!1,propertyOrder:7}}},WTMS:{type:"object",title:"WMTS",propertyOrder:3,options:{collapsed:!1},properties:{URL:{default:"",type:"string",propertyOrder:1,tooltip:"WMTS service URL"},WrapX:{default:!1,type:"boolean",propertyOrder:2,title:"Wrap X"},OriginX:{default:"",type:"string",propertyOrder:3,title:"Tile grid origin X"},OriginY:{default:"",type:"string",propertyOrder:4,title:"Tile grid origin Y"}}},Points:{type:"array",title:"Data",propertyOrder:4,format:"array",options:{collapsed:!0},items:{type:"object",id:"arrPointItem",title:"Data Layer",oneOf:e}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}},o=t.settingsModel;if(0<_.keys(o.attributes).length)for(var e=_.find(c.upgrades,{version:o.get("version")}),i=void 0===e?1:c.upgrades.indexOf(e)+1;i<c.upgrades.length;i++){var n=c.upgrades[i];n.fn(o),o.set("version",n.version)}return r},c.upgrades=[{version:"4.0.0",fn:function(t){}}];var l=c;function c(){}u=i.View,r(y,u),y.prototype.renderMapPoints=function(){var r=this;_.each(this.api.getProperty("Points"),function(t,e){r.renderMapPointsLayer(e)})},y.prototype.renderMapPointsLayer=function(t){this.pointsSource[t]?this.resetData(t):(this.pointsSource[t]=_.get(this.api.getProperty("Points.".concat(t)),"DataSource"),this.cleanUpSource(t),this.removeLayers(t),this.pointsSource[t]&&this.api.subscribe(this.pointsSource[t],_.bind(this.onData,this,t)))},y.prototype.cleanUpSource=function(t){this.pointsSource&&this.pointsSource[t]&&(this.stopListening(this.pointsSource[t]),this.api.unsubscribe(this.pointsSource[t]))},y.prototype.onPointsChange=function(t,e,r){this.cleanUpSource(r),e&&(this.pointsSource[r]=e,this.renderMapPointsLayer(r))},y.prototype.onData=function(t,e,r,o){if(o)return this.updateError("Points Source",o);o=this.pointsSource[t].dataSet.columns.map(function(t){return t.get("id")});this.api.setProperty("Points.".concat(t,".possiblePoints"),[""].concat(o)),this.pointsData[t]=r.items?r.items():this.pointsSource[t].dataSet.collection.models.map(function(t){return t.attributes}),r.reset?this.resetData(t):this.sourceToJSON(t)},y.prototype.resetData=function(t){this.sourceToJSON(t)},y.prototype.getLayerDisplayName=function(t){var e=this.api.getProperty("Points.".concat(t,".Name"));return e||"pointLayer"+t},y.prototype.sourceToJSON=function(i){var n,a,t,o=this,s=this.api.getProperty("Points.".concat(i,".ID")),e=this.api.getProperty("Points.".concat(i,".Cluster")),p=this.api.getProperty("Points.".concat(i,".Coordinates")),r=this.api.getProperty("Points.".concat(i,".DataType")),l=this.getLayerDisplayName(i),c=this.api.getProperty("Points.".concat(i,".Latitude")),u=this.api.getProperty("Points.".concat(i,".Longitude")),d=[],y=("Line"!==r?_.each(this.pointsData[i],function(t){var e=[_.isNil(u)||!t[u]?0:parseFloat(t[u]),_.isNil(c)||!t[c]?0:parseFloat(t[c])],e=new ol.Feature(new ol.geom.Point("lat/lng"===p?ol.proj.fromLonLat(e):e)),r=o.getStyle(i,t);e.setId(t[s]),e.setProperties({Layer:i}),e.setStyle(r),d.push(e)}):(n=this.api.getProperty("Points.".concat(i,".Line.Simplify")),a=this.api.getProperty("Points.".concat(i,".Line.Tolerance")),_.each(this.pointsData[i],function(t){var r=[t[u],t[c]],o=[],e=(_.each(r[0],function(t,e){e=[r[0][e],r[1][e]],e="lat/lng"===p?ol.proj.fromLonLat(e):e;o.push(e)}),new ol.geom.LineString(o)),e=new ol.Feature({geometry:n&&a?e.simplify(a):e});e.setId(t[s]),e.setProperties({Layer:i}),d.push(e)})),new ol.source.Vector({features:d})),f={};"Line"===r?(r=this.api.getProperty("Points.".concat(i,".Line.Width")),t=this.api.getProperty("Points.".concat(i,".Line.Color")),t=new ol.layer.WebGLVector({name:l,source:y,style:[{style:{"stroke-width":r,"stroke-color":t}}]}),this.app.addLayer(t,l)):e?(r=new ol.source.Cluster({distance:40,minDistance:20,source:y}),e=new ol.layer.Vector({name:l,source:r,style:function(t){var e=t.get("features").length,r=f[e];return 1<e?r||(r=new ol.style.Style({image:new ol.style.Circle({radius:10,stroke:new ol.style.Stroke({color:"#fff"}),fill:new ol.style.Fill({color:"#3399CC"})}),text:new ol.style.Text({text:e.toString(),fill:new ol.style.Fill({color:"#ffffff"})})}),f[e]=r):1===e&&(r=t.get("features")[0].getStyle()),r}}),this.app.addLayer(e,l)):(t=new ol.layer.Vector({name:l,source:y}),this.app.addLayer(t,l))},y.prototype.getActions=function(r,t,e){var o=this.api.getProperty("Points.".concat(t,".ID")),i=this.api.getProperty("Points.".concat(t,".Actions")),n=_.filter(this.pointsData[t],function(t){return t[o]===e}),a=[];_.each(i,function(t,e){t.Value=t.Trigger===r?n[0][t.Current]:t.Target.get("value"),t._PropertyIndex=e,a.push(t)}),this.api.doActions(a,"Points.".concat(t,".Actions"))},y.prototype.getTooltip=function(t,e){var r=this.api.getProperty("Points.".concat(t,".ShowTooltip")),o=this.api.getProperty("Points.".concat(t,".Tooltip")),i=this.api.getProperty("Points.".concat(t,".ID"));return r&&0<(r=_.filter(this.pointsData[t],function(t){return t[i]===e})).length?n.compile(o)(r[0]):""},y.prototype.clickEvent=function(t,e){var r=this.api.getProperty("Points.".concat(t,".Selected.SelectedItem")),o=this.api.getProperty("Points.".concat(t,".Selected.Column")),i=this.api.getProperty("Points.".concat(t,".ID")),n=_.filter(this.pointsData[t],function(t){return t[i]===e});o&&r&&(r=_.get(n,"0."+o),this.api.setProperty("Points.".concat(t,".Selected.SelectedItem"),r),console.log(r))},y.prototype.getStyle=function(t,e){var r,o,i,n,a=this.api.getProperty("Points.".concat(t,".DataType")),s=this.api.getProperty("Points.".concat(t,".Labels.UseLabel"));return"Icon"===a?(n=this.api.getProperty("Points.".concat(t,".Icon.Source")),o=this.api.getProperty("Points.".concat(t,".Icon.Color")),i=this.api.getProperty("Points.".concat(t,".Icon.Opacity")),r=this.api.getProperty("Points.".concat(t,".Icon.Position")),n=n?e[n]:"point.png",n={src:this.baseURL+"img/"+n,displacement:"base"===r?[0,10]:[0,0]},o&&(n.color=e[o]),i&&(n.iconOpacity=i),r=new ol.style.Style({image:new ol.style.Icon(n)})):"Circle"===a&&(o=this.api.getProperty("Points.".concat(t,".Circle.Radius")),i=this.api.getProperty("Points.".concat(t,".Circle.FillColor")),n=this.api.getProperty("Points.".concat(t,".Circle.StrokeColor")),a=this.api.getProperty("Points.".concat(t,".Circle.StrokeWidth")),r=new ol.style.Style({image:new ol.style.Circle({radius:this.getStyleProp(o,e,250,5),fill:new ol.style.Fill({color:""===i?"#ff0000":e[i]}),stroke:new ol.style.Stroke({color:""===n?"#ff0000":e[n],width:this.getStyleProp(a,e,10,1)})})})),s?(o=this.api.getProperty("Points.".concat(t,".Labels.Label")),i=this.api.getProperty("Points.".concat(t,".Labels.Size")),n=this.api.getProperty("Points.".concat(t,".Labels.OffsetX")),a=this.api.getProperty("Points.".concat(t,".Labels.OffsetY")),s=this.api.getProperty("Points.".concat(t,".Labels.TextBaseLine")),t=this.api.getProperty("Points.".concat(t,".Labels.Color")),[r,new ol.style.Style({text:new ol.style.Text({font:"".concat(i,"px sans-serif"),text:e[o],textAlign:s,offsetX:n,offsetY:a,fill:new ol.style.Fill({color:t})})})]):r},y.prototype.getStyleProp=function(t,e,r,o){return!_.isNil(t)&&!_.isNil(e[t])&&r<=(o=parseFloat(e[t]))?r:o},y.prototype.updateError=function(t,e){e?this.errors[t]=e:delete this.errors[t],_.keys(this.errors).length?(e=_.map(this.errors,function(t,e){return"["+e+"]: "+t.error}),this.api.showQueryStatus({error:e.join("\n"),type:"Error"})):this.api.hideQueryStatus()},y.prototype.removeLayers=function(t){},y.prototype.doActions=function(r,o,t){var i=[],e=this.api.getProperty("Points.".concat(t,".Actions"));_.each(e,function(t,e){t.Value=t.Trigger===r?o[t.Current]:t.Target.get("value"),t._PropertyIndex=e,i.push(t)}),this.api.doActions(i,"Points.".concat(t,".Actions"))};var u,d=y;function y(t){var e=u.call(this,t)||this;return e.errors={},e.pointsSource={},e.pointsData={},e.data={},e.previousData={},e.addBoundingBtn=!0,e.map=t.map,e.api=t.api,e.path=t.path,e.el=t.el,e.app=t.app,e.baseURL=t.baseURL,e.renderPoints=_.debounce(function(){e.renderMapPoints()},250),e.renderPointsByLayer=_.debounce(function(t){e.renderMapPointsLayer(t)},250),e}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){if(null===t)throw new TypeError("Cannot convert undefined or null to object");var r=Object(t);return _.each(arguments,function(t){if(null!==t)for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(r[e]=t[e])}),r},writable:!0,configurable:!0});h.cache=function(p,l,c,u){var t;_.isArray(c.load)&&(t=c.load.reduce(function(t,e,r){var o,i,n,a,s;return p.cache&&((i=p.cache[e])&&i.get("_viewType")&&(i=(o=i).get("value"),n=(a=(l+e).split(".")).pop(),a=a.join("."),s={},n)&&(s[n]=o,u.setProperty(a,s,{bypass:!0})),t[e]=i||c.defaults&&c.defaults[r]),t},{}),p.set(t)),_.isArray(c.store)&&(t=c.store.reduce(function(t,e){var r=(l+e).split("."),o=r.pop();return o&&(t[e]=u.getProperty(r.join("."))[o]),t},{}),_.extend(p.cache,t),t=c.store.reduce(function(t,e){return t[e]=void 0,t},{}),p.set(t))},h.compareKDBTimes=function(t,e){return t.i>e.i?1:t.i<e.i?-1:t.n>e.n?1:t.n<e.n?-1:0},h.convertPropertyIfMoment=function(t){t=Tools.convertISODatetimeToKDBLikeObject(t);return Tools.isKDBTemporal(t)?Tools.convertKDBTemporalToMoment(t):t},h.expandNestedViewStates=function(t,e){var r,o=/([a-zA-Z]+)\.[0-9]+\./,i=Object.keys(t),n=[];return(n=_.every(i,function(){var t=e.getPropertyMeta(i[0]);return t&&"viewstate"===t.type})?_.uniq(_.filter(_.map(i,function(t){t=o.exec(t);return t?t[1]:null}))):n).length?(r={},_.each(n,function(t){return r[t]=e.getProperty(t)}),r):t},h.focus2Array=function(t){var e=[],r=/"([^"]*)"/g,t=t.toString?t.toString():"",o=/^\[([^\]]*)]$/.exec(t);if(null!==o){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(o[1]))for(var i=void 0;null!==(i=r.exec(o[1]));)e.push(_.map(i[1].split(","),function(t){return t.replace(/&#44;/g,",")}))}else e.push(t.split(","));return _.filter(e,function(t){return 0<(""+t).length})},h.hex2RGB=function(t){t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]:[255,255,255]},h.RGB2hex=function(t){return"#"+((1<<24)+(t[0]<<16)+(t[1]<<8)+t[2]).toString(16).slice(1)},h.clamp=function(t,e,r){return r<t?r:t<e?e:t},h.interpolateColor=function(t,e,r,o){for(var r=(r-e)/(t.length-1),o=this.clamp((o-e)/r,0,t.length-1),o=_.isNaN(o)?0:o,e=t[Math.floor(o)].type,r=t[Math.ceil(o)].type,i=this.hex2RGB(e),n=this.hex2RGB(r),a=o-Math.floor(o),s=i.slice(),p=0;p<3;p++)s[p]=Math.round(s[p]+a*(n[p]-i[p]));return this.RGB2hex(s)},h.getConditionResult=function(t,e,r){var o,i,n={isMatch:function(t,e){var r,o=!1,i=t.split(/ +and +| +/);for(_.includes(i,"or")&&(i=_.without(i,"or"),o=!0),r=0;r<i.length;r++)0!==i[r].indexOf("-")&&i[r].indexOf("*")<0&&(i[r]="*"+i[r]+"*");return _[o?"some":"every"](i,function(t){return n.isSimpleMatch(t,e)})},isSimpleMatch:function(t,e){var r=!1,t=(0===t.indexOf("-")&&(t=t.replace("-",""),r=!0),new RegExp("^"+t.replace(/\*/g,".*")+"$").test(e));return r?!t:t}},a=!1,s=isNaN(parseFloat(t))||_.isObject(t)?(""+t).toLowerCase():parseFloat(t),p=isNaN(parseFloat(e))||_.isObject(e)?(""+e).toLowerCase():parseFloat(e);switch(t&&t.class&&0<=["1212","1213","1214","1215"].indexOf(t.class)?(s=Tools.convertKDBTemporalToMoment(t).unix(),"in"===r?(o=[],_.each(e.toString().split(","),function(t){o.push(Tools.convertDateStringValueToMoment(t).unix()),p=o.toString()})):p=Tools.convertDateStringValueToMoment(e).unix()):t&&t.class&&0<=["1216","1217","1218","1219"].indexOf(t.class)&&(s=Tools.convertKDBTemporalToMoment(t).valueOfNano(),"in"===r?(i=[],_.each(e.toString().split(","),function(t){i.push(Tools.convertDateStringValueToMoment(t).valueOfNano()),p=i.toString()})):p=Tools.convertDateStringValueToMoment(e).valueOfNano()),r){case"contains":a=0<=s.toString().indexOf(p.toString());break;case"starts with":a=0===s.toString().indexOf(p.toString());break;case"ends with":a=-1!==s.toString().indexOf(p.toString(),s.toString().length-p.toString().length);break;case"==":a=s===p;break;case"<":a=s<p;break;case">":a=p<s;break;case"<=":a=s<=p;break;case">=":a=p<=s;break;case"!=":a=s!==p;break;case"in":a=0<=p.toString().split(",").indexOf(s.toString());break;case"search":a=n.isMatch(p,s);break;case"regexp":a=new RegExp(e.toString()).test(t?t.toString():"")}return a},h.isDuration=function(t){return _.get(t,"_kdbType")&&0<=["1216","1217","1218","1219"].indexOf(t._kdbType)},h.getFormatter=function(o,i,n,a){return"Number"===o||"Formatted Number"===o||"Smart Number"===o||"Datetime"===o||"Currency"===o||"SmartCurrency"===o?function(t){var e,r=t;if(null==(t="Smart Number"!==o&&"Formatted Number"!==o||_.isNumber(t)?t:_.isNumber(parseFloat(t))?parseFloat(t):t))return"";if("Smart Number"===o)r=_.isNumber(t)?Tools.smartFormatNumber(t,i):_.escape(t);else{if("Datetime"===o)return e=t,(moment.isMoment(t)||moment.isDuration(t)?h.isDuration(t)?Tools.convertValueToMoment(t.valueOf()):t:Tools.isKDBTemporal(t)?Tools.convertKDBTemporalToMoment(t):("number"==typeof t&&(e=new Date(t)),Tools.convertDateStringValueToMoment(e.toString()))).format(a);r="Formatted Number"===o&&t.toFixed?_.isNaN(t)?"":Tools.formatNumber(t,i):t.toFixed?t.toFixed(i):_.escape(r)}if(n&&0<=r.toString().indexOf(".")){for(;"0"===r[r.length-1];)r=r.slice(0,-1);"."===r[r.length-1]&&(r=r.slice(0,-1))}return r}:"Boolean"===o?function(t){return _.escape(t)}:function(t){return moment.isMoment(t)||moment.isDuration(t)?t.format(a,void 0):_.escape(t)}},h.pump=function(r){var t,o,i;return null==r||!_.isObject(r)||(t=Object.getPrototypeOf(r),_.isObject(r)&&t!==Object.prototype&&t!==Array.prototype)?r:t===Array.prototype&&_.isArray(r)?r.map(h.pump):(o=/^(\d+)((?:\.\w+)+)$/,Object.keys(r).every(function(t){return o.test(t)})?Object.keys(r).map(function(t){var e=o.exec(t);return _.isNil(e)?{index:0,tail:void 0,value:void 0}:{index:Number(e[1]),tail:e[2].substring(1),value:r[t]}}).reduce(function(t,e){var r={},o=void 0===e.index?0:e.index;return r[o]={},r[o][e.tail]=e.value,_.merge(t,h.pump(r))},[]):(i={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/},Object.keys(r).some(function(t){return i.nonGreedy.test(t)})?Object.keys(r).map(function(t){var e=i.greedy.exec(t);return{head:_.isNil(e)?null:e[1],tail:_.isNil(e)||""===e[2]?null:e[2].substring(1),value:r[t]}}).reduce(function(t,e){var r={},o=null!==e.tail,i=_.isNil(e.head)?0:e.head,n=_.isNil(e.tail)?0:e.tail;return o?(r[i]={},r[i][n]=e.value):r[i]=e.value,_.merge(t,h.pump(r))},{}):_.mapValues(r,h.pump)))},h.replaceViewStatesWithValue=function(t,e,r){return h.replaceViewStates(t,e,function(t,e,r,o){return o.value!==r&&console.warn("viewModel value has changed"),o.value},r)},h.replaceViewStatesWithModel=function(t,e,o){return h.replaceViewStates(t,e,function(t,e,r){return r instanceof i.Model&&r.get("_viewType")?r:((t=o.getProperty(t)[e]).get("value")!==r&&t.set("value",r),t)},o)},h.alpha=function(t,e){var r=this.hex2RGB(t);return r?"rgba(".concat(r[0],",").concat(r[1],",").concat(r[2],",").concat(e/100,")"):new Color(t).alpha(e/100).rgbaString()},h.colorFactory=function(t,e,r){void 0===e&&(e="#0061FF"),void 0===r&&(r=80);var o={};return o[t+"Color"]={title:t.replace("Point","").replace("Hover","Hover ").replace("Border","Border ").replace("Background","Background ")+"Color",type:"gradient",default:e,options:{gradient:!1}},o[t+"Opacity"]={title:t.replace("Point","").replace("Hover","Hover ").replace("Border","Border ").replace("Background","Background ")+"Opacity",default:r,minimum:0,maximum:100,type:"number",step:1,format:"range"},o},h.backgroundFactory=function(t){return h.colorFactory(t+"Background")},h.borderFactory=function(t){var e={};return e[t+"BorderWidth"]={title:t.replace("Point","").replace("Hover","Hover ")+" Border Width",type:"number",format:"range",default:2.01,minimum:.01,maximum:10.01},_.merge(h.colorFactory(t+"Border"),e)},h.radiusFactory=function(t){var e={};return e[t+"Radius"]={title:t.replace("Point","").replace("Hover","Hover ").replace("Hit","Hit ")+"Radius",type:"number",format:"range",default:0,minimum:0,maximum:10},e},h.typeFactory=function(t){return{_Type:{type:"string",default:t,options:{hidden:!0}}}},h.replaceViewStates=function(r,t,p,l){var c;return c=function(t,e){return function r(t,e,o){o=o?o+".":"";var i,n,a=l.getPropertyMeta(o+(e+="")),s=t&&t.has&&t.has("_dataSource")&&t.has("_dataType"),s=(_.isArray(t)||_.isObject(t))&&!s;return a&&"data"===a.type?t:a&&"viewstate"===a.type?(i=(n=(o+e).split(".")).pop(),n=n.join("."),p(n,void 0===i?"":i,t,a)):s?(o+=e,c=function(t,e){return r(t,e,o)},(_.isArray(t)?_.map:_.mapValues)(t,c)):t}(t,e,r||"")},(_.isArray(t)?_.map:_.mapValues)(t,c)};var f=h;function h(){}var g;e.Tools;function m(t){var e=g.call(this,t)||this;return e.themeClass="",e.markerGroup={},e.map={},e.pointLayer={},e.ignoreOnSettingsChange=!1,e.layerGroup={},e.vectors={},e.EPSGCODE={"WGS 84":"EPSG:4326",Mercator:"EPSG:3857"},e.sampleURL="https://sampleservices.luciad.com/ogc/wmts/sampleswmts?SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile&LAYER=92c09725-a9c5-46fb-bffd-d9e23b4abbf2&STYLE=default&FORMAT=image/png&TILEMATRIXSET=WorldCRS84Quad&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",e.resolutions=[.703125,.3515625,.17578125,.087890625,.0439453125,.02197265625,.010986328125,.0054931640625,.00274658203125,.001373291015625,.0006866455078125,.00034332275390625],e.key=_.uniqueId("QuadMap_"),e.api=t.api,e.viewModel=new i.DeepModel,e.el.className+=" QuadMaps",e.el.innerHTML=a.app({key:e.key}),e.tooltip=e.el.getElementsByClassName("ol-info")[0],e.path=e.extractOfflineMapPath(t.dashboardAppModel),e.baseURL="".concat(location.origin).concat(location.pathname.replace("/edit",""),"/modules/").concat(e.path,"/"),e.loadMap(),e.hideErrorMessage=t.api.hideErrorMessage,e.showErrorMessage=t.api.showErrorMessage,e}return g=i.View,r(m,g),m.prototype.extractOfflineMapPath=function(t){t=_.filter(t.get("paths"),function(t){return"QuadMap"===t.key});return _.get(t,"0.value","QuadMap")},m.prototype.loadMap=function(){var t=this,e=document.createElement("script");e.onload=function(){t.loadMapInstance(),t.setLayerGroup(),t.renderLayers(),t.hideErrorMessage()},e.src=this.baseURL+"lib/ol.js",document.head.appendChild(e)},m.prototype.loadMapInstance=function(){var e=this,t=this.api.getProperty("Basics.CenterLat"),r=this.api.getProperty("Basics.CenterLng"),o=this.api.getProperty("Basics.Zoom");this.map=new ol.Map({target:this.key,layers:[],view:new ol.View({center:[parseFloat(t),parseFloat(r)],zoom:parseFloat(o)})}),this.map.on("moveend",function(){e.mapReposition()}),this.map.on("pointermove",function(t){e.pointHover(t)}),this.map.on("click",function(t){e.pointClick(t)}),this.map.getTargetElement().addEventListener("pointerleave",function(){e.tooltip.style.visibility="hidden"})},m.prototype.mapReposition=function(){var t=this.map.getView(),e=t.getZoom(),t=t.getCenter(),r=t[0],t=t[1],o=parseFloat(this.api.getProperty("Basics.Zoom")),i=parseFloat(this.api.getProperty("Basics.CenterLat")),n=parseFloat(this.api.getProperty("Basics.CenterLng"));e!==o&&this.api.setProperty("Basics.Zoom",e),r!==i&&this.api.setProperty("Basics.CenterLat",r),t!==n&&this.api.setProperty("Basics.CenterLng",t)},m.prototype.pointClick=function(t){var r=this;this.map.forEachFeatureAtPixel(t.pixel,function(t){var e=t.getProperties().Layer,t=t.getId();r.pointLayer.clickEvent(e,t),r.pointLayer.getActions("Click",e,t)})},m.prototype.pointHover=function(o){var i=this;this.map.forEachFeatureAtPixel(o.pixel,function(t){var e,t=i.extractFeatureInfo(t),r=t.layerIndex,t=t.pointId;return null!=r&&null!=t&&((e=i.pointLayer.getTooltip(r,t))?i.updateTooltip(o.pixel,e):i.hideTooltip(),i.pointLayer.getActions("Hover",r,t),!0)})||this.hideTooltip()},m.prototype.updateTooltip=function(t,e){this.tooltip.style.left=t[0]+"px",this.tooltip.style.top=t[1]+"px",this.tooltip.style.visibility="visible",this.tooltip.innerText=e},m.prototype.hideTooltip=function(){this.tooltip.style.visibility="hidden"},m.prototype.extractFeatureInfo=function(t){var e;return t.get("features")?1===t.get("features").length?{layerIndex:(e=t.get("features")[0]).get("Layer"),pointId:e.getId()}:{layeIndex:null,pointId:null}:{layerIndex:t.get("Layer"),pointId:t.getId()}},m.prototype.setLayerGroup=function(){var t=this.getBaseLayer();this.markerGroup=new ol.layer.Group({layers:[t],name:"markerGroup"}),this.map.addLayer(this.markerGroup)},m.prototype.addLayer=function(t,e){var r=this.markerGroup.getLayers().getArray().find(function(t){return t.get("name")===e});r?(r.setSource(t.getSource()),t.style_&&r.setStyle(t.style_),r.changed()):(t.set("name",e),this.markerGroup.getLayers().push(t)),this.fitMapToVectorGroupExtent()},m.prototype.fitMapToVectorGroupExtent=function(){var o;this.api.getProperty("Basics.FitToData")&&(o=ol.extent.createEmpty(),this.markerGroup.getLayers().forEach(function(t){var e,r,t=t.getSource();t&&(t.getFeatures?0<(r=t.getFeatures()).length&&(e=ol.extent.createEmpty(),r.forEach(function(t){t.getGeometry()&&ol.extent.extend(e,t.getGeometry().getExtent())}),ol.extent.extend(o,e)):t.getExtent&&(r=t.getExtent())&&!ol.extent.isEmpty(r)&&ol.extent.extend(o,r))}),ol.extent.isEmpty(o)||this.map.getView().fit(o,{maxZoom:16,duration:500,padding:[20,20,20,20]}))},m.prototype.getBaseLayer=function(){var t=this.resolutions.map(function(t,e){return e.toString()}),e=this.resolutions,r=[-180,90],o=this.api.getProperty("Basics.Projection"),i=this.api.getProperty("Basics.MapGeneration"),n=this.api.getProperty("WTMS.URL"),a=this.api.getProperty("WTMS.WrapX");if("Mercator"===o)for(var t=[],e=[],s=ol.proj.get("EPSG:3857"),p=ol.extent.getWidth(s.getExtent())/256,l=0;l<20;l++)t[l]=l.toString(),e[l]=p/Math.pow(2,l),r=[-20037508,20037508];return new ol.layer.Tile({source:new ol.source.WMTS({attributions:this.key,url:n||this.sampleURL,layer:"BaseLayer"+i,format:"image/png",projection:this.EPSGCODE[o],matrixSet:"PM",name:"baseLayer",id:"baseLayer",tileGrid:new ol.tilegrid.WMTS({origin:r,resolutions:e,matrixIds:t}),style:"default",wrapX:a})})},m.prototype.renderLayers=function(){var e=this;this.pointLayer=new d({map:this.map,api:this.api,path:this.path,baseURL:this.baseURL,el:this.el,app:this}),this.pointLayer.renderMapPoints(),this.listenTo(this.viewModel,"change:Points",function(t){e.onViewModelChanged(e.flattenObj(t.changed,void 0))})},m.prototype.flattenObj=function(r,o){var i=this,n={},a=["SelectedZoomedItems","SelectedItem","DataSource"];return Object.keys(r).forEach(function(t){var e=o?"".concat(o,".").concat(t):t;"object"!=typeof r[t]||0<=a.indexOf(t)?n[e]=r[t]:n=s(s({},n),i.flattenObj(r[t],e))}),n},m.prototype.onSettingsChange=function(t){var e=f.expandNestedViewStates(t,this.api),e=f.replaceViewStatesWithValue("",e,this.api),e=f.pump(e);this.onSettingsChangeProcessed.call(this,e,t)},m.prototype.onSettingsChangeProcessed=function(t,e){this.viewModel.set(e),this.ignoreOnSettingsChange&&(this.ignoreOnSettingsChange=!1)},m.prototype.onViewModelChanged=function(t){var r=this,o=[/(Points.)(\d+)(.Cluster)/,/(Points.)(\d+)(.DataSource)/,/(Points.)(\d+)(.ID)/,/(Points.)(\d+)(.Latitude)/,/(Points.)(\d+)(.Longitude)/,/(Points.)(\d+)(.Altitude)/,/(Points.)(\d+)(.UseLabel)/,/(Points.)(\d+)(.Label)/,/(Points.)(\d+)(.LabelSize)/,/(Points.)(\d+)(.Tooltip)/],i=[/(WTMS.)(\d+)(.URL)/,/(WTMS.)(\d+)(.WrapX)/],n=!1;_.each(t,function(t,e){_.each(o,function(t){t=e.match(t);t&&_.get(t,2)&&(n=!0)}),_.each(i,function(t){t=e.match(t);t&&_.get(t,2)&&r.addLayer(r.getBaseLayer(),"BaseLayer")})}),n&&this.pointLayer.renderPoints()},m.getComponentDefinition=l.getComponentDefinition,m});
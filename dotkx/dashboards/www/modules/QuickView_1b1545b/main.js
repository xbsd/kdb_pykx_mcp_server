define(["backbone","Forms","Handlebars","dashMoment","QuickBase","css!./css/main.css"],function(h,i,e,n,c){s.FailedLoginsNotification=e.template({1:function(e,t,i,n,o){var s,a=null!=t?t:e.nullContext||{},l=e.hooks.helperMissing,r="function",c=e.escapeExpression,d=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <div class="status-'+c(typeof(s=null!=(s=d(i,"status")||(null!=t?d(t,"status"):t))?s:l)==r?s.call(a,{name:"status",hash:{},data:o,loc:{start:{line:2,column:23},end:{line:2,column:33}}}):s)+'">\n        <span>'+c(typeof(s=null!=(s=d(i,"time")||(null!=t?d(t,"time"):t))?s:l)==r?s.call(a,{name:"time",hash:{},data:o,loc:{start:{line:3,column:14},end:{line:3,column:22}}}):s)+'</span>\n        <span class="info">from:</span>\n        <span>'+c(typeof(s=null!=(s=d(i,"machineID")||(null!=t?d(t,"machineID"):t))?s:l)==r?s.call(a,{name:"machineID",hash:{},data:o,loc:{start:{line:5,column:14},end:{line:5,column:27}}}):s)+"</span>\n"+(null!=(e=d(i,"if").call(a,null!=t?d(t,"status"):t,{name:"if",hash:{},fn:e.program(2,o,0),inverse:e.noop,data:o,loc:{start:{line:6,column:8},end:{line:9,column:15}}}))?e:"")+'        <span class="info">url:</span>\n        <span>'+c(typeof(s=null!=(s=d(i,"url")||(null!=t?d(t,"url"):t))?s:l)==r?s.call(a,{name:"url",hash:{},data:o,loc:{start:{line:11,column:14},end:{line:11,column:21}}}):s)+"</span>\n    </div>\n"},2:function(e,t,i,n,o){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'        <span class="info">status:</span>\n        <span>'+e.escapeExpression("function"==typeof(i=null!=(i=s(i,"status")||(null!=t?s(t,"status"):t))?i:e.hooks.helperMissing)?i.call(null!=t?t:e.nullContext||{},{name:"status",hash:{},data:o,loc:{start:{line:8,column:14},end:{line:8,column:24}}}):i)+"</span>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return null!=(i=s(i,"each").call(null!=t?t:e.nullContext||{},null!=t?s(t,"rows"):t,{name:"each",hash:{},fn:e.program(1,o,0),inverse:e.noop,data:o,loc:{start:{line:1,column:0},end:{line:13,column:9}}}))?i:""},useData:!0}),s.LoadingScreen=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="loading" style="display: table; width: 100%; height: 100%; opacity: 0.9; pointer-events: none;">\n    <div style="display: table-cell; width: 100%; height: 100%; vertical-align: middle; text-align: center;">\n        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64" fill="#D2D2D2">\n            <circle cx="16" cy="3" r="0">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n            <circle transform="rotate(45 16 16)" cx="16" cy="3" r="0">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.125s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n            <circle transform="rotate(90 16 16)" cx="16" cy="3" r="0">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.25s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n            <circle transform="rotate(135 16 16)" cx="16" cy="3" r="0.567031">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.375s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n            <circle transform="rotate(180 16 16)" cx="16" cy="3" r="1.82452">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.5s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n            <circle transform="rotate(225 16 16)" cx="16" cy="3" r="2.88475">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.625s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n            <circle transform="rotate(270 16 16)" cx="16" cy="3" r="2.1029">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.75s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n            <circle transform="rotate(315 16 16)" cx="16" cy="3" r="0.60761">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.875s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n            <circle transform="rotate(180 16 16)" cx="16" cy="3" r="1.82452">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.5s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" ></animate>\n            </circle>\n        </svg>\n        <div style="color: #D2D2D2; font-weight: bold; margin-top: 7px; font-size: 11px; letter-spacing: 1px;">\n            '+e.escapeExpression("function"==typeof(i=null!=(i=s(i,"text")||(null!=t?s(t,"text"):t))?i:e.hooks.helperMissing)?i.call(null!=t?t:e.nullContext||{},{name:"text",hash:{},data:o,loc:{start:{line:33,column:12},end:{line:33,column:20}}}):i)+"\n        </div>\n    </div>\n</div>"},useData:!0}),s.LoginHistoryDialog=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){return'<div class="grid-div">\n</div>'},useData:!0}),s.MainToolbar=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s,a=null!=t?t:e.nullContext||{},l=e.hooks.helperMissing,r=e.escapeExpression,c="function",e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="main-toolbar hideMainMenu">\n    <div class="logo"></div>\n\n    <div class="dash-main-menu">\n        <button class="main-menu-btn ui-button ui-corner-all ui-widget ui-button-icon-only" aria-label="Main Menu">\n            <span class="ui-button-icon ui-icon fa fa-bars"></span> \n        </button>\n    </div>\n\n    <div class="document-selector" style="display: inline-block;"></div>\n\n    <div class="main">\n        <a class="refresh-dash" style="display: inline-block;" tabindex="0">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Refresh Dashboard",{name:"t",hash:{},data:o,loc:{start:{line:13,column:76},end:{line:13,column:101}}}))+'</a>\n        <label class="customise-dash" for="'+r(typeof(s=null!=(s=e(i,"guid")||(null!=t?e(t,"guid"):t))?s:l)==c?s.call(a,{name:"guid",hash:{},data:o,loc:{start:{line:14,column:43},end:{line:14,column:51}}}):s)+'_customise">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Customise Dashboard",{name:"t",hash:{},data:o,loc:{start:{line:14,column:63},end:{line:14,column:90}}}))+'</label>\n        <input id="'+r(typeof(s=null!=(s=e(i,"guid")||(null!=t?e(t,"guid"):t))?s:l)==c?s.call(a,{name:"guid",hash:{},data:o,loc:{start:{line:15,column:19},end:{line:15,column:27}}}):s)+'_customise" type="checkbox" class="ui-helper-hidden-accessible" tabindex="-1" />\n        <a class="save-dash" style="display: inline-block;" tabindex="0">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Save View State",{name:"t",hash:{},data:o,loc:{start:{line:16,column:73},end:{line:16,column:96}}}))+'</a>\n        <a class="default-dash" style="display: inline-block;" tabindex="0">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Reset View State",{name:"t",hash:{},data:o,loc:{start:{line:17,column:76},end:{line:17,column:100}}}))+'</a>\n        <a class="share-dash" style="display: none;" tabindex="0">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Share Dashboard",{name:"t",hash:{},data:o,loc:{start:{line:18,column:66},end:{line:18,column:89}}}))+'</a>\n        <a class="create-pdf" style="display: inline-block" tabindex="0">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Create Pdf",{name:"t",hash:{},data:o,loc:{start:{line:19,column:73},end:{line:19,column:91}}}))+'</a>\n    </div>\n\n    <div class="connectionStatus"></div>\n\n    <div class="profile">\n        <button tabindex="0">\n            <i class="fa fa-fw fa-user"></i>\n            <span class="user-name-wrap">\n                <span class="user-name"></span>\n            </span>\n        </button>\n\n        <div class="profile-menu"></div>\n    </div>\n</div>\n'},useData:!0}),s.Notificator=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){return'<div class="panel ui-widget-content">\n    <div class="title"></div>\n    <div class="items"></div>\n    <button class="close-button">\n        Close\n    </button>\n</div>'},useData:!0}),s.ShareDashDialog=e.template({1:function(e,t,i,n,o){return"checked"},compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s,a=null!=t?t:e.nullContext||{},l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div>\n    <input class="share-dash-url" value="'+e.escapeExpression("function"==typeof(s=null!=(s=l(i,"url")||(null!=t?l(t,"url"):t))?s:e.hooks.helperMissing)?s.call(a,{name:"url",hash:{},data:o,loc:{start:{line:2,column:41},end:{line:2,column:48}}}):s)+'" readonly >\n</div>\n<div class="share-meta">\n    <label class="share-shorten">Shorten <input class="share-shorten-checkbox" type="checkbox"\n            '+(null!=(s=l(i,"if").call(a,null!=t?l(t,"shortenUrl"):t,{name:"if",hash:{},fn:e.program(1,o,0),inverse:e.noop,data:o,loc:{start:{line:6,column:12},end:{line:6,column:44}}}))?s:"")+' ></label>\n    <span class="share-info"><i class="fa share-info-icon"></i> <span class="share-info-text"></span></span>\n</div>'},useData:!0}),s.app=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){return'<div class="toolbar-div">\n</div>\n\n<div class="document-view-div">\n</div>\n\n<div class="dialog-panel">\n    <div class="document" ></div>\n    <div class="environment" ></div>\n</div>\n<div class="notifications-div">\n\n</div>'},useData:!0});var o=s;function s(){}var a=h.Model.extend({defaults:{api:null,components:null,deltaClient:null,documents:null,language:"en",publisherUrl:null,smartDrop:!0,websiteUrl:null,userName:null,paths:null,propertiesPinned:!0,isHelpDialogTabbed:!0,hasPermission:function(){return!0},dashEngine:null},initialize:function(e){var t,i=[];for(t in e.versions)e.versions.hasOwnProperty(t)&&i.push({key:t,value:e.versions[t]});this.set({api:e.api,components:new c.ComponentDefinitionCollection,documents:e.documents,PackageName:e.PackageName,paths:_.sortBy(i,"key"),publisherUrl:e.publisherUrl,websiteUrl:e.websiteUrl})}}),l=h;function r(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function d(e,t){var i;if(null!=e)return"function"==typeof(i=e[t])?e[t]():i}l.LocalStorage=window.Store=function(e,t){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=e,this.serializer=t||{serialize:function(e){return e===Object(e)?JSON.stringify(e):e},deserialize:function(e){return e&&JSON.parse(e)}};e=this.localStorage().getItem(this.name);this.records=e&&e.split(",")||[]};var u,m=l.LocalStorage.prototype,g={save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return e.id||0===e.id||(e.id=r()+r()+"-"+r()+"-"+r()+"-"+r()+"-"+r()+r()+r(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this._itemName(e.id),this.serializer.serialize(e)),this.records.push(e.id.toString()),this.save(),this.find(e)},update:function(e){this.localStorage().setItem(this._itemName(e.id),this.serializer.serialize(e));var t=e.id.toString();return function(e,t){for(var i=e.length;i--;)if(e[i]===t)return 1}(this.records,t)||(this.records.push(t),this.save()),e.attributes},find:function(e){return this.serializer.deserialize(this.localStorage().getItem(this._itemName(e.id)))},findAll:function(){for(var e,t=[],i=0;i<this.records.length;i++)e=this.records[i],null!=(e=this.serializer.deserialize(this.localStorage().getItem(this._itemName(e))))&&t.push(e);return t},destroy:function(e){this.localStorage().removeItem(this._itemName(e.id));for(var t=e.id.toString(),i=0;i<this.records.length;i++)this.records[i]===t&&this.records.splice(i,1);return this.save(),e},localStorage:function(){return localStorage},_clear:function(){var e,t=this.localStorage(),i=new RegExp("^"+this.name+"-");for(e in t.removeItem(this.name),t)i.test(e)&&t.removeItem(e);this.records.length=0},_storageSize:function(){return this.localStorage().length},_itemName:function(e){return this.name+"-"+e}};for(u in g)m[u]=g[u];l.LocalStorage.sync=window.Store.sync=l.localSync=function(e,t,i){var n,o,s=d(t,"localStorage")||d(t.collection,"localStorage"),a=l.$?l.$.Deferred&&l.$.Deferred():l.Deferred&&l.Deferred();try{switch(e){case"read":n=null!=t.id?s.find(t):s.findAll();break;case"create":n=s.create(t);break;case"update":n=s.update(t);break;case"delete":n=s.destroy(t)}}catch(e){o=22===e.code&&0===s._storageSize()?"Private browsing is unsupported":e.message}return n?(i&&i.success&&("0.9.10"===l.VERSION?i.success(t,n,i):i.success(n)),a&&a.resolve(n)):(o=o||"Record Not Found",i&&i.error&&("0.9.10"===l.VERSION?i.error(t,o,i):i.error(o)),a&&a.reject(o)),i&&i.complete&&i.complete(n),a&&a.promise()},l.ajaxSync=l.sync,l.getSyncMethod=function(e,t){return t&&t.ajaxSync||!d(e,"localStorage")&&!d(e.collection,"localStorage")?l.ajaxSync:l.localSync},l.sync=function(e,t,i){return l.getSyncMethod(t,i).apply(this,[e,t,i])},l.LocalStorage;var p,f,v,w,D=h.View.extend({className:"quick-dash loadingScreen",loadText:null,initialize:function(e){this.loadText=e.loadingText,this.render()},render:function(){return this.$el.html(o.LoadingScreen({text:this.loadText})),this.$el.hide(),this.$el.fadeIn(),this}}),S=h.View.extend({$dialog:null,close:function(){this.$dialog.dialog("close")},dataGridStuff:(p=["pk","time","machineID","status","url"],f=[11,15,11,11,11],v=["pk","Time","Machine Id","Status","Url"],{generateDatagridConfig:function(e){return this.Datagrid=e,(e=new c.DocumentDataModel({_subscriptionKey:"pk",_dataType:"copy",_maxRows:1e6})).apply(),e.onExecuteSuccess(this.getResponse(),!0),new h.Model({data:e,columnsConfig:this.getColumnsConfiguration(),datagridConfig:this.datagridConfiguration(),sortColumns:this.sortColumns})},datagridConfiguration:function(){return{Selection:{Mode:"Multi Row"}}},columnsConfiguration:function(){var i;return MAP={1:"Boolean",14:"Date",15:"DateTime",19:"Time"},i=function(e){return MAP[e]||"General"},_.map(p,function(e,t){return{Field:e,DisplayName:v[t],Sortable:!0,Hidden:_.includes(w,p[t]),Format:i(f[t])}})},getResponse:function(e){return{rows:e||[],columns:p,meta:_.zipObject(p,f)}},getColumnsConfiguration:function(){var e=this.columnsConfiguration(),t=this;return _.map(e,function(e){return _.extend({},t.Datagrid.getColumnSettingsModel(),{DisplayName:e.Field,TextAlign:"left",IsReadonly:!0,MinWidthAbsolute:100},e)})},sortColumns:[{sortCol:"time",sortAsc:!(w=["pk"])}]}),getLoginHistory:function(){var t=this;c.DeltaClientLib.getAPIQueryData("kdb",void 0,".session.getLoginsUI",[{IsKdbParam:!0,i:0,index:0,name:"clientType",type:"symbol"}],function(e){t.dgSourceModel.onExecuteSuccess(t.dataGridStuff.getResponse(_.map(e.rows,function(e){return _.extend({pk:_.uniqueId()},_.pick(e,"machineID","status","time","url"))})),!0),t.hideLoadingScreen(),t.onResize()},function(e){console.log("getLoginHistory session get logins error",e)},100,!1)},hideLoadingScreen:function(){this.$loadingScreen&&(this.$loadingScreen.fadeOut(function(){$(this).remove()}),this.$loadingScreen=null)},initialize:function(e){var i=this;i.$el.html(o.LoginHistoryDialog()),i.showLoadingScreen(),i.initializeDataGrid(),this.$dialog=this.$el.dialog(_.extend({classes:{"ui-dialog":"quick-base login-history-dialog"},title:t("Login History"),resizable:!0,height:302,width:552,modal:!0,autoOpen:!0,draggable:!0,buttons:[{text:t("OK"),click:$.proxy(i.close,i),icon:"fa fa-check"}],open:function(){$('<i class="fa fa-history"></i>').insertBefore(i.$el.parent().find(".ui-dialog-title"))},close:function(){_.isFunction(e.onClose)&&e.onClose(),i.remove()},resize:$.proxy(this.onResize,this)},e))},initializeDataGrid:function(e){var i=this;require(["Datagrid"],function(e){var t=i.dataGridStuff.generateDatagridConfig(e);i.dgSourceModel=t.get("data"),i.dgSource=new e.Master({el:i.$(".grid-div"),model:t}),i.getLoginHistory()})},onResize:function(){this.dgSource&&this.dgSource.onResize()},remove:function(){this.dgSource.off(),this.dgSource.remove(),h.View.prototype.remove.apply(this)},showLoadingScreen:function(e){e=new D({loadingText:e});e.$el.appendTo(this.$el),this.$loadingScreen=e.$el}}),b=h.View.extend({ICONS:{error:"fa-times",loading:"fa-spinner fa-pulse",success:"fa-check"},$closeButton:null,$dialog:null,appModel:null,className:"quick-view window share-dash-dialog",closeArgs:null,viewModel:null,events:{"change .share-shorten-checkbox":"onToggleShorten","click .share-dash-url":"onClickUrl"},initialize:function(e){this.options=e,this.container=e.container,this.shortenUrl=e.shortenUrl,this.url=e.url,this.render()},onClickClose:function(){this.$dialog.dialog("close")},onClickCopy:function(){this.$urlInput.select();try{document.execCommand("copy")?this.showInfo("Link copied","success"):this.showInfo("Error: link not copied","error")}catch(e){this.showInfo("Error: link not copied ("+e.toString()+")","error")}},onClickPreview:function(){window.open(this.shortenUrl?this.shortUrl:this.url,"_blank","noopener,noreferrer,resizable")},onClickUrl:function(){this.$urlInput.select()},onToggleShorten:function(){function t(e){i.shortUrl=e[1],i.$urlInput.val(i.shortUrl),i.showInfo(null,"none")}function e(e){i.shortUrl=null,i.$urlInput.val(i.url),i.showInfo(e.toString(),"error"),i.shortenUrl=!1,i.$shareShortenCheckbox.prop("checked",!1),i.trigger("shortenUrlSetting",!1)}var i=this,n=window.location.protocol+"//"+window.location.host+"/",o=this.$shareShortenCheckbox.prop("checked");o?this.shortUrl?this.$urlInput.val(this.shortUrl):(i.showInfo("Shortening","loading"),this.options.isLite?c.DashClient.runAPI(".api.shortenUrl","gw",[{type:"string",value:this.url.substring(n.length)}],function(e){t([0,n+e.rows[0].symbol])},e):c.DeltaClientLib.deltaClient.request("UrlAPI.getShortUrl",t,e,this.url)):this.$urlInput.val(this.url),this.shortenUrl=o,this.trigger("shortenUrlSetting",o)},render:function(){var e,t=this;this.$el.html(o.ShareDashDialog({shortenUrl:this.shortenUrl,url:this.url})),this.$shareInfoIcon=this.$el.find(".share-info-icon"),this.$shareInfoText=this.$el.find(".share-info-text"),this.$urlInput=this.$el.find("input.share-dash-url"),this.$shareShortenCheckbox=this.$el.find("input.share-shorten-checkbox"),e=[{text:"Copy Link",icon:"fa fa-clipboard",click:_.bind(this.onClickCopy,this)},{text:"Preview",icon:"fa fa-external-link",click:_.bind(this.onClickPreview,this)},{text:"Close",icon:"fa fa-times",click:_.bind(this.onClickClose,this)}],this.$dialog=this.$el.dialog(_.extend({appendTo:this.container,title:"Share Dashboard",resizable:!1,width:500,modal:!0,autoOpen:!0,draggable:!0,buttons:e,open:function(){$('<i class="fa fa-share-alt"></i>').insertBefore(t.$el.parent().find(".ui-dialog-title"))},close:function(){t.remove()}},this.options)),this.onToggleShorten()},showInfo:function(e,t){var i=this;"none"===t?this.$el.removeClass("show-info"):(this.$el.addClass("show-info"),_.delay(function(){i.$el.removeClass("show-info")},3e3),icon=this.ICONS[t],this.$shareInfoIcon.removeClass(function(e,t){return(t.match(/\bfa-\S+/g)||[]).join(" ")}).addClass(icon),this.$shareInfoText.text(e))}}),C=h.View.extend({AUTOSAVE_THROTTLE:5e3,$saveDash:null,initialize:function(e){var t=this,i=this,n=(this.appModel=e.appModel,this.dialogContainer=e.dialogContainer,this.themes=e.themes,this.viewModel=e.viewModel,this.currentDocViewModel=null,this.$el.html(o.MainToolbar({guid:_.uniqueId("toolbar_")})),this.mainMenuButton=this.el.querySelectorAll(".main-menu-btn")[0],this.initMainMenu(),this.documentSelector=new c.DocumentSelector({el:this.$el.find(".document-selector"),appModel:this.appModel,viewModel:this.viewModel}),this.listenTo(this.viewModel,"change:selectedDocumentId",this.onSelectedDocumentIdChanged),this.$refreshDash=this.$el.find(".refresh-dash"),this.$refreshDash.button({icon:"fa fa-refresh",text:!1,showLabel:!1}).click($.proxy(this.onRefreshDash,this)),this.$refreshDash.keyup(function(e){" "!==e.key&&"Enter"!==e.key||t.$refreshDash.click()}),this.$customiseDash=this.$el.find(".customise-dash"),this.$customiseDash.button({icon:"fa fa-cog",text:!1,showLabel:!1}).click($.proxy(this.onCustomiseDash,this)),this.$customiseDash.button("widget").attr("tabindex","0").keyup(function(e){" "!==e.key&&"Enter"!==e.key||t.$customiseDash.click()}),this.onUserConfigurableChange(),this.listenTo(this.viewModel,"change:userConfigurable",this.onUserConfigurableChange),this.$saveDash=this.$el.find(".save-dash"),this.$saveDash.button({icon:"fa fa-floppy-o",text:!1,showLabel:!1}).click($.proxy(this.onSaveDash,this)),this.$saveDash.keyup(function(e){" "!==e.key&&"Enter"!==e.key||t.$saveDash.click()}),$("<span></span>").addClass("save-pending ui-icon fa fa-asterisk").appendTo(this.$saveDash),$("<span></span>").addClass("save-in-progress ui-icon fa fa-spinner fa-pulse").appendTo(this.$saveDash),this.listenTo(this.viewModel,"widgets-configured",this.onWidgetsConfigured),this.throttledAutoSaveDash=_.throttle(this.onSaveDash.bind(this),this.AUTOSAVE_THROTTLE),this.$revertDash=this.$el.find(".default-dash"),this.$revertDash.button({icon:"fa fa-undo",text:!1,showLabel:!1}).click($.proxy(this.onRevertDash,this)),this.$revertDash.keyup(function(e){" "!==e.key&&"Enter"!==e.key||t.$revertDash.click()}),this.$shareDash=this.$el.find(".share-dash"),this.$shareDash.button({icon:"fa fa-share-alt",text:!1,showLabel:!1}).click($.proxy(this.onShareDash,this)),this.$shareDash.keyup(function(e){" "!==e.key&&"Enter"!==e.key||t.$shareDash.click()}),this.$createPdf=this.$el.find(".create-pdf"),this.$createPdf.button({icon:"fa fa-file-pdf-o",text:!1,showLabel:!1}).click($.proxy(this.onCreatePdf,this)),this.$createPdf.keyup(function(e){" "!==e.key&&"Enter"!==e.key||t.$createPdf.click()}),this.appModel.get("isLite")&&this.appModel.get("PdfUrl")||this.$createPdf.hide(),$(c.DeltaClientLib).on("DeltaClientConnect",function(){"true"===c.DeltaClientLib.getDashboardProperty("pdf_enabled")&&i.$createPdf.show()}),this.$profileButton=this.$el.find(".profile > button"),this.$profileMenu=this.$el.find(".profile > .profile-menu"),this.$profileButton=this.$el.find(".profile > button").button({text:!0}).click(function(){return i.$profileMenu.toggle(),i.$profileMenu.css("position","absolute"),i.$profileMenu.position({my:"right top",at:"right bottom",of:this}),$(document).one("click",function(){i.$profileMenu.hide()}),!1}),this.appModel.get("isLite")?this.initProfileMenu():$(c.DeltaClientLib).one("DeltaClientLogin",$.proxy(this.initProfileMenu,this)),this.listenTo(this.appModel,"change:userName",function(e,t){i.$el.find(".user-name").text(t)}),function(){$(c.DeltaClientLib).one("DeltaClientDisconnect",function(){i.changeConnectionStatus(!1),$(c.DeltaClientLib).one("DeltaClientConnect",function(){i.changeConnectionStatus(!0),n()})})});n()},changeConnectionStatus:function(e){var t=this;e?(t.$el.find(".connectionStatus").html('<span class="fa fa-info-circle"></span>Delta Client has reconnected'),t.$el.find(".connectionStatus").css({color:"#03B103",display:"inline-block"}),_.delay(function(){t.$el.find(".connectionStatus").hide()},7e3)):(t.$el.find(".connectionStatus").html('<span class="fa fa-warning"></span>Delta Client connection has been lost, reconnecting...'),t.$el.find(".connectionStatus").css({color:"#FF6262",display:"inline-block"}))},initMainMenu:function(){this.mainMenuView=new c.MainMenu({mainMenuButton:this.mainMenuButton,appModel:this.appModel,viewModel:this.viewModel,isQuickView:!0});var e=this.el.querySelectorAll(".dash-main-menu")[0];e.appendChild(this.mainMenuView.el),this.mainMenu=e.querySelectorAll(".main-menu")[0],this.mainMenuFocusOutHandler=this.onMainMenuFocusOut.bind(this),this.toggleMainMenuHandler=this.onToggleMainMenu.bind(this),this.mainMenuButton.addEventListener("click",this.toggleMainMenuHandler),this.mainMenu.addEventListener("focusout",this.mainMenuFocusOutHandler),this.listenTo(this.mainMenuView,"saveViewStates resetViewStates",this.onMainMenuEventTriggered.bind(this))},onToggleMainMenu:function(e){"block"===this.mainMenu.style.display?(this.mainMenuView.hide(),this.mainMenuButton.focus()):this.mainMenuView.show()},onMainMenuEventTriggered:function(e){switch(this.mainMenuView.hide(),e){case"saveViewStates":this.mainMenuButton.focus(),this.onSaveDash();break;case"resetViewStates":this.onRevertDash();break;default:console.error("Main Menu: ".concat(e," not found"))}},onMainMenuFocusOut:function(e){e.relatedTarget===this.mainMenuButton||this.mainMenu.contains(e.relatedTarget)||this.mainMenuView.hide()},remove:function(){this.mainMenuButton.removeEventListener("click",this.toggleMainMenuHandler),this.mainMenu.removeEventListener("focusout",this.mainMenuFocusOutHandler),h.View.prototype.remove.apply(this)},initProfileMenu:function(){this.profileMenu=new c.ProfileMenu({appModel:this.appModel,dialogContainer:this.dialogContainer,themes:this.themes,isQuickView:!0,viewModel:this.viewModel}),this.$profileMenu.html(this.profileMenu.$el),this.listenTo(this.profileMenu,"themeChange",function(){this.trigger("themeChange")}.bind(this)),this.listenTo(this.profileMenu,"login-history",function(){this.onLoginHistory()}.bind(this)),this.$profileMenu.hide()},onChangePassword:function(){new c.ChangePasswordDialog},getViewstate:function(){var e=this.viewModel.get("selectedDocumentId"),e=this.appModel.get("documents").get(e).get("viewState").getViewStateList(!0),t={};return _.each(e,function(e){t[e.path]=e.model.get("value")}),t},onCreatePdf:function(){var o,s,a,l,r,e=this.viewModel.get("selectedDocumentId"),t=this.appModel.get("documents").get(e),c="",d=this;t&&(s=t.get("viewState").getViewStateExport(t.get("hidePdfGlobalVS")),a="#"+e+"/"+this.viewModel.get("selectedScreenId"),t=new h.Model({printFilters:!1,width:"standard",useClientUrl:!1,fileName:this.appModel.get("documents").get(this.viewModel.get("selectedDocumentId")).get("name")+" "+n().format("YYYY-MM-DD HH:mm")}),d.appModel.get("NewPdf")?(l=$(".toolbar-div").width(),r=$(".grid-stack").height(),t.schema={fileName:{title:"File Name"},printFilters:{title:"Print Filters:",type:"Checkbox"},width:{title:"Pdf Width:",type:"Select",options:["standard","current preview ("+l+"px)"],default:"standard"}},d.appModel.get("isLite")||(t.schema.useClientUrl={title:"Use Client URL:",type:"Checkbox"})):t.schema={},new i.NewObjectDialog({dialogTitle:"Create PDF",iconClass:"fa-file-pdf-o",model:t,userClass:"create-pdf-dialog",okBtnLabel:"Create PDF",okBtnIcon:"fa fa-file-pdf-o",width:350,callback:function(e){_.isEmpty(s)||(c="?viewstate="+encodeURIComponent(JSON.stringify(s)));var t,i=d.appModel.get("isLite"),n=d.appModel.get("PdfUrl");d.appModel.get("NewPdf")&&(c=(c+=c?"&":"?")+"printfilters="+(e.get("printFilters")?1:0),0<$(".pdf-expandable").length?c+="&documentHeight=1080&documentWidth=1920":c=(c=(c+="&documentWidth="+l)+("standard"===e.get("width")?"&width=standard":"&width=other"))+"&documentHeight="+r,t=$.cookie("dashboard-timezone")||d.profileMenu.$selectTimezone.val(),c=(c=(c+="&timezone="+t)+"&clientURL="+location.origin+location.pathname)+(e.get("useClientUrl")?"&useClientUrl=1":"&useClientUrl=0")),c+=(c?"&":"?")+"print=pdf"+(i?"&theme="+($.cookie("dashboard-viewer-theme")||"kx-darkroom"):""),o=(i?"index.html":"index.jsp")+c+a,url=(i?n:"pdf.jsp")+"?filename="+encodeURIComponent(e.get("fileName"))+"&url="+encodeURIComponent(o),window.open(url)}}))},onCustomiseDash:function(){this.viewModel.get("userConfigurable")&&this.viewModel.set("buildMode",!this.viewModel.get("buildMode"),{userInitiated:!0})},onDocumentViewStateChanged:function(){var e=this.viewModel.get("selectedDocumentId"),e=this.appModel.get("documents").get(e),e=e?e.get("saveViewerState"):"";0===e.indexOf("enabled")&&(this.currentDocViewModel.wasChanged=!0,this.$saveDash.addClass("changed")),"enabled_auto"===e&&this.throttledAutoSaveDash()},onDocumentViewStateSaved:function(e){this.$saveDash.removeClass("saving changed")},onLoginHistory:function(){new S({appModel:this.appModel})},onLogout:function(){location.reload()},onRefreshDash:function(){var e=this.appModel.get("documents").get(this.viewModel.get("selectedDocumentId"));e&&e.get("data").getTreeList().forEach(function(e){e.stop(),e.isDirty=!0,e.start()})},onResize:function(){this.documentSelector.onResize()},onRevertDash:function(){var e=this,t=e.appModel.get("isLite"),i=e.viewModel.get("incomingSession"),n=this.viewModel.get("selectedDocumentId"),o=this.appModel.get("documents").get(n),s=o.get("viewState");c.ConfirmDialog.ShowConfirm({dialogTitle:"Confirm Reset",renderTemplate:function(){return"Are you sure you want to revert all settings for this Dashboard to the Editor defaults?"},callback:function(){s instanceof c.DocumentViewModel&&(i&&t?c.DashClient.runAPI(".api.deleteViewstateSessions","gw",[{type:"symbol",value:i}],function(e){console.log("Successfully removed Session Viewstates with ID ".concat(i," from Session Table.")),window.location.reload()},function(e){M.Error("ERROR: Unable to remove Session Viewstates with ID ".concat(i," from the Session Table."),e)}):(c.ViewStateModelHelpers.renameViewStateAttrNamedID(s),s.isNew()&&s.set(s.idAttribute,n,{silent:!0}),s.destroyOnServer({success:function(){e.appModel.get("router").navigate(n,{trigger:!0}),c.ViewStateModelHelpers.restoreViewStateAttrNamedID(s),_.each(s.getViewStateList(),function(e){valueToSet=e.model.get("_rolling")?c.Helpers.convertRollingToDate(e.model.get("_default"),e.model.get("_type")):e.model.get("_default"),e.path.startsWith("_settings/")||e.model.set("value",valueToSet)})},error:function(){c.ViewStateModelHelpers.restoreViewStateAttrNamedID(s),console.log("can't delete user settings",arguments)},dashboardId:o.id})))}})},flattenViewstateModel:function(n,o,s){void 0===o&&(o=""),void 0===s&&(s={});var a=this;return n&&n.keys().forEach(function(e){var t=n.get(e),i=o?"".concat(o,"/").concat(e):e;"_settings"!==e&&".settings"!==e&&(t&&"function"==typeof t.get&&t.get("_viewType")&&"dict"!=t.get("_type")?s[i]=t:t instanceof h.Model&&a.flattenViewstateModel(t,i,s))}),s},onSaveDash:function(){var e,t,i,n=this,o=this.viewModel.get("selectedDocumentId"),s=this.appModel.get("documents").get(o);this.$saveDash.addClass("saving"),s&&_.includes(["enabled","enabled_auto"],s.get("saveViewerState"))?((e=s.get("viewState")).withAllProperties=!0,c.ViewStateModelHelpers.renameViewStateAttrNamedID(e),t=n.viewModel.get("incomingSession"),this.appModel.get("isLite")&&t?(i=[{type:"symbol",value:t},{type:"string",value:JSON.stringify(this.flattenViewstateModel(e))}],c.DashClient.runAPI(".api.setViewstateSessions","gw",i,function(){console.log("Saved Session Viewstates with ID ".concat(t," to Session Table.")),n.$saveDash.removeClass("saving changed")},function(e){M.Error("ERROR: Unable to save Session Viewstates with ID ".concat(t," to Session Table."),e),n.$saveDash.removeClass("saving")})):s.get("viewState").save({id:o},{error:function(e){var t;n.$saveDash.removeClass("saving"),t=arguments[1]||"No error information returned from the server.",M.Error("ERROR DIALOG: ",e,arguments),c.ErrorDialog.ShowError(t)},success:function(){delete s.get("viewState").wasChanged,n.$saveDash.removeClass("saving changed")}}),e.withAllProperties=!1,c.ViewStateModelHelpers.restoreViewStateAttrNamedID(e)):console.log("no document to save!",o)},onSelectedDocumentIdChanged:function(){var e=this.viewModel.previous("selectedDocumentId"),t=this.viewModel.get("selectedDocumentId");this.$shareDash.hide(),e&&(e=this.appModel.get("documents").get(e))&&(this.stopListening(e.get("viewState"),"change",this.onDocumentViewStateChanged),this.stopListening(e.get("viewState"),"sync",this.onDocumentViewStateSaved),this.onDocumentViewStateSaved()),t&&(e=this.appModel.get("documents").get(t))&&(this.currentDocViewModel=e.get("viewState"),this.currentDocViewModel&&!this.currentDocViewModel.id&&(this.currentDocViewModel.id=t),this.listenTo(e.get("viewState"),"change",this.onDocumentViewStateChanged),this.listenTo(e.get("viewState"),"sync",this.onDocumentViewStateSaved),t=this.el.querySelectorAll(".main-toolbar")[0],["Show"].includes(e.get("mainMenuButton"))?t.classList.remove("hideMainMenu"):t.classList.add("hideMainMenu"),this.$saveDash.toggle(_.includes(["enabled","enabled_auto"],e.get("saveViewerState"))),this.$shareDash.toggle(e.get("enableShareDashboard")),this.mainMenuView.updateQuickViewSave(e.get("saveViewerState")))},onShareDash:function(){var e,t,i=this.viewModel.get("selectedDocumentId"),n=this.appModel.get("documents").get(i),o=this.viewModel.get("selectedScreenId");this.appModel.has("shortenShareUrl")||this.appModel.set("shortenShareUrl",!0,{silent:!0}),n&&n.get("enableShareDashboard")?(t=this.appModel.get("websiteUrl"),this.appModel.get("pushStateBase")&&(e=window.location.pathname,t=t.replace(e,e.replace("/","/#"))),location.href&&0<location.href.indexOf("auth=saml")&&(t+="?auth=saml"),0===(t+="#".concat(n.id)).indexOf("//")&&(t=location.protocol+t),o&&(t+="/"+o),(e=c.getViewStateExport(n))&&(t+="?viewstate=".concat(e)),o=new b({isLite:this.appModel.get("isLite"),shortenUrl:this.appModel.get("shortenShareUrl"),url:t}),this.listenTo(o,"shortenUrlSetting",function(e){this.appModel.set("shortenShareUrl",e,{silent:!0})})):console.log("no document to share",i)},onUserConfigurableChange:function(){this.$customiseDash.button("widget").toggle(this.viewModel.get("userConfigurable"))},onWidgetsConfigured:function(){this.$saveDash.addClass("changed")}}),M=c.Log,y=c.AreYouSureDialog.extend({className:"quick-view window are-you-sure",viewModel:null,initialize:function(e){c.AreYouSureDialog.prototype.initialize.apply(this,arguments),this.dashboardId=e.dashboardId},doSave:function(){var e=$.Deferred(),t=this.model.get("viewState");return t.withAllProperties=!0,c.ViewStateModelHelpers.renameViewStateAttrNamedID(t),this.model.get("viewState").save({id:this.dashboardId},{error:e.reject,success:e.resolve}),t.withAllProperties=!1,c.ViewStateModelHelpers.restoreViewStateAttrNamedID(t),e.promise()},getPromptMessage:function(){return"There are unsaved view state changes in this dashboard."}}),k=h.Router.extend({model:null,previousRoutes:null,viewModel:null,routes:{":dashboardId(/)(:screenId)":"onDashboard"},initialize:function(e){this.model=e.model,this.viewModel=e.viewModel,this.dialogContainer=e.dialogContainer,this.previousRoutes=[],this.initializeEvents()},initializeEvents:function(){this.on("route",function(){this.previousRoutes.push(h.history.fragment)})},getSessionFromQueryString:function(e){e=/sessionID=([A-Za-z0-9_-]+)/.exec(e);return e?decodeURIComponent(e[1]):null},getUserViewState:function(e,i,n){e=new c.DocumentViewModel({id:e.id});c.Log.Log("User Settings Get"),e.fetch({success:function(e){c.Log.Log("User Settings Completed",e),e.unset("id",{silent:!0}),c.ViewStateModelHelpers.restoreViewStateAttrNamedID(e);var t=c.getViewstateFromQueryString(i);t&&e.set(t),n(e)},error:function(e,t){"Record Not Found"===t?c.Log.Log("User Settings Not Found"):c.Log.Error("User Settings Error"),n(null)}})},navigateToDash:function(n,o,s){var i,a=this,l=this.viewModel.get("selectedDocumentId"),e=this.model.get("documents").get(n);e?(i=function(e){var t=c.getViewstateFromQueryString(s),i=a.getSessionFromQueryString(s);a.viewModel.set("incomingViewState",t,{silent:!0}),a.viewModel.set("incomingSession",i,{silent:!0}),l===n&&t&&a.viewModel.trigger("processIncomingViewState",e),l===n&&i&&a.viewModel.trigger("processIncomingSession",e),o||((t=e.get("screens").findWhere({isDefault:!0})||e.get("screens").first())?o=t.id:M.Error("no default screen, no screens at all")),a.viewModel.set({selectedDocumentId:n,selectedScreenId:o}),e.trigger("view-state-init")},l!==n?e.fetch({success:function(t){a.getUserViewState(t,s,function(e){a.updateDocumentViewState(t,e),i(t)})},error:function(e,i){alert(i&&"string"==typeof i?i:t("error downloading dashboard"))},silent:!0}):i(e)):(M.Error("dashboard NOT found (?)"),l?M.Error("dashboard doesn't exist or user doesnt have required permissions. (2)"):0<this.model.get("documents").length?this.navigate(this.model.get("documents").first().id,{trigger:!0}):(M.Error("dashboard doesn't exist or user doesnt have required permissions. (1)"),$(document).find(".loadingScreen").css({display:"none"}),this.dialog=$("<div>The Selected dashboard does not exist or user does not have required permissions or no dashboards are permissioned to this user.</div>").dialog({autoOpen:!0,height:350,width:350,modal:!0,title:"Error loading Dashboard"})))},onDashboard:function(t,i,n){var o=this.viewModel.get("selectedDocumentId"),e=this.model.get("documents").find(function(e){return e.id===o});e&&o!==t&&e.get("unsavedViewerPrompt")&&e.get("viewState").wasChanged?new y({container:this.dialogContainer,dashboardId:o,model:e,userClass:"quick-view"}).on("close",function(e){"cancel"==e?(this.previousRoutes.pop(),this.navigate(_.last(this.previousRoutes),{replace:!0}),this.onNavCancel&&(this.onNavCancel(),this.onNavCancel=null)):(this.navigateToDash(t,i,n),this.previousRoutes=[h.history.fragment])}.bind(this)):this.navigateToDash(t,i,n)},updateDocumentViewState:function(e,t){var i,o=e.get("viewState"),n=o.get(".settings"),s=function(e,i){var t,n=o.getByPath(i);if(_.isObject(e))if(_.isFunction(e.get))t=e.get("value");else{if(!e._viewType)return _.each(e,function(e,t){s(e,i+"/"+t)}),!1;t=e.value}else t=e;n&&!_.isUndefined(t)&&(n instanceof h.Model?n.set("value",t):M.Warn('AppRouter: Invalid view state at "'+i+'"',n))};t&&_.each(t.attributes,function(e,t){".settings"!==t?s(e,t):n&&_.each(e.attributes,function(e,t){i=n.get(t),_.isUndefined(i)&&(i=new h.Model,n.set(t,i)),i.set(e.attributes)})})}}),L=h.View.extend({className:"notificator",initialize:function(e){this.appModel=e.appModel,this.render()},notify:function(e,t){this.$title.text(e),this.$items.append(t),this.$panel.fadeIn("slow")},onClose:function(){var e=this;this.$panel.fadeOut("slow",function(){e.$items.html("")})},render:function(){return this.$el.addClass(this.className),this.$el.html(o.Notificator()),this.$title=this.$(".title"),this.$items=this.$(".items"),this.$panel=this.$(".panel"),this.$close=this.$(".close-button"),this.$close.button({showLabel:!1,icons:{primary:"fa fa-times"}}).click($.proxy(this.onClose,this)),this.$panel.hide(),this}}),x=h.View.extend({className:"failed-logins",initialize:function(e){this.appModel=e.appModel,this.render()},render:function(){var e=this.model.toJSON();return _.each(e.rows,function(e){var t=I.convertKDBTemporalToMoment(e.time);e.time=t.format("YYYY-MM-DD HH:mm:ss"),e.timeSort=t.valueOf()}),e.rows=_.sortBy(e.rows,"timeSort").reverse(),$(this.$el).css("max-height",$(".quick-base").height()/2),this.$el.addClass(this.className),this.$el.html(o.FailedLoginsNotification(e)),this}}),I=c.Tools;return h.View.extend({DOCUMENT_TITLE:{SEPARATOR:" - ",SUFFIX:"Dashboards"},THEMES:[{id:"kx-darkroom",name:"Dark"},{id:"kx-light",name:"Light"}],$documentDialogPanel:null,$documentViewDiv:null,$environmentDialogPanel:null,loadingScreen:null,documentView:null,environmentTheme:null,viewModel:null,router:null,appid:"dashboards",hideLoadingScreen:function(){this.loadingScreen&&this.loadingScreen.remove()},initialize:function(t){var e,s=this,i=(-1!==document.location.href.indexOf("auth=saml")&&(this.saml=!0),window.resizeHandler=function(){window.dispatchEvent(new Event("resize"))},c.Helpers.preventBackspaceBack(),e=(e=-1!==document.location.pathname.indexOf(".")?document.location.pathname.substr(0,document.location.pathname.lastIndexOf("/")+1):document.location.pathname).replace("quickview/",""),t.embedded&&this.$el.addClass("embedded"),t.isLite?c.DashClientLib:c.DeltaClientLib),n=i.documentSync,i=i.documentCollectionSync;t.documentAPI&&(n=c.DocumentSyncHelpers.buildDocumentSync(t.documentAPI),i=c.DocumentSyncHelpers.buildDocumentCollectionSync(t.documentAPI)),c.Document.prototype.sync=n,c.DocumentCollection.prototype.sync=i,t.isLite?(c.DocumentViewModel.prototype.localStorage=new h.LocalStorage("viewstate"),_.extend(c.DocumentDataModel.prototype,c.DashClientLib),c.DeltaClientLib.PIVOT_SOURCE_CODE=c.DashClientLib.PIVOT_SOURCE_CODE):c.DocumentViewModel.prototype.sync=c.DeltaClientLib.documentViewSync,this.model=new a($.extend({documents:new c.DocumentCollection,websiteUrl:"//"+document.location.host+e,saml:this.saml},t)),c.Helpers.setCalendarPath(this.model.get("paths")),this.viewModel=new c.AppViewModel({buildMode:!1}),t.printMode&&this.$el.addClass("print-mode"),n=function(e){s.model.set("language",e.language||"en"),s.render(),$.extend($.ui.dialog.prototype.options,{appendTo:s.$documentDialogPanel}),s.setThemeFromCookie(),s.model.get("components").reset(t.components),t.deltaToken=t.deltaToken||$.cookie("deltaToken"),s.model.get("isLite")?(c.DashClient.client=new c.DashClient(t),c.DeltaClientLib=c.DashClient):s.saml?s.initializeDeltaClient(null,null,function(e){alert(e)},null,!0):t&&t.delta?(s.model.set({userName:t.delta.username,DeltaClientHost:t.delta.options.host,DeltaClientPort:t.delta.options.port,DeltaClientSecure:t.delta.options.secure,DeltaClientFromUrl:t.delta.options.fromURL}),c.DeltaClientLib.initializeDeltaClientCopy(t.delta.client,s.model.get("DeltaClientHost"),s.model.get("DeltaClientPort"),s.model.get("DeltaClientSecure"),s.model.get("DeltaClientFromUrl"),t.delta.username,t.delta.password,null,function(e){alert(e)},s.appid)):t.deltaToken||t.credentials?($(c.DeltaClientLib).one("DeltaClientLogin",function(e){s.model.set("userName",c.DeltaClientLib.deltaClient.user()),t.deltaToken&&$.cookie("deltaToken",t.deltaToken,{expires:30,path:"/;SameSite=Strict",secure:"https:"===_.get(window,"location.protocol")})}),s.initializeDeltaClient(t.credentials?t.credentials.username:null,t.credentials?t.credentials.password:null,null,t.deltaToken)):s.showLogin(),"MutationObserver"in window&&(s.observer=new MutationObserver(function(e){for(var t=0;t<e.length;t++){var i=e[t].addedNodes;if(i)for(var n=0;n<i.length;n++){var o=i[n];"ui-datepicker-div"===o.id?s.$documentDialogPanel[0].appendChild(o):_.isString(o.className)&&-1!==o.className.indexOf("select2-container")&&(-1!==o.className.indexOf("select2-container--document-selector")||-1!==o.className.indexOf("select2-container--dashboards-properties")||-1!==o.className.indexOf("select2--environment")?s.$environmentDialogPanel:s.$documentDialogPanel)[0].appendChild(o)}}}),s.observer.observe(document.querySelector("body"),{attributes:!1,childList:!0,characterData:!1})),s.initializeEvents(),s.fixSelect2DialogIssue()};try{c.InitializeQuickbase(n)}catch(e){console.log("error loading quickbase",e),_.isFunction()&&(window.t=function(e){return e},n())}window.startPdfCreation=this.startPdfCreation,c.Dash.DashEngine.activator(this.model,this.viewModel)},initializeEvents:function(){var o=this,e=this.model.get("isLite")?c.DashClient.client:c.DeltaClientLib;$(window).resize($.proxy(this.onResize,this)),this.listenTo(this.toolbar,"themeChange",this.setThemeFromCookie),$(e).one("DeltaClientConnect",function(){o.hideLoadingScreen(),$(e).on("DeltaClientConnect",function(){o.hideLoadingScreen();var e=o.getCurrentDocument();e&&e.get("data").getTreeList().forEach(function(e){e.start()})})}),$(e).on("DeltaClientDisconnect",function(e,i){var n=o.getCurrentDocument();i=i?_.startCase(i)+": ":"",o.showLoadingScreen(i+t("reconnecting...")),n&&o.getCurrentDocument().get("data").getTreeList().forEach(function(e){e.stop()})}),$(e).one("DeltaClientLogin",$.proxy(this.onDeltaClientLogin,this)),this.listenTo(this.viewModel,"change:buildMode",this.onBuildModeChange),this.listenTo(this.viewModel,"change:selectedDocumentId",this.onDocumentChanged),this.listenTo(this.viewModel,"processIncomingViewState",this.processIncomingViewState),this.listenTo(this.viewModel,"processIncomingSession",this.processIncomingSession),window.onbeforeunload=function(e){var t=o.getCurrentDocument(),i="There are unsaved changes in this dashboard.",n=!1;if(t&&t.get("data").getTreeList().forEach(function(e){e.stop()}),n=t&&t.get("unsavedViewerPrompt")&&(t.get("viewState").wasChanged||_.some(c.ComponentView.getInstances(),function(e){return e.beforeRemove()}))?!0:n)return(e||window.event).returnValue=i}},initializeDeltaClient:function(i,n,o,s,a,l){var r=this;c.DeltaClientLib.initializeDeltaClient(r.model.get("DeltaClientHost"),r.model.get("DeltaClientPort"),r.model.get("DeltaClientSecure"),r.model.get("DeltaClientFromUrl"),i,n,null,function(e){var t;_.isFunction(o)?o(e):(t=_.isString(e)?e.toLowerCase():null,"loginRequired"===e?r.showLogin():"userSessionLimit"===e?r.showForceLoginPrompt(function(){r.initializeDeltaClient(i,n,o,s,a,l)}):(t&&_.some(["login","token","session","websocket"]),r.showLogin(e)))},s,r.appid,!0,!!a,!!l)},fixSelect2DialogIssue:function(){var t;$.ui&&$.ui.dialog&&$.ui.dialog.prototype._allowInteraction&&(t=$.ui.dialog.prototype._allowInteraction,$.ui.dialog.prototype._allowInteraction=function(e){return!!$(e.target).closest(".select2-dropdown").length||t.apply(this,arguments)})},getAPIPrefix:function(){return"file:"===location.protocol||"FSBL"in window?"http://localhost:10001/api/":"/api/"},getCurrentDocument:function(){var t=this.viewModel.get("selectedDocumentId");return this.model.get("documents").find(function(e){return e.id===t})},onBuildModeChange:function(){this.$el.toggleClass("buildMode",this.viewModel.get("buildMode"))},onDocumentChanged:function(){var e,t;this.viewModel.get("selectedDocumentId")&&(t=(e=this.model.get("documents").get(this.viewModel.get("selectedDocumentId"))).get("themeSwitchable"),this.viewModel.set("themeSwitchable",t),this.resetDocumentView(e),this.onResize(),this.processIncomingViewState(e),this.processIncomingSession(e),this.viewModel.set("userConfigurable",!1)),t=e?(t?this.setThemeFromCookie():"None"!==(t=e.get("dashboardTheme"))&&(this.viewModel.set("DashboardTheme",t),this.setDocumentTheme(t),this.setEnvironmentTheme(t)),e.get("name")+this.DOCUMENT_TITLE.SEPARATOR+this.DOCUMENT_TITLE.SUFFIX):this.DOCUMENT_TITLE.SUFFIX,$(document).attr("title",t)},onDeltaClientLogin:function(){var t=this,e=(this.model.set("ClientLoginTimestamp",Date.now()),M.Log("Dash Documents Fetch"),this.model.get("documents").fetch({success:$.proxy(this.onDocumentsFetched,this),error:function(){alert("document fetch error")},reset:!0}),this.model.get("isLite")),i=this.model.get("embedded"),i=e&&!i;!e?(this.model.set("userName",c.DeltaClientLib.username),this.updateUserComponents(),this.onPopulateDeltaClientInformation(),c.DeltaClientLib.showLastLoginAttempts&&this.onShowLastLoginAttempts()):i&&(i=(e=this.model.get("connections"))&&!_.isEmpty(e.models)?_.first(e.models):"html5evalcongroup",c.DeltaClientLib.getQueryData("q",i,".dash.u",[],function(e){e=_.get(e,"rows.0.symbol","User");t.model.set("userName","default"===e?"User":e)},function(e){t.model.set("userName","User")}),this.model.set("userName","User"))},onPopulateDeltaClientInformation:function(){var t=this;c.DeltaClientLib.getAPIQueryData("kdb",void 0,".ui.controlDetails",[],function(e){t.model.set("dashboardControlDetails",e.rows.reduce(function(e,t){return e[t.Property]=_.isArray(t.Value)?t.Value.join(""):t.Value,e},{}))},function(e){console.log("Error Fetching Delta Client Information:",e)},100,!1)},onDocumentsFetched:function(){M.Log("Dash Documents Complete"),this.router=new k({dialogContainer:this.$environmentDialogPanel,model:this.model,viewModel:this.viewModel}),this.model.set("router",this.router);var e,t=this.model.get("pushStateBase");t&&((e=document.createElement("base")).setAttribute("href",t),document.getElementsByTagName("head")[0].appendChild(e)),h.history.start(t?{pushState:!!t,root:t}:void 0),h.history.fragment.length<=0&&((e=this.viewModel.get("selectedDocumentId"))||0<(t=this.model.get("documents").getSortedDocuments()).length&&(e=t[0].id),e?this.router.navigate(e,{trigger:!0}):M.Error("this user doesn't have any dashboards")),this.hideLoadingScreen()},onResize:function(){this.documentView&&this.documentView.onResize(),this.toolbar&&this.toolbar.onResize&&this.toolbar.onResize()},onShowLastLoginAttempts:function(){var e,t=c.DeltaClientLib.showLastLoginAttempts,i="",n=this;if("failures"===t||"true"===t)e=".session.getFailedLoginsUI",i="Unsuccessful login attempts:";else{if("all"!==t)return;e=".session.getLoginsUI",i="Last 10 login attempts:"}c.DeltaClientLib.getAPIQueryData("kdb",void 0,e,[],function(e){var e=_.filter(e.rows,function(e){return e.machineID&&0<e.machineID.length});0<e.length&&(e=new x({appModel:n.model,model:new h.Model({rows:e})}),n.notificator.notify(i,e.$el))},function(e){console.log("show last login attempts error:",e)},100,!1)},processIncomingViewState:function(e){c.processIncomingViewState(e,this.viewModel)},processIncomingSession:function(e){c.processIncomingSession(e,this.viewModel,this.model.get("isLite"))},remove:function(){this.observer.disconnect(),h.View.prototype.remove.call(this)},render:function(){this.model.get("isLite")?this.$el.addClass("quick-view quick-base is-lite"):this.$el.addClass("quick-view quick-base"),this.$el.html(o.app()),this.$notificationsDiv=this.$(".notifications-div"),this.notificator=new L({el:this.$notificationsDiv}),this.$documentDialogPanel=this.$el.find("> .dialog-panel .document"),this.$documentViewDiv=this.$el.find(".document-view-div"),this.$environmentDialogPanel=this.$el.find("> .dialog-panel .environment"),this.toolbar=new C({el:this.$el.find(".toolbar-div"),appModel:this.model,dialogContainer:this.$environmentDialogPanel,themes:this.THEMES,viewModel:this.viewModel})},resetDocumentView:function(e){var t,i;this.documentView&&(this.documentView.remove(),this.documentView=null),(i=c.NotificationManager).setDocumentDataModel(e.get("data")),t=i.CONFIG.upgradeConfig(e.get("notifications")),i.setOptions(t),this.documentView=new c.DocumentView({appModel:this.model,model:e,quickView:!0,viewModel:this.viewModel}),this.$documentViewDiv.append(this.documentView.$el)},setThemeFromCookie:function(){this.environmentTheme=$.cookie("dashboard-viewer-theme")||this.THEMES[0].id,this.setEnvironmentTheme(this.environmentTheme),this.setDocumentTheme(this.environmentTheme),_.includes(self.THEMES,this.environmentTheme)&&require(["css!"+this.environmentTheme])},setDocumentTheme:function(e){var t,i;switch(e){case"kx-darkroom":case"Dark":t="kx-darkroom",i="Dark";break;case"kx-light":case"Light":t="kx-light",i="Light"}"None"!==e&&(this.viewModel.set("DashboardTheme",i),_.each([this.$documentViewDiv,this.$documentDialogPanel],function(e){e&&(e.removeClass("Dark Light kx-darkroom kx-light"),e.addClass(i),e.addClass(t))}))},setEnvironmentTheme:function(t){switch(t){case"Dark":t="kx-darkroom";break;case"Light":t="kx-light"}_.each([this.toolbar.$el,this.$environmentDialogPanel,this.$notificationsDiv],function(e){e&&e.removeClass("Dark Light kx-darkroom kx-light").addClass(t)})},showForceLoginPrompt:function(e){c.ConfirmDialog.ShowConfirm({dialogTitle:"Session Limit exceeded",renderTemplate:function(){return t("User session limit has been reached, terminate oldest open session?")},callback:e,cancelBtnCallback:this.showLogin.bind(this),container:this.$environmentDialogPanel})},showLoadingScreen:function(e){this.loadingScreen&&this.loadingScreen.remove(),this.loadingScreen=new D({loadingText:e}),this.$el.append(this.loadingScreen.$el)},showLogin:function(e){var o=this;new c.LoginDialog({appModel:this.model,container:this.$environmentDialogPanel,errorMessage:e,doLogin:function(t,i,n){o.initializeDeltaClient(t,i,function(e){"loginRequired"===e?o.showLogin():"userSessionLimit"===e?o.showForceLoginPrompt(function(){o.initializeDeltaClient(t,i,n,null,null,!0)}):n(e)})}})},startPdfCreation:function(){0<$("body.pdf").length&&0<$(".pdf-expandable").length&&($(".fillHeightMode").toggleClass("fillHeightMode",!1),$("html").toggleClass("pdf-flow-layout",!0))},updateUserComponents:function(){var t=this.model.get("components");c.DeltaClientLib.getComponents(function(e){t.remove(t.where({user:!0})),_.each(e,function(e){e=$.parseJSON(e.dataJSON);e.user=!0,t.add(e)})},function(e){M.Error("DeltaClientLib.getComponents: Error",e)})}})});
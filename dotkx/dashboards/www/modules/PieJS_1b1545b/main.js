define(["Handlebars","QuickBase","moment","xlsx","chartjs","backbone","css!./css/app.css"],function(b,h,s,A,H,i){"use strict";var a,o,e=this&&this.__extends||(a=function(e,t){return(a=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}))(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function o(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,o=1,a=arguments.length;o<a;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},j=(o=i.DeepModel,e(r,o),r.prototype.initialize=function(){this.labelPlugin={afterDatasetsUpdate:function(t){_.each(t.config.layers.models,function(e){e.setPopoutSegment(t)})},beforeDraw:function(e){function t(o,e,a,i,r,n,s){for(var l=1.2*o.measureText("M").width,c=e?e.split("\\n"):"",t=0;t<c.length;++t)!function(e){var e=c[e].split("</span>"),t=0;_.each(e,function(e){e=e.replace(/(<([^>]+)>)/gi,"");o.fillStyle=r,o.font=n+"px "+s,o.fillText(e,a+t,i),t=o.measureText(e).width}),i+=l}(t)}var o,a,i,r,n,s,l,c;e.config.options.elements.center&&(o=e.chart.ctx,n=(c=e.config.options.elements.center).fontSize,a=c.fontStyle||"Arial",i=c.text,r=c.color||"#000",s=(c.sidePadding||20)/100*(2*e.innerRadius),o.font=n+"px "+a,l=o.measureText(i).width,s=2*e.innerRadius-s,s=Math.floor(n*(s/l)),l=2*e.innerRadius,n=n||Math.min(s,l),o.textAlign="center",o.textBaseline="middle",s=(e.chartArea.left+e.chartArea.right)/2,l=(e.chartArea.top+e.chartArea.bottom)/2,o.font=n+"px "+a,o.fillStyle=r,"fontawesome"===c.fontStyle?o.fillText((e=i,(c=document.createElement("i")).className="fa fa-"+e,c.style.display="none",document.body.appendChild(c),e=window.getComputedStyle(c,":before").getPropertyValue("content"),document.body.removeChild(c),e.replace(/([.\"])/g,"")),s,l):t(o,i,s,l,r,n,a))}}},r.prototype.setPopoutSegment=function(e,t){var o,a=this;this.resetLayerPopout(e),0<e.data.datasets.length&&(t=_.isNaN(t)?t:-1,_.each(e.config.dataSource,function(e){e=_.find(e.getData().models,function(e){return e.get(a.get("Basics.SelectedAttr"))===a.get("Basics.Selected")});e&&null!==e.id&&(t=e.id)}),-1!==t)&&(o=e.getDatasetMeta(0).data[t])&&this.get("Basics.PopoutSelected")&&(o._model.outerRadius=e.outerRadius+parseFloat(this.get("Basics.PopoutSelectedSize")),o._model.innerRadius=e.innerRadius+parseFloat(this.get("Basics.PopoutSelectedSize")))},r.prototype.resetLayerPopout=function(t){this.get("Basics.PopoutSelected")&&0<t.data.datasets.length&&_.each(t.getDatasetMeta(0).data,function(e){e._model.outerRadius=t.outerRadius,e._model.innerRadius=t.innerRadius})},r.prototype.computeConfigProps=function(){var e=void 0===this.get("DataSet.DonutRatio")?35:this.get("DataSet.DonutRatio"),t=void 0===this.get("DataSet.Circumference")?100:this.get("DataSet.Circumference"),o=void 0===this.get("DataSet.Rotation")?50:this.get("DataSet.Rotation"),a=this.get("InnerLabel.labelPosition");return this.get("InnerLabel.ShowPieceLabel")?{cutoutPercentage:e,circumference:this.calcRange(t,0,2)*Math.PI,rotation:(this.calcRange(o,0,2)-1)*Math.PI,labelPosition:a,pieceLabel:this.computePieceLabel(),elements:this.computeElementCenter()}:{cutoutPercentage:e,circumference:this.calcRange(t,0,2)*Math.PI,rotation:(this.calcRange(o,0,2)-1)*Math.PI,labelPosition:a,elements:this.computeElementCenter()}},r.prototype.updateData=function(i){var t,e,r=this;i?(this.setPreviousChartData(),this.chartData={},this.dataSource=i,void 0!==(e=this.get("DataSet.Label"))&&(e=e.startsWith("/")&&e.endsWith("/")?e.substring(1,e.length-1):"^"+e.replace(/\*/g,"(.*)")+"$",t=new RegExp(e),e=i.getColumnNames().filter(function(e){return e.match(t)}),_.each(e,function(a){_.each(r.get("DataSet.Layers"),function(e){var t,o=e.Segment;void 0!==o&&(o=o.startsWith("/")&&o.endsWith("/")?o.substring(1,o.length-1):"^"+o.replace(/\*/g,"(.*)")+"$",t=new RegExp(o),o=i.getColumnNames().filter(function(e){return e.match(t)}),r.labelData=i.getData().map(function(e){return e.get(i.getPropertyFromColumn(a))}),_.each(o,function(t){r.chartData[r.getDisplayName(t)]={data:_.map(i.getData().models,function(e){return e.get(t)}),color:e.Color||i.api.getProperty("DataSet.Layers.0.Color"),borderColor:e.BorderColor||i.api.getProperty("DataSet.Layers.0.BorderColor"),colorOpacity:e.ColorOpacity||i.api.getProperty("DataSet.Layers.0.ColorOpacity"),usePallette:e.UseColor}}),r.updateVisuals())})})),this.updateVisuals()):this.initialize()},r.prototype.updateVisuals=function(){var e=this.computeDataSetProps(),t=this.computeConfigProps();this.dataset=_.map(e,function(e){return _.extend({},t,e)})},r.prototype.setPreviousChartData=function(){this.previousChartData=_.extend({},this.chartData)},r.prototype.calcRange=function(e,t,o){return t+e/100*(Math.abs(o)-Math.abs(t))},r.prototype.computeDataSetProps=function(){var i=this;return _.map(this.chartData,function(e,t){0;var o=i.getBackgroundColor(e.usePallette,e.color,e.colorOpacity),a=_.isString(e.borderColor)&&""===e.borderColor?o:e.borderColor;return{label:i.labelData,id:i.id,data:e.data,backgroundColor:i.computeHightlightColor(o,e.colorOpacity,e,t),borderColor:a,defaultBackgroundColor:o,defaultBorderColor:a}})},r.prototype.computeElementCenter=function(){return{center:{text:this.get("InnerLabel.Innertitle"),color:this.get("InnerLabel.InnertitleColor"),fontStyle:this.get("InnerLabel.InnertitleFont"),fontSize:this.get("InnerLabel.InnertitleSize"),sidePadding:15}}},r.prototype.computePieceLabel=function(){var e=this.get("InnerLabel"),t=e.Precision,o=e.HideTrailingZeroes,a=e.DateFormat,i=e.Format,r=e.PieceLabelRender,n=e.Prefix,s=e.Suffix,l=e.PieceLabelArc,c=e.PieceLabelOverlap,p=e.ShowZero,d=e.FontSize,h=e.PieceLabelColor,u=e.PieceLabelPosition,g=e.PieceLabelTemplate,f=D.getFormatter(i,t,o,a),m=this.dataSource,y=m?m.getData():null;return{precision:t||0,showZero:p,fontSize:d,fontColor:h,fontStyle:"normal",fontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",arc:l,position:u,overlap:c,render:function(e){var t=e[r];if(g){var o,a,i=b.compile(g);try{y&&0<y.models.length&&y.models[e.index]&&(o=_.assignIn(e,y.models[e.index].attributes),m)&&(a=m.api.getTemplateViewStates(g),t=i(_.assignIn(o,a)))}catch(e){console.log("Handlebar Error",e)}return t}if(_.indexOf(["percentage","value","label"],r)<0){i=b.compile(r);t=r;try{y&&0<y.models.length&&y.models[e.index]&&(t=i(y.models[e.index].attributes))}catch(e){console.log("Handlebar Error",e)}e.advanced=t}return"Invalid date"===(t=f(t))&&(t=e[r]),n+t+s}}},r.prototype.getBackgroundColor=function(e,t,o){e=e?this.getColorScheme(o):D.alpha(t,o);return e},r.prototype.computeHightlightColor=function(e,t,o,a){_.extend([],e);return this.computeHighlightRules(e,t,"RuleColor",a)},r.prototype.getColorScheme=function(t){var o=[];if(_.each(_.map(this.get("Style.chartBarColors"),"type"),function(e){o.push(D.alpha(e,t))}),0<o.length&&o.length<this.labelData.length)for(var e=_.extend([],o),a=0;a<=this.labelData.length/e.length+1;a++)o=_.concat(o,e);return o},r.prototype.getDisplayName=function(e){var t=e;return t=(e=_.fromPairs(_.map(this.get("DataSet.Layers"),function(e){return[e.Segment,e.Display]}))[e])?e:t},r.prototype.computeHighlightRules=function(n,s,l,c){var o,a,i,p=this,d=[],r=0,e=_.map(this.get("DataSet.Layers"),"Segment"),t=this.get("Basics"),h=t.Focus,t=t.Data,h=h?_.first(D.focus2Array(h)):[],u=void 0===h?0:h.length,g=(t.dataSet&&t.dataSet.breakdownColumns&&(a=t.dataSet.breakdownColumns),_.get(a,"attributes")&&(a=a.get("value")),0<=_.indexOf(e,c)?r=_.indexOf(e,c):_.each(e,function(e,t){e.match(c)&&(r=t)}),"DataSet.Layers."+r+".HighlightRules");return this.chartData[c]&&this.dataSource&&(i=this.dataSource,_.each(i.api.getProperty(g),function(e,r){var t=i.api.getProperty(g+"."+r+".RuleSource");t?("{breakdownId}"===e.RuleSource&&(t=a&&a[u]?a[u]:e.RuleSource),p.dataSource&&(o=p.dataSource.getData().pluck(t))):o=_.get(p.chartData[c],"data"),o&&0<o.length&&_.each(o,function(e,t){var o,a,i;p.dataSource&&(o=p.dataSource.api.getProperty(g+"."+r+".RuleValue"),a=p.dataSource.api.getProperty(g+"."+r+"."+l),i=p.dataSource.api.getProperty(g+"."+r+".RuleOperation"),"previous"===o&&(o=p.getPreviousChartData(c,t)),e=D.getConditionResult(e,o,i),d[t]?d[t]=e?D.alpha(a,s):d[t]:d.push(e?D.alpha(a,s):"string"==typeof n?n:n[t]))})})),0<g.length&&0<d.length?d:n},r.prototype.getPreviousChartData=function(e,t){if(this.previousChartData&&this.previousChartData[e]){e=_.get(this.previousChartData[e],"data")[t];if(e)return e}},r);function r(){var e=null!==o&&o.apply(this,arguments)||this;return e.colorCache={},e.columns=[],e.labels=[],e.chartData={},e.labelData=[],e.chartType="pie",e.previousChartData={},e}l=i.Collection,e(c,l),c.prototype.modelId=function(e){return e};var l,V=c;function c(){var e=null!==l&&l.apply(this,arguments)||this;return e.model=j,e}p=i.DeepModel,e(d,p),d.prototype.initialize=function(){},d.prototype.toPieJSON=function(){return _.chain(this.toJSON()).toPairs().reduce(function(e,t){return e[t[0].toLowerCase()]=t[1],e},{}).value()},d.Enabled=!1;var p,Y=d;function d(){return null!==p&&p.apply(this,arguments)||this}u.sourceKey=function(e){return e.getPath()},u.mergeChanges=function(t,o,e,a,i,r){return e&&(t=_.fromPairs(_.map(e,function(e){return[o(e),e]}))),a&&_.each(a,function(e){return _.extend(t[o(e)],e)}),i&&_.each(i,function(e){t[o(e)]=e}),r&&_.each(r,function(e){delete t[o(e)]}),t},u.prototype.setFocus=function(e){this.focus=e,this.updateChildren(),this.childDataSource&&this.childDataSource.setFocus(e)},u.prototype.getColumnNames=function(){if(this.breakdownColumns&&this.breakdownColumns.length)return[u.BREAKDOWN_ID,this.breakdownColumns[0]].concat(_.difference(_.keys(this.meta),this.breakdownColumns));try{return _.map(this.meta,function(e){return[e.id,e.index]}).sort(function(e,t){return e[1]-t[1]}).map(function(e){return e[0]})}catch(e){return _.keys(this.meta)}},u.prototype.getColumnType=function(e){return this.childDataSource?this.childDataSource.getColumnType(e):e===u.BREAKDOWN_ID&&this.primaryKey?this.meta[this.primaryKey].kdbType:this.meta[e]?this.meta[e].kdbType:11},u.prototype.getData=function(){return this.childDataSource?this.childDataSource.getData():this.source.dataSet&&this.source.dataSet.collection},u.prototype.getDepth=function(){return this.childDataSource?this.childDataSource.getDepth():this.depth},u.prototype.getKey=function(){return this.source.cid},u.prototype.getPrimaryKey=function(){return this.childDataSource?this.childDataSource.getPrimaryKey():this.primaryKey},u.prototype.getPropertyFromColumn=function(e){return e===u.BREAKDOWN_ID?this.getPrimaryKey():e},u.prototype.getPath=function(){return this.source.path},u.prototype.getSource=function(){return this.source},u.prototype.hasData=function(){return this.childDataSource?this.childDataSource.hasData():this.hasDataFlag},u.prototype.onData=function(e,t,o){e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey);var a=e.columns,i=a.reset,r=a.change,n=a.add,a=a.remove;this.meta=u.mergeChanges(this.meta,function(e){return e.id},i,r,n,a),0!==this.depth||_.isEqual(e.breakdownColumns,this.breakdownColumns)||(this.breakdownColumns=e.breakdownColumns,this.removeChild()),t.reset&&0<t.reset.length&&this.removeChild(),o&&this.updateError(this,o),this.hasDataFlag=!0,this.updateChildren()&&this.listener.updateDataSource(this)},u.prototype.subscribe=function(){this.api.subscribe(this.source,this.onData.bind(this))},u.prototype.updateDataSource=function(){this.listener.updateDataSource(this)},u.prototype.updateError=function(e,t){this.listener.updateError(this,t)},u.prototype.unsubscribe=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource),this.api.unsubscribe(this.source)},u.prototype.removeChild=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource)},u.prototype.updateChildren=function(){var e;return!(this.breakdownColumns&&this.breakdownColumns.length&&this.depth<this.breakdownColumns.length-1&&(this.focus.length>this.depth?(this.childDataSource&&this.focus[this.depth]!==this.childDataSource.getSource().id&&this.removeChild(),!this.childDataSource&&(0!==this.depth&&(this.focus[this.depth-1],this.source.id),e=this.source.dataSet&&this.source.dataSet.collection.get(this.focus[this.depth]))&&(this.childDataSource=new u(e,this,this.api,this.focus,this.depth+1,this.breakdownColumns),this.childDataSource.subscribe())):(this.removeChild(),this.focus.length!==this.depth||!this.hasDataFlag||0!==this.depth&&this.focus[this.depth-1].toString()!==this.source.id.toString()||this.listener.updateDataSource(this)),1))},u.BREAKDOWN_ID="{breakdownId}";var z=u;function u(e,t,o,a,i,r){this.breakdownColumns=[],this.hasDataFlag=!1,this.focus=[],this.meta={},this.source=e,this.listener=t,this.api=o,this.depth=i||0,this.breakdownColumns=r,this.setFocus(a)}g=i.DeepModel,e(f,g),f.prototype.initialize=function(e){this.el=e.el,this.api=e.api,this.computeHighlightRulesHTML()},f.prototype.computeHighlightRulesHTML=function(){var a=[],e="",i=this.api;_.each(this.api.getProperty("DataSet.Layers"),function(e,o){_.each(e.HighlightRules,function(e,t){e.Show&&a.push({layer:i.getProperty("DataSet.Layers."+o+".Basics.Name"),ruleName:i.getProperty("DataSet.Layers."+o+".HighlightRules."+t+".RuleName"),ruleColor:i.getProperty("DataSet.Layers."+o+".HighlightRules."+t+".RuleColor"),ruleBorder:i.getProperty("DataSet.Layers."+o+".HighlightRules."+t+".RuleBorderColor")})})}),0<a.length&&(e=T.highlighRule(a)),this.el.querySelector(".highlight-rules-dialog").innerHTML=e};var g,W=f;function f(){return null!==g&&g.apply(this,arguments)||this}m=i.DeepModel,e(y,m),y.prototype.initialize=function(e){this.externalDiv=e.externalDiv,this.toolsEnabled=!1,this.app=e.app,this.chart=this.app.chart},y.prototype.computeLegendProp=function(){var l=this,a=this.app,i=this.get("Mode");return{display:!this.get("LegendScroll")&&this.get("Display"),position:this.get("Position")?this.get("Position"):"top",fullWidth:!!this.get("FullWidth"),reverse:!!this.get("Reverse"),labels:{boxWidth:this.get("BoxWidth"),fontSize:parseFloat(this.get("LabelFontSize"))||0,fontColor:this.get("LabelColor"),fontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",padding:this.get("Padding"),usePointStyle:this.get("UsePointStyle"),generateLabels:function(n){var s=n.data;return s.labels.length&&s.datasets.length?s.labels.map(function(e,t){var o=n.getDatasetMeta(0),a=s.datasets[0],i=o.data[t],i=i&&i.custom||{},r=n.options.elements.arc;return{text:e,fillStyle:l.getDefaultProp(i.backgroundColor,a.defaultBackgroundColor,t,r.backgroundColor),strokeStyle:l.getDefaultProp(i.borderColor,a.defaultBorderColor,t,r.borderColor),lineWidth:l.getDefaultProp(i.borderWidth,a.borderWidth,t,r.borderWidth),hidden:isNaN(a.data[t])||o.data[t].hidden,index:t}}):{}}},onClick:function(e,t){var o;"Select Only"===i?a.onClick(t.index):(o=t.index,(t=a.chart).data.datasets.forEach(function(e){_.each(e._meta,function(e){var t=e.data[o];e.data&&e.data[o]&&(t.hidden=!t.hidden)})}),t.update())}}},y.prototype.getDefaultProp=function(e,t,o,a){o=_.isArray(t)?_.get(t,o):t;return e||o||a},y.prototype.onHTMLLegendClick=function(e){var t,o,a,e=e.target;e&&e.matches("li")&&(t=e.innerText,o=this.app.chart,a=o.legend.legendItems.findIndex(function(e){return e.text===t}),o.options.legend.reverse&&(a=o.legend.legendItems.length-1-a),""===e.style.textDecoration?(e.style.textDecoration="line-through",e.style.textDecorationThickness="2px"):e.style.textDecoration="",e.classList.toggle("strike"),_.each(o.data.datasets,function(e){_.each(e._meta,function(e){e.data[a].hidden=!e.data[a].hidden}),o._meta&&o._meta.data&&o._meta.data[a]}),o.update())},y.prototype.renderhtmlLegend=function(e){this.get("LegendScroll")&&this.get("Display")?(this.externalDiv.innerHTML=this.computeLegendHTML(e.legend.legendItems),this.externalDiv.querySelector("ul")&&(this.externalDiv.querySelector("ul").addEventListener("click",_.bind(this.onHTMLLegendClick,this)),this.computehtmlLegendStyle())):this.externalDiv.innerHTML=""},y.prototype.computePaddingAdjustment=function(){var e=this.get("Position"),t=this.toolsEnabled?30:0;return this.computehtmlLegendStyle(),this.get("LegendScroll")&&this.get("Display")?{top:"top"===e?30+t:50,left:"left"===e?100:0,right:"right"===e?100:0,bottom:"bottom"===e?60:5}:{top:t||5,left:0,right:0,bottom:0}},y.prototype.remove=function(){this.externalDiv.querySelector("ul")&&this.externalDiv.querySelector("ul").removeEventListener("click",this.onHTMLLegendClick)},y.prototype.setExtDivPosition=function(e,t,o,a){this.externalDiv.style.top=e,this.externalDiv.style.bottom=t,this.externalDiv.style.left=o,this.externalDiv.style.right=a},y.prototype.setExtDivDimensions=function(e,t){this.externalDiv.style.height=e,this.externalDiv.style.width=t},y.prototype.computehtmlLegendStyle=function(){var e=this.toolsEnabled?30:0;this.get("LegendScroll")?("bottom"===this.get("Position")?(this.setExtDivPosition("",0,"",""),this.setExtDivDimensions("30px","auto")):"top"===this.get("Position")?(this.setExtDivPosition(e||"10px","","",""),this.setExtDivDimensions("30px","auto")):"left"===this.get("Position")?(this.setExtDivPosition(e||"10px","",0,""),this.setExtDivDimensions("auto","100px")):"right"===this.get("Position")&&(this.setExtDivPosition(e||"10px","","","5px"),this.setExtDivDimensions("auto","100px")),this.externalDiv.style.color=this.get("LabelColor"),this.externalDiv.style["font-size"]=this.get("LabelFontSize"),this.externalDiv.style["font-family"]="'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",this.externalDiv.style.width=this.get("BoxWidth"),this.externalDiv.style["margin-right"]=this.get("Padding")+"px",this.externalDiv.style["margin-left"]=this.get("Padding")+"px"):this.setExtDivPosition("",20,"","")},y.prototype.computeLegendHTML=function(e){return T.externalLegend(e)};var m,q=y;function y(){var e=null!==m&&m.apply(this,arguments)||this;return e.toolsEnabled=!0,e}S=i.DeepModel,e(v,S),v.prototype.toPieJSON=function(){return _.chain(this.toJSON()).toPairs().reduce(function(e,t){return e[t[0].toLowerCase()]=t[1],e},{}).value()},v.prototype.customTooltip=function(e,t,o){var a,i=e._model,r=e._view,n={},s=this.api.getProperty("Style.advancedTooltip"),l=_.get(e,"_chart.active[0]._datasetIndex");this.tooltip&&(this.api.removeTooltip(),delete this.tooltip),i.dataPoints&&(a=i.dataPoints[0].index,i&&(n=this.getHandleBarParams(o,e,a,l)),this.tooltip=this.api.setTooltip({data:n,text:s,anchorEl:e._chart.canvas,position:{left:r.caretX||e._eventPosition.x,top:r.caretY||e._eventPosition.y}}))},v.prototype.getHandleBarParams=function(s,l,c,p){var o={},d=s.get("Basics.Data").dataSet.collection,e=d.models[0],e=_.get(e,"attributes")?e.attributes:{},h=[],e=(_.each(l._data.datasets,function(e,t){var o=l._chart.getDatasetMeta(t),a=_.sum(_.map(e.data,function(e,t){return o.data[t].hidden?0:parseFloat(e)})),i=parseFloat(e.data[c]),r=Object.keys(s.chartData)[t],n=s.get("DataSet.Layers."+t+".Segment");void 0!==p&&p!==t||(t=d.models[c],h.push({color:_.isArray(e.backgroundColor)?e.backgroundColor[c]:e.backgroundColor,cols:t?t.attributes:{},isLayerEnabled:!0,label:e.label[c],layerData:i,layerDataFormatted:e.label[c],layerName:""===r?n:r,percent:i/a*100,value:i}))}),_.each(e,function(e,t){o[t]=e}),{dataSet:h,points:h});return _.extend(e,o)},v.Enabled=!1;var S,K=v;function v(e){var t=S.call(this,e)||this;return t.api=e,b.registerHelper("toFixed",function(e,t){return parseFloat(e).toFixed(t)}),b.registerHelper("commaFormat",function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}),b.registerHelper("smartNumber",function(e){e=parseFloat(e);return isNaN(e)?e:h.Tools.smartFormatNumber(e,0)}),t}x=i.DeepModel,e(C,x),C.prototype.computeLayoutProp=function(e){var t=void 0===this.get("Padding.Top")?0:this.get("Padding.Top"),o=void 0===this.get("Padding.Left")?0:this.get("Padding.Left"),a=void 0===this.get("Padding.Bottom")?0:this.get("Padding.Bottom"),i=void 0===this.get("Padding.Right")?0:this.get("Padding.Right");return{padding:{top:t+e.top,left:o+e.left,right:i+e.right,bottom:a+e.bottom}}};var x,Z=C;function C(){return null!==x&&x.apply(this,arguments)||this}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e){if(null===e)throw new TypeError("Cannot convert undefined or null to object");var o=Object(e);return _.each(arguments,function(e){if(null!==e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(o[t]=e[t])}),o},writable:!0,configurable:!0});P.cache=function(l,c,p,d){var e;_.isArray(p.load)&&(e=p.load.reduce(function(e,t,o){var a,i,r,n,s;return l.cache&&((i=l.cache[t]).get("_viewType")&&(i=(a=i).get("value"),r=(n=(c+t).split(".")).pop(),n=n.join("."),s={},r)&&(s[r]=a,d.setProperty(n,s,{bypass:!0})),e[t]=i||p.defaults&&p.defaults[o]),e},{}),l.set(e)),_.isArray(p.store)&&(e=p.store.reduce(function(e,t){var o=(c+t).split("."),a=o.pop();return a&&(e[t]=d.getProperty(o.join("."))[a]),e},{}),_.extend(l.cache,e),e=p.store.reduce(function(e,t){return e[t]=void 0,e},{}),l.set(e))},P.expandNestedViewStates=function(e,o){var a=/([a-zA-Z]+)\.[0-9]+\./,t=Object.keys(e),i=[],r=_.every(t,function(){var e=o.getPropertyMeta(t[0]);return e&&"viewstate"===e.type}),n={};return(i=r?_.uniq(_.filter(_.map(t,function(e){var t=a.exec(e);return t||(n[e]=o.getProperty(e)),t?t[1]:null}))):i).length?(_.each(i,function(e){n[e]=o.getProperty(e)}),n):e},P.focus2Array=function(e){var t=[],o=/"([^"]*)"/g,e=e.toString?e.toString():"",a=/^\[([^\]]*)]$/.exec(e);if(null!==a){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(a[1]))for(var i=void 0;null!==(i=o.exec(a[1]));)t.push(_.map(i[1].split(","),function(e){return e.replace(/&#44;/g,",")}))}else t.push(e.split(","));return _.filter(t,function(e){return 0<(""+e).length})},P.getConditionResult=function(e,t,o){var a,i,r={isMatch:function(e,t){var o,a=!1,i=e.split(/ +and +| +/);for(_.includes(i,"or")&&(i=_.without(i,"or"),a=!0),o=0;o<i.length;o++)0!==i[o].indexOf("-")&&i[o].indexOf("*")<0&&(i[o]="*"+i[o]+"*");return _[a?"some":"every"](i,function(e){return r.isSimpleMatch(e,t)})},isSimpleMatch:function(e,t){var o=!1,e=(0===e.indexOf("-")&&(e=e.replace("-",""),o=!0),new RegExp("^"+e.replace(/\*/g,".*")+"$").test(t));return o?!e:e}},n=!1,s=isNaN(parseFloat(e))||_.isObject(e)?(""+e).toLowerCase():parseFloat(e),l=isNaN(parseFloat(t))||_.isObject(t)?(""+t).toLowerCase():parseFloat(t);switch(e&&e.class&&0<=["1212","1213","1214","1215"].indexOf(e.class)?(s=h.Tools.convertKDBTemporalToMoment(e).unix(),"in"===o?(a=[],_.each(t.toString().split(","),function(e){a.push(h.Tools.convertDateStringValueToMoment(e).unix()),l=a.toString()})):l=h.Tools.convertDateStringValueToMoment(t).unix()):e&&e.class&&0<=["1216","1217","1218","1219"].indexOf(e.class)&&(s=h.Tools.convertKDBTemporalToMoment(e).valueOfNano(),"in"===o?(i=[],_.each(t.toString().split(","),function(e){i.push(h.Tools.convertDateStringValueToMoment(e).valueOfNano()),l=i.toString()})):l=h.Tools.convertDateStringValueToMoment(t).valueOfNano()),o){case"contains":n=0<=s.toString().indexOf(l.toString());break;case"starts with":n=0===s.toString().indexOf(l.toString());break;case"ends with":n=-1!==s.toString().indexOf(l.toString(),s.toString().length-l.toString().length);break;case"==":n=s===l;break;case"<":n=s<l;break;case">":n=l<s;break;case"<=":n=s<=l;break;case">=":n=l<=s;break;case"!=":n=s!==l;break;case"in":n=0<=l.toString().split(",").indexOf(s.toString());break;case"search":n=r.isMatch(l,s);break;case"regexp":n=new RegExp(t.toString()).test(e?e.toString():"")}return n},P.isDuration=function(e){return _.get(e,"_kdbType")&&0<=["1216","1217","1218","1219"].indexOf(e._kdbType)},P.getFormatter=function(a,i,r,n){return"Number"===a||"Formatted Number"===a||"Smart Number"===a||"Datetime"===a||"Currency"===a||"SmartCurrency"===a?function(e){var t,o=e;if(null==(e="Smart Number"!==a&&"Formatted Number"!==a||_.isNumber(e)?e:_.isNumber(parseFloat(e))?parseFloat(e):e))return"";if("Smart Number"===a)o=_.isNumber(e)?h.Tools.smartFormatNumber(e,i):_.escape(e);else{if("Datetime"===a)return t=e,(s.isMoment(e)||s.isDuration(e)?P.isDuration(e)?h.Tools.convertValueToMoment(e.valueOf()):e:h.Tools.isKDBTemporal(e)?h.Tools.convertKDBTemporalToMoment(e):("number"==typeof e&&(t=new Date(e)),h.Tools.convertDateStringValueToMoment(t.toString()))).format(n);o="Formatted Number"===a&&e.toFixed?_.isNaN(e)?"":h.Tools.formatNumber(e,i):e.toFixed?e.toFixed(i):_.escape(o)}if(r&&0<=o.toString().indexOf(".")){for(;"0"===o[o.length-1];)o=o.slice(0,-1);"."===o[o.length-1]&&(o=o.slice(0,-1))}return o}:"Boolean"===a?function(e){return _.escape(e)}:function(e){return s.isMoment(e)||s.isDuration(e)?e.format(n,void 0):e}},P.pump=function(o){var e,a,i;return null==o||!_.isObject(o)||(e=Object.getPrototypeOf(o),_.isObject(o)&&e!==Object.prototype&&e!==Array.prototype)?o:e===Array.prototype&&_.isArray(o)?o.map(P.pump):(a=/^(\d+)((?:\.\w+)+)$/,Object.keys(o).every(function(e){return a.test(e)})?Object.keys(o).map(function(e){var t=a.exec(e);return _.isNil(t)?{index:0,tail:void 0,value:void 0}:{index:Number(t[1]),tail:t[2].substring(1),value:o[e]}}).reduce(function(e,t){var o={},a=void 0===t.index?0:t.index;return o[a]={},o[a][t.tail]=t.value,_.merge(e,P.pump(o))},[]):(i={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/},Object.keys(o).some(function(e){return i.nonGreedy.test(e)})?Object.keys(o).map(function(e){var t=i.greedy.exec(e);return{head:_.isNil(t)?null:t[1],tail:_.isNil(t)||""===t[2]?null:t[2].substring(1),value:o[e]}}).reduce(function(e,t){var o={},a=null!==t.tail,i=_.isNil(t.head)?0:t.head,r=_.isNil(t.tail)?0:t.tail;return a?(o[i]={},o[i][r]=t.value):o[i]=t.value,_.merge(e,P.pump(o))},{}):_.mapValues(o,P.pump)))},P.replaceViewStatesWithValue=function(e,t,o){return P.replaceViewStates(e,t,function(e,t,o,a){return a.value!==o&&console.warn("viewModel value has changed"),a.value},o)},P.alpha=function(e,t){return new Color(e).alpha(t/100).rgbaString()},P.replaceViewStates=function(o,e,l,c){var p;return p=function(e,t){return function o(e,t,a){a=a?a+".":"";var i,r,n=c.getPropertyMeta(a+(t+="")),s=e&&e.has&&e.has("_dataSource")&&e.has("_dataType"),s=(_.isArray(e)||_.isObject(e))&&!s;return n&&"data"===n.type?e:n&&"viewstate"===n.type?(i=(r=(a+t).split(".")).pop(),r=r.join("."),l(r,void 0===i?"":i,e,n)):s?(a+=t,p=function(e,t){return o(e,t,a)},(_.isArray(e)?_.map:_.mapValues)(e,p)):e}(e,t,o||"")},(_.isArray(e)?_.map:_.mapValues)(e,p)};var D=P;function P(){}var w={Trigger:{type:"string",enum:["Click","Hover"],default:"Click",title:"Trigger Action",propertyOrder:2,options:{hidden:!0}}},L=(E.getComponentDefinition=function(e){var t,o,a={id:1,componentName:"PieJS",componentDescription:"",version:"v2.3.0.1",appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"4.7.7",Basics:{Name:"",Data:"",Theme:"Dark",Focus:"",Selected:"",SelectedAttr:"",PopoutSelected:!1,PopoutSelectedSize:10,Actions:[]},DataSet:{Label:"",DonutRatio:50,Rotation:50,Circumference:100,BorderWidth:1,Layers:[{Segment:"",Display:"",UseColor:!0,Color:"#0061FF",BorderColor:"#ffffff",ColorOpacity:85,HighlightRules:[]}]},Legend:{Display:!0,FullWidth:!0,Reverse:!1,Position:"top",LabelColor:"#ffffff",LabelFontFamily:"Helvetica",LabelFontSize:12,BoxWidth:40,Padding:10,UsePointStyle:!0,Mode:"Toggle Hidden",LegendScroll:!1},InnerLabel:{Innertitle:"",InnertitleColor:"#ffffff",InnertitleFont:"Verdana",InnertitleSize:12,ShowPieceLabel:!1,ShowZero:!1,PieceLabelArc:!1,PieceLabelColor:"#ffffff",PieceLabelOverlap:!1,PieceLabelRender:"percentage",PieceLabelPosition:"default",PieceLabelTemplate:"",FontSize:10,Format:"General",Precision:2,HideTrailingZeroes:!1,Prefix:"",Suffix:"",DateFormat:"YYYY-MM-DD"},Padding:{Top:2,Bottom:2,Left:2,Right:2},Animations:{Enabled:!1},Style:{palettes:[],chartBarColors:[{type:"#0061FF"},{type:"#F23A66"},{type:"#009BAB"},{type:"#7647CC"},{type:"#FFC300"},{type:"#9FA3A6"},{type:"#003A99"},{type:"#A90B31"},{type:"#005D67"},{type:"#452481"}],advanced:"",advancedTooltip:'<div> <table>{{#each dataSet}} <tbody> {{#eq @index 0}} <tr> <td colspan="2">{{label}}</td> </tr> {{/eq}} <tr><td>{{xaxis}}</td> <td><svg style="width:20px;height:20px"> <circle fill="{{color}}" stroke-width="2" stroke="white" r="8" cy="10" cx="10"> </circle> </svg></td> <td>{{layerName}} :</td> <td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr> {{/each}} </tbody> </table> </div>'},FileExport:{ShowScreenshot:!1,ShowExportCsvButton:!1,ShowExportExcelButton:!1,ScreenshotButton:"Export Png",FileName:[]},possibleColumns:[""],possibleLabels:[""],possiblePalettes:[""]},schema:{type:"object",title:"Properties",properties:{possibleLabels:{type:"array",propertyOrder:1,format:"table",default:["sym"],options:{collapsed:!0,hidden:!0}},possibleColumns:{propertyOrder:2,type:"array",format:"table",default:["sym"],options:{collapsed:!0,hidden:!0}},possiblePalettes:{propertyOrder:2,type:"array",format:"table",default:[""],options:{collapsed:!0,hidden:!0}},possibleRules:{type:"array",propertyOrder:1,format:"table",default:[],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",propertyOrder:3,title:"Basics",options:{collapsed:!1},properties:{Name:{title:"Name",type:"string",default:""},Data:{type:"data",format:"string",title:"Data Source",default:""},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},Focus:{type:"viewstate",title:"Focus",default:""},Selected:{type:"viewstate",title:"Selected Value",default:""},SelectedAttr:{type:"string",title:"Selected Value Attribute",enumSource:"possible_labels",watch:{possible_labels:"root.possibleLabels"}},PopoutSelected:{type:"boolean",title:"Popout on selection",default:!1,format:"checkbox"},PopoutSelectedSize:{title:"Popout Size",default:10,minimum:1,maximum:100,type:"number",step:1,format:"range"},FixedColumn:{type:"string",title:"Column Def"},Actions:{type:"actions",options:{collapsed:!0},fields:{map:_.extend({Current:{title:"Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},ViewstateProperty:{title:"Viewstate",type:"viewstate"}},w),nav:w,query:w,url:w}}}},DataSet:{type:"object",propertyOrder:4,title:"Data",options:{collapsed:!0},properties:{Label:{propertyOrder:1,default:"",title:"Series Key",type:"customDropdown",data:"possible_labels",watch:{possible_labels:"root.possibleLabels"}},DonutRatio:{title:"Cut out %",propertyOrder:2,default:35,minimum:1,maximum:100,type:"number",step:1,format:"range"},Rotation:{title:"Rotation",propertyOrder:3,default:50,minimum:0,maximum:100,type:"number",step:1,format:"range"},Circumference:{title:"Circumference",propertyOrder:4,default:100,minimum:0,maximum:100,type:"number",step:1,format:"range"},BorderWidth:{title:"Border Width",propertyOrder:5,default:1,minimum:0,maximum:10,type:"number",step:1,format:"range",options:{hidden:!0}},Layers:{type:"array",propertyOrder:8,format:"object",title:"Layers",uniqueItems:!1,options:{collapsed:!0,reset:!0},items:{type:"object",title:"Layer",properties:{Segment:{default:"",title:"Series Data",type:"customDropdown",data:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},Display:{type:"string",default:"",title:"Display"},UseColor:{type:"boolean",title:"Use Colour Palette",default:!0,format:"checkbox"},Color:{type:"gradient",options:{gradient:!1},title:"Color",default:"#0061FF"},BorderColor:{title:"Border Color",type:"gradient",options:{gradient:!1,noColor:!0},default:"#ffffff"},ColorOpacity:{title:"Color Opacity",default:85,minimum:1,maximum:100,type:"number",step:1,format:"range"},HighlightRules:{type:"array",title:"Highlight Rules",options:{collapsed:!0},items:{type:"object",title:"Highlight Rule",properties:{RuleName:{type:"string",title:"Rule Name",default:""},RuleSource:{type:"string",title:"Rule Source",default:"",enumSource:"possible_cols",watch:{possible_cols:"root.possibleColumns"}},RuleOperation:{type:"string",title:"Rule Operation",default:"",enum:["","search","contains","starts with","ends with","==","<",">","<=",">=","!=","Fill Left-to-Right","Fill Right-to-Left"]},RuleValue:{type:"string",title:"Rule Value",data:"possible_columns",default:""},RuleColor:{title:"Rule Colour",type:"gradient",options:{gradient:!1,noColor:!1},default:"#ffffff"},RuleBorderColor:{title:"Rule Border Color",type:"gradient",options:{gradient:!1,noColor:!1},default:"#ffffff"},Show:{title:"Show Rule in Legend",type:"boolean",format:"checkbox",default:!1}}}}}}}}},Legend:{type:"object",title:"Legend",propertyOrder:5,options:{collapsed:!0},properties:{Display:{type:"boolean",format:"checkbox",default:!0},FullWidth:{type:"boolean",title:"Full Width",format:"checkbox",default:!0},Reverse:{type:"boolean",title:"Reverse Order",format:"checkbox",default:!1},Position:{type:"string",default:"top",enum:["top","bottom","left","right"]},LabelColor:{title:"Label Colour",type:"gradient",options:{gradient:!1},default:"#898989"},LabelFontFamily:{type:"string",title:"Label Font Family",options:{hidden:!0},enum:["Helvetica","Arial","Times New Roman","Times","Courier New","Courier","Verdana","Georgia","Palatino","Garamond","Comic Sans MS"],default:"Helvetica"},LabelFontSize:{type:"number",title:"Label Font Size",default:12},BoxWidth:{type:"number",title:"Legend Box Width",default:40},Padding:{type:"number",title:"Legend Box Padding",default:10},UsePointStyle:{type:"boolean",title:"Use Point Style",format:"checkbox",default:!0},LegendScroll:{type:"boolean",title:"Scrolling legends",format:"checkbox",default:!0},Mode:{type:"string",title:"Mode",enum:["Toggle Hidden","Select Only"],default:"Toggle Hidden"}}},Padding:{type:"object",title:"Padding",propertyOrder:5,options:{collapsed:!0},properties:{Left:{type:"number",default:2},Right:{type:"number",default:2},Top:{type:"number",default:2},Bottom:{type:"number",default:2}}},Style:{type:"object",propertyOrder:7,title:"Style",options:{collapsed:!0},properties:{palettes:{propertyOrder:1,default:"",title:"Palette Theme",type:"string",enumSource:"possible_palettes",watch:{possible_palettes:"root.possiblePalettes"}},chartBarColors:{type:"array",format:"table",title:"Color Palette",propertyOrder:2,options:{collapsed:!1},uniqueItems:!1,items:{type:"object",title:"Bar Colour",properties:{type:{type:"gradient",options:{gradient:!1},title:"color",default:"#ffa500"}}},default:[{type:"#0061FF"},{type:"#7995b8"},{type:"#808387"},{type:"#a69775"},{type:"#749450"},{type:"#51966a"},{type:"#e2c7c0"},{type:"#9acad6"},{type:"#1995a3"},{type:"#484d6e"}]},advanced:{type:"css",title:"Advanced CSS",propertyOrder:2,default:""},advancedTooltip:{data:["xaxis","yaxis","key","color"],default:"",propertyOrder:3,title:"Custom tooltip",templateItems:{points:{type:"array",items:{layerName:"layerName",layerData:"layerData",layerDataFormatted:"layerDataFormatted",colors:{backgroundColor:"backgroundColor",borderColor:"borderColor"},cols:null,isLayerEnabled:"isLayerEnabled"}}},type:"tooltipTemplate"}}},FileExport:{type:"object",propertyOrder:320,title:"File Export",options:{collapsed:!0},properties:{ShowExportCsvButton:{type:"boolean",title:"Show Export Csv Button",default:!1,format:"checkbox"},ShowExportExcelButton:{type:"boolean",title:"Show Export Excel Button",default:!1,format:"checkbox"},ShowScreenshot:{type:"boolean",title:"Show Screenshot Button",default:!1,format:"checkbox"},ScreenshotButton:{default:"Export Png",enum:["Export Png","Copy to Clipboard","Export Png & Copy to Clipboard"],title:"Screenshot Button",type:"string"},FileName:{type:"array",format:"table",title:"FileName",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Filename Part",options:{collapsed:!0},properties:{FileNamePart:{title:"FileName Part",type:"string"}}}}}},Animations:{type:"object",propertyOrder:6,options:{collapsed:!0},properties:{Enabled:{type:"boolean",format:"checkbox",default:!1},Easing:{type:"string",enum:["linear","easeInQuad","easeOutQuad","easeInOutQuad","easeInCubic","easeOutCubic","easeInOutCubic","easeInQuart","easeOutQuart","easeInOutQuart","easeInQuint","easeOutQuint","easeInOutQuint","easeInSine","easeOutSine","easeInOutSine","easeInExpo","easeOutExpo","easeInOutExpo","easeInCirc","easeOutCirc","easeInOutCirc","easeInElastic","easeOutElastic","easeInOutElastic","easeInBack","easeOutBack","easeInOutBack","easeInBounce","easeOutBounce","easeInOutBounce"],default:""},Duration:{type:"number",format:"number",default:0}}},InnerLabel:{type:"object",propertyOrder:5,title:"Labels",options:{collapsed:!0},properties:{Innertitle:{type:"string",title:"Inner Label",propertyOrder:1,default:""},InnertitleFont:{type:"string",title:"Inner Label Font",propertyOrder:2,enum:["Verdana","fontawesome","Arial","Helvetica","Times","Courier"],default:"Verdana"},InnertitleSize:{type:"number",title:"Inner Label Size",propertyOrder:3,default:12},InnertitleColor:{type:"gradient",title:"Inner Label Color",propertyOrder:6,default:"#ffffff"},ShowPieceLabel:{title:"Show Piece Label",propertyOrder:7,type:"boolean",format:"checkbox",default:!1},ShowZero:{title:"Piece Label Show Zero ",propertyOrder:8,type:"boolean",format:"checkbox",default:!1},PieceLabelArc:{title:"Piece Label Arc",propertyOrder:9,type:"boolean",format:"checkbox",default:!1},PieceLabelOverlap:{title:"Piece Label Overlap",propertyOrder:10,type:"boolean",format:"checkbox",default:!1},PieceLabelRender:{title:"Piece Label Type",propertyOrder:11,type:"string",enum:["label","value","percentage"],default:"percentage"},PieceLabelTemplate:{default:"",propertyOrder:12,templateItems:{values:{items:_.keyBy(["percentage","value","label"]),type:"object"}},title:"Piece Label Template",type:"tooltipTemplate"},PieceLabelPosition:{title:"Piece Label Position",propertyOrder:13,type:"string",enum:["default","border","outside"],default:"default"},PieceLabelColor:{title:"Piece Label Colour",propertyOrder:14,type:"gradient",default:"#ffffff"},FontSize:{title:"Piece Font Size",propertyOrder:15,type:"number",default:12},Format:{type:"string",propertyOrder:16,enum:["General","Number","Smart Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:17,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},HideTrailingZeroes:{type:"boolean",propertyOrder:18,title:"Hide Trailing Zeroes",format:"checkbox",default:!1},DateFormat:{type:"string",propertyOrder:19,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:20,default:""},Suffix:{type:"string",propertyOrder:21,default:""}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(o=E.upgrades.indexOf(_.find(E.upgrades,{version:e.settingsModel.get("version")}))+1;o<E.upgrades.length;o+=1)(t=E.upgrades[o]).fn(e.settingsModel),e.settingsModel.set("version",t.version);return a},E);function E(){}function k(){this.drawDataset=this.drawDataset.bind(this)}function F(e,t){if(function(e){if(e.options.pieceLabel){var t=1;if(Array.isArray(e.options.pieceLabel)&&(t=e.options.pieceLabel.length),!e.pieceLabel||t!==e.pieceLabel.length){e.pieceLabel=[];for(var o=0;o<t;++o)e.pieceLabel.push(new k)}}else e.pieceLabel&&delete e.pieceLabel;return e.pieceLabel}(e))for(var o=0;o<e.pieceLabel.length;++o)e.pieceLabel[o][t](e,o)}L.upgrades=[{version:0,fn:function(){}},{version:"4.1.0.3",fn:function(e){var t=e.get("InnerLabel");t.Format=void 0===t.Format?"General":t.Format,t.Precision=void 0===t.Precision?2:t.Precision,t.HideTrailingZeroes=void 0!==t.HideTrailingZeroes&&t.HideTrailingZeroes,t.Prefix=void 0===t.Prefix?"":t.Prefix,t.Suffix=void 0===t.Suffix?"":t.Suffix,t.DateFormat=void 0===t.DateFormat?"YYYY-MM-DD":t.DateFormat,e.set("InnerLabel",t)}},{version:"4.1.0s4b",fn:function(e){var t=e.get("FileExport"),o=e.get("Padding"),a=e.get("DataSet.Layers");void 0===t?(e.set("FileExport.ShowExportCsvButton",!1),e.set("FileExport.ShowExportExcelButton",!1),e.set("FileExport.ShowScreenshot",!1),e.set("FileExport.FileName",[])):e.set("FileExport",t),void 0===o&&e.set("Padding",{Right:2,Bottom:2,Left:2,Top:2}),_.each(a,function(e){e.BorderColor=void 0===e.BorderColor?"#ffffff":e.BorderColor})}},{version:"4.2.1",fn:function(e){e.set("InnerLabel.InnertitleSize",0)}},{version:"4.3.1",fn:function(e){var t=e.get("Basics"),o=e.get("Legend"),a=e.get("InnerLabel"),i=(t.PopoutSelected=void 0!==t.PopoutSelected&&t.PopoutSelected,t.PopoutSelectedSize=void 0===t.PopoutSelectedSize?10:t.PopoutSelectedSize,o.Mode=void 0===o.Mode?"Toggle Hidden":o.Mode,t.SelectedObjectRouting);i?(i=_.map(i,function(e){return{_Type:"map",Trigger:"Click",Current:e.ColumnProperty,Target:e.ViewstateProperty}}),e.set("Basics",t),e.set("Legend",o),e.set("Basics.Actions",i),e.unset("Basics.SelectedObjectRouting"),a.FontSize=void 0===a.FontSize?10:a.FontSize,e.set("InnerLabel",a)):(e.set("Basics.Actions",[]),e.unset("Basics.SelectedObjectRouting"))}},{version:"4.5.1",fn:function(e){var t=e.get("InnerLabel"),o=e.get("Style"),a=e.get("Legend");t.PieceLabelTemplate=void 0===t.PieceLabelTemplate?"":t.PieceLabelTemplate,e.set("InnerLabel",t);'<div><span>{{dataSet.0.label}}</span><br><table>{{#each dataSet}}<tr><td>{{xaxis}}</td><td><svg style="width:20px;height:20px"><circle cx="10" cy= "10" r="8" stroke="white" stroke-width="2" fill= "{{color}}" > </circle></svg> </td><td>{{layerData}} :</td><td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr>{{/each}} </table></div>'===o.advancedTooltip?o.advancedTooltip='<div> <table>{{#each dataSet}} <tbody> {{#eq @index 0}} <tr> <td colspan="2">{{label}}</td> </tr> {{/eq}} <tr><td>{{xaxis}}</td> <td><svg style="width:20px;height:20px"> <circle fill="{{color}}" stroke-width="2" stroke="white" r="8" cy="10" cx="10"> </circle> </svg></td> <td>{{layerName}} :</td> <td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr> {{/each}} </tbody> </table> </div>':(t=new RegExp("{{layerData}}","g"),o.advancedTooltip=o.advancedTooltip.replace(t,"{{layerName}}")),e.set("Style",o),a.Mode="Toogle Hidden"===a.Mode?"Toggle Hidden":a.Mode,e.set("Legend",a)}},{version:"4.7.7",fn:function(e){e.get("Basics.Name")||e.set("Basics.Name","")}},{version:"v2.3.0.1",fn:function(e){void 0===e.get("FileExport.ScreenshotButton")&&e.set("FileExport.ScreenshotButton","Export Png")}}],"undefined"==typeof Chart?console.warn("Can not find Chart object."):(Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),k.prototype.beforeDatasetsUpdate=function(e,t){this.parseOptions(e,t),"outside"===this.position&&(t=1.5*this.fontSize+this.outsidePadding,e.chartArea.top+=t,e.chartArea.bottom-=t)},k.prototype.afterDatasetsDraw=function(e,t){this.parseOptions(e,t),this.labelBounds=[],e.config.data.datasets.forEach(this.drawDataset)},k.prototype.drawDataset=function(e){for(var t=this.ctx,o=this.chartInstance,a=e._meta[Object.keys(e._meta)[0]],i=0,r=0;r<a.data.length;r++){var n,s,l,c,p,d,h,u,g,f=a.data[r],m=f._view,y=void 0;if(0!==m.circumference||this.showZero){switch(this.render){case"value":var b=e.data[r],y=(b=this.format?this.format(b):b).toString();break;case"advanced":b=e.data[r];y=(b=this.format?this.format(b):b).toString();break;case"label":y=o.config.data.labels[r];break;case"image":y=this.images[r]?this.loadImage(this.images[r]):"";break;default:var S=m.circumference/this.options.circumference*100,S=parseFloat(S.toFixed(this.precision));this.showActualPercentages||100<(i+=S)&&(S-=i-100,S=parseFloat(S.toFixed(this.precision))),y=S+"%"}(y="function"==typeof this.render&&"object"==typeof(y=this.render({label:o.config.data.labels[r],value:e.data[r],percentage:S,dataset:e,index:r}))?this.loadImage(y):y)&&(t.save(),t.beginPath(),t.font=Chart.helpers.fontString(this.fontSize,this.fontStyle,this.fontFamily),"outside"===this.position||"border"===this.position?(s=m.outerRadius/2,p=this.fontSize+this.textMargin,c=m.startAngle+(m.endAngle-m.startAngle)/2,"border"===this.position?l=(m.outerRadius-s)/2+s:"outside"===this.position&&(this.arc||(p=this.textMargin),l=m.outerRadius-s+s+p),c={x:m.x+Math.cos(c)*l,y:m.y+Math.sin(c)*l},"outside"===this.position&&(this.arc||(p+=this.measureText(y).width/2),c.x<m.x?c.x-=p:c.x+=p,n=m.outerRadius+p)):(s=m.innerRadius,c=f.tooltipPosition()),"function"==typeof(p=this.fontColor)?p=p({label:o.config.data.labels[r],value:e.data[r],percentage:S,text:y,backgroundColor:e.backgroundColor[r],dataset:e,index:r}):"string"!=typeof p&&(p=p[r]||this.options.defaultFontColor),this.arc?(n=n||(s+m.outerRadius)/2,t.fillStyle=p,t.textBaseline="middle",this.drawArcText(y,n,m,this.overlap)):(g=this.measureText(y),d=c.x-g.width/2,h=c.x+g.width/2,u=c.y-g.height/2,g=c.y+g.height/2,(!!this.overlap||("outside"===this.position?this.checkTextBound(d,h,u,g):f.inRange(d,u)&&f.inRange(d,g)&&f.inRange(h,u)&&f.inRange(h,g)))&&this.fillText(y,c,p)),t.restore())}}},k.prototype.parseOptions=function(e,t){var o=e.options.pieceLabel;Array.isArray(o)&&(o=o[t]),this.chartInstance=e,this.ctx=e.chart.ctx,this.options=e.config.options,this.render=o.render||o.mode,this.position=o.position||"default",this.arc=o.arc,this.format=o.format,this.precision=o.precision||0,this.fontSize=o.fontSize||this.options.defaultFontSize,this.fontColor=o.fontColor||this.options.defaultFontColor,this.fontStyle=o.fontStyle||this.options.defaultFontStyle,this.fontFamily=o.fontFamily||this.options.defaultFontFamily,this.shadowOffsetX=o.shadowOffsetX||3,this.shadowOffsetY=o.shadowOffsetY||3,this.shadowColor=o.shadowColor||"rgba(0,0,0,0.3)",this.shadowBlur=o.shadowBlur||6,this.textShadow=o.textShadow||!1,this.hasTooltip=e.tooltip._active&&e.tooltip._active.length,this.showZero=o.showZero,this.overlap=o.overlap,this.images=o.images||[],this.outsidePadding=o.outsidePadding||2,this.textMargin=o.textMargin||2,this.showActualPercentages=o.showActualPercentages||!1},k.prototype.checkTextBound=function(e,t,o,a){for(var i=this.labelBounds,r=0;r<i.length;++r){for(var n=i[r],s=[[e,o],[e,a],[t,o],[t,a]],l=0;l<s.length;++l){var c=s[l][0],p=s[l][1];if(c>=n.left&&c<=n.right&&p>=n.top&&p<=n.bottom)return!1}for(s=[[n.left,n.top],[n.left,n.bottom],[n.right,n.top],[n.right,n.bottom]],l=0;l<s.length;++l){c=s[l][0],p=s[l][1];if(e<=c&&c<=t&&o<=p&&p<=a)return!1}}return i.push({left:e,right:t,top:o,bottom:a}),!0},k.prototype.measureText=function(e){if("object"==typeof e)return{width:e.width,height:e.height};for(var t=0,o=e.split("\n"),a=0;a<o.length;++a){var i=this.ctx.measureText(o[a]);i.width>t&&(t=i.width)}return{width:t,height:this.fontSize*o.length}},k.prototype.fillText=function(e,t,o){var a=this.ctx;if("object"==typeof e)a.drawImage(e,t.x-e.width/2,t.y-e.height/2,e.width,e.height);else{a.save(),a.fillStyle=o,a.textBaseline="top",a.textAlign="center",this.textShadow&&(a.shadowOffsetX=this.shadowOffsetX,a.shadowOffsetY=this.shadowOffsetY,a.shadowColor=this.shadowColor,a.shadowBlur=this.shadowBlur);for(var i=e.split("\n"),r=0;r<i.length;r++){var n=t.y-this.fontSize/2*i.length+this.fontSize*r;a.fillText(i[r],t.x,n)}a.restore()}},k.prototype.loadImage=function(e){var t=new Image;return t.src=e.src,t.width=e.width,t.height=e.height,t},k.prototype.drawArcText=function(e,t,o,a){var i=this.ctx,r=o.x,n=o.y,s=o.startAngle,o=o.endAngle,r=(i.save(),i.translate(r,n),o-s),n=s+=Math.PI/2;if(s+=((o+=Math.PI/2)-((h=this.measureText(e)).width/t+s))/2,a||!(r<o-s))if("string"==typeof e){i.rotate(s);var l=e.split("\n"),c=0,p=[],d=0;"border"===this.position&&(d=(l.length-1)*this.fontSize/2);for(var h,u=0;u<l.length;++u)(h=i.measureText(l[u])).width>c&&(c=h.width),p.push(h.width);for(u=0;u<l.length;++u){var g=l[u],f=(l.length-1-u)*-this.fontSize+d,m=(i.save(),(c-p[u])/2);i.rotate(m/t);for(var y=0;y<g.length;y++){var b=g.charAt(y);h=i.measureText(b),i.save(),i.translate(0,-1*t),i.fillText(b,0,f),i.restore(),i.rotate(h.width/t)}i.restore()}}else i.rotate((n+o)/2),i.translate(0,-1*t),this.fillText(e,{x:0,y:0});i.restore()},Chart.pluginService.register({beforeDatasetsUpdate:function(e){F(e,"beforeDatasetsUpdate")},afterDatasetsDraw:function(e){F(e,"afterDatasetsDraw")}}));O.app=b.template({compiler:[8,">= 4.3.0"],main:function(e,t,o,a,i){return'<div class="chart-container">\n    <canvas class="chart"></canvas>\n    <div class="chartjs-tooltip" style="display:none"></div>\n</div>\n<div class="highlight-rules-dialog" title="Highlight Rules"></div>\n<div class="chart-legend"></div>'},useData:!0}),O.externalLegend=b.template({1:function(e,t,o,a,i){var r,n=null!=t?t:e.nullContext||{},s=e.hooks.helperMissing,l="function",c=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'        <li><span style="background-color:'+c(typeof(r=null!=(r=e(o,"fillStyle")||(null!=t?e(t,"fillStyle"):t))?r:s)==l?r.call(n,{name:"fillStyle",hash:{},data:i,loc:{start:{line:3,column:42},end:{line:3,column:55}}}):r)+'; border-color:#fffff"></span>'+c(typeof(r=null!=(r=e(o,"text")||(null!=t?e(t,"text"):t))?r:s)==l?r.call(n,{name:"text",hash:{},data:i,loc:{start:{line:3,column:85},end:{line:3,column:93}}}):r)+"</li>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,o,a,i){return'<ul class="5-legend">\n'+(null!=(o=(e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]})(o,"each").call(null!=t?t:e.nullContext||{},t,{name:"each",hash:{},fn:e.program(1,i,0),inverse:e.noop,data:i,loc:{start:{line:2,column:4},end:{line:4,column:13}}}))?o:"")+"</ul>"},useData:!0}),O.fileExporter=b.template({compiler:[8,">= 4.3.0"],main:function(e,t,o,a,i){var r=null!=t?t:e.nullContext||{},n=e.hooks.helperMissing,s=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="tools-panel">\n    <div class="pnlButtons">\n        <span class="lnksExport link-disabled">\n            <i class="fa fa-fw fa-download" title="'+s((e(o,"t")||t&&e(t,"t")||n).call(r,"Data",{name:"t",hash:{},data:i,loc:{start:{line:4,column:51},end:{line:4,column:63}}}))+'"></i>\n            <a class="lnkExcelExport" title="'+s((e(o,"t")||t&&e(t,"t")||n).call(r,"Download the current dataset in Excel format",{name:"t",hash:{},data:i,loc:{start:{line:5,column:45},end:{line:5,column:97}}}))+'">'+s((e(o,"t")||t&&e(t,"t")||n).call(r,"Excel",{name:"t",hash:{},data:i,loc:{start:{line:5,column:99},end:{line:5,column:112}}}))+'</a>\n            <a class="lnkCsvExport" title="'+s((e(o,"t")||t&&e(t,"t")||n).call(r,"Download the current dataset in CSV format",{name:"t",hash:{},data:i,loc:{start:{line:6,column:43},end:{line:6,column:93}}}))+'">'+s((e(o,"t")||t&&e(t,"t")||n).call(r,"CSV",{name:"t",hash:{},data:i,loc:{start:{line:6,column:95},end:{line:6,column:106}}}))+'</a>\n            <a class="lnkDownloadScreenshot" title="'+s((e(o,"t")||t&&e(t,"t")||n).call(r,"Download a PNG image of the chart",{name:"t",hash:{},data:i,loc:{start:{line:7,column:52},end:{line:7,column:93}}}))+'">'+s((e(o,"t")||t&&e(t,"t")||n).call(r,"PNG",{name:"t",hash:{},data:i,loc:{start:{line:7,column:95},end:{line:7,column:106}}}))+"</a>\n        </span>\n    </div>\n</div>"},useData:!0}),O.highlighRule=b.template({1:function(e,t,o,a,i){var r,n=null!=t?t:e.nullContext||{},s=e.hooks.helperMissing,l="function",c=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="highlightRule-menu-item">\n    <svg>\n        <rect x="2" y="5" width="10" height="10" stroke="'+c(typeof(r=null!=(r=e(o,"ruleBorder")||(null!=t?e(t,"ruleBorder"):t))?r:s)==l?r.call(n,{name:"ruleBorder",hash:{},data:i,loc:{start:{line:4,column:57},end:{line:4,column:71}}}):r)+'" fill="'+c(typeof(r=null!=(r=e(o,"ruleColor")||(null!=t?e(t,"ruleColor"):t))?r:s)==l?r.call(n,{name:"ruleColor",hash:{},data:i,loc:{start:{line:4,column:79},end:{line:4,column:92}}}):r)+'" stroke-width="2"></rect>\n    </svg>\n    <span>&nbsp;'+c(typeof(r=null!=(r=e(o,"layer")||(null!=t?e(t,"layer"):t))?r:s)==l?r.call(n,{name:"layer",hash:{},data:i,loc:{start:{line:6,column:16},end:{line:6,column:25}}}):r)+"&nbsp;("+c(typeof(r=null!=(r=e(o,"ruleName")||(null!=t?e(t,"ruleName"):t))?r:s)==l?r.call(n,{name:"ruleName",hash:{},data:i,loc:{start:{line:6,column:32},end:{line:6,column:44}}}):r)+")</span>\n</div>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,o,a,i){return null!=(o=(e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]})(o,"each").call(null!=t?t:e.nullContext||{},t,{name:"each",hash:{},fn:e.program(1,i,0),inverse:e.noop,data:i,loc:{start:{line:1,column:0},end:{line:8,column:9}}}))?o:""},useData:!0}),O.htmlLegend=b.template({1:function(e,t,o,a,i){var r,n=null!=t?t:e.nullContext||{},s=e.hooks.helperMissing,l="function",c=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'        <li><span style="background-color:'+c(typeof(r=null!=(r=e(o,"fillStyle")||(null!=t?e(t,"fillStyle"):t))?r:s)==l?r.call(n,{name:"fillStyle",hash:{},data:i,loc:{start:{line:3,column:42},end:{line:3,column:55}}}):r)+'; border-color:#fffff"></span>'+c(typeof(r=null!=(r=e(o,"text")||(null!=t?e(t,"text"):t))?r:s)==l?r.call(n,{name:"text",hash:{},data:i,loc:{start:{line:3,column:85},end:{line:3,column:93}}}):r)+"</li>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,o,a,i){return'<ul class="5-legend">\n'+(null!=(o=(e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]})(o,"each").call(null!=t?t:e.nullContext||{},t,{name:"each",hash:{},fn:e.program(1,i,0),inverse:e.noop,data:i,loc:{start:{line:2,column:4},end:{line:4,column:13}}}))?o:"")+"</ul>"},useData:!0});var T=O;function O(){}M.getConfig=function(e){var o,a=this,t={".csv":"Csv",".xlsx":"Excel"}[e.fileFormat],i={configSets:{},fileFormat:e.fileFormat,fileName:h.ExportTools.getExportFileName(e.fileName,"",t),workSheetTitle:e.workSheetTitle,metaData:[],dataSet:{}},r=e.columnsConfig,n=r.dataSource;return i.fileName=h.ExportTools.getExportFileName(e.fileName,"",t),i.fileFormat=e.fileFormat,i.workSheetTitle=e.workSheetTitle,n&&(i.dataSet=n.getData().toJSON(),o=r.formats.PieceLabelRender,i.metaData=[this.getExportMetaData({colId:r.labelColId,colFormats:r.formats,kdbType:n.getColumnType(r.labelColId)},"label")],_.each(r.layersIds,function(e){var e="label"===o?r.labelColId:e,t=h.ExportTools.regExValidateColumnIDs(e,n.getColumnNames());0<t.length?t.forEach(function(e){i.metaData.push(a.getExportMetaData({colId:e,colFormats:r.formats,kdbType:n.getColumnType(e)},"layers"))}):console.log("Column with id: '"+e+"' not found")})),i},M.getExportMetaData=function(e,t){var o,a={},i=e.kdbType,r="",n="",s="",l=!1;if("label"===t)switch(i){case 1:o="Boolean";break;case 4:case 5:case 6:case 7:case 8:case 9:o="Number";break;case 15:o="Datetime",s="YYYY-MM-DD HH:mm:ss.SSS";break;case 13:o="Datetime",s="MMM YYYY";break;case 14:case 16:o="Datetime",s="YYYY-MM-DD";break;case 17:o="Datetime",s="HH:mm";break;case 18:o="Datetime",s="HH:mm:ss";break;case 19:o="Datetime",s="HH:mm:ss.SSS";break;default:o="String"}else r=e.colFormats.Prefix,n=e.colFormats.Suffix,o=e.colFormats.Format,s=e.colFormats.DateFormat,l=e.colFormats.HideTrailingZeroes;t=this.resolveColumnTypeAndFormat(o,s,e.colFormats.Precision,i);return a.colId=e.colId,a.colName=e.colId,a.dataType=t.dataType,a.dataKdbType=t.dataKdbType,a.dataFormat=t.dataFormat,a.hideTrailingZeroes=l,a.prefix=r,"percentage"===e.colFormats.PieceLabelRender?a.suffix="":a.suffix=n,a},M.resolveColumnTypeAndFormat=function(e,t,o,a){var i=11<a&&a<20,r=o?"."+Array(o+1).join("0"):"";switch((3===a||a<1||19<a)&&(a=11,t="TO_STRING",e="String"),e){case"Number":t="#0"+r;break;case"Smart Number":e="Number",t="SmartNumber"+r;break;case"Datetime":e=h.ExportTools.getTemporalTypeFromFormat(t),t=h.ExportTools.CHARTS_DATE_FORMAT_MAP[t],t=i?t||"":(e="String","");break;default:e="String",t=""}return{dataType:e=1===a?"Boolean":e,dataFormat:t,dataKdbType:a}},M.getValidPrecission=function(e){var t=void 0!==e?e:0;return t<0?(t=0,console.info("Invalid precission, should be between in range of 0 and 10, got: ",e)):10<t&&(t=10,console.info("Invalid precission, should be between in range of 0 and 10, got: ",e)),t};var G=M;function M(){}B=i.View,e(I,B),I.prototype.remove=function(){return this.lnkCsvExport&&this.fileExportCSV&&this.lnkCsvExport.removeEventListener("click",this.fileExportCSV),this.lnkExcelExport&&this.fileExportXLSX&&this.lnkExcelExport.removeEventListener("click",this.fileExportXLSX),this.lnkDownloadScreenshot&&this.fileExportPNG&&this.lnkDownloadScreenshot.removeEventListener("click",this.fileExportPNG),this.stopListening(),i.View.prototype.remove.apply(this)},I.prototype.initializeEvents=function(){this.listenTo(this.model,"change",this.displayChoiceLinkButtons.bind(this)),this.lnkCsvExport&&this.lnkExcelExport&&this.lnkDownloadScreenshot&&(this.fileExportCSV=this.fileExport.bind(this,".csv"),this.fileExportXLSX=this.fileExport.bind(this,".xlsx"),this.fileExportPNG=this.downloadImage.bind(this,".png"),this.lnkCsvExport.addEventListener("click",this.fileExportCSV),this.lnkExcelExport.addEventListener("click",this.fileExportXLSX),this.lnkDownloadScreenshot.addEventListener("click",this.fileExportPNG))},I.prototype.displayChoiceLinkButtons=function(){var e=this.model.get("FileExport");!e||_.keys(e).length<5||(this.api.hasPermission(h.CustomAPIPermission.canExportData)&&(e.ShowExportCsvButton||e.ShowExportExcelButton||e.ShowScreenshot)?(this.lnkCsvExport&&this.lnkExcelExport&&this.lnkDownloadScreenshot&&this.lnksExport&&(this.lnksExport.classList.remove("link-disabled"),this.lnkCsvExport.classList.toggle("link-disabled",!e.ShowExportCsvButton),this.lnkExcelExport.classList.toggle("link-disabled",!e.ShowExportExcelButton),this.lnkDownloadScreenshot.classList.toggle("link-disabled",!e.ShowScreenshot)),this.chartContainer.classList.toggle("links-enabled",!this.chartContainer.classList.contains("links-enabled")),e.Enabled||this.model.set("FileExport.Enabled",!0)):(this.lnksExport&&this.lnksExport.classList.add("link-disabled"),this.chartContainer.classList.remove("links-enabled"),e.Enabled&&this.model.set("FileExport.Enabled",!1)))},I.prototype.downloadImage=function(e){var o=h.ExportTools.getExportFileName(this.getExportConfig().fileName,"","Screenshot"),a=this.appView.api,i=this.appView.dashboardViewModel.get("selectedDocumentId"),r=a.getDashboardName(i),n=this.getExportConfig(),o=("string"==typeof o?o:"Screenshot")+e;this.generateImage(function(e,t){h.Tools.fileSave(o,e,t),a.onTransferAction({actions:a.getProperty("FileExport.Actions"),component:"Pie JS",dashboardId:i,dashboardName:r,fileLength:_.get(n,"columnsConfig.dataSource.source.dataSet.collection.length")},o,_.get(n,"columnsConfig.dataSource.meta"),"success","png",a.humanFileSize(e.size))})},I.prototype.fileExport=function(e){var t=this.appView.dashboardViewModel.get("selectedDocumentId"),o=this.appView.api.getDashboardName(t),a=h.ExportTools,e=G.getConfig(_.extend(this.getExportConfig(),{fileFormat:e}));e.actions=this.appView.api.getProperty("FileExport.Actions"),e.selectedDashboard={dashboardId:t,dashboardName:o},a.openFileExportDialog(e)},I.prototype.generateImage=function(t){var e,o,a=this,i=this.getCanvas(),r=i.width,n=i.height,s=document.createElement("canvas"),l="Light"===this.getTheme()?"#F8F8F8":"#282828";i&&(s.width=r,s.height=n,e=s.getContext("2d"))&&(e.fillStyle=l,e.fillRect(0,0,r,n),e.drawImage(i,0,0),o=this.api.getProperty("FileExport.ScreenshotButton"),this.isIE?-1<o.indexOf("Export Png")&&(l=s.toDataURL("image/png"),t(h.Tools.convertDataUrlToBlob(l),"image/png")):e.canvas.toBlob(function(e){-1<o.indexOf("Export Png")&&t(e,"application/octet-stream"),-1<o.indexOf("Copy to Clipboard")&&e&&h.Tools.copyToClipboard(e,"Pie Chart",a.api)}))},I.prototype.getTheme=function(){return this.appView.dashboardViewModel.get("DashboardTheme")},I.prototype.renderLinks=function(){this.lnksExport=this.el.querySelector(".lnksExport"),this.lnkCsvExport=this.el.querySelector("a.lnkCsvExport"),this.lnkExcelExport=this.el.querySelector("a.lnkExcelExport"),this.lnkDownloadScreenshot=this.el.querySelector("a.lnkDownloadScreenshot")};var B,R,U=I;function I(e){var t=B.call(this,e)||this;return t.api=e.api,t.getCanvas=e.getCanvas,t.appView=e.appView,t.getExportConfig=e.getExportConfig,t.isIE=!1,HTMLCanvasElement&&HTMLCanvasElement.prototype&&_.get(HTMLCanvasElement.prototype,"msToBlob")&&(t.isIE=!0),t.chartContainer=t.appView.el.querySelector(".chart-container"),t.render(),t.renderLinks(),t.initializeEvents(),t}function N(e){var a=R.call(this,e)||this,o=(a.focus=[],a.isReadyForThemeChange=!1,a.layers=new V,a.dataSources={},a.errors={},a.globalPalette=[],_.extend(a,_.pick(e,["api","dashboardViewModel"])),a.api=e.api,a.onSettingsChange.bind(a));return a.onSettingsChange=function(e){var t=this.onSettingsChange!==(this.onSettingsChange=o);this.onSettingsChange(e),t&&(this.isReadyForThemeChange=!0,this.setThemeAccordingToDashboardSettings())}.bind(a),a.el.innerHTML=T.app({id:a.id}),a.ctx=a.el.querySelector(".chart-container").querySelector("canvas").getContext("2d"),a.defaultOptions={maintainAspectRatio:!1,responsive:!0,animation:{duration:0}},a.listenTo(a.layers,"add",function(){this.setThemeAccordingToDashboardSettings()}),a.listenTo(a.layers,"reset",function(){this.setThemeAccordingToDashboardSettings()}),a.listenTo(a.layers,"remove",function(e){e.stopListening()}),a.listenTo(a.layers,"update",function(e,t){a.updatePossibleLayers();var o=0<t.changes.added.length+t.changes.removed.length;_.throttle(function(){!o&&a.animation&&a.animation.get("Enabled")?a.updateChart():a.initializeChart()})}),a.highlightRulesModel=new W({el:a.el,api:a.api}),a.legendModel=new q({externalDiv:a.el.querySelector(".chart-legend"),app:a}),a.listenTo(a.legendModel,"change",a.initializeChart.bind(a)),a.layoutModel=new Z,a.listenTo(a.layoutModel,"change",a.initializeChart.bind(a)),a.animation=new Y,a.listenTo(a.animation,"change",a.updateChart.bind(a)),a.tooltips=new K(a.api),a.fileExportModel=new i.DeepModel,a.fileExporterView=new U({model:a.fileExportModel,el:T.fileExporter({id:a.id}),api:a.api,appView:a,getCanvas:function(){return a.ctx.canvas},getExportConfig:function(){var e=a.layers.at(0);return{columnsConfig:{dataSource:a.dataSources[e.get("Basics.Data").cid],layersIds:_.map(e.get("DataSet.Layers"),"Segment"),labelColId:e.get("DataSet.Label"),formats:e.get("InnerLabel")},fileName:a.fileExportModel.get("FileExport.FileName"),altFileName:"",workSheetTitle:"Pie JS"}}}),a.el.prepend(a.fileExporterView.el),a.listenTo(a.fileExportModel,"change:FileExport.Enabled",a.toggleToolsPanel.bind(a)),a.globalPalette=e.dashboardAppModel.get("globalPalettes"),a.api.setProperty("possiblePalettes",_.map(_.uniqBy(a.globalPalette,"rule"),"rule")),a}return R=i.View,e(N,R),N.prototype.onSettingsChange=function(e){var e=D.expandNestedViewStates(e,this.api),e=D.replaceViewStatesWithValue("",e,this.api),t=D.pump(e);e.hasOwnProperty("Layers")&&(t.Layers=e.Layers),this.onSettingsChangeProcessed.call(this,t)},N.prototype.updateError=function(e,t){function o(e){return"Error"===e?3:"Loading"===e?2:"NoResults"===e?1:0}var a=this,e=e.getKey(),t=(t?this.errors[e]=t:delete this.errors[e],_.reduce(this.errors,function(e,t){t=t.type;return o(t)>o(e)?t:e},""));t&&("NoResults"!==t||Object.keys(this.dataSources).length===Object.keys(this.errors).length)?(e=_.map(this.errors,function(e,t){e=e.error,t=a.dataSources[t];return e?"["+t.getPath()+"]: "+e:null}).filter(function(e){return e}),this.api.showQueryStatus({error:e.join("\n"),type:t})):this.api.hideQueryStatus()},N.prototype.updateDataSource=function(o){var a=this,i="DataSet.Layers.0.Segment";if(this.dataSources[o.getKey()]){var r=!1,e=this.layers.filter(function(e){e=e.get("Basics.Data");return e&&e.cid===o.getKey()}),n=h.HeuristicHelpers.getNumericColumns(o),s=h.HeuristicHelpers.getStringColumns(o),l=h.HeuristicHelpers.getListColumns(o),c=0===n.length?l:n,p=this.errors[o.getKey()],d=0===s.length?0===l.length?n:l:s;if(0===c.length&&(!p||"Loading"===_.get(p,"type")))return void this.api.showErrorMessage({error:t("Data Source provided is not valid for Pie Chart"),type:"Warning"});e.forEach(function(e,t){e.updateData(o),e.set("possibleColumns",o.getColumnNames()),e.set("possibleRules",o.getColumnNames()),e.set("possibleLabels",o.getColumnNames()),a.api.setProperty("possibleColumns",e.get("possibleColumns")),a.api.setProperty("possibleRules",e.get("possibleRules")),a.api.setProperty("possibleLabels",e.get("possibleLabels")),0===t&&""===a.api.getProperty(i)&&(e.set(i,c[0]),a.api.setProperty(i,c[0]),r=!0),0===t&&""===a.api.getProperty("DataSet.Label")&&(e.set("DataSet.Label",d[0]),a.api.setProperty("DataSet.Label",d[0]),r=!0)}),r&&this.api.setProperty("DataSet",{Label:d[0],DonutRatio:50,Rotation:50,Circumference:100,BorderWidth:1,Layers:[{Segment:c[0],Display:"",UseColor:!0,Color:"#0061FF",BorderColor:"#ffffff",ColorOpacity:85,HighlightRules:[]}]})}(this.animation&&this.animation.get("Enabled")?this.updateChart:this.initializeChart).bind(this).call(this)},N.prototype.onResize=function(){this.chart&&this.chart.resize(!1)},N.prototype.onSettingsChangeProcessed=function(e){_.isObject(e.Basics)&&this.onSettingsBasicsChanged.call(this,e.Basics),_.isObject(e.Basics)&&e.Basics.Data&&this.onSettingsLayersChanged.call(this,e),(_.isObject(e.DataSet)||_.has(e,"Layers"))&&this.onSettingsOnData(e),_.isObject(e.InnerLabel)&&this.onSettingsOnInnerLabel(e),_.isObject(e.Legend)&&this.onSettingsLegendChanged.call(this,e.Legend),_.isObject(e.Style)&&this.onSettingsStyleChanged.call(this,e.Style),_.isObject(e.Padding)&&this.onSettingsPaddingChanged.call(this,e),_.isObject(e.FileExport)&&this.onSettingsFileExportChanged.call(this,e.FileExport),_.isObject(e.Animations)&&this.onSettingsAnimationChanged.call(this,e.Animations)},N.prototype.onSettingsFileExportChanged=function(e){var o=this;this.fileExportModel&&(_.each(e,function(e,t){o.fileExportModel.set("FileExport."+t,e)}),4<_.keys(e).length)&&void 0===this.fileExportModel.get("FileExport.Enabled")&&(this.api.hasPermission(h.CustomAPIPermission.canExportData)&&(e.ShowExportCsvButton||e.ShowExportExcelButton||e.ShowScreenshot)?this.fileExportModel.set("FileExport.Enabled",!0):this.fileExportModel.set("FileExport.Enabled",!1))},N.prototype.onSettingsAnimationChanged=function(e){this.animation&&this.animation.set(e)},N.prototype.onSettingsPaddingChanged=function(e){this.layoutModel.set("Padding",e.Padding)},N.prototype.onSettingsLegendChanged=function(e){this.legendModel.set(e),this.chart&&this.legendModel.renderhtmlLegend(this.chart)},N.prototype.onSettingsStyleChanged=function(o){var a,i,e,t,r,n,s;o.palettes&&(a=""+(null==(e=this.dashboardViewModel)?void 0:e.get("DashboardTheme")),i=".palette_theme",e=this.api.getProperty("Style.palettes"),t=_.filter(this.globalPalette,function(e){var t=".dark"!==_.get(e,"theme")&&".light"!==_.get(e,"theme")||e.theme.toLowerCase()==="."+a.toLowerCase();return e.rule===i&&t}),r=(_.isEmpty(e)||" "===e||e===i)&&0<t.length,n=!1,s=[],r&&_.each(t,function(e){s.push({type:h.Tools.rgbStr2hex(e.color)}),n=!0}),_.each(this.globalPalette,function(e){var t=".dark"!==_.get(e,"theme")&&".light"!==_.get(e,"theme")||e.theme.toLowerCase()==="."+a.toLowerCase();_.isEmpty(e.rule.trim())||e.rule!==o.palettes||!t||r||(s.push({type:h.Tools.rgbStr2hex(e.color)}),n=!0)}),n)&&this.api.setProperty("Style.chartBarColors",s),this.layers&&0<this.layers.models.length&&(this.layers.models[0].set("Style",o),o.chartBarColors&&this.layers.models[0].updateVisuals(),this.initializeChart())},N.prototype.onSettingsLayersChanged=function(e){var o=this,a=(this.layers.set(e),e.Basics.Data),e=this.dataSources[a.cid];e?e.hasData()&&this.updateDataSource(e):(e=new z(a,this,this.api,this.focus),this.dataSources[a.cid]=e,this.listenTo(a,"change:queryStatus",function(e,t){o.updateError(o.dataSources[a.cid],t)}),e.subscribe())},N.prototype.onSettingsOnData=function(e){var t=this,a=this.layers.models[0];_.each(e.DataSet,function(e,t){a&&"Layers"===t&&_.each(e,function(e,o){_.each(e,function(e,t){a.set("DataSet.Layers."+o+"."+t,e)})}),a&&"Label"===t&&a.set("DataSet.Label",e),a&&"DonutRatio"===t&&a.set("DataSet.DonutRatio",e),a&&"Rotation"===t&&a.set("DataSet.Rotation",e),a&&"Circumference"===t&&a.set("DataSet.Circumference",e),a&&"BorderWidth"===t&&a.set("DataSet.BorderWidth",e)}),_.each(this.dataSources,function(e){a.chartData={},void 0===a.get("Style")&&a.set("Style",t.api.getProperty("Style")),void 0===a.get("InnerLabel")&&a.set("InnerLabel",t.api.getProperty("InnerLabel")),a.dataSource=e,a.updateData(e)}),a&&a.set("Basics.Focus",this.api.getProperty("Basics.Focus")),this.initializeChart(),this.highlightRulesModel.computeHighlightRulesHTML()},N.prototype.onSettingsOnInnerLabel=function(e){var o=this.layers.models[0];o&&(_.each(e.InnerLabel,function(e,t){o.set("InnerLabel."+t,e)}),this.initializeChart())},N.prototype.toggleToolsPanel=function(){var e;this.fileExportModel.has("FileExport")&&this.legendModel&&(e=this.fileExportModel.get("FileExport.Enabled"),!this.legendModel.toolsEnabled&&e?(this.legendModel.toolsEnabled=!0,this.el.querySelector(".tools-panel").classList.remove("disabled"),this.initializeChart()):e||(this.legendModel.toolsEnabled=!1,this.el.querySelector(".tools-panel").classList.toggle("disabled",!this.el.querySelector(".tools-panel").classList.contains("disabled")),this.initializeChart()))},N.prototype.onSettingsAnimationsChanged=function(e){var t=this;e.hasOwnProperty("Enabled")?(e.Enabled?D.cache(this.animation,"Animations.",{load:["Duration","Easing"],defaults:[0,"easeOutQuart"]},this.api):D.cache(this.animation,"Animations.",{store:["Duration","Easing"]},this.api),this.animation.set(e),_.defer(function(){t.api.setProperty("Animations",i.Model.prototype.toJSON.apply(t.animation))})):this.animation.set(e)},N.prototype.onSettingsTooltipsChanged=function(e){var t=this;e.hasOwnProperty("Enabled")?(e.Enabled?D.cache(this.tooltips,"Tooltips.",{load:["Mode"],defaults:[0,"index"]},this.api):D.cache(this.tooltips,"Tooltips.",{store:["Mode"]},this.api),this.tooltips.set(e),_.defer(function(){t.api.setProperty("Tooltips",i.Model.prototype.toJSON.apply(t.tooltips))})):this.tooltips.set(e)},N.prototype.onSettingsBasicsChanged=function(e){var t=this;void 0!==e.Focus&&(this.focus=_.first(D.focus2Array(e.Focus))||[],_.each(this.dataSources,function(e){e.setFocus(t.focus)})),void 0!==e.Selected&&0<this.layers.models.length&&this.api.getProperty("Basics.PopoutSelected")&&(this.layers.models[0].set("Basics.Selected",e.Selected),this.updateChart())},N.prototype.initializeChart=function(){this.chart&&(this.chart.destroy(),delete this.chart);var e=this.prepareChart(),t=e.datasets,o=e.labels,e=e.options;t&&o&&e&&(t={type:"doughnut",layers:this.layers,dataSource:this.dataSources,data:{datasets:t,labels:o},plugins:[this.layers.models[0].labelPlugin],options:n(n({},e),this.layers.models[0].computeConfigProps())},window.layers=this.layers,window.dataSources=this.dataSources,(_.isNil(o)||0===o.length)&&_.get(t,"options.legend.reverse")&&_.set(t,"options.legend.reverse",!1),this.chart=new Chart(this.ctx,t),this.legendModel.renderhtmlLegend(this.chart))},N.prototype.updateChart=function(){var a=this;if(this.chart){var e=this.prepareChart(),t=e.datasets,o=e.labels,e=e.options;if(t&&o&&e){_.merge(this.chart.options,e),t.forEach(function(e){var t,o=_.find(a.chart.data.datasets,{id:e.id});o?(t=e.data,_.merge(o,e),o.data=t):a.chart.data.datasets.push(e)});for(var i=_.fromPairs(_.map(t,function(e){return[e.id,!0]})),r=0;r<this.chart.data.datasets.length;r++)i[this.chart.data.datasets[r].id]||(this.chart.data.datasets.splice(r,1),r--);_.get(this.chart,"config.data.labels")&&(this.chart.config.data.labels=o),o&&0<o.length&&this.chart.update()}}else this.initializeChart.bind(this).call(this)},N.prototype.prepareChart=function(){var e,t,o,a,i,r=this;return this.layers.length?(e=_.flatten(_.map(this.layers.models,"dataset").filter(_.negate(_.isEmpty))),t=_.flatten(_.map(this.layers.models,"labelData").filter(_.negate(_.isEmpty))),o=this.layers.models[0],a=this.tooltips,i=this.legendModel.computePaddingAdjustment(),{datasets:e,labels:t,options:n(n({},this.defaultOptions),{animation:this.animation.toPieJSON(),legend:this.legendModel.computeLegendProp(),layout:this.layoutModel.computeLayoutProp(i),onClick:function(e,t){t&&t.length&&(r.onClick(t[0]._index,e),r.chart.update())},tooltips:{enabled:!1,mode:"point",custom:function(e){a.customTooltip(this,e,o)}}})}):{}},N.prototype.onClick=function(e,t){var o,a=this.layers.models[0],i=a.get("Basics.Data"),i=this.dataSources[i.cid],r=i.getData().at(e);a.setPopoutSegment(this.chart,e),void 0!==r&&(e=i.getPropertyFromColumn(a.get("Basics.SelectedAttr")),(e=r.get(e))===this.api.getProperty("Basics.Selected")&&(e=""),this.api.setProperty("Basics.Selected",e,!0),e=i.getDepth(),o=_.clone(this.focus),i=i.getPropertyFromColumn(a.get("DataSet.Label")),a=r.get(i),o[e]=a&&a.toString?a.toString():""+a,this.api.setProperty("Basics.Focus",o.join(","),!0),this.doActions(t))},N.prototype.doActions=function(e){var t,o,e=this.chart.getElementAtEvent(e);e.length&&(o=(e=e[0])._datasetIndex,e=e._index,((o=this.layers.models.length-1-o)<0||o>this.layers.models.length-1)&&(o=this.layers.models.length-1),o=this.layers.models[o].get("Basics.Data"),t=this.dataSources[o.cid].getData().at(e),o=this.api.getProperty("Basics.Actions").map(function(e){return n(n({},e),{Value:t.get(e.Current)})}),this.api.doActions(o,"Basics.Actions"))},N.prototype.onLayerDataEvents=function(e){var t=e.get("Basics.Data"),t=t?this.dataSources[t.cid]:void 0;t&&(e.updateData(t),e.set("_Hidden._PossibleColumns",t?t.getColumnNames():[]))},N.prototype.onLayerVisualEvents=function(e){e.updateVisuals()},N.prototype.setTheme=function(e){var t,o,a=this;if("Light"===e)t="#FFFFFF",o="#000000";else{if("Dark"!==e)return;t="#000000",o="#FFFFFF"}var e=e.toLowerCase(),i=this.layers.models[0];_.each(["Legend.LabelColor","InnerLabel.InnertitleColor","InnerLabel.PieceLabelColor"],function(e){i&&i.get(e)&&i.get(e).toLowerCase()===t.toLowerCase()&&i.set(e,o),a.api.getProperty(e).toLowerCase()===t.toLowerCase()&&a.api.setProperty(e,o)}),_.each(["dark","light"],function(e){a.el.classList.remove(e)}),this.el.classList.add(e)},N.prototype.setThemeAccordingToDashboardSettings=function(){this.isReadyForThemeChange&&this.setTheme(this.dashboardViewModel.get("DashboardTheme"))},N.prototype.updatePossibleLayers=function(){this.layers.filter(function(e){return"Line"===e.get("_Hidden._Type")}).forEach(function(a){var e=a.collection.reduceRight(function(e,t,o){return[a===t?"nofill":"Layer "+(o+1)].concat(e)},["origin"]);a.set("_Hidden._PossibleLayers",e)}.bind(this))},N.getComponentDefinition=L.getComponentDefinition,N});
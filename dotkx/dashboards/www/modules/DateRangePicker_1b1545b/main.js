define(["backbone","Forms","Handlebars","QuickBase","moment","css!./css/app.css"],function(n,o,e,l,t){"use strict";var a,i=this&&this.__extends||(a=function(e,t){return(a=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}))(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),r=(s.getComponentDefinition=function(e){if(0<_.keys(e.settingsModel.attributes).length)for(var t=_.find(s.upgrades,{version:e.settingsModel.get("version")}),i=void 0===t?1:s.upgrades.indexOf(t)+1;i<s.upgrades.length;i+=1){var a=s.upgrades[i];a.fn(e.settingsModel),e.settingsModel.set("version",a.version)}return{id:75,componentName:"DateRangePicker",componentDescription:"DateRangePicker",appKey:"DateRangePicker",css:"DateRangePicker",listViewThumb:null,ghostViewThumb:null,buildViewThumb:null,appArgs:{json:{version:"4.7.8",Basics:{Name:"",Data:"",StartDateLabel:"Enter date range:",EndDateLabel:"",SelectedStartDate:"",SelectedEndDate:"",StartDateLabelWidth:120,InputFieldWidth:90,EndDateLabelWidth:0,InputFieldOrientation:"Horizontal",Horizontal:"Center",Vertical:"Middle",Tooltip:"",AllowKeyboardInput:!0},Actions:[],Style:{advanced:""}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",options:{collapsed:!1},propertyOrder:200,properties:{Name:{title:"Name",type:"string",default:""},Data:{type:"data",title:"Data Source",default:""},StartDateLabel:{title:"Start Date Label",type:"string",default:"Select date range:"},EndDateLabel:{title:"End Date Label",type:"string",default:""},SelectedStartDate:{title:"Selected Start Date",type:"viewstate",default:""},SelectedEndDate:{title:"Selected End Date",type:"viewstate",default:""},StartDateLabelWidth:{title:"Start Date Label Width",type:"number",default:120},EndDateLabelWidth:{title:"End Date Label Width",type:"number",default:0},InputFieldWidth:{title:"Input Field Width",type:"number",default:90},InputFieldOrientation:{type:"string",title:"Input Field Orientation",enum:["Horizontal","Vertical"],default:"Horizontal"},Horizontal:{type:"string",title:"Horizontal Alignment",enum:["Left","Center","Right"]},Vertical:{type:"string",title:"Vertical Alignment",enum:["Top","Middle","Bottom"]},Tooltip:{title:"Tooltip",type:"string",default:""},AllowKeyboardInput:{title:"Allow Keyboard Input",type:"boolean",default:!0}}},Actions:{type:"actions"},Style:{type:"object",title:"Style",options:{collapsed:!0},propertyOrder:210,properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}}},s.upgrades=[{version:0,fn:function(e){}}],s);function s(){}h.app=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,a,r){return'<div style="display: table; width: 100%; height: 100%;">  \n    <div class="align-div" style="display: table-cell; width: 100%; height: 100%; text-align: center; vertical-align: middle;">\n        <div style="display: inline-block;">\n            <div class="date-range-picker-container">\n                <span class="date-range-picker-input bbf-editor">                  \n                </span>                 \n            </div>\n        </div>\n    </div> \n</div>'},useData:!0});var d,c=h;function h(){}function p(e){var t=d.call(this,e)||this;return t.errors=null,t.availableDates=[],t.theme="",t.defaultType="date",t.errorClassName="error",t.hasInit=!1,t.currentPickerType={viewstateType:null},t.previousPickerType=null,t.primaryKey=null,t.intersectionObserver=null,t.api=e.api,t.dateCollection=new n.Collection,t.viewModel=new n.DeepModel,t.debouncedRenderDateRangePicker=_.debounce(t.renderDateRangePicker.bind(t),100),t.currentPickerType.viewstateType=t.defaultType,t.el=e.el,t.el.className+=" DateRangePicker",t.setTheme(e.dashboardViewModel.get(p.APP_THEME)),t}return d=n.View,i(p,d),p.prototype.setTheme=function(e){"Light"===e?this.el.classList.add("Light"):this.el.classList.remove("Light"),this.dateRangePicker&&this.dateRangePicker.setTheme(e),this.theme=e},p.prototype.onData=function(e,t){var i,a=this,r=e.columns,s=(e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey,this.dateCollection=new n.Collection([],{model:n.Model.extend({idAttribute:this.primaryKey})})),t.reset?(r.reset&&(i=e.columns.reset),this.dateCollection.reset(t.reset)):(this.dateCollection.remove(_.map(t.remove,function(e){return e[a.primaryKey]})),this.dateCollection.add(t.add),this.dateCollection.add(t.change,{merge:!0})),i&&i[0]?i[0].id:"");this.availableDates=this.dateCollection.map(function(e){e=e.get(s)||"";return l.Tools.isKDBTemporal(e)?l.Tools.convertKDBTemporalToMoment(e).toDashString():(a.api.showQueryStatus({error:'Invalid Date Type "'+(_.isFunction(e.toString)?e.toString():e)+'", please choose a Data Source that returns a column of date/time types',errorType:"Warning"}),null)}),this.dateRangePicker&&this.debouncedRenderDateRangePicker()},p.prototype.initializeEvents=function(){var a=this;this.listenTo(this.viewModel,"change:Basics.Data",this.onDataSourceChanged.bind(this)),this.listenTo(this.viewModel,"change:Basics.InputFieldWidth",this.setInputFieldWidth.bind(this)),this.listenTo(this.viewModel,"change:Basics.StartDateLabelWidth",this.updateStartDateLabelWidth.bind(this)),this.listenTo(this.viewModel,"change:Basics.EndDateLabelWidth",this.updateEndDateLabelWidth.bind(this)),this.listenTo(this.viewModel,"change:Basics.Horizontal",this.onHorizontalAlignChanged.bind(this)),this.listenTo(this.viewModel,"change:Basics.Vertical",this.onVerticalAlignChanged.bind(this)),this.listenTo(this.viewModel,"change:Basics.Tooltip",this.onTooltipChanged.bind(this)),this.listenTo(this.viewModel,"change:Basics.InputFieldOrientation",this.onInputFieldOrientation.bind(this)),this.listenTo(this.viewModel,"change:Basics.AllowKeyboardInput",this.debouncedRenderDateRangePicker.bind(this)),this.listenTo(this.viewModel,"change:Basics.StartDateLabel change:Basics.EndDateLabel",this.onLabelChange.bind(this)),this.listenTo(this.viewModel,"change:Basics.SelectedStartDate change:Basics.SelectedEndDate",this.onSelectedDateChange.bind(this)),this.intersectionObserver=new IntersectionObserver(function(e){for(var t=0,i=e;t<i.length;t++)i[t].isIntersecting||a.onResize()}),this.intersectionObserver.observe(this.el)},p.prototype.afterInitialize=function(){this.render(),this.initializeEvents(),this.onDataSourceChanged(),this.onVerticalAlignChanged(),this.onTooltipChanged(),this.onHorizontalAlignChanged(),this.renderDateRangePicker()},p.prototype.onDataSourceChanged=function(){var e=this.viewModel.get("Basics.Data");e?this.dataModel&&e.path===this.dataModel.path||this.applyDataProperty(e):(this.applyDataProperty(),this.availableDates=[],this.dateRangePicker&&this.debouncedRenderDateRangePicker())},p.prototype.applyDataProperty=function(e){this.dataModel&&(this.stopListening(this.dataModel),this.api.unsubscribe(this.dataModel),this.availableDates=[]),(this.dataModel=e)&&(this.dataModel&&this.dataModel.attributes?(this.api.subscribe(e,this.onData.bind(this)),this.initializeQueryStatusHandler(this.dataModel)):this.api.showQueryStatus({error:'Invalid Data Source: "'+e.path+'" selected',errorType:"Warning"}))},p.prototype.initializeQueryStatusHandler=function(e){this.updateQueryStatus(),this.listenTo(e,"change:queryStatus",this.updateQueryStatus.bind(this))},p.prototype.updateQueryStatus=function(e,t){t?"NoResults"!==t.type&&this.api.showQueryStatus(t):this.api.hideQueryStatus()},p.prototype.executeActions=function(){this.api.doActions(this.viewModel.get("Actions"),"Actions")},p.prototype.onHorizontalAlignChanged=function(){this.alignDiv&&(this.alignDiv.style.textAlign=this.viewModel.get("Basics.Horizontal"))},p.prototype.onVerticalAlignChanged=function(){this.alignDiv&&(this.alignDiv.style.verticalAlign=this.viewModel.get("Basics.Vertical"))},p.prototype.onInputFieldOrientation=function(){this.displayDiv&&("Vertical"===this.viewModel.get("Basics.InputFieldOrientation")?(this.displayDiv.classList.remove("date-range-input-box-row"),this.displayDiv.classList.add("date-range-input-box-column")):(this.displayDiv.classList.remove("date-range-input-box-column"),this.displayDiv.classList.add("date-range-input-box-row")))},p.prototype.onTooltipChanged=function(){var e=this.viewModel.get("Basics.Tooltip")||"";this.drpContainer&&(this.drpContainer.title=e)},p.prototype.setInputFieldWidth=function(){_.isFunction(this.dateRangePicker.setInputFieldWidth)&&this.dateRangePicker.setInputFieldWidth(this.viewModel.get("Basics.InputFieldWidth"))},p.prototype.updateStartDateLabelWidth=function(){var e=this.viewModel.get("Basics.StartDateLabelWidth");this.startDateLabel&&(this.startDateLabel.style.width=e+"px")},p.prototype.updateEndDateLabelWidth=function(){var e=this.viewModel.get("Basics.EndDateLabelWidth");this.endDateLabel&&(this.endDateLabel.style.width=e+"px")},p.prototype.render=function(){return this.el.innerHTML=c.app(),this.drpInputElement=this.el.querySelectorAll(".date-range-picker-input")[0],this.drpContainer=this.el.querySelectorAll(".date-range-picker-container")[0],this.alignDiv=this.el.querySelectorAll(".align-div")[0],this},p.prototype.onSettingsChange=function(e){var i=this;_.each(e,function(e,t){i.viewModel.set(t,e)}),this.hasInit||(this.hasInit=!0,this.afterInitialize())},p.prototype.remove=function(){var e;return this.setErrors(null),null!=(e=this.intersectionObserver)&&e.unobserve(this.el),this.removeDateRangePicker(),n.View.prototype.remove.apply(this)},p.prototype.onLabelChange=function(){this.startDateLabel&&(this.startDateLabel.innerHTML=this.viewModel.get("Basics.StartDateLabel")),this.endDateLabel&&(this.endDateLabel.innerHTML=this.viewModel.get("Basics.EndDateLabel"))},p.prototype.onSelectedDateChange=function(){var e=this.viewModel.get("Basics.SelectedStartDate"),t=this.viewModel.get("Basics.SelectedEndDate"),i=(_.isEmpty(e)&&!this.api.getPropertyMeta("Basics.SelectedStartDate").viewstateType&&(e=this.el.querySelectorAll("input")[0].value),_.isEmpty(t)&&!this.api.getPropertyMeta("Basics.SelectedEndDate").viewstateType&&(t=this.el.querySelectorAll("input")[1].value),l.Tools.convertValueToMoment(e)),a=l.Tools.convertValueToMoment(t),i=i.isValid()?i.format("YYYY-MM-DD"):e,e=a.isValid()?a.format("YYYY-MM-DD"):t;this.dateRangePicker.updateDateInputField([i,e]),this.executeActions()},p.prototype.renderDateRangePicker=function(){this.removeDateRangePicker();var e=this.api.getPropertyMeta("Basics.SelectedStartDate"),t=this.api.getPropertyMeta("Basics.SelectedEndDate"),t=(e?null===e.viewstateType?(e=null,e=this.currentPickerType):this.currentPickerType=e:e=this.currentPickerType,t?null===t.viewstateType?(t=null,t=this.currentPickerType):this.currentPickerType=t:t=this.currentPickerType,o.RTTI.getByName(e.viewstateType)),e=(t.editor.type,t.editor.options),i=(t.editor.validators,n.Form.editors.DateRangePicker),e=_.extend({},e,{availableDates:this.availableDates,allowInput:this.viewModel.get("Basics.AllowKeyboardInput")}),i=(this.dateRangePicker=new i({id:_.uniqueId("daterange_"),schema:{options:e,validators:t.editor.validators}}).render(),this.dateRangePicker.setTheme(this.theme),this.setInputFieldWidth(),this.el.setAttribute("data-type","DateRangePicker"),this.drpInputElement&&this.drpInputElement.appendChild(this.dateRangePicker.el),this.el.querySelectorAll("input")[0]),e=this.el.querySelectorAll("input")[1];this.startDateLabel=document.createElement("label"),this.startDateLabel.classList.add("date-range-picker-label"),this.startDateLabel.setAttribute("for",i.id),i.before(this.startDateLabel),this.endDateLabel=document.createElement("label"),this.endDateLabel.classList.add("date-range-picker-label"),this.endDateLabel.setAttribute("for",e.id),e.before(this.endDateLabel),this.updateStartDateLabelWidth(),this.updateEndDateLabelWidth(),this.onLabelChange(),this.displayDiv=this.el.querySelectorAll(".date-range-input-box")[0],this.onInputFieldOrientation(),this.addDateRangePickerListeners(),this.onSelectedDateChange()},p.prototype.addDateRangePickerListeners=function(){var t=this;this.listenTo(this.dateRangePicker,"change",function(){t.setErrors(null);var e=t.dateRangePicker.getValue();t.viewModel.set("Basics.SelectedStartDate",e[0],{silent:!0}),t.api.setProperty("Basics.SelectedStartDate",e[0]),t.api.setProperty("Basics.SelectedEndDate",e[1])}),this.listenTo(this.dateRangePicker,"close",function(){var e;t.$startErrorTooltip&&t.$startErrorTooltip.is(":visible")&&t.$startErrorTooltip.hasClass("internal-invalid-error")||t.$endErrorTooltip&&t.$endErrorTooltip.is(":visible")&&t.$endErrorTooltip.hasClass("internal-invalid-error")?t.dateRangePicker.previousDate&&(t.setErrors(null),e=t.dateRangePicker.previousDate,t.viewModel.set("Basics.SelectedStartDate",e[0],{silent:!0}),t.api.setProperty("Basics.SelectedStartDate",e[0]),t.api.setProperty("Basics.SelectedEndDate",e[1]),t.dateRangePicker)&&t.dateRangePicker.setValue(e):(t.$startErrorTooltip&&t.$startErrorTooltip.is(":visible")&&t.$startErrorTooltip.hasClass("internal-range-error")||t.$endErrorTooltip&&t.$endErrorTooltip.is(":visible")&&t.$endErrorTooltip.hasClass("internal-range-error"))&&(e=[{type:"invalid-range",inputField:t.el.querySelectorAll("input")[1]}],t.setErrors(e))}),this.listenTo(this.dateRangePicker,"focus",function(){var e;(t.dateRangePicker.focusedField===t.el.querySelectorAll("input")[0]&&t.$endErrorTooltip&&t.$endErrorTooltip.is(":visible")&&t.$endErrorTooltip.hasClass("internal-range-error")||t.dateRangePicker.focusedField===t.el.querySelectorAll("input")[1]&&t.$startErrorTooltip&&t.$startErrorTooltip.is(":visible")&&t.$startErrorTooltip.hasClass("internal-range-error"))&&(e=[{type:"invalid-range",inputField:t.el.querySelectorAll("input")[1]}],t.setErrors(e))}),this.listenTo(this.dateRangePicker,"date-range-error",function(e){t.setErrors(e)})},p.prototype.onScroll=function(){this.onResize()},p.prototype.onResize=function(){this.errors&&this.errors.length&&this.setErrors(this.errors)},p.prototype.removeDateRangePicker=function(){this.dateRangePicker&&(this.stopListening(this.dateRangePicker),this.dateRangePicker.remove(),this.dateRangePicker=null)},p.prototype.getErrorFromTooltip=function(e){var t,i=e===this.$startErrorTooltip?this.el.querySelectorAll("input")[0]:this.el.querySelectorAll("input")[1];return e.hasClass(p.ERROR_TABLE.invalid.cssClass)?t="invalid":e.hasClass(p.ERROR_TABLE.unavailable.cssClass)?t="unavailable":(t="invalid-range",(e=e.text()).includes("start")?t="invalid-range-start":e.includes("end")&&(t="invalid-range-end")),{type:t,inputField:i}},p.prototype.setErrors=function(e){var t=(this.errors=e)?e.length:0,i=(_.map(p.ERROR_TABLE,"cssClass"),this.el.querySelectorAll("input"));o.ErrorTooltip.clear(this.$startErrorTooltip),o.ErrorTooltip.clear(this.$endErrorTooltip),0===t?(this.el.classList.remove(this.errorClassName),_.forEach(i,function(e){e.classList.remove("dateRangePickerInputBoxError")})):2===t?(this.el.classList.add(this.errorClassName),_.forEach(i,function(e){e.classList.add("dateRangePickerInputBoxError")}),e&&(this.showError(p.ERROR_TABLE[e[1].type],this.el.querySelectorAll("input")[1]),e[0].type!==e[1].type)&&this.showError(p.ERROR_TABLE[e[0].type],this.el.querySelectorAll("input")[0])):1===t&&(this.el.classList.add(this.errorClassName),e)&&(e[0].type.startsWith("invalid-range")?_.forEach(i,function(e){e.classList.add("dateRangePickerInputBoxError")}):(e[0].inputField.classList.add("dateRangePickerInputBoxError"),(e[0].inputField===this.el.querySelectorAll("input")[0]?this.el.querySelectorAll("input")[1]:this.el.querySelectorAll("input")[0]).classList.remove("dateRangePickerInputBoxError")),t=e[0].inputField,this.showError(p.ERROR_TABLE[e[0].type],t))},p.prototype.showError=function(e,t){var i,a,r,s=e.msg;(s.includes("start")||s.includes("end"))&&(r=s.lastIndexOf("of ")+3,i=s.slice(r),a=(s.includes("start")?this.el.querySelectorAll("input")[1]:this.el.querySelectorAll("input")[0]).value,s=s.slice(0,r)+a+" "+i),this.isTopMostElement(t)&&((r=o.ErrorTooltip.show(s,t)).addClass(e.cssClass),t===this.el.querySelectorAll("input")[0]?this.$startErrorTooltip=r:this.$endErrorTooltip=r)},p.prototype.isTopMostElement=function(e){var t=e.getBoundingClientRect(),t=document.elementFromPoint(t.x+t.width/2,t.y+t.height/2);return t===e||(null==t?void 0:t.classList)&&(null==t?void 0:t.classList.contains("field-error"))},p.APP_THEME="DashboardTheme",p.PROP_DATA="Basics.Data",p.ERROR_TABLE={invalid:{msg:"Invalid date",cssClass:"internal-invalid-error"},unavailable:{msg:"Date out of scope",cssClass:"internal-unavailable-error"},"invalid-range":{msg:"Dates out of order",cssClass:"internal-range-error"},"invalid-range-start":{msg:"Dates out of order, please provide a start date of or earlier",cssClass:"internal-range-error"},"invalid-range-end":{msg:"Dates out of order, please provide an end date of or later",cssClass:"internal-range-error"}},p.getComponentDefinition=r.getComponentDefinition,p});